var ce=Object.defineProperty;var ue=(e,t,s)=>t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var N=(e,t,s)=>ue(e,typeof t!="symbol"?t+"":t,s);import{d as L,I as R,W as G,aj as J,ai as W,T as X,an as K,V as Q,S as Y,ah as Z,a_ as pe,cG as ee,X as ge,E as d,e as f,f as g,l as o,z as a,k as n,B as r,A as m,F as b,a$ as me,ao as V,ab as fe,aR as _e,U as he,b8 as ye,aW as ve,aX as be,aY as De,aZ as we,cO as Ce,bS as ke,dG as Me,ay as Pe,c8 as Oe,dH as Ie,r as Te,y as F,L as I,m as k,p as E}from"./vendor-D2vbv48U.js";import{E as j}from"./EIRreportsStore-DUpXUN2w.js";import{N as Se}from"./NavigationMenu-CJ5wKZsG.js";import{V as Be}from"./ViewToggleComponent-B6ZXOAGd.js";import{i as Ne,_ as te,aJ as $,P as Ve,S as ne,u as se,ay as $e,y as oe,aK as Ae,aL as x,c as q,aM as xe,j as ze,m as A,l as Fe,k as Ee,au as je}from"./index-BKKrZstI.js";import{D as ie}from"./drug_prescription_service-Cdp09yhG.js";import{V as qe}from"./opd_offline_visits-CkZmY95H.js";import"./lodash-Dt8AsbQm.js";import"./apexcharts-D3NY3X_Q.js";import"./drug_service-enNyjps3.js";const He=L({name:"MedicationDetailsModal",components:{IonContent:Z,IonHeader:Y,IonFooter:Q,IonPage:K,IonTitle:X,IonRow:W,IonCol:J,IonButton:G,IonIcon:R},props:{selectedMedication:{type:Object,default:null}},data(){return{iconsContent:Ne,medkit:ee,closeIcon:pe,dismiss:()=>(this.$emit("close"),ge.dismiss())}},methods:{formatFullDate(e){return e?new Date(e).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"N/A"},getFrequencyLabel(e){const t=ie.find(s=>s.code===e);return t?t.label:"Unknown"}}}),Ue={class:"medication-details-header"},Le={class:"modal_wrapper"},Re={class:"medication-details-modal"},Ge={class:"text-xl font-bold mb-4"},Je={class:"grid grid-cols-2 gap-3"};function We(e,t,s,i,l,c){const _=d("ion-icon"),y=d("ion-title"),u=d("ion-header"),M=d("ion-content"),D=d("ion-button"),T=d("ion-col"),S=d("ion-row"),P=d("ion-footer");return g(),f(b,null,[o(u,{style:{display:"flex","justify-content":"space-between"}},{default:a(()=>[o(y,{class:"modalTitle"},{default:a(()=>[n("div",Ue,[o(_,{icon:e.medkit,class:"ion-margin-end"},null,8,["icon"]),t[1]||(t[1]=n("span",null,"Medication Details",-1))])]),_:1}),o(_,{onClick:t[0]||(t[0]=B=>e.dismiss()),style:{"padding-top":"10px","padding-right":"10px"},icon:e.iconsContent.cancel},null,8,["icon"])]),_:1}),o(M,{fullscreen:!0,class:"ion-padding",style:{"--background":"#fff"}},{default:a(()=>[n("div",Le,[n("div",Re,[n("h2",Ge,r(e.selectedMedication.drug.name),1),n("div",Je,[n("div",null,[t[2]||(t[2]=n("strong",null,"Order ID:",-1)),m(" "+r(e.selectedMedication.order_id),1)]),n("div",null,[t[3]||(t[3]=n("strong",null,"Drug ID:",-1)),m(" "+r(e.selectedMedication.drug_inventory_id),1)]),n("div",null,[t[4]||(t[4]=n("strong",null,"Dose:",-1)),m(" "+r(e.selectedMedication.dose)+" "+r(e.selectedMedication.units),1)]),n("div",null,[t[5]||(t[5]=n("strong",null,"Equivalent Daily Dose:",-1)),m(" "+r(e.selectedMedication.equivalent_daily_dose),1)]),n("div",null,[t[6]||(t[6]=n("strong",null,"Frequency:",-1)),m(" "+r(e.getFrequencyLabel(e.selectedMedication.frequency)),1)]),n("div",null,[t[7]||(t[7]=n("strong",null,"Order Type:",-1)),m(" "+r(e.selectedMedication.order.order_type_id),1)]),n("div",null,[t[8]||(t[8]=n("strong",null,"Start Date:",-1)),m(" "+r(e.formatFullDate(e.selectedMedication.order.start_date)),1)]),n("div",null,[t[9]||(t[9]=n("strong",null,"Date Created:",-1)),m(" "+r(e.formatFullDate(e.selectedMedication.order.date_created)),1)]),n("div",null,[t[10]||(t[10]=n("strong",null,"Orderer:",-1)),m(" "+r(e.selectedMedication.order.orderer),1)]),n("div",null,[t[11]||(t[11]=n("strong",null,"Instructions:",-1)),m(" "+r(e.selectedMedication.order.instructions),1)])])])])]),_:1}),o(P,{collapse:"fade",class:"ion-no-border"},{default:a(()=>[o(S,null,{default:a(()=>[o(T,null,{default:a(()=>[o(D,{onClick:e.dismiss,color:"primary",style:{float:"right","margin-bottom":"20px","margin-right":"20px"}},{default:a(()=>[o(_,{icon:e.closeIcon,slot:"start"},null,8,["icon"]),t[12]||(t[12]=m(" Close "))]),_:1,__:[12]},8,["onClick"])]),_:1})]),_:1})]),_:1})],64)}const H=te(He,[["render",We],["__scopeId","data-v-01db984e"]]);class U extends ${constructor(s=null,i=null){const l=new Ve,c=s!==null?s:l.getID(),_=i!==null?i:ne.getUserID();super(c,32,_);N(this,"drugHistory");N(this,"currentDrugOrder");this.drugHistory=[],this.currentDrugOrder=[]}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}getDispensationArryObj(s,i){return[{drug_order_id:s,date:this.date,quantity:i}]}saveDispensations(s,i){return $.postJson("/dispensations",{dispensations:s,provider_id:this.providerID,program_id:i})}generateOfflineDispensatiobObject(s,i){return{dispensations:s,provider_id:this.providerID,program_id:i,patient_id:this.patientID}}async saveDispensationsOffline(s){var i,l,c;try{const _=se(),{patient:y}=me(_),u=JSON.parse(JSON.stringify(y.value));s.length>0&&((c=(l=(i=u.dispensations)!=null?i:u.dispensations={}).unsaved)!=null||(l.unsaved=[]),u.dispensations.unsaved.length>=0&&u.dispensations.unsaved.push(...s)),await $e(u),oe("Dispensations saved offline successfully")}catch(_){Ae("Error saving dispensations offline"+_)}}async voidOrder(s){return $.void("/dispensations/".concat(s),{})}async loadDrugHistory(){const s=await x.getDrugOrderHistory(this.patientID);s&&(this.drugHistory=s)}async loadCurrentDrugOrder(){const s=await x.getDrugOrders(this.patientID);s&&(this.currentDrugOrder=await Promise.all(s))}calcCompletePack(s,i){const l=s.barcodes.sort(function(y,u){return y.tabs-u.tabs});if(l.length==0||i==0)return i;for(let y=0;y<=l.length-1;y++)if(parseInt(l[y].tabs)>=i)return l[y].tabs;const c=parseInt(l[0].tabs);let _=parseInt(l[l.length-1].tabs);for(;_<i;)_+=c;return _}}const Xe=L({name:"MedicationDispensation",components:{IonContent:Z,IonPage:K,NavigationMenu:Se,IonCard:we,IonCardHeader:De,IonCardTitle:be,IonCardContent:ve,IonButton:G,IonModal:ye,IonHeader:Y,IonToolbar:he,IonTitle:X,IonButtons:_e,IonInput:fe,MedicationDetailsModal:H,IonRow:W,IonCol:J,IonIcon:R,ViewToggleComponent:Be,IonFooter:Q},setup(){const e=Te(null);return{navMenuRef:e,navigateBack:()=>{e.value&&e.value.goBackwards()}}},data(){return{medicationsByProgram:{},medications:[],selectedMedication:null,medkit:ee,repeat:Ie,eye:Oe,alertCircleOutline:Pe,checkmarkDoneCircleOutline:Me,clipboardOutline:ke,timeOutline:Ce,currentView:"list",previousClinicalNotes:"",checkedIn:!1,showAsPrescribedBtn:!1,isOnline:ne.getAPIStatus()}},computed:{...V(j,["navigationPayload"]),...V(se,["patient"]),...V(q,["NCDMedicatioTogglePreference"]),medicationsByProgram(){return this.medications.reduce((e,t)=>{const s=t.program_id;return e[s]||(e[s]=[]),e[s].push(t),e},{})},groupedMedications(){return this.medications.reduce((e,t)=>{const s=t.order.date_created.split("T")[0];return e[s]||(e[s]=[]),e[s].push(t),e},{})}},async mounted(){this.initComp()},methods:{async initComp(){this.initTogglePreference(),this.medications=[],this.initOwnNavData(),await this.prescribedMedications(),this.enableShowAsPrescribedBtn()},async getPrograms(){return await this.getOfflinePrograms()},async printVisitSummary(){await new je().printData("visit")},async handleAbscond(e){try{console.log("The patient being absconded",e);const t=String(localStorage.getItem("locationID"));await qe.closeVisit(e.patientId,new Date().toISOString()),await Ee().refresh(t)}catch(t){console.error("Failed to abscond patient:",t)}},initOwnNavData(){j().setNavigationPayload("Dispense Medication",!0,!1,"/","home")},async prescribedMedications(){this.isOnline?(this.medications=await x.findProgramDrugOrdersAwaitingDispensation(this.patient.patientID),console.log(this.medications),this.medications=this.medications.map(e=>({...e,amountToDispense:e.amountToDispense||null,dispensed:e.dispensed||!1})),await this.groupMedicationsByProgram(this.medications)):await this.getPatientPrescribedMedications()},async getPatientPrescribedMedications(){try{const e=this.patient.dispensations.saved,t=this.patient.dispensations.unsaved,s=new Set;t.forEach(c=>{c.dispensations&&c.dispensations[0]&&c.dispensations[0].drug_order_id&&s.add(c.dispensations[0].drug_order_id)});const l=e.filter(c=>!s.has(c.order_id)).map(c=>({...c,amountToDispense:c.amountToDispense||null,dispensed:c.dispensed||!1}));await this.groupMedicationsByProgram(l)}catch(e){console.error("Error fetching offline medications:",e)}},async groupMedicationsByProgram(e){const t=await this.getPrograms(),s={};t.forEach(i=>{s[i.program_id]=i.name}),this.medicationsByProgram={},e.forEach(i=>{const l=s[i.program_id];l&&(this.medicationsByProgram[l]||(this.medicationsByProgram[l]=[]),this.medicationsByProgram[l].push(i))})},async getOfflinePrograms(){try{return await Fe("programs",{likeClause:{},currentPage:1,itemsPerPage:5e4}).then(c=>c.records)}catch(e){throw console.error("Error fetching offline districts:",e.message),e}},getFrequencyLabel(e){const t=ie.find(s=>s.code===e);return t?t.label:"Unknown"},validateAmount(e){const t=parseFloat(e.amountToDispense);isNaN(t)||t<=0?e.error="Please enter a valid amount greater than 0.":e.error=null},setAmountAsPrescribed(e){e.amountToDispense=e.dose,this.validateAmount(e)},async dispenseMedication(e){if(e.error){A("Fix errors before dispensing.");return}try{const t=new U,s=t.getDispensationArryObj(e.order_id,e.amountToDispense);if(this.isOnline)await t.saveDispensations(s,e.program_id),e.dispensed=!0,oe("Medication dispensed successfully.");else{const i=new U,l=i.generateOfflineDispensatiobObject(s,e.program_id);await i.saveDispensationsOffline([l]),e.dispensed=!0}}catch(t){A("Dispensing failed. Please try again."),A("Error: "+t),console.error(t)}},async viewDetails(e){this.selectedMedication=e,await ze(H,{class:"large-modal"},!0,{selectedMedication:this.selectedMedication})},formatHeaderDate(e){return new Date(e).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})},handleViewChange(e){this.initTogglePreference(e,!0)},async enableShowAsPrescribedBtn(){const e=await xe([14]);this.showAsPrescribedBtn=!e},initTogglePreference(e="list",t=!1){const s={toggle_view:e},i=q();Object.keys(this.NCDMedicatioTogglePreference).length===0&&(s.toggle_view="list",i.setNCDMedicatioTogglePreference(s)),Object.keys(this.NCDMedicatioTogglePreference).length>0&&t==!0&&i.setNCDMedicatioTogglePreference(s)},groupMedicationsByDate(e){return e.reduce((t,s)=>{const i=s.order.date_created.split("T")[0];return t[i]||(t[i]=[]),t[i].push(s),t},{})}},watch:{patient:{async handler(){this.initComp()},deep:!0},$route:{handler(e){e.name==="NCDDispensations"&&this.initComp()},immediate:!0}}}),Ke={key:0,style:{margin:"20px"},class:"flex flex-col items-center justify-center p-8"},Qe={key:1,class:"p-4"},Ye={class:"text-xl font-bold mb-4 program-name"},Ze={class:"overflow-x-auto"},et={class:"w-full"},tt={class:"p-3"},nt={class:"p-3"},st={class:"flex items-center"},ot={class:"p-3"},it={class:"p-3"},rt={class:"p-3"},at={class:"flex items-center space-x-2"},lt={key:0,class:"error-text text-sm"},dt={class:"p-3"},ct={class:"flex space-x-2"},ut={key:0,class:"text-center py-8"},pt={key:2,class:"p-4"},gt={class:"text-xl font-bold mb-4 program-name"},mt={class:"text-lg font-bold mb-2"},ft={class:"text-md font-medium"},_t={class:"medication-details"},ht={class:"flex justify-between mb-3"},yt={class:"flex items-center"},vt={class:"flex items-center mb-3"},bt={key:0,class:"error-text"},Dt={class:"mt-3 flex space-x-2"},wt={key:0,class:"text-center mb-8"};function Ct(e,t,s,i,l,c){const _=d("NavigationMenu"),y=d("ViewToggleComponent"),u=d("ion-icon"),M=d("ion-input"),D=d("ion-button"),T=d("ion-card-content"),S=d("ion-card"),P=d("ion-col"),B=d("ion-row"),re=d("ion-card-title"),ae=d("ion-card-header"),le=d("ion-content"),z=d("ion-footer"),de=d("ion-page");return g(),F(de,null,{default:a(()=>[o(_,{ref:"navMenuRef"},null,512),o(y,{"initial-view":e.NCDMedicatioTogglePreference.toggle_view,onViewChanged:e.handleViewChange},null,8,["initial-view","onViewChanged"]),o(le,null,{default:a(()=>[Object.keys(e.medicationsByProgram).length===0?(g(),f("div",Ke,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-4 text-gray-500"},null,8,["icon"]),t[2]||(t[2]=n("h2",{class:"text-xl font-semibold text-gray-700 mb-2"},"No Medications to Dispense",-1)),t[3]||(t[3]=n("p",{class:"text-gray-600"},"There are currently no medications waiting to be dispensed for current Client.",-1))])):e.NCDMedicatioTogglePreference.toggle_view==="list"?(g(),f("div",Qe,[(g(!0),f(b,null,I(e.medicationsByProgram,(w,C)=>(g(),f(b,{key:C},[n("h2",Ye,r(C),1),o(S,{class:"mb-6"},{default:a(()=>[o(T,null,{default:a(()=>[n("div",Ze,[n("table",et,[t[6]||(t[6]=n("thead",null,[n("tr",{class:"bg-gray-100"},[n("th",{class:"p-3 text-left"},"Date"),n("th",{class:"p-3 text-left"},"Medication"),n("th",{class:"p-3 text-left"},"Dose"),n("th",{class:"p-3 text-left"},"Frequency"),n("th",{class:"p-3 text-left"},"Amount to Dispense"),n("th",{class:"p-3 text-left"},"Actions")])],-1)),n("tbody",null,[(g(!0),f(b,null,I(w,p=>(g(),f("tr",{key:p.order_id,class:"border-b hover:bg-gray-50"},[n("td",tt,r(e.formatHeaderDate(p.order.date_created.split("T")[0])),1),n("td",nt,[n("div",st,[o(u,{icon:e.medkit,class:"mr-2"},null,8,["icon"]),m(" "+r(p.drug.name),1)])]),n("td",ot,r(p.dose)+" "+r(p.units),1),n("td",it,r(e.getFrequencyLabel(p.frequency)),1),n("td",rt,[n("div",at,[o(M,{type:"number",placeholder:"Amount",modelValue:p.amountToDispense,"onUpdate:modelValue":v=>p.amountToDispense=v,onInput:v=>e.validateAmount(p),class:E(["w-24 dose-input bordered-input",p.error?"input-error":""])},null,8,["modelValue","onUpdate:modelValue","onInput","class"]),k("",!0)]),p.error?(g(),f("div",lt,r(p.error),1)):k("",!0)]),n("td",dt,[n("div",ct,[o(D,{color:"primary",size:"small",onClick:v=>e.dispenseMedication(p),disabled:!p.amountToDispense||p.dispensed},{default:a(()=>[o(u,{icon:e.checkmarkDoneCircleOutline,class:"mr-1",style:{"margin-right":"5px"}},null,8,["icon"]),m(" "+r(p.dispensed?"Dispensed":"Dispense"),1)]),_:2},1032,["onClick","disabled"]),o(D,{color:"secondary",size:"small",onClick:v=>e.viewDetails(p),style:{"margin-left":"10px"}},{default:a(()=>[o(u,{icon:e.eye,class:"mr-1",style:{"margin-right":"5px"}},null,8,["icon"]),t[5]||(t[5]=m(" Details "))]),_:2,__:[5]},1032,["onClick"])])])]))),128))])]),w.length===0?(g(),f("div",ut,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-2"},null,8,["icon"]),n("p",null,"No medications prescribed for "+r(C),1)])):k("",!0)])]),_:2},1024)]),_:2},1024)],64))),128))])):(g(),f("div",pt,[(g(!0),f(b,null,I(e.medicationsByProgram,(w,C)=>(g(),f(b,{key:C},[n("h2",gt,r(C),1),(g(!0),f(b,null,I(e.groupMedicationsByDate(w),(p,v)=>(g(),f(b,{key:v},[n("h3",mt,r(e.formatHeaderDate(v)),1),o(B,null,{default:a(()=>[o(P,{size:"12","size-md":"6","size-lg":"4"},{default:a(()=>[n("h3",ft,r(v),1)]),_:2},1024)]),_:2},1024),o(B,null,{default:a(()=>[(g(!0),f(b,null,I(p,h=>(g(),F(P,{key:h.order_id,size:"12","size-md":"6","size-lg":"4"},{default:a(()=>[o(S,{class:"mb-4"},{default:a(()=>[o(ae,null,{default:a(()=>[o(re,{class:"medication-details-header"},{default:a(()=>[o(u,{icon:e.medkit,class:"ion-margin-end"},null,8,["icon"]),n("span",null,r(h.drug.name),1)]),_:2},1024)]),_:2},1024),o(T,null,{default:a(()=>[n("div",_t,[n("div",ht,[n("span",yt,r(e.getFrequencyLabel(h.frequency))+" ("+r(h.frequency)+") ",1)]),n("div",vt,[o(M,{type:"number",placeholder:"Amount",modelValue:h.amountToDispense,"onUpdate:modelValue":O=>h.amountToDispense=O,onInput:O=>e.validateAmount(h),class:E(["w-24 dose-input bordered-input",h.error?"input-error":""])},null,8,["modelValue","onUpdate:modelValue","onInput","class"]),k("",!0)]),h.error?(g(),f("div",bt,r(h.error),1)):k("",!0),n("div",Dt,[o(D,{color:"primary",onClick:O=>e.dispenseMedication(h),disabled:!h.amountToDispense||h.dispensed},{default:a(()=>[o(u,{icon:e.checkmarkDoneCircleOutline,class:"mr-2",style:{"margin-right":"5px"}},null,8,["icon"]),m(" "+r(h.dispensed?"Dispensed":"Dispense"),1)]),_:2},1032,["onClick","disabled"]),o(D,{color:"secondary",style:{"margin-left":"20px"},onClick:O=>e.viewDetails(h)},{default:a(()=>[o(u,{icon:e.eye,class:"mr-2",style:{"margin-right":"5px"}},null,8,["icon"]),t[8]||(t[8]=m(" Details "))]),_:2,__:[8]},1032,["onClick"])])])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)],64))),128)),w.length===0?(g(),f("div",wt,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-2"},null,8,["icon"]),n("p",null,"No medications prescribed for "+r(C),1)])):k("",!0)],64))),128))]))]),_:1}),o(z,{collapse:"fade",class:"ion-no-border"},{default:a(()=>[o(B,null,{default:a(()=>[o(P,null,{default:a(()=>[o(D,{id:"cbtn",class:"",color:"primary",fill:"solid",style:{float:"right","margin-left":"50px"},onClick:t[0]||(t[0]=w=>e.printVisitSummary())},{default:a(()=>t[9]||(t[9]=[m(" Print Visit Summary ")])),_:1,__:[9]}),o(D,{id:"cbtn",class:"",color:"danger",fill:"solid",style:{float:"right","margin-left":"50px"},onClick:t[1]||(t[1]=w=>e.handleAbscond(e.patient))},{default:a(()=>t[10]||(t[10]=[m(" Close visit ")])),_:1,__:[10]})]),_:1})]),_:1})]),_:1}),o(z)]),_:1})}const At=te(Xe,[["render",Ct],["__scopeId","data-v-a01a3842"]]);export{At as default};
