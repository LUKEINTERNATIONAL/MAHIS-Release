var Le=Object.defineProperty;var Be=(t,e,n)=>e in t?Le(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var U=(t,e,n)=>Be(t,typeof e!="symbol"?e+"":e,n);import{H as D,aL as C,u as re,S as _,aG as J,K as ce,_ as le,P as He,t as Z,m as de,i as E,A as Ue,X as Ze,p as Ye,d as je}from"./index-BAKYi-in.js";import{l as qe}from"./lodash-Dt8AsbQm.js";import{R as Ge,d as G,aj as v,W as Y,ak as We,G as Xe,ai as N,X as j,E as P,e as q,f as k,l as m,k as h,z as u,A as w,F as ue,r as x,a as Ke,y as se,m as ae,u as f,D as oe,B as V,br as Qe}from"./vendor-jr-7G0gv.js";import{S as et}from"./sms_service-pOPyv1Ht.js";import{E as tt}from"./EIRreportsStore-BmVRLkz_.js";import{u as nt,F as ie,e as st}from"./Export-Dbqmvx0b.js";const $=Ge("immunizationAppointMentStore",{state:()=>({selectedAppointmentMent:[],selectedAppointmentMentForAppointmentsPage:"",AppointmentsReload:!1,startDate:D.sessionDate(),endDate:D.sessionDate()}),actions:{getAppointmentMents(){return this.selectedAppointmentMent},setAppointmentMent(t){this.selectedAppointmentMent.length=0,this.selectedAppointmentMent.push(t)},clearAppointmentMent(){this.selectedAppointmentMent.length=0},getSelectedAppointmentMentForAppointmentsPage(){return this.selectedAppointmentMentForAppointmentsPage},setSelectedAppointmentMentForAppointmentsPage(t){this.selectedAppointmentMentForAppointmentsPage=t},setAppointmentsReload(t){this.AppointmentsReload=t},getAppointmentsReload(){return this.AppointmentsReload},setStartEndDate(t,e){this.startDate=t,this.endDate=e},getStartEndDate(){return{startDate:this.startDate,endDate:this.endDate}}}});class O extends C{constructor(n){const s=n!==void 0?n:O.getPatientID(),r=O.getProviderID();super(s,7,r);U(this,"patientID");U(this,"providerID");this.patientID=s,this.providerID=r}static getPatientID(){return re().patient.patientID}static getProviderID(){return _.getUserID()}async setPatientID(n){this.patientID=n}async createAppointment(n){var p;let s=JSON.parse(JSON.stringify(n));const r=[];$().selectedAppointmentMent.forEach(S=>{const I=D.toStandardHisFormat(S.date);r.push(I)});const l=await this.buildValueDate("Appointment date",r[0]);return(p=s==null?void 0:s.appointments.unsaved)==null||p.push(l),await J(s),ce("next Appointment Set Successfully"),r[0]}async getNextAppointment(){if(this.programID&&this.patientID)return C.getJson("/programs/".concat(this.programID,"/patients/").concat(this.patientID,"/next_appointment_date"),{date:this.date})}async getDailyAppointments(n){const s=C.getProgramID();return C.getJson("/programs/".concat(s,"/booked_appointments"),{date:n,paginate:!1})}}const at=G({components:{IonRow:N,IonItem:Xe,IonList:We,IonButton:Y,IonCol:v},props:{date:{type:String,required:!0},patient:{type:Number,required:!0},modalaction:{type:String,required:!0}},data(){return{formattedDate:D.toStandardHisFormat(this.date)}},methods:{async dismissModal(){await j.dismiss()},async sendSMS(){await j.dismiss("send-SMS")}}}),ot={class:"saveBtn"};function it(t,e,n,s,r,c){const l=P("ion-row"),p=P("ion-button"),S=P("ion-col");return k(),q(ue,null,[m(l,{class:"centered-content"},{default:u(()=>e[0]||(e[0]=[h("div",{class:"text-container"},[h("div",null,"Do you want to send SMS reminder?")],-1)])),_:1,__:[0]}),h("div",ot,[m(l,null,{default:u(()=>[m(S,null,{default:u(()=>[m(p,{onClick:t.dismissModal,id:"cbtn",class:"btnText cbtn",fill:"solid",style:{width:"130px"}},{default:u(()=>e[1]||(e[1]=[w(" No ",-1)])),_:1,__:[1]},8,["onClick"])]),_:1}),m(S,null,{default:u(()=>[m(p,{onClick:t.sendSMS,class:"btnText",fill:"solid",style:{width:"130px","text-align":"right"}},{default:u(()=>e[2]||(e[2]=[w(" Yes ",-1)])),_:1,__:[2]},8,["onClick"])]),_:1})]),_:1})])],64)}const rt=le(at,[["render",it],["__scopeId","data-v-2bafd924"]]),ct={class:"lbl-ct"},lt={class:"lbl-ct"},dt={style:{"margin-right":"20px",color:"black"}},ut={key:0},mt={style:{color:"#999"}},pt={style:{"font-size":"16px",color:"#666","margin-top":"5px"}},ft=G({watch:{},name:"xxxComponent"}),gt=G({...ft,props:{patient_Id:{},encounter_Id:{}},setup(t){const e=re(),n=x(),s=x(),r=x(!1),c=x(!1),l=D.toStandardHisDisplayFormat(_.getSessionDate()),p=x(!1),S=x(),I=x(0),z=x([]),F=[];function pe(o){const a=new Date(_.getSessionDate());return a.setHours(0,0,0,0),o<a}const W=t;async function fe(){if($().selectedAppointmentMent.length>0)try{await xe();const i=await new O().createAppointment(e.patient);await _e(),await ye(),await K(),ge(i)}catch(a){}else Z("please select next appointment date on the calendar")}async function ge(o){if(z.value.length==0){Z("No phone numbers available for sms reminder!");return}if(o&&await de(rt,{class:"nationalIDModal"})=="send-SMS"){const i=JSON.parse(JSON.stringify(e.patient));i.sms={appointment_date:o},await J(i)}}async function _e(){const o=E();o.setVaccineReload(!o.getVaccineReload())}async function ye(){const o=$();o.setAppointmentsReload(!o.getAppointmentsReload())}Ke(async()=>{$().clearAppointmentMent(),await be(),await he()});async function he(){try{const o=new He,a=W.patient_Id!==void 0?W.patient_Id:o.getID(),i=await we(a);if(F.length>0){const d=F[F.length-1];await De(d,a)==!1&&(n.value=ne(d.vaccine.date_administered,te(i.age)),s.value=D.toStandardHisDisplayFormat(n.value),Q(n.value),ee(n.value),r.value=!0)}}catch(o){}}async function De(o,a){try{const i=new Date(e.patient.personInformation.birthdate),d=ne(i,te(o.age)),y=Se(o.vaccine.date_administered),g=new Date(d);return console.log(X(y,g)),X(y,g)}catch(i){}}function Se(o){const a={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"},i=o.split(/[:/ ]/),d="".concat(i[2],"-").concat(a[i[1]],"-").concat(i[0],"T").concat(i[3],":").concat(i[4],":").concat(i[5]);return new Date(d)}function X(o,a){const i=o.getFullYear(),d=o.getMonth(),y=o.getDate(),g=a.getFullYear(),A=a.getMonth(),M=a.getDate();return i!==g?i>g:d!==A?d>A:y>M}function ve(o){return o.forEach(a=>{a.antigens.forEach(i=>{i.status=="administered"&&F.push({age:a.age,vaccine:i})})}),F}async function we(o){try{const a=e.patient.vaccineSchedule;ve(a.vaccine_schedule);for(const i of a.vaccine_schedule)if(i.milestone_status==="current"||i.milestone_status==="upcoming")return i;return null}catch(a){return null}}async function Ae(o){try{const a=await Ue.getDailyAppointments(D.toStandardHisFormat(o),D.toStandardHisFormat(o));I.value=a.length}catch(a){}}async function K(){try{await j.dismiss()}catch(o){console.error("Modal dismissal error:",o)}}async function be(){try{let o=await et.getConfigurations();c.value=o.show_sms_popup}catch(o){}}async function xe(){var i,d;const o=JSON.parse(JSON.stringify(e.patient.guardianInformation)),a=[...o==null?void 0:o.unsaved,...o==null?void 0:o.saved];a.length>0&&((i=a[0])!=null&&i.cell_phone_number)&&z.value.push((d=a[0])==null?void 0:d.cell_phone_number),e.patient.personInformation.cell_phone_number&&z.value.push(e.patient.personInformation.cell_phone_number)}async function Q(o){const a=$(),i={counter:1,date:o};a.setAppointmentMent(i),p.value=!1,await Ae(o),p.value=!0,S.value=D.toStandardHisDisplayFormat(o)}function ee(o){const i=$().getAppointmentMents(),d=A=>{const M=new Date(A);return M.setHours(0,0,0,0),M.getTime()},y=d(new Date(o)),g=i.find(A=>d(new Date(A.date))===y);return g?g.counter:null}function te(o){const a=/(\d+)\s*(week|month|year)s?/i,i=o.match(a);if(!i)return"Invalid input format";const d=parseInt(i[1]);switch(i[2].toLowerCase()){case"week":return d*7;case"month":return d*30;case"year":return d*365;default:return"Invalid time unit"}}function ne(o,a){if(a=="Invalid input format")return"";let i;if(o instanceof Date)i=new Date(o);else{const[b,H]=o.split(" "),[Ce,Pe,Te]=b.split("/"),[Oe,Je,ze]=H.split(":"),Re={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};i=new Date(Number(Te),Re[Pe],Number(Ce),Number(Oe),Number(Je),Number(ze))}i.setDate(i.getDate()+a);const d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],g=b=>String(b).padStart(2,"0"),A=d[i.getDay()],M=y[i.getMonth()],Ie=g(i.getDate()),Me=i.getFullYear(),Ve=g(i.getHours()),Ne=g(i.getMinutes()),$e=g(i.getSeconds()),R=-i.getTimezoneOffset(),Fe=Math.floor(Math.abs(R)/60),ke=Math.abs(R)%60,Ee="GMT".concat(R>=0?"+":"-").concat(g(Fe)).concat(g(ke)),L=Intl.DateTimeFormat().resolvedOptions().timeZone;let B;try{const b=new Intl.DateTimeFormat("en",{timeZone:L,timeZoneName:"long"}).formatToParts(i).find(H=>H.type==="timeZoneName");B=b?b.value:L}catch(b){console.error("Error getting localized time zone name:",b),B=L}return"Date ".concat(A," ").concat(M," ").concat(Ie," ").concat(Me," ").concat(Ve,":").concat(Ne,":").concat($e," ").concat(Ee," (").concat(B,")")}return(o,a)=>{const i=P("VueDatePicker");return k(),q(ue,null,[m(f(N),{style:{"margin-top":"10px"}},{default:u(()=>[m(f(v),{style:{"margin-left":"-3px"}},{default:u(()=>a[1]||(a[1]=[h("div",{class:"om",style:{"font-weight":"600",color:"#8d8686"}},"Set Next Appointment Date",-1)])),_:1,__:[1]}),m(f(v),{size:"6",style:{"text-align":"right"}},{default:u(()=>[m(f(oe),{class:"lbl-tl",style:{"font-size":"13"}},{default:u(()=>[a[2]||(a[2]=w(" Todays Date: ",-1)),h("span",ct,V(f(l)),1)]),_:1,__:[2]})]),_:1})]),_:1}),m(f(N),{style:{"margin-top":"10px"}},{default:u(()=>[m(f(v),{style:{"margin-left":"-3px"}},{default:u(()=>a[3]||(a[3]=[h("div",{class:"om"},null,-1)])),_:1,__:[3]}),p.value?(k(),se(f(v),{key:0,size:"10",style:{"text-align":"right"}},{default:u(()=>[m(f(oe),{class:"lbl-tl",style:{"font-size":"16","font-weight":"500"}},{default:u(()=>[a[4]||(a[4]=w(" Total Appointments ",-1)),h("span",lt,"("+V(S.value)+")",1),a[5]||(a[5]=w(": ",-1)),h("span",dt,[m(f(Qe),{color:"primary",style:{"margin-bottom":"-5px","font-size":"15px"}},{default:u(()=>[w(V(I.value),1)]),_:1})])]),_:1,__:[4,5]})]),_:1})):ae("",!0)]),_:1}),m(f(N),{style:{"margin-top":"20px"}},{default:u(()=>[m(f(v),null,{default:u(()=>[m(i,{modelValue:n.value,"onUpdate:modelValue":a[0]||(a[0]=d=>n.value=d),onDateUpdate:Q,"enable-time-picker":!1,inline:"","auto-apply":"","disabled-dates":pe},{day:u(({day:d,date:y})=>[(k(),q("p",ut,[w(V(d),1),h("sup",mt,V(ee(y)),1)]))]),_:1},8,["modelValue"])]),_:1})]),_:1}),r.value?(k(),se(f(N),{key:0,style:{"margin-top":"0px","margin-bottom":"0px"}},{default:u(()=>[m(f(v),{style:{"background-color":"#f0f0f0",padding:"15px","border-radius":"8px","box-shadow":"0 2px 4px rgba(0, 0, 0, 0.1)"}},{default:u(()=>[a[6]||(a[6]=h("div",{style:{"font-size":"17px",color:"#333","font-weight":"bold"}},"Suggested Date:",-1)),h("div",pt,V(s.value),1)]),_:1,__:[6]})]),_:1})):ae("",!0),m(f(N),{style:{"margin-top":"10px","margin-bottom":"10px"}},{default:u(()=>[m(f(v),null,{default:u(()=>[m(f(Y),{onClick:K,id:"cbtn",class:"btnText cbtn",fill:"solid",style:{width:"130px"}},{default:u(()=>a[7]||(a[7]=[w(" Cancel ",-1)])),_:1,__:[7]})]),_:1}),m(f(v),{style:{"text-align":"right"}},{default:u(()=>[m(f(Y),{onClick:fe,class:"btnText",fill:"solid",style:{width:"130px"}},{default:u(()=>a[8]||(a[8]=[w(" save ",-1)])),_:1,__:[8]})]),_:1})]),_:1})],64)}}}),_t=le(gt,[["__scopeId","data-v-6ee82e0c"]]);async function Pt(t){var s,r;const e=JSON.parse(JSON.stringify(t)),n=E();if(!qe.isEmpty(n.getAdministeredVaccines())){const c=Dt(),l=await St();let p=e==null?void 0:e.vaccineAdministration;p.orders=[...p==null?void 0:p.orders,...c],p.voided=p.voided.filter(S=>{var I;return S.drug_name!==((I=c[0])==null?void 0:I.drug_name)}),p.obs=[...p==null?void 0:p.obs,...l],n.setVaccineReload(!n.getVaccineReload()),p.orders.length>0&&n.setLastVaccineAdminstredOnschedule(p.orders),me(e,(s=c[0])==null?void 0:s.drug_name,"administered",(r=l[0])==null?void 0:r.obs_datetime),await J(e),ce("Saved successful"),await At(e)}}function me(t,e,n,s){t.vaccineSchedule.vaccine_schedule.forEach(r=>{r.antigens.forEach(c=>{c.drug_name===e&&(c.status=n,c.date_administered=s)})})}async function Tt(t,e){const n=await yt(t);return await ht(new Date(e),n)}async function yt(t){try{let e;if(_.getUseIndexDBStatus()&&_.getModsStatus()?e=await Ye("genericVaccineSchedule"):e=await _.getJson("eir/schedule/generic",{paginate:!1}),e.length>0){if(t=="M")return e[0].genericVaccineSchedule.male_schedule;if(t=="F")return e[0].genericVaccineSchedule.female_schedule}else if(je().apiStatus){if(e=await _.getJson("eir/schedule/generic",{paginate:!1}),t=="M")return e.male_schedule;if(t=="F")return e.female_schedule}}catch(e){return console.error("Error getting offline generic vaccine schedule",e),[]}}async function ht(t,e){const n=new Date;return e.forEach(s=>{const r=s.age.toLowerCase();let c=null;if(r==="at birth")c=new Date(t);else if(r.includes("weeks")){const l=parseInt(r.split(" ")[0],10);c=new Date(t),c.setDate(t.getDate()+l*7)}else if(r.includes("months")){const l=parseInt(r.split(" ")[0],10);c=new Date(t),c.setMonth(t.getMonth()+l)}else if(r.includes("years")){const l=parseInt(r.split(" ")[0],10);c=new Date(t),c.setFullYear(t.getFullYear()+l)}c?c>n?s.milestone_status="upcoming":c.toDateString()===n.toDateString()?s.milestone_status="current":s.milestone_status="passed":s.milestone_status="unknown"}),{vaccine_schedule:e}}function Dt(){return E().getAdministeredVaccines().map(e=>{var n,s,r;return{drug_name:((s=(n=e==null?void 0:e.drug_)==null?void 0:n.drug)==null?void 0:s.drug_name)||((r=e==null?void 0:e.drug_)==null?void 0:r.drug_name),drug_inventory_id:e.drug_id,equivalent_daily_dose:1,start_date:e.date_administered,auto_expire_date:vt(e.date_administered,1),units:"ml",instructions:"",dose:1,frequency:"Unknown",batch_number:e.batch_number||"Unknown",prn:0}})}async function St(){const e=E().getAdministeredVaccines();return await Promise.all(e.map(async s=>{var r,c,l;return{concept_id:2876,value_text:((c=(r=s==null?void 0:s.drug_)==null?void 0:r.drug)==null?void 0:c.drug_name)||((l=s==null?void 0:s.drug_)==null?void 0:l.drug_name),obs_datetime:s.date_administered}}))}function vt(t,e){const n=new Date(t);return n.setDate(n.getDate()+parseInt(e)),D.toStandardHisFormat(n)}function wt(){de(_t,{class:"otherVitalsModal"},!1)}async function At(t){var s,r;const e=E(),n=e.getLastVaccineAdminstredOnschedule();n.length>0&&((r=(s=t==null?void 0:t.vaccineSchedule)==null?void 0:s.vaccine_schedule)==null||r.forEach(c=>{bt(c.antigens)==!0&&c.antigens.forEach(l=>{l.drug_id==n[0].drug_inventory_id&&wt()})})),e.setLastVaccineAdminstredOnschedule([])}function bt(t){return t.every(e=>e.status==="administered")}async function Ot(t,e,n){const s=JSON.parse(JSON.stringify(t));let r=s==null?void 0:s.vaccineAdministration;r.orders.some(l=>l.drug_name===e.drug.drug_name)?(r.orders=r.orders.filter(l=>l.drug_name!==e.drug.drug_name),r.obs=r.obs.filter(l=>l.value_text!==e.drug.drug_name)):r.voided=[...r==null?void 0:r.voided,{reason:n,order_id:e.drug.order_id,drug_name:e.drug.drug_name}],me(s,e.drug.drug_name,"pending",""),await J(s)}async function Jt(t,e){return _.void("/encounters/".concat(t),{reason:e})}function zt(t){return xt(t.drug_name)==!0}function xt(t){const e=["Vit","Albendazole"],n=t.toLowerCase().split(/[\s,()]+/);return e.some(s=>s.toLowerCase().split(/[\s,()]+/).some(c=>n.some(l=>l.includes(c)||c.includes(l))))}async function Rt(){return await _.getJson("immunization/months_picker")}async function Lt(t,e){return await _.getJson("immunization/vaccines_administered",{start_date:t,end_date:e})}async function Bt(t,e){return await _.getJson("immunization/aefi_report",{start_date:t,end_date:e})}async function Ht(){return await _.getJson("immunization/under_five_immunizations_drugs")}async function Ut(){return await _.getJson("/immunization/vaccine_names")}function T(t){return/[,"\n]/.test(t)?'"'.concat(t.replace(/"/g,'""'),'"'):t}function Zt(){try{const t=tt(),e=Ze(),{activePlatformProfile:n}=nt();let s=It(t.$state.immunizationMonthlyRepoartData);s+="\n",s+=Mt(t.$state.AEFIReportData),s+="\n",s+="\n        Date Created: ".concat(new Date().toISOString().split("T")[0],"\n        Report Period: ").concat(t.$state.navigationPayload.subTxt,"\n        Site: ").concat(e.$state.userFacilityName);const r=new Blob([s],{type:"text/csv;charset=utf-8;"}),c="".concat(e.$state.userFacilityName,"_").concat(t.$state.navigationPayload.subTxt,"_").concat(t.$state.navigationPayload.title);if(n.value.fileExport===ie.WEB){const l=document.createElement("a");l.href=window.URL.createObjectURL(r),l.setAttribute("download","".concat(c,".csv")),l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l)}else n.value.fileExport===ie.FILE_SYSTEM?st("".concat(c,".csv"),r,"blob"):Z("Platform not supported")}catch(t){console.error("Error exporting CSV:",t)}}function It(t){let e="Category,Static <1y,Static >1y,Outreach <1y,Outreach >1y\n";for(const n of t){const s=[T(n.label),n.fixed.lessThan1y,n.fixed.moreThan1y,n.outreach.lessThan1y,n.outreach.moreThan1y].join(",");e+=s+"\n"}return e}function Mt(t){let e="Cases,"+t.vaccines.map(n=>T(n.name)).join(",")+"\n";for(const n of t.categories){e+=T(n.name)+"\n";for(const s of n.cases){const r=[T(s.name),...s.data.map(c=>c.count)];e+=r.join(",")+"\n"}}return e}export{O as A,rt as a,Rt as b,Ut as c,Lt as d,Zt as e,Ht as f,Tt as g,Bt as h,zt as i,Ot as j,_t as n,Pt as s,$ as u,Jt as v};
