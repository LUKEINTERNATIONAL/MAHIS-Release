var _=Object.defineProperty;var O=(e,a,s)=>a in e?_(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s;var c=(e,a,s)=>O(e,typeof a!="symbol"?a+"":a,s);import{d as R,ar as g,b$ as I,U as C,T as B,as as k,ac as N,G as F,S as H,a9 as P,c2 as $,X as A,a1 as E,a2 as W,E as b,e as u,f as p,m as T,l as D,k as v,z as V,F as z,L as J,B as q}from"./vendor-BzS-GRGX.js";import{ao as r,D as U,al as j,H as f,i as L,A as G,g as K,h as X,k as w,f as Q,an as y,j as Y,S as Z,ap as x,u as ee,_ as te}from"./index-xmN8DORW.js";import{S as ae,L as se,a as ne,u as S,E as ie,b as oe}from"./lab_order-DIoQjVnZ.js";import{a as re,b as le}from"./SvgDynamicColor-Q4ht95M8.js";import{D as de}from"./DashBox-bjCJqNrw.js";import{P as ce}from"./patient_lab_service-BOxBHrs2.js";import{A as M}from"./app_encounter_service-BLy4tvzY.js";class ue extends M{constructor(s){super(s,32);c(this,"patientID");c(this,"testTypeID");c(this,"resultDate");c(this,"testID");this.patientID=s,this.testTypeID=-1,this.resultDate="",this.testID=-1}createLabResult(s){return M.postJson("lab/tests/".concat(this.testID,"/results"),{encounter_id:this.encounterID,date:this.resultDate,measures:s})}getTestID(){return this.testID}getTestTypeID(){return this.testTypeID}setTestTypeID(s){this.testTypeID=s}setResultDate(s){this.resultDate=s}setTestID(s){this.testID=s}getTestsWithoutResults(){return r.getOrders(this.patientID,{status:"drawn"})}getTestIndicators(){return r.getJson("lab/test_result_indicators",{test_type_id:this.testTypeID})}static getTestIndicatorsWithID(s){return r.getJson("lab/test_result_indicators",{test_type_id:s})}}const pe=R({name:"Menu",components:{CheckInConfirmationModal:j,IonContent:P,IonHeader:H,IonItem:F,IonList:N,IonMenu:k,IonTitle:B,IonToolbar:C,DynamicButton:U,DashBox:de,LabModal:ne,LabViewResultsModal:se,SendToLabConfirmationModal:ae,DataTable:I},computed:{...g(ee,["patient"]),...g(S,["labResults"]),...g(x,["investigations"]),...g(w,["patientsWaitingForVitals","patientsWaitingForConsultation","patientsWaitingForLab","patientsWaitingForDispensation"]),hasEnterResults(){return this.listOrders.some(e=>e.btn&&e.btn.includes("enter_results"))}},props:{propOrders:{default:[]}},data(){return{loading:!1,tableData:[],options:{responsive:!0,select:!1,layout:{topStart:"",topEnd:"search",bottomStart:"info",bottomEnd:"paging"},ordering:!1,order:[[3,"desc"]]},header:["Lab Test","Specimen","Accession Number","Order Date","Result"],iconsContent:L,valueNumericArray:[],obsDatetime:[],graphIcon:le(["#006401"]),listIcon:re(["#636363"]),displayGraph:!0,sendToLabModalOpen:!1,orders:[],userRoles:[],height:[],BMI:[],iconBg:{},activeWeight:[],activeHeight:[],activeBMI:[],listOrders:[],listResults:[],hasPatientsWaitingForLab:!1,labResultsContent:"",listHeaderOrders:"",service:"",openModal:!1,openResultsModal:!1,series:[{name:"",data:[]}]}},setup(){return{checkmark:W,pulseOutline:E}},async mounted(){this.loading=!0,await this.updateInvestigationWizard(),await this.setListData(),this.loading=!1,this.$nextTick(()=>{const e=this.$refs.dataTable.dt;e.columns.adjust().draw(),e.on("click",".result-btn",a=>{const s=a.target.getAttribute("data-id");this.openResultsForm(JSON.parse(s))}),e.on("click",".view-btn",a=>{const s=a.target.getAttribute("data-id");this.viewLabOrder(JSON.parse(s))}),e.on("click",".delete-btn",a=>{const s=a.target.getAttribute("data-id");this.voidLabOrder(JSON.parse(s),a)}),e.on("click",".order-btn",a=>{const s=a.target.getAttribute("data-id");this.saveTest(JSON.parse(s))})}),this.orders=this.propOrders,this.service=new ce(this.patient.patientID),this.userRoles=await Z.getUserRoles()},watch:{$route:{async handler(){await this.setListData()},deep:!0},patient:{async handler(e){e&&e.patientID&&await this.setListData()},immediate:!0},tableData:{handler(e){if(this.$refs.dataTable){const a=this.$refs.dataTable.dt;a.clear(),a.rows.add(e),a.draw()}},deep:!0}},methods:{async closeModal(){this.openModal=!1,await this.setListData()},async saveTest(e){await new oe().postActivities(this.patient.patientID,[{concept_id:await y.getConceptID(e.name,!0),name:e.name,specimen:e.specimen,reason:"Routine",specimenConcept:await y.getConceptID(e.specimen,!0)}]),Y("Successfully saved"),this.orders=await r.getOrders(this.patient.patientID),this.tableData=this.generateListItems(this.orders,"order"),this.tableData.sort((n,t)=>{const o=new Date(n[3]);return new Date(t[3]).getTime()-o.getTime()});const s=this.$refs.dataTable.dt;s.clear(),s.rows.add(this.tableData),s.draw()},async openEnterResultModal(){await Q(ie,{class:"lab-results-modal"},!0,{title:"name"}),await this.setListData()},toggleSendToLabModal(){this.sendToLabModalOpen=!this.sendToLabModalOpen},async fetchPatientLabStageData(){const e=await K(),a=e?e.code:null;if(a){const s=await X.getPatientList("LAB",a);await w().refresh(a),this.patient.patientID&&(this.hasPatientsWaitingForLab=s.some(n=>n.patient_id===this.patient.patientID))}},async updateInvestigationWizard(){this.orders=await r.getOrders(this.patient.patientID);const e=await this.orders.filter(a=>f.toStandardHisFormat(f.sessionDate())===f.toStandardHisFormat(a.order_date));e.length>0?this.investigations[0].selectedData=e:this.investigations[0].selectedData=""},dismiss(){A.dismiss()},async voidLabOrder(e,a){await G("Do you want to delete ".concat(e.tests[0].name," ?"),a)&&await this.service.voidOrder(e.id,"Mistake entry"),await this.setListData()},async openResultsForm(e){const a=await ue.getTestIndicatorsWithID(e.concept_id);console.log({testIndicators:a});const s=[e,{validationStatus:"",data:{rowData:[{colData:[]}]}}];a.forEach(t=>{let o={inputHeader:t.name,value:"",colSize:3,id:t.concept_id,name:t.name,required:!0,eventType:"input",alertsErrorMassage:""};if(t.name=="RBS"&&(o={inputHeader:t.name,value:"",colSize:3,id:t.concept_id,name:t.name,required:!0,eventType:"input",alertsErrorMassage:"",validationFunctionName:"validateRBS",unit:"mg/dL"}),t.name=="FBS"&&(o={inputHeader:t.name,value:"",colSize:3,id:t.concept_id,name:t.name,required:!0,eventType:"input",alertsErrorMassage:"",validationFunctionName:"validateFBS",unit:"mg/dL"}),t.name=="MRDT"||t.name=="Tuberculosis program"||t.name=="Vdrl"||t.name=="Hepatitis B"||t.name=="Lam"||t.name=="CrAg"||t.name=="CD4 count"||t.name=="Leukocytes"||t.name=="Protein"||t.name=="Nitrite"||t.name=="Urine Ketones"||t.name=="HIV test"){let i=[];(t.name=="MRDT"||t.name=="Vdrl"||t.name=="Hepatitis B"||t.name=="CrAg"||t.name=="Lam")&&(i=[{id:"1",name:"Positive"},{id:"2",name:"Negative"},{id:"3",name:"Invalid"}]),t.name=="Tuberculosis program"&&(i=[{id:"1",name:"Scanty"},{id:"2",name:"Negative"},{id:"3",name:"1+"},{id:"4",name:"2+"},{id:"5",name:"3+"}]),t.name=="CD4 count"&&(i=[{id:"1",name:"below reference line"},{id:"2",name:"above reference line"}]),(t.name=="Leukocytes"||t.name=="Protein"||t.name=="Nitrite"||t.name=="Ketones"||t.name=="Urine Ketones")&&(i=[{id:"2",name:"Negative"},{id:"1",name:"Trace"},{id:"3",name:"1+"},{id:"4",name:"2+"},{id:"5",name:"3+"},{id:"6",name:"4+"}]),t.name=="HIV test"&&(i=[{id:"2",name:"Positive"},{id:"1",name:"Negative"},{id:"3",name:"Invalid"}]),o={inputHeader:t.name,icon:L.search,value:"",name:"units",eventType:"input",alertsErrorMassage:"",isSingleSelect:!0,trackBy:"id",multiSelectData:i,id:t.concept_id,idName:"district_id"}}s[1].data.rowData[0].colData.push(o)}),S().setLabResults(s),this.openModal=!0,this.orders=await r.getOrders(this.patient.patientID),console.log("ðŸš€ ~ openResultsForm ~ this.orders:",this.orders)},async viewLabOrder(e){this.labResultsContent=e,this.openResultsModal=!0},async setListData(){this.loading=!0,this.orders=await r.getOrders(this.patient.patientID);let e=this.generateListItems(this.orders,"order");e.sort((o,i)=>{const l=new Date(o[3]);return new Date(i[3]).getTime()-l.getTime()});const a=[],s=a.filter(o=>!e.some(i=>i[0]===o[0])),n=e.filter(o=>a.some(i=>i[0]===o[0])),t=e.filter(o=>!n.some(i=>i[0]===o[0]));this.tableData=[...n,...s,...t],await this.updateInvestigationWizard(),this.loading=!1,I.use($)},generateListItems(e,a){return e.length>0?e.flatMap(s=>s.tests.flatMap(n=>{var i,l,d,m;const t='<button class="btn btn-outline-secondary btn-sm view-btn" data-id=\''.concat(JSON.stringify(n),"'>").concat(this.iconsContent.view2,"</button> ");let o="";return((i=n==null?void 0:n.result)==null?void 0:i.length)==1?o=(n==null?void 0:n.result)!=null?((l=n==null?void 0:n.result[0])==null?void 0:l.value_modifier)+((d=n==null?void 0:n.result[0])==null?void 0:d.value):null:((m=n==null?void 0:n.result)==null?void 0:m.length)>1&&(n==null||n.result,o=t),[[n.name,s.specimen.name,s.accession_number,f.toStandardHisFormat(s.order_date),o]]})):[]}}}),me={class:"container"},he={key:0,class:"loading-container"},ge={key:1,class:"table-responsive"};function be(e,a,s,n,t,o){const i=b("ion-spinner"),l=b("DataTable"),d=b("LabViewResultsModal"),m=b("LabModal");return p(),u("div",me,[e.loading?(p(),u("div",he,[D(i,{name:"crescent"}),a[2]||(a[2]=v("p",null,"Loading lab results...",-1))])):T("",!0),e.loading?T("",!0):(p(),u("div",ge,[D(l,{ref:"dataTable",options:e.options,data:e.tableData,class:"display nowrap",width:"100%"},{default:V(()=>[v("thead",null,[v("tr",null,[(p(!0),u(z,null,J(e.header,h=>(p(),u("th",{key:h,"data-orderable":!0},q(h),1))),128))])])]),_:1},8,["options","data"])])),D(d,{popoverOpen:e.openResultsModal,content:e.labResultsContent,onCloseModal:a[0]||(a[0]=h=>e.openResultsModal=!1)},null,8,["popoverOpen","content"]),D(m,{popoverOpen:e.openModal,onSaved:e.closeModal,onCloseModal:a[1]||(a[1]=h=>e.openModal=!1)},null,8,["popoverOpen","onSaved"])])}const De=te(pe,[["render",be],["__scopeId","data-v-519fa306"]]),Me=Object.freeze(Object.defineProperty({__proto__:null,default:De},Symbol.toStringTag,{value:"Module"}));export{De as L,ue as P,Me as a};
