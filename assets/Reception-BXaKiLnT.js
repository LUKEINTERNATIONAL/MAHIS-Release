var fa=Object.defineProperty;var _a=(B,R,P)=>R in B?fa(B,R,{enumerable:!0,configurable:!0,writable:!0,value:P}):B[R]=P;var Ue=(B,R,P)=>_a(B,typeof R!="symbol"?R+"":R,P);import{d as Le,b1 as Re,r as d,c as we,a as Ee,w as ba,E as Pe,y as w,f as p,u as t,bd as ha,z as i,l,U as ga,T as ya,A as h,W as ce,S as Na,k as _,e as N,m as g,G as Se,a3 as wa,I as ge,cb as Pa,bj as Sa,aJ as Aa,F as Va,L as ka,B as L,br as pe,p as E,D as V,bm as je,aa as re,ab as D,bu as Ia,a9 as Ra,db as Ca,aY as qa,d9 as Da,i as xa,bk as Ga,a$ as Ta}from"./vendor-CKGLxZg5.js";import{a2 as ze,u as Ye,b as $a,z as Ae,L as me,B as Be,aW as Fa,P as ye,t as Y,j as Me,_ as We,q as Oa,l as Ua}from"./index-kdr2EpoV.js";import{A as Ba}from"./app_encounter_service-98GsPszC.js";import{R as Ve}from"./relations_service-DCqjFL58.js";import{P as Ma}from"./patient_registration_service-CqqQR6LP.js";import{I as La}from"./identifier_service-BPuTgMcc.js";import{B as ke}from"./BasicYesNoSelect-BZYSSFsU.js";import{P as Ea}from"./patient_type_service-BotodM9K.js";import"./lodash-Dt8AsbQm.js";class ja extends Ba{constructor(P,k,m){super(P,51,k,m);Ue(this,"sitePrefix");this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}createArvNumber(P){return ze.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:P})}buildArvNumber(P){return"".concat(this.sitePrefix,"-ARV-").concat(P)}}const za={class:"form-container"},Ya={class:"search-section"},Wa={key:0,class:"search-results"},Ha={key:0,class:"search-loading"},Ja={key:1},Qa=["onClick"],Za={class:"guardian-name"},Ka={key:0,class:"relationship-badge"},Xa={key:0,class:"guardian-address"},et={key:0,class:"relationship-selector"},at={class:"relationship-actions"},tt={class:"pagination"},rt=["disabled"],lt={class:"page-info"},st=["disabled"],nt={key:2,class:"no-results"},it={key:0,class:"create-form-section"},ot={key:0},ut={key:1},dt={key:2},vt={key:0},ct={key:1},pt={key:2},mt={class:"form-row"},ft={class:"form-group radio-group"},_t={class:"radio-label-container"},Ie=10,bt=Le({__name:"ManageGuardian",props:{isOpen:{type:Boolean,required:!0}},emits:["close","whenSaved","guardianSelected"],setup(B,{emit:R}){const P=Ye(),{patient:k}=Re(P),m=$a(),{apiStatus:j}=Re(m),H=R,G=d(""),J=d([]),Q=d(!1),T=d(!1),r=d(1),u=d([]),le=d([]),se=d([]),$=d(null),F=d(null),v=d({firstName:"",lastName:"",gender:"",phone:"",address:{},relationship:""}),C=d(null),O=d(null),z=d(null),s=d([]),n=d([]),f=d([]),S=d(!1),A=d(!1),x=d(!1),ne=d(!1),ie=d([]),fe=d(null),W=d(!1),Z=d(!1),K=d(!1),oe=d(!1),X=d(!1),ee=d(""),ae=d(""),Ne=we(()=>Math.ceil(u.value.length/Ie)),He=we(()=>{const a=(r.value-1)*Ie,e=a+Ie;return u.value.slice(a,e)});we(()=>v.value.firstName.trim()!==""&&v.value.lastName.trim()!==""&&v.value.relationship),Ee(async()=>{await Xe(),await Ge()});const _e=()=>{pa(),H("close")},Je=()=>{clearTimeout(Ce),Ce=setTimeout(()=>{T.value=!1,qe()},300)};let Ce;const qe=async()=>{if(!G.value.trim()){u.value=[],r.value=1;return}Q.value=!0;try{const a=await ye.getJson("people/".concat(k.value.patientID,"/relationships"));le.value=a.map(c=>{var q,M,U,ue,te,de,he,ve,Te,$e,Fe,Oe;if(((M=(q=c.relation)==null?void 0:q.person_id)==null?void 0:M.toString())===k.value.patientID)return null;const o=((ue=(U=c.relation)==null?void 0:U.names)==null?void 0:ue[0])||{},I=((de=(te=c.relation)==null?void 0:te.addresses)==null?void 0:de[0])||{};return{id:(ve=(he=c.relation)==null?void 0:he.person_id)==null?void 0:ve.toString(),firstName:o.given_name||"Unknown",lastName:o.family_name||"",phone:((Fe=($e=(Te=c.relation)==null?void 0:Te.person_attributes)==null?void 0:$e.find(ma=>ma.value))==null?void 0:Fe.value)||"",relationship:((Oe=c.type)==null?void 0:Oe.b_is_to_a)||"Other",address:{city_village:I.city_village||"",township_division:I.township_division||"",state_province:I.state_province||""},source:"existing"}}).filter(Boolean);const e=G.value.split(" "),y={given_name:e[0],family_name:e.length>=2?e[1]:"",page:"1",per_page:"20",exclude_patient_id:k.value.patientID},b=await ye.search(y);se.value=b.filter(c=>c.person.person_id.toString()!==k.value.patientID).map(c=>{var q,M;const o=c.person.names[0],I=c.person.addresses[0]||{};return{id:c.person.person_id.toString(),firstName:o.given_name,lastName:o.family_name,phone:((M=(q=c.person.attributes)==null?void 0:q.find(U=>U.attribute_type==="Cell Phone Number"))==null?void 0:M.value)||"",relationship:"",address:{city_village:I.city_village||"",township_division:I.township_division||"",state_province:I.state_province||""},source:"search"}}),u.value=[...le.value,...se.value.filter(c=>!le.value.some(o=>o.id===c.id))].sort((c,o)=>{const I="".concat(c.firstName," ").concat(c.lastName).toUpperCase(),q="".concat(o.firstName," ").concat(o.lastName).toUpperCase();return I.localeCompare(q)}),r.value=1}catch(a){Y("Failed to search guardians")}finally{Q.value=!1}},Qe=a=>{a.relationship?De(a):(F.value=a,$.value=null)},De=async a=>{try{const e=ie.value.find(y=>{var b;return y.value===(a.relationship||((b=$.value)==null?void 0:b.value))});e&&(await Ve.createRelation(k.value.patientID,a.id,e.other.relationship_type_id),H("guardianSelected",{...a,relationship:e.value,address:a.address||{city_village:"",township_division:"",state_province:""}}),_e(),Me("Guardian relationship created successfully"))}catch(e){Y("Failed to create guardian relationship")}finally{xe()}},Ze=()=>{if(X.value=!$.value,!$.value){Y("Please select a relationship");return}De(F.value)},Ke=()=>{xe()},xe=()=>{F.value=null,$.value=null,X.value=!1},Xe=async()=>{try{const a=await Ae("districts"),e=Array.isArray(a)?a:(a==null?void 0:a.records)||[];if(s.value=e.map(y=>({name:y.name,district_id:y.district_id||y.id})),s.value.length===0&&j.value){const y=await me.getAllDistricts();s.value=y.map(b=>({name:b.name,district_id:b.district_id||b.id}))}}catch(a){console.error("District loading error:",a),s.value=[]}},ea=async a=>{try{const e=await Ae("TAs",{whereClause:{district_id:a.district_id}}),y=Array.isArray(e)?e:(e==null?void 0:e.records)||[];if(n.value=y.map(b=>({name:b.name,traditional_authority_id:b.traditional_authority_id||b.id})),n.value.length===0&&j.value){const b=await me.getTraditionalAuthorities(a.district_id);n.value=b.map(c=>({name:c.name,traditional_authority_id:c.traditional_authority_id||c.id}))}}catch(e){console.error("TA loading error:",e),n.value=[]}},aa=async a=>{try{const e=await Ae("villages",{whereClause:{traditional_authority_id:a.traditional_authority_id}}),y=Array.isArray(e)?e:(e==null?void 0:e.records)||[];if(f.value=y.map(b=>({name:b.name,village_id:b.village_id||b.id})),f.value.length===0&&j.value){const b=await me.getVillages(a.traditional_authority_id);f.value=b.map(c=>({name:c.name,village_id:c.village_id||c.id}))}}catch(e){console.error("Village loading error:",e),f.value=[]}},ta=()=>{const a=be(v.value.firstName);Z.value=!a.valid,ee.value=a.reason;const e=be(v.value.lastName);return K.value=!e.valid,ae.value=e.reason,ne.value=!v.value.gender,S.value=!C.value,A.value=!O.value,x.value=!z.value,W.value=!v.value.relationship,!(Z.value||K.value||ne.value||S.value||A.value||x.value||W.value)},be=a=>{const e=a.trim();return e===""?{valid:!1,reason:"required"}:/^[A-Za-z']+$/.test(e)?e.length<3?{valid:!1,reason:"too_short"}:{valid:!0,reason:""}:{valid:!1,reason:"invalid_chars"}},ra=a=>{v.value.firstName=a.target.value;const e=be(v.value.firstName);return ee.value=e.reason,Z.value=!e.valid,{valid:!0,reason:""}},la=a=>{v.value.lastName=a.target.value;const e=be(v.value.lastName);return ae.value=e.reason,K.value=!e.valid,{valid:!0,reason:""}},sa=a=>/^(88|99|98|89)\d{7}$/.test(a.trim()),na=a=>{v.value.phone=a.target.value,oe.value=!sa(v.value.phone)},ia=a=>{v.value.gender=a,ne.value=!a},oa=a=>{C.value=a,S.value=!a,a&&ea(a)},ua=a=>{O.value=a,A.value=!a,a&&aa(a)},da=a=>{z.value=a,x.value=!a},va=a=>{fe.value=a,v.value.relationship=(a==null?void 0:a.value)||"",W.value=!v.value.relationship},ca=async()=>{var a,e,y;if(!ta()){Y("Please fill all required fields");return}try{const b=((a=z.value)==null?void 0:a.name)||"",c=((e=O.value)==null?void 0:e.name)||"",o=((y=C.value)==null?void 0:y.name)||"",I={given_name:v.value.firstName,family_name:v.value.lastName,gender:v.value.gender,birthdate:"",birthdate_estimated:!0,attributes:{cell_phone_number:v.value.phone}},M=await new Ma().registerGuardian(I);if(!M||!M.person_id)throw new Error("Failed to create guardian - no person ID returned");const U=M.person_id;console.log("Guardian created with ID:",U);const ue={person_id:U,address1:b,address2:c,city_village:b,township_division:c,state_province:o,country:"Malawi",preferred:1,latitude:"",longitude:""};let te;try{te=await me.createAddress(ue),te||(te=await me.postJson("person/"+U+"/address",ue))}catch(ve){}const de=ie.value.find(ve=>ve.value===v.value.relationship);de&&await Ve.createRelation(k.value.patientID,U,de.other.relationship_type_id);const he={id:U.toString(),firstName:v.value.firstName,lastName:v.value.lastName,phone:v.value.phone,relationship:v.value.relationship,address:{city_village:b,township_division:c,state_province:o,country:"Malawi"}};H("whenSaved",he),_e(),Me("Guardian created successfully")}catch(b){Y("Failed to complete guardian creation: ")}},Ge=async()=>{try{const a=await Ve.getRelations();ie.value=a.map(e=>({label:e.b_is_to_a,value:e.b_is_to_a,other:e}))}catch(a){console.error("Failed to load relationships",a)}},pa=()=>{v.value={firstName:"",lastName:"",gender:"",phone:"",address:{},relationship:""},C.value=null,O.value=null,z.value=null,fe.value=null,G.value="",J.value=[],u.value=[],r.value=1,Z.value=!1,K.value=!1,oe.value=!1,ne.value=!1,S.value=!1,A.value=!1,x.value=!1,W.value=!1,X.value=!1,ee.value="",ae.value="",T.value=!1,F.value=null,$.value=null};return Ge(),ba(T,a=>{a?J.value=[]:G.value&&qe()}),(a,e)=>{const y=Pe("ion-buttons"),b=Pe("ion-radio"),c=Pe("ion-radio-group");return p(),w(t(ha),{"is-open":B.isOpen,onDidDismiss:_e,class:"guardian-modal"},{default:i(()=>[l(t(Na),null,{default:i(()=>[l(t(ga),null,{default:i(()=>[l(t(ya),{class:"modal-title"},{default:i(()=>e[12]||(e[12]=[h("Search/Add Guardian")])),_:1,__:[12]}),l(y,{slot:"end"},{default:i(()=>[l(t(ce),{onClick:_e,class:"close-button"},{default:i(()=>e[13]||(e[13]=[h("Close")])),_:1,__:[13]})]),_:1})]),_:1})]),_:1}),l(t(Ra),{class:"ion-padding modal-content"},{default:i(()=>[_("div",za,[_("div",Ya,[l(t(Se),{class:"search-item",lines:"full"},{default:i(()=>[l(t(wa),{modelValue:G.value,"onUpdate:modelValue":e[0]||(e[0]=o=>G.value=o),placeholder:"Search Guardian",onIonInput:Je,class:"search-input"},{default:i(()=>[l(t(ge),{icon:t(Pa),slot:"start"},null,8,["icon"])]),_:1},8,["modelValue"]),l(t(ce),{slot:"end",fill:"clear",onClick:e[1]||(e[1]=o=>T.value=!0),title:"Create new guardian"},{default:i(()=>[l(t(ge),{icon:t(Sa)},null,8,["icon"]),l(t(ge),{icon:t(Aa)},null,8,["icon"])]),_:1})]),_:1}),G.value&&!T.value?(p(),N("div",Wa,[Q.value?(p(),N("div",Ha," Searching... ")):u.value.length>0?(p(),N("div",Ja,[(p(!0),N(Va,null,ka(He.value,o=>{var I;return p(),N("div",{key:o.id,class:"result-item"},[_("div",{class:"result-item-content",onClick:q=>Qe(o)},[_("div",Za,[h(L(o.firstName)+" "+L(o.lastName)+" ",1),o.relationship?(p(),N("span",Ka,"("+L(o.relationship)+")",1)):g("",!0)]),o.address?(p(),N("div",Xa,L(typeof o.address=="object"?"".concat(o.address.city_village).concat(o.address.township_division?", "+o.address.township_division:"").concat(o.address.state_province?", "+o.address.state_province:""):"Address available"),1)):g("",!0)],8,Qa),((I=F.value)==null?void 0:I.id)===o.id?(p(),N("div",et,[l(t(pe),{modelValue:$.value,"onUpdate:modelValue":e[2]||(e[2]=q=>$.value=q),options:ie.value,label:"label","track-by":"value",placeholder:"Select relationship*",searchable:!0,class:E({"error-state":X.value}),onInput:e[3]||(e[3]=q=>X.value=!1)},null,8,["modelValue","options","class"]),X.value?(p(),w(t(V),{key:0,class:"error-label",style:{display:"block","margin-top":"5px"}},{default:i(()=>e[14]||(e[14]=[h(" Relationship is required ")])),_:1,__:[14]})):g("",!0),_("div",at,[l(t(ce),{onClick:Ze,size:"small",class:"confirm-btn"},{default:i(()=>e[15]||(e[15]=[h(" Confirm ")])),_:1,__:[15]}),e[17]||(e[17]=_("div",{class:"spacer"},null,-1)),l(t(ce),{onClick:Ke,fill:"outline",size:"small",class:"cancel-btn"},{default:i(()=>e[16]||(e[16]=[h(" Cancel ")])),_:1,__:[16]})])])):g("",!0)])}),128)),_("div",tt,[_("button",{onClick:e[4]||(e[4]=o=>r.value=Math.max(1,r.value-1)),disabled:r.value===1,class:"pagination-button"}," < ",8,rt),_("span",lt,"Page "+L(r.value)+" of "+L(Ne.value),1),_("button",{onClick:e[5]||(e[5]=o=>r.value=Math.min(Ne.value,r.value+1)),disabled:r.value===Ne.value,class:"pagination-button"}," > ",8,st)])])):(p(),N("div",nt,[_("p",null,'No guardians found matching "'+L(G.value)+'"',1)]))])):g("",!0)]),T.value?(p(),N("div",it,[l(t(je),{class:"form-grid"},{default:i(()=>[l(t(re),{class:"form-row"},{default:i(()=>[l(t(D),{class:"form-column"},{default:i(()=>[l(Be,{inputHeader:"First name*",inputValue:v.value.firstName,"onUpdate:inputValue":e[6]||(e[6]=o=>ra(o)),inputType:"text",error:Z.value},null,8,["inputValue","error"]),Z.value?(p(),w(t(V),{key:0,class:"error-label"},{default:i(()=>[ee.value==="required"?(p(),N("span",ot,"First name is required")):ee.value==="invalid_chars"?(p(),N("span",ut,"First name can only contain letters and apostrophes")):ee.value==="too_short"?(p(),N("span",dt,"First name must be at least 3 characters")):g("",!0)]),_:1})):g("",!0)]),_:1}),l(t(D),{class:"form-column"},{default:i(()=>[l(Be,{inputHeader:"Last name*",inputValue:v.value.lastName,"onUpdate:inputValue":la,inputType:"text",required:!0,error:K.value},null,8,["inputValue","error"]),K.value?(p(),w(t(V),{key:0,class:"error-label"},{default:i(()=>[ae.value==="required"?(p(),N("span",vt,"First name is required")):ae.value==="invalid_chars"?(p(),N("span",ct,"First name can only contain letters and apostrophes")):ae.value==="too_short"?(p(),N("span",pt,"First name must be at least 3 characters")):g("",!0)]),_:1})):g("",!0)]),_:1})]),_:1}),_("div",mt,[l(t(D),{class:"form-column"},{default:i(()=>[_("div",ft,[_("div",_t,[e[21]||(e[21]=_("label",{class:"label-title"},[h("Gender "),_("span",{class:"required"},"*")],-1)),l(c,{value:v.value.gender,onIonChange:e[7]||(e[7]=o=>ia(o.detail.value)),class:"inline-radio-group"},{default:i(()=>[l(t(Se),{lines:"none",class:"inline-radio-item",style:{"--background":"white"}},{default:i(()=>[l(b,{slot:"start",value:"M",style:{"margin-right":"16px"}}),l(t(V),null,{default:i(()=>e[18]||(e[18]=[h("Male")])),_:1,__:[18]})]),_:1}),l(t(Se),{lines:"none",class:"inline-radio-item",style:{"--background":"white"}},{default:i(()=>[l(b,{slot:"start",value:"F",style:{"margin-right":"16px"},class:"custom-radio"}),l(t(V),null,{default:i(()=>e[19]||(e[19]=[h("Female")])),_:1,__:[19]})]),_:1})]),_:1},8,["value"]),ne.value?(p(),w(t(V),{key:0,class:"error-label"},{default:i(()=>e[20]||(e[20]=[h(" Gender is required ")])),_:1,__:[20]})):g("",!0)])])]),_:1}),l(t(D),{class:"form-column"},{default:i(()=>[l(t(V),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:i(()=>e[22]||(e[22]=[h("District"),_("span",{class:"required"}," *",-1)])),_:1,__:[22]}),l(t(pe),{modelValue:C.value,"onUpdate:modelValue":[e[8]||(e[8]=o=>C.value=o),oa],options:s.value,label:"name","track-by":"district_id",placeholder:"Select district",searchable:!0,"close-on-select":!0,class:E({"error-state":S.value})},null,8,["modelValue","options","class"]),S.value?(p(),w(t(V),{key:0,class:"error-label"},{default:i(()=>e[23]||(e[23]=[h(" District is required ")])),_:1,__:[23]})):g("",!0)]),_:1})]),l(t(re),{class:"form-row"},{default:i(()=>[l(t(D),{class:"form-column"},{default:i(()=>[l(t(V),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:i(()=>e[24]||(e[24]=[h("T/A or Area"),_("span",{class:"required"}," *",-1)])),_:1,__:[24]}),l(t(pe),{modelValue:O.value,"onUpdate:modelValue":[e[9]||(e[9]=o=>O.value=o),ua],options:n.value,label:"name","track-by":"traditional_authority_id",placeholder:"Select traditional authority",searchable:!0,"close-on-select":!0,disabled:!C.value,class:E({"error-state":A.value})},null,8,["modelValue","options","disabled","class"]),A.value?(p(),w(t(V),{key:0,class:"error-label"},{default:i(()=>e[25]||(e[25]=[h(" Traditional Authority/Area is required ")])),_:1,__:[25]})):g("",!0)]),_:1}),l(t(D),{class:"form-column"},{default:i(()=>[l(t(V),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:i(()=>e[26]||(e[26]=[h("Village or Township"),_("span",{class:"required"}," *",-1)])),_:1,__:[26]}),l(t(pe),{modelValue:z.value,"onUpdate:modelValue":[e[10]||(e[10]=o=>z.value=o),da],options:f.value,label:"name","track-by":"village_id",placeholder:"Select village",searchable:!0,"close-on-select":!0,disabled:!O.value,class:E({"error-state":x.value}),error:x.value},null,8,["modelValue","options","disabled","class","error"]),x.value?(p(),w(t(V),{key:0,class:"error-label"},{default:i(()=>e[27]||(e[27]=[h(" Village/Township is required ")])),_:1,__:[27]})):g("",!0)]),_:1})]),_:1}),l(t(re),{class:"form-row"},{default:i(()=>[l(t(D),{class:"form-column"},{default:i(()=>[l(Fa,{inputHeader:"Phone number",inputValue:v.value.phone,"onUpdate:inputValue":na,inputType:"tel",required:!0,class:E({"error-state":oe.value}),error:oe.value},null,8,["inputValue","class","error"]),oe.value?(p(),w(t(V),{key:0,class:"error-label"},{default:i(()=>e[28]||(e[28]=[h(" Phone must be 9 digits starting with 88, 99, 98, or 89 ")])),_:1,__:[28]})):g("",!0)]),_:1}),l(t(D),{class:"form-column"},{default:i(()=>[l(t(V),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:i(()=>e[29]||(e[29]=[h("Relationship"),_("span",{class:"required"}," *",-1)])),_:1,__:[29]}),l(t(pe),{modelValue:fe.value,"onUpdate:modelValue":[e[11]||(e[11]=o=>fe.value=o),va],multiple:!1,taggable:!1,"hide-selected":!0,"close-on-select":!0,openDirection:"bottom",placeholder:"Select relationship",selectLabel:"",label:"label",searchable:!0,"track-by":"value",options:ie.value,disabled:!1,class:E({"error-state":W.value}),error:W.value},null,8,["modelValue","options","class","error"]),W.value?(p(),w(t(V),{key:0,class:"error-label"},{default:i(()=>e[30]||(e[30]=[h(" Relationship is required ")])),_:1,__:[30]})):g("",!0)]),_:1})]),_:1})]),_:1})])):g("",!0),T.value?(p(),w(t(ce),{key:1,expand:"block",onClick:ca,class:"save-button"},{default:i(()=>[l(t(ge),{icon:t(Ia),slot:"start"},null,8,["icon"]),e[31]||(e[31]=h(" Save "))]),_:1,__:[31]})):g("",!0)])]),_:1})]),_:1},8,["is-open"])}}}),ht=We(bt,[["__scopeId","data-v-ce6b14cf"]]),gt={class:"form-row"},yt={class:"form-group segment-group"},Nt={class:"segment-label-container"},wt={class:"arv-input-container"},Pt=["disabled"],St=Le({__name:"Reception",setup(B,{expose:R}){const P=new ye,k=new ja(P.getID(),-1,""),m=d({}),j=d(!1),H=Oa(),G=Ye(),{patient:J}=Re(G),Q=d({}),T=new Ea(J.value.patientID,-1),r=d({isInit:!1,isLoading:!1,canSubmit:!1,hasGuardian:!1,captureArvNumber:"",sitePrefix:"",guardianPresent:"",patientPresent:"",hasArvNumber:!1,arvNumber:""}),u={guardianPresent:{label:"Guardian present",required:()=>!0,buildObs:()=>k.buildValueCoded("Guardian present",r.value.guardianPresent),validation:()=>{F("guardianPresent")&&r.value.guardianPresent==="Yes"&&!r.value.hasGuardian&&(m.value.guardianPresent="Please register a new guardian",j.value=!0)},onGuardianSelected:()=>{r.value.hasGuardian=!0,m.value.guardianPresent=""},onFormUpdate:(s,n)=>{s==="patientPresent"&&n==="No"&&r.value.guardianPresent==="No"&&(r.value.guardianPresent="Yes",m.value.guardianPresent=""),s==="guardianPresent"&&n==="Yes"&&!r.value.hasGuardian&&(j.value=!0)}},patientPresent:{label:"Patient present",required:()=>!0,buildObs:()=>k.buildValueCoded("Patient present",r.value.patientPresent),onFormUpdate:(s,n)=>{s==="guardianPresent"&&n==="No"&&r.value.patientPresent==="No"&&(r.value.patientPresent="Yes",m.value.patientPresent="")},validation:()=>F("patientPresent")},hasGuardian:{init:async()=>P.getGuardian().then(s=>{r.value.hasGuardian=s.length>0})},hasArvNumber:{init:async()=>{var n,f,S;r.value.hasArvNumber=!1;const s=await ye.findByID(J.value.patientID);if(r.value.hasArvNumber=(n=s.patient_identifiers)==null?void 0:n.some(A=>A.type.name==="ARV Number"&&/\w+-ARV-\d+/i.test("".concat(A.identifier))),!r.value.hasArvNumber){const A=await ze.getNextSuggestedARVNumber();r.value.arvNumber=(S=(f="".concat(A.arv_number).split(/\s/))==null?void 0:f[1])!=null?S:A.arv_number.replace(/^\D+|\s/g,""),await H.loadSitePrefix(),r.value.sitePrefix=H.globalPropertyStore.sitePrefix||"_ERROR_"}}},captureArvNumber:{label:"Capture ART number?",init:async()=>{await T.loadPatientType()},required:()=>!r.value.hasArvNumber&&T.getType()==="New patient",validation:()=>F("captureArvNumber")},arvNumber:{label:"ART Number",required:()=>r.value.captureArvNumber==="Yes",formatArvNumber:()=>{const s=r.value.arvNumber.replace(/^.*-/,"");return"".concat(r.value.sitePrefix,"-ARV-").concat(s)},onFormUpdate:(s,n)=>{s==="captureArvNumber"&&n==="No"&&(m.value.arvNumber="")},onSubmit:async()=>{if(m.value.arvNumber="",!u.arvNumber.required())return!0;try{return await k.createArvNumber(u.arvNumber.formatArvNumber())?(r.value.hasArvNumber=!0,!0):(m.value.arvNumber="Unable to save ARV number",!1)}catch(s){return m.value.arvNumber="Error saving arv Number",!1}},validation:()=>{if(F("arvNumber")){if(!/^\d+$/.test(r.value.arvNumber)){m.value.arvNumber="Only numbers are allowed";return}if(parseInt(r.value.arvNumber)<=0){m.value.arvNumber="Number must be positive";return}const s=u.arvNumber.required();r.value.isLoading=!0,r.value.canSubmit=!1,La.arvNumberExists(u.arvNumber.formatArvNumber()).then(n=>{if(n&&s){m.value.arvNumber="ARV number already exists";return}m.value.arvNumber=""}).catch(()=>{if(m.value.arvNumber="",s){m.value.arvNumber="Error verifying ARV number";return}}).finally(()=>{r.value.canSubmit=!0,r.value.isLoading=!1})}}}};async function le(){r.value.isLoading=!0,r.value.canSubmit=!1,await Promise.all(Object.keys(u).filter(s=>typeof u[s].init=="function").map(s=>u[s].init())),r.value.isLoading=!1,r.value.isInit=!0,r.value.canSubmit=!0}function se(s){m.value[s]="",typeof u[s].validation=="function"&&u[s].validation()}function $(){return Object.keys(u).reduce((s,n)=>{if(n in u&&typeof u[n].required=="function"&&u[n].required()&&typeof u[n].buildObs=="function"){const f=u[n].buildObs();return Array.isArray(f)?[...s,...f]:[...s,f]}return s},[])}function F(s){return m.value[s]="",(typeof u[s].required=="function"?u[s].required():!1)?r.value[s]?!0:(m.value[s]="".concat(u[s].label," is required"),!1):"".concat(r.value[s]).length>0}function v(){const s=Object.keys(u).filter(n=>!Q.value[n]&&typeof u[n].onSubmit=="function").map(n=>u[n].onSubmit&&u[n].onSubmit().then(()=>{Q.value[n]=!0}));return Promise.all(s)}function C(s,n){se(s),Object.keys(u).forEach(f=>{var S;return((S=u[f])==null?void 0:S.onFormUpdate)&&u[f].onFormUpdate(s,n)})}function O(){return Object.keys(u).forEach(s=>se(s)),Object.keys(m.value).some(s=>"".concat(m.value[s]).length>=1)}async function z(){if(!r.value.isInit||!r.value.canSubmit)return Y("Please wait for all data to load before submitting"),!1;if(O())return Y("Please review form for errors"),!1;if(await v(),O())return Y("Please review form for errors"),!1;try{return await k.createEncounter(),await k.saveObservationList(await Promise.all($())),!0}catch(s){return console.error(s),Ua("unable to save reception data"),!1}}return Ee(()=>le()),R({onSubmit:z}),(s,n)=>(p(),w(t(Ta),null,{default:i(()=>[r.value.isLoading?(p(),w(t(Ca),{key:0,type:"indeterminate"})):g("",!0),l(t(qa),null,{default:i(()=>[l(t(je),null,{default:i(()=>[l(t(re),null,{default:i(()=>[l(t(D),{size:"12"},{default:i(()=>[l(ke,{required:"",label:"Patient present?",modelValue:r.value.patientPresent,"onUpdate:modelValue":n[0]||(n[0]=f=>r.value.patientPresent=f),onOnChange:n[1]||(n[1]=f=>C("patientPresent",f)),"error-message":m.value.patientPresent,disabled:!r.value.isInit},null,8,["modelValue","error-message","disabled"])]),_:1}),l(t(D),{size:"12"},{default:i(()=>[l(ke,{required:"",label:"Guardian present?",modelValue:r.value.guardianPresent,"onUpdate:modelValue":n[2]||(n[2]=f=>r.value.guardianPresent=f),onOnChange:n[3]||(n[3]=f=>C("guardianPresent",f)),"error-message":m.value.guardianPresent,disabled:!r.value.isInit},null,8,["modelValue","error-message","disabled"])]),_:1})]),_:1}),u.captureArvNumber.required()?(p(),w(t(re),{key:0},{default:i(()=>[l(t(D),null,{default:i(()=>[l(ke,{required:"",label:"Capture ART number?",modelValue:r.value.captureArvNumber,"onUpdate:modelValue":n[4]||(n[4]=f=>r.value.captureArvNumber=f),onOnChange:n[5]||(n[5]=f=>C("captureArvNumber",f)),"error-message":m.value.captureArvNumber,disabled:!r.value.isInit},null,8,["modelValue","error-message","disabled"])]),_:1})]),_:1})):g("",!0),u.arvNumber.required()?(p(),w(t(re),{key:1},{default:i(()=>[l(t(D),null,{default:i(()=>{var f,S,A;return[_("div",gt,[_("div",yt,[_("div",Nt,[n[9]||(n[9]=_("label",{class:"label-title"},[h("ART Number "),_("span",{class:"required"},"*")],-1)),m.value.arvNumber?(p(),w(t(Da),{key:0,class:"error-label"},{default:i(()=>[h(L(m.value.arvNumber),1)]),_:1})):g("",!0)]),_("div",wt,[_("div",{class:E(["input-group",{"input-group-error":(f=m.value.arvNumber)!=null?f:!1}])},[xa(_("input",{disabled:!r.value.isInit,type:"text",class:E(["form-control",{"has-error":(S=m.value.arvNumber)!=null?S:!1}]),"onUpdate:modelValue":n[6]||(n[6]=x=>r.value.arvNumber=x),onInput:n[7]||(n[7]=x=>C("arvNumber",x.target.value)),required:""},null,42,Pt),[[Ga,r.value.arvNumber]]),_("span",{class:E(["input-group-text",{"has-error":(A=m.value.arvNumber)!=null?A:!1}])},L(r.value.sitePrefix)+"-ARV ",3)],2)])])])]}),_:1})]),_:1})):g("",!0)]),_:1})]),_:1}),l(ht,{isOpen:j.value,patientID:t(J).patientID,onClose:n[8]||(n[8]=f=>j.value=!1),onGuardianSelected:u.guardianPresent.onGuardianSelected,onWhenSaved:u.guardianPresent.onGuardianSelected},null,8,["isOpen","patientID","onGuardianSelected","onWhenSaved"])]),_:1}))}}),Tt=We(St,[["__scopeId","data-v-2595ed33"]]);export{Tt as default};
