!function(){function e(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var a=i.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}System.register(["./vendor-legacy-PwJwfeg2.js","./index-legacy-CAqY44sk.js","./consultation_service-legacy-DnDVEfAm.js","./lodash-legacy-C-x9g9Na.js","./app_encounter_service-legacy-LJRPnsbp.js","./Arrays-legacy-BAgeKGRl.js","./patient_type_service-legacy-Blmk_EwO.js"],(function(t,i){"use strict";var a,n,s,r,o,c,d,l,g,u,m,p,h,v,f,b,y,w,P,x,S,I,C,k,D,_,O,E,T,R,V,N,M,F,A,H,$,q,z,B,j,L,U,G,J,W,Y,Q,K,X,Z,ee,te,ie,ae,ne;return{setters:[e=>{a=e.d,n=e.d5,s=e.aE,r=e.aF,o=e.M,c=e.J,d=e.W,l=e.bq,g=e.d6,u=e.cs,m=e.cr,p=e.D,h=e.G,v=e.I,f=e.dz,b=e.K,y=e.e4,w=e.e5,P=e.E,x=e.e,S=e.f,I=e.k,C=e.i,k=e.l,D=e.v,_=e.z,O=e.F,E=e.L,T=e.A,R=e.B,V=e.y,N=e.m,M=e.p,F=e.d1},e=>{A=e.S,H=e.H,$=e.am,q=e.a5,z=e.cp,B=e.W,j=e.cq,L=e.cr,U=e.J,G=e.u,J=e.cs,W=e.a3,Y=e.m,Q=e.ct,K=e.cu,X=e.cv,Z=e._},e=>{ee=e.C},e=>{te=e.l},e=>{ie=e.A},e=>{ae=e.u},e=>{ne=e.P}],execute:function(){var i=document.createElement("style");i.textContent=".prescription-container[data-v-b0b7ac4d]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;max-width:800px;margin:0 auto;padding:1rem;border-radius:4px;background-color:#fff}.header[data-v-b0b7ac4d]{display:flex;align-items:center;padding-bottom:1rem;border-bottom:1px solid #e0e0e0;margin-bottom:1.5rem;position:relative}h2[data-v-b0b7ac4d]{margin:0;flex-grow:1;font-size:1.3rem;font-weight:600}.accordion-section[data-v-b0b7ac4d]{margin-bottom:1rem;border:1px solid #e0e0e0;border-radius:4px;overflow:hidden}.accordion-header[data-v-b0b7ac4d]{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;background-color:#f5f5f5;cursor:pointer;user-select:none}.accordion-header h3[data-v-b0b7ac4d]{margin:0;font-size:1rem;font-weight:500}.expand-btn[data-v-b0b7ac4d]{background:none;border:none;cursor:pointer;font-size:1rem}.accordion-content[data-v-b0b7ac4d]{padding:1rem;border-top:1px solid #e0e0e0}.horizontal-options[data-v-b0b7ac4d]{display:flex;flex-direction:row;gap:1rem}.horizontal-item[data-v-b0b7ac4d]{--inner-padding-end: 0px;--padding-start: 0px;flex-shrink:0}.allergy-section[data-v-b0b7ac4d]{display:flex;align-items:center}.allergy-label[data-v-b0b7ac4d]{font-weight:500;margin-right:2rem;min-width:180px}.option-grid[data-v-b0b7ac4d]{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}.checkbox-option[data-v-b0b7ac4d]{display:flex;align-items:center;cursor:pointer}.checkbox-text[data-v-b0b7ac4d]{margin-left:.5rem}.patient-info[data-v-b0b7ac4d]{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;font-size:.9rem}.info-item[data-v-b0b7ac4d]{display:flex;align-items:center}.info-label[data-v-b0b7ac4d]{font-weight:500;margin-right:.3rem}.regimen-grid[data-v-b0b7ac4d]{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem;margin-bottom:1rem}.regimen-item[data-v-b0b7ac4d]{display:flex;align-items:center;padding:.5rem 1rem;background-color:#e6f7f9;border-radius:4px;cursor:pointer;transition:background-color .2s}.regimen-item.selected[data-v-b0b7ac4d]{background-color:#81d4fa;border:1px solid #4fc3f7}.regimen-id[data-v-b0b7ac4d]{font-weight:500;margin-right:1rem;min-width:30px}.custom-regimen[data-v-b0b7ac4d]{display:flex;align-items:center;justify-content:space-between;margin-top:1rem;padding-top:1rem;border-top:1px solid #e0e0e0}.selected-medication-section[data-v-b0b7ac4d]{margin-top:1.5rem}.medication-table[data-v-b0b7ac4d]{width:100%;border-collapse:collapse}.table-header[data-v-b0b7ac4d]{display:flex;font-weight:500;border-bottom:1px solid #e0e0e0;padding-bottom:.5rem}.table-row[data-v-b0b7ac4d]{display:flex;padding:.5rem 0;border-bottom:1px solid #f0f0f0}.highlighted[data-v-b0b7ac4d]{background-color:#fffde7}.header-cell[data-v-b0b7ac4d],.row-cell[data-v-b0b7ac4d]{padding:.5rem}.drug-name[data-v-b0b7ac4d]{flex:2}.units[data-v-b0b7ac4d],.am[data-v-b0b7ac4d],.noon[data-v-b0b7ac4d],.pm[data-v-b0b7ac4d],.frequency[data-v-b0b7ac4d],.action[data-v-b0b7ac4d]{flex:1;text-align:center}.remove-btn[data-v-b0b7ac4d]{background-color:#f44336;color:#fff;border:none;border-radius:4px;padding:.25rem .5rem;cursor:pointer;font-size:.8rem}.remove-btn[data-v-b0b7ac4d]:hover{background-color:#d32f2f}.next-visit-interval[data-v-b0b7ac4d]{margin-bottom:1rem}.pack-quantity[data-v-b0b7ac4d]{background-color:#e8f5e9;color:#2e7d32;font-weight:500;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:4px}@media (max-width: 768px){.allergic-row[data-v-b0b7ac4d]{flex-direction:column;align-items:flex-start}.radio-group[data-v-b0b7ac4d]{margin-top:10px}}.required[data-v-b0b7ac4d]{color:red}.medication-run-out[data-v-b0b7ac4d]{margin-bottom:1rem}.estimated-packs[data-v-b0b7ac4d]{margin-top:1rem}h4[data-v-b0b7ac4d]{font-size:.9rem;font-weight:500;margin-bottom:.5rem}.pack-item[data-v-b0b7ac4d]{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}.pack-quantity[data-v-b0b7ac4d]{width:30px;height:30px;display:flex;align-items:center;justify-content:center;background-color:#e8f5e9;border-radius:4px}.save-section[data-v-b0b7ac4d]{display:flex;justify-content:flex-start;margin-top:1.5rem}.save-btn[data-v-b0b7ac4d]{padding:.5rem 1.5rem;background-color:#1b5e20;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:500}.save-btn[data-v-b0b7ac4d]:hover{background-color:#2e7d32}\n/*$vite$:1*/",document.head.appendChild(i);class se extends A{constructor(){super()}static getAllArvRegimens(){return this.getJson(`programs/${this.getProgramID()}/all_arv_regimens`)}static getRegimens(e){return this.getJson(`programs/${this.getProgramID()}/regimens`,{patient_id:e})}static getCustomIngridients(){return this.getJson(`programs/${this.getProgramID()}/custom_regimen_ingredients`)}static getCurrentRegimen(e,t=this.getSessionDate()){return this.getJson(`programs/${this.getProgramID()}/${e}`,{date:t})}static getRegimenExtras(e,t){return this.getJson(`programs/${this.getProgramID()}/regimen_extras`,{name:e,weight:t})}}class re extends ie{constructor(t,i){super(t,25,i),e(this,"nextVisitInterval",void 0),e(this,"fastTrack",void 0),e(this,"regimenExtras",void 0),e(this,"hangingPills",void 0),e(this,"fastTrackMedications",void 0),e(this,"medicationOrders",void 0),e(this,"treatmentState",void 0),e(this,"contraindications",void 0),e(this,"sideEffects",void 0),e(this,"tptPrescriptionCount",void 0),e(this,"lastSideEffectDate",void 0),this.nextVisitInterval=0,this.fastTrack=!1,this.regimenExtras=[],this.fastTrackMedications=[],this.hangingPills=[],this.medicationOrders=[],this.treatmentState="",this.contraindications={},this.sideEffects={},this.tptPrescriptionCount=0,this.lastSideEffectDate=""}setNextVisitInterval(e){this.nextVisitInterval=e}getHangingPills(){return this.hangingPills}getMedicationOrders(){return this.medicationOrders.map((e=>ie.getCachedConceptName(e)))}getTptPrescriptionCount(){return this.tptPrescriptionCount}getLastSideEffectDate(){return this.lastSideEffectDate}getContraindications(){return this.contraindications}getSideEffects(){return this.sideEffects}getRegimenExtras(){return this.regimenExtras}getPatientRegimens(){return se.getRegimens(this.patientID)}getARVs(){return se.getJson("arv_drugs")}getCustomIngridients(){return se.getCustomIngridients()}getFastTrackMedications(){return this.fastTrackMedications}getTreatmentState(){return this.treatmentState}isFastTrack(){return this.fastTrack}medicationOrdersAvailable(){return!te.isEmpty(this.medicationOrders)}shouldPrescribeExtras(){return ie.getConceptsByCategory("art_extra_medication_order").map((e=>this.medicationOrders.includes(e.concept_id))).some(Boolean)}getRegimenStarterpack(e,t){const i={weight:t,regimen:e};return ie.getJson(`programs/${ie.getProgramID()}/regimen_starter_packs`,i)}async getLvpDrugsByType(e,t){return ie.getJson(`programs/${ie.getProgramID()}/regimens/${t}`,{patient_id:this.patientID,lpv_drug_type:e})}async loadContraindications(){const e=await ie.getConceptID("Contraindications");(await ie.getObs({concept_id:e,person_id:this.patientID})).forEach((e=>{const t=H.toStandardHisFormat(e.obs_datetime);this.contraindications[t]||(this.contraindications[t]=[]);const i=ie.getCachedConceptName(e.value_coded);this.contraindications[t].push(i)}))}async loadDrugInduced(){const e=await ie.getConceptID("Drug induced"),t=await ie.getObs({concept_id:e,person_id:this.patientID});t&&t.forEach((e=>{const t=H.toStandardHisFormat(e.obs_datetime);if(this.lastSideEffectDate||(this.lastSideEffectDate=t),!e.value_drug||!e.value_coded)return;this.sideEffects[t]||(this.sideEffects[t]={}),this.sideEffects[t][e.value_drug]||(this.sideEffects[t][e.value_drug]=[]);const i=ie.getCachedConceptName(e.value_coded);this.sideEffects[t][e.value_drug].push(i)}))}async loadTptPrescriptionCount(){const e=await ie.getJson("tpt_prescription_count",{patient_id:this.patientID,date:this.date});if(e){const t=e.count+1;this.tptPrescriptionCount=t>3?3:t}}async loadFastTrackStatus(){const e=await ie.getFirstValueCoded(this.patientID,"Fast track"),t=await ie.getConceptID("yes");e&&(this.fastTrack=e===t)}async loadRegimenExtras(e=this.date){const t=await se.getJson(`programs/${se.getProgramID()}/patients/${this.patientID}/dosages`,{date:e});t&&(this.regimenExtras=Object.values(t))}async loadMedicationOrders(){const e=await ie.getConceptID("Medication orders"),t=await ie.getObs({concept_id:e,date:this.date,person_id:this.patientID,page_size:5});this.medicationOrders=t.map((e=>e.value_coded))}async loadHangingPills(){const e=await ie.getAll(this.patientID,"Pills brought")||[];this.hangingPills=e.filter((e=>e.value_numeric>=1&&(!(!e.value_drug||$(e.obs_datetime)!==$(this.date))||(e.order||!1)))).map((e=>{var t;return(null==e||null===(t=e.order)||void 0===t||null===(t=t.drug_order)||void 0===t?void 0:t.drug_inventory_id)||e.value_drug}))}async loadFastTrackMedications(){const e=(await q.getLastDrugsReceived(this.patientID)).map((async e=>{const{drug:t}=e,i=await q.getDrugDosages(this.patientID,t.drug_id);return{drug_id:t.drug_id,drug_name:t.name,units:t.units,am:i.am,noon:i.noon,pm:i.pm,frequency:e.frequency}}));this.fastTrackMedications=await Promise.all(e)}async loadTreatmentState(){const e={date:this.date},t=await ie.getJson(`programs/${ie.getProgramID()}/patients/${this.patientID}/status`,e);t&&(this.treatmentState=t.status)}findAndGroupDrugSideEffects(e){const t={};for(const i in this.sideEffects){const a=this.sideEffects[i];for(const n in a)e.includes(parseInt(n))&&(t[i]||(t[i]=[]),t[i]=[...t[i],...a[n]])}return t}calculatePillsPerDay(e,t,i){return parseFloat(e.toString())+t+i}estimatePackSize(e,t=0){const i=e*this.nextVisitInterval/(t||1);let a=Math.round(i);return a<=0&&(a+=1),a}calculateDosage(e,t){let i=0;return 0===t&&(i=e),0==e&&(i=t),e>0&&t>0&&(i=(e+t)/2),i}calculateEquivalentDosage(e,t){return e+t}calculateDateFromInterval(){const e=new Date(this.date);return e.setDate(e.getDate()+this.nextVisitInterval),H.toStandardHisFormat(e)}getDrugPackSize(e){if(e.pack_size)return e.pack_size;try{return e.barcodes[0].tabs}catch(t){return 30}}getInstructions(e,t,i,a){return`${e} :- Morning: ${t} ${a}, Evening: ${i} ${a}`}toOrderObj(e,t,i,a=0,n=0,s=""){return{drug_inventory_id:e,equivalent_daily_dose:this.calculateEquivalentDosage(a,n),start_date:this.date,auto_expire_date:this.calculateDateFromInterval(),units:i,instructions:this.getInstructions(t,a,n,i),dose:this.calculateDosage(a,n),frequency:s}}async getReasonForRegimenSwitch(){const e=await ie.getFirstValueText(this.patientID,"Reason for ARV switch");return e||"N/A"}async createDrugOrder(e){return q.create({encounter_id:this.encounterID,drug_orders:e})}async createHangingPillsObs(e){return this.saveValueTextObs("appointment type",e)}async createRegimenSwitchObs(e){return this.saveValueTextObs("Reason for ARV switch",e)}}var oe=(e=>(e.ARV_REGIMENS="arv_regimens",e.INTERVAL_SELECTION="next_visit_interval",e))(oe||{}),ce=(e=>(e.EXIT="exit",e.CONTINUE="continue",e))(ce||{}),de=(e=>(e.ON_VALUE="onValue",e.ON_BUILD="onBuild",e.BEFORE_NEXT="beforeNext",e))(de||{});const le={"Do not prescribe LPV regimens together with 3HP":{priority:1,actions:{alert:async({regimenName:e})=>(await z("3HP - LPV/r conflict",e,"Regimens containing LPV/r <b>cannot</b> be prescribed together with 3HP",[{name:"Close",slot:"end",color:"danger"}],"his-danger-color"),"exit")},target:"arv_regimens",targetEvent:"onValue",conditions:{regimenCode:e=>[7,8,9,10,11,12].includes(e),medicationOrders:e=>e.filter((e=>!!`${e}`.match(/3hp/i))).length>=1}},"Check for any adverse effects or contraindications associated with the regimen":{priority:1,actions:{alert:async({regimenCodeStr:e,sideEffectsTable:t})=>{const{columns:i,rows:a}=t;return"Select other regimen"===await L(`Contraindications / Side effects for ${e}`,"",i,a,[{name:"Select other regimen",slot:"start"},{name:"Keep selected regimen",slot:"end",color:"danger"}],"his-danger-color")?"exit":"continue"}},target:"arv_regimens",targetEvent:"beforeNext",conditions:{hasSideEffects:e=>e,lastSideEffectDate:(e,{currentDate:t})=>e>=t}},"Recommend 2nd line regimen to children under 3":{priority:1,actions:{alert:async()=>"Select another regimen"===await j("Recommendation","",["Children under 3 years often have a high viral load and may be infected with drug-resistant HIV from previous exposure to ARVs (mother's ART and/or infant nevirapine prophylaxis)","Therefore, children under <b>3 years</b> respond better when <b>started immediately on 2nd line regimen</b> (Regimen <b>11</b>)"],[{name:"Select another regimen",slot:"start"},{name:"Keep selected regimen",slot:"end",color:"danger"}],"his-warning-color")?"exit":"continue"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{age:e=>e<3,regimenCode:e=>11!=e}},"Provide a reason for switching regimens when patient already has one":{priority:1,actions:{alert:async e=>{const t=await B(`Are you sure you want to replace ${e.currentRegimenStr}?`,"Specify reason for switching regimen",["Policy change","Ease of administration (pill burden, swallowing)","Drug drug interaction","Pregnancy intention","Side effects","Treatment failure","Weight Change","Other"],[{name:"Cancel",slot:"start",color:"danger"},{name:"Continue",slot:"end",role:"action"}]);return t.selection&&"Cancel"!=t.action?(e.reasonForSwitch=t.selection,"continue"):"exit"}},target:"arv_regimens",targetEvent:"onValue",conditions:{regimenCode:(e,{currentRegimenCode:t})=>-1!=t&&e!=t}},"Provide 14 day starter pack for LPV regimens for children under 3 years old":{priority:3,actions:{alert:async e=>"Prescribe starter pack"===await z("Starter pack needed for 14 days",`${e.treatmentInitiationState}`,`${e.regimenName}`,[{name:"Cancel",slot:"start",color:"danger"},{name:"Prescribe starter pack",slot:"end"}],"his-info-color")?(e.starterPackNeeded=!0,"continue"):"exit"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{age:e=>e<3,regimenCode:e=>11===e,treatmentInitiationState:e=>["Initiation","Re-initiation"].includes(e)}},"Provide 14 day starter pack for NVP based regimens on newly initiated/re-initiation patients":{priority:3,actions:{alert:async e=>"Prescribe starter pack"===await z("Starter pack needed for 14 days",`${e.treatmentInitiationState}`,`${e.regimenName}`,[{name:"Cancel",slot:"start",color:"danger"},{name:"Prescribe starter pack",slot:"end"}],"his-info-color")?(e.starterPackNeeded=!0,"continue"):"exit"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{regimenCode:e=>[0,2,6].includes(e),treatmentInitiationState:e=>["Initiation","Re-initiation"].includes(e)}},"Ask to reuse hanging pills if any":{priority:5,actions:{alert:async e=>{const t=await z("Hanging pills recommendation","Add hanging pills?","",[{name:"No",slot:"start",color:"warning"},{name:"Yes",slot:"end"}],"his-info-color");return e.hangingPillsStatus="Yes"===t?"Optimize - including hanging pills":"Exact - excluding hanging pills","continue"}},target:"next_visit_interval",targetEvent:"beforeNext",conditions:{drugs:(e,{hangingPills:t})=>e.map((e=>t.includes(e))).some(Boolean)}},"Provide warning of use of DTG regimen to women of reproductive age":{priority:2,actions:{alert:async({regimenName:e})=>"Select another regimen"===await z("Use of DTG or EFV in women of reproductive age",e,["There is currently <u>no confirmation</u>","that <b>DTG</b> is safe in <u>very early pregnancy</u>","DTG-based regimens are therefore not used as standard 1st line regimens for","<u>girls and women</u> who may get pregnancy"].join(" "),[{name:"Select another regimen",slot:"start"},{name:"Continue with regimen",slot:"end",color:"danger"}],"his-danger-color")?"exit":"continue"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{regimenCode:e=>e>=12,isChildBearing:e=>e}},"Provide pallet options for LPV regimens for patient's whose weight is between 3 and 25 kgs":{priority:6,actions:{alert:async e=>{const t=await z("Pellets (cups) / Tabs","","Prescribe LPV/r in <b>Pellets (cups)</b> or <b>Tablets</b>?",[{name:"Granules",slot:"start"},{name:"Pellets",slot:"end"},{name:"Tabs",slot:"end"}],"his-info-color");return e.lpvType=t.toLowerCase(),"continue"}},target:"arv_regimens",targetEvent:"beforeNext",conditions:{weight:e=>e>=3&&e<=25,regimenCode:e=>11===e||9===e}},"Provide 14 day interval for NVP or LVP Regimen starter pack":{priority:1,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{prescriptionType:e=>"Regimen"===e,selectedInterval:e=>e>14,starterPackNeeded:e=>e,regimenCode:e=>[0,2,6,11].includes(e)}},"Restrict Emergency supply prescription to 1 month":{priority:1,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{selectedInterval:e=>e>28,patientType:e=>"Emergency supply"===e}},"Provide intervals upto 1 month, 2nd up to 2 months, and 3rd up to 6 months for Patients receiving TPT":{priority:2,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{prescriptionType:e=>"Regimen"===e,medicationOrders:e=>e.map((e=>!!`${e}`.match(/3hp/i))).some(Boolean),tptPrescriptionCount:(e,{selectedInterval:t})=>Math.round(t/30)>e}}},ge={"Rifapentine or isoniazid should be taken weekly":{concept:"Weekly (QW)",priority:1,conditions:{drug:e=>`${e}`.match(/Rifapentine|Isoniazid/i)}},"Use daily frequency for any other drugs":{concept:"Daily (QOD)",priority:2,conditions:{drug:e=>!`${e}`.match(/Rifapentine|Isoniazid/i)}}};function ue(e,t){const i=[],a=[-1,"",null,void 0];for(const n in t){if(!(n in e))continue;const s=e[n];a.includes(s)?i.push(!1):i.push(t[n](s,e))}return i.every(Boolean)}function me(e,t,i="",a="",n="priority"){const s=[];for(const r in t){const n=t[r];[n.target&&i&&n.target!=i,n.targetEvent&&a&&n.targetEvent!=a].some(Boolean)||ue(e,n.conditions)&&(n.title=r,n.description&&(n.description.text=n.description.info(e)),s.push(n))}return"priority"===n?s.sort(((e,t)=>e.priority&&t.priority&&e.priority<t.priority?-1:1)):function(e){return e.sort(((e,t)=>e.weight&&t.weight&&e.weight>t.weight?-1:1))}(s)}const pe=a({name:"Prescription",data:()=>({toDisplayFmt:K,toDisplayGenderFmt:X,accordionState:{allergySection:!0,medicationSection:!1,arvRegimensSection:!1,nextVisitSection:!1},consultation:w({}),prescription:w({}),chevronUp:y,chevronDown:b,reasonsForOver6Months:"",route:"",providerID:1,patientID:-1,facts:{age:-1,gender:"",weight:50,currentDate:"",isChildBearing:!1,isPregnant:!1,isBreastfeeding:!1,prescriptionType:"",patientType:"",tbStatus:"",tptStatus:{},tptPrescriptionCount:0,currentRegimenCode:-1,currentRegimenStr:"",drug:"",drugs:[],contraindications:{},hasSideEffects:!1,sideEffectsTable:{},lastSideEffectDate:"",regimenCode:-1,regimenCodeStr:"",regimenName:"",regimenDrugs:[],hangingPills:[],reasonForSwitch:"",starterPackNeeded:!1,hangingPillsStatus:"",treatmentInitiationState:"",lpvType:"",medicationOrders:[],selectedInterval:0,isEligibleForTpt:!1},arvRegimens:[],medicationOptions:[],selectedRegimen:{},customRegimen:!1,allergyOption:"",Intervaloptions:[{label:"2 weeks",value:14},{label:"1 month",value:28},{label:"2 months",value:56},{label:"3 months",value:84},{label:"4 months",value:112},{label:"5 months",value:140},{label:"6 months",value:168},{label:"7 months",value:196},{label:"8 months",value:224},{label:"9 months",value:252},{label:"10 months",value:280},{label:"11 months",value:308},{label:"12 months",value:336}],allergyOptions:[{label:"Yes",value:"Yes"},{label:"No",value:"No"},{label:"Unknown",value:"Unknown"}],nextVisitInterval:1,selectedMedications:[],medicationRunOutDate:re.getSessionDate(),estimatedPacks:[]}),components:{IonIcon:v,IonItem:h,IonLabel:p,IonSelect:m,IonSelectOption:u,IonTextarea:g,IonCheckbox:l,IonButton:d,IonAccordion:c,IonAccordionGroup:o,IonRadio:r,IonRadioGroup:s,IonNote:n},computed:{noDispensation(){return this.medicationOptions.some((e=>"none"===e.value&&e.isChecked))},over6monthsMedication(){return this.nextVisitInterval>168}},methods:{isChildBearing(){return"F"===this.facts.gender&&this.facts.age>=12&&this.facts.age<=50},toggleAccordion(e){this.accordionState[e]=!this.accordionState[e]},async onEvent(e,t){const i=me(this.facts,le,e,t);for(const s in i){var a;const e=i[s];if(null!=e&&null!==(a=e.actions)&&void 0!==a&&a.alert){var n;if(await(null==e||null===(n=e.actions)||void 0===n?void 0:n.alert(this.facts))===ce.EXIT)return!1}}return!0},formatDrugs:e=>e.map((e=>e.alternative_drug_name)).join(" + "),getDrugFrequency(e){this.facts.drug=e;const t=me(this.facts,ge);if(!te.isEmpty(t))return t[0].concept},extractRegimenCode(e){try{return e.match(/n\/a/i)?-1:parseInt(e.substring(0,e.length))}catch(t){return console.warn(t),-1}},buildSideEffectsTable(e){const t=[];for(const i in e){const a=this.facts.contraindications[i]||[];t.push([K(i),a.join(", "),e[i].join(", ")])}return{columns:["Date","Contraindication(s)","Side effect(s)"],rows:t}},async toggleRegimen(e){if(this.selectedRegimen.name!==e.name){this.facts.lpvType="",this.facts.hangingPillsStatus="",this.facts.starterPackNeeded=!1,this.facts.regimenName=`${e.name} (${this.formatDrugs(e.drugs)})`,this.facts.regimenCodeStr=e.name,this.facts.regimenCode=this.extractRegimenCode(e.name),this.facts.regimenDrugs=e.drugs,this.facts.drugs=e.drugs.map((e=>e.drug_id));const t=this.prescription.findAndGroupDrugSideEffects(this.facts.drugs);if(this.facts.hasSideEffects=!te.isEmpty(t),this.facts.sideEffectsTable=this.buildSideEffectsTable(t),!this.onEvent(oe.ARV_REGIMENS,de.ON_VALUE))return;this.selectedRegimen=e,this.selectedMedications=e.drugs,this.updateEstimatedPacks()}else this.selectedRegimen={},this.selectedMedications=[]},disableOption:(e,t=!0)=>({disabled:t,description:{color:"danger",show:"always",text:e}}),validateTPTOption(e){return this.facts.tptStatus.completed?this.disableOption("Completed TPT treatment"):this.facts.tptStatus.tb_treatment?this.disableOption("Completed/on TB treatment"):this.facts.isPregnant?this.disableOption("Pregnant patient"):this.facts.tptStatus.eligible["3HP"]||this.facts.tptStatus.eligible["6H"]?null!==this.facts.tptStatus.tpt&&this.facts.tptStatus.tpt!==e?this.disableOption(`On ${this.facts.tptStatus.tpt} treatment`):(this.facts.isEligibleForTpt=e.includes("3HP")?this.facts.tptStatus.eligible["3HP"]:this.facts.tptStatus.eligible["6H"],this.facts.isBreastfeeding?this.disableOption("Breastfeeding patient",!1):this.facts.isEligibleForTpt&&this.facts.tptStatus.tpt===e&&!this.facts.tptStatus.completed?{isChecked:!0}:{}):this.disableOption("Not eligible to start or re-start TPT")},buildTPTOption(e,t,i=0){const a={label:e,value:t,isChecked:!1,disabled:!1};if(i>0&&this.facts.weight<i)return{...a,...this.disableOption("Weight below regulation")};const n=this.validateTPTOption(e);return{...a,...n}},buildMedicationOptions(){this.medicationOptions=[{label:"ARVs",value:"arvs",isChecked:!1},{label:"CPT",value:"cpt",isChecked:!1,..."Yes"===this.allergyOption?this.disableOption("Allergic to sulphur"):{}},this.buildTPTOption("3HP (RFP + INH)","3hp",20),this.buildTPTOption("INH 300 / RFP 300 (3HP)","inh300",30),this.buildTPTOption("IPT","ipt",30),{label:"None",value:"none",isChecked:!1}]},async allergyChange(e){this.allergyOption=e.detail.value},nextVisitIntervalChange(e){const t=new Date;this.nextVisitInterval=e.detail.value,this.medicationRunOutDate=Q(t,this.nextVisitInterval,"days"),this.updateEstimatedPacks()},async onSubmit(){try{const e=[await this.createbuildValueCoded("Allergic to sulphur",this.allergyOption.toString())];this.noDispensation?e.push(await this.consultation.buildValueCoded("Prescribe drugs","No")):(e.push(await this.consultation.buildValueCoded("Prescribe drugs","Yes")),this.medicationOptions.forEach((async t=>{t.isChecked&&e.push(await this.consultation.buildValueCoded("Medication orders",t.label))}))),await this.consultation.saveObservationList(e),await this.prescription.createEncounter(),this.prescription.setNextVisitInterval(this.nextVisitInterval);const t=this.selectedMedications.map((e=>this.prescription.toOrderObj(e.drug_id,e.alternative_drug_name||e.drug_name,e.units,e.am,e.pm,e.frequency||this.getDrugFrequency(e.drug_name))));if(await this.prescription.createDrugOrder(t),this.over6monthsMedication){const e=await this.consultation.buildValueCoded("Why prescribe medication for more than 6 months?",this.reasonsForOver6Months);await this.prescription.saveObservationList([e])}return!0}catch(e){return console.error("Error saving prescription:",e),Y("Failed to save prescription"),!1}},async createbuildValueCoded(e,t){return await this.consultation.buildValueCoded(e,t)},async handleMedicationSelection(e,t,i){const a=e.detail.checked;if("none"===i.value)return a&&(this.medicationOptions=this.medicationOptions.map(((e,i)=>({...e,isChecked:i===t})))),void(await this.updateSelectedMedications());"arvs"===i.value&&(a?(this.accordionState.arvRegimensSection=!0,this.accordionState.nextVisitSection=!0):(this.accordionState.arvRegimensSection=!1,this.accordionState.nextVisitSection=!1));const n=e=>!!e.label.match(/IPT|3HP|INH/i),s=this.medicationOptions.filter(n);if(n(i)){const e=e=>"3HP (RFP + INH)"===e.label||"INH 300 / RFP 300 (3HP)"===e.label,t=s.some((e=>"IPT"===e.label&&e.isChecked));if(e(i)&&t&&a){const t=await this.showTPTConflictDialog();return"Prescribe IPT"===t?this.medicationOptions=this.medicationOptions.map((t=>({...t,isChecked:!e(t)&&t.isChecked}))):"Prescribe 3HP"===t&&(this.medicationOptions=this.medicationOptions.map((t=>({...t,isChecked:"IPT"!==t.label&&(e(t)?t.label===i.label:t.isChecked)})))),void(await this.updateSelectedMedications())}if(e(i)&&a&&(this.medicationOptions=this.medicationOptions.map((t=>({...t,isChecked:e(t)?t.label===i.label:t.isChecked})))),"IPT"===i.label&&a){if(s.some((t=>e(t)&&t.isChecked))){const t=await this.showTPTConflictDialog();return"Prescribe IPT"===t?this.medicationOptions=this.medicationOptions.map((t=>({...t,isChecked:!e(t)&&t.isChecked}))):"Prescribe 3HP"===t&&(this.medicationOptions=this.medicationOptions.map((e=>({...e,isChecked:"IPT"!==e.label&&e.isChecked})))),void(await this.updateSelectedMedications())}}}a&&"none"!==i.value&&(this.medicationOptions=this.medicationOptions.map((e=>({...e,isChecked:"none"!==e.value&&e.isChecked})))),this.medicationOptions[t].isChecked=a,await this.updateSelectedMedications()},async updateSelectedMedications(){this.selectedMedications=[];const e=async(e,t,i)=>{if(this.medicationOptions.find((t=>t.value===e&&t.isChecked))){const e=await se.getRegimenExtras(t,this.facts.weight),a=ae(i?e.filter(i):e,"concept_name");this.selectedMedications.push(...a)}};this.medicationOptions.find((e=>"arvs"===e.value&&e.isChecked))&&this.selectedRegimen.drugs&&this.selectedMedications.push(...this.selectedRegimen.drugs),await e("cpt","Cotrimoxazole",(e=>"Daily (QOD)"===e.frequency)),await e("3hp","INH / RFP"),await e("inh300","INH / RFP"),await e("ipt","INH",(e=>"Daily (QOD)"===e.frequency)),this.updateEstimatedPacks()},updateEstimatedPacks(){this.prescription.setNextVisitInterval(this.nextVisitInterval),this.estimatedPacks=this.selectedMedications.map((e=>{const t=this.prescription.getDrugPackSize(e),i=this.prescription.calculatePillsPerDay(e.am,e.noon,e.pm),a=this.prescription.estimatePackSize(i,t);return{name:e.drug_name,quantity:a}}))},async initFacts(){const e=await W.getProgramInformation(this.patientID);this.facts.hangingPills=this.prescription.getHangingPills(),this.facts.treatmentInitiationState=this.prescription.getTreatmentState(),this.facts.currentRegimenStr=e.current_regimen,this.facts.currentRegimenCode=this.extractRegimenCode(e.current_regimen),this.facts.medicationOrders=this.prescription.getMedicationOrders(),this.facts.contraindications=this.prescription.getContraindications(),this.facts.tptPrescriptionCount=this.prescription.getTptPrescriptionCount(),this.facts.lastSideEffectDate=this.prescription.getLastSideEffectDate(),this.facts.currentDate=re.getSessionDate(),this.facts.isChildBearing=this.isChildBearing(),this.facts.tptStatus=await this.consultation.getTptTreatmentStatus();const t=new ne(this.patientID,this.providerID);await t.loadPatientType(),this.facts.patientType=t.patientType},showTPTConflictDialog:async()=>await z("TPT Conflict","You cannot prescribe IPT and 3HP together","Please choose one option",[{name:"Prescribe 3HP",slot:"start",color:"primary"},{name:"Prescribe IPT",slot:"end",color:"primary"}])},watch:{nextVisitInterval:{handler(){this.updateEstimatedPacks()}},allergyOption:{handler(){this.buildMedicationOptions()}},medicationOptions:{handler(){this.updateSelectedMedications()},deep:!0}},async mounted(){var e,t;const i=U();this.providerID=Number(f(i.$state).user_ID)||1;const a=G(),n=f(a.$state).patient;this.patientID=(null==n?void 0:n.patientID)||25,this.facts.gender=(null==n?void 0:n.personInformation.gender)||"",this.facts.age=J(null==n?void 0:n.personInformation.birthdate);if(null==n||null===(e=n.vitals)||void 0===e||null===(e=e.saved)||void 0===e?void 0:e[0]){const e=n.vitals.saved.find((e=>"Weight (kg)"===e.concept_name));e&&(this.facts.weight=e.value_numeric)}const s=null==n||null===(t=n.activePrograms)||void 0===t?void 0:t.find((e=>"HIV PROGRAM"===e.program.name));s&&(this.facts.currentRegimenStr=s.program.name,this.facts.currentRegimenCode=this.extractRegimenCode(s.program.name)),this.consultation=new ee(this.patientID,this.providerID),this.prescription=new re(this.patientID,this.providerID);const r=await se.getRegimens(this.patientID);Object.entries(r).forEach((([e,t])=>{this.arvRegimens.push({name:e,drugs:t})})),await this.prescription.loadHangingPills(),await this.prescription.loadRegimenExtras(),await this.initFacts(),this.buildMedicationOptions()}}),he={class:"prescription-container"},ve={class:"accordion-section"},fe={class:"expand-btn"},be={class:"accordion-content"},ye={class:"allergy-section"},we={class:"accordion-section"},Pe={class:"expand-btn"},xe={class:"accordion-content"},Se={class:"medication-options"},Ie={class:"option-grid"},Ce={class:"checkbox-text"},ke={class:"accordion-section"},De={class:"expand-btn"},_e={class:"accordion-content"},Oe={class:"patient-info"},Ee={class:"info-item"},Te={class:"info-value"},Re={class:"info-item"},Ve={class:"info-value"},Ne={class:"info-item"},Me={class:"info-value"},Fe={class:"info-item"},Ae={class:"info-value"},He={class:"info-item"},$e={class:"info-value"},qe={class:"regimen-grid"},ze=["onClick"],Be={class:"regimen-id"},je={class:"regimen-name"},Le=["onClick"],Ue={class:"regimen-id"},Ge={class:"regimen-name"},Je={class:"custom-regimen"},We={class:"selected-medication-section"},Ye={class:"medication-table"},Qe={class:"row-cell drug-name"},Ke={class:"row-cell units"},Xe={class:"row-cell am"},Ze={class:"row-cell noon"},et={class:"row-cell pm"},tt={class:"row-cell frequency"},it={class:"accordion-section"},at={class:"expand-btn"},nt={class:"accordion-content"},st={class:"next-visit-interval"},rt={class:"medication-run-out"},ot={class:"estimated-packs"},ct={class:"pack-name"},dt={class:"pack-quantity"},lt={key:0,class:"over-6-months-medication"};t("default",Z(pe,[["render",function(e,t,i,a,n,s){const r=P("ion-icon"),o=P("ion-radio"),c=P("ion-radio-group"),d=P("ion-checkbox"),l=P("ion-note"),g=P("ion-select-option"),u=P("ion-select"),m=P("ion-item"),p=P("ion-label"),h=P("ion-textarea");return S(),x("div",he,[I("div",ve,[I("div",{class:"accordion-header",onClick:t[0]||(t[0]=t=>e.toggleAccordion("allergySection"))},[t[8]||(t[8]=I("h3",null,"Allergy Information",-1)),I("button",fe,[k(r,{icon:e.accordionState.allergySection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),C(I("div",be,[I("div",ye,[t[9]||(t[9]=I("div",{class:"allergy-label"},"Allergic to cotrimoxazole",-1)),k(c,{modelValue:e.allergyOption,"onUpdate:modelValue":t[1]||(t[1]=t=>e.allergyOption=t),onIonChange:e.allergyChange,class:"horizontal-options"},{default:_((()=>[(S(!0),x(O,null,E(e.allergyOptions,(e=>(S(),x("div",{key:e.value,class:"horizontal-item"},[k(o,{value:e.value},{default:_((()=>[T(R(e.label),1)])),_:2},1032,["value"])])))),128))])),_:1},8,["modelValue","onIonChange"])])],512),[[D,e.accordionState.allergySection]])]),I("div",we,[I("div",{class:"accordion-header",onClick:t[2]||(t[2]=t=>e.toggleAccordion("medicationSection"))},[t[10]||(t[10]=I("h3",null,"Medication to prescribe during this visit",-1)),I("button",Pe,[k(r,{icon:e.accordionState.medicationSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),C(I("div",xe,[I("div",Se,[I("div",Ie,[(S(!0),x(O,null,E(e.medicationOptions,((i,a)=>{var n,s;return S(),x("div",{key:i.value,class:"option-item"},[k(d,{checked:i.isChecked,disabled:i.disabled,"label-placement":"end",onIonChange:t=>e.handleMedicationSelection(t,a,i)},{default:_((()=>[I("span",Ce,R(i.label),1)])),_:2},1032,["checked","disabled","onIonChange"]),t[11]||(t[11]=I("br",null,null,-1)),"always"===(null===(n=i.description)||void 0===n?void 0:n.show)?(S(),V(l,{key:0,color:null===(s=i.description)||void 0===s?void 0:s.color},{default:_((()=>{var e;return[T(R(null===(e=i.description)||void 0===e?void 0:e.text),1)]})),_:2},1032,["color"])):N("",!0)])})),128))])])],512),[[D,e.accordionState.medicationSection]])]),I("div",ke,[I("div",{class:"accordion-header",onClick:t[3]||(t[3]=t=>e.toggleAccordion("arvRegimensSection"))},[t[12]||(t[12]=I("h3",null,"ARV Regimens",-1)),I("button",De,[k(r,{icon:e.accordionState.arvRegimensSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),C(I("div",_e,[I("div",Oe,[I("div",Ee,[t[13]||(t[13]=I("span",{class:"info-label"},"Age:",-1)),I("span",Te,R(e.facts.age)+" Years",1)]),I("div",Re,[t[14]||(t[14]=I("span",{class:"info-label"},"Gender:",-1)),I("span",Ve,R(e.toDisplayGenderFmt(e.facts.gender)),1)]),I("div",Ne,[t[15]||(t[15]=I("span",{class:"info-label"},"Current Regimen:",-1)),I("span",Me,R(e.facts.currentRegimenStr),1)]),I("div",Fe,[t[16]||(t[16]=I("span",{class:"info-label"},"Current Weight:",-1)),I("span",Ae,R(e.facts.weight),1)]),I("div",He,[t[17]||(t[17]=I("span",{class:"info-label"},"Reason for change:",-1)),I("span",$e,R(e.facts.reasonForSwitch),1)])]),I("div",qe,[(S(!0),x(O,null,E(e.arvRegimens.slice(0,5),(t=>(S(),x("div",{key:t.name,class:M(["regimen-item",{selected:e.selectedRegimen.name===t.name}]),onClick:i=>e.toggleRegimen(t)},[I("span",Be,R(t.name),1),I("span",je,R(e.formatDrugs(t.drugs)),1)],10,ze)))),128)),(S(!0),x(O,null,E(e.arvRegimens.slice(5),(t=>(S(),x("div",{key:t.name,class:M(["regimen-item",{selected:e.selectedRegimen.name===t.name}]),onClick:i=>e.toggleRegimen(t)},[I("span",Ue,R(t.name),1),I("span",Ge,R(e.formatDrugs(t.drugs)),1)],10,Le)))),128))]),I("div",Je,[t[18]||(t[18]=I("span",null,"Set custom regimen",-1)),k(d,{modelValue:e.customRegimen,"onUpdate:modelValue":t[4]||(t[4]=t=>e.customRegimen=t)},null,8,["modelValue"])]),I("div",We,[t[20]||(t[20]=I("h3",null,"Selected medication",-1)),I("div",Ye,[t[19]||(t[19]=F('<div class="table-header" data-v-b0b7ac4d><div class="header-cell drug-name" data-v-b0b7ac4d>Drug name</div><div class="header-cell units" data-v-b0b7ac4d>Units</div><div class="header-cell am" data-v-b0b7ac4d>AM</div><div class="header-cell noon" data-v-b0b7ac4d>Noon</div><div class="header-cell pm" data-v-b0b7ac4d>PM</div><div class="header-cell frequency" data-v-b0b7ac4d>Frequency</div><div class="header-cell action" data-v-b0b7ac4d>Action</div></div>',1)),(S(!0),x(O,null,E(e.selectedMedications,((e,t)=>(S(),x("div",{key:t,class:M(["table-row",{highlighted:0===t}])},[I("div",Qe,R(e.drug_name),1),I("div",Ke,R(e.units),1),I("div",Xe,R(e.am),1),I("div",Ze,R(e.noon),1),I("div",et,R(e.pm),1),I("div",tt,R(e.frequency),1)],2)))),128))])])],512),[[D,e.accordionState.arvRegimensSection]])]),I("div",it,[I("div",{class:"accordion-header",onClick:t[5]||(t[5]=t=>e.toggleAccordion("nextVisitSection"))},[t[21]||(t[21]=I("h3",null,"Next Visit Information",-1)),I("button",at,[k(r,{icon:e.accordionState.nextVisitSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),C(I("div",nt,[I("div",st,[k(m,null,{default:_((()=>[k(u,{modelValue:e.nextVisitInterval,"onUpdate:modelValue":t[6]||(t[6]=t=>e.nextVisitInterval=t),interface:"popover",onIonChange:e.nextVisitIntervalChange,placeholder:"Select interval",label:"Interval to next visit","label-placement":"stacked"},{default:_((()=>[(S(!0),x(O,null,E(e.Intervaloptions,(e=>(S(),V(g,{key:e.value,value:e.value},{default:_((()=>[T(R(e.label),1)])),_:2},1032,["value"])))),128))])),_:1},8,["modelValue","onIonChange"])])),_:1})]),I("div",rt,[t[22]||(t[22]=I("label",null,"Medication run out date:",-1)),I("span",null,R(e.toDisplayFmt(e.medicationRunOutDate)),1)]),I("div",ot,[t[23]||(t[23]=I("h4",null,"Estimated packs/tins:",-1)),(S(!0),x(O,null,E(e.estimatedPacks,((e,t)=>(S(),x("div",{key:t,class:"pack-item"},[I("span",ct,R(e.name),1),I("div",dt,R(e.quantity),1)])))),128))]),e.over6monthsMedication?(S(),x("div",lt,[k(m,null,{default:_((()=>[k(p,{position:"stacked"},{default:_((()=>t[24]||(t[24]=[T("Specify reason for prescribing medication over 6 months "),I("span",{class:"required"},"*",-1)]))),_:1,__:[24]}),k(h,{modelValue:e.reasonsForOver6Months,"onUpdate:modelValue":t[7]||(t[7]=t=>e.reasonsForOver6Months=t),placeholder:"Enter reason for over 6 months medication"},null,8,["modelValue"])])),_:1})])):N("",!0)],512),[[D,e.accordionState.nextVisitSection]])])])}],["__scopeId","data-v-b0b7ac4d"]]))}}}))}();
