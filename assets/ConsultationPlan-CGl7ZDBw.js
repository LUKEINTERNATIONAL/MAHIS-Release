import{d as ke,ak as Ae,cq as xe,r,c as Re,aX as d,w as l,a as Pe,N as K,f as X,J as B,l as u,u as y,a8 as Te,k as f,m as Ie,i as h,bF as Ne,v as D,ae as Be,bc as C}from"./vendor-CCEOjICu.js";import{aD as Y,u as Ve,aE as $e,aF as Fe,a9 as Me,c as ze,aG as He,f as Le,Y as Ee,d as We,T as je,J as Ge,M as Je,H as V,aH as A,aI as Ue,aJ as qe,N as Q,t as Ke,o as Xe,aK as x,aL as Ye,$ as Qe,S as Ze}from"./index-Dy9ZuUHl.js";import{D as Oe}from"./DemographicBar-ChxxZxhU.js";import{u as $,D as et,C as tt,T as at}from"./TreatmentPlan-CDFYJ8d0.js";import{u as st,I as nt,N as ot,M as it,s as rt,c as lt,a as ct}from"./NextAppointment-BYOdSeFG.js";import{_ as ut}from"./RiskAssessment.vue_vue_type_script_setup_true_lang-C5yEEn5N.js";import{_ as mt}from"./Vitals.vue_vue_type_script_setup_true_lang-pzU_mLyv.js";import{u as ft,_ as vt}from"./useFormWizard-R2ezN-_N.js";import{l as gt}from"./lodash-Dt8AsbQm.js";import{a as Z,b as dt}from"./formatServerData-CRX-K7V6.js";import{C as pt}from"./Registration-B4IEG_Sc.js";import{u as St}from"./usePatientProfile-CI2CY3yu.js";import"./apexcharts-CkGWSImU.js";import"./DashBox-CP_Qs3j6.js";import"./BasicForm-CDD4jxeF.js";import"./DateInputField-MVh0oScR.js";import"./previousDiagnosis-CsE42JLn.js";import"./group_validation-DKBbOlnt.js";import"./drug_service-DSjUtwdw.js";import"./lab_order-CsHwFVAS.js";import"./drug_prescription_service-D_FBQATf.js";import"./ncd_appointment_service-DzpmAHBH.js";import"./useLocation-B7SQaFrr.js";import"./useExposeFromStandardForm-BA8_gIji.js";import"./vaccines_service-BqcJdMD5.js";import"./sms_service-Dgp5F8cS.js";import"./EIRreportsStore-B0dCjr3W.js";import"./Export-DAPboYOx.js";import"./Outcome-CYV8dC4d.js";const ht={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Dt={class:"back_profile"},Qt=ke({__name:"ConsultationPlan",setup(bt,{expose:O}){const{onTabBeforeChange:ee,onChangeCurrentTab:te,currentTabIndex:v}=ft("Consultation Plan"),{printVisitSummary:ae}=St(),R=Ae(),se=xe();r([]),r([]),r(!1);const P=r(!0),T=r(!1),S=r(!1),F=Re(()=>({text:S.value?"Saving...":"Finish",icon:S.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:T.value||S.value})),ne=Y(),oe=Ve(),ie=$e(),re=Fe();Me();const le=st(),_=ze();He();const ce=Le(),ue=$(),me=Ee(),{patient:o}=d(oe),{vitals:fe}=d(ne),{investigations:ve}=d(ie),{diagnosis:ge}=d(re),{substance:de}=d(ce),{selectedNCDMedicationList:M}=d(le),{FootScreening:pe,visualScreening:Se,cvScreening:he}=d(ue),{sessionDate:z}=d(me),{apiStatus:Ct}=d(We());l(F,(e,t)=>{console.log("Done button options changed:",{from:t,to:e,currentStep:v.value,tabsLength:n.value.length}),e.disabled!==(t==null?void 0:t.disabled)&&console.log("Done button ".concat(e.disabled?"disabled":"enabled")),e.text!==(t==null?void 0:t.text)&&console.log('Done button text changed from "'.concat(t==null?void 0:t.text,'" to "').concat(e.text,'"'))},{deep:!0}),l(S,(e,t)=>{e!==t&&(console.log("Saving state changed: ".concat(t," -> ").concat(e)),console.log(e?"Starting save process...":"Save process completed"))});const De=e=>{console.log("Done button change received from wizard:",e),e.newOptions.disabled&&console.log("Done button has been disabled"),e.isLastStep&&console.log("User is on the last step, done button should be visible")},w=()=>{let e=!1;return p(),S.value&&(e=!0),T.value=e,!e},be=()=>{R.push("patientProfile")},I=()=>_.NCDActivities.map(e=>({title:e,icon:""})),n=r(I()),H=r(null),L=r(null),E=r(null),W=r(null),j=r(null),G=r(null),J=r(null),p=()=>{var a;if(!n.value||n.value.length===0)return console.log("Tabs not yet initialized"),null;const e=v.value>=0&&v.value<n.value.length?v.value:0;switch((a=n.value[e])==null?void 0:a.title){case"Vital Signs":return"Vitals";case"Risk Assessment":return"RiskAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"DiagnosisComponent";case"Complications Screening":return"ComplicationsScreening";case"Treatment Plan":return"TreatmentPlan";case"Next Appointment":return"NextAppointment";default:if(_.NCDActivities.length>0)switch(_.NCDActivities[0]){case"Vital Signs":return"Vitals";case"Risk Assessment":return"RiskAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"DiagnosisComponent";case"Complications Screening":return"ComplicationsScreening";case"Treatment Plan":return"TreatmentPlan";case"Next Appointment":return"NextAppointment"}return null}},N=()=>{P.value=!1,setTimeout(()=>{v.value=0,P.value=!0},0)},U=()=>{const e=Y();e.setVitals(e.getInitialVitals(o.value.ID))},g=async()=>{var a,m;const e=Je(z.value,"sessionDate","value")||V.sessionDate(),t=A("vitals");for(let s=0;s<n.value.length;s++){const c=n.value[s];if(c.title==="Vital Signs")n.value[s].icon=k(e,t)?C:"";else if(c.title==="Risk Assessment"){const i=A("substanceAbuse");n.value[s].icon=k(e,i)?C:""}else if(c.title==="Investigations"){const i=(m=(a=o==null?void 0:o.value)==null?void 0:a.labOrders)==null?void 0:m.saved,b=i==null?void 0:i.filter(we=>V.toStandardHisFormat(e)===V.toStandardHisFormat(we.order_date));n.value[s].icon=(b==null?void 0:b.length)>0?C:""}else if(c.title==="Diagnosis"){const i=A("diagnosis");n.value[s].icon=k(e,i)?C:""}else if(c.title==="Complications Screening"){const i=A("screening");n.value[s].icon=k(e,i)?C:""}else c.title==="Treatment Plan"&&(M.value.length>0?n.value[s].icon=it()?C:"":n.value[s].icon="")}w()},k=(e,t)=>{const a=new Date(e);return a.setHours(0,0,0,0),t.some(m=>{const s=new Date(m.obs_datetime);return s.setHours(0,0,0,0),s.getTime()===a.getTime()})},Ce=async()=>{var s,c,i,b;const e=[],t=await Z(Se.value),a=await dt(pe.value),m=await Z(he.value);t.length>0&&e.push({concept_id:await x.getConceptID("Visual acuity",!0),value_text:"visual acuity test",obs_datetime:x.getSessionDate(),child:t}),a.length>0&&e.push({concept_id:await x.getConceptID("Foot check",!0),value_text:"foot screening",obs_datetime:x.getSessionDate(),child:a}),m.length>0&&e.push(...m),e.length>0&&((b=(i=(c=(s=o.value).screening)!=null?c:s.screening={}).unsaved)!=null||(i.unsaved=[]),o.value.screening.unsaved.push(...e),Q("Complications saved successfully"))},ye=async()=>{const e=Ye();if(!gt.isEmpty(e.selectedMedicalAllergiesList)){const m=Qe(),s=e.selectedMedicalAllergiesList.map(i=>({concept_id:985,obs_datetime:Ze.getSessionDate(),location_id:m.facilityLocation.code,value_text:i.name})),c=await rt(s);o.value=Object.assign(o.value,c),console.log("Allergies staged successfully:",o.value),e.clearSelectedMedicalAllergiesList()}const t=await lt();o.value=Object.assign(o.value,t);const a=await ct().saveNonPharmaTherapyPatientData();o.value=Object.assign(o.value,a)},q=async()=>{S.value=!0;try{const e=[{ref:H,name:"Vitals"},{ref:L,name:"Risk Assessment"},{ref:E,name:"Investigations"},{ref:W,name:"Diagnosis"},{ref:j,name:"Complications Screening"},{ref:G,name:"Treatment Plan"},{ref:J,name:"Next Appointment"}];for(const t of e)if(t.ref.value&&typeof t.ref.value.onSubmit=="function")try{await t.ref.value.onSubmit()}catch(a){throw console.error("Error calling ".concat(t.name," onSubmit:"),a),a}else console.log("".concat(t.name," component ref not available or no onSubmit method"));await ye(),await Ce(),await Ue(),await qe(o.value),await _e(),Q("Data saved successfully!"),R.push("patientProfile")}catch(e){console.error("Error saving data:",e),Ke("Error occurred while saving data. Please try again.")}finally{S.value=!1}},_e=async()=>{await Xe(pt,{class:"small-confirm-modal "})!=="dismiss"&&await ae()};return Pe(async()=>{if(_.NCDActivities.length===0){R.push("patientProfile");return}$().resetScreening(),n.value=I(),await g(),(v.value===void 0||v.value<0)&&(v.value=0,console.log("Setting initial tab index to 0")),T.value=!1,w()}),l(v,async()=>{await w()}),l(fe,async()=>{await g()},{deep:!0}),l(o,async()=>{$().resetScreening(),await g()},{deep:!0}),l(z,async()=>{await g()},{deep:!0}),l(ve,async()=>{await g()},{deep:!0}),l(ge,async()=>{await g()},{deep:!0}),l(de,async()=>{await g()},{deep:!0}),l(M,async()=>{await g()},{deep:!0}),l(se,async e=>{N(),U(),n.value=I()},{deep:!0}),l(o,async(e,t)=>{e.ID!=t.ID&&(N(),U())},{deep:!0}),O({saveData:q,markWizard:g,refreshWizard:N,validateDoneButtonState:w}),(e,t)=>(X(),K(y(Be),null,{default:B(()=>[u(je),u(y(Te),{fullscreen:!0},{default:B(()=>[u(Oe),f("div",ht,[P.value?(X(),K(vt,{key:0,ref:"wizard","vertical-tabs":"","navigable-tabs":"","scrollable-tabs":"",startIndex:0,doneButton:F.value,"custom-tabs":n.value,beforeChange:y(ee),onChange:y(te),"onComplete:wizard":t[1]||(t[1]=a=>q()),onDoneButtonChanged:De},{default:B(()=>[f("div",null,[f("div",Dt,[u(Ge,{name:"Back to profile",iconSlot:"start",fill:"clear",icon:y(Ne),"font-weight":"600",onClick:t[0]||(t[0]=a=>be())},null,8,["icon"])])]),h(f("div",null,[u(mt,{ref_key:"vitalsRef",ref:H},null,512)],512),[[D,p()=="Vitals"]]),h(f("div",null,[u(ut,{ref_key:"riskAssessmentRef",ref:L},null,512)],512),[[D,p()=="RiskAssessment"]]),h(f("div",null,[u(nt,{ref_key:"investigationsRef",ref:E},null,512)],512),[[D,p()=="Investigations"]]),h(f("div",null,[u(et,{ref_key:"diagnosisRef",ref:W},null,512)],512),[[D,p()=="DiagnosisComponent"]]),h(f("div",null,[u(tt,{ref_key:"complicationsRef",ref:j},null,512)],512),[[D,p()=="ComplicationsScreening"]]),h(f("div",null,[u(at,{ref_key:"treatmentPlanRef",ref:G},null,512)],512),[[D,p()=="TreatmentPlan"]]),h(f("div",null,[u(ot,{ref_key:"nextAppointmentRef",ref:J},null,512)],512),[[D,p()=="NextAppointment"]])]),_:1},8,["doneButton","custom-tabs","beforeChange","onChange"])):Ie("",!0)])]),_:1})]),_:1}))}});export{Qt as default};
