!function(){function e(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["./vendor-legacy-CFX0KWSj.js","./app_encounter_service-legacy-CViqp1vU.js","./index-legacy-DhOsa4Y5.js","./lodash-legacy-pOOc9Efu.js"],function(t,n){"use strict";var r,a,i,u,s,o,l,d,c,g,y,p,m,f,_,h,v,b,D,k,q,w,S,O,P,z,I,A,E,M,C,V,j,x,H,U;return{setters:[e=>{r=e.d,a=e.r,i=e.a,u=e.y,s=e.f,o=e.z,l=e.l,d=e.u,c=e.aY,g=e.e,y=e.bm,p=e.F,m=e.L,f=e.aa,_=e.ab,h=e.D,v=e.A,b=e.G,D=e.B,k=e.a3,q=e.m,w=e.aX,S=e.W,O=e.I,P=e.c_,z=e.k,I=e.aI,A=e.a$},e=>{E=e.A},e=>{M=e.S,C=e.a4,V=e.P,j=e.af,x=e.t,H=e.l},e=>{U=e.l}],execute:function(){class n extends M{constructor(){super()}static async fetchAvailableDrugStock(e){const t=await this.getJson("pharmacy/items",{drug_id:e});if(!U.isEmpty(t))return t.map(e=>({quantity:e.current_quantity,packSize:e.pack_size}))}}const B={11:[30],21:[25],22:[60],24:[30,60,90,100],30:[90],39:[60],73:[120],74:[60],76:[1e3],297:[30,60,90],576:[30,60,90],613:[60],731:[60],732:[60],733:[60],734:[30],735:[30],736:[60],738:[60],931:[12,30,60],932:[30],954:[60],963:[30,60,90],968:[60],969:[30],971:[30,60,90],976:[60],977:[30],982:[30],983:[30,90],1039:[30,60,90],1043:[60],1044:[30],1056:[24],1216:[3,6,8,12]};class Y extends E{constructor(t,n){super(t,54,n),e(this,"drugHistory",void 0),e(this,"currentDrugOrder",void 0),e(this,"useDrugManagement",void 0),this.drugHistory=[],this.currentDrugOrder=[],this.useDrugManagement=!1}setIsDrugManagementEnabled(e){this.useDrugManagement=e}async loadDrugManagementEnabled(){this.useDrugManagement=!1}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}buildDispensations(e,t,n){const r=[];for(let a=0;a<n;a++)r.push({drug_order_id:e,date:this.date,quantity:t/n});return r}saveDispensations(e){return E.postJson("/dispensations",{dispensations:e,program_id:E.getProgramID()})}async voidOrder(e){return E.void(`/dispensations/${e}`,{})}async loadDrugHistory(){try{this.drugHistory=await C.getDrugOrderHistory(this.patientID)||[]}catch(e){console.warn(e)}}async loadCurrentDrugOrder(){if(this.currentDrugOrder=await C.getDrugOrders(this.patientID)||[],this.useDrugManagement)for(const e of this.currentDrugOrder){const t=await n.fetchAvailableDrugStock(e.drug.drug_id);e.stocks=this.groupByPackSize(t)}}groupByPackSize(e){const t=new Map;return null==e||e.forEach(({packSize:e,quantity:n})=>{var r,a;e&&(t.has(e)?t.set(e,{packSize:e,quantity:n+(null!==(r=null===(a=t.get(e))||void 0===a?void 0:a.quantity)&&void 0!==r?r:0)}):t.set(e,{quantity:n,packSize:e}))}),Array.from(t.values())}getDrugPackSizes(e){return e in B?B[e]:[30,60,90]}calcCompletePack(e,t){var n;const r=(null!==(n=e.barcodes)&&void 0!==n?n:[]).sort((e,t)=>e.tabs-t.tabs);if(0==r.length||0==t)return t;for(const a in r){const{tabs:e}=r[a];if(parseInt(e)>=t)return e}return parseInt(r[r.length-1].tabs)}}const $={key:0},F={key:1},J={style:{"margin-top":"10%"},class:"ion-text-center"};t("_",r({__name:"ArtDispensation",setup(e,{expose:t}){const n=a([]),r=new V,E=new Y(r.getID(),-1);function M(e){if(!e.quantity)return"";const t=parseInt(`${e.quantity}`)/e.amount_needed*100;return t>110?"You are dispensing over 110% of prescribed amount":t<100?"You are dispensing less than 100% of prescribed amount":void 0}return i(()=>{E.loadCurrentDrugOrder().then(()=>{n.value=E.getCurrentOrder().map(e=>{var t;return{name:e.drug.name,quantity:e.quantity||null,drug_id:e.drug.drug_id,order_id:e.order.order_id,amount_needed:(()=>{const t=parseFloat(e.amount_needed)-(e.quantity||0);return t<=0?0:E.calcCompletePack(e.order,t)})(),pack_sizes:E.getDrugPackSizes(e.drug.drug_id),disabled:(null!==(t=e.quantity)&&void 0!==t?t:0)>0}})})}),t({onSubmit:async function(){const e=n.value.filter(e=>e.quantity>=1&&!e.disabled).map(e=>E.buildDispensations(e.order_id,parseInt(e.quantity),1));return e.length<=0?(x("Please enter one or more drug quantities"),!1):!!(await Promise.all(e.map(e=>E.saveDispensations(e)))).every(Boolean)||(H("An error has occured"),!1)}}),(e,t)=>(s(),u(d(A),{style:{width:"90%",margin:"0px auto","min-height":"40vh"}},{default:o(()=>[l(d(c),null,{default:o(()=>[n.value.length?(s(),g("div",$,[l(d(y),null,{default:o(()=>[(s(!0),g(p,null,m(n.value,(e,n)=>(s(),u(d(f),{key:n},{default:o(()=>[l(d(_),null,{default:o(()=>[l(d(h),{style:{"font-weight":"bold"}},{default:o(()=>t[0]||(t[0]=[v(" Medication ")])),_:1,__:[0]}),l(d(b),{lines:"none"},{default:o(()=>[l(d(h),null,{default:o(()=>[v(D(e.name),1)]),_:2},1024)]),_:2},1024),l(d(y),null,{default:o(()=>[l(d(f),null,{default:o(()=>[l(d(_),null,{default:o(()=>[l(d(h),{style:{"font-weight":"bold"}},{default:o(()=>t[1]||(t[1]=[v("Amount needed")])),_:1,__:[1]}),l(d(k),{style:{background:"#E8E8E8","font-weight":"bold"},readonly:"",modelValue:e.amount_needed,"onUpdate:modelValue":t=>e.amount_needed=t,type:"number",fill:"outline"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),l(d(_),null,{default:o(()=>[l(d(h),{style:{"font-weight":"bold"}},{default:o(()=>t[2]||(t[2]=[v("Amount to dispense")])),_:1,__:[2]}),l(d(k),{placeholder:"Enter amount to dispense",disabled:e.disabled,modelValue:e.quantity,"onUpdate:modelValue":t=>e.quantity=t,type:"number",fill:"outline"},null,8,["disabled","modelValue","onUpdate:modelValue"]),!e.disabled&&M(e)?(s(),u(d(w),{key:0,style:{color:"red"}},{default:o(()=>[v(D(M(e)),1)]),_:2},1024)):q("",!0),e.disabled?(s(),u(d(S),{key:1,onClick:t=>async function(e){await j("Are you sure you want to reset this dispensation?")&&E.voidOrder(e.order_id).then(()=>{e.disabled=!1,e.quantity=null}).catch(()=>x("Unable to reset dispensation"))}(e),fill:"outline",class:"ion-margin-top"},{default:o(()=>[l(d(O),{icon:d(P)},null,8,["icon"]),t[3]||(t[3]=v(" Reset "))]),_:2,__:[3]},1032,["onClick"])):q("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):(s(),g("div",F,[z("div",J,[l(d(O),{style:{"font-size":"5rem!important"},icon:d(I)},null,8,["icon"]),t[4]||(t[4]=z("h1",null,"No Dispensations needed at the moment",-1))])]))]),_:1})]),_:1}))}}))}}})}();
