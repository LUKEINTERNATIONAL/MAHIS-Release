var Ae=Object.defineProperty;var Te=(C,N,p)=>N in C?Ae(C,N,{enumerable:!0,configurable:!0,writable:!0,value:p}):C[N]=p;var Ie=(C,N,p)=>(Te(C,typeof N!="symbol"?N+"":N,p),p);import{d as xe,aQ as Ce,r as i,c as le,w as me,E as Fe,e as v,y as F,z as l,l as s,x as a,U as qe,R as Ue,S as Oe,A as d,V as ne,aa as Me,j as n,G as Be,b7 as Ee,I as te,cx as Le,bb as He,ap as Ye,f as x,F as ke,J as Je,B as E,m as I,be as je,aL as Se,aM as se,D as y,bj as ze,p as Qe,bm as We,b0 as Ke,d1 as J,d2 as ce,i as Xe,bc as Ze}from"./vendor-65256339.js";import{A as ea,f as Ve,u as Ge,B as Pe,d as aa,a as fe,t as S,R as ve,b as _e,g as ta,_ as De,h as sa,S as Re}from"./index-dd8b4458.js";import{P as la}from"./patient_type_service-ac489e6d.js";import"./lodash-7be49fbd.js";import"./apexcharts-583f3fdc.js";import"./chartjs-bbe0813a.js";import"./barcode-qrcode-reader-d9469be9.js";class na extends ea{constructor(p,k,_){super(p,51,k,_);Ie(this,"sitePrefix");this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}createArvNumber(p){return Ve.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:p})}buildArvNumber(p){return"".concat(this.sitePrefix,"-ARV-").concat(p)}}const ra={class:"form-container"},oa={class:"search-section"},ia={key:0,class:"search-results"},ua={key:0,class:"search-loading"},da={key:1},ca=["onClick"],va={class:"pagination"},pa=["disabled"],ma={class:"page-info"},fa=["disabled"],_a={key:2,class:"no-results"},ha={key:0,class:"create-form-section"},pe=10,ga=xe({__name:"ManageGuardian",props:{isOpen:{type:Boolean,required:!0}},emits:["close","whenSaved","guardianSelected"],setup(C,{emit:N}){const p=Ge(),{patient:k}=Ce(p),_=N,c=i(""),P=i([]),q=i(!1),h=i(!1),g=i(1),V=i([]),L=i([]),H=i([]),u=i({firstName:"",lastName:"",phone:"",relationship:""}),U=i([]),G=i(null),D=i(!1),R=i(!1),$=i(!1),W=i(!1),j=le(()=>Math.ceil(V.value.length/pe)),re=le(()=>{const r=(g.value-1)*pe,t=r+pe;return V.value.slice(r,t)}),oe=le(()=>u.value.firstName.trim()!==""&&u.value.lastName.trim()!==""&&u.value.relationship),Y=()=>{Q(),_("close")},ie=()=>{clearTimeout(K),K=setTimeout(()=>{h.value=!1,z()},300)};let K;const z=async()=>{if(!c.value.trim()){V.value=[],g.value=1;return}q.value=!0;try{const r=await fe.getJson("people/".concat(k.value.patientID,"/relationships"));L.value=r.map(f=>{var M,B,ae,ge,be,ye,Ne,we;const w=((B=(M=f.relation)==null?void 0:M.names)==null?void 0:B[0])||{};return{id:(ge=(ae=f.relation)==null?void 0:ae.person_id)==null?void 0:ge.toString(),firstName:w.given_name||"Unknown",lastName:w.family_name||"",phone:((Ne=(ye=(be=f.relation)==null?void 0:be.person_attributes)==null?void 0:ye.find($e=>$e.value))==null?void 0:Ne.value)||"",relationship:((we=f.type)==null?void 0:we.b_is_to_a)||"Other",source:"existing"}});const t=c.value.split(" "),T={given_name:t[0],family_name:t.length>=2?t[1]:"",page:"1",per_page:"20",exclude_patient_id:k.value.patientID},m=await fe.search(T);H.value=m.map(f=>{var M,B;const w=f.person.names[0];return{id:f.person.person_id.toString(),firstName:w.given_name,lastName:w.family_name,phone:((B=(M=f.person.attributes)==null?void 0:M.find(ae=>ae.attribute_type==="Cell Phone Number"))==null?void 0:B.value)||"",relationship:"",source:"search"}}),V.value=[...L.value,...H.value.filter(f=>!L.value.some(w=>w.id===f.id))].sort((f,w)=>{const M="".concat(f.firstName," ").concat(f.lastName).toUpperCase(),B="".concat(w.firstName," ").concat(w.lastName).toUpperCase();return M.localeCompare(B)}),g.value=1}catch(r){S("Failed to search guardians")}finally{q.value=!1}},ue=async r=>{try{const t=U.value.find(T=>T.value===(r.relationship||"Guardian"));t?(await ve.createRelation(k.value.patientID,r.id,t.other.relationship_type_id),_("guardianSelected",r),Y(),_e("Guardian relationship created successfully")):S("Could not determine relationship type")}catch(t){console.error("Error creating relationship:",t),S("Failed to create guardian relationship")}},he=r=>{r?(G.value=r,u.value.relationship=r.value,D.value=!1):(G.value=null,u.value.relationship=""),A()},X=r=>{u.value.firstName=r.target.value,O()},Z=r=>{u.value.lastName=r.target.value,ee()},de=r=>{u.value.phone=r.target.value,o()},O=()=>{R.value=u.value.firstName.trim()===""},ee=()=>{$.value=u.value.lastName.trim()===""},o=()=>{W.value=u.value.phone.trim()===""},e=async()=>{try{if(O(),ee(),A(),!oe.value){S("Please fill all required fields");return}const r={given_name:u.value.firstName,family_name:u.value.lastName,gender:"",birthdate:"",birthdate_estimated:!0,attributes:{cell_phone_number:u.value.phone}},t=new ta;await t.registerGuardian(r);const T=t.getPersonID();if(!T){S("Failed to create guardian");return}const m=U.value.find(w=>w.value===u.value.relationship);m&&await ve.createRelation(k.value.patientID,T,m.other.relationship_type_id);const f={id:T.toString(),firstName:u.value.firstName,lastName:u.value.lastName,phone:u.value.phone,relationship:u.value.relationship};_("whenSaved",f),Y(),_e("Guardian created successfully")}catch(r){console.error("Error creating guardian:",r),S("Failed to create guardian")}},b=async()=>{try{const r=await ve.getRelations();U.value=r.map(t=>({label:t.b_is_to_a,value:t.b_is_to_a,other:t}))}catch(r){console.error("Failed to load relationships",r)}},A=()=>{D.value=!u.value.relationship},Q=()=>{u.value={firstName:"",lastName:"",phone:"",relationship:""},G.value=null,c.value="",P.value=[],h.value=!1,g.value=1,q.value=!1};return b(),me(h,r=>{r?P.value=[]:c.value&&z()}),(r,t)=>{const T=Fe("ion-buttons");return v(),F(a(Ke),{"is-open":C.isOpen,onDidDismiss:Y},{default:l(()=>[s(a(qe),null,{default:l(()=>[s(a(Ue),null,{default:l(()=>[s(a(Oe),{class:"modal-title"},{default:l(()=>t[5]||(t[5]=[d("Search/Add Guardian")])),_:1,__:[5]}),s(T,{slot:"end"},{default:l(()=>[s(a(ne),{onClick:Y,class:"close-button"},{default:l(()=>t[6]||(t[6]=[d("Close")])),_:1,__:[6]})]),_:1})]),_:1})]),_:1}),s(a(Me),{class:"ion-padding modal-content"},{default:l(()=>[n("div",ra,[n("div",oa,[s(a(Be),{class:"search-item",lines:"full"},{default:l(()=>[s(a(Ee),{modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=m=>c.value=m),placeholder:"Search guardian by name",onIonInput:ie,class:"search-input"},{default:l(()=>[s(a(te),{icon:a(Le),slot:"start"},null,8,["icon"])]),_:1},8,["modelValue"]),s(a(ne),{slot:"end",fill:"clear",onClick:t[1]||(t[1]=m=>h.value=!0),title:"Create new guardian"},{default:l(()=>[s(a(te),{icon:a(He)},null,8,["icon"]),s(a(te),{icon:a(Ye)},null,8,["icon"])]),_:1})]),_:1}),c.value&&!h.value?(v(),x("div",ia,[q.value?(v(),x("div",ua," Searching... ")):V.value.length>0?(v(),x("div",da,[(v(!0),x(ke,null,Je(re.value,m=>(v(),x("div",{key:m.id,class:"result-item",onClick:f=>ue(m)},E(m.firstName)+" "+E(m.lastName),9,ca))),128)),n("div",va,[n("button",{onClick:t[2]||(t[2]=m=>g.value=Math.max(1,g.value-1)),disabled:g.value===1,class:"pagination-button"}," < ",8,pa),n("span",ma,"page "+E(g.value)+" of "+E(j.value),1),n("button",{onClick:t[3]||(t[3]=m=>g.value=Math.min(j.value,g.value+1)),disabled:g.value===j.value,class:"pagination-button"}," > ",8,fa)])])):(v(),x("div",_a,[n("p",null,'No guardians found matching "'+E(c.value)+'"',1)]))])):I("",!0)]),h.value?(v(),x("div",ha,[s(a(je),{class:"form-grid"},{default:l(()=>[s(a(Se),{class:"form-row"},{default:l(()=>[s(a(se),{class:"form-column"},{default:l(()=>[s(Pe,{inputHeader:"First name*",inputValue:u.value.firstName,"onUpdate:inputValue":X,inputType:"text",error:R.value},null,8,["inputValue","error"]),R.value?(v(),F(a(y),{key:0,class:"error-label"},{default:l(()=>t[7]||(t[7]=[d(" First name is required ")])),_:1,__:[7]})):I("",!0)]),_:1}),s(a(se),{class:"form-column"},{default:l(()=>[s(Pe,{inputHeader:"Last name*",inputValue:u.value.lastName,"onUpdate:inputValue":Z,inputType:"text",required:!0,error:$.value},null,8,["inputValue","error"]),$.value?(v(),F(a(y),{key:0,class:"error-label"},{default:l(()=>t[8]||(t[8]=[d(" Last name is required ")])),_:1,__:[8]})):I("",!0)]),_:1})]),_:1}),s(a(Se),{class:"form-row"},{default:l(()=>[s(a(se),{class:"form-column"},{default:l(()=>[s(aa,{inputHeader:"Phone number",inputValue:u.value.phone,"onUpdate:inputValue":de,inputType:"tel",required:!0},null,8,["inputValue"])]),_:1}),s(a(se),{class:"form-column"},{default:l(()=>[s(a(y),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:l(()=>t[9]||(t[9]=[d("Relationship"),n("span",{class:"required"}," *",-1)])),_:1,__:[9]}),s(a(ze),{modelValue:G.value,"onUpdate:modelValue":[t[4]||(t[4]=m=>G.value=m),he],multiple:!1,taggable:!1,"hide-selected":!0,"close-on-select":!0,openDirection:"bottom",placeholder:"Select relationship",selectLabel:"",label:"label",searchable:!0,"track-by":"value",options:U.value,disabled:!1,class:Qe({"error-state":D.value}),error:D.value},null,8,["modelValue","options","class","error"]),D.value?(v(),F(a(y),{key:0,class:"error-label"},{default:l(()=>t[10]||(t[10]=[d(" Relationship is required ")])),_:1,__:[10]})):I("",!0)]),_:1})]),_:1})]),_:1})])):I("",!0),h.value?(v(),F(a(ne),{key:1,expand:"block",onClick:e,class:"save-button"},{default:l(()=>[s(a(te),{icon:a(We),slot:"start"},null,8,["icon"]),t[11]||(t[11]=d(" Save "))]),_:1,__:[11]})):I("",!0)])]),_:1})]),_:1},8,["is-open"])}}});const ba=De(ga,[["__scopeId","data-v-473b61c5"]]),ya={class:"reception-form"},Na={class:"form-section"},wa={class:"form-row"},Ia={class:"form-group segment-group"},Sa={class:"segment-label-container"},Pa={class:"form-row"},Ra={class:"form-group segment-group"},xa={class:"segment-label-container"},Ca={key:0,class:"form-row"},ka={class:"form-group segment-group"},Va={class:"segment-label-container"},Ga={key:1,class:"form-row"},Da={class:"form-group segment-group"},$a={class:"segment-label-container"},Aa={class:"arv-input-container"},Ta={class:"input-group"},Fa=["placeholder"],qa={class:"input-group-text"},Ua={class:"form-footer"},Oa=xe({__name:"Reception",setup(C){const N=Ge(),{patient:p}=Ce(N),k=sa(),_=i(""),c=i(""),P=i(""),q=i(!1),h=i(""),g=i(!0),V=i(""),L=i(""),H=i(""),u=i(null),U=i(!1),G=i(!1),D=i(!1),R=i(!1),$=i("");me(P,o=>{o==="no"&&(h.value="",R.value=!1)}),me([_,c],([o,e])=>{o==="no"&&e==="no"&&(c.value="yes")});const W=le(()=>!g.value&&H.value==="New patient"),j=o=>{o!==void 0&&(_.value=o,U.value=!1,_.value==="no"&&c.value==="no"&&(_.value="yes"))},re=async o=>{if(o!==void 0&&(c.value=o,G.value=!1,_.value==="no"&&c.value==="no"&&(_.value="yes"),c.value==="yes"))try{const e=await fe.getJson("people/".concat(p.value.patientID,"/relationships"));e.length>0?u.value=e[0].relation:q.value=!0}catch(e){console.error("Error checking relationships:",e),S("Failed to check existing guardians")}},oe=o=>{o!==void 0&&(P.value=o,D.value=!1)},Y=()=>{q.value=!1,u.value||(c.value="")},ie=o=>{u.value=o},K=o=>{u.value=o,c.value="yes"},z=()=>(R.value=!1,$.value="",h.value.trim()?/^\d+$/.test(h.value)?parseInt(h.value)<=0?(R.value=!0,$.value="Number must be positive",!1):!0:(R.value=!0,$.value="Only numbers are allowed",!1):(R.value=!0,$.value="ART number is required",!1)),ue=()=>{let o=!0;return _.value||(U.value=!0,o=!1),c.value||(G.value=!0,o=!1),W.value&&(P.value||(D.value=!0,o=!1),P.value==="yes"&&!z()&&(o=!1)),o};(async()=>{var b;await k.loadSitePrefix(),L.value=k.globalPropertyStore.sitePrefix||"MPC";const o=new la(X,Z);await o.loadPatientType(),H.value=o.getType();const e=(b=p.value.identifiers)==null?void 0:b.some(A=>{var Q;return A.identifier_type===4&&((Q=A.identifier)==null?void 0:Q.trim())!==""});if(g.value=e,!e&&H.value==="New patient"){const A=await Ve.getNextSuggestedARVNumber();V.value=A.arv_number.replace(/^\D+|\s/g,"")}else V.value=""})();const X=p.value.patientID,Z=Re.getUserID()||-1,de=Re.getUserLocation(),O=new na(X,Z,de),ee=async()=>{if(!ue()){S("Please correct the form errors");return}try{if(!await O.createEncounter()){S("Failed to create encounter");return}const e=[],b=await O.buildValueCoded("Patient present",_.value==="yes"?"Yes":"No");e.push(b);const A=await O.buildValueCoded("Guardian present",c.value==="yes"?"Yes":"No");if(e.push(A),!await O.saveObservationList(e)){S("Failed to save observations");return}P.value==="yes"&&(await O.createArvNumber(h.value)||S("Failed to save ARV number")),_e("Reception data saved successfully")}catch(o){S("Failed to save reception")}};return(o,e)=>(v(),x(ke,null,[e[18]||(e[18]=n("div",{class:"section-header",style:{"margin-bottom":"10px"}},[n("h2",null,"HIV Reception"),n("hr",{style:{"border-top":"1px solid #0c0c0c","margin-top":"10px"}})],-1)),n("div",ya,[n("div",Na,[n("div",wa,[n("div",Ia,[n("div",Sa,[e[5]||(e[5]=n("label",{class:"label-title"},[d("Patient present? "),n("span",{class:"required"},"*")],-1)),U.value?(v(),F(a(y),{key:0,class:"error-label"},{default:l(()=>e[4]||(e[4]=[d(" Patient present is required ")])),_:1,__:[4]})):I("",!0)]),s(a(ce),{value:_.value,onIonChange:e[0]||(e[0]=b=>j(b.detail.value)),class:"custom-segment"},{default:l(()=>[s(a(J),{value:"yes"},{default:l(()=>[s(a(y),null,{default:l(()=>e[6]||(e[6]=[d("Yes")])),_:1,__:[6]})]),_:1}),s(a(J),{value:"no"},{default:l(()=>[s(a(y),null,{default:l(()=>e[7]||(e[7]=[d("No")])),_:1,__:[7]})]),_:1})]),_:1},8,["value"])])]),n("div",Pa,[n("div",Ra,[n("div",xa,[e[9]||(e[9]=n("label",{class:"label-title"},[d("Guardian present? "),n("span",{class:"required"},"*")],-1)),G.value?(v(),F(a(y),{key:0,class:"error-label"},{default:l(()=>e[8]||(e[8]=[d(" Guardian present is required ")])),_:1,__:[8]})):I("",!0)]),s(a(ce),{value:c.value,onIonChange:e[1]||(e[1]=b=>re(b.detail.value)),class:"custom-segment"},{default:l(()=>[s(a(J),{value:"yes"},{default:l(()=>[s(a(y),null,{default:l(()=>e[10]||(e[10]=[d("Yes")])),_:1,__:[10]})]),_:1}),s(a(J),{value:"no"},{default:l(()=>[s(a(y),null,{default:l(()=>e[11]||(e[11]=[d("No")])),_:1,__:[11]})]),_:1})]),_:1},8,["value"])])]),W.value?(v(),x("div",Ca,[n("div",ka,[n("div",Va,[e[13]||(e[13]=n("label",{class:"label-title"},[d("Capture ART number? "),n("span",{class:"required"},"*")],-1)),D.value?(v(),F(a(y),{key:0,class:"error-label"},{default:l(()=>e[12]||(e[12]=[d(" Capture ART number is required ")])),_:1,__:[12]})):I("",!0)]),s(a(ce),{value:P.value,onIonChange:e[2]||(e[2]=b=>oe(b.detail.value)),class:"custom-segment"},{default:l(()=>[s(a(J),{value:"yes"},{default:l(()=>[s(a(y),null,{default:l(()=>e[14]||(e[14]=[d("Yes")])),_:1,__:[14]})]),_:1}),s(a(J),{value:"no"},{default:l(()=>[s(a(y),null,{default:l(()=>e[15]||(e[15]=[d("No")])),_:1,__:[15]})]),_:1})]),_:1},8,["value"])])])):I("",!0),P.value==="yes"&&!g.value?(v(),x("div",Ga,[n("div",Da,[n("div",$a,[e[16]||(e[16]=n("label",{class:"label-title"},[d("ART Number "),n("span",{class:"required"},"*")],-1)),R.value?(v(),F(a(y),{key:0,class:"error-label"},{default:l(()=>[d(E($.value),1)]),_:1})):I("",!0)]),n("div",Aa,[n("div",Ta,[Xe(n("input",{type:"text",class:"form-control","onUpdate:modelValue":e[3]||(e[3]=b=>h.value=b),onInput:z,placeholder:V.value,required:""},null,40,Fa),[[Ze,h.value]]),n("span",qa,E(L.value)+"-ARV",1)])])])])):I("",!0),n("div",Ua,[s(a(ne),{color:"primary",onClick:ee},{default:l(()=>e[17]||(e[17]=[d("Save")])),_:1,__:[17]})])]),s(ba,{isOpen:q.value,patientID:a(p).patientID,onClose:Y,onGuardianSelected:ie,onWhenSaved:K},null,8,["isOpen","patientID"])])],64))}});const za=De(Oa,[["__scopeId","data-v-059adf22"]]);export{za as default};
