import{D as se,d as te,r as c,aO as ae,c as ne,a as oe,H as le,O as re,f as p,J as i,l as n,u as t,a4 as ie,k as r,aS as ue,aP as de,e as A,m as R,dB as ce,E as me,Q as w,K as N,b2 as g,X as h,cP as O,bx as fe,c1 as x,c0 as E,N as $,bs as q,p as m,a7 as ve}from"./vendor-BgCOLJ26.js";import{x as K,a2 as T,t as M,U as pe,K as we,a3 as V,s as P,a4 as ge,a5 as he,a6 as Pe,a1 as ye,y as Ae,a7 as Ie,_ as Ce}from"./index-MiTIbkYg.js";import{i as Se}from"./Img-CJEgX1Vr.js";import{p as _e,g as be}from"./userService-h_as8X7T.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-2AIekHyJ.js";const z=se("authStatusStore",{state:()=>({emrAuthenticated:!1,miumAuthenticated:!1,lastLoginAttempt:null,loginTimestamp:null,username:""}),getters:{isPartiallyAuthenticated:a=>a.emrAuthenticated||a.miumAuthenticated,isFullyAuthenticated:a=>a.emrAuthenticated&&a.miumAuthenticated,authenticationStatus:a=>a.emrAuthenticated&&a.miumAuthenticated?"full":a.emrAuthenticated||a.miumAuthenticated?"partial":"none",authenticatedSystems:a=>{const u=[];return a.emrAuthenticated&&u.push("EMR"),a.miumAuthenticated&&u.push("MIUM"),u},failedSystems:a=>{const u=[];return a.emrAuthenticated||u.push("EMR"),a.miumAuthenticated||u.push("MIUM"),u}},actions:{setEMRAuthenticated(a){this.emrAuthenticated=a,a&&(this.loginTimestamp=new Date)},setMIUMAuthenticated(a){this.miumAuthenticated=a},setUsername(a){this.username=a},recordLoginAttempt(){this.lastLoginAttempt=new Date},clearAuthStatus(){this.emrAuthenticated=!1,this.miumAuthenticated=!1,this.loginTimestamp=null,this.lastLoginAttempt=null,this.username=""},hasSystemAccess(a){return a==="EMR"?this.emrAuthenticated:this.miumAuthenticated}},persist:!0}),ke={class:"login-container"},xe={key:0,style:{"justify-content":"center",display:"block"}},Ee={style:{"font-size":"15px"}},Me={style:{"font-size":"12px",color:"#34af4d"}},Ue={key:1},Le={style:{"font-size":"15px"}},Re={key:0},Ne={style:{"text-align":"left"}},qe={class:"signup-link"},ze={key:1},De={style:{"text-align":"left"}},Fe={key:0,class:"password-requirements"},Be={class:"requirements-list"},Oe={class:"signup-link"},$e=te({__name:"Login",setup(a){const u=c(""),y=c(""),U=c(""),I=c(!1),f=c(!1),L=c("test"),v=c(new Ie),s=c({username:"",currentPassword:"",newPassword:"",confirmPassword:""}),C=c(!1),S=c(!1),_=c(!1),H=ae(),W=K(),D=ne(()=>s.value.username.trim()!==""&&s.value.currentPassword.trim()!==""&&s.value.newPassword.trim()!==""&&s.value.confirmPassword.trim()!==""&&T(s.value.newPassword)&&s.value.newPassword===s.value.confirmPassword&&s.value.newPassword!==s.value.currentPassword),j=async()=>{W.terminate(),await K().postData("SET_OFFLINE_PROGRAMS")},G=()=>{U.value=localStorage.getItem("core_version")||""},J=async()=>{const o=ye(),e=await be();e&&(o.setUserFacilityName(e.name),o.setFacilityLocation(e),localStorage.setItem("facility_code",e.code))},Q=async()=>{const o=await v.value.checkUserPrograms(void 0);o!=null&&o.programs&&Ae().setAuthorizedPrograms(o==null?void 0:o.programs)},b=()=>{f.value=!f.value,f.value&&(s.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""})},X=()=>{M("Help functionality to be implemented")},Y=async()=>{if(!D.value){M("Please complete all fields correctly"),M("Password must be at least 8 characters long and contain at least one uppercase letter, one lowercase letter, one number, and one special character.");return}try{const o=await v.value.requestLogin(s.value.currentPassword,s.value.username);if(o){const{authorization:e}=o,{token:d,user:l}=e;l&&(localStorage.setItem("apiKey",d),await pe.updateUser(l.user_id,{password:s.value.newPassword}),we("Password changed successfully!"),await v.value.requestLogin(s.value.newPassword,s.value.username),s.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""},f.value=!1,localStorage.setItem("apiKey",""))}}catch(o){o instanceof V?P("Current password is incorrect"):P("Error changing password: ".concat(o))}},Z=async()=>{const o=z();if(!u.value||!y.value)return{success:!1,error:null,validationError:!0};v.value.setUsername(u.value),o.setUsername(u.value);try{return await v.value.login(y.value),await J(),await Q(),await Pe(),await _e(),o.setEMRAuthenticated(!0),{success:!0,error:null}}catch(e){return o.setEMRAuthenticated(!1),{success:!1,error:e}}},ee=async()=>(z(),{success:!1,error:""}),F=async()=>{const o=z();if(!u.value||!y.value){M("Complete form to log in");return}o.recordLoginAttempt();const[e,d]=await Promise.allSettled([Z(),ee()]),l=e.status==="fulfilled"&&e.value.success,B=d.status==="fulfilled"&&d.value.success;if(l)H.push("/home");else if(!l&&!B){const k=e.status==="fulfilled"?e.value.error:e.reason;k instanceof V?P("Invalid username or password"):k instanceof ge?(b(),P("Please change your password",5e4)):k instanceof he?(b(),P("Your password has expired. Please change your password",5e4)):P("".concat(k),5e4)}else!l&&B&&(e.status==="fulfilled"?e.value.error:e.reason)};return oe(async()=>{localStorage.setItem("apiKey",""),await v.value.loadConfig(),G(),await j()}),(o,e)=>{const d=le("ion-icon");return p(),re(t(ve),null,{default:i(()=>[n(t(ie),{class:"ion-padding login-page"},{default:i(()=>[r("div",ke,[n(t(ue),{style:{"background-color":"#fff"}},{default:i(()=>[n(t(de),null,{default:i(()=>[n(t(ce),{class:"login_img",src:t(Se)("mw.png"),id:"logo"},null,8,["src"]),n(t(me),{class:"login-title"},{default:i(()=>[L.value==="development"||L.value==="test"?(p(),A("span",xe,[r("div",null,[e[10]||(e[10]=w(" MaHIS ",-1)),r("small",Ee,"(v"+N(U.value)+")",1)]),r("div",Me,"("+N(L.value)+")",1)])):(p(),A("span",Ue,[e[11]||(e[11]=w(" MaHIS ",-1)),r("small",Le,"(v"+N(U.value)+")",1)]))]),_:1}),f.value?R("",!0):(p(),A("div",Re,[r("span",Ne,[n(t(g),{value:u.value,onIonInput:e[0]||(e[0]=l=>u.value=l.target.value||""),type:"text",label:"Username",ref:"usernameRef","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:i(()=>[n(t(h),{slot:"end"},{default:i(()=>[n(d,{icon:t(O)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),n(t(g),{value:y.value,onIonInput:e[2]||(e[2]=l=>y.value=l.target.value||""),type:I.value?"text":"password",label:"Password",ref:"passwordRef","label-placement":"floating",fill:"outline",placeholder:"Enter Password",class:"input-fields",required:"",onKeydown:fe(F,["enter"])},{default:i(()=>[n(t(h),{slot:"end"},{default:i(()=>[n(d,{icon:I.value?t(x):t(E),onClick:e[1]||(e[1]=l=>I.value=!I.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"])]),n(t($),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:F,class:"login-button"},{default:i(()=>[...e[12]||(e[12]=[w(" Login ",-1)])]),_:1}),r("p",qe,[e[13]||(e[13]=w(" For help click ",-1)),r("a",{href:"#",onClick:q(X,["prevent"])},"Here"),e[14]||(e[14]=w(" | ",-1)),r("a",{href:"#",onClick:q(b,["prevent"])},"Change Password")])])),f.value?(p(),A("div",ze,[e[17]||(e[17]=r("h3",{style:{"text-align":"center","margin-bottom":"20px",color:"#34af4d"}},"Change Password",-1)),r("span",De,[n(t(g),{value:s.value.username,onIonInput:e[3]||(e[3]=l=>s.value.username=l.target.value||""),type:"text",label:"Username","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:i(()=>[n(t(h),{slot:"end"},{default:i(()=>[n(d,{icon:t(O)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),n(t(g),{value:s.value.currentPassword,onIonInput:e[5]||(e[5]=l=>s.value.currentPassword=l.target.value||""),type:C.value?"text":"password",label:"Current Password","label-placement":"floating",fill:"outline",placeholder:"Enter Current Password",class:"input-fields",required:""},{default:i(()=>[n(t(h),{slot:"end"},{default:i(()=>[n(d,{icon:C.value?t(x):t(E),onClick:e[4]||(e[4]=l=>C.value=!C.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"]),n(t(g),{value:s.value.newPassword,onIonInput:e[7]||(e[7]=l=>s.value.newPassword=l.target.value||""),type:S.value?"text":"password",label:"New Password","label-placement":"floating",fill:"outline",placeholder:"Enter New Password",class:m(["input-fields",{"invalid-input":s.value.newPassword&&!t(T)(s.value.newPassword)}]),required:""},{default:i(()=>[n(t(h),{slot:"end"},{default:i(()=>[n(d,{icon:S.value?t(x):t(E),onClick:e[6]||(e[6]=l=>S.value=!S.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"]),n(t(g),{value:s.value.confirmPassword,onIonInput:e[9]||(e[9]=l=>s.value.confirmPassword=l.target.value||""),type:_.value?"text":"password",label:"Confirm New Password","label-placement":"floating",fill:"outline",placeholder:"Confirm New Password",class:m(["input-fields",{"invalid-input":s.value.confirmPassword&&s.value.newPassword!==s.value.confirmPassword}]),required:""},{default:i(()=>[n(t(h),{slot:"end"},{default:i(()=>[n(d,{icon:_.value?t(x):t(E),onClick:e[8]||(e[8]=l=>_.value=!_.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"])]),s.value.newPassword?(p(),A("div",Fe,[e[15]||(e[15]=r("p",{class:"requirements-title"},"Password Requirements:",-1)),r("ul",Be,[r("li",{class:m({valid:s.value.newPassword.length>=8})},"At least 8 characters",2),r("li",{class:m({valid:/[A-Z]/.test(s.value.newPassword)})},"One uppercase letter",2),r("li",{class:m({valid:/[0-9]/.test(s.value.newPassword)})},"One number",2),r("li",{class:m({valid:/[@#$%^&+=*!-]/.test(s.value.newPassword)})}," One special character (@#$%^&+=*!-) ",2),r("li",{class:m({valid:s.value.newPassword!==s.value.currentPassword&&s.value.currentPassword!==""})}," Different from current password ",2)])])):R("",!0),n(t($),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:Y,class:"login-button",disabled:!D.value},{default:i(()=>[...e[16]||(e[16]=[w(" Change Password ",-1)])]),_:1},8,["disabled"]),r("p",Oe,[r("a",{href:"#",onClick:q(b,["prevent"])},"Back to Login")])])):R("",!0)]),_:1})]),_:1})])]),_:1})]),_:1})}}}),Ge=Ce($e,[["__scopeId","data-v-ffa40062"]]);export{Ge as default};
