var ue=Object.defineProperty;var pe=(e,t,n)=>t in e?ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var N=(e,t,n)=>pe(e,typeof t!="symbol"?t+"":t,n);import{d as G,L as Q,N as K,a6 as X,a5 as Z,E as W,a7 as Y,M as ee,I as te,a4 as se,aT as ge,ca as ne,R as me,H as c,e as f,f as g,l as o,J as a,k as s,K as r,Q as m,F as D,aV as fe,ah as $,b2 as he,a_ as _e,G as ye,bi as ve,aP as De,aQ as be,aR as we,aS as Ce,cZ as ke,bX as Me,e0 as Pe,av as Oe,c2 as Ie,e1 as Se,r as Te,aO as Be,O as j,P as I,m as k,p as H}from"./vendor-D0D29_A_.js";import{E as R}from"./EIRreportsStore-B8oLXCLf.js";import{N as Ne}from"./NavigationMenu-DL5lZ6-B.js";import{V as $e}from"./ViewToggleComponent-4zBgTHFl.js";import{i as Ae,_ as oe,aW as A,P as Ve,S as z,u as ie,aN as xe,K as E,aX as ze,aY as q,e as U,aZ as Ee,o as qe,v as V,a_ as x,s as Fe,g as je,q as He,w as Re,aC as Ue,a$ as Le}from"./index-B042x6Mo.js";import{D as re}from"./drug_prescription_service-PmjC1kDb.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-yV10MRMc.js";const Je=G({name:"MedicationDetailsModal",components:{IonContent:se,IonHeader:te,IonFooter:ee,IonPage:Y,IonTitle:W,IonRow:Z,IonCol:X,IonButton:K,IonIcon:Q},props:{selectedMedication:{type:Object,default:null}},data(){return{iconsContent:Ae,medkit:ne,closeIcon:ge,dismiss:()=>(this.$emit("close"),me.dismiss())}},methods:{formatFullDate(e){return e?new Date(e).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"N/A"},getFrequencyLabel(e){const t=re.find(n=>n.code===e);return t?t.label:"Unknown"}}}),Ge={class:"medication-details-header"},Qe={class:"modal_wrapper"},Ke={class:"medication-details-modal"},Xe={class:"text-xl font-bold mb-4"},Ze={class:"grid grid-cols-2 gap-3"};function We(e,t,n,i,l,d){const h=c("ion-icon"),y=c("ion-title"),u=c("ion-header"),M=c("ion-content"),b=c("ion-button"),S=c("ion-col"),T=c("ion-row"),P=c("ion-footer");return g(),f(D,null,[o(u,{style:{display:"flex","justify-content":"space-between"}},{default:a(()=>[o(y,{class:"modalTitle"},{default:a(()=>[s("div",Ge,[o(h,{icon:e.medkit,class:"ion-margin-end"},null,8,["icon"]),t[1]||(t[1]=s("span",null,"Medication Details",-1))])]),_:1}),o(h,{onClick:t[0]||(t[0]=B=>e.dismiss()),style:{"padding-top":"10px","padding-right":"10px"},icon:e.iconsContent.cancel},null,8,["icon"])]),_:1}),o(M,{fullscreen:!0,class:"ion-padding",style:{"--background":"#fff"}},{default:a(()=>[s("div",Qe,[s("div",Ke,[s("h2",Xe,r(e.selectedMedication.drug.name),1),s("div",Ze,[s("div",null,[t[2]||(t[2]=s("strong",null,"Order ID:",-1)),m(" "+r(e.selectedMedication.order_id),1)]),s("div",null,[t[3]||(t[3]=s("strong",null,"Drug ID:",-1)),m(" "+r(e.selectedMedication.drug_inventory_id),1)]),s("div",null,[t[4]||(t[4]=s("strong",null,"Dose:",-1)),m(" "+r(e.selectedMedication.dose)+" "+r(e.selectedMedication.units),1)]),s("div",null,[t[5]||(t[5]=s("strong",null,"Equivalent Daily Dose:",-1)),m(" "+r(e.selectedMedication.equivalent_daily_dose),1)]),s("div",null,[t[6]||(t[6]=s("strong",null,"Frequency:",-1)),m(" "+r(e.getFrequencyLabel(e.selectedMedication.frequency)),1)]),s("div",null,[t[7]||(t[7]=s("strong",null,"Order Type:",-1)),m(" "+r(e.selectedMedication.order.order_type_id),1)]),s("div",null,[t[8]||(t[8]=s("strong",null,"Start Date:",-1)),m(" "+r(e.formatFullDate(e.selectedMedication.order.start_date)),1)]),s("div",null,[t[9]||(t[9]=s("strong",null,"Date Created:",-1)),m(" "+r(e.formatFullDate(e.selectedMedication.order.date_created)),1)]),s("div",null,[t[10]||(t[10]=s("strong",null,"Orderer:",-1)),m(" "+r(e.selectedMedication.order.orderer),1)]),s("div",null,[t[11]||(t[11]=s("strong",null,"Instructions:",-1)),m(" "+r(e.selectedMedication.order.instructions),1)])])])])]),_:1}),o(P,{collapse:"fade",class:"ion-no-border"},{default:a(()=>[o(T,null,{default:a(()=>[o(S,null,{default:a(()=>[o(b,{onClick:e.dismiss,color:"primary",style:{float:"right","margin-bottom":"20px","margin-right":"20px"}},{default:a(()=>[o(h,{icon:e.closeIcon,slot:"start"},null,8,["icon"]),t[12]||(t[12]=m(" Close ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})],64)}const L=oe(Je,[["render",We],["__scopeId","data-v-01db984e"]]);class J extends A{constructor(n=null,i=null){const l=new Ve,d=n!==null?n:l.getID(),h=i!==null?i:z.getUserID();super(d,32,h);N(this,"drugHistory");N(this,"currentDrugOrder");this.drugHistory=[],this.currentDrugOrder=[]}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}getDispensationArryObj(n,i){return[{drug_order_id:n,date:this.date,quantity:i}]}saveDispensations(n,i){return A.postJson("/dispensations",{dispensations:n,provider_id:this.providerID,program_id:i})}generateOfflineDispensatiobObject(n,i){return{dispensations:n,provider_id:this.providerID,program_id:i,patient_id:this.patientID}}async saveDispensationsOffline(n){var i,l,d;try{const h=ie(),{patient:y}=fe(h),u=JSON.parse(JSON.stringify(y.value));n.length>0&&((d=(l=(i=u.dispensations)!=null?i:u.dispensations={}).unsaved)!=null||(l.unsaved=[]),u.dispensations.unsaved.length>=0&&u.dispensations.unsaved.push(...n)),await xe(u),E("Dispensations saved offline successfully")}catch(h){ze("Error saving dispensations offline"+h)}}async voidOrder(n){return A.void("/dispensations/".concat(n),{})}async loadDrugHistory(){const n=await q.getDrugOrderHistory(this.patientID);n&&(this.drugHistory=n)}async loadCurrentDrugOrder(){const n=await q.getDrugOrders(this.patientID);n&&(this.currentDrugOrder=await Promise.all(n))}calcCompletePack(n,i){const l=n.barcodes.sort(function(y,u){return y.tabs-u.tabs});if(l.length==0||i==0)return i;for(let y=0;y<=l.length-1;y++)if(parseInt(l[y].tabs)>=i)return l[y].tabs;const d=parseInt(l[0].tabs);let h=parseInt(l[l.length-1].tabs);for(;h<i;)h+=d;return h}}const Ye=G({name:"MedicationDispensation",components:{IonContent:se,IonPage:Y,NavigationMenu:Ne,IonCard:Ce,IonCardHeader:we,IonCardTitle:be,IonCardContent:De,IonButton:K,IonModal:ve,IonHeader:te,IonToolbar:ye,IonTitle:W,IonButtons:_e,IonInput:he,MedicationDetailsModal:L,IonRow:Z,IonCol:X,IonIcon:Q,ViewToggleComponent:$e,IonFooter:ee},setup(){const e=Te(null),t=Be();return{navMenuRef:e,navigateBack:()=>{e.value&&e.value.goBackwards()},router:t}},data(){return{medicationsByProgram:{},medications:[],selectedMedication:null,medkit:ne,repeat:Se,eye:Ie,alertCircleOutline:Oe,checkmarkDoneCircleOutline:Pe,clipboardOutline:Me,timeOutline:ke,currentView:"list",previousClinicalNotes:"",checkedIn:!1,showAsPrescribedBtn:!1}},computed:{...$(R,["navigationPayload"]),...$(ie,["patient"]),...$(U,["NCDMedicatioTogglePreference"]),medicationsByProgram(){return this.medications.reduce((e,t)=>{const n=t.program_id;return e[n]||(e[n]=[]),e[n].push(t),e},{})},groupedMedications(){return this.medications.reduce((e,t)=>{const n=t.order.date_created.split("T")[0];return e[n]||(e[n]=[]),e[n].push(t),e},{})}},async mounted(){this.initComp()},methods:{async initComp(){this.initTogglePreference(),this.medications=[],this.initOwnNavData(),await this.prescribedMedications(),this.enableShowAsPrescribedBtn()},async getPrograms(){try{return await x()&&Le()==!1?await this.getOnlinePrograms():await this.getOfflinePrograms()}catch(e){return console.error("Error fetching programs:",e),await this.getOnlinePrograms()}},async getOnlinePrograms(){return await z.getJson("/programs",{page_size:1e3})},async printVisitSummary(){await new Ue().printData("visit")},async handleAbscond(e){try{await He(e),await Re().refresh(z.getUserLocationId()),E("The patient's visit is now closed"),await this.router.push("/home")}catch(t){console.error(t)}},initOwnNavData(){R().setNavigationPayload("Dispense Medication",!0,!1,"/","home")},async prescribedMedications(){if(await x()&&je()==!1){if(this.medications=await q.findProgramDrugOrdersAwaitingDispensation(this.patient.patientID),console.log(this.medications),!this.medications)return;this.medications=this.medications.map(t=>({...t,amountToDispense:t.amountToDispense||null,dispensed:t.dispensed||!1})),await this.groupMedicationsByProgram(this.medications)}else await this.getPatientPrescribedMedications()},async getPatientPrescribedMedications(){try{const e=this.patient.dispensations.saved,t=this.patient.dispensations.unsaved,n=new Set;t.forEach(d=>{d.dispensations&&d.dispensations[0]&&d.dispensations[0].drug_order_id&&n.add(d.dispensations[0].drug_order_id)});const l=e.filter(d=>!n.has(d.order_id)).map(d=>({...d,amountToDispense:d.amountToDispense||null,dispensed:d.dispensed||!1}));await this.groupMedicationsByProgram(l)}catch(e){console.error("Error fetching offline medications:",e)}},async groupMedicationsByProgram(e){const t=await this.getPrograms(),n={};t.forEach(i=>{n[i.program_id]=i.name}),this.medicationsByProgram={},e.forEach(i=>{const l=n[i.program_id];l&&(this.medicationsByProgram[l]||(this.medicationsByProgram[l]=[]),this.medicationsByProgram[l].push(i))})},async getOfflinePrograms(){try{return await Fe("programs",{likeClause:{},currentPage:1,itemsPerPage:5e4}).then(d=>d.records)}catch(e){throw console.error("Error fetching offline districts:",e.message),e}},getFrequencyLabel(e){const t=re.find(n=>n.code===e);return t?t.label:"Unknown"},validateAmount(e){const t=parseFloat(e.amountToDispense);isNaN(t)||t<=0?e.error="Please enter a valid amount greater than 0.":e.error=null},setAmountAsPrescribed(e){e.amountToDispense=e.dose,this.validateAmount(e)},async dispenseMedication(e){if(e.error){V("Fix errors before dispensing.");return}try{const t=new J,n=t.getDispensationArryObj(e.order_id,e.amountToDispense);if(await x())await t.saveDispensations(n,e.program_id),e.dispensed=!0,E("Medication dispensed successfully.");else{const l=new J,d=l.generateOfflineDispensatiobObject(n,e.program_id);await l.saveDispensationsOffline([d]),e.dispensed=!0}}catch(t){V("Dispensing failed. Please try again."),V("Error: "+t),console.error(t)}},async viewDetails(e){this.selectedMedication=e,await qe(L,{class:"large-modal"},!0,{selectedMedication:this.selectedMedication})},formatHeaderDate(e){return new Date(e).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})},handleViewChange(e){this.initTogglePreference(e,!0)},async enableShowAsPrescribedBtn(){const e=await Ee([14]);this.showAsPrescribedBtn=!e},initTogglePreference(e="list",t=!1){const n={toggle_view:e},i=U();Object.keys(this.NCDMedicatioTogglePreference).length===0&&(n.toggle_view="list",i.setNCDMedicatioTogglePreference(n)),Object.keys(this.NCDMedicatioTogglePreference).length>0&&t==!0&&i.setNCDMedicatioTogglePreference(n)},groupMedicationsByDate(e){return e.reduce((t,n)=>{const i=n.order.date_created.split("T")[0];return t[i]||(t[i]=[]),t[i].push(n),t},{})}},watch:{patient:{async handler(){this.initComp()},deep:!0},$route:{handler(e){e.name==="NCDDispensations"&&this.initComp()},immediate:!0}}}),et={key:0,style:{margin:"20px"},class:"flex flex-col items-center justify-center p-8"},tt={key:1,class:"p-4"},st={class:"text-xl font-bold mb-4 program-name"},nt={class:"overflow-x-auto"},ot={class:"w-full"},it={class:"p-3"},rt={class:"p-3"},at={class:"flex items-center"},lt={class:"p-3"},dt={class:"p-3"},ct={class:"p-3"},ut={class:"flex items-center space-x-2"},pt={key:0,class:"error-text text-sm"},gt={class:"p-3"},mt={class:"flex space-x-2"},ft={key:0,class:"text-center py-8"},ht={key:2,class:"p-4"},_t={class:"text-xl font-bold mb-4 program-name"},yt={class:"text-lg font-bold mb-2"},vt={class:"text-md font-medium"},Dt={class:"medication-details"},bt={class:"flex justify-between mb-3"},wt={class:"flex items-center"},Ct={class:"flex items-center mb-3"},kt={key:0,class:"error-text"},Mt={class:"mt-3 flex space-x-2"},Pt={key:0,class:"text-center mb-8"};function Ot(e,t,n,i,l,d){const h=c("NavigationMenu"),y=c("ViewToggleComponent"),u=c("ion-icon"),M=c("ion-input"),b=c("ion-button"),S=c("ion-card-content"),T=c("ion-card"),P=c("ion-col"),B=c("ion-row"),ae=c("ion-card-title"),le=c("ion-card-header"),de=c("ion-content"),F=c("ion-footer"),ce=c("ion-page");return g(),j(ce,null,{default:a(()=>[o(h,{ref:"navMenuRef"},null,512),o(y,{"initial-view":e.NCDMedicatioTogglePreference.toggle_view,onViewChanged:e.handleViewChange},null,8,["initial-view","onViewChanged"]),o(de,null,{default:a(()=>[Object.keys(e.medicationsByProgram).length===0?(g(),f("div",et,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-4 text-gray-500"},null,8,["icon"]),t[2]||(t[2]=s("h2",{class:"text-xl font-semibold text-gray-700 mb-2"},"No Medications to Dispense",-1)),t[3]||(t[3]=s("p",{class:"text-gray-600"},"There are currently no medications waiting to be dispensed for current Client.",-1))])):e.NCDMedicatioTogglePreference.toggle_view==="list"?(g(),f("div",tt,[(g(!0),f(D,null,I(e.medicationsByProgram,(w,C)=>(g(),f(D,{key:C},[s("h2",st,r(C),1),o(T,{class:"mb-6"},{default:a(()=>[o(S,null,{default:a(()=>[s("div",nt,[s("table",ot,[t[6]||(t[6]=s("thead",null,[s("tr",{class:"bg-gray-100"},[s("th",{class:"p-3 text-left"},"Date"),s("th",{class:"p-3 text-left"},"Medication"),s("th",{class:"p-3 text-left"},"Dose"),s("th",{class:"p-3 text-left"},"Frequency"),s("th",{class:"p-3 text-left"},"Amount to Dispense"),s("th",{class:"p-3 text-left"},"Actions")])],-1)),s("tbody",null,[(g(!0),f(D,null,I(w,p=>(g(),f("tr",{key:p.order_id,class:"border-b hover:bg-gray-50"},[s("td",it,r(e.formatHeaderDate(p.order.date_created.split("T")[0])),1),s("td",rt,[s("div",at,[o(u,{icon:e.medkit,class:"mr-2"},null,8,["icon"]),m(" "+r(p.drug.name),1)])]),s("td",lt,r(p.dose)+" "+r(p.units),1),s("td",dt,r(e.getFrequencyLabel(p.frequency)),1),s("td",ct,[s("div",ut,[o(M,{type:"number",placeholder:"Amount",modelValue:p.amountToDispense,"onUpdate:modelValue":v=>p.amountToDispense=v,onInput:v=>e.validateAmount(p),class:H(["w-24 dose-input bordered-input",p.error?"input-error":""])},null,8,["modelValue","onUpdate:modelValue","onInput","class"]),k("",!0)]),p.error?(g(),f("div",pt,r(p.error),1)):k("",!0)]),s("td",gt,[s("div",mt,[o(b,{color:"primary",size:"small",onClick:v=>e.dispenseMedication(p),disabled:!p.amountToDispense||p.dispensed},{default:a(()=>[o(u,{icon:e.checkmarkDoneCircleOutline,class:"mr-1",style:{"margin-right":"5px"}},null,8,["icon"]),m(" "+r(p.dispensed?"Dispensed":"Dispense"),1)]),_:2},1032,["onClick","disabled"]),o(b,{color:"secondary",size:"small",onClick:v=>e.viewDetails(p),style:{"margin-left":"10px"}},{default:a(()=>[o(u,{icon:e.eye,class:"mr-1",style:{"margin-right":"5px"}},null,8,["icon"]),t[5]||(t[5]=m(" Details ",-1))]),_:1},8,["onClick"])])])]))),128))])]),w.length===0?(g(),f("div",ft,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-2"},null,8,["icon"]),s("p",null,"No medications prescribed for "+r(C),1)])):k("",!0)])]),_:2},1024)]),_:2},1024)],64))),128))])):(g(),f("div",ht,[(g(!0),f(D,null,I(e.medicationsByProgram,(w,C)=>(g(),f(D,{key:C},[s("h2",_t,r(C),1),(g(!0),f(D,null,I(e.groupMedicationsByDate(w),(p,v)=>(g(),f(D,{key:v},[s("h3",yt,r(e.formatHeaderDate(v)),1),o(B,null,{default:a(()=>[o(P,{size:"12","size-md":"6","size-lg":"4"},{default:a(()=>[s("h3",vt,r(v),1)]),_:2},1024)]),_:2},1024),o(B,null,{default:a(()=>[(g(!0),f(D,null,I(p,_=>(g(),j(P,{key:_.order_id,size:"12","size-md":"6","size-lg":"4"},{default:a(()=>[o(T,{class:"mb-4"},{default:a(()=>[o(le,null,{default:a(()=>[o(ae,{class:"medication-details-header"},{default:a(()=>[o(u,{icon:e.medkit,class:"ion-margin-end"},null,8,["icon"]),s("span",null,r(_.drug.name),1)]),_:2},1024)]),_:2},1024),o(S,null,{default:a(()=>[s("div",Dt,[s("div",bt,[s("span",wt,r(e.getFrequencyLabel(_.frequency))+" ("+r(_.frequency)+") ",1)]),s("div",Ct,[o(M,{type:"number",placeholder:"Amount",modelValue:_.amountToDispense,"onUpdate:modelValue":O=>_.amountToDispense=O,onInput:O=>e.validateAmount(_),class:H(["w-24 dose-input bordered-input",_.error?"input-error":""])},null,8,["modelValue","onUpdate:modelValue","onInput","class"]),k("",!0)]),_.error?(g(),f("div",kt,r(_.error),1)):k("",!0),s("div",Mt,[o(b,{color:"primary",onClick:O=>e.dispenseMedication(_),disabled:!_.amountToDispense||_.dispensed},{default:a(()=>[o(u,{icon:e.checkmarkDoneCircleOutline,class:"mr-2",style:{"margin-right":"5px"}},null,8,["icon"]),m(" "+r(_.dispensed?"Dispensed":"Dispense"),1)]),_:2},1032,["onClick","disabled"]),o(b,{color:"secondary",style:{"margin-left":"20px"},onClick:O=>e.viewDetails(_)},{default:a(()=>[o(u,{icon:e.eye,class:"mr-2",style:{"margin-right":"5px"}},null,8,["icon"]),t[8]||(t[8]=m(" Details ",-1))]),_:1},8,["onClick"])])])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)],64))),128)),w.length===0?(g(),f("div",Pt,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-2"},null,8,["icon"]),s("p",null,"No medications prescribed for "+r(C),1)])):k("",!0)],64))),128))]))]),_:1}),o(F,{collapse:"fade",class:"ion-no-border"},{default:a(()=>[o(B,null,{default:a(()=>[o(P,null,{default:a(()=>[o(b,{id:"cbtn",class:"",color:"primary",fill:"solid",style:{float:"right","margin-left":"50px"},onClick:t[0]||(t[0]=w=>e.printVisitSummary())},{default:a(()=>[...t[9]||(t[9]=[m(" Print Visit Summary ",-1)])]),_:1}),o(b,{id:"cbtn",class:"",color:"danger",fill:"solid",style:{float:"right","margin-left":"50px"},onClick:t[1]||(t[1]=w=>e.handleAbscond(e.patient))},{default:a(()=>[...t[10]||(t[10]=[m(" Close visit ",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),o(F)]),_:1})}const zt=oe(Ye,[["render",Ot],["__scopeId","data-v-34f715b7"]]);export{zt as default};
