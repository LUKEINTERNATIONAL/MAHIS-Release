var ba=Object.defineProperty;var ga=(U,C,S)=>C in U?ba(U,C,{enumerable:!0,configurable:!0,writable:!0,value:S}):U[C]=S;var Le=(U,C,S)=>ga(U,typeof C!="symbol"?C+"":C,S);import{d as Ye,aT as qe,r as m,c as Ae,a as je,w as ha,E as Ve,y as N,f as c,u as a,b4 as ya,z as r,l as t,U as Na,T as wa,A as f,W as pe,S as Pa,k as d,e as P,m as h,G as L,b6 as Sa,I as Ne,cP as Aa,be as Va,as as ka,F as Ia,L as Ra,B as D,bm as me,p as E,D as y,bh as ze,aM as re,aL as x,bp as Ca,ad as qa,d7 as xa,aN as Da,d5 as we,aE as ke,aF as se,i as Ga,bf as $a,aQ as Fa}from"./vendor-Bx_IVmwz.js";import{a3 as He,u as We,b as Ta,A as Ie,L as fe,e as Ee,cm as Ua,P as Pe,t as j,k as Be,_ as Je,s as Oa,m as Ma}from"./index-C_B4etN5.js";import{A as La}from"./app_encounter_service-CL70yiSF.js";import{R as Re}from"./relations_service-xis0d_i1.js";import{P as Ea}from"./patient_registration_service-DMEL_EgH.js";import{I as Ba}from"./identifier_service-DXpTnDh4.js";import"./lodash-Dt8AsbQm.js";class Ya extends La{constructor(S,V,p){super(S,51,V,p);Le(this,"sitePrefix");this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}createArvNumber(S){return He.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:S})}buildArvNumber(S){return"".concat(this.sitePrefix,"-ARV-").concat(S)}}const ja={class:"form-container"},za={class:"search-section"},Ha={key:0,class:"search-results"},Wa={key:0,class:"search-loading"},Ja={key:1},Qa=["onClick"],Za={class:"guardian-name"},Ka={key:0,class:"relationship-badge"},Xa={key:0,class:"guardian-address"},et={key:0,class:"relationship-selector"},at={class:"relationship-actions"},tt={class:"pagination"},lt=["disabled"],st={class:"page-info"},rt=["disabled"],nt={key:2,class:"no-results"},it={key:0,class:"create-form-section"},ot={key:0},ut={key:1},dt={key:2},vt={key:0},ct={key:1},pt={key:2},mt={class:"form-row"},ft={class:"form-group radio-group"},_t={class:"radio-label-container"},Ce=10,bt=Ye({__name:"ManageGuardian",props:{isOpen:{type:Boolean,required:!0}},emits:["close","whenSaved","guardianSelected"],setup(U,{emit:C}){const S=We(),{patient:V}=qe(S),p=Ta(),{apiStatus:B}=qe(p),J=C,G=m(""),ne=m([]),Q=m(!1),n=m(!1),u=m(1),Y=m([]),Z=m([]),_e=m([]),R=m(null),z=m(null),v=m({firstName:"",lastName:"",gender:"",phone:"",address:{},relationship:""}),$=m(null),O=m(null),i=m(null),l=m([]),b=m([]),k=m([]),A=m(!1),F=m(!1),H=m(!1),ie=m(!1),oe=m([]),be=m(null),W=m(!1),K=m(!1),X=m(!1),ue=m(!1),ee=m(!1),ae=m(""),te=m(""),Se=Ae(()=>Math.ceil(Y.value.length/Ce)),Qe=Ae(()=>{const s=(u.value-1)*Ce,e=s+Ce;return Y.value.slice(s,e)});Ae(()=>v.value.firstName.trim()!==""&&v.value.lastName.trim()!==""&&v.value.relationship),je(async()=>{await aa(),await Fe()});const ge=()=>{fa(),J("close")},Ze=()=>{clearTimeout(xe),xe=setTimeout(()=>{n.value=!1,De()},300)};let xe;const De=async()=>{if(!G.value.trim()){Y.value=[],u.value=1;return}Q.value=!0;try{const s=await Pe.getJson("people/".concat(V.value.patientID,"/relationships"));Z.value=s.map(_=>{var q,M,T,de,le,ve,ye,ce,Te,Ue,Oe,Me;if(((M=(q=_.relation)==null?void 0:q.person_id)==null?void 0:M.toString())===V.value.patientID)return null;const o=((de=(T=_.relation)==null?void 0:T.names)==null?void 0:de[0])||{},I=((ve=(le=_.relation)==null?void 0:le.addresses)==null?void 0:ve[0])||{};return{id:(ce=(ye=_.relation)==null?void 0:ye.person_id)==null?void 0:ce.toString(),firstName:o.given_name||"Unknown",lastName:o.family_name||"",phone:((Oe=(Ue=(Te=_.relation)==null?void 0:Te.person_attributes)==null?void 0:Ue.find(_a=>_a.value))==null?void 0:Oe.value)||"",relationship:((Me=_.type)==null?void 0:Me.b_is_to_a)||"Other",address:{city_village:I.city_village||"",township_division:I.township_division||"",state_province:I.state_province||""},source:"existing"}}).filter(Boolean);const e=G.value.split(" "),w={given_name:e[0],family_name:e.length>=2?e[1]:"",page:"1",per_page:"20",exclude_patient_id:V.value.patientID},g=await Pe.search(w);_e.value=g.filter(_=>_.person.person_id.toString()!==V.value.patientID).map(_=>{var q,M;const o=_.person.names[0],I=_.person.addresses[0]||{};return{id:_.person.person_id.toString(),firstName:o.given_name,lastName:o.family_name,phone:((M=(q=_.person.attributes)==null?void 0:q.find(T=>T.attribute_type==="Cell Phone Number"))==null?void 0:M.value)||"",relationship:"",address:{city_village:I.city_village||"",township_division:I.township_division||"",state_province:I.state_province||""},source:"search"}}),Y.value=[...Z.value,..._e.value.filter(_=>!Z.value.some(o=>o.id===_.id))].sort((_,o)=>{const I="".concat(_.firstName," ").concat(_.lastName).toUpperCase(),q="".concat(o.firstName," ").concat(o.lastName).toUpperCase();return I.localeCompare(q)}),u.value=1}catch(s){j("Failed to search guardians")}finally{Q.value=!1}},Ke=s=>{s.relationship?Ge(s):(z.value=s,R.value=null)},Ge=async s=>{try{const e=oe.value.find(w=>{var g;return w.value===(s.relationship||((g=R.value)==null?void 0:g.value))});e&&(await Re.createRelation(V.value.patientID,s.id,e.other.relationship_type_id),J("guardianSelected",{...s,relationship:e.value,address:s.address||{city_village:"",township_division:"",state_province:""}}),ge(),Be("Guardian relationship created successfully"))}catch(e){j("Failed to create guardian relationship")}finally{$e()}},Xe=()=>{if(ee.value=!R.value,!R.value){j("Please select a relationship");return}Ge(z.value)},ea=()=>{$e()},$e=()=>{z.value=null,R.value=null,ee.value=!1},aa=async()=>{try{const s=await Ie("districts"),e=Array.isArray(s)?s:(s==null?void 0:s.records)||[];if(l.value=e.map(w=>({name:w.name,district_id:w.district_id||w.id})),l.value.length===0&&B.value){const w=await fe.getAllDistricts();l.value=w.map(g=>({name:g.name,district_id:g.district_id||g.id}))}}catch(s){console.error("District loading error:",s),l.value=[]}},ta=async s=>{try{const e=await Ie("TAs",{whereClause:{district_id:s.district_id}}),w=Array.isArray(e)?e:(e==null?void 0:e.records)||[];if(b.value=w.map(g=>({name:g.name,traditional_authority_id:g.traditional_authority_id||g.id})),b.value.length===0&&B.value){const g=await fe.getTraditionalAuthorities(s.district_id);b.value=g.map(_=>({name:_.name,traditional_authority_id:_.traditional_authority_id||_.id}))}}catch(e){console.error("TA loading error:",e),b.value=[]}},la=async s=>{try{const e=await Ie("villages",{whereClause:{traditional_authority_id:s.traditional_authority_id}}),w=Array.isArray(e)?e:(e==null?void 0:e.records)||[];if(k.value=w.map(g=>({name:g.name,village_id:g.village_id||g.id})),k.value.length===0&&B.value){const g=await fe.getVillages(s.traditional_authority_id);k.value=g.map(_=>({name:_.name,village_id:_.village_id||_.id}))}}catch(e){console.error("Village loading error:",e),k.value=[]}},sa=()=>{const s=he(v.value.firstName);K.value=!s.valid,ae.value=s.reason;const e=he(v.value.lastName);return X.value=!e.valid,te.value=e.reason,ie.value=!v.value.gender,A.value=!$.value,F.value=!O.value,H.value=!i.value,W.value=!v.value.relationship,!(K.value||X.value||ie.value||A.value||F.value||H.value||W.value)},he=s=>{const e=s.trim();return e===""?{valid:!1,reason:"required"}:/^[A-Za-z']+$/.test(e)?e.length<3?{valid:!1,reason:"too_short"}:{valid:!0,reason:""}:{valid:!1,reason:"invalid_chars"}},ra=s=>{v.value.firstName=s.target.value;const e=he(v.value.firstName);return ae.value=e.reason,K.value=!e.valid,{valid:!0,reason:""}},na=s=>{v.value.lastName=s.target.value;const e=he(v.value.lastName);return te.value=e.reason,X.value=!e.valid,{valid:!0,reason:""}},ia=s=>/^(88|99|98|89)\d{7}$/.test(s.trim()),oa=s=>{v.value.phone=s.target.value,ue.value=!ia(v.value.phone)},ua=s=>{v.value.gender=s,ie.value=!s},da=s=>{$.value=s,A.value=!s,s&&ta(s)},va=s=>{O.value=s,F.value=!s,s&&la(s)},ca=s=>{i.value=s,H.value=!s},pa=s=>{be.value=s,v.value.relationship=(s==null?void 0:s.value)||"",W.value=!v.value.relationship},ma=async()=>{var s,e,w;if(!sa()){j("Please fill all required fields");return}try{const g=((s=i.value)==null?void 0:s.name)||"",_=((e=O.value)==null?void 0:e.name)||"",o=((w=$.value)==null?void 0:w.name)||"",I={given_name:v.value.firstName,family_name:v.value.lastName,gender:v.value.gender,birthdate:"",birthdate_estimated:!0,attributes:{cell_phone_number:v.value.phone}},M=await new Ea().registerGuardian(I);if(!M||!M.person_id)throw new Error("Failed to create guardian - no person ID returned");const T=M.person_id;console.log("Guardian created with ID:",T);const de={person_id:T,address1:g,address2:_,city_village:g,township_division:_,state_province:o,country:"Malawi",preferred:1,latitude:"",longitude:""};let le;try{le=await fe.createAddress(de),le||(le=await fe.postJson("person/"+T+"/address",de))}catch(ce){}const ve=oe.value.find(ce=>ce.value===v.value.relationship);ve&&await Re.createRelation(V.value.patientID,T,ve.other.relationship_type_id);const ye={id:T.toString(),firstName:v.value.firstName,lastName:v.value.lastName,phone:v.value.phone,relationship:v.value.relationship,address:{city_village:g,township_division:_,state_province:o,country:"Malawi"}};J("whenSaved",ye),ge(),Be("Guardian created successfully")}catch(g){j("Failed to complete guardian creation: ")}},Fe=async()=>{try{const s=await Re.getRelations();oe.value=s.map(e=>({label:e.b_is_to_a,value:e.b_is_to_a,other:e}))}catch(s){console.error("Failed to load relationships",s)}},fa=()=>{v.value={firstName:"",lastName:"",gender:"",phone:"",address:{},relationship:""},$.value=null,O.value=null,i.value=null,be.value=null,G.value="",ne.value=[],Y.value=[],u.value=1,K.value=!1,X.value=!1,ue.value=!1,ie.value=!1,A.value=!1,F.value=!1,H.value=!1,W.value=!1,ee.value=!1,ae.value="",te.value="",n.value=!1,z.value=null,R.value=null};return Fe(),ha(n,s=>{s?ne.value=[]:G.value&&De()}),(s,e)=>{const w=Ve("ion-buttons"),g=Ve("ion-radio"),_=Ve("ion-radio-group");return c(),N(a(ya),{"is-open":U.isOpen,onDidDismiss:ge,class:"guardian-modal"},{default:r(()=>[t(a(Pa),null,{default:r(()=>[t(a(Na),null,{default:r(()=>[t(a(wa),{class:"modal-title"},{default:r(()=>e[12]||(e[12]=[f("Search/Add Guardian")])),_:1,__:[12]}),t(w,{slot:"end"},{default:r(()=>[t(a(pe),{onClick:ge,class:"close-button"},{default:r(()=>e[13]||(e[13]=[f("Close")])),_:1,__:[13]})]),_:1})]),_:1})]),_:1}),t(a(qa),{class:"ion-padding modal-content"},{default:r(()=>[d("div",ja,[d("div",za,[t(a(L),{class:"search-item",lines:"full"},{default:r(()=>[t(a(Sa),{modelValue:G.value,"onUpdate:modelValue":e[0]||(e[0]=o=>G.value=o),placeholder:"Search Guardian",onIonInput:Ze,class:"search-input"},{default:r(()=>[t(a(Ne),{icon:a(Aa),slot:"start"},null,8,["icon"])]),_:1},8,["modelValue"]),t(a(pe),{slot:"end",fill:"clear",onClick:e[1]||(e[1]=o=>n.value=!0),title:"Create new guardian"},{default:r(()=>[t(a(Ne),{icon:a(Va)},null,8,["icon"]),t(a(Ne),{icon:a(ka)},null,8,["icon"])]),_:1})]),_:1}),G.value&&!n.value?(c(),P("div",Ha,[Q.value?(c(),P("div",Wa," Searching... ")):Y.value.length>0?(c(),P("div",Ja,[(c(!0),P(Ia,null,Ra(Qe.value,o=>{var I;return c(),P("div",{key:o.id,class:"result-item"},[d("div",{class:"result-item-content",onClick:q=>Ke(o)},[d("div",Za,[f(D(o.firstName)+" "+D(o.lastName)+" ",1),o.relationship?(c(),P("span",Ka,"("+D(o.relationship)+")",1)):h("",!0)]),o.address?(c(),P("div",Xa,D(typeof o.address=="object"?"".concat(o.address.city_village).concat(o.address.township_division?", "+o.address.township_division:"").concat(o.address.state_province?", "+o.address.state_province:""):"Address available"),1)):h("",!0)],8,Qa),((I=z.value)==null?void 0:I.id)===o.id?(c(),P("div",et,[t(a(me),{modelValue:R.value,"onUpdate:modelValue":e[2]||(e[2]=q=>R.value=q),options:oe.value,label:"label","track-by":"value",placeholder:"Select relationship*",searchable:!0,class:E({"error-state":ee.value}),onInput:e[3]||(e[3]=q=>ee.value=!1)},null,8,["modelValue","options","class"]),ee.value?(c(),N(a(y),{key:0,class:"error-label",style:{display:"block","margin-top":"5px"}},{default:r(()=>e[14]||(e[14]=[f(" Relationship is required ")])),_:1,__:[14]})):h("",!0),d("div",at,[t(a(pe),{onClick:Xe,size:"small",class:"confirm-btn"},{default:r(()=>e[15]||(e[15]=[f(" Confirm ")])),_:1,__:[15]}),e[17]||(e[17]=d("div",{class:"spacer"},null,-1)),t(a(pe),{onClick:ea,fill:"outline",size:"small",class:"cancel-btn"},{default:r(()=>e[16]||(e[16]=[f(" Cancel ")])),_:1,__:[16]})])])):h("",!0)])}),128)),d("div",tt,[d("button",{onClick:e[4]||(e[4]=o=>u.value=Math.max(1,u.value-1)),disabled:u.value===1,class:"pagination-button"}," < ",8,lt),d("span",st,"Page "+D(u.value)+" of "+D(Se.value),1),d("button",{onClick:e[5]||(e[5]=o=>u.value=Math.min(Se.value,u.value+1)),disabled:u.value===Se.value,class:"pagination-button"}," > ",8,rt)])])):(c(),P("div",nt,[d("p",null,'No guardians found matching "'+D(G.value)+'"',1)]))])):h("",!0)]),n.value?(c(),P("div",it,[t(a(ze),{class:"form-grid"},{default:r(()=>[t(a(re),{class:"form-row"},{default:r(()=>[t(a(x),{class:"form-column"},{default:r(()=>[t(Ee,{inputHeader:"First name*",inputValue:v.value.firstName,"onUpdate:inputValue":e[6]||(e[6]=o=>ra(o)),inputType:"text",error:K.value},null,8,["inputValue","error"]),K.value?(c(),N(a(y),{key:0,class:"error-label"},{default:r(()=>[ae.value==="required"?(c(),P("span",ot,"First name is required")):ae.value==="invalid_chars"?(c(),P("span",ut,"First name can only contain letters and apostrophes")):ae.value==="too_short"?(c(),P("span",dt,"First name must be at least 3 characters")):h("",!0)]),_:1})):h("",!0)]),_:1}),t(a(x),{class:"form-column"},{default:r(()=>[t(Ee,{inputHeader:"Last name*",inputValue:v.value.lastName,"onUpdate:inputValue":na,inputType:"text",required:!0,error:X.value},null,8,["inputValue","error"]),X.value?(c(),N(a(y),{key:0,class:"error-label"},{default:r(()=>[te.value==="required"?(c(),P("span",vt,"First name is required")):te.value==="invalid_chars"?(c(),P("span",ct,"First name can only contain letters and apostrophes")):te.value==="too_short"?(c(),P("span",pt,"First name must be at least 3 characters")):h("",!0)]),_:1})):h("",!0)]),_:1})]),_:1}),d("div",mt,[t(a(x),{class:"form-column"},{default:r(()=>[d("div",ft,[d("div",_t,[e[21]||(e[21]=d("label",{class:"label-title"},[f("Gender "),d("span",{class:"required"},"*")],-1)),t(_,{value:v.value.gender,onIonChange:e[7]||(e[7]=o=>ua(o.detail.value)),class:"inline-radio-group"},{default:r(()=>[t(a(L),{lines:"none",class:"inline-radio-item",style:{"--background":"white"}},{default:r(()=>[t(g,{slot:"start",value:"M",style:{"margin-right":"16px"}}),t(a(y),null,{default:r(()=>e[18]||(e[18]=[f("Male")])),_:1,__:[18]})]),_:1}),t(a(L),{lines:"none",class:"inline-radio-item",style:{"--background":"white"}},{default:r(()=>[t(g,{slot:"start",value:"F",style:{"margin-right":"16px"},class:"custom-radio"}),t(a(y),null,{default:r(()=>e[19]||(e[19]=[f("Female")])),_:1,__:[19]})]),_:1})]),_:1},8,["value"]),ie.value?(c(),N(a(y),{key:0,class:"error-label"},{default:r(()=>e[20]||(e[20]=[f(" Gender is required ")])),_:1,__:[20]})):h("",!0)])])]),_:1}),t(a(x),{class:"form-column"},{default:r(()=>[t(a(y),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:r(()=>e[22]||(e[22]=[f("District"),d("span",{class:"required"}," *",-1)])),_:1,__:[22]}),t(a(me),{modelValue:$.value,"onUpdate:modelValue":[e[8]||(e[8]=o=>$.value=o),da],options:l.value,label:"name","track-by":"district_id",placeholder:"Select district",searchable:!0,"close-on-select":!0,class:E({"error-state":A.value})},null,8,["modelValue","options","class"]),A.value?(c(),N(a(y),{key:0,class:"error-label"},{default:r(()=>e[23]||(e[23]=[f(" District is required ")])),_:1,__:[23]})):h("",!0)]),_:1})]),t(a(re),{class:"form-row"},{default:r(()=>[t(a(x),{class:"form-column"},{default:r(()=>[t(a(y),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:r(()=>e[24]||(e[24]=[f("T/A or Area"),d("span",{class:"required"}," *",-1)])),_:1,__:[24]}),t(a(me),{modelValue:O.value,"onUpdate:modelValue":[e[9]||(e[9]=o=>O.value=o),va],options:b.value,label:"name","track-by":"traditional_authority_id",placeholder:"Select traditional authority",searchable:!0,"close-on-select":!0,disabled:!$.value,class:E({"error-state":F.value})},null,8,["modelValue","options","disabled","class"]),F.value?(c(),N(a(y),{key:0,class:"error-label"},{default:r(()=>e[25]||(e[25]=[f(" Traditional Authority/Area is required ")])),_:1,__:[25]})):h("",!0)]),_:1}),t(a(x),{class:"form-column"},{default:r(()=>[t(a(y),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:r(()=>e[26]||(e[26]=[f("Village or Township"),d("span",{class:"required"}," *",-1)])),_:1,__:[26]}),t(a(me),{modelValue:i.value,"onUpdate:modelValue":[e[10]||(e[10]=o=>i.value=o),ca],options:k.value,label:"name","track-by":"village_id",placeholder:"Select village",searchable:!0,"close-on-select":!0,disabled:!O.value,class:E({"error-state":H.value}),error:H.value},null,8,["modelValue","options","disabled","class","error"]),H.value?(c(),N(a(y),{key:0,class:"error-label"},{default:r(()=>e[27]||(e[27]=[f(" Village/Township is required ")])),_:1,__:[27]})):h("",!0)]),_:1})]),_:1}),t(a(re),{class:"form-row"},{default:r(()=>[t(a(x),{class:"form-column"},{default:r(()=>[t(Ua,{inputHeader:"Phone number",inputValue:v.value.phone,"onUpdate:inputValue":oa,inputType:"tel",required:!0,class:E({"error-state":ue.value}),error:ue.value},null,8,["inputValue","class","error"]),ue.value?(c(),N(a(y),{key:0,class:"error-label"},{default:r(()=>e[28]||(e[28]=[f(" Phone must be 9 digits starting with 88, 99, 98, or 89 ")])),_:1,__:[28]})):h("",!0)]),_:1}),t(a(x),{class:"form-column"},{default:r(()=>[t(a(y),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:r(()=>e[29]||(e[29]=[f("Relationship"),d("span",{class:"required"}," *",-1)])),_:1,__:[29]}),t(a(me),{modelValue:be.value,"onUpdate:modelValue":[e[11]||(e[11]=o=>be.value=o),pa],multiple:!1,taggable:!1,"hide-selected":!0,"close-on-select":!0,openDirection:"bottom",placeholder:"Select relationship",selectLabel:"",label:"label",searchable:!0,"track-by":"value",options:oe.value,disabled:!1,class:E({"error-state":W.value}),error:W.value},null,8,["modelValue","options","class","error"]),W.value?(c(),N(a(y),{key:0,class:"error-label"},{default:r(()=>e[30]||(e[30]=[f(" Relationship is required ")])),_:1,__:[30]})):h("",!0)]),_:1})]),_:1})]),_:1})])):h("",!0),n.value?(c(),N(a(pe),{key:1,expand:"block",onClick:ma,class:"save-button"},{default:r(()=>[t(a(Ne),{icon:a(Ca),slot:"start"},null,8,["icon"]),e[31]||(e[31]=f(" Save "))]),_:1,__:[31]})):h("",!0)])]),_:1})]),_:1},8,["is-open"])}}}),gt=Je(bt,[["__scopeId","data-v-ce6b14cf"]]),ht={class:"segment-label-container"},yt={class:"segment-label-container"},Nt={class:"segment-label-container"},wt={class:"form-row"},Pt={class:"form-group segment-group"},St={class:"segment-label-container"},At={class:"arv-input-container"},Vt=["disabled"],kt=Ye({__name:"Reception",setup(U,{expose:C}){const S=new Pe,V=new Ya(S.getID(),-1,""),p=m({}),B=m(!1),J=Oa(),G=We(),{patient:ne}=qe(G),Q=m({}),n=m({isInit:!1,isLoading:!1,canSubmit:!1,hasGuardian:!1,captureArvNumber:"",sitePrefix:"",guardianPresent:"",patientPresent:"",hasArvNumber:!1,arvNumber:""}),u={guardianPresent:{label:"Guardian present",required:()=>!0,buildObs:()=>V.buildValueCoded("Guardian present",n.value.guardianPresent),validation:()=>{R("guardianPresent")&&n.value.guardianPresent==="Yes"&&!n.value.hasGuardian&&(p.value.guardianPresent="Please register a new guardian",B.value=!0)},onGuardianSelected:()=>{n.value.hasGuardian=!0,p.value.guardianPresent=""},onFormUpdate:(i,l)=>{i==="patientPresent"&&l==="No"&&n.value.guardianPresent==="No"&&(n.value.guardianPresent="Yes",p.value.guardianPresent=""),i==="guardianPresent"&&l==="Yes"&&!n.value.hasGuardian&&(B.value=!0)}},patientPresent:{label:"Patient present",required:()=>!0,buildObs:()=>V.buildValueCoded("Patient present",n.value.patientPresent),onFormUpdate:(i,l)=>{i==="guardianPresent"&&l==="No"&&n.value.patientPresent==="No"&&(n.value.patientPresent="Yes",p.value.patientPresent="")},validation:()=>R("patientPresent")},hasGuardian:{init:async()=>S.getGuardian().then(i=>{n.value.hasGuardian=i.length>0})},hasArvNumber:{init:async()=>{var l,b,k;n.value.hasArvNumber=!1;const i=await Pe.findByID(ne.value.patientID);if(n.value.hasArvNumber=(l=i.patient_identifiers)==null?void 0:l.some(A=>A.type.name==="ARV Number"&&/\w+-ARV-\d+/i.test("".concat(A.identifier))),!n.value.hasArvNumber){const A=await He.getNextSuggestedARVNumber();n.value.arvNumber=(k=(b="".concat(A.arv_number).split(/\s/))==null?void 0:b[1])!=null?k:A.arv_number.replace(/^\D+|\s/g,""),await J.loadSitePrefix(),n.value.sitePrefix=J.globalPropertyStore.sitePrefix||"_ERROR_"}}},captureArvNumber:{label:"Capture ART number?",required:()=>!n.value.hasArvNumber,validation:()=>R("captureArvNumber")},arvNumber:{label:"ART Number",required:()=>n.value.captureArvNumber==="Yes",formatArvNumber:()=>{const i=n.value.arvNumber.replace(/^.*-/,"");return"".concat(n.value.sitePrefix,"-ARV-").concat(i)},onFormUpdate:(i,l)=>{i==="captureArvNumber"&&l==="No"&&(p.value.arvNumber="")},onSubmit:async()=>{if(p.value.arvNumber="",!u.arvNumber.required())return!0;try{return await V.createArvNumber(u.arvNumber.formatArvNumber())?(n.value.hasArvNumber=!0,!0):(p.value.arvNumber="Unable to save ARV number",!1)}catch(i){return p.value.arvNumber="Error saving arv Number",!1}},validation:()=>{if(R("arvNumber")){if(!/^\d+$/.test(n.value.arvNumber)){p.value.arvNumber="Only numbers are allowed";return}if(parseInt(n.value.arvNumber)<=0){p.value.arvNumber="Number must be positive";return}const i=u.arvNumber.required();n.value.isLoading=!0,n.value.canSubmit=!1,Ba.arvNumberExists(u.arvNumber.formatArvNumber()).then(l=>{if(l&&i){p.value.arvNumber="ARV number already exists";return}p.value.arvNumber=""}).catch(()=>{if(p.value.arvNumber="",i){p.value.arvNumber="Error verifying ARV number";return}}).finally(()=>{n.value.canSubmit=!0,n.value.isLoading=!1})}}}};async function Y(){n.value.isLoading=!0,n.value.canSubmit=!1,await Promise.all(Object.keys(u).filter(i=>typeof u[i].init=="function").map(i=>u[i].init())),n.value.isLoading=!1,n.value.isInit=!0,n.value.canSubmit=!0}function Z(i){p.value[i]="",typeof u[i].validation=="function"&&u[i].validation()}function _e(){return Object.keys(u).reduce((i,l)=>{if(l in u&&typeof u[l].required=="function"&&u[l].required()&&typeof u[l].buildObs=="function"){const b=u[l].buildObs();return Array.isArray(b)?[...i,...b]:[...i,b]}return i},[])}function R(i){return p.value[i]="",(typeof u[i].required=="function"?u[i].required():!1)?n.value[i]?!0:(p.value[i]="".concat(u[i].label," is required"),!1):"".concat(n.value[i]).length>0}function z(){const i=Object.keys(u).filter(l=>!Q.value[l]&&typeof u[l].onSubmit=="function").map(l=>u[l].onSubmit&&u[l].onSubmit().then(()=>{Q.value[l]=!0}));return Promise.all(i)}function v(i,l){Z(i),Object.keys(u).forEach(b=>{var k;return((k=u[b])==null?void 0:k.onFormUpdate)&&u[b].onFormUpdate(i,l)})}function $(){return Object.keys(u).forEach(i=>Z(i)),Object.keys(p.value).some(i=>"".concat(p.value[i]).length>=1)}async function O(){if(!n.value.isInit||!n.value.canSubmit)return j("Please wait for all data to load before submitting"),!1;if($())return j("Please review form for errors"),!1;if(await z(),$())return j("Please review form for errors"),!1;try{return await V.createEncounter(),await V.saveObservationList(await Promise.all(_e())),!0}catch(i){return console.error(i),Ma("unable to save reception data"),!1}}return je(()=>Y()),C({onSubmit:O}),(i,l)=>(c(),N(a(Fa),null,{default:r(()=>[n.value.isLoading?(c(),N(a(xa),{key:0,type:"indeterminate"})):h("",!0),t(a(Da),null,{default:r(()=>[t(a(ze),null,{default:r(()=>[t(a(re),null,{default:r(()=>[t(a(x),{size:"12"},{default:r(()=>[d("div",ht,[l[9]||(l[9]=d("label",{class:"label-title"},[f("Patient present? "),d("span",{class:"required"},"*")],-1)),p.value.patientPresent?(c(),N(a(we),{key:0,class:"error-label"},{default:r(()=>[f(D(p.value.patientPresent),1)]),_:1})):h("",!0)]),t(a(ke),{disabled:!n.value.isInit,modelValue:n.value.patientPresent,"onUpdate:modelValue":l[0]||(l[0]=b=>n.value.patientPresent=b),onIonChange:l[1]||(l[1]=b=>v("patientPresent",b.detail.value))},{default:r(()=>[t(a(L),{lines:"none"},{default:r(()=>[t(a(se),{value:"Yes"}),t(a(y),null,{default:r(()=>l[10]||(l[10]=[f("Yes")])),_:1,__:[10]})]),_:1}),t(a(L),{lines:"none"},{default:r(()=>[t(a(se),{value:"No"}),t(a(y),null,{default:r(()=>l[11]||(l[11]=[f("No")])),_:1,__:[11]})]),_:1})]),_:1},8,["disabled","modelValue"])]),_:1}),t(a(x),{size:"12"},{default:r(()=>[d("div",yt,[l[12]||(l[12]=d("label",{class:"label-title"},[f("Guardian present? "),d("span",{class:"required"},"*")],-1)),p.value.guardianPresent?(c(),N(a(we),{key:0,class:"error-label"},{default:r(()=>[f(D(p.value.guardianPresent),1)]),_:1})):h("",!0)]),t(a(ke),{disabled:!n.value.isInit,modelValue:n.value.guardianPresent,"onUpdate:modelValue":l[2]||(l[2]=b=>n.value.guardianPresent=b),onIonChange:l[3]||(l[3]=b=>v("guardianPresent",b.detail.value))},{default:r(()=>[t(a(L),{lines:"none"},{default:r(()=>[t(a(se),{value:"Yes"}),t(a(y),null,{default:r(()=>l[13]||(l[13]=[f("Yes")])),_:1,__:[13]})]),_:1}),t(a(L),{lines:"none"},{default:r(()=>[t(a(se),{value:"No"}),t(a(y),null,{default:r(()=>l[14]||(l[14]=[f("No")])),_:1,__:[14]})]),_:1})]),_:1},8,["disabled","modelValue"])]),_:1})]),_:1}),u.captureArvNumber.required()?(c(),N(a(re),{key:0},{default:r(()=>[t(a(x),null,{default:r(()=>[d("div",Nt,[l[15]||(l[15]=d("label",{class:"label-title"},[f("Capture ART number? "),d("span",{class:"required"},"*")],-1)),p.value.captureArvNumber?(c(),N(a(we),{key:0,class:"error-label"},{default:r(()=>[f(D(p.value.captureArvNumber),1)]),_:1})):h("",!0)]),t(a(ke),{disabled:!n.value.isInit,modelValue:n.value.captureArvNumber,"onUpdate:modelValue":l[4]||(l[4]=b=>n.value.captureArvNumber=b),onIonChange:l[5]||(l[5]=b=>v("captureArvNumber",b.detail.value))},{default:r(()=>[t(a(L),{lines:"none"},{default:r(()=>[t(a(se),{value:"Yes"}),t(a(y),null,{default:r(()=>l[16]||(l[16]=[f("Yes")])),_:1,__:[16]})]),_:1}),t(a(L),{lines:"none"},{default:r(()=>[t(a(se),{value:"No"}),t(a(y),null,{default:r(()=>l[17]||(l[17]=[f("No")])),_:1,__:[17]})]),_:1})]),_:1},8,["disabled","modelValue"])]),_:1})]),_:1})):h("",!0),u.arvNumber.required()?(c(),N(a(re),{key:1},{default:r(()=>[t(a(x),null,{default:r(()=>{var b,k,A;return[d("div",wt,[d("div",Pt,[d("div",St,[l[18]||(l[18]=d("label",{class:"label-title"},[f("ART Number "),d("span",{class:"required"},"*")],-1)),p.value.arvNumber?(c(),N(a(we),{key:0,class:"error-label"},{default:r(()=>[f(D(p.value.arvNumber),1)]),_:1})):h("",!0)]),d("div",At,[d("div",{class:E(["input-group",{"input-group-error":(b=p.value.arvNumber)!=null?b:!1}])},[Ga(d("input",{disabled:!n.value.isInit,type:"text",class:E(["form-control",{"has-error":(k=p.value.arvNumber)!=null?k:!1}]),"onUpdate:modelValue":l[6]||(l[6]=F=>n.value.arvNumber=F),onInput:l[7]||(l[7]=F=>v("arvNumber",F.target.value)),required:""},null,42,Vt),[[$a,n.value.arvNumber]]),d("span",{class:E(["input-group-text",{"has-error":(A=p.value.arvNumber)!=null?A:!1}])},D(n.value.sitePrefix)+"-ARV ",3)],2)])])])]}),_:1})]),_:1})):h("",!0)]),_:1})]),_:1}),t(gt,{isOpen:B.value,patientID:a(ne).patientID,onClose:l[8]||(l[8]=b=>B.value=!1),onGuardianSelected:u.guardianPresent.onGuardianSelected,onWhenSaved:u.guardianPresent.onGuardianSelected},null,8,["isOpen","patientID","onGuardianSelected","onWhenSaved"])]),_:1}))}}),Ft=Je(kt,[["__scopeId","data-v-2b388e8e"]]);export{Ft as default};
