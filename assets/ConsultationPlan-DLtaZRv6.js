import{d as Ae,ak as ke,co as xe,r,c as Re,aT as d,w as l,a as Te,N as q,f as K,J as B,l as u,u as y,a8 as Pe,k as f,m as Ie,i as h,bC as Ne,v as D,ae as Be,b7 as C}from"./vendor-f_p5GZUu.js";import{aA as Q,u as Ve,aB as $e,aC as Fe,aD as Me,c as ze,aE as He,f as Ee,Y as Le,d as We,T as je,J as Ge,M as Je,H as V,aF as k,aG as Ue,aH as Ye,N as X,t as qe,o as Ke,aI as x,aJ as Qe,$ as Xe,S as Ze}from"./index-CVNxzv7S.js";import{D as Oe}from"./DemographicBar-BKu5KGX8.js";import{u as $,D as et,C as tt,T as at}from"./TreatmentPlan-Bm84v6HY.js";import{u as st,I as nt,N as ot,M as it,s as rt,c as lt,a as ct}from"./NextAppointment-DHVduii9.js";import{_ as ut}from"./RiskAssessment.vue_vue_type_script_setup_true_lang-CznKQ8bS.js";import{_ as mt}from"./Vitals.vue_vue_type_script_setup_true_lang-Co5sWpoa.js";import{u as ft,_ as vt}from"./useFormWizard-DErzL4DS.js";import{l as gt}from"./lodash-NJiRuGo9.js";import{a as Z,b as dt}from"./formatServerData-C6m7jkbL.js";import{C as pt}from"./Registration-C7d4PwcM.js";import{u as St}from"./usePatientProfile-CI_fc0Uu.js";import"./apexcharts-Db13O_GS.js";import"./DashBox-BaTBupNi.js";import"./BasicForm-RsiGXZOX.js";import"./DateInputField-DxMa70zu.js";import"./previousDiagnosis-DIDtH6hu.js";import"./group_validation-CkAJFu8p.js";import"./drug_service-vHv-BPw9.js";import"./lab_order-vBu6-U6A.js";import"./drug_prescription_service-CD2Ij6Wv.js";import"./ncd_appointment_service-ErQrqFG5.js";import"./useLocation-Cof8Ojv6.js";import"./useExposeFromStandardForm-CV7Fgag-.js";import"./vaccines_service-DNrWzU0M.js";import"./sms_service-Bp6iW3XA.js";import"./EIRreportsStore-DefHbVI2.js";import"./Export-CC1SbWBa.js";import"./Outcome-9yl_-UD9.js";const ht={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Dt={class:"back_profile"},Xt=Ae({__name:"ConsultationPlan",setup(bt,{expose:O}){const{onTabBeforeChange:ee,onChangeCurrentTab:te,currentTabIndex:v}=ft("Consultation Plan"),{printVisitSummary:ae}=St(),R=ke(),se=xe();r([]),r([]),r(!1);const T=r(!0),P=r(!1),S=r(!1),F=Re(()=>({text:S.value?"Saving...":"Finish",icon:S.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:P.value||S.value})),ne=Q(),oe=Ve(),ie=$e(),re=Fe();Me();const le=st(),_=ze();He();const ce=Ee(),ue=$(),me=Le(),{patient:o}=d(oe),{vitals:fe}=d(ne),{investigations:ve}=d(ie),{diagnosis:ge}=d(re),{substance:de}=d(ce),{selectedNCDMedicationList:M}=d(le),{FootScreening:pe,visualScreening:Se,cvScreening:he}=d(ue),{sessionDate:z}=d(me),{apiStatus:Ct}=d(We());l(F,(e,t)=>{console.log("Done button options changed:",{from:t,to:e,currentStep:v.value,tabsLength:n.value.length}),e.disabled!==(t==null?void 0:t.disabled)&&console.log("Done button ".concat(e.disabled?"disabled":"enabled")),e.text!==(t==null?void 0:t.text)&&console.log('Done button text changed from "'.concat(t==null?void 0:t.text,'" to "').concat(e.text,'"'))},{deep:!0}),l(S,(e,t)=>{e!==t&&(console.log("Saving state changed: ".concat(t," -> ").concat(e)),console.log(e?"Starting save process...":"Save process completed"))});const De=e=>{console.log("Done button change received from wizard:",e),e.newOptions.disabled&&console.log("Done button has been disabled"),e.isLastStep&&console.log("User is on the last step, done button should be visible")},w=()=>{let e=!1;return p(),S.value&&(e=!0),P.value=e,!e},be=()=>{R.push("patientProfile")},I=()=>_.NCDActivities.map(e=>({title:e,icon:""})),n=r(I()),H=r(null),E=r(null),L=r(null),W=r(null),j=r(null),G=r(null),J=r(null),p=()=>{var a;if(!n.value||n.value.length===0)return console.log("Tabs not yet initialized"),null;const e=v.value>=0&&v.value<n.value.length?v.value:0;switch((a=n.value[e])==null?void 0:a.title){case"Vital Signs":return"Vitals";case"Risk Assessment":return"RiskAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"DiagnosisComponent";case"Complications Screening":return"ComplicationsScreening";case"Treatment Plan":return"TreatmentPlan";case"Next Appointment":return"NextAppointment";default:if(_.NCDActivities.length>0)switch(_.NCDActivities[0]){case"Vital Signs":return"Vitals";case"Risk Assessment":return"RiskAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"DiagnosisComponent";case"Complications Screening":return"ComplicationsScreening";case"Treatment Plan":return"TreatmentPlan";case"Next Appointment":return"NextAppointment"}return null}},N=()=>{T.value=!1,setTimeout(()=>{v.value=0,T.value=!0},0)},U=()=>{const e=Q();e.setVitals(e.getInitialVitals(o.value.ID))},g=async()=>{var a,m;const e=Je(z.value,"sessionDate","value")||V.sessionDate(),t=k("vitals");for(let s=0;s<n.value.length;s++){const c=n.value[s];if(c.title==="Vital Signs")n.value[s].icon=A(e,t)?C:"";else if(c.title==="Risk Assessment"){const i=k("substanceAbuse");n.value[s].icon=A(e,i)?C:""}else if(c.title==="Investigations"){const i=(m=(a=o==null?void 0:o.value)==null?void 0:a.labOrders)==null?void 0:m.saved,b=i==null?void 0:i.filter(we=>V.toStandardHisFormat(e)===V.toStandardHisFormat(we.order_date));n.value[s].icon=(b==null?void 0:b.length)>0?C:""}else if(c.title==="Diagnosis"){const i=k("diagnosis");n.value[s].icon=A(e,i)?C:""}else if(c.title==="Complications Screening"){const i=k("screening");n.value[s].icon=A(e,i)?C:""}else c.title==="Treatment Plan"&&(M.value.length>0?n.value[s].icon=it()?C:"":n.value[s].icon="")}w()},A=(e,t)=>{const a=new Date(e);return a.setHours(0,0,0,0),t.some(m=>{const s=new Date(m.obs_datetime);return s.setHours(0,0,0,0),s.getTime()===a.getTime()})},Ce=async()=>{var s,c,i,b;const e=[],t=await Z(Se.value),a=await dt(pe.value),m=await Z(he.value);t.length>0&&e.push({concept_id:await x.getConceptID("Visual acuity",!0),value_text:"visual acuity test",obs_datetime:x.getSessionDate(),child:t}),a.length>0&&e.push({concept_id:await x.getConceptID("Foot check",!0),value_text:"foot screening",obs_datetime:x.getSessionDate(),child:a}),m.length>0&&e.push(...m),e.length>0&&((b=(i=(c=(s=o.value).screening)!=null?c:s.screening={}).unsaved)!=null||(i.unsaved=[]),o.value.screening.unsaved.push(...e),X("Complications saved successfully"))},ye=async()=>{const e=Qe();if(!gt.isEmpty(e.selectedMedicalAllergiesList)){const m=Xe(),s=e.selectedMedicalAllergiesList.map(i=>({concept_id:985,obs_datetime:Ze.getSessionDate(),location_id:m.facilityLocation.code,value_text:i.name})),c=await rt(s);o.value=Object.assign(o.value,c),console.log("Allergies staged successfully:",o.value),e.clearSelectedMedicalAllergiesList()}const t=await lt();o.value=Object.assign(o.value,t);const a=await ct().saveNonPharmaTherapyPatientData();o.value=Object.assign(o.value,a)},Y=async()=>{S.value=!0;try{const e=[{ref:H,name:"Vitals"},{ref:E,name:"Risk Assessment"},{ref:L,name:"Investigations"},{ref:W,name:"Diagnosis"},{ref:j,name:"Complications Screening"},{ref:G,name:"Treatment Plan"},{ref:J,name:"Next Appointment"}];for(const t of e)if(t.ref.value&&typeof t.ref.value.onSubmit=="function")try{await t.ref.value.onSubmit()}catch(a){throw console.error("Error calling ".concat(t.name," onSubmit:"),a),a}else console.log("".concat(t.name," component ref not available or no onSubmit method"));await ye(),await Ce(),await Ue(),await Ye(o.value),await _e(),X("Data saved successfully!"),R.push("patientProfile")}catch(e){console.error("Error saving data:",e),qe("Error occurred while saving data. Please try again.")}finally{S.value=!1}},_e=async()=>{await Ke(pt,{class:"small-confirm-modal "})!=="dismiss"&&await ae()};return Te(async()=>{if(_.NCDActivities.length===0){R.push("patientProfile");return}$().resetScreening(),n.value=I(),await g(),(v.value===void 0||v.value<0)&&(v.value=0,console.log("Setting initial tab index to 0")),P.value=!1,w()}),l(v,async()=>{await w()}),l(fe,async()=>{await g()},{deep:!0}),l(o,async()=>{$().resetScreening(),await g()},{deep:!0}),l(z,async()=>{await g()},{deep:!0}),l(ve,async()=>{await g()},{deep:!0}),l(ge,async()=>{await g()},{deep:!0}),l(de,async()=>{await g()},{deep:!0}),l(M,async()=>{await g()},{deep:!0}),l(se,async e=>{N(),U(),n.value=I()},{deep:!0}),l(o,async(e,t)=>{e.ID!=t.ID&&(N(),U())},{deep:!0}),O({saveData:Y,markWizard:g,refreshWizard:N,validateDoneButtonState:w}),(e,t)=>(K(),q(y(Be),null,{default:B(()=>[u(je),u(y(Pe),{fullscreen:!0},{default:B(()=>[u(Oe),f("div",ht,[T.value?(K(),q(vt,{key:0,ref:"wizard","vertical-tabs":"","navigable-tabs":"","scrollable-tabs":"",startIndex:0,doneButton:F.value,"custom-tabs":n.value,beforeChange:y(ee),onChange:y(te),"onComplete:wizard":t[1]||(t[1]=a=>Y()),onDoneButtonChanged:De},{default:B(()=>[f("div",null,[f("div",Dt,[u(Ge,{name:"Back to profile",iconSlot:"start",fill:"clear",icon:y(Ne),"font-weight":"600",onClick:t[0]||(t[0]=a=>be())},null,8,["icon"])])]),h(f("div",null,[u(mt,{ref_key:"vitalsRef",ref:H},null,512)],512),[[D,p()=="Vitals"]]),h(f("div",null,[u(ut,{ref_key:"riskAssessmentRef",ref:E},null,512)],512),[[D,p()=="RiskAssessment"]]),h(f("div",null,[u(nt,{ref_key:"investigationsRef",ref:L},null,512)],512),[[D,p()=="Investigations"]]),h(f("div",null,[u(et,{ref_key:"diagnosisRef",ref:W},null,512)],512),[[D,p()=="DiagnosisComponent"]]),h(f("div",null,[u(tt,{ref_key:"complicationsRef",ref:j},null,512)],512),[[D,p()=="ComplicationsScreening"]]),h(f("div",null,[u(at,{ref_key:"treatmentPlanRef",ref:G},null,512)],512),[[D,p()=="TreatmentPlan"]]),h(f("div",null,[u(ot,{ref_key:"nextAppointmentRef",ref:J},null,512)],512),[[D,p()=="NextAppointment"]])]),_:1},8,["doneButton","custom-tabs","beforeChange","onChange"])):Ie("",!0)])]),_:1})]),_:1}))}});export{Xt as default};
