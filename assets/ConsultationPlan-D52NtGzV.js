import{d as Ae,aO as Pe,ct as Re,r,c as Te,aV as d,w as c,a as xe,O as j,f as G,J as B,l as m,u as k,a4 as Ne,k as f,m as Ie,i as h,bF as Be,v as D,a7 as Ve,b9 as C}from"./vendor-Cfm9Q6_F.js";import{aF as U,u as Fe,aG as Me,aH as $e,aI as ze,aJ as He,c as Le,aK as Ee,f as We,$ as je,d as Ge,T as Ue,M as Je,V as Ke,H as V,aL as A,aM as Qe,aN as J,aO as qe,t as K,n as Xe,aP as P,K as Ye,aQ as Ze,a1 as Oe,S as et}from"./index-ChmNLWl1.js";import{D as tt}from"./DemographicBar-DFAUmoiu.js";import{u as F,D as at,C as st,T as nt}from"./TreatmentPlan-DZKOEz8Z.js";import{I as it,N as ot,s as rt,c as lt,u as ct}from"./NextAppointment-Bs7LcTBw.js";import{_ as ut}from"./RiskAssessment.vue_vue_type_script_setup_true_lang-DHSWgvwV.js";import{_ as mt}from"./Vitals.vue_vue_type_script_setup_true_lang-DLH5L7RK.js";import{u as vt,_ as ft}from"./useFormWizard-XTxT0wpM.js";import{l as gt}from"./lodash-NJiRuGo9.js";import{a as Q,b as dt}from"./formatServerData-BZHAMnC7.js";import{C as pt}from"./Registration-CSSPnkJJ.js";import{u as St}from"./usePatientProfile-Yqua2qJ9.js";import"./apexcharts-BqOIhlys.js";import"./DashBox-CzCm2Y-Z.js";import"./BasicForm-Dn8fR8YZ.js";import"./DateInputField-DtSwr3Qn.js";import"./previousDiagnosis-BU7RZYD9.js";import"./group_validation-C2Sg5YpF.js";import"./lab_order-C-UhJpRB.js";import"./drug_prescription_service-BBh-8Gyl.js";import"./ncd_appointment_service-5NUjKNkv.js";import"./useLocation-Dj7yknFm.js";import"./useExposeFromStandardForm-C_V-yimd.js";import"./vaccines_service-RkcI3Caa.js";import"./sms_service-Diln5wwJ.js";import"./EIRreportsStore-Cb-9rT5c.js";import"./Export-CR2WCeN6.js";import"./Outcome-CBa02UOj.js";const ht={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Dt={class:"back_profile"},Xt=Ae({__name:"ConsultationPlan",setup(bt,{expose:q}){const{onTabBeforeChange:X,currentTabIndex:v}=vt("Consultation Plan"),{printVisitSummary:Y}=St(),R=Pe(),Z=Re();r([]),r([]),r(!1);const T=r(!0),x=r(!1),p=r(!1),M=Te(()=>({text:p.value?"Saving...":"Finish",icon:p.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:x.value||p.value})),O=U(),ee=Fe(),te=Me(),ae=$e();ze();const se=He(),y=Le();Ee();const ne=We(),ie=F(),oe=je(),{patient:n}=d(ee),{vitals:re}=d(O),{investigations:le}=d(te),{diagnosis:ce}=d(ae),{substance:ue}=d(ne),{selectedNCDMedicationList:$}=d(se),{FootScreening:me,visualScreening:ve,cvScreening:fe}=d(ie),{sessionDate:z}=d(oe),{apiStatus:Ct}=d(Ge());c(M,(e,t)=>{console.log("Done button options changed:",{from:t,to:e,currentStep:v.value,tabsLength:i.value.length}),e.disabled!==(t==null?void 0:t.disabled)&&console.log("Done button ".concat(e.disabled?"disabled":"enabled")),e.text!==(t==null?void 0:t.text)&&console.log('Done button text changed from "'.concat(t==null?void 0:t.text,'" to "').concat(e.text,'"'))},{deep:!0}),c(p,(e,t)=>{e!==t&&(console.log("Saving state changed: ".concat(t," -> ").concat(e)),console.log(e?"Starting save process...":"Save process completed"))});const ge=e=>{console.log("Done button change received from wizard:",e),e.newOptions.disabled&&console.log("Done button has been disabled"),e.isLastStep&&console.log("User is on the last step, done button should be visible")},_=()=>{let e=!1;return S(),p.value&&(e=!0),x.value=e,!e},de=()=>{R.push("patientProfile")},N=()=>y.NCDActivities.map(e=>({title:e,icon:""})),i=r(N()),H=r(null),L=r(null),pe=r(null),Se=r(null),he=r(null),De=r(null),be=r(null),S=()=>{var a;if(!i.value||i.value.length===0)return console.log("Tabs not yet initialized"),null;const e=v.value>=0&&v.value<i.value.length?v.value:0;switch((a=i.value[e])==null?void 0:a.title){case"Vital Signs":return"Vitals";case"Risk Assessment":return"RiskAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"DiagnosisComponent";case"Complications Screening":return"ComplicationsScreening";case"Treatment Plan":return"TreatmentPlan";case"Next Appointment":return"NextAppointment";default:if(y.NCDActivities.length>0)switch(y.NCDActivities[0]){case"Vital Signs":return"Vitals";case"Risk Assessment":return"RiskAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"DiagnosisComponent";case"Complications Screening":return"ComplicationsScreening";case"Treatment Plan":return"TreatmentPlan";case"Next Appointment":return"NextAppointment"}return null}},I=()=>{T.value=!1,setTimeout(()=>{v.value=0,T.value=!0},0)},E=()=>{const e=U();e.setVitals(e.getInitialVitals(n.value.ID))},g=async()=>{var a,l;const e=Ke(z.value,"sessionDate","value")||V.sessionDate(),t=A("vitals");for(let s=0;s<i.value.length;s++){const u=i.value[s];if(u.title==="Vital Signs")i.value[s].icon=w(e,t)?C:"";else if(u.title==="Risk Assessment"){const o=A("substanceAbuse");i.value[s].icon=w(e,o)?C:""}else if(u.title==="Investigations"){const o=(l=(a=n==null?void 0:n.value)==null?void 0:a.labOrders)==null?void 0:l.saved,b=o==null?void 0:o.filter(ke=>V.toStandardHisFormat(e)===V.toStandardHisFormat(ke.order_date));i.value[s].icon=(b==null?void 0:b.length)>0?C:""}else if(u.title==="Diagnosis"){const o=A("diagnosis");i.value[s].icon=w(e,o)?C:""}else if(u.title==="Complications Screening"){const o=A("screening");i.value[s].icon=w(e,o)?C:""}else u.title==="Treatment Plan"&&($.value.length>0?i.value[s].icon=Qe()?C:"":i.value[s].icon="")}_()},w=(e,t)=>{const a=new Date(e);return a.setHours(0,0,0,0),t.some(l=>{const s=new Date(l.obs_datetime);return s.setHours(0,0,0,0),s.getTime()===a.getTime()})},Ce=async()=>{var s,u,o,b;const e=[],t=await Q(ve.value),a=await dt(me.value),l=await Q(fe.value);t.length>0&&e.push({concept_id:await P.getConceptID("Visual acuity",!0),value_text:"visual acuity test",obs_datetime:P.getSessionDate(),child:t}),a.length>0&&e.push({concept_id:await P.getConceptID("Foot check",!0),value_text:"foot screening",obs_datetime:P.getSessionDate(),child:a}),l.length>0&&e.push(...l),e.length>0?((b=(o=(u=(s=n.value).screening)!=null?u:s.screening={}).unsaved)!=null||(o.unsaved=[]),n.value.screening.unsaved.push(...e),Ye("Complications saved successfully")):K("No complications data to save")},ye=async()=>{const e=Ze();if(!gt.isEmpty(e.selectedMedicalAllergiesList)){const l=Oe(),s=e.selectedMedicalAllergiesList.map(o=>({concept_id:o.concept_id,obs_datetime:et.getSessionDate(),value_coded:o.concept_id,location_id:l.facilityLocation.code,value_text:o.name})),u=await rt(s);n.value=Object.assign(n.value,u),console.log("Allergies staged successfully:",n.value),e.clearSelectedMedicalAllergiesList()}const t=await lt();n.value=Object.assign(n.value,t);const a=await ct().saveNonPharmaTherapyPatientData();n.value=Object.assign(n.value,a)},_e=async(e,t)=>{var a,l;e%1===0&&(v.value=e),t==0&&((a=H.value)==null||a.onSubmit()),t==1&&((l=L.value)==null||l.onSubmit()),t==4&&await Ce(),t==5&&await ye(),await J(n.value)},W=async()=>{p.value=!0;try{await qe(),await J(n.value),await we(),R.push("patientProfile")}catch(e){console.error("Error saving data:",e),K("Error occurred while saving data. Please try again.")}finally{p.value=!1}},we=async()=>{await Xe(pt,{class:"small-confirm-modal "})!=="dismiss"&&await Y()};return xe(async()=>{if(y.NCDActivities.length===0){R.push("patientProfile");return}F().resetScreening(),i.value=N(),await g(),(v.value===void 0||v.value<0)&&(v.value=0,console.log("Setting initial tab index to 0")),x.value=!1,p.value=!1,_()}),c(v,async()=>{await _()}),c(re,async()=>{await g()},{deep:!0}),c(n,async()=>{F().resetScreening(),await g()},{deep:!0}),c(z,async()=>{await g()},{deep:!0}),c(le,async()=>{await g()},{deep:!0}),c(ce,async()=>{await g()},{deep:!0}),c(ue,async()=>{await g()},{deep:!0}),c($,async()=>{await g()},{deep:!0}),c(Z,async e=>{I(),E(),i.value=N()},{deep:!0}),c(n,async(e,t)=>{e.ID!=t.ID&&(I(),E())},{deep:!0}),q({saveData:W,markWizard:g,refreshWizard:I,validateDoneButtonState:_}),(e,t)=>(G(),j(k(Ve),null,{default:B(()=>[m(Ue),m(k(Ne),{fullscreen:!0},{default:B(()=>[m(tt),f("div",ht,[T.value?(G(),j(ft,{key:0,ref:"wizard","vertical-tabs":"","navigable-tabs":"","scrollable-tabs":"",startIndex:0,doneButton:M.value,"custom-tabs":i.value,beforeChange:k(X),onChange:_e,"onComplete:wizard":t[1]||(t[1]=a=>W()),onDoneButtonChanged:ge},{default:B(()=>[f("div",null,[f("div",Dt,[m(Je,{name:"Back to profile",iconSlot:"start",fill:"clear",icon:k(Be),"font-weight":"600",onClick:t[0]||(t[0]=a=>de())},null,8,["icon"])])]),h(f("div",null,[m(mt,{ref_key:"vitalsRef",ref:H},null,512)],512),[[D,S()=="Vitals"]]),h(f("div",null,[m(ut,{ref_key:"riskAssessmentRef",ref:L},null,512)],512),[[D,S()=="RiskAssessment"]]),h(f("div",null,[m(it,{ref_key:"investigationsRef",ref:pe},null,512)],512),[[D,S()=="Investigations"]]),h(f("div",null,[m(at,{ref_key:"diagnosisRef",ref:Se},null,512)],512),[[D,S()=="DiagnosisComponent"]]),h(f("div",null,[m(st,{ref_key:"complicationsRef",ref:he},null,512)],512),[[D,S()=="ComplicationsScreening"]]),h(f("div",null,[m(nt,{ref_key:"treatmentPlanRef",ref:De},null,512)],512),[[D,S()=="TreatmentPlan"]]),h(f("div",null,[m(ot,{ref_key:"nextAppointmentRef",ref:be},null,512)],512),[[D,S()=="NextAppointment"]])]),_:1},8,["doneButton","custom-tabs","beforeChange"])):Ie("",!0)])]),_:1})]),_:1}))}});export{Xt as default};
