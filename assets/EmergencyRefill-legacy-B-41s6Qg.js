System.register(["./vendor-legacy-LYGlphH7.js","./index-legacy-DyLcPBG8.js","./SelectFacility-legacy-BVc83KoD.js","./app_encounter_service-legacy-rBOrUG19.js","./adherence_service-legacy-DlzauGkc.js","./LocationFieldOptions-legacy-CytohPn6.js","./lodash-legacy-pOOc9Efu.js"],function(e,t){"use strict";var a,l,n,i,r,d,o,u,s,c,f,m,_,g,p,v,y,b,h,x,A,D,w,O,q,V,$,j,I,k,P,F,E,S,H;return{setters:[e=>{a=e.d,l=e.c_,n=e.r,i=e.a,r=e.y,d=e.f,o=e.z,u=e.l,s=e.u,c=e.aY,f=e.k,m=e.a$,_=e.bm,g=e.aa,p=e.ab,v=e.D,y=e.A,b=e.B,h=e.e,x=e.F,A=e.L,D=e.G,w=e.a3,O=e.O},e=>{q=e.P,V=e.a8,$=e.t,j=e.l,I=e.j,k=e.af,P=e._},e=>{F=e.S},e=>{E=e.A},e=>{S=e.A},e=>{H=e.g},null],execute:function(){var t=document.createElement("style");t.textContent=".section-header ion-label[data-v-2988fbce]{font-size:1rem;font-weight:600;letter-spacing:.5px;color:var(--ion-color-primary);text-transform:uppercase}.drug-item[data-v-2988fbce]{border:1px solid #eee;border-radius:8px;margin-bottom:10px;padding:10px}.error[data-v-2988fbce]{color:red;font-weight:700;font-style:italic}\n/*$vite$:1*/",document.head.appendChild(t);const U={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},z={class:"error"},L={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},N={class:"error"},Y={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},C={class:"error"},M={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},B={class:"error"};e("default",P(a({__name:"EmergencyRefill",setup(e,{expose:t}){const a=new q,P=new E(a.getID(),25,-1,""),G=new S(a.getID(),P.providerID),R=l({date_of_emergency_refill:"",facility:"",drugs:[],next_appointment:"",selectedFacilityObj:null}),Q=n({}),T=n([]),W={date_of_emergency_refill:{required:()=>!0,dataHandler:e=>{R.date_of_emergency_refill=e},validation:async()=>{var e;if(!R.date_of_emergency_refill)return void(Q.value.date_of_emergency_refill="Date is required");if(O(R.date_of_emergency_refill).isAfter(O()))return void(Q.value.date_of_emergency_refill="Date cannot be in the future");const t=null===(e=G.getLastDrugs())||void 0===e||null===(e=e[0])||void 0===e||null===(e=e.order)||void 0===e?void 0:e.start_date;t&&O(R.date_of_emergency_refill).isBefore(t)&&await k(`Date entered is less than last known dispensation of ${O(t).format("DD-MMM-YYYY")}`)},buildObs:()=>P.buildValueDate("Prescription refill date",R.date_of_emergency_refill)},facility:{required:()=>!0,dataHandler:e=>{R.facility=e.name},searchFacilities:e=>H(e).then(e=>T.value=e),validation:()=>{R.facility||(Q.value.facility="Facility is required")},buildObs:()=>P.buildValueText("Health facility name",R.facility)},drugs:{required:()=>!0,dataHandler:e=>{"remainingAmount"===e.field?R.drugs[e.index].other.remainingAmount=e.value:"givenAmount"===e.field&&(R.drugs[e.index].other.givenAmount=e.value)},validation:()=>{R.drugs.some(e=>!e.other.remainingAmount||!e.other.givenAmount)&&(Q.value.drugs="Please enter both remaining and given amounts for all drugs")},buildObs:()=>R.drugs.map(async e=>{const t=G.calculateAdherence(e.other.drug.quantity,e.other.remainingAmount,function(e){const t=e=>`${e}`.match(/qod/i)?"QOD":`${e}`.match(/weekly/i)?"QW":e;return G.calculateExpected(e.quantity,e.equivalent_daily_dose,e.order.start_date,t(e.frequency))}(e.other.drug));return{...await G.buildValueCoded("Medications dispensed",e.value),child:[await G.buildPillCountObs(e.other.drug.order_id,e.other.remainingAmount),await G.buildAdherenceObs(e.other.drug.order_id,e.other.drug.drug_id,t,R.date_of_emergency_refill),await G.buildValueNumber("Amount of drug dispensed",e.other.givenAmount)]}})},next_appointment:{required:()=>!0,dataHandler:e=>{R.next_appointment=e},validation:()=>{R.next_appointment?R.date_of_emergency_refill&&O(R.next_appointment).isBefore(R.date_of_emergency_refill)&&(Q.value.next_appointment="Next appointment date must be after emergency refill date"):Q.value.next_appointment="Next appointment date is required"},buildObs:()=>P.buildValueDate("Appointment date",R.next_appointment)}};function J(e,t){e in W&&"function"==typeof W[e].dataHandler&&W[e].dataHandler(t),K(e)}function K(e){Q.value[e]="","function"!=typeof W[e].required||!W[e].required()||R[e]?R[e]&&"function"==typeof W[e].validation&&W[e].validation():Q.value[e]="This field is required"}return i(async()=>{await async function(){await G.loadPreviousDrugs(),R.drugs=G.getLastDrugs().map(e=>({label:e.drug.name,value:e.drug.concept_id,other:{givenAmount:"",remainingAmount:"",drug:e}}))}()}),t({onSubmit:async function(){if(Object.keys(W).forEach(e=>K(e)),Object.keys(Q.value).some(e=>`${Q.value[e]}`.length>=1))return $("Please review form for errors");try{if(!(await P.createEncounter()))return j("Failed to create encounter");const e=await Promise.all(Object.keys(R).reduce((e,t)=>{if(t in W&&R[t]&&"function"==typeof W[t].buildObs){const a=W[t].buildObs();return Array.isArray(a)?[...e,...a]:[...e,a]}return e},[]));await P.saveObservationList(e),I("Emergency refill saved successfully")}catch(e){console.error("Error saving emergency refill data:",e),j("Failed to save emergency refill data")}}}),(e,t)=>{var a;return(null!==(a=R.drugs)&&void 0!==a?a:[]).length<=0?(d(),r(s(m),{key:0,style:{height:"40vh"}},{default:o(()=>[u(s(c),null,{default:o(()=>t[3]||(t[3]=[f("h1",{class:"ion-text-center",style:{"margin-top":"15%"}}," No previous dispensations found. ",-1)])),_:1,__:[3]})]),_:1})):(d(),r(s(m),{key:1},{default:o(()=>[u(s(c),null,{default:o(()=>[f("div",U,[u(s(_),null,{default:o(()=>[u(s(g),null,{default:o(()=>[u(s(p),null,{default:o(()=>[u(s(v),null,{default:o(()=>t[4]||(t[4]=[y("Date of emergency refill")])),_:1,__:[4]}),u(V,{place_holder:"Select date",onDateUpDated:t[0]||(t[0]=e=>J("date_of_emergency_refill",`${e.value.year}-${e.value.month}-${e.value.day}`)),date_prop:""}),f("div",z,b(Q.value.date_of_emergency_refill),1)]),_:1})]),_:1})]),_:1})]),f("div",L,[u(s(_),null,{default:o(()=>[u(s(g),null,{default:o(()=>[u(s(p),null,{default:o(()=>[u(s(v),null,{default:o(()=>t[5]||(t[5]=[y("Facility")])),_:1,__:[5]}),u(F,{show_error:!1,selected_district_ids:[],selected_location:null,onFacilitySelected:t[1]||(t[1]=e=>{J("facility",e.selected_location)})}),f("div",N,b(Q.value.facility),1)]),_:1})]),_:1})]),_:1})]),f("div",Y,[u(s(v),null,{default:o(()=>t[6]||(t[6]=[y("Emergency Supply Drugs")])),_:1,__:[6]}),(d(!0),h(x,null,A(R.drugs,(e,t)=>(d(),h("div",{key:t,class:"drug-item"},[u(s(_),null,{default:o(()=>[u(s(g),null,{default:o(()=>[u(s(p),{size:"12"},{default:o(()=>[u(s(D),{lines:"none"},{default:o(()=>[u(s(v),null,{default:o(()=>[y(b(e.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),u(s(g),null,{default:o(()=>[u(s(p),{size:"6"},{default:o(()=>[u(s(w),{modelValue:e.other.remainingAmount,"onUpdate:modelValue":t=>e.other.remainingAmount=t,onIonInput:e=>J("drugs",{index:t,field:"remainingAmount",value:e.detail.value}),placeholder:"Pills Remaining",label:"Pills Remaining","label-placement":"stacked",type:"number",fill:"outline"},null,8,["modelValue","onUpdate:modelValue","onIonInput"])]),_:2},1024),u(s(p),{size:"6"},{default:o(()=>[u(s(w),{modelValue:e.other.givenAmount,"onUpdate:modelValue":t=>e.other.givenAmount=t,onIonInput:e=>J("drugs",{index:t,field:"givenAmount",value:e.detail.value}),placeholder:"Pills Given",label:"Pills Given","label-placement":"stacked",type:"number",fill:"outline"},null,8,["modelValue","onUpdate:modelValue","onIonInput"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128)),f("div",C,b(Q.value.drugs),1)]),f("div",M,[u(s(_),null,{default:o(()=>[u(s(g),null,{default:o(()=>[u(s(p),null,{default:o(()=>[u(s(v),null,{default:o(()=>t[7]||(t[7]=[y("Next Appointment Date")])),_:1,__:[7]}),u(V,{place_holder:"Select next appointment date",onDateUpDated:t[2]||(t[2]=e=>J("next_appointment",`${e.value.year}-${e.value.month}-${e.value.day}`)),date_prop:""}),f("div",B,b(Q.value.next_appointment),1)]),_:1})]),_:1})]),_:1})])]),_:1})]),_:1}))}}}),[["__scopeId","data-v-2988fbce"]]))}}});
