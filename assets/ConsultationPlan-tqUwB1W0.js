import{d as Le,ar as Be,cl as Ee,r as i,a$ as p,a as Fe,w as m,y as Q,f as L,z as B,l,e as Me,m as j,k as v,u as P,bM as ze,d5 as He,ah as We,i as D,bG as Ue,v as h,an as Ve,dI as $e,bg as y}from"./vendor-D2vbv48U.js";import{u as Ge,_ as Ye}from"./useFormWizard-DshqvwBA.js";import{u as Je,aA as Qe,aO as je,a1 as qe,c as Ke,aC as Xe,M as Ze,a2 as et,aP as tt,aQ as at,T as st,D as nt,t as E,y as w,m as I,a9 as ot,E as it,H as F,aD as S,ay as q,aR as K,S as lt,k as X,_ as rt}from"./index-De0affBd.js";import{D as ct}from"./DemographicBar-CBSL0P1o.js";import{C as ut,O as mt,a as vt,b as pt}from"./OPDOutcome-DKTu8o8b.js";import{I as dt,N as ft,T as Z,s as gt,a as Dt,d as ht,b as yt}from"./NextAppointment-CBsBqkhS.js";import{O as Pt}from"./OPDPrintingModal-B81p0-lN.js";import{l as M}from"./lodash-Dt8AsbQm.js";import{u as wt}from"./usePatientProfile-CP0PdQJy.js";import{S as ee}from"./Outcome-BonEVmjk.js";import"./apexcharts-D3NY3X_Q.js";import"./patient_complaints_service-B-nMPt3I.js";import"./DashBox-DmdfjoAM.js";import"./useExposeFromStandardForm-DTCBagmg.js";import"./BasicForm-CakgIojd.js";import"./DateInputField-DWcD-_PE.js";import"./formatServerData-B-pAbQ7v.js";import"./drug_prescription_service-CY2DA_da.js";import"./drug_service-CPoRWu87.js";import"./lab_order-CAsUDamg.js";import"./group_validation-BrPOUAhi.js";import"./ncd_appointment_service-lJyScnAN.js";import"./Registration-fqTWch2Z.js";import"./useLocation-0XTka3yy.js";import"./vaccines_service-DlcQwmBJ.js";import"./sms_service-DgthF0LA.js";import"./EIRreportsStore-DUpXUN2w.js";import"./Export-BkO1eBFP.js";const St={key:0,class:"spinner-overlay"},bt={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},It={class:"back_profile"},Ot=Le({__name:"ConsultationPlan",setup(At){const{currentTabIndex:d}=Ge("Consultation Plan"),{printVisitSummary:te}=wt(),f=Be(),ae=Ee(),O=i(!1),A=i(!0),z=i(!1),_=i(!1),T=i(!0),se=i(!1),C=i(!1),ne=i(!1),oe=Je(),ie=Qe(),le=je(),re=qe(),ce=Ke(),H=Xe(),W=Ze(),ue=et(),me=tt(),ve=at(),{patient:r}=p(oe),{investigations:pe}=p(ie),{OPDdiagnosis:de}=p(le),{selectedMedicalDrugsList:fe,nonPharmalogicalTherapyAndOtherNotes:U,selectedMedicalAllergiesList:N}=p(re),{OPDActivities:b}=p(ce),{outcomes:ge}=p(H),{currentSelectedNextAppointmentDate:De}=p(me),{presentingComplaints:he}=p(ve),{vitals:ye}=p(ue),V=i(null),Pe=i(null),$=i(null),we=i(null),Se=i(null),be=i(null),x=i(null),G=()=>b.value.map(e=>({title:e,icon:""})),o=i(G()),Ie=i({}),Oe=async(e,t,s)=>{if(t===0&&await Ce(),!await Y()){E("Please add presenting complaints before proceeding.");return}await c(),e%1===0&&(d.value=e),x.value&&s&&x.value.changeTab(e)},g=()=>{var s;if(!o.value||o.value.length===0)return null;const e=d.value>=0&&d.value<o.value.length?d.value:0;switch((s=o.value[e])==null?void 0:s.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(b.value.length>0)switch(b.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Ae=()=>{f.push("home")},_e=async()=>{_.value=!0,w("Printing consultation summary... Please wait.");try{await te(),w("Consultation summary printed successfully!"),setTimeout(()=>{f.push("home")},3500)}catch(e){I("Failed to print consultation summary.")}finally{_.value=!1}},Te=()=>{w("Patient has finished consultation!"),f.push("home")},Y=async()=>{const e=await ot.getObsByEncounterIdAndDate(it.PRESENTING_COMPLAINTS);return!!(e&&e.length>0)},c=async()=>{var t,s;const e=F.sessionDate();for(let a=0;a<o.value.length;a++)if(!await Y())A.value=!1,o.value[a].title!=="Clinical Assessment"&&(o.value[a].icon=$e);else{A.value=!0,z.value=!1;const u=o.value[a];if(Ie.value={title:"Untitled"},u.title==="Clinical Assessment"){const n=S("presentingComplaints");o.value[a].icon=k(e,n)?y:""}else if(u.title==="Investigations"){const n=(s=(t=r.value)==null?void 0:t.labOrders)==null?void 0:s.saved,R=n==null?void 0:n.filter(Re=>F.toStandardHisFormat(e)===F.toStandardHisFormat(Re.order_date));o.value[a].icon=(R==null?void 0:R.length)>0?y:""}else if(u.title==="Diagnosis"){const n=S("diagnosis");o.value[a].icon=k(e,n)?y:""}else if(u.title==="Treatment Plan"){const n=S("treatment");o.value[a].icon=(n==null?void 0:n.length)>0?y:""}else if(u.title==="Next Appointment"){const n=S("appointments");o.value[a].icon=k(e,n)?y:""}else if(u.title==="Outcome"){const n=S("outcomes");o.value[a].icon=(n==null?void 0:n.length)>0?y:""}}},k=(e,t)=>{if(!t)return!1;const s=new Date(e);return s.setHours(0,0,0,0),t.some(a=>{const u=new Date(a.obs_datetime||a.order_date);return u.setHours(0,0,0,0),u.getTime()===s.getTime()})},Ce=async()=>{var e;O.value=!0;try{await Promise.all([(e=V.value)==null?void 0:e.onSubmit(),Ne()]),await q(r.value),K()}catch(t){throw console.error("Error saving clinical assessment:",t),I("Failed to save clinical assessment"),t}finally{O.value=!1}},Ne=async()=>{try{const e=localStorage.getItem("userID"),t=r.value.patientID;if(!M.isEmpty(N.value)){const s=J();await new Z().onSubmitAllergies(t,e,s),await gt(s)}}catch(e){console.error("Failed to save allergies:",e),E("Failed to save allergies")}},xe=async()=>{try{const e=localStorage.getItem("userID"),t=r.value.patientID,s=new Z;if(!M.isEmpty(N.value)){const a=J();await s.onSubmitAllergies(t,e,a)}if(!M.isEmpty(U.value)){const a=[{concept_id:2688,obs_datetime:localStorage.getItem("sessionDate"),value_text:U.value,location_id:W.facilityLocation.code}];await Dt(a)}await ht(),await yt().saveNonPharmaTherapyPatientData()}catch(e){console.error("Failed to save treatment plan:",e),E("Failed to save treatment plan")}},J=()=>N.value.map(e=>({concept_id:985,obs_datetime:lt.getSessionDate(),value_coded:e.concept_id,location_id:W.facilityLocation.code})),ke=async()=>{var e;try{(e=$.value)==null||e.onSubmit(),await xe(),await H.saveOutcomPatientData(),await K(),await q(r.value);const t=localStorage.getItem("locationID"),s=localStorage.getItem("userRoles");if(!t){I("Location ID could not be found. Please check your settings.");return}(s?JSON.parse(s):[]).some(n=>n.role==="Lab")?(await ee.movePatientToNextStage(r.value.patientID,"LAB","CONSULTATION",t,r.value.visitID||r.value.visit_id),await X().refresh(t),await f.push("home"),w("Lab results submitted. Patient can return to consultation")):(await ee.movePatientToNextStage(r.value.patientID,"CONSULTATION","DISPENSATION",t,r.value.visitID||r.value.visit_id),await X().refresh(t),await f.push("home"),w("Consultation patient saved successfully."))}catch(t){console.error("Error saving consultation data:",t),I("Failed to save consultation data")}};return Fe(async()=>{if(b.value.length===0){await f.push("home");return}o.value=G(),await c(),(d.value===void 0||d.value<0)&&(d.value=0)}),m(ye,async()=>{await c()},{deep:!0}),m(r,async()=>{await c()},{deep:!0}),m(pe,async()=>{await c()},{deep:!0}),m(de,async()=>{await c()},{deep:!0}),m(fe,async()=>{await c()},{deep:!0}),m(ge,async()=>{await c()},{deep:!0}),m(De,async()=>{await c()}),m(he,async()=>{await c()},{deep:!0}),m(ae,async()=>{T.value=!1,setTimeout(()=>{d.value=0,T.value=!0},0)},{deep:!0}),m(ne,e=>{C.value=e,C.value&&setTimeout(()=>{C.value=!1},15e3)}),(e,t)=>(L(),Q(P(Ve),null,{default:B(()=>[l(Pt,{onYes:_e,onNo:Te,isOpen:se.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),O.value?(L(),Me("div",St,[l(P(ze),{name:"bubbles"}),t[2]||(t[2]=v("div",{class:"loading-text"},"Please wait...",-1))])):j("",!0),l(P(He),{"is-open":_.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(st),l(P(We),{fullscreen:!0},{default:B(()=>[l(ct),v("div",bt,[T.value?(L(),Q(Ye,{key:0,ref_key:"wizard",ref:x,"vertical-tabs":"","navigable-tabs":A.value,"scrollable-tabs":"",startIndex:0,doneButton:{text:"Finish",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},nextButton:{disabled:z.value},"custom-tabs":o.value,tabs:o.value,onChange:Oe,"onComplete:wizard":t[1]||(t[1]=s=>ke())},{default:B(()=>[v("div",null,[v("div",It,[l(nt,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:P(Ue),"font-weight":"600",onClick:t[0]||(t[0]=s=>Ae())},null,8,["icon"])])]),D(v("div",null,[l(ut,{ref_key:"clinicalAssessmentRef",ref:V},null,512)],512),[[h,g()==="ClinicalAssessment"]]),D(v("div",null,[l(dt,{ref_key:"investigationsRef",ref:Pe},null,512)],512),[[h,g()==="Investigations"]]),D(v("div",null,[l(mt,{ref_key:"diagnosisRef",ref:$},null,512)],512),[[h,g()==="OPDDiagnosis"]]),D(v("div",null,[l(vt,{ref_key:"treatmentPlanRef",ref:we},null,512)],512),[[h,g()==="OPDTreatmentPlan"]]),D(v("div",null,[l(ft,{ref_key:"nextAppointmentRef",ref:Se},null,512)],512),[[h,g()==="NextAppointment"]]),D(v("div",null,[l(pt,{ref_key:"outcomeRef",ref:be},null,512)],512),[[h,g()==="Outcome"]])]),_:1},8,["navigable-tabs","nextButton","custom-tabs","tabs"])):j("",!0)])]),_:1})]),_:1}))}}),ta=rt(Ot,[["__scopeId","data-v-fb36e59a"]]);export{ta as default};
