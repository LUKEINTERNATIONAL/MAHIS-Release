import{d as ke,ar as Re,cp as Le,r as n,b2 as p,c as Be,a as Fe,w as m,y as $,f as R,z as L,l as r,e as Ee,m as j,k as v,u as y,bQ as ze,dd as We,ah as He,i as h,bJ as Me,v as D,an as Ue,dO as Ve,bg as P}from"./vendor-DL4WTsfb.js";import{u as Ge,_ as $e}from"./useFormWizard-6cYdolX7.js";import{u as je,aD as Je,aU as Ke,a8 as Xe,c as Ye,aF as qe,X as Qe,a9 as Ze,aV as et,aW as tt,aK as at,T as st,F as nt,t as B,K as b,q as O,ag as ot,E as it,H as F,aG as w,aI as J,aX as K,S as lt,o as X,_ as rt}from"./index-DjbhwxKm.js";import{D as ct}from"./DemographicBar-pbjVU6Vu.js";import{C as ut,O as mt,a as vt,b as pt}from"./OPDOutcome-6cGNgmUA.js";import{I as dt,N as ft,s as gt,b as ht,a as Dt}from"./NextAppointment-Cu9a5-Kn.js";import{O as Pt}from"./OPDPrintingModal-dAfFrFDk.js";import{l as yt}from"./lodash-Dt8AsbQm.js";import{u as bt}from"./usePatientProfile-DnCG5FUv.js";import{S as Y}from"./stages-CXCKfb-j.js";import"./apexcharts-a8xXIU8b.js";import"./patient_complaints_service-BRgDEJoo.js";import"./DashBox-ClFuiTxM.js";import"./useExposeFromStandardForm-BsKKp0ZQ.js";import"./BasicForm-CMlpXm6J.js";import"./DateInputField-CXGl0lQj.js";import"./formatServerData-D-3s9rQK.js";import"./drug_prescription_service-Cr-sgyyk.js";import"./drug_service-DZlHL1vm.js";import"./Outcome-D1_Ri2pW.js";import"./lab_order-BaQBEHQC.js";import"./group_validation-rEWcpaVk.js";import"./ncd_appointment_service-DTuR8jMr.js";import"./Registration-OZ55GDtF.js";import"./useLocation-BqRokJ70.js";import"./vaccines_service-D7vhUZSV.js";import"./sms_service-Did_L7Mm.js";import"./EIRreportsStore-BDcZ7Wfn.js";import"./Export-DpU5N5LQ.js";const wt={key:0,class:"spinner-overlay"},St={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Ot={class:"back_profile"},At=ke({__name:"ConsultationPlan",setup(Tt){const{currentTabIndex:d}=Ge("Consultation Plan"),{printVisitSummary:q}=bt(),f=Re(),Q=Le(),A=n(!1),T=n(!0),E=n(!1),_=n(!1),I=n(!0),Z=n(!1),C=n(!1),ee=n(!1),z=je(),te=Je(),ae=Ke(),se=Xe(),ne=Ye(),W=qe(),oe=Qe(),ie=Ze(),le=et(),re=tt(),{patient:l}=p(z),{investigations:ce}=p(te),{OPDdiagnosis:ue}=p(ae),{selectedMedicalDrugsList:me,nonPharmalogicalTherapyAndOtherNotes:_t}=p(se),{OPDActivities:S}=p(ne),{outcomes:ve}=p(W),{currentSelectedNextAppointmentDate:pe}=p(le),{presentingComplaints:de}=p(re),{vitals:fe}=p(ie),ge=at(),H=Be(()=>ge.selectedMedicalAllergiesList),M=n(null),he=n(null),U=n(null),De=n(null),Pe=n(null),ye=n(null),N=n(null),V=()=>S.value.map(e=>({title:e,icon:""})),s=n(),be=n({}),we=async(e,t,i)=>{if(t===0&&await Te(),!await G()){B("Please add presenting complaints before proceeding.");return}await c(),e%1===0&&(d.value=e),N.value&&i&&N.value.changeTab(e)},g=()=>{var i;if(!s.value||s.value.length===0)return null;const e=d.value>=0&&d.value<s.value.length?d.value:0;switch((i=s.value[e])==null?void 0:i.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(S.value.length>0)switch(S.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Se=()=>{f.push("home")},Oe=async()=>{_.value=!0,b("Printing consultation summary... Please wait.");try{await q(),b("Consultation summary printed successfully!"),setTimeout(()=>{f.push("home")},3500)}catch(e){O("Failed to print consultation summary.")}finally{_.value=!1}},Ae=()=>{b("Patient has finished consultation!"),f.push("home")},G=async()=>{const e=await ot.getObsByEncounterIdAndDate(it.PRESENTING_COMPLAINTS);return!!(e&&e.length>0)},c=async()=>{var t,i;const e=F.sessionDate();for(let o=0;o<s.value.length;o++)if(!await G())T.value=!1,s.value[o].title!=="Clinical Assessment"&&(s.value[o].icon=Ve);else{T.value=!0,E.value=!1;const u=s.value[o];if(be.value={title:"Untitled"},u.title==="Clinical Assessment"){const a=w("presentingComplaints");s.value[o].icon=x(e,a)?P:""}else if(u.title==="Investigations"){const a=(i=(t=l.value)==null?void 0:t.labOrders)==null?void 0:i.saved,k=a==null?void 0:a.filter(xe=>F.toStandardHisFormat(e)===F.toStandardHisFormat(xe.order_date));s.value[o].icon=(k==null?void 0:k.length)>0?P:""}else if(u.title==="Diagnosis"){const a=w("diagnosis");s.value[o].icon=x(e,a)?P:""}else if(u.title==="Treatment Plan"){const a=w("treatment");s.value[o].icon=(a==null?void 0:a.length)>0?P:""}else if(u.title==="Next Appointment"){const a=w("appointments");s.value[o].icon=x(e,a)?P:""}else if(u.title==="Outcome"){const a=w("outcomes");s.value[o].icon=(a==null?void 0:a.length)>0?P:""}}},x=(e,t)=>{if(!t)return!1;const i=new Date(e);return i.setHours(0,0,0,0),t.some(o=>{const u=new Date(o.obs_datetime||o.order_date);return u.setHours(0,0,0,0),u.getTime()===i.getTime()})},Te=async()=>{var e;A.value=!0;try{await _e(),await Promise.all([(e=M.value)==null?void 0:e.onSubmit()]),await J(l.value),K()}catch(t){throw console.error("Error saving clinical assessment:",t),O("Failed to save clinical assessment"),t}finally{A.value=!1}},_e=async()=>{try{if(!yt.isEmpty(H.value)){const e=Ce(),t=await gt(e);z.setPatientRecord(t)}}catch(e){console.error("Failed to save allergies:",e),B("Failed to save allergies")}},Ie=async()=>{try{const e=await ht();l.value=Object.assign(l.value,e);const t=await Dt().saveNonPharmaTherapyPatientData();l.value=Object.assign(l.value,t)}catch(e){console.error("Failed to save treatment plan:",e),B("Failed to save treatment plan")}},Ce=()=>H.value.map(e=>({concept_id:985,obs_datetime:lt.getSessionDate(),location_id:oe.facilityLocation.code,value_text:e.name})),Ne=async()=>{var e;try{(e=U.value)==null||e.onSubmit(),await Ie(),await W.saveOutcomPatientData(),await K(),await J(l.value);const t=localStorage.getItem("locationID"),i=localStorage.getItem("userRoles");if(!t){O("Location ID could not be found. Please check your settings.");return}(i?JSON.parse(i):[]).some(a=>a.role==="Lab")?(await Y.movePatientToNextStage(l.value.patientID,"LAB","CONSULTATION",t,l.value.visitID||l.value.visit_id),await X().refresh(t),await f.push("home"),b("Lab results submitted. Patient can return to consultation")):(await Y.movePatientToNextStage(l.value.patientID,"CONSULTATION","DISPENSATION",t,l.value.visitID||l.value.visit_id),await X().refresh(t),await f.push("home"),b("Consultation patient saved successfully."))}catch(t){console.error("Error saving consultation data:",t),O("Failed to save consultation data")}};return Fe(async()=>{if(S.value.length===0){await f.push("home");return}s.value=V(),await c(),(d.value===void 0||d.value<0)&&(d.value=0)}),m(fe,async()=>{await c()},{deep:!0}),m(l,async()=>{await c()},{deep:!0}),m(ce,async()=>{await c()},{deep:!0}),m(ue,async()=>{await c()},{deep:!0}),m(me,async()=>{await c()},{deep:!0}),m(ve,async()=>{await c()},{deep:!0}),m(pe,async()=>{await c()}),m(de,async()=>{await c()},{deep:!0}),m(Q,async()=>{I.value=!1,s.value=V(),setTimeout(()=>{d.value=0,I.value=!0},0)},{deep:!0}),m(ee,e=>{C.value=e,C.value&&setTimeout(()=>{C.value=!1},15e3)}),(e,t)=>(R(),$(y(Ue),null,{default:L(()=>[r(Pt,{onYes:Oe,onNo:Ae,isOpen:Z.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),A.value?(R(),Ee("div",wt,[r(y(ze),{name:"bubbles"}),t[2]||(t[2]=v("div",{class:"loading-text"},"Please wait...",-1))])):j("",!0),r(y(We),{"is-open":_.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),r(st),r(y(He),{fullscreen:!0},{default:L(()=>[r(ct),v("div",St,[I.value?(R(),$($e,{key:0,ref_key:"wizard",ref:N,"vertical-tabs":"","navigable-tabs":T.value,"scrollable-tabs":"",startIndex:0,doneButton:{text:"Finish",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},nextButton:{disabled:E.value},"custom-tabs":s.value,tabs:s.value,onChange:we,"onComplete:wizard":t[1]||(t[1]=i=>Ne())},{default:L(()=>[v("div",null,[v("div",Ot,[r(nt,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:y(Me),"font-weight":"600",onClick:t[0]||(t[0]=i=>Se())},null,8,["icon"])])]),h(v("div",null,[r(ut,{ref_key:"clinicalAssessmentRef",ref:M},null,512)],512),[[D,g()==="ClinicalAssessment"]]),h(v("div",null,[r(dt,{ref_key:"investigationsRef",ref:he},null,512)],512),[[D,g()==="Investigations"]]),h(v("div",null,[r(mt,{ref_key:"diagnosisRef",ref:U},null,512)],512),[[D,g()==="OPDDiagnosis"]]),h(v("div",null,[r(vt,{ref_key:"treatmentPlanRef",ref:De},null,512)],512),[[D,g()==="OPDTreatmentPlan"]]),h(v("div",null,[r(ft,{ref_key:"nextAppointmentRef",ref:Pe},null,512)],512),[[D,g()==="NextAppointment"]]),h(v("div",null,[r(pt,{ref_key:"outcomeRef",ref:ye},null,512)],512),[[D,g()==="Outcome"]])]),_:1},8,["navigable-tabs","nextButton","custom-tabs","tabs"])):j("",!0)])]),_:1})]),_:1}))}}),sa=rt(At,[["__scopeId","data-v-b47a5092"]]);export{sa as default};
