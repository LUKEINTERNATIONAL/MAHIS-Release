var C=Object.defineProperty;var w=(g,o,e)=>o in g?C(g,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[o]=e;var _=(g,o,e)=>w(g,typeof o!="symbol"?o+"":o,e);import{d as P,r as A,a as M,y as h,f as p,z as u,l as d,u as i,ad as B,e as v,bq as E,ac as I,ab as m,A as y,F as V,L as H,k as b,B as q,ar as O,m as N,aa as z,I as F,aR as G,ag as R}from"./vendor-DowD5zKn.js";import{A as D}from"./app_encounter_service-BtCPTlWa.js";import{S as T,a5 as S,P as U,t as J,m as L,_ as Y}from"./index-Cd6xOYoL.js";import{l as $}from"./lodash-Dt8AsbQm.js";class K extends T{constructor(){super()}static async fetchAvailableDrugStock(o){const e=await this.getJson("pharmacy/items",{drug_id:o});if(!$.isEmpty(e))return e.map(a=>({quantity:a.current_quantity,packSize:a.pack_size}))}}const k={11:[30],21:[25],22:[60],24:[30,60,90,100],30:[90],39:[60],73:[120],74:[60],76:[1e3],297:[30,60,90],576:[30,60,90],613:[60],731:[60],732:[60],733:[60],734:[30],735:[30],736:[60],738:[60],931:[12,30,60],932:[30],954:[60],963:[30,60,90],968:[60],969:[30],971:[30,60,90],976:[60],977:[30],982:[30],983:[30,90],1039:[30,60,90],1043:[60],1044:[30],1056:[24],1216:[3,6,8,12]};class Q extends D{constructor(e,a){super(e,54,a);_(this,"drugHistory");_(this,"currentDrugOrder");_(this,"useDrugManagement");this.drugHistory=[],this.currentDrugOrder=[],this.useDrugManagement=!1}setIsDrugManagementEnabled(e){this.useDrugManagement=e}async loadDrugManagementEnabled(){this.useDrugManagement=!1}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}buildDispensations(e,a,r){const c=[];for(let l=0;l<r;l++)c.push({drug_order_id:e,date:this.date,quantity:a/r});return c}saveDispensations(e){return D.postJson("/dispensations",{dispensations:e,program_id:D.getProgramID()})}async voidOrder(e){return D.void("/dispensations/".concat(e),{})}async loadDrugHistory(){try{this.drugHistory=await S.getDrugOrderHistory(this.patientID)||[]}catch(e){console.warn(e)}}async loadCurrentDrugOrder(){if(this.currentDrugOrder=await S.getDrugOrders(this.patientID)||[],!!this.useDrugManagement)for(const e of this.currentDrugOrder){const a=await K.fetchAvailableDrugStock(e.drug.drug_id);e.stocks=this.groupByPackSize(a)}}groupByPackSize(e){const a=new Map;return e==null||e.forEach(({packSize:r,quantity:c})=>{var l,t;r&&(a.has(r)?a.set(r,{packSize:r,quantity:c+((t=(l=a.get(r))==null?void 0:l.quantity)!=null?t:0)}):a.set(r,{quantity:c,packSize:r}))}),Array.from(a.values())}getDrugPackSizes(e){return e in k?k[e]:[30,60,90]}calcCompletePack(e,a){var l;const r=((l=e.barcodes)!=null?l:[]).sort((t,s)=>t.tabs-s.tabs);if(r.length==0||a==0)return a;for(const t in r){const{tabs:s}=r[t];if(parseInt(s)>=a)return s}return parseInt(r[r.length-1].tabs)}}const W={key:0},Z={key:1},j={style:{"margin-top":"10%"},class:"ion-text-center"},X=P({__name:"ArtDispensation",setup(g,{expose:o}){const e=A([]),a=new U,r=new Q(a.getID(),-1);M(()=>{r.loadCurrentDrugOrder().then(()=>{e.value=r.getCurrentOrder().map(t=>{var s;return{name:t.drug.name,quantity:t.quantity,drug_id:t.drug.drug_id,order_id:t.order.order_id,amount_needed:(()=>{const n=parseFloat(t.amount_needed)-(t.quantity||0);return n<=0?0:r.calcCompletePack(t.order,n)})(),pack_sizes:r.getDrugPackSizes(t.drug.drug_id),disabled:((s=t.quantity)!=null?s:0)>0}})})});function c(t){if(!t.quantity)return"";const s=parseInt("".concat(t.quantity)),n=t.amount_needed,f=s/n*100;if(f>110)return"You are dispensing over 110% of prescribed amount";if(f<100)return"You are dispensing less than 100% of prescribed amount"}async function l(){const t=e.value.filter(n=>n.quantity>=1&&!n.disabled).map(n=>r.buildDispensations(n.order_id,parseInt(n.quantity),1));return t.length<=0?(J("Please enter one or more drug quantities"),!1):(await Promise.all(t.map(n=>r.saveDispensations(n)))).every(Boolean)?!0:(L("An error has occured"),!1)}return o({onSubmit:l}),(t,s)=>(p(),h(i(R),{style:{width:"90%",margin:"0px auto","min-height":"40vh"}},{default:u(()=>[d(i(B),null,{default:u(()=>[e.value.length?(p(),v("div",W,[d(i(E),null,{default:u(()=>[d(i(I),{style:{"font-weight":"bold"}},{default:u(()=>[d(i(m),null,{default:u(()=>s[0]||(s[0]=[y("Medication")])),_:1,__:[0]}),d(i(m),{class:"ion-text-center"},{default:u(()=>s[1]||(s[1]=[y("Amount needed")])),_:1,__:[1]}),d(i(m),null,{default:u(()=>s[2]||(s[2]=[y("Quantity")])),_:1,__:[2]})]),_:1}),(p(!0),v(V,null,H(e.value,(n,f)=>(p(),h(i(I),{key:f},{default:u(()=>[d(i(m),null,{default:u(()=>[b("h3",null,q(n.name),1)]),_:2},1024),d(i(m),{class:"ion-text-center"},{default:u(()=>[d(i(O),{fill:"solid",readonly:"",value:n.amount_needed},null,8,["value"])]),_:2},1024),d(i(m),null,{default:u(()=>[d(i(O),{disabled:n.disabled,modelValue:n.quantity,"onUpdate:modelValue":x=>n.quantity=x,type:"number",fill:"outline"},null,8,["disabled","modelValue","onUpdate:modelValue"]),!n.disabled&&c(n)?(p(),h(i(z),{key:0,style:{color:"red"}},{default:u(()=>[y(q(c(n)),1)]),_:2},1024)):N("",!0)]),_:2},1024)]),_:2},1024))),128))]),_:1})])):(p(),v("div",Z,[b("div",j,[d(i(F),{style:{"font-size":"5rem!important"},icon:i(G)},null,8,["icon"]),s[3]||(s[3]=b("h1",null,"No Dispensations needed at the moment",-1))])]))]),_:1})]),_:1}))}}),se=Y(X,[["__scopeId","data-v-438ac855"]]);export{se as default};
