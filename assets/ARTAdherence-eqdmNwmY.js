import{R as ee,d as F,W as J,e as g,f,k as C,F as k,L as T,B as Q,p as H,I as te,aw as oe,ax as se,ar as ne,D as ae,G as re,M as ce,J as ie,ad as le,ae as de,af as ue,ag as pe,ao as he,au as me,b1 as ge,r as O,a as fe,dU as _e,ck as ye,E as v,l as m,z as b,A as N}from"./vendor-IHO26Iap.js";import{_ as Y,u as be,J as Ce,P as ve,S as Ae,m as z,k as Ie}from"./index-tZ4yxjbt.js";import{A as we}from"./adherence_service-BYcYW22d.js";import{l as B}from"./lodash-Dt8AsbQm.js";import"./app_encounter_service-BlDqlCwD.js";const De=ee("ARTAdherence",{state:()=>({lastVisitDate:"",daysElapsed:40,medications:[],agreeWithCalculation:!0}),actions:{processMedicationData(e){const u=e.getLastDrugs().map(n=>{const d=n.drug.name,p=n.barcodes.reduce((A,w)=>A+w.tabs,0),a=0,o=n.frequency||"",h=o.includes("ONCE A DAY")?"1 OOD":o,{expected:i,actual:_,dosesMissed:I,dosesConsumed:E,adherenceStatus:R}=this.calculateAdherence({tabsGiven:p,remaining:a,daysElapsed:this.daysElapsed,frequency:o});return{name:d,remaining:a,tabsGiven:p,tabsPer:h,expected:i,actual:_,dosesMissed:I,dosesConsumed:E,adherenceStatus:R,orderId:n.order.order_id,drugId:n.drug.drug_id,drug:n}});this.medications=u,this.lastVisitDate=e.getReceiptDate()},updateMedicationRemaining(e,t){e>=0&&e<this.medications.length&&(this.medications[e].remaining=t)},updateExpected(e,t){e>=0&&e<this.medications.length&&(this.medications[e].expected=t)},updateActual(e,t){e>=0&&e<this.medications.length&&(this.medications[e].actual=t)},setAgreeWithCalculation(e){this.agreeWithCalculation=e},calculateAdherence({tabsGiven:e,remaining:t,daysElapsed:u,frequency:n}){const d=/once a day/i.test(n)?1:/twice a day/i.test(n)?2:/thrice a day/i.test(n)?3:1,p=u*d,a=e-t,o=Math.max(p-a,0),h=Math.min(a,p);let i="Good";const _=h/p*100;return _<95?i="Explore problem":_<100&&(i="Acceptable"),{expected:p,actual:a,dosesMissed:o,dosesConsumed:h,adherenceStatus:i}}}}),Ee=F({components:{IonButton:J},props:{styles:{type:Array},rowColors:{type:Array,default:()=>[]},cellColors:{type:Array,default:()=>[]},columns:{type:Object,required:!0},rows:{type:Object}},computed:{classStyles(){const e=this.styles?this.styles.join(" "):"";return"his-table ".concat(e)}},methods:{isLink(e){try{return typeof e=="object"&&e.type==="link"}catch(t){return e}},isActionButton(e){try{return typeof e=="object"&&e.type==="button"}catch(t){return e}},getColorCodeClass(e,t){let u="";if(!B.isEmpty(this.rowColors)){const n=this.rowColors.filter(d=>d.indexes.includes(e));B.isEmpty(n)||(u+=" "+n[0].class)}if(!B.isEmpty(this.cellColors)){const n=this.cellColors.filter(d=>d.index===t&&d.row===e);B.isEmpty(n)||(u+=" "+n[0].class)}return u}}}),Re=["innerHTML"];function Se(e,t,u,n,d,p){return f(),g("table",{class:H(["his-md-text",e.classStyles])},[C("tr",null,[(f(!0),g(k,null,T(e.columns,(a,o)=>(f(),g("th",{key:o},Q(a),1))),128))]),(f(!0),g(k,null,T(e.rows,(a,o)=>(f(),g("tr",{key:o},[(f(!0),g(k,null,T(a,(h,i)=>(f(),g("td",{class:H(e.getColorCodeClass(o,i)),key:i},[C("div",null,[C("span",{innerHTML:h},null,8,Re)])],2))),128))]))),128))],2)}const $e=Y(Ee,[["render",Se],["__scopeId","data-v-fe4ab68f"]]),Pe=F({name:"ARTAdherence",components:{ReportDataTable:$e,IonPage:me,IonContent:he,IonCard:pe,IonCardHeader:ue,IonCardTitle:de,IonCardContent:le,IonAccordion:ie,IonAccordionGroup:ce,IonItem:re,IonLabel:ae,IonInput:ne,IonRadio:se,IonRadioGroup:oe,IonButton:J,IonIcon:te},setup(){var G,U;const e=ge(),t=De();be();const u=Ce(),n=new ve,d=(G=Ae.getUserID())!=null?G:-1,p=((U=u.getfacilityLocation())==null?void 0:U.code)||"",a=n.getID(),o=new we(a,d,p),h=O([]),i=O([]),_=O([]),I=O([]);fe(async()=>{try{a&&(await o.loadPreviousDrugs(),o.receivedDrugsBefore()&&t.processMedicationData(o))}catch(s){console.error("Error initializing adherence data:",s)}});const E=()=>{e.push("/patientProfile")},R=(s,r)=>{const y=r.detail.value?parseInt(r.detail.value):0;t.updateMedicationRemaining(s,y)},A=(s,r)=>{const y=r.detail.value?parseInt(r.detail.value):0;t.updateExpected(s,y)},w=(s,r)=>{const y=r.detail.value?parseInt(r.detail.value):0;t.updateActual(s,y)},S=s=>{t.setAgreeWithCalculation(s.detail.value==="yes")};function q(s){return o.calculateExpected(s.quantity,s.equivalent_daily_dose,s.order.start_date,V(s.frequency))}function V(s){return"".concat(s).match(/qod/i)?"QOD":"".concat(s).match(/weekly/i)?"QW":s}function L(){const s=t.medications.map(l=>({...l.drug,pillsBrought:l.remaining})),r=o.getReceiptDate(),y=o.calcTimeElapsed(r,"day"),W=" Last visit: ".concat(r," \n                (").concat(y," Days Elapsed)"),D=[{indexes:[0,3,6],class:"adherence-col-bg"}],P=[],$=[W],c=[["Prescription"],["Tabs given"],["Tabs per"],["Tabs remaining"],["Expected"],["Actual (counted)"],["Adherence"],["Doses missed/ Unaccounted for"],["Doses consumed"],["Art Adherence"]];s.forEach((l,K)=>{const X=V(l.frequency),M=q(l),x=o.calculateAdherence(l.quantity,l.pillsBrought,M),j=o.isAdherenceGood(x)?"Good adherence":"Explore problem",Z=o.calculateUnaccountedOrMissed(M,l.pillsBrought);$.push(l.drug.name),c[0].push(""),c[1].push(l.quantity),c[2].push("".concat(l.equivalent_daily_dose," <b>").concat(X,"</b>")),c[3].push(""),c[4].push(M<0?0:M),c[5].push(l.pillsBrought),c[6].push(""),c[7].push(Z),c[8].push("".concat(x,"%")),c[9].push(j),P.push({index:K+1,row:9,class:j.match(/good/i)?"adherence-txt-good":"adherence-txt-bad"})}),h.value=$,i.value=c,I.value=P,_.value=D}return{tableRows:i,tableHeaders:h,tableCellColors:I,tableRowColors:_,adherenceStore:t,chevronBackOutline:ye,chevronDownOutline:_e,buildAdherenceReport:L,goBackToProfile:E,updateRemaining:R,updateExpected:A,updateActual:w,updateAgreeWithCalculation:S,onSubmit:async()=>{console.log(L());try{if(!n.getID())return z("Patient ID required"),console.error("Patient ID not found"),!1;const r=[];t.medications.forEach(async D=>{const{drug:P,order:$}=D.drug,c={...D.drug,pillsBrought:D.remaining},l=o.calculateAdherence(c.quantity,c.pillsBrought,q(c));r.push(o.buildAdherenceObs($.order_id,P.drug_id,l)),r.push(o.buildPillCountObs($.order_id,D.remaining))}),await o.createEncounter();const y=await Promise.all([...r]);if(await o.saveObservationList(y))return Ie("Adherence saved!"),!0}catch(s){console.error("Error saving adherence data:",s),z("An exception has occured")}return!1}}}}),Me={class:"container"},Oe={class:"ion-padding",slot:"content"},Be={class:"medication-section"},ke={class:"medication-inputs"},Te={class:"medication-name"},qe={class:"ion-padding",slot:"content"};function Ve(e,t,u,n,d,p){const a=v("ion-label"),o=v("ion-item"),h=v("ion-input"),i=v("ion-accordion"),_=v("report-data-table"),I=v("ion-accordion-group"),E=v("ion-card-content"),R=v("ion-card");return f(),g("div",Me,[m(R,{class:"adherence-card"},{default:b(()=>[m(E,null,{default:b(()=>[m(I,{onIonChange:e.buildAdherenceReport,value:"pills"},{default:b(()=>[m(i,{value:"pills","toggle-icon":e.chevronDownOutline},{default:b(()=>[m(o,{slot:"header",color:"light"},{default:b(()=>[m(a,null,{default:b(()=>t[0]||(t[0]=[N("Pills remaining (brought to clinic)")])),_:1,__:[0]})]),_:1}),C("div",Oe,[C("div",Be,[t[1]||(t[1]=C("div",{class:"medication-header"},"Medication (enter amount remaining for each drug)",-1)),C("div",ke,[(f(!0),g(k,null,T(e.adherenceStore.medications,(A,w)=>(f(),g("div",{class:"medication-row",key:w},[C("div",Te,Q(A.name),1),m(h,{type:"number",placeholder:"0",class:"pill-input",modelValue:A.remaining,"onUpdate:modelValue":S=>A.remaining=S,onIonChange:S=>e.updateRemaining(w,S)},null,8,["modelValue","onUpdate:modelValue","onIonChange"])]))),128))])])])]),_:1},8,["toggle-icon"]),m(i,{value:"arv","toggle-icon":e.chevronDownOutline},{default:b(()=>[m(o,{slot:"header",color:"light"},{default:b(()=>[m(a,null,{default:b(()=>t[2]||(t[2]=[N("ARV adherence")])),_:1,__:[2]})]),_:1}),C("div",qe,[m(_,{columns:e.tableHeaders,rows:e.tableRows,cellColors:e.tableCellColors,rowColors:e.tableRowColors},null,8,["columns","rows","cellColors","rowColors"])])]),_:1},8,["toggle-icon"])]),_:1},8,["onIonChange"])]),_:1})]),_:1})])}const He=Y(Pe,[["render",Ve],["__scopeId","data-v-6f75b1b8"]]);export{He as default};
