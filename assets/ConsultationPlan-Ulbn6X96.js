import{d as Le,ar as Be,cl as Fe,r as n,b2 as p,c as Ee,a as ze,w as m,y as Y,f as R,z as L,l,e as He,m as j,k as v,u as y,bN as Me,d5 as Ue,ah as Ve,i as h,bG as We,v as D,an as Ge,dJ as $e,bg as P}from"./vendor-D_pL91wi.js";import{u as Je,_ as Ye}from"./useFormWizard-CeqzPGXa.js";import{u as je,aA as qe,aS as Ke,a3 as Qe,c as Xe,aC as Ze,O as et,a4 as tt,aT as at,aU as st,aH as nt,T as ot,D as it,t as B,C as S,n as O,ab as lt,E as rt,H as F,aD as w,aF as q,aV as K,S as ct,l as Q,_ as ut}from"./index-6eMvyszw.js";import{D as mt}from"./DemographicBar-Dd9mbNOC.js";import{C as vt,O as pt,a as dt,b as ft}from"./OPDOutcome-DdNtH0eU.js";import{I as gt,N as ht,s as Dt,b as Pt,e as yt,d as St}from"./NextAppointment-BJDeQRuj.js";import{O as wt}from"./OPDPrintingModal-DSrYVDkM.js";import{l as X}from"./lodash-Dt8AsbQm.js";import{u as bt}from"./usePatientProfile-DJ1jR4h0.js";import{S as Z}from"./stages-C9QcQsGP.js";import"./apexcharts-f-yxlPgg.js";import"./patient_complaints_service-BqMi-V6A.js";import"./DashBox-DY6r8Dlw.js";import"./useExposeFromStandardForm-DlKikE1r.js";import"./BasicForm-BrHGrs5x.js";import"./DateInputField-PVpHUfzg.js";import"./formatServerData-10Gy6MHW.js";import"./drug_prescription_service-BHApg1Dn.js";import"./drug_service-DLJr3Df0.js";import"./Outcome-oQ78KKB0.js";import"./lab_order-qXg3-rne.js";import"./group_validation-A8a6ezMm.js";import"./ncd_appointment_service-pkm2O4iz.js";import"./Registration-B7D2d3Ht.js";import"./useLocation-BFBht8Qe.js";import"./vaccines_service-MPhdi9YA.js";import"./sms_service-DxvXYCJW.js";import"./EIRreportsStore-BaMpQynv.js";import"./Export-DVMdi1_t.js";const Ot={key:0,class:"spinner-overlay"},At={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},_t={class:"back_profile"},Tt=Le({__name:"ConsultationPlan",setup(Ct){const{currentTabIndex:d}=Je("Consultation Plan"),{printVisitSummary:ee}=bt(),f=Be(),te=Fe(),A=n(!1),_=n(!0),E=n(!1),T=n(!1),C=n(!0),ae=n(!1),I=n(!1),se=n(!1),z=je(),ne=qe(),oe=Ke(),ie=Qe(),le=Xe(),H=Ze(),M=et(),re=tt(),ce=at(),ue=st(),{patient:r}=p(z),{investigations:me}=p(ne),{OPDdiagnosis:ve}=p(oe),{selectedMedicalDrugsList:pe,nonPharmalogicalTherapyAndOtherNotes:U}=p(ie),{OPDActivities:b}=p(le),{outcomes:de}=p(H),{currentSelectedNextAppointmentDate:fe}=p(ce),{presentingComplaints:ge}=p(ue),{vitals:he}=p(re),De=nt(),V=Ee(()=>De.selectedMedicalAllergiesList),W=n(null),Pe=n(null),G=n(null),ye=n(null),Se=n(null),we=n(null),N=n(null),$=()=>b.value.map(e=>({title:e,icon:""})),s=n(),be=n({}),Oe=async(e,t,i)=>{if(t===0&&await Ce(),!await J()){B("Please add presenting complaints before proceeding.");return}await c(),e%1===0&&(d.value=e),N.value&&i&&N.value.changeTab(e)},g=()=>{var i;if(!s.value||s.value.length===0)return null;const e=d.value>=0&&d.value<s.value.length?d.value:0;switch((i=s.value[e])==null?void 0:i.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(b.value.length>0)switch(b.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Ae=()=>{f.push("home")},_e=async()=>{T.value=!0,S("Printing consultation summary... Please wait.");try{await ee(),S("Consultation summary printed successfully!"),setTimeout(()=>{f.push("home")},3500)}catch(e){O("Failed to print consultation summary.")}finally{T.value=!1}},Te=()=>{S("Patient has finished consultation!"),f.push("home")},J=async()=>{const e=await lt.getObsByEncounterIdAndDate(rt.PRESENTING_COMPLAINTS);return!!(e&&e.length>0)},c=async()=>{var t,i;const e=F.sessionDate();for(let o=0;o<s.value.length;o++)if(!await J())_.value=!1,s.value[o].title!=="Clinical Assessment"&&(s.value[o].icon=$e);else{_.value=!0,E.value=!1;const u=s.value[o];if(be.value={title:"Untitled"},u.title==="Clinical Assessment"){const a=w("presentingComplaints");s.value[o].icon=x(e,a)?P:""}else if(u.title==="Investigations"){const a=(i=(t=r.value)==null?void 0:t.labOrders)==null?void 0:i.saved,k=a==null?void 0:a.filter(Re=>F.toStandardHisFormat(e)===F.toStandardHisFormat(Re.order_date));s.value[o].icon=(k==null?void 0:k.length)>0?P:""}else if(u.title==="Diagnosis"){const a=w("diagnosis");s.value[o].icon=x(e,a)?P:""}else if(u.title==="Treatment Plan"){const a=w("treatment");s.value[o].icon=(a==null?void 0:a.length)>0?P:""}else if(u.title==="Next Appointment"){const a=w("appointments");s.value[o].icon=x(e,a)?P:""}else if(u.title==="Outcome"){const a=w("outcomes");s.value[o].icon=(a==null?void 0:a.length)>0?P:""}}},x=(e,t)=>{if(!t)return!1;const i=new Date(e);return i.setHours(0,0,0,0),t.some(o=>{const u=new Date(o.obs_datetime||o.order_date);return u.setHours(0,0,0,0),u.getTime()===i.getTime()})},Ce=async()=>{var e;A.value=!0;try{await Ie(),await Promise.all([(e=W.value)==null?void 0:e.onSubmit()]),await q(r.value),K()}catch(t){throw console.error("Error saving clinical assessment:",t),O("Failed to save clinical assessment"),t}finally{A.value=!1}},Ie=async()=>{try{if(!X.isEmpty(V.value)){const e=xe(),t=await Dt(e);z.setPatientRecord(t)}}catch(e){console.error("Failed to save allergies:",e),B("Failed to save allergies")}},Ne=async()=>{try{if(!X.isEmpty(U.value)){const e=[{concept_id:2688,obs_datetime:localStorage.getItem("sessionDate"),value_text:U.value,location_id:M.facilityLocation.code}];await Pt(e)}await yt(),await St().saveNonPharmaTherapyPatientData()}catch(e){console.error("Failed to save treatment plan:",e),B("Failed to save treatment plan")}},xe=()=>V.value.map(e=>({concept_id:985,obs_datetime:ct.getSessionDate(),value_coded:e.concept_id,location_id:M.facilityLocation.code})),ke=async()=>{var e;try{(e=G.value)==null||e.onSubmit(),await Ne(),await H.saveOutcomPatientData(),await K(),await q(r.value);const t=localStorage.getItem("locationID"),i=localStorage.getItem("userRoles");if(!t){O("Location ID could not be found. Please check your settings.");return}(i?JSON.parse(i):[]).some(a=>a.role==="Lab")?(await Z.movePatientToNextStage(r.value.patientID,"LAB","CONSULTATION",t,r.value.visitID||r.value.visit_id),await Q().refresh(t),await f.push("home"),S("Lab results submitted. Patient can return to consultation")):(await Z.movePatientToNextStage(r.value.patientID,"CONSULTATION","DISPENSATION",t,r.value.visitID||r.value.visit_id),await Q().refresh(t),await f.push("home"),S("Consultation patient saved successfully."))}catch(t){console.error("Error saving consultation data:",t),O("Failed to save consultation data")}};return ze(async()=>{if(b.value.length===0){await f.push("home");return}s.value=$(),await c(),(d.value===void 0||d.value<0)&&(d.value=0)}),m(he,async()=>{await c()},{deep:!0}),m(r,async()=>{await c()},{deep:!0}),m(me,async()=>{await c()},{deep:!0}),m(ve,async()=>{await c()},{deep:!0}),m(pe,async()=>{await c()},{deep:!0}),m(de,async()=>{await c()},{deep:!0}),m(fe,async()=>{await c()}),m(ge,async()=>{await c()},{deep:!0}),m(te,async()=>{C.value=!1,s.value=$(),setTimeout(()=>{d.value=0,C.value=!0},0)},{deep:!0}),m(se,e=>{I.value=e,I.value&&setTimeout(()=>{I.value=!1},15e3)}),(e,t)=>(R(),Y(y(Ge),null,{default:L(()=>[l(wt,{onYes:_e,onNo:Te,isOpen:ae.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),A.value?(R(),He("div",Ot,[l(y(Me),{name:"bubbles"}),t[2]||(t[2]=v("div",{class:"loading-text"},"Please wait...",-1))])):j("",!0),l(y(Ue),{"is-open":T.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(ot),l(y(Ve),{fullscreen:!0},{default:L(()=>[l(mt),v("div",At,[C.value?(R(),Y(Ye,{key:0,ref_key:"wizard",ref:N,"vertical-tabs":"","navigable-tabs":_.value,"scrollable-tabs":"",startIndex:0,doneButton:{text:"Finish",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},nextButton:{disabled:E.value},"custom-tabs":s.value,tabs:s.value,onChange:Oe,"onComplete:wizard":t[1]||(t[1]=i=>ke())},{default:L(()=>[v("div",null,[v("div",_t,[l(it,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:y(We),"font-weight":"600",onClick:t[0]||(t[0]=i=>Ae())},null,8,["icon"])])]),h(v("div",null,[l(vt,{ref_key:"clinicalAssessmentRef",ref:W},null,512)],512),[[D,g()==="ClinicalAssessment"]]),h(v("div",null,[l(gt,{ref_key:"investigationsRef",ref:Pe},null,512)],512),[[D,g()==="Investigations"]]),h(v("div",null,[l(pt,{ref_key:"diagnosisRef",ref:G},null,512)],512),[[D,g()==="OPDDiagnosis"]]),h(v("div",null,[l(dt,{ref_key:"treatmentPlanRef",ref:ye},null,512)],512),[[D,g()==="OPDTreatmentPlan"]]),h(v("div",null,[l(ht,{ref_key:"nextAppointmentRef",ref:Se},null,512)],512),[[D,g()==="NextAppointment"]]),h(v("div",null,[l(ft,{ref_key:"outcomeRef",ref:we},null,512)],512),[[D,g()==="Outcome"]])]),_:1},8,["navigable-tabs","nextButton","custom-tabs","tabs"])):j("",!0)])]),_:1})]),_:1}))}}),na=ut(Tt,[["__scopeId","data-v-20e8cd24"]]);export{na as default};
