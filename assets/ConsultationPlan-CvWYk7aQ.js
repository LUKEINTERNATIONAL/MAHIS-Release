import{d as Ee,ar as Fe,cl as ze,r as i,a$ as p,a as Me,w as m,y as j,f as L,z as B,l,e as Ve,m as q,k as v,u as f,bM as He,d5 as We,ah as Ue,i as D,bG as $e,v as P,an as Ge,dI as Ye,bg as y}from"./vendor-D2vbv48U.js";import{u as Je,_ as je}from"./useFormWizard-DotnPkHx.js";import{u as qe,az as Ke,aM as Qe,a1 as Xe,c as Ze,aB as et,N as tt,a2 as at,aN as st,aO as nt,T as ot,D as it,t as E,z as b,n as I,a8 as lt,E as rt,H as F,aC as w,ax as K,aP as Q,S as ct,k as X,l as Z,_ as ut}from"./index-BTSeOqUL.js";import{D as mt}from"./DemographicBar-Cz3yQv1-.js";import{C as vt,O as pt,a as dt,b as ft}from"./OPDOutcome-Cs4PAX8U.js";import{I as gt,N as ht,T as ee,s as Dt,a as Pt,d as yt,b as bt}from"./NextAppointment-CW73WXQo.js";import{O as wt}from"./OPDPrintingModal-VhM7ZwrN.js";import{l as z}from"./lodash-Dt8AsbQm.js";import{u as St}from"./usePatientProfile-D42Osv3t.js";import"./apexcharts-D3NY3X_Q.js";import"./patient_complaints_service-CwKGqwDe.js";import"./DashBox-CCgNgHdZ.js";import"./useExposeFromStandardForm-DTCBagmg.js";import"./BasicForm-DlgqO7A-.js";import"./DateInputField-C7BnQE-Q.js";import"./formatServerData-DDCZNBsj.js";import"./drug_prescription_service-BtKoB4V8.js";import"./drug_service-CqagE6cs.js";import"./Outcome-BclF31_B.js";import"./lab_order-Bs4v4Fiz.js";import"./userService-B3d0TNWT.js";import"./group_validation-BIqexJY3.js";import"./ncd_appointment_service-1fMX67MA.js";import"./Registration-DettZ-bZ.js";import"./useLocation-CUY0k8RU.js";import"./vaccines_service-DPhCx0Hq.js";import"./sms_service-BVMb--m4.js";import"./EIRreportsStore-DUpXUN2w.js";import"./Export-DoOwWRUE.js";const It={key:0,class:"spinner-overlay"},Ot={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Tt={class:"back_profile"},_t=Ee({__name:"ConsultationPlan",setup(At){const{onTabBeforeChange:te,onChangeCurrentTab:ae,currentTabIndex:d}=Je("Consultation Plan"),{printVisitSummary:se}=St(),g=Fe(),ne=ze(),O=i(!1),T=i(!0),M=i(!1),_=i(!1),A=i(!0),oe=i(!1),C=i(!1),ie=i(!1),le=qe(),re=Ke(),ce=Qe(),ue=Xe(),me=Ze(),V=et(),H=tt(),ve=at(),pe=st(),de=nt(),{patient:r}=p(le),{investigations:fe}=p(re),{OPDdiagnosis:ge}=p(ce),{selectedMedicalDrugsList:he,nonPharmalogicalTherapyAndOtherNotes:W,selectedMedicalAllergiesList:N}=p(ue),{OPDActivities:S}=p(me),{outcomes:De}=p(V),{currentSelectedNextAppointmentDate:Pe}=p(pe),{presentingComplaints:ye}=p(de),{vitals:be}=p(ve),U=i(null),we=i(null),$=i(null),Se=i(null),Ie=i(null),Oe=i(null),x=i(null),G=()=>S.value.map(e=>({title:e,icon:""})),o=i(G()),Te=i({}),_e=async e=>{if(await xe(),!await Y()){E("Please add presenting complaints before proceeding.");return}await c(),e%1===0&&(d.value=e),x.value&&x.value.changeTab(e)},h=()=>{var n;if(!o.value||o.value.length===0)return null;const e=d.value>=0&&d.value<o.value.length?d.value:0;switch((n=o.value[e])==null?void 0:n.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(S.value.length>0)switch(S.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Ae=()=>{g.push("home")},Ce=async()=>{_.value=!0,b("Printing consultation summary... Please wait.");try{await se(),b("Consultation summary printed successfully!"),setTimeout(()=>{g.push("home")},3500)}catch(e){I("Failed to print consultation summary.")}finally{_.value=!1}},Ne=()=>{b("Patient has finished consultation!"),g.push("home")},Y=async()=>(await lt.getObsByEncounterIdAndDate(rt.PRESENTING_COMPLAINTS)).length>0,c=async()=>{var t,n;const e=F.sessionDate();for(let a=0;a<o.value.length;a++)if(!await Y())T.value=!1,o.value[a].title!=="Clinical Assessment"&&(o.value[a].icon=Ye);else{T.value=!0,M.value=!1;const u=o.value[a];if(Te.value={title:"Untitled"},u.title==="Clinical Assessment"){const s=w("presentingComplaints");o.value[a].icon=k(e,s)?y:""}else if(u.title==="Investigations"){const s=(n=(t=r.value)==null?void 0:t.labOrders)==null?void 0:n.saved,R=s==null?void 0:s.filter(Be=>F.toStandardHisFormat(e)===F.toStandardHisFormat(Be.order_date));o.value[a].icon=(R==null?void 0:R.length)>0?y:""}else if(u.title==="Diagnosis"){const s=w("diagnosis");o.value[a].icon=k(e,s)?y:""}else if(u.title==="Treatment Plan"){const s=w("treatment");o.value[a].icon=(s==null?void 0:s.length)>0?y:""}else if(u.title==="Next Appointment"){const s=w("appointments");o.value[a].icon=k(e,s)?y:""}else if(u.title==="Outcome"){const s=w("outcomes");o.value[a].icon=(s==null?void 0:s.length)>0?y:""}}},k=(e,t)=>{if(!t)return!1;const n=new Date(e);return n.setHours(0,0,0,0),t.some(a=>{const u=new Date(a.obs_datetime||a.order_date);return u.setHours(0,0,0,0),u.getTime()===n.getTime()})},xe=async()=>{var e;O.value=!0;try{await Promise.all([(e=U.value)==null?void 0:e.onSubmit(),ke()]),await K(r.value),Q()}catch(t){throw console.error("Error saving clinical assessment:",t),I("Failed to save clinical assessment"),t}finally{O.value=!1}},ke=async()=>{try{const e=localStorage.getItem("userID"),t=r.value.patientID;if(!z.isEmpty(N.value)){const n=J();await new ee().onSubmitAllergies(t,e,n),await Dt(n)}}catch(e){console.error("Failed to save allergies:",e),E("Failed to save allergies")}},Re=async()=>{try{const e=localStorage.getItem("userID"),t=r.value.patientID,n=new ee;if(!z.isEmpty(N.value)){const a=J();await n.onSubmitAllergies(t,e,a)}if(!z.isEmpty(W.value)){const a=[{concept_id:2688,obs_datetime:localStorage.getItem("sessionDate"),value_text:W.value,location_id:H.facilityLocation.code}];await Pt(a)}await yt(),await bt().saveNonPharmaTherapyPatientData()}catch(e){console.error("Failed to save treatment plan:",e),E("Failed to save treatment plan")}},J=()=>N.value.map(e=>({concept_id:985,obs_datetime:ct.getSessionDate(),value_coded:e.concept_id,location_id:H.facilityLocation.code})),Le=async()=>{var e;try{(e=$.value)==null||e.onSubmit(),await Re(),await V.saveOutcomPatientData(),await Q(),await K(r.value);const t=localStorage.getItem("locationID"),n=localStorage.getItem("userRoles");if(!t){I("Location ID could not be found. Please check your settings.");return}(n?JSON.parse(n):[]).some(s=>s.role==="Lab")?(await X.movePatientToNextStage(r.value.patientID,"LAB","CONSULTATION",t,r.value.visitID||r.value.visit_id),await Z().refresh(t),await g.push("home"),b("Lab results submitted. Patient can return to consultation")):(await X.movePatientToNextStage(r.value.patientID,"CONSULTATION","DISPENSATION",t,r.value.visitID||r.value.visit_id),await Z().refresh(t),await g.push("home"),b("Consultation patient saved successfully."))}catch(t){console.error("Error saving consultation data:",t),I("Failed to save consultation data")}};return Me(async()=>{if(S.value.length===0){await g.push("home");return}o.value=G(),await c(),(d.value===void 0||d.value<0)&&(d.value=0)}),m(be,async()=>{await c()},{deep:!0}),m(r,async()=>{await c()},{deep:!0}),m(fe,async()=>{await c()},{deep:!0}),m(ge,async()=>{await c()},{deep:!0}),m(he,async()=>{await c()},{deep:!0}),m(De,async()=>{await c()},{deep:!0}),m(Pe,async()=>{await c()}),m(ye,async()=>{await c()},{deep:!0}),m(ne,async()=>{A.value=!1,setTimeout(()=>{d.value=0,A.value=!0},0)},{deep:!0}),m(ie,e=>{C.value=e,C.value&&setTimeout(()=>{C.value=!1},15e3)}),(e,t)=>(L(),j(f(Ge),null,{default:B(()=>[l(wt,{onYes:Ce,onNo:Ne,isOpen:oe.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),O.value?(L(),Ve("div",It,[l(f(He),{name:"bubbles"}),t[2]||(t[2]=v("div",{class:"loading-text"},"Please wait...",-1))])):q("",!0),l(f(We),{"is-open":_.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(ot),l(f(Ue),{fullscreen:!0},{default:B(()=>[l(mt),v("div",Ot,[A.value?(L(),j(je,{key:0,ref_key:"wizard",ref:x,"vertical-tabs":"","navigable-tabs":T.value,"scrollable-tabs":"",startIndex:0,doneButton:{text:"Finish",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},nextButton:{disabled:M.value},"custom-tabs":o.value,tabs:o.value,beforeChange:f(te),onChange:f(ae),onOnValidateTabs:_e,"onComplete:wizard":t[1]||(t[1]=n=>Le())},{default:B(()=>[v("div",null,[v("div",Tt,[l(it,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:f($e),"font-weight":"600",onClick:t[0]||(t[0]=n=>Ae())},null,8,["icon"])])]),D(v("div",null,[l(vt,{ref_key:"clinicalAssessmentRef",ref:U},null,512)],512),[[P,h()==="ClinicalAssessment"]]),D(v("div",null,[l(gt,{ref_key:"investigationsRef",ref:we},null,512)],512),[[P,h()==="Investigations"]]),D(v("div",null,[l(pt,{ref_key:"diagnosisRef",ref:$},null,512)],512),[[P,h()==="OPDDiagnosis"]]),D(v("div",null,[l(dt,{ref_key:"treatmentPlanRef",ref:Se},null,512)],512),[[P,h()==="OPDTreatmentPlan"]]),D(v("div",null,[l(ht,{ref_key:"nextAppointmentRef",ref:Ie},null,512)],512),[[P,h()==="NextAppointment"]]),D(v("div",null,[l(ft,{ref_key:"outcomeRef",ref:Oe},null,512)],512),[[P,h()==="Outcome"]])]),_:1},8,["navigable-tabs","nextButton","custom-tabs","tabs","beforeChange","onChange"])):q("",!0)])]),_:1})]),_:1}))}}),na=ut(_t,[["__scopeId","data-v-e0a12cad"]]);export{na as default};
