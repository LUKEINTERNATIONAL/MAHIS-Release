var ge=Object.defineProperty;var pe=(N,g,b)=>g in N?ge(N,g,{enumerable:!0,configurable:!0,writable:!0,value:b}):N[g]=b;var K=(N,g,b)=>pe(N,typeof g!="symbol"?g+"":g,b);import{d as se,r as V,c as X,w as ye,a as ne,O as A,f as d,u as l,bg as re,J as n,l as o,G as ue,E as ie,Q as _,aY as oe,N as E,I as ce,k as s,m as z,_ as Z,p as ae,i as Ve,K as k,b6 as _e,a0 as te,e as y,bM as Ie,a7 as de,L as he,e4 as Ae,bj as Ne,a8 as De,F,P as $,a9 as we,aP as Re,aM as Se,ad as ke,a2 as Ce,bm as Pe,aa as Te}from"./vendor-D9iXubTR.js";import{P as H,u as ve,a7 as j,D as be,t as W,I as me,K as ee,_ as fe,bT as xe,af as S,bN as Ee,H as G}from"./index-Bdl5jS7K.js";import{l as le}from"./lodash-NJiRuGo9.js";import"./apexcharts-C2vcFPvf.js";class Me extends H{constructor(){super(...arguments);K(this,"suggestedNextARVNumber");K(this,"patientHasARVNumber",!1);K(this,"prependValue","")}async _getArvNumber_(){var b;try{const I=(b=ve().$state)==null?void 0:b.patient.patientID;if(!I)return"";const f=await H.findByID(I);if(!(f!=null&&f.patient_identifiers))return"";const v=f.patient_identifiers.find(c=>c.identifier_type==4);return(v==null?void 0:v.identifier)||""}catch(t){return""}}async getARVnumber(){try{const b=await this._getArvNumber_();if(b!=="Unknown"){const t=b.split("-");this.suggestedNextARVNumber=t[2].replace(/^\D+|\s/g,""),this.prependValue="".concat(t[0],"-").concat(t[1],"-"),this.patientHasARVNumber=!0}else{const t=await j.getNextSuggestedARVNumber();this.suggestedNextARVNumber=t.arv_number.replace(/^\D+|\s/g,"")}}catch(b){const t=await j.getNextSuggestedARVNumber();this.suggestedNextARVNumber=t.arv_number.replace(/^\D+|\s/g,"")}return this.suggestedNextARVNumber}async saveARVNumber(b){const I=be().$state.globalPropertyStore.sitePrefix,f="".concat(I,"-ARV-").concat(b);if(f===await this._getArvNumber_()){W("ARV number is the same as the current one",5e3);return}if(await me.arvNumberExists(f))W("ARV number already exists",5e3);else try{this.patientHasARVNumber?(await this.updateARVNumber(f),ee("ARV number updated successfully")):(await this.createArvNumber(f),ee("ARV number created successfully"))}catch(c){W("".concat(c))}}}const Be={class:"form-container"},Fe={class:"arv-input-section"},$e={class:"arv-input-container"},He={class:"input-group-text"},Oe={class:"action-buttons"},Ge={key:1},Le=se({__name:"ArvNumberModal",props:{isOpen:{type:Boolean,required:!0}},emits:["close","arvNumberSaved"],setup(N,{emit:g}){const b=N,t=g,I=be(),f=ve(),v=V(""),c=V(""),D=V(""),C=V(!1),h=new Me,w=X(()=>I.globalPropertyStore.sitePrefix||"SITE"),M=X(()=>"".concat(w.value,"-ARV-").concat(v.value)),B=()=>{O(),t("close")},O=()=>{v.value="",c.value="",D.value="",C.value=!1},q=m=>{const R=m.target.value.replace(/[^0-9]/g,"");v.value=R,c.value="",D.value="",L()},L=()=>v.value?/^\d+$/.test(v.value)?parseInt(v.value)<=0?(c.value="Number must be positive",!1):(c.value="",!0):(c.value="Only numbers are allowed",!1):(c.value="ARV number is required",!1),Y=async()=>{var m;if(L()){C.value=!0,c.value="";try{const i=await h._getArvNumber_(),R=M.value;if(i!==R&&await me.arvNumberExists(R)){c.value="ARV number already exists",C.value=!1;return}await h.saveARVNumber(v.value);try{const P=await H.findByID((m=f.$state)==null?void 0:m.patient.patientID);P&&await f.setRecord(P)}catch(P){console.warn("Could not update demographics store:",P)}D.value="ARV number saved successfully",ee("ARV number updated successfully"),t("arvNumberSaved",R),setTimeout(()=>{B()},1e3)}catch(i){console.error("Error saving ARV number:",i),c.value="Error saving ARV number. Please try again.",W("Failed to save ARV number")}finally{C.value=!1}}},J=async()=>{try{const m=await h._getArvNumber_();if(m&&m!=="Unknown"&&m!==""){const i=m.split("-");i.length>=3&&(v.value=i[2],h.patientHasARVNumber=!0)}else{const i=await h.getARVnumber();v.value=i,h.patientHasARVNumber=!1}}catch(m){console.error("Error loading current ARV number:",m);try{const i=await h.getARVnumber();v.value=i,h.patientHasARVNumber=!1}catch(i){console.error("Error getting suggested ARV number:",i)}}};return ye(()=>b.isOpen,m=>{m&&J()}),ne(()=>{I.loadSitePrefix()}),(m,i)=>(d(),A(l(re),{"is-open":N.isOpen,onDidDismiss:B,class:"arv-number-modal"},{default:n(()=>[o(l(ce),null,{default:n(()=>[o(l(ue),null,{default:n(()=>[o(l(ie),{class:"modal-title"},{default:n(()=>[...i[1]||(i[1]=[_("Update ARV Number",-1)])]),_:1}),o(l(oe),{slot:"end"},{default:n(()=>[o(l(E),{onClick:B,class:"close-button"},{default:n(()=>[...i[2]||(i[2]=[_("Close",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),o(l(de),{class:"ion-padding modal-content"},{default:n(()=>[s("div",Be,[s("div",Fe,[o(l(Z),{class:"form-label"},{default:n(()=>[...i[3]||(i[3]=[_("ARV Number ",-1),s("span",{class:"required"},"*",-1)])]),_:1}),s("div",$e,[s("div",{class:ae(["input-group",{"input-group-error":c.value}])},[s("span",He,k(w.value)+"-ARV- ",1),Ve(s("input",{type:"text",class:ae(["form-control",{"has-error":c.value}]),"onUpdate:modelValue":i[0]||(i[0]=R=>v.value=R),onInput:q,placeholder:"Enter number",inputmode:"numeric",pattern:"[0-9]*"},null,34),[[_e,v.value]])],2)]),c.value?(d(),A(l(te),{key:0,class:"error-label"},{default:n(()=>[_(k(c.value),1)]),_:1})):z("",!0),D.value?(d(),A(l(te),{key:1,class:"success-label"},{default:n(()=>[_(k(D.value),1)]),_:1})):z("",!0)]),s("div",Oe,[o(l(E),{color:"danger",fill:"outline",onClick:B,class:"cancel-button"},{default:n(()=>[...i[4]||(i[4]=[_(" Cancel ",-1)])]),_:1}),o(l(E),{onClick:Y,disabled:!v.value||!!c.value||C.value,class:"save-button"},{default:n(()=>[C.value?(d(),A(l(Ie),{key:0,name:"crescent"})):(d(),y("span",Ge,"Save"))]),_:1},8,["disabled"])])])]),_:1})]),_:1},8,["is-open"]))}}),Ue=fe(Le,[["__scopeId","data-v-9e415ee0"]]),Ke={class:"styled-table"},We={key:0},ze=["innerHTML"],je={key:1},qe={class:"modal-content"},Ye=se({__name:"Mastercard",setup(N){const g=V([]),b=V([]),t=new H,I=V([]),f=V(!1),v=V([]),c=V(!1),D=V(!1),C=X(()=>le.chunk(b.value,7)),h=V(!1),w=V(!1);function M(e){return g.value.includes(e)?"Yes":"No"}function B(){b.value=[{label:"ARV Number",value:"...",asyncValue:async()=>{var a,r,p;const e=await H.findByID(t.getID());return(p=(r=((a=e==null?void 0:e.patient_identifiers)!=null?a:[]).find(u=>u.type.name==="ARV Number"))==null?void 0:r.identifier)!=null?p:"Add"},click:()=>{D.value=!0},other:{editable:!0}},{label:"National Patient ID",value:"...",staticValue:()=>t.getNationalID()},{label:"Given Name",value:"...",staticValue:()=>t.getGivenName(),other:{editable:!0,attribute:"given_name",category:"demographics"}},{label:"Family Name",value:"...",staticValue:()=>t.getFamilyName(),other:{editable:!0,attribute:"family_name",category:"demographics"}},{label:"Age",value:"...",staticValue:()=>t.getAge(),other:{editable:!0,attribute:"year_birth_date",category:"demographics"}},{label:"Sex",value:"...",staticValue:()=>t.getGender(),other:{editable:!0,attribute:"gender",category:"demographics"}},{label:"Location",value:"...",staticValue:()=>t.getCurrentVillage(),other:{editable:!0,attribute:"home_region",category:"demographics"}},{label:"Landmark",value:"..."},{label:"Guardian",value:"...",asyncValue:async e=>{const a=await Ee.getGuardianDetails(t.getID());return le.isEmpty(a)?(e.other.editable=!0,"Add"):(e.other.editable=!1,a.map(r=>" ".concat(r.name," (").concat(r.relationshipType,")")).join(" "))},click:()=>{c.value=!0},other:{editable:!1}},{label:"Init W(KG)",value:"...",asyncValue:()=>t.getInitialWeight()},{label:"Init H(CM)",value:"...",asyncValue:()=>t.getInitialHeight()},{label:"Init BMI",value:"...",asyncValue:()=>t.getInitialBMI()},{label:"init Preg",value:"...",condition:()=>t.isFemale(),asyncValue:()=>t.getInitialObs("Is patient pregnant","value_coded")},{label:"init Breastfeeding",value:"...",condition:()=>t.isFemale(),asyncValue:()=>t.getInitialObs("Is patient breast feeding","value_coded")},{label:"cur Preg",value:"...",condition:()=>t.isFemale(),asyncValue:async()=>await t.isPregnant()?"Yes":"No"},{label:"cur Breastfeeding",value:"...",condition:()=>t.isFemale(),asyncValue:async()=>await t.isBreastfeeding()?"Yes":"No"},{label:"TI",value:"...",asyncValue:()=>S.getFirstValueCoded(t.getID(),"Ever received ART")},{label:"Agrees to follow up",value:"...",asyncValue:()=>S.getFirstValueCoded(t.getID(),"Agrees to followup")},{label:"Reason for starting ART",value:"...",asyncValue:()=>S.getFirstValueCoded(t.getID(),"Reason for ART eligibility")},{label:"HIV test date",value:"...",asyncValue:async()=>{const e=await S.getFirstValueDatetime(t.getID(),"Confirmatory HIV test date");return e?G.toStandardHisDisplayFormat(e):""}},{label:"HIV test place",value:"...",asyncValue:()=>S.getFirstValueText(t.getID(),"Confirmatory HIV test location")},{label:"Date of starting first line ART",value:"...",asyncValue:async()=>{const e=await S.getFirstValueDatetime(t.getID(),"Date ART started");return e?G.toStandardHisDisplayFormat(e):""}},{label:"Pulmonary TB within the last 2 years",value:"...",init:async()=>{g.value=await S.getAllValueCoded(t.getID(),"Who stages criteria present")||[]},staticValue:()=>M("Tuberculosis (PTB or EPTB) within the last 2 years")},{label:"Extra pulmonary TB (EPTB)",value:"...",staticValue:()=>M("Extrapulmonary tuberculosis (EPTB)")},{label:"Pulmonary TB (current)",value:"...",staticValue:()=>M("Pulmonary tuberculosis (current)")},{label:"Kaposis sarcoma",value:"...",staticValue:()=>M("Kaposis sarcoma")}]}async function O(){for(const e of b.value){if(typeof e.init=="function")try{await e.init()}catch(a){e.value="Error occurred",console.error("Error initializing card item",e,a)}typeof e.condition=="function"?e.visible=e.condition():e.visible=!0,typeof e.asyncValue=="function"?e.asyncValue(e).then(a=>e.value=a||"").catch(a=>{e.value="Error occurred",console.error("Error loading async value for card item",e,a)}):typeof e.staticValue=="function"&&(e.value=e.staticValue())}}function q(){return h.value=!1,w.value=!0,H.getPatientVisits(t.getID(),!0).then(e=>{I.value=e.map(a=>[{val:G.toStandardHisDisplayFormat(a),actualDate:a},{val:"..."},{val:"..."},{val:"..."},{val:"..."},{val:"..."},{val:"..."},{btn:{label:"More"}}])}).finally(()=>{h.value=!0,w.value=!1})}function L(e){const a=r=>r.map(([p,u])=>"".concat(p," (").concat(u,")")).join("/");v.value=[{label:"Outcome",value:e.outcome},{label:"Outcome Date",value:e.outcome_date},{label:"Side effects",value:e.side_effects},{label:"Viral load",value:e.viral_load},{label:"Pills Brought",value:a(e.pills_brought)},{label:"Pills dispensed",value:a(e.pills_dispensed)},{label:"Visit by",value:e.visit_by},{label:"Regimen",value:e.regimen},{label:"Adherence",value:a(e.adherence)},{label:"TB Status",value:e.tb_status},{label:"Height (cm)",value:e.height},{label:"Weight (Kg)",value:e.weight},{label:"BMI",value:e.bmi},{label:"Is pregnant",value:e.isPregnant,visible:t.isFemale()},{label:"Is breastfeeding",value:e.isBreastfeeding,visible:t.isFemale()}]}async function Y(){w.value=!0;for(let e=0;e<I.value.length;++e){const a=I.value[e],r=a[0].actualDate,p=t.getID(),u=await j.getCurrentProgramInformation(p,r),T=await j.getMastercardDrugInformation(p,r),U=((T==null?void 0:T.pills_given)||[]).map(x=>"".concat(x.short_name||x.name," <b>(").concat(x.quantity||"?",")</b>")).join("<br/>");if(t.isFemale()){const x=await S.getFirstObs(p,"Is patient pregnant",r);x&&G.toStandardHisDisplayFormat(x.obs_datetime)===r&&x.value_coded;const Q=await S.getFirstObs(p,"Is patient breast feeding",r);Q&&G.toStandardHisDisplayFormat(Q.obs_datetime)===r&&Q.value_coded}a[1].val=u.weight,a[2].val=u.regimen,a[3].val=u.viral_load,a[4].val=u.tb_status,a[5].val=u.outcome.match(/Unk/i)?"Unknown":u.outcome,a[6].val=U,a[7].btn={label:"More",onClick:()=>J(u)}}w.value=!0}function J(e){L(e),f.value=!0}function m(){f.value=!1}function i(e){c.value=!1,O()}function R(e){c.value=!1,O()}async function P(e){var a;D.value=!1,((a=b.value)!=null?a:[]).find(r=>r.label==="ARV Number").value=e}return ne(()=>{B(),O(),q().then(()=>Y()).finally(()=>w.value=!1)}),(e,a)=>(d(),A(l(Te),null,{default:n(()=>[o(l(ce),null,{default:n(()=>[o(l(ue),null,{default:n(()=>[o(l(oe),{slot:"start"},{default:n(()=>[o(l(E),{onClick:a[0]||(a[0]=r=>e.$router.back())},{default:n(()=>[o(l(he),{icon:l(Ae)},null,8,["icon"])]),_:1})]),_:1}),o(l(ie),{class:"ion-text-center"},{default:n(()=>[...a[3]||(a[3]=[_("Patient Mastercard",-1)])]),_:1})]),_:1})]),_:1}),o(l(de),null,{default:n(()=>[o(l(Ne),null,{default:n(()=>[o(l(De),null,{default:n(()=>[(d(!0),y(F,null,$(C.value,(r,p)=>(d(),A(l(we),{"size-lg":"3","size-md":"4","size-sm":"12",key:p},{default:n(()=>[o(l(Re),null,{default:n(()=>[o(l(Se),null,{default:n(()=>[o(l(ke),null,{default:n(()=>[(d(!0),y(F,null,$(r,(u,T)=>(d(),A(l(Ce),{key:T},{default:n(()=>{var U;return[o(l(Z),null,{default:n(()=>[_(k(u.label),1)]),_:2},1024),(U=u==null?void 0:u.other)!=null&&U.editable&&u.click?(d(),A(l(E),{key:0,style:{"font-size":"1.2rem","font-weight":"bold"},fill:"clear",slot:"end",onClick:u.click},{default:n(()=>[_(k(u.value||"Edit"),1)]),_:2},1032,["onClick"])):(d(),A(l(Z),{key:1,style:{"font-weight":"bold"},slot:"end"},{default:n(()=>[_(k(u.value),1)]),_:2},1024))]}),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),w.value?(d(),A(l(Pe),{key:0,type:"indeterminate"})):z("",!0),s("table",Ke,[a[5]||(a[5]=s("thead",null,[s("tr",null,[s("th",null,"VISIT DATE"),s("th",null,"WEIGHT (Kg)"),s("th",null,"REG"),s("th",null,"VIRAL LOAD"),s("th",null,"TB STATUS"),s("th",null,"OUTCOME"),s("th",null,"PILLS DISPENSED"),s("th",null,"ACTIONS")])],-1)),h.value?(d(),y("tbody",We,[(d(!0),y(F,null,$(I.value,(r,p)=>(d(),y("tr",{key:p},[(d(!0),y(F,null,$(r,(u,T)=>(d(),y("td",{key:T},[u.val?(d(),y("span",{key:0,innerHTML:u.val},null,8,ze)):u.btn&&typeof(u==null?void 0:u.btn.onClick)=="function"?(d(),A(l(E),{key:1,onClick:u.btn.onClick},{default:n(()=>[_(k(u.btn.label),1)]),_:2},1032,["onClick"])):z("",!0)]))),128))]))),128))])):(d(),y("tbody",je,[(d(),y(F,null,$(6,r=>s("tr",{key:r},[...a[4]||(a[4]=[s("td",null,"...",-1),s("td",null,"...",-1),s("td",null,"...",-1),s("td",null,"...",-1),s("td",null,"...",-1),s("td",null,"...",-1),s("td",null,"...",-1),s("td",null,"...",-1)])])),64))]))]),o(l(re),{"is-open":f.value,onIonModalDidDismiss:m},{default:n(()=>[s("div",qe,[a[7]||(a[7]=s("h3",null,"Details",-1)),s("ul",null,[(d(!0),y(F,null,$(v.value,r=>(d(),y("li",{key:r.label},[s("strong",null,k(r.label)+":",1),_(" "+k(r.value),1)]))),128))]),o(l(E),{expand:"block",onClick:m},{default:n(()=>[...a[6]||(a[6]=[_("Close",-1)])]),_:1})])]),_:1},8,["is-open"]),o(xe,{isOpen:c.value,onClose:a[1]||(a[1]=r=>c.value=!1),onGuardianSelected:i,onWhenSaved:R},null,8,["isOpen"]),o(Ue,{isOpen:D.value,onClose:a[2]||(a[2]=r=>D.value=!1),onArvNumberSaved:P},null,8,["isOpen"])]),_:1})]),_:1}))}}),aa=fe(Ye,[["__scopeId","data-v-c750c358"]]);export{aa as default};
