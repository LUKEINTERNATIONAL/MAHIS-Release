import{D as te,d as se,r as c,aO as ae,c as ne,a as le,H as oe,O as re,f as w,J as i,l,u as s,a4 as ie,k as r,aS as ue,aP as de,e as A,m as R,dB as ce,E as me,Q as g,K as N,b2 as h,X as P,cP as O,bx as ve,c1 as M,c0 as x,N as T,bs as q,p as f,a7 as fe}from"./vendor-BiX5TTcL.js";import{x as $,a2 as K,t as E,U as pe,K as we,a3 as V,s as y,a4 as ge,a5 as he,a6 as Pe,a1 as ye,y as Ae,a7 as Ie,_ as Se}from"./index-fRmZltk6.js";import{i as Ce}from"./Img-CJEgX1Vr.js";import{p as _e,g as be}from"./userService-B5fJn0nv.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-CpWilqEc.js";const z=te("authStatusStore",{state:()=>({emrAuthenticated:!1,miumAuthenticated:!1,lastLoginAttempt:null,loginTimestamp:null,username:""}),getters:{isPartiallyAuthenticated:a=>a.emrAuthenticated||a.miumAuthenticated,isFullyAuthenticated:a=>a.emrAuthenticated&&a.miumAuthenticated,authenticationStatus:a=>a.emrAuthenticated&&a.miumAuthenticated?"full":a.emrAuthenticated||a.miumAuthenticated?"partial":"none",authenticatedSystems:a=>{const u=[];return a.emrAuthenticated&&u.push("EMR"),a.miumAuthenticated&&u.push("MIUM"),u},failedSystems:a=>{const u=[];return a.emrAuthenticated||u.push("EMR"),a.miumAuthenticated||u.push("MIUM"),u}},actions:{setEMRAuthenticated(a){this.emrAuthenticated=a,a&&(this.loginTimestamp=new Date)},setMIUMAuthenticated(a){this.miumAuthenticated=a},setUsername(a){this.username=a},recordLoginAttempt(){this.lastLoginAttempt=new Date},clearAuthStatus(){this.emrAuthenticated=!1,this.miumAuthenticated=!1,this.loginTimestamp=null,this.lastLoginAttempt=null,this.username=""},hasSystemAccess(a){return a==="EMR"?this.emrAuthenticated:this.miumAuthenticated}},persist:!0}),ke={class:"login-container"},Me={key:0,style:{"justify-content":"center",display:"block"}},xe={style:{"font-size":"15px"}},Ee={style:{"font-size":"12px",color:"#34af4d"}},Ue={key:1},Le={style:{"font-size":"15px"}},Re={key:0},Ne={style:{"text-align":"left"}},qe={class:"signup-link"},ze={key:1},De={style:{"text-align":"left"}},Fe={key:0,class:"password-requirements"},Be={class:"requirements-list"},Oe={class:"signup-link"},Te=se({__name:"Login",setup(a){const u=c(""),v=c(""),U=c(""),I=c(!1),p=c(!1),L=c("test"),m=c(new Ie),t=c({username:"",currentPassword:"",newPassword:"",confirmPassword:""}),S=c(!1),C=c(!1),_=c(!1),H=ae(),W=$(),D=ne(()=>t.value.username.trim()!==""&&t.value.currentPassword.trim()!==""&&t.value.newPassword.trim()!==""&&t.value.confirmPassword.trim()!==""&&K(t.value.newPassword)&&t.value.newPassword===t.value.confirmPassword&&t.value.newPassword!==t.value.currentPassword),j=async()=>{W.terminate(),await $().postData("SET_OFFLINE_PROGRAMS")},G=()=>{U.value=localStorage.getItem("core_version")||""},J=async()=>{const n=ye(),e=await be();e&&(n.setUserFacilityName(e.name),n.setFacilityLocation(e),localStorage.setItem("facility_code",e.code))},Q=async()=>{const n=await m.value.checkUserPrograms(void 0);n!=null&&n.programs&&Ae().setAuthorizedPrograms(n==null?void 0:n.programs)},b=()=>{p.value=!p.value,p.value&&(t.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""})},X=()=>{E("Help functionality to be implemented")},Y=async()=>{if(!D.value){E("Please complete all fields correctly"),E("Password must be at least 8 characters long and contain at least one uppercase letter, one lowercase letter, one number, and one special character.");return}try{const n=await m.value.requestLogin(t.value.currentPassword,t.value.username);if(n){const{authorization:e}=n,{token:d,user:o}=e;o&&(localStorage.setItem("apiKey",d),await pe.updateUser(o.user_id,{password:t.value.newPassword}),we("Password changed successfully!"),await m.value.requestLogin(t.value.newPassword,t.value.username),t.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""},p.value=!1,localStorage.setItem("apiKey",""))}}catch(n){n instanceof V?y("Current password is incorrect"):y("Error changing password: ".concat(n))}},Z=async()=>{const n=z();if(!u.value||!v.value)return{success:!1,error:null,validationError:!0};m.value.setUsername(u.value),n.setUsername(u.value);try{return await m.value.login(v.value),await J(),await Q(),await Pe(),await _e(),n.setEMRAuthenticated(!0),{success:!0,error:null}}catch(e){return n.setEMRAuthenticated(!1),{success:!1,error:e}}},ee=async()=>{const n=z();if(!u.value||!v.value)return{success:!1,error:null,validationError:!0};m.value.setUsername(u.value);try{return await m.value.loginToMIUM(v.value),n.setMIUMAuthenticated(!0),{success:!0,error:null}}catch(e){return n.setMIUMAuthenticated(!1),{success:!1,error:e}}},F=async()=>{const n=z();if(!u.value||!v.value){E("Complete form to log in");return}n.recordLoginAttempt();const[e,d]=await Promise.allSettled([Z(),ee()]),o=e.status==="fulfilled"&&e.value.success,B=d.status==="fulfilled"&&d.value.success;if(o)H.push("/home");else if(!o&&!B){const k=e.status==="fulfilled"?e.value.error:e.reason;k instanceof V?y("Invalid username or password"):k instanceof ge?(b(),y("Please change your password",5e4)):k instanceof he?(b(),y("Your password has expired. Please change your password",5e4)):y("".concat(k),5e4)}else!o&&B&&(e.status==="fulfilled"?e.value.error:e.reason)};return le(async()=>{localStorage.setItem("apiKey",""),await m.value.loadConfig(),G(),await j()}),(n,e)=>{const d=oe("ion-icon");return w(),re(s(fe),null,{default:i(()=>[l(s(ie),{class:"ion-padding login-page"},{default:i(()=>[r("div",ke,[l(s(ue),{style:{"background-color":"#fff"}},{default:i(()=>[l(s(de),null,{default:i(()=>[l(s(ce),{class:"login_img",src:s(Ce)("mw.png"),id:"logo"},null,8,["src"]),l(s(me),{class:"login-title"},{default:i(()=>[L.value==="development"||L.value==="test"?(w(),A("span",Me,[r("div",null,[e[10]||(e[10]=g(" MaHIS ",-1)),r("small",xe,"(v"+N(U.value)+")",1)]),r("div",Ee,"("+N(L.value)+")",1)])):(w(),A("span",Ue,[e[11]||(e[11]=g(" MaHIS ",-1)),r("small",Le,"(v"+N(U.value)+")",1)]))]),_:1}),p.value?R("",!0):(w(),A("div",Re,[r("span",Ne,[l(s(h),{value:u.value,onIonInput:e[0]||(e[0]=o=>u.value=o.target.value||""),type:"text",label:"Username",ref:"usernameRef","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:i(()=>[l(s(P),{slot:"end"},{default:i(()=>[l(d,{icon:s(O)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),l(s(h),{value:v.value,onIonInput:e[2]||(e[2]=o=>v.value=o.target.value||""),type:I.value?"text":"password",label:"Password",ref:"passwordRef","label-placement":"floating",fill:"outline",placeholder:"Enter Password",class:"input-fields",required:"",onKeydown:ve(F,["enter"])},{default:i(()=>[l(s(P),{slot:"end"},{default:i(()=>[l(d,{icon:I.value?s(M):s(x),onClick:e[1]||(e[1]=o=>I.value=!I.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"])]),l(s(T),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:F,class:"login-button"},{default:i(()=>[...e[12]||(e[12]=[g(" Login ",-1)])]),_:1}),r("p",qe,[e[13]||(e[13]=g(" For help click ",-1)),r("a",{href:"#",onClick:q(X,["prevent"])},"Here"),e[14]||(e[14]=g(" | ",-1)),r("a",{href:"#",onClick:q(b,["prevent"])},"Change Password")])])),p.value?(w(),A("div",ze,[e[17]||(e[17]=r("h3",{style:{"text-align":"center","margin-bottom":"20px",color:"#34af4d"}},"Change Password",-1)),r("span",De,[l(s(h),{value:t.value.username,onIonInput:e[3]||(e[3]=o=>t.value.username=o.target.value||""),type:"text",label:"Username","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:i(()=>[l(s(P),{slot:"end"},{default:i(()=>[l(d,{icon:s(O)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),l(s(h),{value:t.value.currentPassword,onIonInput:e[5]||(e[5]=o=>t.value.currentPassword=o.target.value||""),type:S.value?"text":"password",label:"Current Password","label-placement":"floating",fill:"outline",placeholder:"Enter Current Password",class:"input-fields",required:""},{default:i(()=>[l(s(P),{slot:"end"},{default:i(()=>[l(d,{icon:S.value?s(M):s(x),onClick:e[4]||(e[4]=o=>S.value=!S.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"]),l(s(h),{value:t.value.newPassword,onIonInput:e[7]||(e[7]=o=>t.value.newPassword=o.target.value||""),type:C.value?"text":"password",label:"New Password","label-placement":"floating",fill:"outline",placeholder:"Enter New Password",class:f(["input-fields",{"invalid-input":t.value.newPassword&&!s(K)(t.value.newPassword)}]),required:""},{default:i(()=>[l(s(P),{slot:"end"},{default:i(()=>[l(d,{icon:C.value?s(M):s(x),onClick:e[6]||(e[6]=o=>C.value=!C.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"]),l(s(h),{value:t.value.confirmPassword,onIonInput:e[9]||(e[9]=o=>t.value.confirmPassword=o.target.value||""),type:_.value?"text":"password",label:"Confirm New Password","label-placement":"floating",fill:"outline",placeholder:"Confirm New Password",class:f(["input-fields",{"invalid-input":t.value.confirmPassword&&t.value.newPassword!==t.value.confirmPassword}]),required:""},{default:i(()=>[l(s(P),{slot:"end"},{default:i(()=>[l(d,{icon:_.value?s(M):s(x),onClick:e[8]||(e[8]=o=>_.value=!_.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"])]),t.value.newPassword?(w(),A("div",Fe,[e[15]||(e[15]=r("p",{class:"requirements-title"},"Password Requirements:",-1)),r("ul",Be,[r("li",{class:f({valid:t.value.newPassword.length>=8})},"At least 8 characters",2),r("li",{class:f({valid:/[A-Z]/.test(t.value.newPassword)})},"One uppercase letter",2),r("li",{class:f({valid:/[0-9]/.test(t.value.newPassword)})},"One number",2),r("li",{class:f({valid:/[@#$%^&+=*!-]/.test(t.value.newPassword)})}," One special character (@#$%^&+=*!-) ",2),r("li",{class:f({valid:t.value.newPassword!==t.value.currentPassword&&t.value.currentPassword!==""})}," Different from current password ",2)])])):R("",!0),l(s(T),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:Y,class:"login-button",disabled:!D.value},{default:i(()=>[...e[16]||(e[16]=[g(" Change Password ",-1)])]),_:1},8,["disabled"]),r("p",Oe,[r("a",{href:"#",onClick:q(b,["prevent"])},"Back to Login")])])):R("",!0)]),_:1})]),_:1})])]),_:1})]),_:1})}}}),Ge=Se(Te,[["__scopeId","data-v-a6d94c27"]]);export{Ge as default};
