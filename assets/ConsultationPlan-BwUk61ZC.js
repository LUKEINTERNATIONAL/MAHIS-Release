import{d as Ne,ar as xe,cm as ke,r as n,a$ as p,c as Re,a as Le,w as m,y as V,f as R,z as L,l,e as Be,m as $,k as v,u as y,bN as Ee,d6 as Fe,ah as ze,i as h,bG as We,v as P,an as He,dJ as Me,bg as D}from"./vendor-CbvKnZbu.js";import{u as Ue,_ as Ve}from"./useFormWizard-BvJze18a.js";import{u as $e,aC as Ge,aT as Je,a3 as Ye,c as je,aE as qe,O as Ke,a4 as Qe,aU as Xe,aV as Ze,aI as et,T as tt,D as at,t as G,C as w,n as O,ab as st,E as nt,H as B,aF as b,aA as J,aW as Y,l as j,_ as ot}from"./index-DdD67sqo.js";import{D as it}from"./DemographicBar-BY8BC7t4.js";import{C as lt,O as rt,a as ct,b as ut}from"./OPDOutcome-BHYsld1O.js";import{I as mt,N as vt,S as q,a as pt,d as dt,b as ft}from"./NextAppointment-Djowyy5B.js";import{O as gt}from"./OPDPrintingModal-BgTnPIEU.js";import{l as ht}from"./lodash-Dt8AsbQm.js";import{u as Pt}from"./usePatientProfile-Dh5JyKI-.js";import"./apexcharts-BbGV9YyK.js";import"./patient_complaints_service-BHerNlg9.js";import"./DashBox-BkXXf4aJ.js";import"./useExposeFromStandardForm-3F3YPujq.js";import"./BasicForm-C2wF1F35.js";import"./DateInputField-CPswy8AW.js";import"./formatServerData-np9Kq0wl.js";import"./drug_prescription_service-BNr_uoL9.js";import"./drug_service-BajJAVaj.js";import"./Outcome-4rVaEiMK.js";import"./lab_order-C_n_yyvB.js";import"./group_validation-DlPpxiYk.js";import"./ncd_appointment_service-DZwoPokA.js";import"./Registration-Bg7okxUf.js";import"./useLocation-DoEhXxC_.js";import"./vaccines_service-BxLIjKKM.js";import"./sms_service-BvZ8iN5H.js";import"./EIRreportsStore-fi7L6-6-.js";import"./Export-gzpJbMsA.js";const Dt={key:0,class:"spinner-overlay"},yt={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},wt={class:"back_profile"},bt=Ne({__name:"ConsultationPlan",setup(St){const{currentTabIndex:d}=Ue("Consultation Plan"),{printVisitSummary:K}=Pt(),f=xe(),Q=ke(),T=n(!1),A=n(!0),E=n(!1),C=n(!1),I=n(!0),X=n(!1),_=n(!1),Z=n(!1),ee=$e(),te=Ge(),ae=Je(),se=Ye(),ne=je(),F=qe(),oe=Ke(),ie=Qe(),le=Xe(),re=Ze(),{patient:r}=p(ee),{investigations:ce}=p(te),{OPDdiagnosis:ue}=p(ae),{selectedMedicalDrugsList:me,nonPharmalogicalTherapyAndOtherNotes:z}=p(se),{OPDActivities:S}=p(ne),{outcomes:ve}=p(F),{currentSelectedNextAppointmentDate:pe}=p(le),{presentingComplaints:de}=p(re),{vitals:fe}=p(ie),ge=et();Re(()=>ge.selectedMedicalAllergiesList);const W=n(null),he=n(null),H=n(null),Pe=n(null),De=n(null),ye=n(null),N=n(null),M=()=>S.value.map(e=>({title:e,icon:""})),s=n(),we=n({}),be=async(e,t,i)=>{if(t===0&&await Ae(),!await U()){G("Please add presenting complaints before proceeding.");return}await c(),e%1===0&&(d.value=e),N.value&&i&&N.value.changeTab(e)},g=()=>{var i;if(!s.value||s.value.length===0)return null;const e=d.value>=0&&d.value<s.value.length?d.value:0;switch((i=s.value[e])==null?void 0:i.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(S.value.length>0)switch(S.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Se=()=>{f.push("home")},Oe=async()=>{C.value=!0,w("Printing consultation summary... Please wait.");try{await K(),w("Consultation summary printed successfully!"),setTimeout(()=>{f.push("home")},3500)}catch(e){O("Failed to print consultation summary.")}finally{C.value=!1}},Te=()=>{w("Patient has finished consultation!"),f.push("home")},U=async()=>{const e=await st.getObsByEncounterIdAndDate(nt.PRESENTING_COMPLAINTS);return!!(e&&e.length>0)},c=async()=>{var t,i;const e=B.sessionDate();for(let o=0;o<s.value.length;o++)if(!await U())A.value=!1,s.value[o].title!=="Clinical Assessment"&&(s.value[o].icon=Me);else{A.value=!0,E.value=!1;const u=s.value[o];if(we.value={title:"Untitled"},u.title==="Clinical Assessment"){const a=b("presentingComplaints");s.value[o].icon=x(e,a)?D:""}else if(u.title==="Investigations"){const a=(i=(t=r.value)==null?void 0:t.labOrders)==null?void 0:i.saved,k=a==null?void 0:a.filter(_e=>B.toStandardHisFormat(e)===B.toStandardHisFormat(_e.order_date));s.value[o].icon=(k==null?void 0:k.length)>0?D:""}else if(u.title==="Diagnosis"){const a=b("diagnosis");s.value[o].icon=x(e,a)?D:""}else if(u.title==="Treatment Plan"){const a=b("treatment");s.value[o].icon=(a==null?void 0:a.length)>0?D:""}else if(u.title==="Next Appointment"){const a=b("appointments");s.value[o].icon=x(e,a)?D:""}else if(u.title==="Outcome"){const a=b("outcomes");s.value[o].icon=(a==null?void 0:a.length)>0?D:""}}},x=(e,t)=>{if(!t)return!1;const i=new Date(e);return i.setHours(0,0,0,0),t.some(o=>{const u=new Date(o.obs_datetime||o.order_date);return u.setHours(0,0,0,0),u.getTime()===i.getTime()})},Ae=async()=>{var e;T.value=!0;try{await Promise.all([(e=W.value)==null?void 0:e.onSubmit()]),await J(r.value),Y()}catch(t){throw console.error("Error saving clinical assessment:",t),O("Failed to save clinical assessment"),t}finally{T.value=!1}},Ce=async()=>{try{if(!ht.isEmpty(z.value)){const e=[{concept_id:2688,obs_datetime:localStorage.getItem("sessionDate"),value_text:z.value,location_id:oe.facilityLocation.code}];await pt(e)}await dt(),await ft().saveNonPharmaTherapyPatientData()}catch(e){console.error("Failed to save treatment plan:",e),G("Failed to save treatment plan")}},Ie=async()=>{var e;try{(e=H.value)==null||e.onSubmit(),await Ce(),await F.saveOutcomPatientData(),await Y(),await J(r.value);const t=localStorage.getItem("locationID"),i=localStorage.getItem("userRoles");if(!t){O("Location ID could not be found. Please check your settings.");return}(i?JSON.parse(i):[]).some(a=>a.role==="Lab")?(await q.movePatientToNextStage(r.value.patientID,"LAB","CONSULTATION",t,r.value.visitID||r.value.visit_id),await j().refresh(t),await f.push("home"),w("Lab results submitted. Patient can return to consultation")):(await q.movePatientToNextStage(r.value.patientID,"CONSULTATION","DISPENSATION",t,r.value.visitID||r.value.visit_id),await j().refresh(t),await f.push("home"),w("Consultation patient saved successfully."))}catch(t){console.error("Error saving consultation data:",t),O("Failed to save consultation data")}};return Le(async()=>{if(S.value.length===0){await f.push("home");return}s.value=M(),await c(),(d.value===void 0||d.value<0)&&(d.value=0)}),m(fe,async()=>{await c()},{deep:!0}),m(r,async()=>{await c()},{deep:!0}),m(ce,async()=>{await c()},{deep:!0}),m(ue,async()=>{await c()},{deep:!0}),m(me,async()=>{await c()},{deep:!0}),m(ve,async()=>{await c()},{deep:!0}),m(pe,async()=>{await c()}),m(de,async()=>{await c()},{deep:!0}),m(Q,async()=>{I.value=!1,s.value=M(),setTimeout(()=>{d.value=0,I.value=!0},0)},{deep:!0}),m(Z,e=>{_.value=e,_.value&&setTimeout(()=>{_.value=!1},15e3)}),(e,t)=>(R(),V(y(He),null,{default:L(()=>[l(gt,{onYes:Oe,onNo:Te,isOpen:X.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),T.value?(R(),Be("div",Dt,[l(y(Ee),{name:"bubbles"}),t[2]||(t[2]=v("div",{class:"loading-text"},"Please wait...",-1))])):$("",!0),l(y(Fe),{"is-open":C.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(tt),l(y(ze),{fullscreen:!0},{default:L(()=>[l(it),v("div",yt,[I.value?(R(),V(Ve,{key:0,ref_key:"wizard",ref:N,"vertical-tabs":"","navigable-tabs":A.value,"scrollable-tabs":"",startIndex:0,doneButton:{text:"Finish",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},nextButton:{disabled:E.value},"custom-tabs":s.value,tabs:s.value,onChange:be,"onComplete:wizard":t[1]||(t[1]=i=>Ie())},{default:L(()=>[v("div",null,[v("div",wt,[l(at,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:y(We),"font-weight":"600",onClick:t[0]||(t[0]=i=>Se())},null,8,["icon"])])]),h(v("div",null,[l(lt,{ref_key:"clinicalAssessmentRef",ref:W},null,512)],512),[[P,g()==="ClinicalAssessment"]]),h(v("div",null,[l(mt,{ref_key:"investigationsRef",ref:he},null,512)],512),[[P,g()==="Investigations"]]),h(v("div",null,[l(rt,{ref_key:"diagnosisRef",ref:H},null,512)],512),[[P,g()==="OPDDiagnosis"]]),h(v("div",null,[l(ct,{ref_key:"treatmentPlanRef",ref:Pe},null,512)],512),[[P,g()==="OPDTreatmentPlan"]]),h(v("div",null,[l(vt,{ref_key:"nextAppointmentRef",ref:De},null,512)],512),[[P,g()==="NextAppointment"]]),h(v("div",null,[l(ut,{ref_key:"outcomeRef",ref:ye},null,512)],512),[[P,g()==="Outcome"]])]),_:1},8,["navigable-tabs","nextButton","custom-tabs","tabs"])):$("",!0)])]),_:1})]),_:1}))}}),Xt=ot(bt,[["__scopeId","data-v-95c10b91"]]);export{Xt as default};
