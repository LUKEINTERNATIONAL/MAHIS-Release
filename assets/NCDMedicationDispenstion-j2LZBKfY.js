var ue=Object.defineProperty;var pe=(e,t,n)=>t in e?ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var N=(e,t,n)=>pe(e,typeof t!="symbol"?t+"":t,n);import{d as E,I as j,W as q,bf as W,cm as ge,a_ as me,E as d,e as f,f as p,l as o,z as r,p as S,ab as X,ac as Y,T as Z,au as ee,V as te,S as ne,ao as se,ah as fe,cc as oe,X as _e,k as s,B as a,A as _,F as b,aj as he,al as A,ar as ye,U as ve,bg as be,ad as De,ae as we,af as Ce,ag as ke,dB as Me,cn as Pe,dC as Oe,aK as Ie,bG as Te,dD as $e,r as Ve,y as L,L as I,m as M}from"./vendor-IHO26Iap.js";import{E as R}from"./EIRreportsStore-DjJyrod0.js";import{N as Be}from"./NavigationMenu-SL_DIej6.js";import{_ as H,i as Se,P as Ne,S as Ae,u as ie,a0 as ze,k as x,aG as xe,a4 as F,o as G,aH as Fe,g as Ee,m as B,A as je,j as J,H as qe,h as He,l as Ue,a3 as Le}from"./index-tZ4yxjbt.js";import{a as re}from"./drug_prescription_service-CzDvBQ33.js";import{A as z}from"./app_encounter_service-BlDqlCwD.js";import"./lodash-Dt8AsbQm.js";import"./drug_service-DcuEfQyA.js";const Re=E({name:"ViewToggle",components:{IonButtons:W,IonButton:q,IonIcon:j},props:{initialView:{type:String,default:"list",validator:e=>["list","card"].includes(e)}},data(){return{currentView:this.initialView,listOutline:me,gridOutline:ge}},methods:{switchView(e){this.currentView=e,this.$emit("view-changed",e)}}}),Ge={class:"view-toggle-container"};function Je(e,t,n,i,l,c){const m=d("ion-icon"),h=d("ion-button"),u=d("ion-buttons");return p(),f("div",Ge,[o(u,{slot:"end",class:"toggle-buttons"},{default:r(()=>[o(h,{fill:"clear",class:S({active:e.currentView==="list"}),onClick:t[0]||(t[0]=w=>e.switchView("list"))},{default:r(()=>[o(m,{icon:e.listOutline,size:"large"},null,8,["icon"])]),_:1},8,["class"]),o(h,{fill:"clear",class:S({active:e.currentView==="card"}),onClick:t[1]||(t[1]=w=>e.switchView("card"))},{default:r(()=>[o(m,{icon:e.gridOutline,size:"large"},null,8,["icon"])]),_:1},8,["class"])]),_:1})])}const Ke=H(Re,[["render",Je],["__scopeId","data-v-3e7a5aa6"]]),Qe=E({name:"MedicationDetailsModal",components:{IonContent:se,IonHeader:ne,IonFooter:te,IonPage:ee,IonTitle:Z,IonRow:Y,IonCol:X,IonButton:q,IonIcon:j},props:{selectedMedication:{type:Object,default:null}},data(){return{iconsContent:Se,medkit:oe,closeIcon:fe,dismiss:()=>(this.$emit("close"),_e.dismiss())}},methods:{formatFullDate(e){return e?new Date(e).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"N/A"},getFrequencyLabel(e){const t=re.find(n=>n.code===e);return t?t.label:"Unknown"}}}),We={class:"medication-details-header"},Xe={class:"modal_wrapper"},Ye={class:"medication-details-modal"},Ze={class:"text-xl font-bold mb-4"},et={class:"grid grid-cols-2 gap-3"};function tt(e,t,n,i,l,c){const m=d("ion-icon"),h=d("ion-title"),u=d("ion-header"),w=d("ion-content"),D=d("ion-button"),T=d("ion-col"),$=d("ion-row"),P=d("ion-footer");return p(),f(b,null,[o(u,{style:{display:"flex","justify-content":"space-between"}},{default:r(()=>[o(h,{class:"modalTitle"},{default:r(()=>[s("div",We,[o(m,{icon:e.medkit,class:"ion-margin-end"},null,8,["icon"]),t[1]||(t[1]=s("span",null,"Medication Details",-1))])]),_:1}),o(m,{onClick:t[0]||(t[0]=V=>e.dismiss()),style:{"padding-top":"10px","padding-right":"10px"},icon:e.iconsContent.cancel},null,8,["icon"])]),_:1}),o(w,{fullscreen:!0,class:"ion-padding",style:{"--background":"#fff"}},{default:r(()=>[s("div",Xe,[s("div",Ye,[s("h2",Ze,a(e.selectedMedication.drug.name),1),s("div",et,[s("div",null,[t[2]||(t[2]=s("strong",null,"Order ID:",-1)),_(" "+a(e.selectedMedication.order_id),1)]),s("div",null,[t[3]||(t[3]=s("strong",null,"Drug ID:",-1)),_(" "+a(e.selectedMedication.drug_inventory_id),1)]),s("div",null,[t[4]||(t[4]=s("strong",null,"Dose:",-1)),_(" "+a(e.selectedMedication.dose)+" "+a(e.selectedMedication.units),1)]),s("div",null,[t[5]||(t[5]=s("strong",null,"Equivalent Daily Dose:",-1)),_(" "+a(e.selectedMedication.equivalent_daily_dose),1)]),s("div",null,[t[6]||(t[6]=s("strong",null,"Frequency:",-1)),_(" "+a(e.getFrequencyLabel(e.selectedMedication.frequency)),1)]),s("div",null,[t[7]||(t[7]=s("strong",null,"Order Type:",-1)),_(" "+a(e.selectedMedication.order.order_type_id),1)]),s("div",null,[t[8]||(t[8]=s("strong",null,"Start Date:",-1)),_(" "+a(e.formatFullDate(e.selectedMedication.order.start_date)),1)]),s("div",null,[t[9]||(t[9]=s("strong",null,"Date Created:",-1)),_(" "+a(e.formatFullDate(e.selectedMedication.order.date_created)),1)]),s("div",null,[t[10]||(t[10]=s("strong",null,"Orderer:",-1)),_(" "+a(e.selectedMedication.order.orderer),1)]),s("div",null,[t[11]||(t[11]=s("strong",null,"Instructions:",-1)),_(" "+a(e.selectedMedication.order.instructions),1)])])])])]),_:1}),o(P,{collapse:"fade",class:"ion-no-border"},{default:r(()=>[o($,null,{default:r(()=>[o(T,null,{default:r(()=>[o(D,{onClick:e.dismiss,color:"primary",style:{float:"right","margin-bottom":"20px","margin-right":"20px"}},{default:r(()=>[o(m,{icon:e.closeIcon,slot:"start"},null,8,["icon"]),t[12]||(t[12]=_(" Close "))]),_:1,__:[12]},8,["onClick"])]),_:1})]),_:1})]),_:1})],64)}const K=H(Qe,[["render",tt],["__scopeId","data-v-01db984e"]]);class Q extends z{constructor(n=null,i=null){const l=new Ne,c=n!==null?n:l.getID(),m=i!==null?i:Ae.getUserID();super(c,32,m);N(this,"drugHistory");N(this,"currentDrugOrder");this.drugHistory=[],this.currentDrugOrder=[]}getDrugHistory(){return this.drugHistory}getCurrentOrder(){return this.currentDrugOrder}getDispensationArryObj(n,i){return[{drug_order_id:n,date:this.date,quantity:i}]}saveDispensations(n,i){return z.postJson("/dispensations",{dispensations:n,provider_id:this.providerID,program_id:i})}generateOfflineDispensatiobObject(n,i){return{dispensations:n,provider_id:this.providerID,program_id:i,patient_id:this.patientID}}async saveDispensationsOffline(n){var i,l,c;try{const m=ie(),{patient:h}=he(m),u=JSON.parse(JSON.stringify(h.value));n.length>0&&((c=(l=(i=u.dispensations)!=null?i:u.dispensations={}).unsaved)!=null||(l.unsaved=[]),u.dispensations.unsaved.length>=0&&u.dispensations.unsaved.push(...n)),await ze(u,!1),x("Dispensations saved offline successfully")}catch(m){xe("Error saving dispensations offline"+m)}}async voidOrder(n){return z.void("/dispensations/".concat(n),{})}async loadDrugHistory(){const n=await F.getDrugOrderHistory(this.patientID);n&&(this.drugHistory=n)}async loadCurrentDrugOrder(){const n=await F.getDrugOrders(this.patientID);n&&(this.currentDrugOrder=await Promise.all(n))}calcCompletePack(n,i){const l=n.barcodes.sort(function(h,u){return h.tabs-u.tabs});if(l.length==0||i==0)return i;for(let h=0;h<=l.length-1;h++)if(parseInt(l[h].tabs)>=i)return l[h].tabs;const c=parseInt(l[0].tabs);let m=parseInt(l[l.length-1].tabs);for(;m<i;)m+=c;return m}}const nt=E({name:"MedicationDispensation",components:{IonContent:se,IonPage:ee,NavigationMenu:Be,IonCard:ke,IonCardHeader:Ce,IonCardTitle:we,IonCardContent:De,IonButton:q,IonModal:be,IonHeader:ne,IonToolbar:ve,IonTitle:Z,IonButtons:W,IonInput:ye,MedicationDetailsModal:K,IonRow:Y,IonCol:X,IonIcon:j,ViewToggleComponent:Ke,IonFooter:te},setup(){const e=Ve(null);return{navMenuRef:e,navigateBack:()=>{e.value&&e.value.goBackwards()}}},data(){return{medicationsByProgram:{},medications:[],selectedMedication:null,medkit:oe,repeat:$e,eye:Te,alertCircleOutline:Ie,checkmarkDoneCircleOutline:Oe,clipboardOutline:Pe,timeOutline:Me,currentView:"list",previousClinicalNotes:"",checkedIn:!1,showAsPrescribedBtn:!1,isOnline:!1}},computed:{...A(R,["navigationPayload"]),...A(ie,["patient"]),...A(G,["NCDMedicatioTogglePreference"]),medicationsByProgram(){return this.medications.reduce((e,t)=>{const n=t.program_id;return e[n]||(e[n]=[]),e[n].push(t),e},{})},groupedMedications(){return this.medications.reduce((e,t)=>{const n=t.order.date_created.split("T")[0];return e[n]||(e[n]=[]),e[n].push(t),e},{})}},async mounted(){this.initComp()},methods:{async initComp(){this.initTogglePreference(),this.medications=[],this.initOwnNavData(),await this.prescribedMedications(),this.enableShowAsPrescribedBtn()},async getPrograms(){return await this.getOfflinePrograms()},async printVisitSummary(){await new Le().printData("visit")},async closeVisit(){try{const e=await J.getCheckInStatus(this.patient.patientID);await J.checkOutPatient(e[0].id,qe.todayDateFormatted());const t=await He(),n=t?t.code:null;await Ue().refresh(n),this.checkedIn=!1,x("The patient's visit is now closed",5e4),this.navigateBack()}catch(e){console.error(e),B("An error occurred while closing the visit.",5e4),this.navigateBack()}},initOwnNavData(){R().setNavigationPayload("Dispense Medication",!0,!1,"/","home")},async prescribedMedications(){this.isOnline?(this.medications=await F.findProgramDrugOrdersAwaitingDispensation(this.patient.patientID),console.log(this.medications),this.medications=this.medications.map(e=>({...e,amountToDispense:e.amountToDispense||null,dispensed:e.dispensed||!1})),await this.groupMedicationsByProgram(this.medications)):await this.getPatientPrescribedMedications()},async getPatientPrescribedMedications(){try{const e=this.patient.dispensations.saved,t=this.patient.dispensations.unsaved,n=new Set;t.forEach(c=>{c.dispensations&&c.dispensations[0]&&c.dispensations[0].drug_order_id&&n.add(c.dispensations[0].drug_order_id)});const l=e.filter(c=>!n.has(c.order_id)).map(c=>({...c,amountToDispense:c.amountToDispense||null,dispensed:c.dispensed||!1}));await this.groupMedicationsByProgram(l)}catch(e){console.error("Error fetching offline medications:",e)}},async groupMedicationsByProgram(e){const t=await this.getPrograms(),n={};t.forEach(i=>{n[i.program_id]=i.name}),this.medicationsByProgram={},e.forEach(i=>{const l=n[i.program_id];l&&(this.medicationsByProgram[l]||(this.medicationsByProgram[l]=[]),this.medicationsByProgram[l].push(i))})},async getOfflinePrograms(){try{const e="",i=e?{name:"%".concat(e,"%")}:{};return await je("programs",{likeClause:i,currentPage:1,itemsPerPage:5e4}).then(c=>c.records)}catch(e){throw console.error("Error fetching offline districts:",e.message),e}},getFrequencyLabel(e){const t=re.find(n=>n.code===e);return t?t.label:"Unknown"},validateAmount(e){const t=parseFloat(e.amountToDispense);isNaN(t)||t<=0?e.error="Please enter a valid amount greater than 0.":e.error=null},setAmountAsPrescribed(e){e.amountToDispense=e.dose,this.validateAmount(e)},async dispenseMedication(e){if(e.error){B("Fix errors before dispensing.");return}try{const t=new Q,n=t.getDispensationArryObj(e.order_id,e.amountToDispense);if(this.isOnline)await t.saveDispensations(n,e.program_id),e.dispensed=!0,x("Medication dispensed successfully.");else{const i=new Q,l=i.generateOfflineDispensatiobObject(n,e.program_id);await i.saveDispensationsOffline([l]),e.dispensed=!0}}catch(t){B("Dispensing failed. Please try again."),B("Error: "+t),console.error(t)}},async viewDetails(e){this.selectedMedication=e,await Ee(K,{class:"large-modal"},!0,{selectedMedication:this.selectedMedication})},formatHeaderDate(e){return new Date(e).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})},handleViewChange(e){this.initTogglePreference(e,!0)},async enableShowAsPrescribedBtn(){const e=await Fe([14]);this.showAsPrescribedBtn=!e},initTogglePreference(e="list",t=!1){const n={toggle_view:e},i=G();Object.keys(this.NCDMedicatioTogglePreference).length===0&&(n.toggle_view="list",i.setNCDMedicatioTogglePreference(n)),Object.keys(this.NCDMedicatioTogglePreference).length>0&&t==!0&&i.setNCDMedicatioTogglePreference(n)},groupMedicationsByDate(e){return e.reduce((t,n)=>{const i=n.order.date_created.split("T")[0];return t[i]||(t[i]=[]),t[i].push(n),t},{})}},watch:{patient:{async handler(){this.initComp()},deep:!0},$route:{handler(e){e.name==="NCDDispensations"&&this.initComp()},immediate:!0}}}),st={key:0,style:{margin:"20px"},class:"flex flex-col items-center justify-center p-8"},ot={key:1,class:"p-4"},it={class:"text-xl font-bold mb-4 program-name"},rt={class:"overflow-x-auto"},at={class:"w-full"},lt={class:"p-3"},dt={class:"p-3"},ct={class:"flex items-center"},ut={class:"p-3"},pt={class:"p-3"},gt={class:"p-3"},mt={class:"flex items-center space-x-2"},ft={key:0,class:"error-text text-sm"},_t={class:"p-3"},ht={class:"flex space-x-2"},yt={key:0,class:"text-center py-8"},vt={key:2,class:"p-4"},bt={class:"text-xl font-bold mb-4 program-name"},Dt={class:"text-lg font-bold mb-2"},wt={class:"text-md font-medium"},Ct={class:"medication-details"},kt={class:"flex justify-between mb-3"},Mt={class:"flex items-center"},Pt={class:"flex items-center mb-3"},Ot={key:0,class:"error-text"},It={class:"mt-3 flex space-x-2"},Tt={key:0,class:"text-center mb-8"};function $t(e,t,n,i,l,c){const m=d("NavigationMenu"),h=d("ViewToggleComponent"),u=d("ion-icon"),w=d("ion-input"),D=d("ion-button"),T=d("ion-card-content"),$=d("ion-card"),P=d("ion-col"),V=d("ion-row"),ae=d("ion-card-title"),le=d("ion-card-header"),de=d("ion-content"),U=d("ion-footer"),ce=d("ion-page");return p(),L(ce,null,{default:r(()=>[o(m,{ref:"navMenuRef"},null,512),o(h,{"initial-view":e.NCDMedicatioTogglePreference.toggle_view,onViewChanged:e.handleViewChange},null,8,["initial-view","onViewChanged"]),o(de,null,{default:r(()=>[Object.keys(e.medicationsByProgram).length===0?(p(),f("div",st,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-4 text-gray-500"},null,8,["icon"]),t[2]||(t[2]=s("h2",{class:"text-xl font-semibold text-gray-700 mb-2"},"No Medications to Dispense",-1)),t[3]||(t[3]=s("p",{class:"text-gray-600"},"There are currently no medications waiting to be dispensed for current Client.",-1))])):e.NCDMedicatioTogglePreference.toggle_view==="list"?(p(),f("div",ot,[(p(!0),f(b,null,I(e.medicationsByProgram,(C,k)=>(p(),f(b,{key:k},[s("h2",it,a(k),1),o($,{class:"mb-6"},{default:r(()=>[o(T,null,{default:r(()=>[s("div",rt,[s("table",at,[t[6]||(t[6]=s("thead",null,[s("tr",{class:"bg-gray-100"},[s("th",{class:"p-3 text-left"},"Date"),s("th",{class:"p-3 text-left"},"Medication"),s("th",{class:"p-3 text-left"},"Dose"),s("th",{class:"p-3 text-left"},"Frequency"),s("th",{class:"p-3 text-left"},"Amount to Dispense"),s("th",{class:"p-3 text-left"},"Actions")])],-1)),s("tbody",null,[(p(!0),f(b,null,I(C,g=>(p(),f("tr",{key:g.order_id,class:"border-b hover:bg-gray-50"},[s("td",lt,a(e.formatHeaderDate(g.order.date_created.split("T")[0])),1),s("td",dt,[s("div",ct,[o(u,{icon:e.medkit,class:"mr-2"},null,8,["icon"]),_(" "+a(g.drug.name),1)])]),s("td",ut,a(g.dose)+" "+a(g.units),1),s("td",pt,a(e.getFrequencyLabel(g.frequency)),1),s("td",gt,[s("div",mt,[o(w,{type:"number",placeholder:"Amount",modelValue:g.amountToDispense,"onUpdate:modelValue":v=>g.amountToDispense=v,onInput:v=>e.validateAmount(g),class:S(["w-24 dose-input bordered-input",g.error?"input-error":""])},null,8,["modelValue","onUpdate:modelValue","onInput","class"]),M("",!0)]),g.error?(p(),f("div",ft,a(g.error),1)):M("",!0)]),s("td",_t,[s("div",ht,[o(D,{color:"primary",size:"small",onClick:v=>e.dispenseMedication(g),disabled:!g.amountToDispense||g.dispensed},{default:r(()=>[o(u,{icon:e.checkmarkDoneCircleOutline,class:"mr-1",style:{"margin-right":"5px"}},null,8,["icon"]),_(" "+a(g.dispensed?"Dispensed":"Dispense"),1)]),_:2},1032,["onClick","disabled"]),o(D,{color:"secondary",size:"small",onClick:v=>e.viewDetails(g),style:{"margin-left":"10px"}},{default:r(()=>[o(u,{icon:e.eye,class:"mr-1",style:{"margin-right":"5px"}},null,8,["icon"]),t[5]||(t[5]=_(" Details "))]),_:2,__:[5]},1032,["onClick"])])])]))),128))])]),C.length===0?(p(),f("div",yt,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-2"},null,8,["icon"]),s("p",null,"No medications prescribed for "+a(k),1)])):M("",!0)])]),_:2},1024)]),_:2},1024)],64))),128))])):(p(),f("div",vt,[(p(!0),f(b,null,I(e.medicationsByProgram,(C,k)=>(p(),f(b,{key:k},[s("h2",bt,a(k),1),(p(!0),f(b,null,I(e.groupMedicationsByDate(C),(g,v)=>(p(),f(b,{key:v},[s("h3",Dt,a(e.formatHeaderDate(v)),1),o(V,null,{default:r(()=>[o(P,{size:"12","size-md":"6","size-lg":"4"},{default:r(()=>[s("h3",wt,a(v),1)]),_:2},1024)]),_:2},1024),o(V,null,{default:r(()=>[(p(!0),f(b,null,I(g,y=>(p(),L(P,{key:y.order_id,size:"12","size-md":"6","size-lg":"4"},{default:r(()=>[o($,{class:"mb-4"},{default:r(()=>[o(le,null,{default:r(()=>[o(ae,{class:"medication-details-header"},{default:r(()=>[o(u,{icon:e.medkit,class:"ion-margin-end"},null,8,["icon"]),s("span",null,a(y.drug.name),1)]),_:2},1024)]),_:2},1024),o(T,null,{default:r(()=>[s("div",Ct,[s("div",kt,[s("span",Mt,a(e.getFrequencyLabel(y.frequency))+" ("+a(y.frequency)+") ",1)]),s("div",Pt,[o(w,{type:"number",placeholder:"Amount",modelValue:y.amountToDispense,"onUpdate:modelValue":O=>y.amountToDispense=O,onInput:O=>e.validateAmount(y),class:S(["w-24 dose-input bordered-input",y.error?"input-error":""])},null,8,["modelValue","onUpdate:modelValue","onInput","class"]),M("",!0)]),y.error?(p(),f("div",Ot,a(y.error),1)):M("",!0),s("div",It,[o(D,{color:"primary",onClick:O=>e.dispenseMedication(y),disabled:!y.amountToDispense||y.dispensed},{default:r(()=>[o(u,{icon:e.checkmarkDoneCircleOutline,class:"mr-2",style:{"margin-right":"5px"}},null,8,["icon"]),_(" "+a(y.dispensed?"Dispensed":"Dispense"),1)]),_:2},1032,["onClick","disabled"]),o(D,{color:"secondary",style:{"margin-left":"20px"},onClick:O=>e.viewDetails(y)},{default:r(()=>[o(u,{icon:e.eye,class:"mr-2",style:{"margin-right":"5px"}},null,8,["icon"]),t[8]||(t[8]=_(" Details "))]),_:2,__:[8]},1032,["onClick"])])])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)],64))),128)),C.length===0?(p(),f("div",Tt,[o(u,{icon:e.alertCircleOutline,size:"large",class:"mb-2"},null,8,["icon"]),s("p",null,"No medications prescribed for "+a(k),1)])):M("",!0)],64))),128))]))]),_:1}),o(U,{collapse:"fade",class:"ion-no-border"},{default:r(()=>[o(V,null,{default:r(()=>[o(P,null,{default:r(()=>[o(D,{id:"cbtn",class:"",color:"primary",fill:"solid",style:{float:"right","margin-left":"50px"},onClick:t[0]||(t[0]=C=>e.printVisitSummary())},{default:r(()=>t[9]||(t[9]=[_(" Print Visit Summary ")])),_:1,__:[9]}),o(D,{id:"cbtn",class:"",color:"danger",fill:"solid",style:{float:"right","margin-left":"50px"},onClick:t[1]||(t[1]=C=>e.closeVisit())},{default:r(()=>t[10]||(t[10]=[_(" Close visit ")])),_:1,__:[10]})]),_:1})]),_:1})]),_:1}),o(U)]),_:1})}const jt=H(nt,[["render",$t],["__scopeId","data-v-94ab8938"]]);export{jt as default};
