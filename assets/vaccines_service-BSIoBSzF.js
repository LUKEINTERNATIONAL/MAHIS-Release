var Lt=Object.defineProperty;var Ht=(e,t,n)=>t in e?Lt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var U=(e,t,n)=>Ht(e,typeof t!="symbol"?t+"":t,n);import{H as h,u as rt,S as D,a1 as J,k as ct,_ as lt,P as Bt,t as Z,g as dt,f as E,J as Ut,A as Zt,b as Yt}from"./index-53w8xEQj.js";import{l as jt}from"./lodash-Dt8AsbQm.js";import{R as qt,d as W,ab as v,W as Y,an as Wt,G as Gt,ac as N,X as j,E as O,e as q,f as k,l as m,k as y,z as u,A as w,F as ut,r as x,a as Xt,y as at,m as st,u as f,D as ot,B as V,da as Kt}from"./vendor-DowD5zKn.js";import{A as C}from"./app_encounter_service-DVUvyrB0.js";import{S as Qt}from"./sms_service-WlQuXEDs.js";import{A as te}from"./appointment_service-wufSmdwn.js";import{E as ee}from"./EIRreportsStore-CKI_NPUw.js";import{u as ne,F as it,e as ae}from"./Export-D8xjWPdU.js";const $=qt("immunizationAppointMentStore",{state:()=>({selectedAppointmentMent:[],selectedAppointmentMentForAppointmentsPage:"",AppointmentsReload:!1,startDate:h.sessionDate(),endDate:h.sessionDate()}),actions:{getAppointmentMents(){return this.selectedAppointmentMent},setAppointmentMent(e){this.selectedAppointmentMent.length=0,this.selectedAppointmentMent.push(e)},clearAppointmentMent(){this.selectedAppointmentMent.length=0},getSelectedAppointmentMentForAppointmentsPage(){return this.selectedAppointmentMentForAppointmentsPage},setSelectedAppointmentMentForAppointmentsPage(e){this.selectedAppointmentMentForAppointmentsPage=e},setAppointmentsReload(e){this.AppointmentsReload=e},getAppointmentsReload(){return this.AppointmentsReload},setStartEndDate(e,t){this.startDate=e,this.endDate=t},getStartEndDate(){return{startDate:this.startDate,endDate:this.endDate}}}});class T extends C{constructor(n){const a=n!==void 0?n:T.getPatientID(),r=T.getProviderID();super(a,7,r);U(this,"patientID");U(this,"providerID");this.patientID=a,this.providerID=r}static getPatientID(){return rt().patient.patientID}static getProviderID(){return D.getUserID()}async setPatientID(n){this.patientID=n}async createAppointment(n){var p;let a=JSON.parse(JSON.stringify(n));const r=[];$().selectedAppointmentMent.forEach(S=>{const I=h.toStandardHisFormat(S.date);r.push(I)});const l=await this.buildValueDate("Appointment date",r[0]);return(p=a==null?void 0:a.appointments.unsaved)==null||p.push(l),await J(a),ct("next Appointment Set Successfully"),r[0]}async getNextAppointment(){if(this.programID&&this.patientID)return C.getJson("/programs/".concat(this.programID,"/patients/").concat(this.patientID,"/next_appointment_date"),{date:this.date})}async getDailiyAppointments(n){const a=C.getProgramID();return C.getJson("/programs/".concat(a,"/booked_appointments"),{date:n,paginate:!1})}}const se=W({components:{IonRow:N,IonItem:Gt,IonList:Wt,IonButton:Y,IonCol:v},props:{date:{type:String,required:!0},patient:{type:Number,required:!0},modalaction:{type:String,required:!0}},data(){return{formattedDate:h.toStandardHisFormat(this.date)}},methods:{async dismissModal(){await j.dismiss()},async sendSMS(){await j.dismiss("send-SMS")}}}),oe={class:"saveBtn"};function ie(e,t,n,a,r,c){const l=O("ion-row"),p=O("ion-button"),S=O("ion-col");return k(),q(ut,null,[m(l,{class:"centered-content"},{default:u(()=>t[0]||(t[0]=[y("div",{class:"text-container"},[y("div",null,"Do you want to send SMS reminder?")],-1)])),_:1,__:[0]}),y("div",oe,[m(l,null,{default:u(()=>[m(S,null,{default:u(()=>[m(p,{onClick:e.dismissModal,id:"cbtn",class:"btnText cbtn",fill:"solid",style:{width:"130px"}},{default:u(()=>t[1]||(t[1]=[w(" No ")])),_:1,__:[1]},8,["onClick"])]),_:1}),m(S,null,{default:u(()=>[m(p,{onClick:e.sendSMS,class:"btnText",fill:"solid",style:{width:"130px","text-align":"right"}},{default:u(()=>t[2]||(t[2]=[w(" Yes ")])),_:1,__:[2]},8,["onClick"])]),_:1})]),_:1})])],64)}const re=lt(se,[["render",ie],["__scopeId","data-v-2bafd924"]]),ce={class:"lbl-ct"},le={class:"lbl-ct"},de={style:{"margin-right":"20px",color:"black"}},ue={key:0},me={style:{color:"#999"}},pe={style:{"font-size":"16px",color:"#666","margin-top":"5px"}},fe=W({watch:{},name:"xxxComponent"}),ge=W({...fe,props:{patient_Id:{},encounter_Id:{}},setup(e){const t=rt(),n=x(),a=x(),r=x(!1),c=x(!1),l=h.toStandardHisDisplayFormat(D.getSessionDate()),p=x(!1),S=x(),I=x(0),z=x([]),F=[];function pt(o){const s=new Date(D.getSessionDate());return s.setHours(0,0,0,0),o<s}const G=e;async function ft(){if($().selectedAppointmentMent.length>0)try{await xt();const i=await new T().createAppointment(t.patient);await _t(),await yt(),await K(),gt(i)}catch(s){}else Z("please select next appointment date on the calendar")}async function gt(o){if(z.value.length==0){Z("No phone numbers available for sms reminder!");return}if(o&&await dt(re,{class:"nationalIDModal"})=="send-SMS"){const i=JSON.parse(JSON.stringify(t.patient));i.sms={appointment_date:o},await J(i)}}async function _t(){const o=E();o.setVaccineReload(!o.getVaccineReload())}async function yt(){const o=$();o.setAppointmentsReload(!o.getAppointmentsReload())}Xt(async()=>{$().clearAppointmentMent(),await bt(),await ht()});async function ht(){try{const o=new Bt,s=G.patient_Id!==void 0?G.patient_Id:o.getID(),i=await wt(s);if(F.length>0){const d=F[F.length-1];await Dt(d,s)==!1&&(n.value=nt(d.vaccine.date_administered,et(i.age)),a.value=h.toStandardHisDisplayFormat(n.value),Q(n.value),tt(n.value),r.value=!0)}}catch(o){}}async function Dt(o,s){try{const i=new Date(t.patient.personInformation.birthdate),d=nt(i,et(o.age)),_=St(o.vaccine.date_administered),g=new Date(d);return console.log(X(_,g)),X(_,g)}catch(i){}}function St(o){const s={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"},i=o.split(/[:/ ]/),d="".concat(i[2],"-").concat(s[i[1]],"-").concat(i[0],"T").concat(i[3],":").concat(i[4],":").concat(i[5]);return new Date(d)}function X(o,s){const i=o.getFullYear(),d=o.getMonth(),_=o.getDate(),g=s.getFullYear(),A=s.getMonth(),M=s.getDate();return i!==g?i>g:d!==A?d>A:_>M}function vt(o){return o.forEach(s=>{s.antigens.forEach(i=>{i.status=="administered"&&F.push({age:s.age,vaccine:i})})}),F}async function wt(o){try{const s=t.patient.vaccineSchedule;vt(s.vaccine_schedule);for(const i of s.vaccine_schedule)if(i.milestone_status==="current"||i.milestone_status==="upcoming")return i;return null}catch(s){return null}}async function At(o){try{const s=await te.getDailiyAppointments(h.toStandardHisFormat(o),h.toStandardHisFormat(o));I.value=s.length}catch(s){}}async function K(){try{await j.dismiss()}catch(o){console.error("Modal dismissal error:",o)}}async function bt(){try{let o=await Qt.getConfigurations();c.value=o.show_sms_popup}catch(o){}}async function xt(){var i,d;const o=JSON.parse(JSON.stringify(t.patient.guardianInformation)),s=[...o==null?void 0:o.unsaved,...o==null?void 0:o.saved];s.length>0&&((i=s[0])!=null&&i.cell_phone_number)&&z.value.push((d=s[0])==null?void 0:d.cell_phone_number),t.patient.personInformation.cell_phone_number&&z.value.push(t.patient.personInformation.cell_phone_number)}async function Q(o){const s=$(),i={counter:1,date:o};s.setAppointmentMent(i),p.value=!1,await At(o),p.value=!0,S.value=h.toStandardHisDisplayFormat(o)}function tt(o){const i=$().getAppointmentMents(),d=A=>{const M=new Date(A);return M.setHours(0,0,0,0),M.getTime()},_=d(new Date(o)),g=i.find(A=>d(new Date(A.date))===_);return g?g.counter:null}function et(o){const s=/(\d+)\s*(week|month|year)s?/i,i=o.match(s);if(!i)return"Invalid input format";const d=parseInt(i[1]);switch(i[2].toLowerCase()){case"week":return d*7;case"month":return d*30;case"year":return d*365;default:return"Invalid time unit"}}function nt(o,s){if(s=="Invalid input format")return"";let i;if(o instanceof Date)i=new Date(o);else{const[b,B]=o.split(" "),[Ct,Ot,Pt]=b.split("/"),[Tt,Jt,zt]=B.split(":"),Rt={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};i=new Date(Number(Pt),Rt[Ot],Number(Ct),Number(Tt),Number(Jt),Number(zt))}i.setDate(i.getDate()+s);const d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],_=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],g=b=>String(b).padStart(2,"0"),A=d[i.getDay()],M=_[i.getMonth()],It=g(i.getDate()),Mt=i.getFullYear(),Vt=g(i.getHours()),Nt=g(i.getMinutes()),$t=g(i.getSeconds()),R=-i.getTimezoneOffset(),Ft=Math.floor(Math.abs(R)/60),kt=Math.abs(R)%60,Et="GMT".concat(R>=0?"+":"-").concat(g(Ft)).concat(g(kt)),L=Intl.DateTimeFormat().resolvedOptions().timeZone;let H;try{const b=new Intl.DateTimeFormat("en",{timeZone:L,timeZoneName:"long"}).formatToParts(i).find(B=>B.type==="timeZoneName");H=b?b.value:L}catch(b){console.error("Error getting localized time zone name:",b),H=L}return"Date ".concat(A," ").concat(M," ").concat(It," ").concat(Mt," ").concat(Vt,":").concat(Nt,":").concat($t," ").concat(Et," (").concat(H,")")}return(o,s)=>{const i=O("VueDatePicker");return k(),q(ut,null,[m(f(N),{style:{"margin-top":"10px"}},{default:u(()=>[m(f(v),{style:{"margin-left":"-3px"}},{default:u(()=>s[1]||(s[1]=[y("div",{class:"om",style:{"font-weight":"600",color:"#8d8686"}},"Set Next Appointment Date",-1)])),_:1,__:[1]}),m(f(v),{size:"6",style:{"text-align":"right"}},{default:u(()=>[m(f(ot),{class:"lbl-tl",style:{"font-size":"13"}},{default:u(()=>[s[2]||(s[2]=w(" Todays Date: ")),y("span",ce,V(f(l)),1)]),_:1,__:[2]})]),_:1})]),_:1}),m(f(N),{style:{"margin-top":"10px"}},{default:u(()=>[m(f(v),{style:{"margin-left":"-3px"}},{default:u(()=>s[3]||(s[3]=[y("div",{class:"om"},null,-1)])),_:1,__:[3]}),p.value?(k(),at(f(v),{key:0,size:"10",style:{"text-align":"right"}},{default:u(()=>[m(f(ot),{class:"lbl-tl",style:{"font-size":"16","font-weight":"500"}},{default:u(()=>[s[4]||(s[4]=w(" Total Appointments ")),y("span",le,"("+V(S.value)+")",1),s[5]||(s[5]=w(": ")),y("span",de,[m(f(Kt),{color:"primary",style:{"margin-bottom":"-5px","font-size":"15px"}},{default:u(()=>[w(V(I.value),1)]),_:1})])]),_:1,__:[4,5]})]),_:1})):st("",!0)]),_:1}),m(f(N),{style:{"margin-top":"20px"}},{default:u(()=>[m(f(v),null,{default:u(()=>[m(i,{modelValue:n.value,"onUpdate:modelValue":s[0]||(s[0]=d=>n.value=d),onDateUpdate:Q,"enable-time-picker":!1,inline:"","auto-apply":"","disabled-dates":pt},{day:u(({day:d,date:_})=>[(k(),q("p",ue,[w(V(d),1),y("sup",me,V(tt(_)),1)]))]),_:1},8,["modelValue"])]),_:1})]),_:1}),r.value?(k(),at(f(N),{key:0,style:{"margin-top":"0px","margin-bottom":"0px"}},{default:u(()=>[m(f(v),{style:{"background-color":"#f0f0f0",padding:"15px","border-radius":"8px","box-shadow":"0 2px 4px rgba(0, 0, 0, 0.1)"}},{default:u(()=>[s[6]||(s[6]=y("div",{style:{"font-size":"17px",color:"#333","font-weight":"bold"}},"Suggested Date:",-1)),y("div",pe,V(a.value),1)]),_:1,__:[6]})]),_:1})):st("",!0),m(f(N),{style:{"margin-top":"10px","margin-bottom":"10px"}},{default:u(()=>[m(f(v),null,{default:u(()=>[m(f(Y),{onClick:K,id:"cbtn",class:"btnText cbtn",fill:"solid",style:{width:"130px"}},{default:u(()=>s[7]||(s[7]=[w(" Cancel ")])),_:1,__:[7]})]),_:1}),m(f(v),{style:{"text-align":"right"}},{default:u(()=>[m(f(Y),{onClick:ft,class:"btnText",fill:"solid",style:{width:"130px"}},{default:u(()=>s[8]||(s[8]=[w(" save ")])),_:1,__:[8]})]),_:1})]),_:1})],64)}}}),_e=lt(ge,[["__scopeId","data-v-1d22c524"]]);async function Te(e){var a,r;const t=JSON.parse(JSON.stringify(e)),n=E();if(!jt.isEmpty(n.getAdministeredVaccines())){const c=De(),l=await Se();let p=t==null?void 0:t.vaccineAdministration;p.orders=[...p==null?void 0:p.orders,...c],p.voided=p.voided.filter(S=>{var I;return S.drug_name!==((I=c[0])==null?void 0:I.drug_name)}),p.obs=[...p==null?void 0:p.obs,...l],n.setVaccineReload(!n.getVaccineReload()),p.orders.length>0&&n.setLastVaccineAdminstredOnschedule(p.orders),mt(t,(a=c[0])==null?void 0:a.drug_name,"administered",(r=l[0])==null?void 0:r.obs_datetime),await J(t),ct("Saved successful"),await Ae(t)}}function mt(e,t,n,a){e.vaccineSchedule.vaccine_schedule.forEach(r=>{r.antigens.forEach(c=>{c.drug_name===t&&(c.status=n,c.date_administered=a)})})}async function Je(e,t){const n=await ye(e);return await he(new Date(t),n)}async function ye(e){try{let t=await Zt("genericVaccineSchedule");if(t.length>0){if(e=="M")return t[0].genericVaccineSchedule.male_schedule;if(e=="F")return t[0].genericVaccineSchedule.female_schedule}else if(Yt().apiStatus){if(t=await D.getJson("eir/schedule/generic",{paginate:!1}),e=="M")return t.male_schedule;if(e=="F")return t.female_schedule}}catch(t){return console.error("Error getting offline generic vaccine schedule",t),[]}}async function he(e,t){const n=new Date;return t.forEach(a=>{const r=a.age.toLowerCase();let c=null;if(r==="at birth")c=new Date(e);else if(r.includes("weeks")){const l=parseInt(r.split(" ")[0],10);c=new Date(e),c.setDate(e.getDate()+l*7)}else if(r.includes("months")){const l=parseInt(r.split(" ")[0],10);c=new Date(e),c.setMonth(e.getMonth()+l)}else if(r.includes("years")){const l=parseInt(r.split(" ")[0],10);c=new Date(e),c.setFullYear(e.getFullYear()+l)}c?c>n?a.milestone_status="upcoming":c.toDateString()===n.toDateString()?a.milestone_status="current":a.milestone_status="passed":a.milestone_status="unknown"}),{vaccine_schedule:t}}function De(){return E().getAdministeredVaccines().map(t=>{var n,a,r;return{drug_name:((a=(n=t==null?void 0:t.drug_)==null?void 0:n.drug)==null?void 0:a.drug_name)||((r=t==null?void 0:t.drug_)==null?void 0:r.drug_name),drug_inventory_id:t.drug_id,equivalent_daily_dose:1,start_date:t.date_administered,auto_expire_date:ve(t.date_administered,1),units:"ml",instructions:"",dose:1,frequency:"Unknown",batch_number:t.batch_number||"Unknown",prn:0}})}async function Se(){const t=E().getAdministeredVaccines();return await Promise.all(t.map(async a=>{var r,c,l;return{concept_id:2876,value_text:((c=(r=a==null?void 0:a.drug_)==null?void 0:r.drug)==null?void 0:c.drug_name)||((l=a==null?void 0:a.drug_)==null?void 0:l.drug_name),obs_datetime:a.date_administered}}))}function ve(e,t){const n=new Date(e);return n.setDate(n.getDate()+parseInt(t)),h.toStandardHisFormat(n)}function we(){dt(_e,{class:"otherVitalsModal"},!1)}async function Ae(e){var a,r;const t=E(),n=t.getLastVaccineAdminstredOnschedule();n.length>0&&((r=(a=e==null?void 0:e.vaccineSchedule)==null?void 0:a.vaccine_schedule)==null||r.forEach(c=>{be(c.antigens)==!0&&c.antigens.forEach(l=>{l.drug_id==n[0].drug_inventory_id&&we()})})),t.setLastVaccineAdminstredOnschedule([])}function be(e){return e.every(t=>t.status==="administered")}async function ze(e,t,n){const a=JSON.parse(JSON.stringify(e));let r=a==null?void 0:a.vaccineAdministration;r.orders.some(l=>l.drug_name===t.drug.drug_name)?(r.orders=r.orders.filter(l=>l.drug_name!==t.drug.drug_name),r.obs=r.obs.filter(l=>l.value_text!==t.drug.drug_name)):r.voided=[...r==null?void 0:r.voided,{reason:n,order_id:t.drug.order_id,drug_name:t.drug.drug_name}],mt(a,t.drug.drug_name,"pending",""),await J(a)}async function Re(e,t){return D.void("/encounters/".concat(e),{reason:t})}function Le(e){return xe(e.drug_name)==!0}function xe(e){const t=["Vit","Albendazole"],n=e.toLowerCase().split(/[\s,()]+/);return t.some(a=>a.toLowerCase().split(/[\s,()]+/).some(c=>n.some(l=>l.includes(c)||c.includes(l))))}async function He(){return await D.getJson("immunization/months_picker")}async function Be(e,t){return await D.getJson("immunization/vaccines_administered",{start_date:e,end_date:t})}async function Ue(e,t){return await D.getJson("immunization/aefi_report",{start_date:e,end_date:t})}async function Ze(){return await D.getJson("immunization/under_five_immunizations_drugs")}async function Ye(){return await D.getJson("/immunization/vaccine_names")}function P(e){return/[,"\n]/.test(e)?'"'.concat(e.replace(/"/g,'""'),'"'):e}function je(){try{const e=ee(),t=Ut(),{activePlatformProfile:n}=ne();let a=Ie(e.$state.immunizationMonthlyRepoartData);a+="\n",a+=Me(e.$state.AEFIReportData),a+="\n",a+="\n        Date Created: ".concat(new Date().toISOString().split("T")[0],"\n        Report Period: ").concat(e.$state.navigationPayload.subTxt,"\n        Site: ").concat(t.$state.userFacilityName);const r=new Blob([a],{type:"text/csv;charset=utf-8;"}),c="".concat(t.$state.userFacilityName,"_").concat(e.$state.navigationPayload.subTxt,"_").concat(e.$state.navigationPayload.title);if(n.value.fileExport===it.WEB){const l=document.createElement("a");l.href=window.URL.createObjectURL(r),l.setAttribute("download","".concat(c,".csv")),l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l)}else n.value.fileExport===it.FILE_SYSTEM?ae("".concat(c,".csv"),r,"blob"):Z("Platform not supported")}catch(e){console.error("Error exporting CSV:",e)}}function Ie(e){let t="Category,Static <1y,Static >1y,Outreach <1y,Outreach >1y\n";for(const n of e){const a=[P(n.label),n.fixed.lessThan1y,n.fixed.moreThan1y,n.outreach.lessThan1y,n.outreach.moreThan1y].join(",");t+=a+"\n"}return t}function Me(e){let t="Cases,"+e.vaccines.map(n=>P(n.name)).join(",")+"\n";for(const n of e.categories){t+=P(n.name)+"\n";for(const a of n.cases){const r=[P(a.name),...a.data.map(c=>c.count)];t+=r.join(",")+"\n"}}return t}export{T as A,re as a,ze as b,Le as c,He as d,Ye as e,Be as f,Je as g,je as h,Ze as i,Ue as j,_e as n,Te as s,$ as u,Re as v};
