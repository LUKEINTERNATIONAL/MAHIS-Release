import{d as W,V as Y,G as E,S as z,a9 as B,E as d,y as U,f as w,z as C,k as $,l as g,ar as o,bd as G,D as j,M as J,J as q,aZ as K,bH as Q,a_ as Z,aY as X,a$ as tt,W as et,cF as at,U as st,T as it,af as nt,bf as ot,r as rt,a2 as ct,cp as lt,e as L,m as k}from"./vendor-CKGLxZg5.js";import{D as pt,_ as H,y as ut,T as dt,ad as ht,S as p,t as u,H as D,I as T,f as mt,a0 as gt,j as m,a5 as b,aE as O,h as y,g as _,k as v,Q as Dt,aF as c,l as M,aG as ft,n as Pt,aH as St,a6 as yt,aI as vt,aJ as wt,V as It,a7 as bt,aK as Ot,aL as _t,aM as At,u as Ct,i as Lt,P as kt,W as Tt,Y as Mt}from"./index-kdr2EpoV.js";import{D as Ft}from"./DemographicBar-Bkyrgd4E.js";import{S as Nt}from"./SaveProgressModal-Bmx21qp2.js";import{S as Wt}from"./Stepper-Bb7aL__5.js";import{_ as Et,T as zt,h as Bt,k as Ut,j as $t,s as Ht}from"./Outcome-Cz0hWqGr.js";import{l as A}from"./lodash-Dt8AsbQm.js";import{D as Vt}from"./diagnosis-CWAR8yoz.js";import{c as F,a as P,f as N}from"./formatServerData-DnvR1Luh.js";import{P as xt}from"./patient_complaints_service-CKrCzPBs.js";import{A as I}from"./app_encounter_service-98GsPszC.js";import{B as Rt}from"./BasicFooter-CJh4R2SW.js";import{_ as Yt}from"./SetEncounter.vue_vue_type_script_lang-DuMOkf9E.js";import{O as Gt}from"./OPDPrintingModal-C1PTrxbT.js";import{u as jt}from"./usePatientProfile-C3oyWASy.js";import"./SvgDynamicColor-CvZStkge.js";import"./StandardForm.vue_vue_type_script_setup_true_lang-CyskiRBJ.js";import"./useExposeFromStandardForm-XnUzMZ5A.js";import"./BasicForm-dBPc1w0c.js";import"./DateInputField-BI5B_HHR.js";import"./patient_lab_service-FAs5iCQJ.js";import"./ncd_appointment_service-ClUVt5R9.js";import"./clinicalDaysStore-B8mFLyXf.js";import"./UpcomingFeature-p5E4b7gx.js";import"./previousVitals-Cly_UMjM.js";import"./apexcharts-PU4wsIkv.js";import"./group_validation-BYo3r3jn.js";import"./drug_prescription_service-BMD2w0jG.js";import"./drug_service-Wq0jWaOR.js";import"./appointment_service-CRplC5P0.js";import"./FeatusModal-tUBOBFvn.js";import"./vitals_service-LAVtP2ig.js";import"./SelectFacility-PwLGtT0p.js";import"./patient_registration_service-CqqQR6LP.js";import"./relationship_service-BpAceGHn.js";import"./relations_service-DCqjFL58.js";import"./FollowUpStore-CwHt0KCb.js";import"./BirthRegistration.vue_vue_type_script_setup_true_lang-hZti_n8U.js";import"./vaccines_service-CbixEgRR.js";import"./sms_service-pu0o93Nu.js";import"./EIRreportsStore-zKv7S2eM.js";import"./Export-D4js6FKi.js";import"./index-DQ-GnhlI.js";class Jt extends I{constructor(e,a){super(e,111,a)}}class qt extends I{constructor(e,a){super(e,30,a)}}class Kt extends I{constructor(e,a){super(e,141,a)}}class Qt extends I{constructor(e,a){super(e,28,a)}}const Zt=W({name:"Menu",components:{IonContent:B,IonHeader:z,IonItem:E,IonFooter:Y,DynamicButton:pt},data(){return{}},props:{status:{type:Boolean,default:!0},name:{type:String,default:"Save and end visit"}},methods:{}}),Xt={class:"button-container"};function te(t,e,a,s,n,h){const f=d("DynamicButton"),i=d("ion-footer");return w(),U(i,{translucent:!0,class:"ion-no-border"},{default:C(()=>[$("div",Xt,[g(f,{name:t.name,iconSlot:"end",onClick:e[0]||(e[0]=l=>t.$emit("finishBtn"))},null,8,["name"])])]),_:1})}const ee=H(Zt,[["render",te],["__scopeId","data-v-e844e8f2"]]),ae=W({name:"ConsultationPlan",mixins:[Et,Yt],components:{OPDPrintingModal:Gt,CheckInConfirmationModal:ht,IonContent:B,IonHeader:z,IonMenuButton:ot,IonPage:nt,IonTitle:it,IonToolbar:st,IonLoading:at,Toolbar:dt,ToolbarSearch:ut,DemographicBar:Ft,IonButton:et,IonCard:tt,IonCardContent:X,IonCardHeader:Z,IonCardSubtitle:Q,IonCardTitle:K,IonAccordion:q,IonAccordionGroup:J,IonItem:E,IonLabel:j,IonModal:G,Stepper:Wt,BasicFooter:Rt,OPDFooter:ee},data(){return{openStepper:"1",wizardData:[],StepperData:[],isOpen:!1,hasPatientsWaitingForLab:!1,iconsContent:Lt,isLoading:!1,isLoadingPrinter:!1,patients:[],showAlert:!1,checkedIn:!1,printModalOpen:!1}},props:{list:{default:""}},computed:{...o(Ct,["patient"]),...o(At,["pregnancy"]),...o(_t,["presentingComplaints"]),...o(Ot,["pastMedicalHistory"]),...o(bt,["vitals"]),...o(It,["investigations"]),...o(wt,["OPDdiagnosis"]),...o(vt,["physicalExam"]),...o(yt,["selectedMedicalDrugsList","nonPharmalogicalTherapyAndOtherNotes","selectedMedicalAllergiesList"]),...o(St,["adult","minor"]),...o(b,["outcomes"]),...o(Pt,["OPDActivities"]),...o(v,["patientsWaitingForVitals","patientsWaitingForConsultation","patientsWaitingForLab","patientsWaitingForDispensation","counter"]),...o(ft,["currentSelectedNextAppointmentDate"])},async created(){},async mounted(){await this.getData(),await this.fetchPatientLabStageData(),this.markWizard()},watch:{patientsWaitingForLab(t){this.hasPatientsWaitingForLab=t.some(e=>e.patient_id===this.patient.patientID),this.showAlert=this.hasPatientsWaitingForLab,this.showAlert&&setTimeout(()=>{this.showAlert=!1},15e3)},vitals:{handler(){this.markWizard()},deep:!0},$route:{async handler(){await this.getData(),this.markWizard(),this.fetchPatientLabStageData(),this.hasPatientsWaitingForLab=!1},deep:!0},investigations:{handler(){this.markWizard()},deep:!0},OPDdiagnosis:{handler(){this.markWizard()},deep:!0},selectedMedicalDrugsList:{handler(){this.markWizard()}},outcomes:{handler(){this.markWizard()}},currentSelectedNextAppointmentDate:{handler(){this.markWizard()}},hasPatientsWaitingForLab:{immediate:!0,handler(t){}}},setup(){const{printVisitSummary:t}=jt(),e=rt([]);async function a(i){const l=new kt,r=await Tt.getEncounters(l.getID(),{date:i});await s(r)}async function s(i){var l;try{const r=(l=i.find(S=>S.type.name==="PRESENTING COMPLAINTS"))==null?void 0:l.observations;r?e.value=await h(n(r,"Presenting complaint"),"coded"):e.value=[]}catch(r){console.error("Error setting presenting complaints encounters:",r)}}async function n(i,l){return i==null?void 0:i.filter(r=>r.concept.concept_names.some(S=>S.name===l))}async function h(i,l){return i.length>0?Promise.all(i.map(async r=>await Mt.getConceptName(r.value_coded))):[]}return(async()=>{const i=new Date().toISOString().split("T")[0];await a(i)})(),{presentingComplaintsValue:e,printVisitSummary:t,loadSavedEncounters:a,chevronBackOutline:lt,checkmark:ct}},methods:{endConsultation(){},togglePrintModal(){this.printModalOpen=!this.printModalOpen},closeCheckInModal(){this.printModalOpen=!1},async printYes(){this.isLoadingPrinter=!0,m("Printing consultation summary... Please wait.");try{await this.printVisitSummary(),m("Consultation summary printed successfully!"),setTimeout(()=>{this.$router.push("home")},3500)}catch(t){M("Failed to print consultation summary.")}finally{this.isLoadingPrinter=!1}},async printNo(){m("Patient has finished consultation!"),this.$router.push("home")},getSaveFunction(t){if(t<this.StepperData.length-1)switch(t){case 0:return this.presentingComplaintsValue.length===0?this.saveClinicalAssessment:()=>Promise.resolve();case 1:return()=>Promise.resolve();case 2:return()=>Promise.resolve();case 3:return()=>Promise.resolve();default:return()=>Promise.resolve()}else return async()=>{await this.saveDiagnosis(),await this.saveTreatmentPlan(),await b().saveOutcomPatientData(),O();const e=await _(),a=e?e.code:null;if(!a){M("Location ID could not be found. Please check your settings.");return}this.userRole!=="Lab"?(await y.addPatientToStage(this.patient.patientID,D.todayDateFormatted(),"DISPENSATION",a),await v().refresh(a),this.$router.push("home"),m("Patient has finished consultation!")):(await y.addPatientToStage(this.patient.patientID,D.todayDateFormatted(),"CONSULTATION",a),await v().refresh(a),this.$router.push("home"),m("Lab results submitted. Patient can return to consultation"))}},async fetchPatientLabStageData(){const t=await _(),e=t?t.code:null;if(e){const a=await y.getPatientList("LAB",e);this.patient.patientID&&(this.hasPatientsWaitingForLab=a.some(s=>s.patient_id===this.patient.patientID))}},setList(){const t={VITALS:this.patientsWaitingForVitals,CONSULTATION:this.patientsWaitingForConsultation,LAB:this.patientsWaitingForLab,DISPENSATION:this.patientsWaitingForDispensation};this.patients=t[this.list]||[]},async getData(){try{this.wizardData=[],this.StepperData=[];for(let t=0;t<this.OPDActivities.length;t++){let e="common_step";this.OPDActivities[t]=="Clinical Assessment"&&(this.openStepper=t+1),this.OPDActivities[t]=="Investigations"&&(this.openStepper=t+1),this.OPDActivities[t]=="Diagnosis"&&(this.openStepper=t+1),this.OPDActivities[t]=="Treatment Plan"&&(this.openStepper=t+1),this.OPDActivities[t]=="Outcome"&&(this.openStepper=t+1);let a=this.OPDActivities[t],s=this.OPDActivities[t];this.OPDActivities[t]=="Diagnosis"&&(s="OPDDiagnosis"),this.OPDActivities[t]=="Treatment Plan"&&(s="OPDTreatmentPlan");const n=t+1;this.wizardData.push({title:a,class:e,checked:t===0?!1:"",disabled:!1,number:n,last_step:t===this.OPDActivities.length-1?"last_step":""}),this.StepperData.push({title:a,component:s.replace(/\s+/g,""),value:n.toString()})}}catch(t){console.error(t)}},markWizard(){this.presentingComplaints?c(this.wizardData,"Clinical Assessments",{checked:!0,class:"open_step common_step"}):c(this.wizardData,"Clinical Assessments",{checked:!1}),this.investigations[0].selectedData.length>0?c(this.wizardData,"Investigations",{checked:!0,class:"open_step common_step"}):c(this.wizardData,"Investigations",{checked:!1}),this.OPDdiagnosis[0].selectedData.length>0?c(this.wizardData,"Diagnosis",{checked:!0,class:"open_step common_step"}):c(this.wizardData,"Diagnosis",{checked:!1}),this.selectedMedicalDrugsList.length>0?c(this.wizardData,"Treatment Plan",{checked:!0,class:"open_step common_step"}):c(this.wizardData,"Treatment Plan",{checked:!1}),this.currentSelectedNextAppointmentDate?c(this.wizardData,"Next Appointment",{checked:!0,class:"open_step common_step"}):c(this.wizardData,"Next Appointment",{checked:!1}),this.outcomes.length>0?c(this.wizardData,"Outcome",{checked:!0,class:"open_step common_step"}):c(this.wizardData,"Outcome",{checked:!1})},getFormatedData(t){return t.map(e=>(e==null?void 0:e.data[0])||(e==null?void 0:e.data))},async saveClinicalAssessment(){this.isLoading=!0;try{const t=await Dt.getAll(this.patient.patientID,"Presenting complaint");let e=[];if(t&&(e=t.filter(a=>D.toStandardHisFormat(D.sessionDate())===D.toStandardHisFormat(a.obs_datetime))),this.presentingComplaints[0].selectedData.length>0||e.length>0)await this.saveConsciousness(),await this.savePresentingComplaints(),await this.saveWomenStatus(),await this.savePastMedicalHistory(),await this.saveAllergies(),await this.savePhysicalExam(),O();else{u("Patient complaints are required");return}}catch(t){}finally{this.isLoading=!1}},async saveData(){try{await this.saveDiagnosis(),await this.saveTreatmentPlan(),await b().saveOutcomPatientData(),O();const t=await y.getCheckInStatus(this.patient.patientID);await y.checkOutPatient(t[0].id,D.todayDateFormatted());const e=await _(),a=e?e.code:null;await v().refresh(a),this.checkedIn=!1}catch(t){}this.togglePrintModal()},async savePastMedicalHistory(){const t=await this.buildPastMedicalHistory(),e=p.getUserID();if(t.length>0){const a=new qt(this.patient.patientID,e);if(!await a.createEncounter())return u("Unable to create past medical history encounter");if(!await a.saveObservationList(t))return u("Unable to create past medical history!");m("Past medical history has been created")}},async savePresentingComplaints(){if(this.presentingComplaints[0].selectedData.length>0){const t=p.getUserID(),e=new xt(this.patient.patientID,t);if(!await e.createEncounter())return u("Unable to create patient complaints encounter");if(!await e.saveObservationList(this.getFormatedData(this.presentingComplaints[0].selectedData)))return u("Unable to create patient complaints  !");m("Patient complaints has been created")}this.presentingComplaints[0].selectedData},async savePhysicalExam(){const t=await this.buildPhysicalExamination();if(t.length>0){const e=p.getUserID(),a=new Qt(this.patient.patientID,e);if(!await a.createEncounter())return u("Unable to create patient physical examination encounter");if(!await a.saveObservationList(t))return u("Unable to create patient physical examination  !");m("Physical examination has been created")}},async saveWomenStatus(){const t=await P(this.pregnancy);if(t.length>0){const e=p.getUserID(),a=new Jt(this.patient.patientID,e);if(!await a.createEncounter())return u("Unable to create pregnant Status encounter");if(!await a.saveObservationList(t))return u("Unable to create pregnant Status !");m("Pregnant Status has been created")}},async saveDiagnosis(){var t,e,a,s;if(this.OPDdiagnosis[0].selectedData.length>0){const n=p.getUserID(),h=new Vt,f=this.getFormatedData(this.OPDdiagnosis[0].selectedData);console.log(this.patient),(s=(a=(e=(t=this.patient).diagnosis)!=null?e:t.diagnosis={}).unsaved)!=null||(a.unsaved=[]),this.patient.diagnosis.unsaved.push(...f),await gt(this.patient),await h.onSubmit(this.patient.patientID,n,this.getFormatedData(this.OPDdiagnosis[0].selectedData))}this.OPDdiagnosis[0].selectedData=[]},async saveAllergies(){if(p.getUserID(),this.patient.patientID,!A.isEmpty(this.selectedMedicalAllergiesList)){const t=this.mapToAllergies();Ht(t)}},async saveTreatmentPlan(){const t=p.getUserID(),e=this.patient.patientID,a=new zt;if(!A.isEmpty(this.selectedMedicalAllergiesList)){const s=this.mapToAllergies();a.onSubmitAllergies(e,t,s)}if(!A.isEmpty(this.nonPharmalogicalTherapyAndOtherNotes)){const s=T(),n=[{concept_id:2688,obs_datetime:p.getSessionDate(),value_text:this.nonPharmalogicalTherapyAndOtherNotes,location_id:s.facilityLocation.code}];await Bt(n)}Ut(),await $t().saveNonPharmaTherapyPatientData()},saveInvestigations(){},openModal(){mt(Nt)},mapToAllergies(){const t=T();return this.selectedMedicalAllergiesList.map(e=>({concept_id:985,obs_datetime:p.getSessionDate(),value_coded:e.concept_id,location_id:t.facilityLocation.code}))},async buildPastMedicalHistory(){return[...await F(this.pastMedicalHistory),...await P(this.pastMedicalHistory),...await N(this.pastMedicalHistory)]},async saveConsciousness(){if((await P(this.adult)).length>0){const e=p.getUserID(),a=new Kt(this.patient.patientID,e);if(!await a.createEncounter())return u("Unable to create patient complaints encounter");const n=D.getAgeInYears(this.patient.personInformation.birthdate);let h;n<18?h=await P(this.minor):h=await P(this.adult),await a.saveObservationList(h)}},async buildPhysicalExamination(){return[...await F(this.physicalExam),...await P(this.physicalExam),...await N(this.physicalExam)]}}}),se={key:0,class:"spinner-overlay"},ie={key:1,class:"pause-alert"};function ne(t,e,a,s,n,h){const f=d("OPDPrintingModal"),i=d("ion-spinner"),l=d("ion-loading"),r=d("Toolbar"),S=d("DemographicBar"),V=d("Stepper"),x=d("ion-content"),R=d("ion-page");return w(),U(R,null,{default:C(()=>[g(f,{onYes:t.printYes,onNo:t.printNo,isOpen:t.printModalOpen,title:"Do you want to print the consultation summary?"},null,8,["onYes","onNo","isOpen"]),t.isLoading?(w(),L("div",se,[g(i,{name:"bubbles"}),e[0]||(e[0]=$("div",{class:"loading-text"},"Please wait...",-1))])):k("",!0),g(l,{"is-open":t.isLoadingPrinter,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),g(r),g(x,{fullscreen:!0},{default:C(()=>[g(S),g(V,{stepperTitle:t.userRoleSettings.stepperTitle,wizardData:t.wizardData,onUpdateStatus:t.markWizard,StepperData:t.StepperData,openStepper:t.openStepper,backUrl:t.userRoleSettings.url,backBtn:t.userRoleSettings.btnName,getSaveFunction:t.getSaveFunction,hasPatientsWaitingList:t.hasPatientsWaitingForLab,specialButtonLabel:"save & end visit",specialButtonFn:t.saveData,userRole:t.userRole},null,8,["stepperTitle","wizardData","onUpdateStatus","StepperData","openStepper","backUrl","backBtn","getSaveFunction","hasPatientsWaitingList","specialButtonFn","userRole"])]),_:1}),(t.userRole==="Clinician"||t.userRole==="Superuser")&&t.showAlert?(w(),L("div",ie," Consultation for this patient is paused due to lab orders. ")):k("",!0)]),_:1})}const qe=H(ae,[["render",ne],["__scopeId","data-v-13a9186a"]]);export{qe as default};
