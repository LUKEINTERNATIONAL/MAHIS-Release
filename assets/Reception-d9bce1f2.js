var Ge=Object.defineProperty;var De=(R,y,m)=>y in R?Ge(R,y,{enumerable:!0,configurable:!0,writable:!0,value:m}):R[y]=m;var fe=(R,y,m)=>(De(R,typeof y!="symbol"?y+"":y,m),m);import{d as we,aQ as Se,r as u,c as ee,w as Ie,E as Ae,e as c,y as k,z as s,l as n,x as a,U as $e,R as Te,S as Fe,A as d,V as ae,aa as qe,j as o,G as Le,b7 as Me,I as _e,cx as Ue,f as C,F as Pe,J as Oe,B,m as S,be as Be,aL as ge,aM as Z,D as h,bj as Ee,p as He,bm as Ye,b0 as Je,d1 as O,d2 as ie,i as je,bc as ze}from"./vendor-65256339.js";import{A as Qe,f as Ce,u as Re,B as be,d as We,a as he,t as G,g as Ke,R as ye,b as xe,_ as Ve,h as Xe,S as Ne}from"./index-d92f7182.js";import{P as Ze}from"./patient_type_service-caa9c9ba.js";import"./lodash-7be49fbd.js";import"./apexcharts-583f3fdc.js";import"./chartjs-bbe0813a.js";import"./barcode-qrcode-reader-d9469be9.js";class ea extends Qe{constructor(m,A,b){super(m,51,A,b);fe(this,"sitePrefix");this.sitePrefix=""}getSitePrefix(){return this.sitePrefix}createArvNumber(m){return Ce.postJson("/patient_identifiers/",{patient_id:this.patientID,identifier_type:4,identifier:m})}buildArvNumber(m){return"".concat(this.sitePrefix,"-ARV-").concat(m)}}const aa={class:"form-container"},ta={class:"search-section"},sa={key:0,class:"search-results"},la={key:0,class:"search-loading"},na={key:1},oa=["onClick"],ra={class:"pagination"},ia=["disabled"],ua={class:"page-info"},da=["disabled"],va={key:2,class:"no-results"},ca={class:"no-results-content"},pa={key:0,class:"create-form-section"},ue=10,ma=we({__name:"ManageGuardian",props:{isOpen:{type:Boolean,required:!0}},emits:["close","whenSaved","guardianSelected"],setup(R,{emit:y}){const m=Re(),{patient:A}=Se(m),b=y,v=u(""),f=u([]),D=u(!1),_=u(!1),g=u(1),i=u({firstName:"",lastName:"",phone:"",relationship:""}),M=u([]),x=u(null),V=u(!1),$=u(!1),T=u(!1),E=u(!1),I=ee(()=>Math.ceil(f.value.length/ue)),F=ee(()=>{const l=(g.value-1)*ue,t=l+ue;return f.value.slice(l,t)}),te=ee(()=>i.value.firstName.trim()!==""&&i.value.lastName.trim()!==""&&i.value.relationship),U=()=>{e(),b("close")},se=()=>{clearTimeout(z),z=setTimeout(()=>{_.value=!1,Q()},300)};let z;const Q=async()=>{if(!v.value.trim()){f.value=[],g.value=1;return}D.value=!0;try{const t=(await he.getJson("people/".concat(A.value.patientID,"/relationships"))).map(w=>{var L,J,j,X,ve,ce,pe,me;const P=((J=(L=w.relation)==null?void 0:L.names)==null?void 0:J[0])||{};return{id:((X=(j=w.relation)==null?void 0:j.person_id)==null?void 0:X.toString())||Date.now().toString(),firstName:P.given_name||"Unknown",lastName:P.family_name||"",phone:((pe=(ce=(ve=w.relation)==null?void 0:ve.person_attributes)==null?void 0:ce.find(ke=>ke.value))==null?void 0:pe.value)||"",relationship:((me=w.type)==null?void 0:me.b_is_to_a)||"Other"}}),N=v.value.toLowerCase(),p=t.filter(w=>{const P=(w.firstName||"").toLowerCase(),L=(w.lastName||"").toLowerCase();return P.includes(N)||L.includes(N)});if(p.length>0)f.value=p;else{const w=await he.search({given_name:v.value,family_name:v.value});f.value=w.map(P=>{var J,j;const L=P.person.names[0];return{id:P.person.person_id.toString(),firstName:L.given_name,lastName:L.family_name,phone:((j=(J=P.person.attributes)==null?void 0:J.find(X=>X.attribute_type==="Cell Phone Number"))==null?void 0:j.value)||"",relationship:""}})}g.value=1}catch(l){console.error("Search error:",l),G("Failed to search guardians")}finally{D.value=!1}},le=l=>{b("guardianSelected",l),U()},ne=l=>{l?(x.value=l,i.value.relationship=l.value,V.value=!1):(x.value=null,i.value.relationship=""),r()},W=l=>{i.value.firstName=l.target.value,H()},oe=l=>{i.value.lastName=l.target.value,Y()},de=l=>{i.value.phone=l.target.value,K()},H=()=>{$.value=i.value.firstName.trim()===""},Y=()=>{T.value=i.value.lastName.trim()===""},K=()=>{E.value=i.value.phone.trim()===""},q=async()=>{try{if(H(),Y(),r(),!te.value){G("Please fill all required fields");return}const l={given_name:i.value.firstName,family_name:i.value.lastName,gender:"",birthdate:"",birthdate_estimated:!0,attributes:{cell_phone_number:i.value.phone}},t=new Ke;await t.registerGuardian(l);const N=t.getPersonID();if(!N){G("Failed to create guardian");return}const p=M.value.find(P=>P.value===i.value.relationship);p&&await ye.createRelation(A.value.patientID,N,p.other.relationship_type_id);const w={id:N.toString(),firstName:i.value.firstName,lastName:i.value.lastName,phone:i.value.phone,relationship:i.value.relationship};b("whenSaved",w),U(),xe("Guardian created successfully")}catch(l){console.error("Error creating guardian:",l),G("Failed to create guardian")}},re=async()=>{try{const l=await ye.getRelations();M.value=l.map(t=>({label:t.b_is_to_a,value:t.b_is_to_a,other:t}))}catch(l){console.error("Failed to load relationships",l)}},r=()=>{V.value=!i.value.relationship},e=()=>{i.value={firstName:"",lastName:"",phone:"",relationship:""},x.value=null,v.value="",f.value=[],_.value=!1,g.value=1,D.value=!1};return re(),Ie(_,l=>{l?f.value=[]:v.value&&Q()}),(l,t)=>{const N=Ae("ion-buttons");return c(),k(a(Je),{"is-open":R.isOpen,onDidDismiss:U},{default:s(()=>[n(a($e),null,{default:s(()=>[n(a(Te),null,{default:s(()=>[n(a(Fe),{class:"modal-title"},{default:s(()=>t[5]||(t[5]=[d("Search/Add Guardian")])),_:1,__:[5]}),n(N,{slot:"end"},{default:s(()=>[n(a(ae),{onClick:U,class:"close-button"},{default:s(()=>t[6]||(t[6]=[d("Close")])),_:1,__:[6]})]),_:1})]),_:1})]),_:1}),n(a(qe),{class:"ion-padding modal-content"},{default:s(()=>[o("div",aa,[o("div",ta,[n(a(Le),{class:"search-item",lines:"full"},{default:s(()=>[n(a(Me),{modelValue:v.value,"onUpdate:modelValue":t[0]||(t[0]=p=>v.value=p),placeholder:"Search guardian by name",onIonInput:se,class:"search-input"},{default:s(()=>[n(a(_e),{icon:a(Ue),slot:"start"},null,8,["icon"])]),_:1},8,["modelValue"])]),_:1}),v.value&&!_.value?(c(),C("div",sa,[D.value?(c(),C("div",la," Searching... ")):f.value.length>0?(c(),C("div",na,[(c(!0),C(Pe,null,Oe(F.value,p=>(c(),C("div",{key:p.id,class:"result-item",onClick:w=>le(p)},B(p.firstName)+" "+B(p.lastName),9,oa))),128)),o("div",ra,[o("button",{onClick:t[1]||(t[1]=p=>g.value=Math.max(1,g.value-1)),disabled:g.value===1,class:"pagination-button"}," < ",8,ia),o("span",ua,"page "+B(g.value)+" of "+B(I.value),1),o("button",{onClick:t[2]||(t[2]=p=>g.value=Math.min(I.value,g.value+1)),disabled:g.value===I.value,class:"pagination-button"}," > ",8,da)])])):(c(),C("div",va,[o("div",ca,[t[8]||(t[8]=o("p",null,"Guardian not found.",-1)),n(a(ae),{fill:"clear",onClick:t[3]||(t[3]=p=>_.value=!0)},{default:s(()=>t[7]||(t[7]=[d(" Create Guardian ")])),_:1,__:[7]})])]))])):S("",!0)]),_.value?(c(),C("div",pa,[n(a(Be),{class:"form-grid"},{default:s(()=>[n(a(ge),{class:"form-row"},{default:s(()=>[n(a(Z),{class:"form-column"},{default:s(()=>[n(be,{inputHeader:"First name*",inputValue:i.value.firstName,"onUpdate:inputValue":W,inputType:"text",error:$.value},null,8,["inputValue","error"]),$.value?(c(),k(a(h),{key:0,class:"error-label"},{default:s(()=>t[9]||(t[9]=[d(" First name is required ")])),_:1,__:[9]})):S("",!0)]),_:1}),n(a(Z),{class:"form-column"},{default:s(()=>[n(be,{inputHeader:"Last name*",inputValue:i.value.lastName,"onUpdate:inputValue":oe,inputType:"text",required:!0,error:T.value},null,8,["inputValue","error"]),T.value?(c(),k(a(h),{key:0,class:"error-label"},{default:s(()=>t[10]||(t[10]=[d(" Last name is required ")])),_:1,__:[10]})):S("",!0)]),_:1})]),_:1}),n(a(ge),{class:"form-row"},{default:s(()=>[n(a(Z),{class:"form-column"},{default:s(()=>[n(We,{inputHeader:"Phone number",inputValue:i.value.phone,"onUpdate:inputValue":de,inputType:"tel",required:!0},null,8,["inputValue"])]),_:1}),n(a(Z),{class:"form-column"},{default:s(()=>[n(a(h),{position:"stacked",style:{"font-weight":"500"},class:"labl-cls"},{default:s(()=>t[11]||(t[11]=[d("Relationship"),o("span",{class:"required"}," *",-1)])),_:1,__:[11]}),n(a(Ee),{modelValue:x.value,"onUpdate:modelValue":[t[4]||(t[4]=p=>x.value=p),ne],multiple:!1,taggable:!1,"hide-selected":!0,"close-on-select":!0,openDirection:"bottom",placeholder:"Select relationship",selectLabel:"",label:"label",searchable:!0,"track-by":"value",options:M.value,disabled:!1,class:He({"error-state":V.value}),error:V.value},null,8,["modelValue","options","class","error"]),V.value?(c(),k(a(h),{key:0,class:"error-label"},{default:s(()=>t[12]||(t[12]=[d(" Relationship is required ")])),_:1,__:[12]})):S("",!0)]),_:1})]),_:1})]),_:1})])):S("",!0),_.value?(c(),k(a(ae),{key:1,expand:"block",onClick:q,class:"save-button"},{default:s(()=>[n(a(_e),{icon:a(Ye),slot:"start"},null,8,["icon"]),t[13]||(t[13]=d(" Save "))]),_:1,__:[13]})):S("",!0)])]),_:1})]),_:1},8,["is-open"])}}});const fa=Ve(ma,[["__scopeId","data-v-bc686fbd"]]),_a={class:"reception-form"},ga={class:"form-section"},ba={class:"form-row"},ha={class:"form-group segment-group"},ya={class:"segment-label-container"},Na={class:"form-row"},wa={class:"form-group segment-group"},Sa={class:"segment-label-container"},Ia={key:0,class:"form-row"},Pa={class:"form-group segment-group"},Ca={class:"segment-label-container"},Ra={key:1,class:"form-row"},xa={class:"form-group segment-group"},Va={class:"segment-label-container"},ka={class:"arv-input-container"},Ga={class:"input-group"},Da=["placeholder"],Aa={class:"input-group-text"},$a={class:"form-footer"},Ta=we({__name:"Reception",setup(R){const y=Re(),{patient:m}=Se(y),A=Xe(),b=u(""),v=u(""),f=u(""),D=u(!1),_=u(""),g=u(!0),i=u(""),M=u(""),x=u(""),V=u(null),$=u(!1),T=u(!1),E=u(!1),I=u(!1),F=u("");Ie(f,r=>{r==="no"&&(_.value="",I.value=!1)});const te=ee(()=>!g.value&&x.value==="New patient"),U=r=>{r!==void 0&&(b.value=r,$.value=!1,b.value==="no"&&v.value==="no"&&(b.value="yes"))},se=r=>{r!==void 0&&(v.value=r,T.value=!1,b.value==="no"&&v.value==="no"&&(b.value="yes"),v.value==="yes"&&(D.value=!0))},z=r=>{r!==void 0&&(f.value=r,E.value=!1)},Q=()=>{D.value=!1,V.value||(v.value="")},le=r=>{V.value=r},ne=r=>{V.value=r,v.value="yes"},W=()=>(I.value=!1,F.value="",_.value.trim()?/^\d+$/.test(_.value)?parseInt(_.value)<=0?(I.value=!0,F.value="Number must be positive",!1):!0:(I.value=!0,F.value="Only numbers are allowed",!1):(I.value=!0,F.value="ART number is required",!1)),oe=()=>{let r=!0;return b.value||($.value=!0,r=!1),v.value||(T.value=!0,r=!1),f.value||(E.value=!0,r=!1),f.value==="yes"&&(W()||(r=!1)),r};(async()=>{var l;await A.loadSitePrefix(),M.value=A.globalPropertyStore.sitePrefix||"MPC";const r=new Ze(H,Y,K);await r.loadPatientType(),x.value=r.getType();const e=(l=m.value.identifiers)==null?void 0:l.some(t=>{var N;return t.identifier_type===4&&((N=t.identifier)==null?void 0:N.trim())!==""});if(g.value=e,!e&&x.value==="New patient"){const t=await Ce.getNextSuggestedARVNumber();i.value=t.arv_number.replace(/^\D+|\s/g,"")}else i.value=""})();const H=m.value.patientID,Y=Ne.getUserID()||-1,K=Ne.getUserLocation(),q=new ea(H,Y,K),re=async()=>{if(!oe()){G("Please correct the form errors");return}try{if(!await q.createEncounter()){G("Failed to create encounter");return}const e=[],l=await q.buildValueCoded("Patient present",b.value==="yes"?"Yes":"No");e.push(l);const t=await q.buildValueCoded("Guardian present",v.value==="yes"?"Yes":"No");if(e.push(t),!await q.saveObservationList(e)){G("Failed to save observations");return}f.value==="yes"&&(await q.createArvNumber(_.value)||G("Failed to save ARV number")),xe("Reception data saved successfully")}catch(r){G("Failed to save reception")}};return(r,e)=>(c(),C(Pe,null,[e[18]||(e[18]=o("div",{class:"section-header",style:{"margin-bottom":"10px"}},[o("h2",null,"HIV Reception"),o("hr",{style:{"border-top":"1px solid #0c0c0c","margin-top":"10px"}})],-1)),o("div",_a,[o("div",ga,[o("div",ba,[o("div",ha,[o("div",ya,[e[5]||(e[5]=o("label",{class:"label-title"},[d("Patient present? "),o("span",{class:"required"},"*")],-1)),$.value?(c(),k(a(h),{key:0,class:"error-label"},{default:s(()=>e[4]||(e[4]=[d(" Patient present is required ")])),_:1,__:[4]})):S("",!0)]),n(a(ie),{value:b.value,onIonChange:e[0]||(e[0]=l=>U(l.detail.value)),class:"custom-segment"},{default:s(()=>[n(a(O),{value:"yes"},{default:s(()=>[n(a(h),null,{default:s(()=>e[6]||(e[6]=[d("Yes")])),_:1,__:[6]})]),_:1}),n(a(O),{value:"no"},{default:s(()=>[n(a(h),null,{default:s(()=>e[7]||(e[7]=[d("No")])),_:1,__:[7]})]),_:1})]),_:1},8,["value"])])]),o("div",Na,[o("div",wa,[o("div",Sa,[e[9]||(e[9]=o("label",{class:"label-title"},[d("Guardian present? "),o("span",{class:"required"},"*")],-1)),T.value?(c(),k(a(h),{key:0,class:"error-label"},{default:s(()=>e[8]||(e[8]=[d(" Guardian present is required ")])),_:1,__:[8]})):S("",!0)]),n(a(ie),{value:v.value,onIonChange:e[1]||(e[1]=l=>se(l.detail.value)),class:"custom-segment"},{default:s(()=>[n(a(O),{value:"yes"},{default:s(()=>[n(a(h),null,{default:s(()=>e[10]||(e[10]=[d("Yes")])),_:1,__:[10]})]),_:1}),n(a(O),{value:"no"},{default:s(()=>[n(a(h),null,{default:s(()=>e[11]||(e[11]=[d("No")])),_:1,__:[11]})]),_:1})]),_:1},8,["value"])])]),te.value?(c(),C("div",Ia,[o("div",Pa,[o("div",Ca,[e[13]||(e[13]=o("label",{class:"label-title"},[d("Capture ART number? "),o("span",{class:"required"},"*")],-1)),E.value?(c(),k(a(h),{key:0,class:"error-label"},{default:s(()=>e[12]||(e[12]=[d(" Capture ART number is required ")])),_:1,__:[12]})):S("",!0)]),n(a(ie),{value:f.value,onIonChange:e[2]||(e[2]=l=>z(l.detail.value)),class:"custom-segment"},{default:s(()=>[n(a(O),{value:"yes"},{default:s(()=>[n(a(h),null,{default:s(()=>e[14]||(e[14]=[d("Yes")])),_:1,__:[14]})]),_:1}),n(a(O),{value:"no"},{default:s(()=>[n(a(h),null,{default:s(()=>e[15]||(e[15]=[d("No")])),_:1,__:[15]})]),_:1})]),_:1},8,["value"])])])):S("",!0),f.value==="yes"&&!g.value?(c(),C("div",Ra,[o("div",xa,[o("div",Va,[e[16]||(e[16]=o("label",{class:"label-title"},[d("ART Number "),o("span",{class:"required"},"*")],-1)),I.value?(c(),k(a(h),{key:0,class:"error-label"},{default:s(()=>[d(B(F.value),1)]),_:1})):S("",!0)]),o("div",ka,[o("div",Ga,[je(o("input",{type:"text",class:"form-control","onUpdate:modelValue":e[3]||(e[3]=l=>_.value=l),onInput:W,placeholder:i.value,required:""},null,40,Da),[[ze,_.value]]),o("span",Aa,B(M.value)+"-ARV",1)])])])])):S("",!0),o("div",$a,[n(a(ae),{color:"primary",onClick:re},{default:s(()=>e[17]||(e[17]=[d("Save")])),_:1,__:[17]})])]),n(fa,{isOpen:D.value,patientID:a(m).patientID,onClose:Q,onGuardianSelected:le,onWhenSaved:ne},null,8,["isOpen","patientID"])])],64))}});const Ha=Ve(Ta,[["__scopeId","data-v-61c361f2"]]);export{Ha as default};
