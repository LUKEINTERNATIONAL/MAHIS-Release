var X=Object.defineProperty;var Z=(e,t,i)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var b=(e,t,i)=>Z(e,typeof t!="symbol"?t+"":t,i);import{d as ee,d5 as te,aE as ie,aF as ne,M as se,J as ae,W as re,bq as oe,d6 as ce,cs as le,cr as de,D as ue,G as he,I as ge,dv as $,K as pe,e4 as me,e5 as H,E as y,e as m,f as p,k as s,i as k,l as v,v as O,z as S,F as _,L as I,A as E,B as u,y as B,m as q,p as R,d1 as fe}from"./vendor-Bx_IVmwz.js";import{S as ve,H as T,aW as L,a5 as V,cp as C,W as be,cq as ye,cr as Se,J as Pe,u as _e,cs as Ie,a3 as Ce,m as we,ct as De,cu as U,cv as ke,_ as Oe}from"./index-C_B4etN5.js";import{C as Ee}from"./consultation_service-BDfsipn9.js";import{l as x}from"./lodash-Dt8AsbQm.js";import{A as h}from"./app_encounter_service-CL70yiSF.js";import{u as Re}from"./Arrays-CfBll-2n.js";import{P as Te}from"./patient_type_service-B7VlZW8O.js";class w extends ve{constructor(){super()}static getAllArvRegimens(){return this.getJson("programs/".concat(this.getProgramID(),"/all_arv_regimens"))}static getRegimens(t){return this.getJson("programs/".concat(this.getProgramID(),"/regimens"),{patient_id:t})}static getCustomIngridients(){return this.getJson("programs/".concat(this.getProgramID(),"/custom_regimen_ingredients"))}static getCurrentRegimen(t,i=this.getSessionDate()){return this.getJson("programs/".concat(this.getProgramID(),"/").concat(t),{date:i})}static getRegimenExtras(t,i){return this.getJson("programs/".concat(this.getProgramID(),"/regimen_extras"),{name:t,weight:i})}}class N extends h{constructor(i,n){super(i,25,n);b(this,"nextVisitInterval");b(this,"fastTrack");b(this,"regimenExtras");b(this,"hangingPills");b(this,"fastTrackMedications");b(this,"medicationOrders");b(this,"treatmentState");b(this,"contraindications");b(this,"sideEffects");b(this,"tptPrescriptionCount");b(this,"lastSideEffectDate");this.nextVisitInterval=0,this.fastTrack=!1,this.regimenExtras=[],this.fastTrackMedications=[],this.hangingPills=[],this.medicationOrders=[],this.treatmentState="",this.contraindications={},this.sideEffects={},this.tptPrescriptionCount=0,this.lastSideEffectDate=""}setNextVisitInterval(i){this.nextVisitInterval=i}getHangingPills(){return this.hangingPills}getMedicationOrders(){return this.medicationOrders.map(i=>h.getCachedConceptName(i))}getTptPrescriptionCount(){return this.tptPrescriptionCount}getLastSideEffectDate(){return this.lastSideEffectDate}getContraindications(){return this.contraindications}getSideEffects(){return this.sideEffects}getRegimenExtras(){return this.regimenExtras}getPatientRegimens(){return w.getRegimens(this.patientID)}getARVs(){return w.getJson("arv_drugs")}getCustomIngridients(){return w.getCustomIngridients()}getFastTrackMedications(){return this.fastTrackMedications}getTreatmentState(){return this.treatmentState}isFastTrack(){return this.fastTrack}medicationOrdersAvailable(){return!x.isEmpty(this.medicationOrders)}shouldPrescribeExtras(){return h.getConceptsByCategory("art_extra_medication_order").map(a=>this.medicationOrders.includes(a.concept_id)).some(Boolean)}getRegimenStarterpack(i,n){const a={weight:n,regimen:i};return h.getJson("programs/".concat(h.getProgramID(),"/regimen_starter_packs"),a)}async getLvpDrugsByType(i,n){return h.getJson("programs/".concat(h.getProgramID(),"/regimens/").concat(n),{patient_id:this.patientID,lpv_drug_type:i})}async loadContraindications(){const i=await h.getConceptID("Contraindications");(await h.getObs({concept_id:i,person_id:this.patientID})).forEach(a=>{const r=T.toStandardHisFormat(a.obs_datetime);this.contraindications[r]||(this.contraindications[r]=[]);const o=h.getCachedConceptName(a.value_coded);this.contraindications[r].push(o)})}async loadDrugInduced(){const i=await h.getConceptID("Drug induced"),n=await h.getObs({concept_id:i,person_id:this.patientID});n&&n.forEach(a=>{const r=T.toStandardHisFormat(a.obs_datetime);if(this.lastSideEffectDate||(this.lastSideEffectDate=r),!a.value_drug||!a.value_coded)return;this.sideEffects[r]||(this.sideEffects[r]={}),this.sideEffects[r][a.value_drug]||(this.sideEffects[r][a.value_drug]=[]);const o=h.getCachedConceptName(a.value_coded);this.sideEffects[r][a.value_drug].push(o)})}async loadTptPrescriptionCount(){const i=await h.getJson("tpt_prescription_count",{patient_id:this.patientID,date:this.date});if(i){const n=i.count+1;this.tptPrescriptionCount=n>3?3:n}}async loadFastTrackStatus(){const i=await h.getFirstValueCoded(this.patientID,"Fast track"),n=await h.getConceptID("yes");i&&(this.fastTrack=i===n)}async loadRegimenExtras(i=this.date){const n=await w.getJson("programs/".concat(w.getProgramID(),"/patients/").concat(this.patientID,"/dosages"),{date:i});n&&(this.regimenExtras=Object.values(n))}async loadMedicationOrders(){const i=await h.getConceptID("Medication orders"),n=await h.getObs({concept_id:i,date:this.date,person_id:this.patientID,page_size:5});this.medicationOrders=n.map(a=>a.value_coded)}async loadHangingPills(){const i=await h.getAll(this.patientID,"Pills brought")||[];this.hangingPills=i.filter(n=>n.value_numeric>=1?n.value_drug&&L(n.obs_datetime)===L(this.date)?!0:n.order||!1:!1).map(n=>{var a,r;return((r=(a=n==null?void 0:n.order)==null?void 0:a.drug_order)==null?void 0:r.drug_inventory_id)||n.value_drug})}async loadFastTrackMedications(){const n=(await V.getLastDrugsReceived(this.patientID)).map(async a=>{const{drug:r}=a,o=await V.getDrugDosages(this.patientID,r.drug_id);return{drug_id:r.drug_id,drug_name:r.name,units:r.units,am:o.am,noon:o.noon,pm:o.pm,frequency:a.frequency}});this.fastTrackMedications=await Promise.all(n)}async loadTreatmentState(){const i={date:this.date},n=await h.getJson("programs/".concat(h.getProgramID(),"/patients/").concat(this.patientID,"/status"),i);n&&(this.treatmentState=n.status)}findAndGroupDrugSideEffects(i){const n={};for(const a in this.sideEffects){const r=this.sideEffects[a];for(const o in r)i.includes(parseInt(o))&&(n[a]||(n[a]=[]),n[a]=[...n[a],...r[o]])}return n}calculatePillsPerDay(i,n,a){return parseFloat(i.toString())+n+a}estimatePackSize(i,n=0){const a=i*this.nextVisitInterval/(n||1);let r=Math.round(a);return r<=0&&(r+=1),r}calculateDosage(i,n){let a=0;return n===0&&(a=i),i==0&&(a=n),i>0&&n>0&&(a=(i+n)/2),a}calculateEquivalentDosage(i,n){return i+n}calculateDateFromInterval(){const i=new Date(this.date);return i.setDate(i.getDate()+this.nextVisitInterval),T.toStandardHisFormat(i)}getDrugPackSize(i){if(i.pack_size)return i.pack_size;try{return i.barcodes[0].tabs}catch(n){return 30}}getInstructions(i,n,a,r){return"".concat(i," :- Morning: ").concat(n," ").concat(r,", Evening: ").concat(a," ").concat(r)}toOrderObj(i,n,a,r=0,o=0,d=""){return{drug_inventory_id:i,equivalent_daily_dose:this.calculateEquivalentDosage(r,o),start_date:this.date,auto_expire_date:this.calculateDateFromInterval(),units:a,instructions:this.getInstructions(n,r,o,a),dose:this.calculateDosage(r,o),frequency:d}}async getReasonForRegimenSwitch(){const i=await h.getFirstValueText(this.patientID,"Reason for ARV switch");return i||"N/A"}async createDrugOrder(i){return V.create({encounter_id:this.encounterID,drug_orders:i})}async createHangingPillsObs(i){return this.saveValueTextObs("appointment type",i)}async createRegimenSwitchObs(i){return this.saveValueTextObs("Reason for ARV switch",i)}}var z=(e=>(e.ARV_REGIMENS="arv_regimens",e.INTERVAL_SELECTION="next_visit_interval",e))(z||{}),J=(e=>(e.EXIT="exit",e.CONTINUE="continue",e))(J||{}),W=(e=>(e.ON_VALUE="onValue",e.ON_BUILD="onBuild",e.BEFORE_NEXT="beforeNext",e))(W||{});const Ve={"Do not prescribe LPV regimens together with 3HP":{priority:1,actions:{alert:async({regimenName:e})=>(await C("3HP - LPV/r conflict",e,"Regimens containing LPV/r <b>cannot</b> be prescribed together with 3HP",[{name:"Close",slot:"end",color:"danger"}],"his-danger-color"),"exit")},target:"arv_regimens",targetEvent:"onValue",conditions:{regimenCode(e){return[7,8,9,10,11,12].includes(e)},medicationOrders(e){return e.filter(t=>!!"".concat(t).match(/3hp/i)).length>=1}}},"Check for any adverse effects or contraindications associated with the regimen":{priority:1,actions:{alert:async({regimenCodeStr:e,sideEffectsTable:t})=>{const{columns:i,rows:n}=t;return await Se("Contraindications / Side effects for ".concat(e),"",i,n,[{name:"Select other regimen",slot:"start"},{name:"Keep selected regimen",slot:"end",color:"danger"}],"his-danger-color")==="Select other regimen"?"exit":"continue"}},target:"arv_regimens",targetEvent:"beforeNext",conditions:{hasSideEffects(e){return e},lastSideEffectDate(e,{currentDate:t}){return e>=t}}},"Recommend 2nd line regimen to children under 3":{priority:1,actions:{alert:async()=>await ye("Recommendation","",["Children under 3 years often have a high viral load and may be infected with drug-resistant HIV from previous exposure to ARVs (mother's ART and/or infant nevirapine prophylaxis)","Therefore, children under <b>3 years</b> respond better when <b>started immediately on 2nd line regimen</b> (Regimen <b>11</b>)"],[{name:"Select another regimen",slot:"start"},{name:"Keep selected regimen",slot:"end",color:"danger"}],"his-warning-color")==="Select another regimen"?"exit":"continue"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{age(e){return e<3},regimenCode(e){return e!=11}}},"Provide a reason for switching regimens when patient already has one":{priority:1,actions:{alert:async e=>{const t=await be("Are you sure you want to replace ".concat(e.currentRegimenStr,"?"),"Specify reason for switching regimen",["Policy change","Ease of administration (pill burden, swallowing)","Drug drug interaction","Pregnancy intention","Side effects","Treatment failure","Weight Change","Other"],[{name:"Cancel",slot:"start",color:"danger"},{name:"Continue",slot:"end",role:"action"}]);return t.selection&&t.action!="Cancel"?(e.reasonForSwitch=t.selection,"continue"):"exit"}},target:"arv_regimens",targetEvent:"onValue",conditions:{regimenCode(e,{currentRegimenCode:t}){return t!=-1&&e!=t}}},"Provide 14 day starter pack for LPV regimens for children under 3 years old":{priority:3,actions:{alert:async e=>await C("Starter pack needed for 14 days","".concat(e.treatmentInitiationState),"".concat(e.regimenName),[{name:"Cancel",slot:"start",color:"danger"},{name:"Prescribe starter pack",slot:"end"}],"his-info-color")==="Prescribe starter pack"?(e.starterPackNeeded=!0,"continue"):"exit"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{age(e){return e<3},regimenCode(e){return e===11},treatmentInitiationState(e){return["Initiation","Re-initiation"].includes(e)}}},"Provide 14 day starter pack for NVP based regimens on newly initiated/re-initiation patients":{priority:3,actions:{alert:async e=>await C("Starter pack needed for 14 days","".concat(e.treatmentInitiationState),"".concat(e.regimenName),[{name:"Cancel",slot:"start",color:"danger"},{name:"Prescribe starter pack",slot:"end"}],"his-info-color")==="Prescribe starter pack"?(e.starterPackNeeded=!0,"continue"):"exit"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{regimenCode(e){return[0,2,6].includes(e)},treatmentInitiationState(e){return["Initiation","Re-initiation"].includes(e)}}},"Ask to reuse hanging pills if any":{priority:5,actions:{alert:async e=>(await C("Hanging pills recommendation","Add hanging pills?","",[{name:"No",slot:"start",color:"warning"},{name:"Yes",slot:"end"}],"his-info-color")==="Yes"?e.hangingPillsStatus="Optimize - including hanging pills":e.hangingPillsStatus="Exact - excluding hanging pills","continue")},target:"next_visit_interval",targetEvent:"beforeNext",conditions:{drugs(e,{hangingPills:t}){return e.map(n=>t.includes(n)).some(Boolean)}}},"Provide warning of use of DTG regimen to women of reproductive age":{priority:2,actions:{alert:async({regimenName:e})=>await C("Use of DTG or EFV in women of reproductive age",e,["There is currently <u>no confirmation</u>","that <b>DTG</b> is safe in <u>very early pregnancy</u>","DTG-based regimens are therefore not used as standard 1st line regimens for","<u>girls and women</u> who may get pregnancy"].join(" "),[{name:"Select another regimen",slot:"start"},{name:"Continue with regimen",slot:"end",color:"danger"}],"his-danger-color")==="Select another regimen"?"exit":"continue"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{regimenCode(e){return e>=12},isChildBearing(e){return e}}},"Provide pallet options for LPV regimens for patient's whose weight is between 3 and 25 kgs":{priority:6,actions:{alert:async e=>{const t=await C("Pellets (cups) / Tabs","","Prescribe LPV/r in <b>Pellets (cups)</b> or <b>Tablets</b>?",[{name:"Granules",slot:"start"},{name:"Pellets",slot:"end"},{name:"Tabs",slot:"end"}],"his-info-color");return e.lpvType=t.toLowerCase(),"continue"}},target:"arv_regimens",targetEvent:"beforeNext",conditions:{weight(e){return e>=3&&e<=25},regimenCode(e){return e===11||e===9}}},"Provide 14 day interval for NVP or LVP Regimen starter pack":{priority:1,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{prescriptionType(e){return e==="Regimen"},selectedInterval(e){return e>14},starterPackNeeded(e){return e},regimenCode(e){return[0,2,6,11].includes(e)}}},"Restrict Emergency supply prescription to 1 month":{priority:1,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{selectedInterval:e=>e>28,patientType:e=>e==="Emergency supply"}},"Provide intervals upto 1 month, 2nd up to 2 months, and 3rd up to 6 months for Patients receiving TPT":{priority:2,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{prescriptionType(e){return e==="Regimen"},medicationOrders(e){return e.map(t=>!!"".concat(t).match(/3hp/i)).some(Boolean)},tptPrescriptionCount(e,{selectedInterval:t}){return Math.round(t/30)>e}}}},Ne={"Rifapentine or isoniazid should be taken weekly":{concept:"Weekly (QW)",priority:1,conditions:{drug(e){return"".concat(e).match(/Rifapentine|Isoniazid/i)}}},"Use daily frequency for any other drugs":{concept:"Daily (QOD)",priority:2,conditions:{drug(e){return!"".concat(e).match(/Rifapentine|Isoniazid/i)}}}};function xe(e,t){const i=[],n=[-1,"",null,void 0];for(const a in t){if(!(a in e))continue;const r=e[a];if(n.includes(r)){i.push(!1);continue}i.push(t[a](r,e))}return i.every(Boolean)}function Me(e){return e.sort((t,i)=>t.priority&&i.priority&&t.priority<i.priority?-1:1)}function Fe(e){return e.sort((t,i)=>t.weight&&i.weight&&t.weight>i.weight?-1:1)}function G(e,t,i="",n="",a="priority"){const r=[];for(const o in t){const d=t[o];[d.target&&i&&d.target!=i,d.targetEvent&&n&&d.targetEvent!=n].some(Boolean)||xe(e,d.conditions)&&(d.title=o,d.description&&(d.description.text=d.description.info(e)),r.push(d))}return a==="priority"?Me(r):Fe(r)}const Ae=ee({name:"Prescription",data(){return{toDisplayFmt:U,toDisplayGenderFmt:ke,accordionState:{allergySection:!0,medicationSection:!1,arvRegimensSection:!1,nextVisitSection:!1},consultation:H({}),prescription:H({}),chevronUp:me,chevronDown:pe,reasonsForOver6Months:"",route:"",providerID:1,patientID:-1,facts:{age:-1,gender:"",weight:50,currentDate:"",isChildBearing:!1,isPregnant:!1,isBreastfeeding:!1,prescriptionType:"",patientType:"",tbStatus:"",tptStatus:{},tptPrescriptionCount:0,currentRegimenCode:-1,currentRegimenStr:"",drug:"",drugs:[],contraindications:{},hasSideEffects:!1,sideEffectsTable:{},lastSideEffectDate:"",regimenCode:-1,regimenCodeStr:"",regimenName:"",regimenDrugs:[],hangingPills:[],reasonForSwitch:"",starterPackNeeded:!1,hangingPillsStatus:"",treatmentInitiationState:"",lpvType:"",medicationOrders:[],selectedInterval:0,isEligibleForTpt:!1},arvRegimens:[],medicationOptions:[],selectedRegimen:{},customRegimen:!1,allergyOption:"",Intervaloptions:[{label:"2 weeks",value:14},{label:"1 month",value:28},{label:"2 months",value:56},{label:"3 months",value:84},{label:"4 months",value:112},{label:"5 months",value:140},{label:"6 months",value:168},{label:"7 months",value:196},{label:"8 months",value:224},{label:"9 months",value:252},{label:"10 months",value:280},{label:"11 months",value:308},{label:"12 months",value:336}],allergyOptions:[{label:"Yes",value:"Yes"},{label:"No",value:"No"},{label:"Unknown",value:"Unknown"}],nextVisitInterval:1,selectedMedications:[],medicationRunOutDate:N.getSessionDate(),estimatedPacks:[]}},components:{IonIcon:ge,IonItem:he,IonLabel:ue,IonSelect:de,IonSelectOption:le,IonTextarea:ce,IonCheckbox:oe,IonButton:re,IonAccordion:ae,IonAccordionGroup:se,IonRadio:ne,IonRadioGroup:ie,IonNote:te},computed:{noDispensation(){return this.medicationOptions.some(e=>e.value==="none"&&e.isChecked)},over6monthsMedication(){return this.nextVisitInterval>168}},methods:{isChildBearing(){return this.facts.gender==="F"&&this.facts.age>=12&&this.facts.age<=50},toggleAccordion(e){this.accordionState[e]=!this.accordionState[e]},async onEvent(e,t){var n,a;const i=G(this.facts,Ve,e,t);for(const r in i){const o=i[r];if((n=o==null?void 0:o.actions)!=null&&n.alert&&await((a=o==null?void 0:o.actions)==null?void 0:a.alert(this.facts))===J.EXIT)return!1}return!0},formatDrugs(e){return e.map(t=>t.alternative_drug_name).join(" + ")},getDrugFrequency(e){this.facts.drug=e;const t=G(this.facts,Ne);if(!x.isEmpty(t))return t[0].concept},extractRegimenCode(e){try{return e.match(/n\/a/i)?-1:parseInt(e.substring(0,e.length))}catch(t){return console.warn(t),-1}},buildSideEffectsTable(e){const t=["Date","Contraindication(s)","Side effect(s)"],i=[];for(const n in e){const a=this.facts.contraindications[n]||[];i.push([U(n),a.join(", "),e[n].join(", ")])}return{columns:t,rows:i}},async toggleRegimen(e){if(this.selectedRegimen.name!==e.name){this.facts.lpvType="",this.facts.hangingPillsStatus="",this.facts.starterPackNeeded=!1,this.facts.regimenName="".concat(e.name," (").concat(this.formatDrugs(e.drugs),")"),this.facts.regimenCodeStr=e.name,this.facts.regimenCode=this.extractRegimenCode(e.name),this.facts.regimenDrugs=e.drugs,this.facts.drugs=e.drugs.map(i=>i.drug_id);const t=this.prescription.findAndGroupDrugSideEffects(this.facts.drugs);if(this.facts.hasSideEffects=!x.isEmpty(t),this.facts.sideEffectsTable=this.buildSideEffectsTable(t),!this.onEvent(z.ARV_REGIMENS,W.ON_VALUE))return;this.selectedRegimen=e,this.selectedMedications=e.drugs,this.updateEstimatedPacks()}else this.selectedRegimen={},this.selectedMedications=[]},disableOption(e,t=!0){return{disabled:t,description:{color:"danger",show:"always",text:e}}},validateTPTOption(e){return this.facts.tptStatus.completed?this.disableOption("Completed TPT treatment"):this.facts.tptStatus.tb_treatment?this.disableOption("Completed/on TB treatment"):this.facts.isPregnant?this.disableOption("Pregnant patient"):!this.facts.tptStatus.eligible["3HP"]&&!this.facts.tptStatus.eligible["6H"]?this.disableOption("Not eligible to start or re-start TPT"):this.facts.tptStatus.tpt!==null&&this.facts.tptStatus.tpt!==e?this.disableOption("On ".concat(this.facts.tptStatus.tpt," treatment")):(this.facts.isEligibleForTpt=e.includes("3HP")?this.facts.tptStatus.eligible["3HP"]:this.facts.tptStatus.eligible["6H"],this.facts.isBreastfeeding?this.disableOption("Breastfeeding patient",!1):this.facts.isEligibleForTpt&&this.facts.tptStatus.tpt===e&&!this.facts.tptStatus.completed?{isChecked:!0}:{})},buildTPTOption(e,t,i=0){const n={label:e,value:t,isChecked:!1,disabled:!1};if(i>0&&this.facts.weight<i)return{...n,...this.disableOption("Weight below regulation")};const a=this.validateTPTOption(e);return{...n,...a}},buildMedicationOptions(){this.medicationOptions=[{label:"ARVs",value:"arvs",isChecked:!1},{label:"CPT",value:"cpt",isChecked:!1,...this.allergyOption==="Yes"?this.disableOption("Allergic to sulphur"):{}},this.buildTPTOption("3HP (RFP + INH)","3hp",20),this.buildTPTOption("INH 300 / RFP 300 (3HP)","inh300",30),this.buildTPTOption("IPT","ipt",30),{label:"None",value:"none",isChecked:!1}]},async allergyChange(e){this.allergyOption=e.detail.value},nextVisitIntervalChange(e){const t=new Date;this.nextVisitInterval=e.detail.value,this.medicationRunOutDate=De(t,this.nextVisitInterval,"days"),this.updateEstimatedPacks()},async onSubmit(){try{const e=[await this.createbuildValueCoded("Allergic to sulphur",this.allergyOption.toString())];this.noDispensation?e.push(await this.consultation.buildValueCoded("Prescribe drugs","No")):(e.push(await this.consultation.buildValueCoded("Prescribe drugs","Yes")),this.medicationOptions.forEach(async i=>{i.isChecked&&e.push(await this.consultation.buildValueCoded("Medication orders",i.label))})),await this.consultation.saveObservationList(e),await this.prescription.createEncounter(),this.prescription.setNextVisitInterval(this.nextVisitInterval);const t=this.selectedMedications.map(i=>this.prescription.toOrderObj(i.drug_id,i.alternative_drug_name||i.drug_name,i.units,i.am,i.pm,i.frequency||this.getDrugFrequency(i.drug_name)));if(await this.prescription.createDrugOrder(t),this.over6monthsMedication){const i=await this.consultation.buildValueCoded("Why prescribe medication for more than 6 months?",this.reasonsForOver6Months);await this.prescription.saveObservationList([i])}return!0}catch(e){return console.error("Error saving prescription:",e),we("Failed to save prescription"),!1}},async createbuildValueCoded(e,t){return await this.consultation.buildValueCoded(e,t)},async handleMedicationSelection(e,t,i){const n=e.detail.checked;if(i.value==="none"){n&&(this.medicationOptions=this.medicationOptions.map((o,d)=>({...o,isChecked:d===t}))),await this.updateSelectedMedications();return}i.value==="arvs"&&(n?(this.accordionState.arvRegimensSection=!0,this.accordionState.nextVisitSection=!0):(this.accordionState.arvRegimensSection=!1,this.accordionState.nextVisitSection=!1));const a=o=>!!o.label.match(/IPT|3HP|INH/i),r=this.medicationOptions.filter(a);if(a(i)){const o=g=>g.label==="3HP (RFP + INH)"||g.label==="INH 300 / RFP 300 (3HP)",d=r.some(g=>g.label==="IPT"&&g.isChecked);if(o(i)&&d&&n){const g=await this.showTPTConflictDialog();g==="Prescribe IPT"?this.medicationOptions=this.medicationOptions.map(l=>({...l,isChecked:o(l)?!1:l.isChecked})):g==="Prescribe 3HP"&&(this.medicationOptions=this.medicationOptions.map(l=>({...l,isChecked:l.label==="IPT"?!1:o(l)?l.label===i.label:l.isChecked}))),await this.updateSelectedMedications();return}if(o(i)&&n&&(this.medicationOptions=this.medicationOptions.map(g=>({...g,isChecked:o(g)?g.label===i.label:g.isChecked}))),i.label==="IPT"&&n&&r.some(l=>o(l)&&l.isChecked)){const l=await this.showTPTConflictDialog();l==="Prescribe IPT"?this.medicationOptions=this.medicationOptions.map(f=>({...f,isChecked:o(f)?!1:f.isChecked})):l==="Prescribe 3HP"&&(this.medicationOptions=this.medicationOptions.map(f=>({...f,isChecked:f.label==="IPT"?!1:f.isChecked}))),await this.updateSelectedMedications();return}}n&&i.value!=="none"&&(this.medicationOptions=this.medicationOptions.map(o=>({...o,isChecked:o.value==="none"?!1:o.isChecked}))),this.medicationOptions[t].isChecked=n,await this.updateSelectedMedications()},async updateSelectedMedications(){this.selectedMedications=[];const e=async(t,i,n)=>{if(this.medicationOptions.find(r=>r.value===t&&r.isChecked)){const r=await w.getRegimenExtras(i,this.facts.weight),o=Re(n?r.filter(n):r,"concept_name");this.selectedMedications.push(...o)}};this.medicationOptions.find(t=>t.value==="arvs"&&t.isChecked)&&this.selectedRegimen.drugs&&this.selectedMedications.push(...this.selectedRegimen.drugs),await e("cpt","Cotrimoxazole",t=>t.frequency==="Daily (QOD)"),await e("3hp","INH / RFP"),await e("inh300","INH / RFP"),await e("ipt","INH",t=>t.frequency==="Daily (QOD)"),this.updateEstimatedPacks()},updateEstimatedPacks(){this.prescription.setNextVisitInterval(this.nextVisitInterval),this.estimatedPacks=this.selectedMedications.map(e=>{const t=this.prescription.getDrugPackSize(e),i=this.prescription.calculatePillsPerDay(e.am,e.noon,e.pm),n=this.prescription.estimatePackSize(i,t);return{name:e.drug_name,quantity:n}})},async initFacts(){const e=await Ce.getProgramInformation(this.patientID);this.facts.hangingPills=this.prescription.getHangingPills(),this.facts.treatmentInitiationState=this.prescription.getTreatmentState(),this.facts.currentRegimenStr=e.current_regimen,this.facts.currentRegimenCode=this.extractRegimenCode(e.current_regimen),this.facts.medicationOrders=this.prescription.getMedicationOrders(),this.facts.contraindications=this.prescription.getContraindications(),this.facts.tptPrescriptionCount=this.prescription.getTptPrescriptionCount(),this.facts.lastSideEffectDate=this.prescription.getLastSideEffectDate(),this.facts.currentDate=N.getSessionDate(),this.facts.isChildBearing=this.isChildBearing(),this.facts.tptStatus=await this.consultation.getTptTreatmentStatus();const t=new Te(this.patientID,this.providerID);await t.loadPatientType(),this.facts.patientType=t.patientType},async showTPTConflictDialog(){return await C("TPT Conflict","You cannot prescribe IPT and 3HP together","Please choose one option",[{name:"Prescribe 3HP",slot:"start",color:"primary"},{name:"Prescribe IPT",slot:"end",color:"primary"}])}},watch:{nextVisitInterval:{handler(){this.updateEstimatedPacks()}},allergyOption:{handler(){this.buildMedicationOptions()}},medicationOptions:{handler(){this.updateSelectedMedications()},deep:!0}},async mounted(){var o,d,g;const e=Pe();this.providerID=Number($(e.$state).user_ID)||1;const t=_e(),i=$(t.$state).patient;if(this.patientID=(i==null?void 0:i.patientID)||25,this.facts.gender=(i==null?void 0:i.personInformation.gender)||"",this.facts.age=Ie(i==null?void 0:i.personInformation.birthdate),(d=(o=i==null?void 0:i.vitals)==null?void 0:o.saved)==null?void 0:d[0]){const l=i.vitals.saved.find(f=>f.concept_name==="Weight (kg)");l&&(this.facts.weight=l.value_numeric)}const a=(g=i==null?void 0:i.activePrograms)==null?void 0:g.find(l=>l.program.name==="HIV PROGRAM");a&&(this.facts.currentRegimenStr=a.program.name,this.facts.currentRegimenCode=this.extractRegimenCode(a.program.name)),this.consultation=new Ee(this.patientID,this.providerID),this.prescription=new N(this.patientID,this.providerID);const r=await w.getRegimens(this.patientID);Object.entries(r).forEach(([l,f])=>{this.arvRegimens.push({name:l,drugs:f})}),await this.prescription.loadHangingPills(),await this.prescription.loadRegimenExtras(),await this.initFacts(),this.buildMedicationOptions()}}),$e={class:"prescription-container"},He={class:"accordion-section"},Be={class:"expand-btn"},qe={class:"accordion-content"},Le={class:"allergy-section"},Ue={class:"accordion-section"},Ge={class:"expand-btn"},ze={class:"accordion-content"},Je={class:"medication-options"},We={class:"option-grid"},je={class:"checkbox-text"},Ye={class:"accordion-section"},Qe={class:"expand-btn"},Ke={class:"accordion-content"},Xe={class:"patient-info"},Ze={class:"info-item"},et={class:"info-value"},tt={class:"info-item"},it={class:"info-value"},nt={class:"info-item"},st={class:"info-value"},at={class:"info-item"},rt={class:"info-value"},ot={class:"info-item"},ct={class:"info-value"},lt={class:"regimen-grid"},dt=["onClick"],ut={class:"regimen-id"},ht={class:"regimen-name"},gt=["onClick"],pt={class:"regimen-id"},mt={class:"regimen-name"},ft={class:"custom-regimen"},vt={class:"selected-medication-section"},bt={class:"medication-table"},yt={class:"row-cell drug-name"},St={class:"row-cell units"},Pt={class:"row-cell am"},_t={class:"row-cell noon"},It={class:"row-cell pm"},Ct={class:"row-cell frequency"},wt={class:"accordion-section"},Dt={class:"expand-btn"},kt={class:"accordion-content"},Ot={class:"next-visit-interval"},Et={class:"medication-run-out"},Rt={class:"estimated-packs"},Tt={class:"pack-name"},Vt={class:"pack-quantity"},Nt={key:0,class:"over-6-months-medication"};function xt(e,t,i,n,a,r){const o=y("ion-icon"),d=y("ion-radio"),g=y("ion-radio-group"),l=y("ion-checkbox"),f=y("ion-note"),j=y("ion-select-option"),Y=y("ion-select"),M=y("ion-item"),Q=y("ion-label"),K=y("ion-textarea");return p(),m("div",$e,[s("div",He,[s("div",{class:"accordion-header",onClick:t[0]||(t[0]=c=>e.toggleAccordion("allergySection"))},[t[8]||(t[8]=s("h3",null,"Allergy Information",-1)),s("button",Be,[v(o,{icon:e.accordionState.allergySection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),k(s("div",qe,[s("div",Le,[t[9]||(t[9]=s("div",{class:"allergy-label"},"Allergic to cotrimoxazole",-1)),v(g,{modelValue:e.allergyOption,"onUpdate:modelValue":t[1]||(t[1]=c=>e.allergyOption=c),onIonChange:e.allergyChange,class:"horizontal-options"},{default:S(()=>[(p(!0),m(_,null,I(e.allergyOptions,c=>(p(),m("div",{key:c.value,class:"horizontal-item"},[v(d,{value:c.value},{default:S(()=>[E(u(c.label),1)]),_:2},1032,["value"])]))),128))]),_:1},8,["modelValue","onIonChange"])])],512),[[O,e.accordionState.allergySection]])]),s("div",Ue,[s("div",{class:"accordion-header",onClick:t[2]||(t[2]=c=>e.toggleAccordion("medicationSection"))},[t[10]||(t[10]=s("h3",null,"Medication to prescribe during this visit",-1)),s("button",Ge,[v(o,{icon:e.accordionState.medicationSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),k(s("div",ze,[s("div",Je,[s("div",We,[(p(!0),m(_,null,I(e.medicationOptions,(c,P)=>{var F,A;return p(),m("div",{key:c.value,class:"option-item"},[v(l,{checked:c.isChecked,disabled:c.disabled,"label-placement":"end",onIonChange:D=>e.handleMedicationSelection(D,P,c)},{default:S(()=>[s("span",je,u(c.label),1)]),_:2},1032,["checked","disabled","onIonChange"]),t[11]||(t[11]=s("br",null,null,-1)),((F=c.description)==null?void 0:F.show)==="always"?(p(),B(f,{key:0,color:(A=c.description)==null?void 0:A.color},{default:S(()=>{var D;return[E(u((D=c.description)==null?void 0:D.text),1)]}),_:2},1032,["color"])):q("",!0)])}),128))])])],512),[[O,e.accordionState.medicationSection]])]),s("div",Ye,[s("div",{class:"accordion-header",onClick:t[3]||(t[3]=c=>e.toggleAccordion("arvRegimensSection"))},[t[12]||(t[12]=s("h3",null,"ARV Regimens",-1)),s("button",Qe,[v(o,{icon:e.accordionState.arvRegimensSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),k(s("div",Ke,[s("div",Xe,[s("div",Ze,[t[13]||(t[13]=s("span",{class:"info-label"},"Age:",-1)),s("span",et,u(e.facts.age)+" Years",1)]),s("div",tt,[t[14]||(t[14]=s("span",{class:"info-label"},"Gender:",-1)),s("span",it,u(e.toDisplayGenderFmt(e.facts.gender)),1)]),s("div",nt,[t[15]||(t[15]=s("span",{class:"info-label"},"Current Regimen:",-1)),s("span",st,u(e.facts.currentRegimenStr),1)]),s("div",at,[t[16]||(t[16]=s("span",{class:"info-label"},"Current Weight:",-1)),s("span",rt,u(e.facts.weight),1)]),s("div",ot,[t[17]||(t[17]=s("span",{class:"info-label"},"Reason for change:",-1)),s("span",ct,u(e.facts.reasonForSwitch),1)])]),s("div",lt,[(p(!0),m(_,null,I(e.arvRegimens.slice(0,5),c=>(p(),m("div",{key:c.name,class:R(["regimen-item",{selected:e.selectedRegimen.name===c.name}]),onClick:P=>e.toggleRegimen(c)},[s("span",ut,u(c.name),1),s("span",ht,u(e.formatDrugs(c.drugs)),1)],10,dt))),128)),(p(!0),m(_,null,I(e.arvRegimens.slice(5),c=>(p(),m("div",{key:c.name,class:R(["regimen-item",{selected:e.selectedRegimen.name===c.name}]),onClick:P=>e.toggleRegimen(c)},[s("span",pt,u(c.name),1),s("span",mt,u(e.formatDrugs(c.drugs)),1)],10,gt))),128))]),s("div",ft,[t[18]||(t[18]=s("span",null,"Set custom regimen",-1)),v(l,{modelValue:e.customRegimen,"onUpdate:modelValue":t[4]||(t[4]=c=>e.customRegimen=c)},null,8,["modelValue"])]),s("div",vt,[t[20]||(t[20]=s("h3",null,"Selected medication",-1)),s("div",bt,[t[19]||(t[19]=fe('<div class="table-header" data-v-b0b7ac4d><div class="header-cell drug-name" data-v-b0b7ac4d>Drug name</div><div class="header-cell units" data-v-b0b7ac4d>Units</div><div class="header-cell am" data-v-b0b7ac4d>AM</div><div class="header-cell noon" data-v-b0b7ac4d>Noon</div><div class="header-cell pm" data-v-b0b7ac4d>PM</div><div class="header-cell frequency" data-v-b0b7ac4d>Frequency</div><div class="header-cell action" data-v-b0b7ac4d>Action</div></div>',1)),(p(!0),m(_,null,I(e.selectedMedications,(c,P)=>(p(),m("div",{key:P,class:R(["table-row",{highlighted:P===0}])},[s("div",yt,u(c.drug_name),1),s("div",St,u(c.units),1),s("div",Pt,u(c.am),1),s("div",_t,u(c.noon),1),s("div",It,u(c.pm),1),s("div",Ct,u(c.frequency),1)],2))),128))])])],512),[[O,e.accordionState.arvRegimensSection]])]),s("div",wt,[s("div",{class:"accordion-header",onClick:t[5]||(t[5]=c=>e.toggleAccordion("nextVisitSection"))},[t[21]||(t[21]=s("h3",null,"Next Visit Information",-1)),s("button",Dt,[v(o,{icon:e.accordionState.nextVisitSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),k(s("div",kt,[s("div",Ot,[v(M,null,{default:S(()=>[v(Y,{modelValue:e.nextVisitInterval,"onUpdate:modelValue":t[6]||(t[6]=c=>e.nextVisitInterval=c),interface:"popover",onIonChange:e.nextVisitIntervalChange,placeholder:"Select interval",label:"Interval to next visit","label-placement":"stacked"},{default:S(()=>[(p(!0),m(_,null,I(e.Intervaloptions,c=>(p(),B(j,{key:c.value,value:c.value},{default:S(()=>[E(u(c.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","onIonChange"])]),_:1})]),s("div",Et,[t[22]||(t[22]=s("label",null,"Medication run out date:",-1)),s("span",null,u(e.toDisplayFmt(e.medicationRunOutDate)),1)]),s("div",Rt,[t[23]||(t[23]=s("h4",null,"Estimated packs/tins:",-1)),(p(!0),m(_,null,I(e.estimatedPacks,(c,P)=>(p(),m("div",{key:P,class:"pack-item"},[s("span",Tt,u(c.name),1),s("div",Vt,u(c.quantity),1)]))),128))]),e.over6monthsMedication?(p(),m("div",Nt,[v(M,null,{default:S(()=>[v(Q,{position:"stacked"},{default:S(()=>t[24]||(t[24]=[E("Specify reason for prescribing medication over 6 months "),s("span",{class:"required"},"*",-1)])),_:1,__:[24]}),v(K,{modelValue:e.reasonsForOver6Months,"onUpdate:modelValue":t[7]||(t[7]=c=>e.reasonsForOver6Months=c),placeholder:"Enter reason for over 6 months medication"},null,8,["modelValue"])]),_:1})])):q("",!0)],512),[[O,e.accordionState.nextVisitSection]])])])}const Ut=Oe(Ae,[["render",xt],["__scopeId","data-v-b0b7ac4d"]]);export{Ut as default};
