import{d as H,c_ as j,r as V,a as B,y as L,f as D,z as i,l,u as r,ad as N,k as d,bq as b,ac as g,ab as _,D as h,A,B as y,av as U,e as O,F as M,L as R,G as z,ar as q,ag as G,O as v}from"./vendor-DowD5zKn.js";import{_ as F}from"./DatePicker.vue_vue_type_script_setup_true_lang-DhIL5mOk.js";import{P as Y,ad as T,t as Q,m as k,k as W,_ as J}from"./index-Cd6xOYoL.js";import{A as K}from"./app_encounter_service-BtCPTlWa.js";import{A as X}from"./adherence_service-BDfao5vR.js";import{g as Z}from"./LocationFieldOptions-ChZiqghB.js";import"./lodash-Dt8AsbQm.js";const ee={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},te={class:"error"},ae={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},ne={class:"error"},le={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},re={class:"error"},ie={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},oe={class:"error"},se=H({__name:"EmergencyRefill",setup(ue,{expose:P}){const x=new Y,f=new K(x.getID(),25,-1,""),u=new X(x.getID(),f.providerID),n=j({date_of_emergency_refill:"",facility:"",drugs:[],next_appointment:"",selectedFacilityObj:null}),o=V({}),I=V([]),s={date_of_emergency_refill:{required:()=>!0,dataHandler:e=>{n.date_of_emergency_refill=e},validation:async()=>{var t,a,m;if(!n.date_of_emergency_refill){o.value.date_of_emergency_refill="Date is required";return}if(v(n.date_of_emergency_refill).isAfter(v())){o.value.date_of_emergency_refill="Date cannot be in the future";return}const e=(m=(a=(t=u.getLastDrugs())==null?void 0:t[0])==null?void 0:a.order)==null?void 0:m.start_date;e&&v(n.date_of_emergency_refill).isBefore(e)&&await T("Date entered is less than last known dispensation of ".concat(v(e).format("DD-MMM-YYYY")))},buildObs:()=>f.buildValueDate("Prescription refill date",n.date_of_emergency_refill)},facility:{required:()=>!0,dataHandler:e=>{n.facility=e.label,n.selectedFacilityObj=e},searchFacilities:e=>Z(e).then(t=>I.value=t),validation:()=>{n.facility||(o.value.facility="Facility is required")},buildObs:()=>f.buildValueText("Health facility name",n.facility)},drugs:{required:()=>!0,dataHandler:e=>{e.field==="remainingAmount"?n.drugs[e.index].other.remainingAmount=e.value:e.field==="givenAmount"&&(n.drugs[e.index].other.givenAmount=e.value)},validation:()=>{n.drugs.some(e=>!e.other.remainingAmount||!e.other.givenAmount)&&(o.value.drugs="Please enter both remaining and given amounts for all drugs")},buildObs:()=>n.drugs.map(async e=>{const t=u.calculateAdherence(e.other.drug.quantity,e.other.remainingAmount,S(e.other.drug));return{...await u.buildValueCoded("Medications dispensed",e.value),child:[await u.buildPillCountObs(e.other.drug.order_id,e.other.remainingAmount),await u.buildAdherenceObs(e.other.drug.order_id,e.other.drug.drug_id,t,n.date_of_emergency_refill),await u.buildValueNumber("Amount of drug dispensed",e.other.givenAmount)]}})},next_appointment:{required:()=>!0,dataHandler:e=>{n.next_appointment=e},validation:()=>{if(!n.next_appointment){o.value.next_appointment="Next appointment date is required";return}n.date_of_emergency_refill&&v(n.next_appointment).isBefore(n.date_of_emergency_refill)&&(o.value.next_appointment="Next appointment date must be after emergency refill date")},buildObs:()=>f.buildValueDate("Appointment date",n.next_appointment)}};function S(e){const t=a=>"".concat(a).match(/qod/i)?"QOD":"".concat(a).match(/weekly/i)?"QW":a;return u.calculateExpected(e.quantity,e.equivalent_daily_dose,e.order.start_date,t(e.frequency))}function p(e,t){e in s&&typeof s[e].dataHandler=="function"&&s[e].dataHandler(t),w(e)}function w(e){if(o.value[e]="",typeof s[e].required=="function"&&s[e].required()&&!n[e]){o.value[e]="This field is required";return}n[e]&&typeof s[e].validation=="function"&&s[e].validation()}function E(){return Object.keys(n).reduce((e,t)=>{if(t in s&&n[t]&&typeof s[t].buildObs=="function"){const a=s[t].buildObs();return Array.isArray(a)?[...e,...a]:[...e,a]}return e},[])}async function $(){if(Object.keys(s).forEach(t=>w(t)),Object.keys(o.value).some(t=>"".concat(o.value[t]).length>=1))return Q("Please review form for errors");try{if(!await f.createEncounter())return k("Failed to create encounter");const a=await Promise.all(E());await f.saveObservationList(a),W("Emergency refill saved successfully")}catch(t){console.error("Error saving emergency refill data:",t),k("Failed to save emergency refill data")}}async function C(){await u.loadPreviousDrugs(),n.drugs=u.getLastDrugs().map(e=>({label:e.drug.name,value:e.drug.concept_id,other:{givenAmount:"",remainingAmount:"",drug:e}}))}return B(async()=>{await C()}),P({onSubmit:$}),(e,t)=>(D(),L(r(G),null,{default:i(()=>[l(r(N),null,{default:i(()=>[d("div",ee,[l(r(b),null,{default:i(()=>[l(r(g),null,{default:i(()=>[l(r(_),null,{default:i(()=>[l(r(h),null,{default:i(()=>t[5]||(t[5]=[A("Date of emergency refill")])),_:1,__:[5]}),l(F,{place_holder:"Select date",onDateUpDated:t[0]||(t[0]=a=>p("date_of_emergency_refill","".concat(a.value.year,"-").concat(a.value.month,"-").concat(a.value.day))),date_prop:""}),d("div",te,y(o.value.date_of_emergency_refill),1)]),_:1})]),_:1})]),_:1})]),d("div",ae,[l(r(b),null,{default:i(()=>[l(r(g),null,{default:i(()=>[l(r(_),null,{default:i(()=>[l(r(U),{modelValue:n.selectedFacilityObj,"onUpdate:modelValue":[t[1]||(t[1]=a=>n.selectedFacilityObj=a),t[2]||(t[2]=a=>p("facility",a))],multiple:!1,taggable:!1,"close-on-select":!0,openDirection:"bottom","tag-placeholder":"Find and select facility",placeholder:"Select facility where emergency refill was collected",selectLabel:"",label:"label",searchable:!0,"track-by":"label",onSearchChange:t[3]||(t[3]=a=>s.facility.searchFacilities(a)),options:I.value},null,8,["modelValue","options"]),d("div",ne,y(o.value.facility),1)]),_:1})]),_:1})]),_:1})]),d("div",le,[l(r(h),null,{default:i(()=>t[6]||(t[6]=[A("Emergency Supply Drugs")])),_:1,__:[6]}),(D(!0),O(M,null,R(n.drugs,(a,m)=>(D(),O("div",{key:m,class:"drug-item"},[l(r(b),null,{default:i(()=>[l(r(g),null,{default:i(()=>[l(r(_),{size:"12"},{default:i(()=>[l(r(z),{lines:"none"},{default:i(()=>[l(r(h),null,{default:i(()=>[A(y(a.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),l(r(g),null,{default:i(()=>[l(r(_),{size:"6"},{default:i(()=>[l(r(q),{modelValue:a.other.remainingAmount,"onUpdate:modelValue":c=>a.other.remainingAmount=c,onIonInput:c=>p("drugs",{index:m,field:"remainingAmount",value:c.detail.value}),placeholder:"Pills Remaining",label:"Pills Remaining","label-placement":"stacked",type:"number",fill:"outline"},null,8,["modelValue","onUpdate:modelValue","onIonInput"])]),_:2},1024),l(r(_),{size:"6"},{default:i(()=>[l(r(q),{modelValue:a.other.givenAmount,"onUpdate:modelValue":c=>a.other.givenAmount=c,onIonInput:c=>p("drugs",{index:m,field:"givenAmount",value:c.detail.value}),placeholder:"Pills Given",label:"Pills Given","label-placement":"stacked",type:"number",fill:"outline"},null,8,["modelValue","onUpdate:modelValue","onIonInput"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128)),d("div",re,y(o.value.drugs),1)]),d("div",ie,[l(r(b),null,{default:i(()=>[l(r(g),null,{default:i(()=>[l(r(_),null,{default:i(()=>[l(r(h),null,{default:i(()=>t[7]||(t[7]=[A("Next Appointment Date")])),_:1,__:[7]}),l(F,{place_holder:"Select next appointment date",onDateUpDated:t[4]||(t[4]=a=>p("next_appointment","".concat(a.value.year,"-").concat(a.value.month,"-").concat(a.value.day))),date_prop:""}),d("div",oe,y(o.value.next_appointment),1)]),_:1})]),_:1})]),_:1})])]),_:1})]),_:1}))}}),ye=J(se,[["__scopeId","data-v-7137c89c"]]);export{ye as default};
