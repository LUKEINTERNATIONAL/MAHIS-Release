import{d as Ne,ar as Re,cm as Be,r as n,a$ as p,c as Fe,a as Le,w as u,y as J,f as N,z as R,l,e as Ee,m as Y,k as m,u as y,bN as ze,d6 as He,ah as Me,i as f,bG as We,v as g,an as Ve,dJ as $e,bg as h}from"./vendor-CvwB6MYL.js";import{u as Ge,_ as Ue}from"./useFormWizard-BTBVIyt2.js";import{u as Je,aC as Ye,aQ as Qe,a3 as je,c as qe,aE as Ke,O as Xe,a4 as Ze,aR as et,aS as tt,aI as at,T as st,D as nt,t as B,C as F,m as S,ab as ot,E as it,H as L,aF as D,aA as Q,aT as j,S as lt,_ as rt}from"./index-Dh8jAzJ9.js";import{D as ct}from"./DemographicBar-DP2x52B5.js";import{C as ut,O as mt,a as pt,b as vt}from"./OPDOutcome-Bl6rIvUU.js";import{I as dt,N as ft,s as gt,a as ht,d as yt,b as Dt}from"./NextAppointment-DxWTJYVv.js";import{O as Pt}from"./OPDPrintingModal-93xWpvhS.js";import{l as q}from"./lodash-Dt8AsbQm.js";import{u as bt}from"./usePatientProfile-B4-p_dGz.js";import"./apexcharts-CCGezHdX.js";import"./patient_complaints_service-DtWbU4D4.js";import"./DashBox-ZH-gG7wB.js";import"./useExposeFromStandardForm-DAyhudYO.js";import"./BasicForm-Cq55EW8Z.js";import"./DateInputField-DcL6FqqX.js";import"./formatServerData-C-TF8Na0.js";import"./drug_prescription_service-Czw8Pv0G.js";import"./drug_service-Cu0Jp6GA.js";import"./Outcome-DO7Wiyjh.js";import"./lab_order-C4NXVc13.js";import"./group_validation-BILZ-YFA.js";import"./ncd_appointment_service-ChYFKDtY.js";import"./Registration-gBlq_nNc.js";import"./useLocation-DiU54dnW.js";import"./vaccines_service-dz2363Ga.js";import"./sms_service-DpRFIz3G.js";import"./EIRreportsStore-ksrEIbQz.js";import"./Export-DDmkP85o.js";const wt={key:0,class:"spinner-overlay"},St={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Ot={class:"back_profile"},_t=Ne({__name:"ConsultationPlan",setup(At){const{currentTabIndex:v}=Ge("Consultation Plan"),{printVisitSummary:K}=bt(),P=Re(),X=Be(),O=n(!1),_=n(!0),E=n(!1),A=n(!1),C=n(!0),Z=n(!1),T=n(!1),ee=n(!1),te=Je(),ae=Ye(),se=Qe(),ne=je(),oe=qe(),z=Ke(),H=Xe(),ie=Ze(),le=et(),re=tt(),{patient:b}=p(te),{investigations:ce}=p(ae),{OPDdiagnosis:ue}=p(se),{selectedMedicalDrugsList:me,nonPharmalogicalTherapyAndOtherNotes:M}=p(ne),{OPDActivities:w}=p(oe),{outcomes:pe}=p(z),{currentSelectedNextAppointmentDate:ve}=p(le),{presentingComplaints:de}=p(re),{vitals:fe}=p(ie),ge=at(),W=Fe(()=>ge.selectedMedicalAllergiesList),V=n(null),he=n(null),$=n(null),ye=n(null),De=n(null),Pe=n(null),I=n(null),G=()=>w.value.map(e=>({title:e,icon:""})),s=n(G()),be=n({}),we=async(e,t,i)=>{if(t===0&&await Ae(),!await U()){B("Please add presenting complaints before proceeding.");return}await r(),e%1===0&&(v.value=e),I.value&&i&&I.value.changeTab(e)},d=()=>{var i;if(!s.value||s.value.length===0)return null;const e=v.value>=0&&v.value<s.value.length?v.value:0;switch((i=s.value[e])==null?void 0:i.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(w.value.length>0)switch(w.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Se=()=>{P.push("home")},Oe=async()=>{A.value=!0,F("Printing consultation summary... Please wait.");try{await K(),F("Consultation summary printed successfully!"),setTimeout(()=>{P.push("home")},3500)}catch(e){S("Failed to print consultation summary.")}finally{A.value=!1}},_e=()=>{F("Patient has finished consultation!"),P.push("home")},U=async()=>{const e=await ot.getObsByEncounterIdAndDate(it.PRESENTING_COMPLAINTS);return!!(e&&e.length>0)},r=async()=>{var t,i;const e=L.sessionDate();for(let o=0;o<s.value.length;o++)if(!await U())_.value=!1,s.value[o].title!=="Clinical Assessment"&&(s.value[o].icon=$e);else{_.value=!0,E.value=!1;const c=s.value[o];if(be.value={title:"Untitled"},c.title==="Clinical Assessment"){const a=D("presentingComplaints");s.value[o].icon=x(e,a)?h:""}else if(c.title==="Investigations"){const a=(i=(t=b.value)==null?void 0:t.labOrders)==null?void 0:i.saved,k=a==null?void 0:a.filter(ke=>L.toStandardHisFormat(e)===L.toStandardHisFormat(ke.order_date));s.value[o].icon=(k==null?void 0:k.length)>0?h:""}else if(c.title==="Diagnosis"){const a=D("diagnosis");s.value[o].icon=x(e,a)?h:""}else if(c.title==="Treatment Plan"){const a=D("treatment");s.value[o].icon=(a==null?void 0:a.length)>0?h:""}else if(c.title==="Next Appointment"){const a=D("appointments");s.value[o].icon=x(e,a)?h:""}else if(c.title==="Outcome"){const a=D("outcomes");s.value[o].icon=(a==null?void 0:a.length)>0?h:""}}},x=(e,t)=>{if(!t)return!1;const i=new Date(e);return i.setHours(0,0,0,0),t.some(o=>{const c=new Date(o.obs_datetime||o.order_date);return c.setHours(0,0,0,0),c.getTime()===i.getTime()})},Ae=async()=>{var e;O.value=!0;try{await Ce(),await Promise.all([(e=V.value)==null?void 0:e.onSubmit()]),await Q(b.value),j()}catch(t){throw console.error("Error saving clinical assessment:",t),S("Failed to save clinical assessment"),t}finally{O.value=!1}},Ce=async()=>{try{if(!q.isEmpty(W.value)){const e=Ie();await gt(e)}}catch(e){console.error("Failed to save allergies:",e),B("Failed to save allergies")}},Te=async()=>{try{if(!q.isEmpty(M.value)){const e=[{concept_id:2688,obs_datetime:localStorage.getItem("sessionDate"),value_text:M.value,location_id:H.facilityLocation.code}];await ht(e)}await yt(),await Dt().saveNonPharmaTherapyPatientData()}catch(e){console.error("Failed to save treatment plan:",e),B("Failed to save treatment plan")}},Ie=()=>W.value.map(e=>({concept_id:985,obs_datetime:lt.getSessionDate(),value_coded:e.concept_id,location_id:H.facilityLocation.code})),xe=async()=>{var e;try{(e=$.value)==null||e.onSubmit(),await Te(),await z.saveOutcomPatientData(),await j(),await Q(b.value);const t=localStorage.getItem("locationID"),i=localStorage.getItem("userRoles");if(!t){S("Location ID could not be found. Please check your settings.");return}const c=(i?JSON.parse(i):[]).some(a=>a.role==="Lab")}catch(t){console.error("Error saving consultation data:",t),S("Failed to save consultation data")}};return Le(async()=>{if(w.value.length===0){await P.push("home");return}s.value=G(),await r(),(v.value===void 0||v.value<0)&&(v.value=0)}),u(fe,async()=>{await r()},{deep:!0}),u(b,async()=>{await r()},{deep:!0}),u(ce,async()=>{await r()},{deep:!0}),u(ue,async()=>{await r()},{deep:!0}),u(me,async()=>{await r()},{deep:!0}),u(pe,async()=>{await r()},{deep:!0}),u(ve,async()=>{await r()}),u(de,async()=>{await r()},{deep:!0}),u(X,async()=>{C.value=!1,setTimeout(()=>{v.value=0,C.value=!0},0)},{deep:!0}),u(ee,e=>{T.value=e,T.value&&setTimeout(()=>{T.value=!1},15e3)}),(e,t)=>(N(),J(y(Ve),null,{default:R(()=>[l(Pt,{onYes:Oe,onNo:_e,isOpen:Z.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),O.value?(N(),Ee("div",wt,[l(y(ze),{name:"bubbles"}),t[2]||(t[2]=m("div",{class:"loading-text"},"Please wait...",-1))])):Y("",!0),l(y(He),{"is-open":A.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(st),l(y(Me),{fullscreen:!0},{default:R(()=>[l(ct),m("div",St,[C.value?(N(),J(Ue,{key:0,ref_key:"wizard",ref:I,"vertical-tabs":"","navigable-tabs":_.value,"scrollable-tabs":"",startIndex:0,doneButton:{text:"Finish",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},nextButton:{disabled:E.value},"custom-tabs":s.value,tabs:s.value,onChange:we,"onComplete:wizard":t[1]||(t[1]=i=>xe())},{default:R(()=>[m("div",null,[m("div",Ot,[l(nt,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:y(We),"font-weight":"600",onClick:t[0]||(t[0]=i=>Se())},null,8,["icon"])])]),f(m("div",null,[l(ut,{ref_key:"clinicalAssessmentRef",ref:V},null,512)],512),[[g,d()==="ClinicalAssessment"]]),f(m("div",null,[l(dt,{ref_key:"investigationsRef",ref:he},null,512)],512),[[g,d()==="Investigations"]]),f(m("div",null,[l(mt,{ref_key:"diagnosisRef",ref:$},null,512)],512),[[g,d()==="OPDDiagnosis"]]),f(m("div",null,[l(pt,{ref_key:"treatmentPlanRef",ref:ye},null,512)],512),[[g,d()==="OPDTreatmentPlan"]]),f(m("div",null,[l(ft,{ref_key:"nextAppointmentRef",ref:De},null,512)],512),[[g,d()==="NextAppointment"]]),f(m("div",null,[l(vt,{ref_key:"outcomeRef",ref:Pe},null,512)],512),[[g,d()==="Outcome"]])]),_:1},8,["navigable-tabs","nextButton","custom-tabs","tabs"])):Y("",!0)])]),_:1})]),_:1}))}}),ta=rt(_t,[["__scopeId","data-v-fe3a3a34"]]);export{ta as default};
