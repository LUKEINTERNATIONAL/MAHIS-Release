var ee=Object.defineProperty;var te=(e,t,i)=>t in e?ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var _=(e,t,i)=>te(e,typeof t!="symbol"?t+"":t,i);import{d as ie,d7 as ne,aw as se,ax as ae,M as oe,J as re,W as ce,ay as le,d8 as de,cv as ue,cu as he,D as me,G as ge,I as pe,dx as q,K as fe,e6 as ve,e7 as L,E as S,e as m,f as d,k as s,i as R,l as f,v as V,z as I,F as P,L as C,A as k,B as u,y as z,m as N,p as T,d3 as ye}from"./vendor-DowD5zKn.js";import{S as be,H as x,aW as G,a5 as F,cp as w,W as _e,cq as Ie,cr as Se,J as Pe,u as Ce,cs as we,m as J,a3 as De,ct as ke,cu as W,cv as Oe,_ as Ee}from"./index-Cd6xOYoL.js";import{C as Re}from"./consultation_service-CnT5fN18.js";import{l as $}from"./lodash-Dt8AsbQm.js";import{A as g}from"./app_encounter_service-BtCPTlWa.js";import{u as Ve}from"./Arrays-CfBll-2n.js";import{P as Te}from"./patient_type_service-BpmS2uQh.js";class D extends be{constructor(){super()}static getAllArvRegimens(){return this.getJson("programs/".concat(this.getProgramID(),"/all_arv_regimens"))}static getRegimens(t){return this.getJson("programs/".concat(this.getProgramID(),"/regimens"),{patient_id:t})}static getCustomIngridients(){return this.getJson("programs/".concat(this.getProgramID(),"/custom_regimen_ingredients"))}static getCurrentRegimen(t,i=this.getSessionDate()){return this.getJson("programs/".concat(this.getProgramID(),"/").concat(t),{date:i})}static getRegimenExtras(t,i){return this.getJson("programs/".concat(this.getProgramID(),"/regimen_extras"),{name:t,weight:i})}}class A extends g{constructor(i,n){super(i,25,n);_(this,"nextVisitInterval");_(this,"fastTrack");_(this,"regimenExtras");_(this,"hangingPills");_(this,"fastTrackMedications");_(this,"medicationOrders");_(this,"treatmentState");_(this,"contraindications");_(this,"sideEffects");_(this,"tptPrescriptionCount");_(this,"lastSideEffectDate");this.nextVisitInterval=0,this.fastTrack=!1,this.regimenExtras=[],this.fastTrackMedications=[],this.hangingPills=[],this.medicationOrders=[],this.treatmentState="",this.contraindications={},this.sideEffects={},this.tptPrescriptionCount=0,this.lastSideEffectDate=""}setNextVisitInterval(i){this.nextVisitInterval=i}getHangingPills(){return this.hangingPills}getMedicationOrders(){return this.medicationOrders.map(i=>g.getCachedConceptName(i))}getTptPrescriptionCount(){return this.tptPrescriptionCount}getLastSideEffectDate(){return this.lastSideEffectDate}getContraindications(){return this.contraindications}getSideEffects(){return this.sideEffects}getRegimenExtras(){return this.regimenExtras}getPatientRegimens(){return D.getRegimens(this.patientID)}getARVs(){return D.getJson("arv_drugs")}getCustomIngridients(){return D.getCustomIngridients()}getFastTrackMedications(){return this.fastTrackMedications}getTreatmentState(){return this.treatmentState}isFastTrack(){return this.fastTrack}medicationOrdersAvailable(){return!$.isEmpty(this.medicationOrders)}shouldPrescribeExtras(){return g.getConceptsByCategory("art_extra_medication_order").map(o=>this.medicationOrders.includes(o.concept_id)).some(Boolean)}getRegimenStarterpack(i,n){const o={weight:n,regimen:i};return g.getJson("programs/".concat(g.getProgramID(),"/regimen_starter_packs"),o)}async getLvpDrugsByType(i,n){return g.getJson("programs/".concat(g.getProgramID(),"/regimens/").concat(n),{patient_id:this.patientID,lpv_drug_type:i})}async loadContraindications(){const i=await g.getConceptID("Contraindications");(await g.getObs({concept_id:i,person_id:this.patientID})).forEach(o=>{const r=x.toStandardHisFormat(o.obs_datetime);this.contraindications[r]||(this.contraindications[r]=[]);const c=g.getCachedConceptName(o.value_coded);this.contraindications[r].push(c)})}async loadDrugInduced(){const i=await g.getConceptID("Drug induced"),n=await g.getObs({concept_id:i,person_id:this.patientID});n&&n.forEach(o=>{const r=x.toStandardHisFormat(o.obs_datetime);if(this.lastSideEffectDate||(this.lastSideEffectDate=r),!o.value_drug||!o.value_coded)return;this.sideEffects[r]||(this.sideEffects[r]={}),this.sideEffects[r][o.value_drug]||(this.sideEffects[r][o.value_drug]=[]);const c=g.getCachedConceptName(o.value_coded);this.sideEffects[r][o.value_drug].push(c)})}async loadTptPrescriptionCount(){const i=await g.getJson("tpt_prescription_count",{patient_id:this.patientID,date:this.date});if(i){const n=i.count+1;this.tptPrescriptionCount=n>3?3:n}}async loadFastTrackStatus(){const i=await g.getFirstValueCoded(this.patientID,"Fast track"),n=await g.getConceptID("yes");i&&(this.fastTrack=i===n)}async loadRegimenExtras(i=this.date){const n=await D.getJson("programs/".concat(D.getProgramID(),"/patients/").concat(this.patientID,"/dosages"),{date:i});n&&(this.regimenExtras=Object.values(n))}async loadMedicationOrders(){const i=await g.getConceptID("Medication orders"),n=await g.getObs({concept_id:i,date:this.date,person_id:this.patientID,page_size:5});this.medicationOrders=n.map(o=>o.value_coded)}async loadHangingPills(){const i=await g.getAll(this.patientID,"Pills brought")||[];this.hangingPills=i.filter(n=>n.value_numeric>=1?n.value_drug&&G(n.obs_datetime)===G(this.date)?!0:n.order||!1:!1).map(n=>{var o,r;return((r=(o=n==null?void 0:n.order)==null?void 0:o.drug_order)==null?void 0:r.drug_inventory_id)||n.value_drug})}async loadFastTrackMedications(){const n=(await F.getLastDrugsReceived(this.patientID)).map(async o=>{const{drug:r}=o,c=await F.getDrugDosages(this.patientID,r.drug_id);return{drug_id:r.drug_id,drug_name:r.name,units:r.units,am:c.am,noon:c.noon,pm:c.pm,frequency:o.frequency}});this.fastTrackMedications=await Promise.all(n)}async loadTreatmentState(){const i={date:this.date},n=await g.getJson("programs/".concat(g.getProgramID(),"/patients/").concat(this.patientID,"/status"),i);n&&(this.treatmentState=n.status)}findAndGroupDrugSideEffects(i){const n={};for(const o in this.sideEffects){const r=this.sideEffects[o];for(const c in r)i.includes(parseInt(c))&&(n[o]||(n[o]=[]),n[o]=[...n[o],...r[c]])}return n}calculatePillsPerDay(i,n,o){return parseFloat(i.toString())+n+o}estimatePackSize(i,n=0){const o=i*this.nextVisitInterval/(n||1);let r=Math.round(o);return r<=0&&(r+=1),r}calculateDosage(i,n){let o=0;return n===0&&(o=i),i==0&&(o=n),i>0&&n>0&&(o=(i+n)/2),o}calculateEquivalentDosage(i,n){return i+n}calculateDateFromInterval(){const i=new Date(this.date);return i.setDate(i.getDate()+this.nextVisitInterval),x.toStandardHisFormat(i)}getDrugPackSize(i){if(i.pack_size)return i.pack_size;try{return i.barcodes[0].tabs}catch(n){return 30}}getInstructions(i,n,o,r){return"".concat(i," :- Morning: ").concat(n," ").concat(r,", Evening: ").concat(o," ").concat(r)}toOrderObj(i,n,o,r=0,c=0,h=""){return{drug_inventory_id:i,equivalent_daily_dose:this.calculateEquivalentDosage(r,c),start_date:this.date,auto_expire_date:this.calculateDateFromInterval(),units:o,instructions:this.getInstructions(n,r,c,o),dose:this.calculateDosage(r,c),frequency:h}}async getReasonForRegimenSwitch(){const i=await g.getFirstValueText(this.patientID,"Reason for ARV switch");return i||"N/A"}async createDrugOrder(i){return F.create({encounter_id:this.encounterID,drug_orders:i})}async createHangingPillsObs(i){return this.saveValueTextObs("appointment type",i)}async createRegimenSwitchObs(i){return this.saveValueTextObs("Reason for ARV switch",i)}}var Y=(e=>(e.ARV_REGIMENS="arv_regimens",e.INTERVAL_SELECTION="next_visit_interval",e))(Y||{}),Q=(e=>(e.EXIT="exit",e.CONTINUE="continue",e))(Q||{}),K=(e=>(e.ON_VALUE="onValue",e.ON_BUILD="onBuild",e.BEFORE_NEXT="beforeNext",e))(K||{});const Me={"Do not prescribe LPV regimens together with 3HP":{priority:1,actions:{alert:async({regimenName:e})=>(await w("3HP - LPV/r conflict",e,"Regimens containing LPV/r <b>cannot</b> be prescribed together with 3HP",[{name:"Close",slot:"end",color:"danger"}],"his-danger-color"),"exit")},target:"arv_regimens",targetEvent:"onValue",conditions:{regimenCode(e){return[7,8,9,10,11,12].includes(e)},medicationOrders(e){return e.filter(t=>!!"".concat(t).match(/3hp/i)).length>=1}}},"Check for any adverse effects or contraindications associated with the regimen":{priority:1,actions:{alert:async({regimenCodeStr:e,sideEffectsTable:t})=>{const{columns:i,rows:n}=t;return await Se("Contraindications / Side effects for ".concat(e),"",i,n,[{name:"Select other regimen",slot:"start"},{name:"Keep selected regimen",slot:"end",color:"danger"}],"his-danger-color")==="Select other regimen"?"exit":"continue"}},target:"arv_regimens",targetEvent:"beforeNext",conditions:{hasSideEffects(e){return e},lastSideEffectDate(e,{currentDate:t}){return e>=t}}},"Recommend 2nd line regimen to children under 3":{priority:1,actions:{alert:async()=>await Ie("Recommendation","",["Children under 3 years often have a high viral load and may be infected with drug-resistant HIV from previous exposure to ARVs (mother's ART and/or infant nevirapine prophylaxis)","Therefore, children under <b>3 years</b> respond better when <b>started immediately on 2nd line regimen</b> (Regimen <b>11</b>)"],[{name:"Select another regimen",slot:"start"},{name:"Keep selected regimen",slot:"end",color:"danger"}],"his-warning-color")==="Select another regimen"?"exit":"continue"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{age(e){return e<3},regimenCode(e){return e!=11}}},"Provide a reason for switching regimens when patient already has one":{priority:1,actions:{alert:async e=>{const t=await _e("Are you sure you want to replace ".concat(e.currentRegimenStr,"?"),"Specify reason for switching regimen",["Policy change","Ease of administration (pill burden, swallowing)","Drug drug interaction","Pregnancy intention","Side effects","Treatment failure","Weight Change","Other"],[{name:"Cancel",slot:"start",color:"danger"},{name:"Continue",slot:"end",role:"action"}]);return t.selection&&t.action!="Cancel"?(e.reasonForSwitch=t.selection,"continue"):"exit"}},target:"arv_regimens",targetEvent:"onValue",conditions:{regimenCode(e,{currentRegimenCode:t}){return t!=-1&&e!=t}}},"Provide 14 day starter pack for LPV regimens for children under 3 years old":{priority:3,actions:{alert:async e=>await w("Starter pack needed for 14 days","".concat(e.treatmentInitiationState),"".concat(e.regimenName),[{name:"Cancel",slot:"start",color:"danger"},{name:"Prescribe starter pack",slot:"end"}],"his-info-color")==="Prescribe starter pack"?(e.starterPackNeeded=!0,"continue"):"exit"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{age(e){return e<3},regimenCode(e){return e===11},treatmentInitiationState(e){return["Initiation","Re-initiation"].includes(e)}}},"Provide 14 day starter pack for NVP based regimens on newly initiated/re-initiation patients":{priority:3,actions:{alert:async e=>await w("Starter pack needed for 14 days","".concat(e.treatmentInitiationState),"".concat(e.regimenName),[{name:"Cancel",slot:"start",color:"danger"},{name:"Prescribe starter pack",slot:"end"}],"his-info-color")==="Prescribe starter pack"?(e.starterPackNeeded=!0,"continue"):"exit"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{regimenCode(e){return[0,2,6].includes(e)},treatmentInitiationState(e){return["Initiation","Re-initiation"].includes(e)}}},"Ask to reuse hanging pills if any":{priority:5,actions:{alert:async e=>(await w("Hanging pills recommendation","Add hanging pills?","",[{name:"No",slot:"start",color:"warning"},{name:"Yes",slot:"end"}],"his-info-color")==="Yes"?e.hangingPillsStatus="Optimize - including hanging pills":e.hangingPillsStatus="Exact - excluding hanging pills","continue")},target:"next_visit_interval",targetEvent:"beforeNext",conditions:{drugs(e,{hangingPills:t}){return e.map(n=>t.includes(n)).some(Boolean)}}},"Provide warning of use of DTG regimen to women of reproductive age":{priority:2,actions:{alert:async({regimenName:e})=>await w("Use of DTG or EFV in women of reproductive age",e,["There is currently <u>no confirmation</u>","that <b>DTG</b> is safe in <u>very early pregnancy</u>","DTG-based regimens are therefore not used as standard 1st line regimens for","<u>girls and women</u> who may get pregnancy"].join(" "),[{name:"Select another regimen",slot:"start"},{name:"Continue with regimen",slot:"end",color:"danger"}],"his-danger-color")==="Select another regimen"?"exit":"continue"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{regimenCode(e){return e>=12},isChildBearing(e){return e}}},"Provide pallet options for LPV regimens for patient's whose weight is between 3 and 25 kgs":{priority:6,actions:{alert:async e=>{const t=await w("Pellets (cups) / Tabs","","Prescribe LPV/r in <b>Pellets (cups)</b> or <b>Tablets</b>?",[{name:"Granules",slot:"start"},{name:"Pellets",slot:"end"},{name:"Tabs",slot:"end"}],"his-info-color");return e.lpvType=t.toLowerCase(),"continue"}},target:"arv_regimens",targetEvent:"beforeNext",conditions:{weight(e){return e>=3&&e<=25},regimenCode(e){return e===11||e===9}}},"Provide 14 day interval for NVP or LVP Regimen starter pack":{priority:1,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{prescriptionType(e){return e==="Regimen"},selectedInterval(e){return e>14},starterPackNeeded(e){return e},regimenCode(e){return[0,2,6,11].includes(e)}}},"Restrict Emergency supply prescription to 1 month":{priority:1,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{selectedInterval:e=>e>28,patientType:e=>e==="Emergency supply"}},"Provide intervals upto 1 month, 2nd up to 2 months, and 3rd up to 6 months for Patients receiving TPT":{priority:2,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{prescriptionType(e){return e==="Regimen"},medicationOrders(e){return e.map(t=>!!"".concat(t).match(/3hp/i)).some(Boolean)},tptPrescriptionCount(e,{selectedInterval:t}){return Math.round(t/30)>e}}}},Ne={"Rifapentine or isoniazid should be taken weekly":{concept:"Weekly (QW)",priority:1,conditions:{drug(e){return"".concat(e).match(/Rifapentine|Isoniazid/i)}}},"Use daily frequency for any other drugs":{concept:"Daily (QOD)",priority:2,conditions:{drug(e){return!"".concat(e).match(/Rifapentine|Isoniazid/i)}}}};function xe(e,t){const i=[],n=[-1,"",null,void 0];for(const o in t){if(!(o in e))continue;const r=e[o];if(n.includes(r)){i.push(!1);continue}i.push(t[o](r,e))}return i.every(Boolean)}function Fe(e){return e.sort((t,i)=>t.priority&&i.priority&&t.priority<i.priority?-1:1)}function Ae(e){return e.sort((t,i)=>t.weight&&i.weight&&t.weight>i.weight?-1:1)}function j(e,t,i="",n="",o="priority"){const r=[];for(const c in t){const h=t[c];[h.target&&i&&h.target!=i,h.targetEvent&&n&&h.targetEvent!=n].some(Boolean)||xe(e,h.conditions)&&(h.title=c,h.description&&(h.description.text=h.description.info(e)),r.push(h))}return o==="priority"?Fe(r):Ae(r)}const $e=ie({name:"Prescription",data(){return{toDisplayFmt:W,toDisplayGenderFmt:Oe,accordionState:{allergySection:!0,medicationSection:!1,arvRegimensSection:!1,nextVisitSection:!1},consultation:L({}),prescription:L({}),chevronUp:ve,chevronDown:fe,reasonsForOver6Months:"",route:"",providerID:1,patientID:-1,facts:{age:-1,gender:"",weight:50,currentDate:"",isChildBearing:!1,isPregnant:!1,isBreastfeeding:!1,prescriptionType:"",patientType:"",tbStatus:"",tptStatus:{},tptPrescriptionCount:0,currentRegimenCode:-1,currentRegimenStr:"",drug:"",drugs:[],contraindications:{},hasSideEffects:!1,sideEffectsTable:{},lastSideEffectDate:"",regimenCode:-1,regimenCodeStr:"",regimenName:"",regimenDrugs:[],hangingPills:[],reasonForSwitch:"",starterPackNeeded:!1,hangingPillsStatus:"",treatmentInitiationState:"",lpvType:"",medicationOrders:[],selectedInterval:0,isEligibleForTpt:!1,customDrugs:[]},arvRegimens:[],medicationOptions:[],selectedRegimen:{},customRegimen:!1,allergyOption:"",Intervaloptions:[{label:"2 weeks",value:14},{label:"1 month",value:28},{label:"2 months",value:56},{label:"3 months",value:84},{label:"4 months",value:112},{label:"5 months",value:140},{label:"6 months",value:168},{label:"7 months",value:196},{label:"8 months",value:224},{label:"9 months",value:252},{label:"10 months",value:280},{label:"11 months",value:308},{label:"12 months",value:336}],allergyOptions:[{label:"Yes",value:"Yes"},{label:"No",value:"No"},{label:"Unknown",value:"Unknown"}],nextVisitInterval:1,selectedMedications:[],medicationRunOutDate:A.getSessionDate(),estimatedPacks:[],customIngredients:[],editableMedication:!1,customIngredientSearch:""}},components:{IonIcon:pe,IonItem:ge,IonLabel:me,IonSelect:he,IonSelectOption:ue,IonTextarea:de,IonCheckbox:le,IonButton:ce,IonAccordion:re,IonAccordionGroup:oe,IonRadio:ae,IonRadioGroup:se,IonNote:ne},computed:{noDispensation(){return this.medicationOptions.some(e=>e.value==="none"&&e.isChecked)},over6monthsMedication(){return this.nextVisitInterval>168},filteredIngredients(){if(!this.customIngredientSearch)return this.customIngredients;const e=this.customIngredientSearch.toLowerCase();return this.customIngredients.filter(t=>t.name.toLowerCase().includes(e))}},methods:{isChildBearing(){return this.facts.gender==="F"&&this.facts.age>=12&&this.facts.age<=50},toggleAccordion(e){this.accordionState[e]=!this.accordionState[e]},async onEvent(e,t){var n,o;const i=j(this.facts,Me,e,t);for(const r in i){const c=i[r];if((n=c==null?void 0:c.actions)!=null&&n.alert&&await((o=c==null?void 0:c.actions)==null?void 0:o.alert(this.facts))===Q.EXIT)return!1}return!0},formatDrugs(e){return e.map(t=>t.alternative_drug_name).join(" + ")},getDrugFrequency(e){this.facts.drug=e;const t=j(this.facts,Ne);if(!$.isEmpty(t))return t[0].concept},extractRegimenCode(e){try{return e.match(/n\/a/i)?-1:parseInt(e.substring(0,e.length))}catch(t){return console.warn(t),-1}},buildSideEffectsTable(e){const t=["Date","Contraindication(s)","Side effect(s)"],i=[];for(const n in e){const o=this.facts.contraindications[n]||[];i.push([W(n),o.join(", "),e[n].join(", ")])}return{columns:t,rows:i}},async toggleRegimen(e){if(this.selectedRegimen.name!==e.name){this.facts.lpvType="",this.facts.hangingPillsStatus="",this.facts.starterPackNeeded=!1,this.facts.regimenName="".concat(e.name," (").concat(this.formatDrugs(e.drugs),")"),this.facts.regimenCodeStr=e.name,this.facts.regimenCode=this.extractRegimenCode(e.name),this.facts.regimenDrugs=e.drugs,this.facts.drugs=e.drugs.map(i=>i.drug_id);const t=this.prescription.findAndGroupDrugSideEffects(this.facts.drugs);if(this.facts.hasSideEffects=!$.isEmpty(t),this.facts.sideEffectsTable=this.buildSideEffectsTable(t),!this.onEvent(Y.ARV_REGIMENS,K.ON_VALUE))return;this.selectedRegimen=e,this.selectedMedications=e.drugs,this.updateEstimatedPacks()}else this.selectedRegimen={},this.selectedMedications=[]},disableOption(e,t=!0){return{disabled:t,description:{color:"danger",show:"always",text:e}}},validateTPTOption(e){return this.facts.tptStatus.completed?this.disableOption("Completed TPT treatment"):this.facts.tptStatus.tb_treatment?this.disableOption("Completed/on TB treatment"):this.facts.isPregnant?this.disableOption("Pregnant patient"):!this.facts.tptStatus.eligible["3HP"]&&!this.facts.tptStatus.eligible["6H"]?this.disableOption("Not eligible to start or re-start TPT"):this.facts.tptStatus.tpt!==null&&this.facts.tptStatus.tpt!==e?this.disableOption("On ".concat(this.facts.tptStatus.tpt," treatment")):(this.facts.isEligibleForTpt=e.includes("3HP")?this.facts.tptStatus.eligible["3HP"]:this.facts.tptStatus.eligible["6H"],this.facts.isBreastfeeding?this.disableOption("Breastfeeding patient",!1):this.facts.isEligibleForTpt&&this.facts.tptStatus.tpt===e&&!this.facts.tptStatus.completed?{isChecked:!0}:{})},buildTPTOption(e,t,i=0){const n={label:e,value:t,isChecked:!1,disabled:!1};if(i>0&&this.facts.weight<i)return{...n,...this.disableOption("Weight below regulation")};const o=this.validateTPTOption(e);return{...n,...o}},buildMedicationOptions(){this.medicationOptions=[{label:"ARVs",value:"arvs",isChecked:!1},{label:"CPT",value:"cpt",isChecked:!1,...this.allergyOption==="Yes"?this.disableOption("Allergic to sulphur"):{}},this.buildTPTOption("3HP (RFP + INH)","3hp",20),this.buildTPTOption("INH 300 / RFP 300 (3HP)","inh300",30),this.buildTPTOption("IPT","ipt",30),{label:"None",value:"none",isChecked:!1}]},async allergyChange(e){this.allergyOption=e.detail.value},nextVisitIntervalChange(e){const t=new Date;this.nextVisitInterval=e.detail.value,this.medicationRunOutDate=ke(t,this.nextVisitInterval,"days"),this.updateEstimatedPacks()},async onSubmit(){try{const e=[await this.createbuildValueCoded("Allergic to sulphur",this.allergyOption.toString())];this.noDispensation?e.push(await this.consultation.buildValueCoded("Prescribe drugs","No")):(e.push(await this.consultation.buildValueCoded("Prescribe drugs","Yes")),this.medicationOptions.forEach(async i=>{i.isChecked&&e.push(await this.consultation.buildValueCoded("Medication orders",i.label))})),await this.consultation.saveObservationList(e),await this.prescription.createEncounter(),this.prescription.setNextVisitInterval(this.nextVisitInterval);const t=this.selectedMedications.map(i=>this.prescription.toOrderObj(i.drug_id,i.alternative_drug_name||i.drug_name,i.units,i.am,i.pm,i.frequency||this.getDrugFrequency(i.drug_name)));if(await this.prescription.createDrugOrder(t),this.over6monthsMedication){const i=await this.consultation.buildValueCoded("Why prescribe medication for more than 6 months?",this.reasonsForOver6Months);await this.prescription.saveObservationList([i])}return!0}catch(e){return console.error("Error saving prescription:",e),J("Failed to save prescription"),!1}},async createbuildValueCoded(e,t){return await this.consultation.buildValueCoded(e,t)},async handleMedicationSelection(e,t,i){const n=e.detail.checked;if(i.value==="none"){n&&(this.medicationOptions=this.medicationOptions.map((c,h)=>({...c,isChecked:h===t}))),await this.updateSelectedMedications();return}i.value==="arvs"&&(n?(this.accordionState.arvRegimensSection=!0,this.accordionState.nextVisitSection=!0):(this.accordionState.arvRegimensSection=!1,this.accordionState.nextVisitSection=!1));const o=c=>!!c.label.match(/IPT|3HP|INH/i),r=this.medicationOptions.filter(o);if(o(i)){const c=p=>p.label==="3HP (RFP + INH)"||p.label==="INH 300 / RFP 300 (3HP)",h=r.some(p=>p.label==="IPT"&&p.isChecked);if(c(i)&&h&&n){const p=await this.showTPTConflictDialog();p==="Prescribe IPT"?this.medicationOptions=this.medicationOptions.map(l=>({...l,isChecked:c(l)?!1:l.isChecked})):p==="Prescribe 3HP"&&(this.medicationOptions=this.medicationOptions.map(l=>({...l,isChecked:l.label==="IPT"?!1:c(l)?l.label===i.label:l.isChecked}))),await this.updateSelectedMedications();return}if(c(i)&&n&&(this.medicationOptions=this.medicationOptions.map(p=>({...p,isChecked:c(p)?p.label===i.label:p.isChecked}))),i.label==="IPT"&&n&&r.some(l=>c(l)&&l.isChecked)){const l=await this.showTPTConflictDialog();l==="Prescribe IPT"?this.medicationOptions=this.medicationOptions.map(y=>({...y,isChecked:c(y)?!1:y.isChecked})):l==="Prescribe 3HP"&&(this.medicationOptions=this.medicationOptions.map(y=>({...y,isChecked:y.label==="IPT"?!1:y.isChecked}))),await this.updateSelectedMedications();return}}n&&i.value!=="none"&&(this.medicationOptions=this.medicationOptions.map(c=>({...c,isChecked:c.value==="none"?!1:c.isChecked}))),this.medicationOptions[t].isChecked=n,await this.updateSelectedMedications()},isCustomMedicationSelected(e){return this.selectedMedications.some(t=>t.drug_name===e.name)},toggleCustomMedication(e){const t=this.selectedMedications.findIndex(i=>i.drug_name===e.name);if(t>=0)this.selectedMedications.splice(t,1);else{const i={drug_id:e.drug_id,concept_id:e.concept_id,drug_name:e.name,concept_name:e.name,alternative_drug_name:e.name,units:e.units,am:0,noon:0,pm:0,frequency:"Daily (QOD)",pack_size:30,barcodes:[],regimen_category:"Custom"};this.selectedMedications.push(i)}this.updateEstimatedPacks()},addCustomMedication(e){const t={drug_id:e.drug_id,concept_id:e.concept_id,drug_name:e.name,concept_name:e.name,alternative_drug_name:e.name,units:e.units,am:0,noon:0,pm:0,frequency:"Daily (QOD)",pack_size:30,barcodes:[],regimen_category:"Custom"};this.selectedMedications.some(i=>i.drug_name===e.name)||(this.selectedMedications.push(t),this.updateEstimatedPacks())},async updateSelectedMedications(){this.selectedMedications=[];const e=async(t,i,n)=>{if(this.medicationOptions.find(r=>r.value===t&&r.isChecked)){const r=await D.getRegimenExtras(i,this.facts.weight),c=Ve(n?r.filter(n):r,"concept_name");this.selectedMedications.push(...c)}};this.medicationOptions.find(t=>t.value==="arvs"&&t.isChecked)&&this.selectedRegimen.drugs&&this.selectedMedications.push(...this.selectedRegimen.drugs),await e("cpt","Cotrimoxazole",t=>t.frequency==="Daily (QOD)"),await e("3hp","INH / RFP"),await e("inh300","INH / RFP"),await e("ipt","INH",t=>t.frequency==="Daily (QOD)"),this.updateEstimatedPacks()},updateEstimatedPacks(){this.prescription.setNextVisitInterval(this.nextVisitInterval),this.estimatedPacks=this.selectedMedications.map(e=>{const t=this.prescription.getDrugPackSize(e),i=this.prescription.calculatePillsPerDay(e.am,e.noon,e.pm),n=this.prescription.estimatePackSize(i,t);return{name:e.drug_name,quantity:n}})},async initFacts(){const e=await De.getProgramInformation(this.patientID);this.facts.hangingPills=this.prescription.getHangingPills(),this.facts.treatmentInitiationState=this.prescription.getTreatmentState(),this.facts.currentRegimenStr=e.current_regimen,this.facts.currentRegimenCode=this.extractRegimenCode(e.current_regimen),this.facts.medicationOrders=this.prescription.getMedicationOrders(),this.facts.contraindications=this.prescription.getContraindications(),this.facts.tptPrescriptionCount=this.prescription.getTptPrescriptionCount(),this.facts.lastSideEffectDate=this.prescription.getLastSideEffectDate(),this.facts.currentDate=A.getSessionDate(),this.facts.isChildBearing=this.isChildBearing(),this.facts.tptStatus=await this.consultation.getTptTreatmentStatus(),this.facts.customDrugs=await this.prescription.getCustomIngridients();const t=new Te(this.patientID,this.providerID);await t.loadPatientType(),this.facts.patientType=t.patientType},async showTPTConflictDialog(){return await w("TPT Conflict","You cannot prescribe IPT and 3HP together","Please choose one option",[{name:"Prescribe 3HP",slot:"start",color:"primary"},{name:"Prescribe IPT",slot:"end",color:"primary"}])},async fetchCustomIngredients(){try{const e=new Set;this.customIngredients=this.facts.customDrugs.filter(t=>e.has(t.name)?!1:(e.add(t.name),!0))}catch(e){console.error("Error fetching custom ingredients:",e),J("Failed to load custom ingredients")}}},watch:{nextVisitInterval:{handler(){this.updateEstimatedPacks()}},allergyOption:{handler(){this.buildMedicationOptions()}},medicationOptions:{handler(){this.updateSelectedMedications()},deep:!0},customRegimen:{async handler(e){e?(await this.fetchCustomIngredients(),this.selectedRegimen={},this.selectedMedications=[],this.editableMedication=!0,this.estimatedPacks=[]):(this.editableMedication=!1,this.selectedMedications=[],this.estimatedPacks=[])}}},async mounted(){var c,h,p;const e=Pe();this.providerID=Number(q(e.$state).user_ID)||1;const t=Ce(),i=q(t.$state).patient;if(this.patientID=(i==null?void 0:i.patientID)||25,this.facts.gender=(i==null?void 0:i.personInformation.gender)||"",this.facts.age=we(i==null?void 0:i.personInformation.birthdate),(h=(c=i==null?void 0:i.vitals)==null?void 0:c.saved)==null?void 0:h[0]){const l=i.vitals.saved.find(y=>y.concept_name==="Weight (kg)");l&&(this.facts.weight=l.value_numeric)}const o=(p=i==null?void 0:i.activePrograms)==null?void 0:p.find(l=>l.program.name==="HIV PROGRAM");o&&(this.facts.currentRegimenStr=o.program.name,this.facts.currentRegimenCode=this.extractRegimenCode(o.program.name)),this.consultation=new Re(this.patientID,this.providerID),this.prescription=new A(this.patientID,this.providerID);const r=await D.getRegimens(this.patientID);Object.entries(r).forEach(([l,y])=>{this.arvRegimens.push({name:l,drugs:y})}),await this.prescription.loadHangingPills(),await this.prescription.loadRegimenExtras(),await this.initFacts(),this.buildMedicationOptions()}}),He={class:"prescription-container h-full"},Ue={class:"accordion-section"},Be={class:"expand-btn"},qe={class:"accordion-content"},Le={class:"allergy-section"},ze={class:"accordion-section"},Ge={class:"expand-btn"},Je={class:"accordion-content"},We={class:"medication-options"},je={class:"option-grid"},Ye={class:"checkbox-text"},Qe={class:"accordion-section"},Ke={class:"expand-btn"},Xe={class:"accordion-content"},Ze={class:"patient-info"},et={class:"info-item"},tt={class:"info-value"},it={class:"info-item"},nt={class:"info-value"},st={class:"info-item"},at={class:"info-value"},ot={class:"info-item"},rt={class:"info-value"},ct={class:"info-item"},lt={class:"info-value"},dt={key:0},ut={class:"regimen-grid"},ht=["onClick"],mt={class:"regimen-id"},gt={class:"regimen-name"},pt=["onClick"],ft={class:"regimen-id"},vt={class:"regimen-name"},yt={key:1,class:"custom-regimen-scroll",style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"0.5rem"}},bt=["onClick"],_t={class:"regimen-name"},It={class:"regimen-units"},St={class:"custom-regimen"},Pt={class:"selected-medication-section"},Ct={class:"medication-table"},wt={class:"row-cell drug-name"},Dt={class:"row-cell units"},kt={class:"row-cell am"},Ot={class:"row-cell noon"},Et={class:"row-cell pm"},Rt={class:"row-cell frequency"},Vt={class:"row-cell am"},Tt={class:"row-cell noon"},Mt={class:"row-cell pm"},Nt={class:"row-cell frequency"},xt={class:"accordion-section"},Ft={class:"expand-btn"},At={class:"accordion-content"},$t={class:"next-visit-interval"},Ht={class:"medication-run-out"},Ut={class:"estimated-packs"},Bt={class:"pack-name"},qt={class:"pack-quantity"},Lt={key:0,class:"over-6-months-medication"};function zt(e,t,i,n,o,r){const c=S("ion-icon"),h=S("ion-radio"),p=S("ion-radio-group"),l=S("ion-checkbox"),y=S("ion-note"),O=S("ion-input"),M=S("ion-select-option"),H=S("ion-select"),U=S("ion-item"),X=S("ion-label"),Z=S("ion-textarea");return d(),m("div",He,[s("div",Ue,[s("div",{class:"accordion-header",onClick:t[0]||(t[0]=a=>e.toggleAccordion("allergySection"))},[t[10]||(t[10]=s("h3",null,"Allergy Information",-1)),s("button",Be,[f(c,{icon:e.accordionState.allergySection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),R(s("div",qe,[s("div",Le,[t[11]||(t[11]=s("div",{class:"allergy-label"},"Allergic to cotrimoxazole",-1)),f(p,{modelValue:e.allergyOption,"onUpdate:modelValue":t[1]||(t[1]=a=>e.allergyOption=a),onIonChange:e.allergyChange,class:"horizontal-options"},{default:I(()=>[(d(!0),m(P,null,C(e.allergyOptions,a=>(d(),m("div",{key:a.value,class:"horizontal-item"},[f(h,{value:a.value},{default:I(()=>[k(u(a.label),1)]),_:2},1032,["value"])]))),128))]),_:1},8,["modelValue","onIonChange"])])],512),[[V,e.accordionState.allergySection]])]),s("div",ze,[s("div",{class:"accordion-header",onClick:t[2]||(t[2]=a=>e.toggleAccordion("medicationSection"))},[t[12]||(t[12]=s("h3",null,"Medication to prescribe during this visit",-1)),s("button",Ge,[f(c,{icon:e.accordionState.medicationSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),R(s("div",Je,[s("div",We,[s("div",je,[(d(!0),m(P,null,C(e.medicationOptions,(a,b)=>{var v,B;return d(),m("div",{key:a.value,class:"option-item"},[f(l,{checked:a.isChecked,disabled:a.disabled,"label-placement":"end",onIonChange:E=>e.handleMedicationSelection(E,b,a)},{default:I(()=>[s("span",Ye,u(a.label),1)]),_:2},1032,["checked","disabled","onIonChange"]),t[13]||(t[13]=s("br",null,null,-1)),((v=a.description)==null?void 0:v.show)==="always"?(d(),z(y,{key:0,color:(B=a.description)==null?void 0:B.color},{default:I(()=>{var E;return[k(u((E=a.description)==null?void 0:E.text),1)]}),_:2},1032,["color"])):N("",!0)])}),128))])])],512),[[V,e.accordionState.medicationSection]])]),s("div",Qe,[s("div",{class:"accordion-header",onClick:t[3]||(t[3]=a=>e.toggleAccordion("arvRegimensSection"))},[t[14]||(t[14]=s("h3",null,"ARV Regimens",-1)),s("button",Ke,[f(c,{icon:e.accordionState.arvRegimensSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),R(s("div",Xe,[s("div",Ze,[s("div",et,[t[15]||(t[15]=s("span",{class:"info-label"},"Age:",-1)),s("span",tt,u(e.facts.age)+" Years",1)]),s("div",it,[t[16]||(t[16]=s("span",{class:"info-label"},"Gender:",-1)),s("span",nt,u(e.toDisplayGenderFmt(e.facts.gender)),1)]),s("div",st,[t[17]||(t[17]=s("span",{class:"info-label"},"Current Regimen:",-1)),s("span",at,u(e.facts.currentRegimenStr),1)]),s("div",ot,[t[18]||(t[18]=s("span",{class:"info-label"},"Current Weight:",-1)),s("span",rt,u(e.facts.weight),1)]),s("div",ct,[t[19]||(t[19]=s("span",{class:"info-label"},"Reason for change:",-1)),s("span",lt,u(e.facts.reasonForSwitch),1)])]),e.customRegimen?(d(),m("div",dt,[f(O,{modelValue:e.customIngredientSearch,"onUpdate:modelValue":t[4]||(t[4]=a=>e.customIngredientSearch=a),onInput:t[5]||(t[5]=a=>{var b;return e.customIngredientSearch=(b=a.target)==null?void 0:b.value}),placeholder:" Search medications...",class:"custom-search","clear-input":""},null,8,["modelValue"])])):N("",!0),s("div",ut,[e.customRegimen?(d(),m("div",yt,[(d(!0),m(P,null,C(e.filteredIngredients,a=>(d(),m("div",{key:a.name,class:T(["regimen-item",{selected:e.isCustomMedicationSelected(a)}]),onClick:b=>e.toggleCustomMedication(a)},[s("span",_t,u(a.name),1),s("span",It,"("+u(a.units)+")",1)],10,bt))),128))])):(d(),m(P,{key:0},[(d(!0),m(P,null,C(e.arvRegimens.slice(0,5),a=>(d(),m("div",{key:a.name,class:T(["regimen-item",{selected:e.selectedRegimen.name===a.name}]),onClick:b=>e.toggleRegimen(a)},[s("span",mt,u(a.name),1),s("span",gt,u(e.formatDrugs(a.drugs)),1)],10,ht))),128)),(d(!0),m(P,null,C(e.arvRegimens.slice(5),a=>(d(),m("div",{key:a.name,class:T(["regimen-item",{selected:e.selectedRegimen.name===a.name}]),onClick:b=>e.toggleRegimen(a)},[s("span",ft,u(a.name),1),s("span",vt,u(e.formatDrugs(a.drugs)),1)],10,pt))),128))],64))]),s("div",St,[t[20]||(t[20]=s("span",null,"Set custom regimen",-1)),f(l,{modelValue:e.customRegimen,"onUpdate:modelValue":t[6]||(t[6]=a=>e.customRegimen=a)},null,8,["modelValue"])]),s("div",Pt,[t[24]||(t[24]=s("h3",null,"Selected medication",-1)),s("div",Ct,[t[23]||(t[23]=ye('<div class="table-header" data-v-80133919><div class="header-cell drug-name" data-v-80133919>Drug name</div><div class="header-cell units" data-v-80133919>Units</div><div class="header-cell am" data-v-80133919>AM</div><div class="header-cell noon" data-v-80133919>Noon</div><div class="header-cell pm" data-v-80133919>PM</div><div class="header-cell frequency" data-v-80133919>Frequency</div></div>',1)),(d(!0),m(P,null,C(e.selectedMedications,(a,b)=>(d(),m("div",{key:b,class:T(["table-row",{highlighted:b===0}])},[s("div",wt,u(a.drug_name),1),s("div",Dt,u(a.units),1),e.editableMedication?(d(),m(P,{key:0},[s("div",kt,[f(O,{onIonInput:v=>a.am=parseFloat(v.target.value),type:"number",modelValue:a.am,"onUpdate:modelValue":v=>a.am=v,min:"0",class:"editable-input",style:{"background-color":"#f0f9ff",border:"1px solid #90caf9","border-radius":"4px"}},null,8,["onIonInput","modelValue","onUpdate:modelValue"])]),s("div",Ot,[f(O,{onIonInput:v=>a.noon=parseFloat(v.target.value),type:"number",modelValue:a.noon,"onUpdate:modelValue":v=>a.noon=v,min:"0",class:"editable-input",style:{"background-color":"#f0f9ff",border:"1px solid #90caf9","border-radius":"4px"}},null,8,["onIonInput","modelValue","onUpdate:modelValue"])]),s("div",Et,[f(O,{onIonInput:v=>a.pm=parseFloat(v.target.value),type:"number",modelValue:a.pm,"onUpdate:modelValue":v=>a.pm=v,min:"0",class:"editable-input",style:{"background-color":"#f0f9ff",border:"1px solid #90caf9","border-radius":"4px"}},null,8,["onIonInput","modelValue","onUpdate:modelValue"])]),s("div",Rt,[f(H,{modelValue:a.frequency,"onUpdate:modelValue":v=>a.frequency=v,onIonChange:v=>{a.frequency=v.detail.value,e.updateEstimatedPacks()}},{default:I(()=>[f(M,{value:"Daily (QOD)"},{default:I(()=>t[21]||(t[21]=[k("Daily")])),_:1,__:[21]}),f(M,{value:"Weekly"},{default:I(()=>t[22]||(t[22]=[k("Weekly")])),_:1,__:[22]})]),_:2},1032,["modelValue","onUpdate:modelValue","onIonChange"])])],64)):(d(),m(P,{key:1},[s("div",Vt,u(a.am),1),s("div",Tt,u(a.noon),1),s("div",Mt,u(a.pm),1),s("div",Nt,u(a.frequency),1)],64))],2))),128))])])],512),[[V,e.accordionState.arvRegimensSection]])]),s("div",xt,[s("div",{class:"accordion-header",onClick:t[7]||(t[7]=a=>e.toggleAccordion("nextVisitSection"))},[t[25]||(t[25]=s("h3",null,"Next Visit Information",-1)),s("button",Ft,[f(c,{icon:e.accordionState.nextVisitSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),R(s("div",At,[s("div",$t,[f(U,null,{default:I(()=>[f(H,{modelValue:e.nextVisitInterval,"onUpdate:modelValue":t[8]||(t[8]=a=>e.nextVisitInterval=a),interface:"popover",onIonChange:e.nextVisitIntervalChange,placeholder:"Select interval",label:"Interval to next visit","label-placement":"stacked"},{default:I(()=>[(d(!0),m(P,null,C(e.Intervaloptions,a=>(d(),z(M,{key:a.value,value:a.value},{default:I(()=>[k(u(a.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","onIonChange"])]),_:1})]),s("div",Ht,[t[26]||(t[26]=s("label",null,"Medication run out date:",-1)),s("span",null,u(e.toDisplayFmt(e.medicationRunOutDate)),1)]),s("div",Ut,[t[27]||(t[27]=s("h4",null,"Estimated packs/tins:",-1)),(d(!0),m(P,null,C(e.estimatedPacks,(a,b)=>(d(),m("div",{key:b,class:"pack-item"},[s("span",Bt,u(a.name),1),s("div",qt,u(a.quantity),1)]))),128))]),e.over6monthsMedication?(d(),m("div",Lt,[f(U,null,{default:I(()=>[f(X,{position:"stacked"},{default:I(()=>t[28]||(t[28]=[k("Specify reason for prescribing medication over 6 months "),s("span",{class:"required"},"*",-1)])),_:1,__:[28]}),f(Z,{modelValue:e.reasonsForOver6Months,"onUpdate:modelValue":t[9]||(t[9]=a=>e.reasonsForOver6Months=a),placeholder:"Enter reason for over 6 months medication"},null,8,["modelValue"])]),_:1})])):N("",!0)],512),[[V,e.accordionState.nextVisitSection]])])])}const Zt=Ee($e,[["render",zt],["__scopeId","data-v-80133919"]]);export{Zt as default};
