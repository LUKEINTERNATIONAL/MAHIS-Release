System.register(["./vendor-legacy-CJZC4Dfn.js","./prescription_service-legacy-B7doaGUv.js","./index-legacy-C4TpyYf0.js","./Arrays-legacy-BSC7onNe.js","./patient_type_service-legacy-D9b1aoav.js","./lodash-legacy-pOOc9Efu.js","./app_encounter_service-legacy-Ct6Y-4Xb.js"],function(e,t){"use strict";var i,a,n,o,s,r,c,l,d,m,u,p,g,h,f,v,b,y,x,w,k,I,S,C,P,_,O,R,V,T,D,E,M,N,F,H,A,U,q,z,B,L,j,$,G,W,Y,Q,K,X,J,Z,ee;return{setters:[e=>{i=e.d,a=e.d9,n=e.ad,o=e.ae,s=e.M,r=e.J,c=e.W,l=e.bO,d=e.da,m=e.cz,u=e.cy,p=e.D,g=e.G,h=e.I,f=e.e2,v=e.K,b=e.e3,y=e.e4,x=e.E,w=e.e,k=e.f,I=e.k,S=e.i,C=e.l,P=e.v,_=e.z,O=e.F,R=e.L,V=e.A,T=e.B,D=e.y,E=e.m,M=e.p,N=e.d5},e=>{F=e.C,H=e.P,A=e.R},e=>{U=e.cq,q=e.co,z=e.cs,B=e.ct,L=e.I,j=e.u,$=e.cu,G=e.l,W=e.a2,Y=e.cv,Q=e.cw,K=e.cx,X=e._},e=>{J=e.u},e=>{Z=e.P},e=>{ee=e.l},null],execute:function(){var t=document.createElement("style");t.textContent=".custom-search[data-v-9a4b7fa9]{margin-bottom:1rem;width:100%;background-color:#f0f9ff;border:1px solid #90caf9;border-radius:4px}.prescription-container[data-v-9a4b7fa9]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;max-width:800px;min-height:761px;margin:0 auto;padding:1rem;border-radius:4px;background-color:#fff}.header[data-v-9a4b7fa9]{display:flex;align-items:center;padding-bottom:1rem;border-bottom:1px solid #e0e0e0;margin-bottom:1.5rem;position:relative}h2[data-v-9a4b7fa9]{margin:0;flex-grow:1;font-size:1.3rem;font-weight:600}.accordion-section[data-v-9a4b7fa9]{margin-bottom:1rem;border:1px solid #e0e0e0;border-radius:4px;overflow:hidden}.accordion-header[data-v-9a4b7fa9]{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;background-color:#f5f5f5;cursor:pointer;user-select:none}.accordion-header h3[data-v-9a4b7fa9]{margin:0;font-size:1rem;font-weight:500}.expand-btn[data-v-9a4b7fa9]{background:none;border:none;cursor:pointer;font-size:1rem}.accordion-content[data-v-9a4b7fa9]{padding:1rem;border-top:1px solid #e0e0e0}.horizontal-options[data-v-9a4b7fa9]{display:flex;flex-direction:row;gap:1rem}.horizontal-item[data-v-9a4b7fa9]{--inner-padding-end: 0px;--padding-start: 0px;flex-shrink:0}.allergy-section[data-v-9a4b7fa9]{display:flex;align-items:center}.allergy-label[data-v-9a4b7fa9]{font-weight:500;margin-right:2rem;min-width:180px}.option-grid[data-v-9a4b7fa9]{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}.checkbox-option[data-v-9a4b7fa9]{display:flex;align-items:center;cursor:pointer}.checkbox-text[data-v-9a4b7fa9]{margin-left:.5rem}.patient-info[data-v-9a4b7fa9]{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;font-size:.9rem}.info-item[data-v-9a4b7fa9]{display:flex;align-items:center}.info-label[data-v-9a4b7fa9]{font-weight:500;margin-right:.3rem}.regimen-grid[data-v-9a4b7fa9]{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem;margin-bottom:1rem}.regimen-item[data-v-9a4b7fa9]{display:flex;align-items:center;padding:.5rem 1rem;background-color:#e6f7f9;border-radius:4px;cursor:pointer;transition:background-color .2s}.regimen-item.selected[data-v-9a4b7fa9]{background-color:#81d4fa;border:1px solid #4fc3f7}.regimen-id[data-v-9a4b7fa9]{font-weight:500;margin-right:1rem;min-width:30px}.custom-regimen[data-v-9a4b7fa9]{display:flex;align-items:center;justify-content:space-between;margin-top:1rem;padding-top:1rem;border-top:1px solid #e0e0e0}.selected-medication-section[data-v-9a4b7fa9]{margin-top:1.5rem}.medication-table[data-v-9a4b7fa9]{width:100%;border-collapse:collapse}.table-header[data-v-9a4b7fa9]{display:flex;font-weight:500;border-bottom:1px solid #e0e0e0;padding-bottom:.5rem}.table-row[data-v-9a4b7fa9]{display:flex;padding:.5rem 0;border-bottom:1px solid #f0f0f0}.highlighted[data-v-9a4b7fa9]{background-color:#fffde7}.header-cell[data-v-9a4b7fa9],.row-cell[data-v-9a4b7fa9]{padding:.5rem}.drug-name[data-v-9a4b7fa9]{flex:2}.units[data-v-9a4b7fa9],.am[data-v-9a4b7fa9],.noon[data-v-9a4b7fa9],.pm[data-v-9a4b7fa9],.frequency[data-v-9a4b7fa9],.action[data-v-9a4b7fa9]{flex:1;text-align:center}.remove-btn[data-v-9a4b7fa9]{background-color:#f44336;color:#fff;border:none;border-radius:4px;padding:.25rem .5rem;cursor:pointer;font-size:.8rem}.remove-btn[data-v-9a4b7fa9]:hover{background-color:#d32f2f}.next-visit-interval[data-v-9a4b7fa9]{margin-bottom:1rem}.pack-quantity[data-v-9a4b7fa9]{background-color:#e8f5e9;color:#2e7d32;font-weight:500;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:4px}@media (max-width: 768px){.allergic-row[data-v-9a4b7fa9]{flex-direction:column;align-items:flex-start}.radio-group[data-v-9a4b7fa9]{margin-top:10px}}.required[data-v-9a4b7fa9]{color:red}.medication-run-out[data-v-9a4b7fa9]{margin-bottom:1rem}.estimated-packs[data-v-9a4b7fa9]{margin-top:1rem}h4[data-v-9a4b7fa9]{font-size:.9rem;font-weight:500;margin-bottom:.5rem}.pack-item[data-v-9a4b7fa9]{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}.pack-quantity[data-v-9a4b7fa9]{width:30px;height:30px;display:flex;align-items:center;justify-content:center;background-color:#e8f5e9;border-radius:4px}.save-section[data-v-9a4b7fa9]{display:flex;justify-content:flex-start;margin-top:1.5rem}.save-btn[data-v-9a4b7fa9]{padding:.5rem 1.5rem;background-color:#1b5e20;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:500}.save-btn[data-v-9a4b7fa9]:hover{background-color:#2e7d32}.row-cell ion-input[data-v-9a4b7fa9]{--padding-start: 4px;--padding-end: 4px;--padding-top: 4px;--padding-bottom: 4px;--border: 1px solid #ddd;--border-radius: 4px}.row-cell ion-select[data-v-9a4b7fa9]{--padding-start: 4px;--padding-end: 4px;max-width:100%}.regimen-units[data-v-9a4b7fa9]{color:#666;font-size:.9em;margin-left:.5rem}.custom-regimen-scroll[data-v-9a4b7fa9]{max-height:400px;overflow-y:auto;border:1px solid #e0e0e0;border-radius:4px;padding:.5rem}.custom-regimen-scroll[data-v-9a4b7fa9]::-webkit-scrollbar{width:8px}.custom-regimen-scroll[data-v-9a4b7fa9]::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px}.custom-regimen-scroll[data-v-9a4b7fa9]::-webkit-scrollbar-thumb{background:#888;border-radius:4px}.custom-regimen-scroll[data-v-9a4b7fa9]::-webkit-scrollbar-thumb:hover{background:#555}.regimen-grid[data-v-9a4b7fa9]{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1rem}\n/*$vite$:1*/",document.head.appendChild(t);var te=(e=>(e.ARV_REGIMENS="arv_regimens",e.INTERVAL_SELECTION="next_visit_interval",e))(te||{}),ie=(e=>(e.EXIT="exit",e.CONTINUE="continue",e))(ie||{}),ae=(e=>(e.ON_VALUE="onValue",e.ON_BUILD="onBuild",e.BEFORE_NEXT="beforeNext",e))(ae||{});const ne={"Do not prescribe LPV regimens together with 3HP":{priority:1,actions:{alert:async({regimenName:e})=>(await U("3HP - LPV/r conflict",e,"Regimens containing LPV/r <b>cannot</b> be prescribed together with 3HP",[{name:"Close",slot:"end",color:"danger"}],"his-danger-color"),"exit")},target:"arv_regimens",targetEvent:"onValue",conditions:{regimenCode:e=>[7,8,9,10,11,12].includes(e),medicationOrders:e=>e.filter(e=>!!`${e}`.match(/3hp/i)).length>=1}},"Check for any adverse effects or contraindications associated with the regimen":{priority:1,actions:{alert:async({regimenCodeStr:e,sideEffectsTable:t})=>{const{columns:i,rows:a}=t;return"Select other regimen"===await B(`Contraindications / Side effects for ${e}`,"",i,a,[{name:"Select other regimen",slot:"start"},{name:"Keep selected regimen",slot:"end",color:"danger"}],"his-danger-color")?"exit":"continue"}},target:"arv_regimens",targetEvent:"beforeNext",conditions:{hasSideEffects:e=>e,lastSideEffectDate:(e,{currentDate:t})=>e>=t}},"Recommend 2nd line regimen to children under 3":{priority:1,actions:{alert:async()=>"Select another regimen"===await z("Recommendation","",["Children under 3 years often have a high viral load and may be infected with drug-resistant HIV from previous exposure to ARVs (mother's ART and/or infant nevirapine prophylaxis)","Therefore, children under <b>3 years</b> respond better when <b>started immediately on 2nd line regimen</b> (Regimen <b>11</b>)"],[{name:"Select another regimen",slot:"start"},{name:"Keep selected regimen",slot:"end",color:"danger"}],"his-warning-color")?"exit":"continue"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{age:e=>e<3,regimenCode:e=>11!=e}},"Provide a reason for switching regimens when patient already has one":{priority:1,actions:{alert:async e=>{const t=await q(`Are you sure you want to replace ${e.currentRegimenStr}?`,"Specify reason for switching regimen",["Policy change","Ease of administration (pill burden, swallowing)","Drug drug interaction","Pregnancy intention","Side effects","Treatment failure","Weight Change","Other"],[{name:"Cancel",slot:"start",color:"danger"},{name:"Continue",slot:"end",role:"action"}]);return t.selection&&"Cancel"!=t.action?(e.reasonForSwitch=t.selection,"continue"):"exit"}},target:"arv_regimens",targetEvent:"onValue",conditions:{regimenCode:(e,{currentRegimenCode:t})=>-1!=t&&e!=t}},"Provide 14 day starter pack for LPV regimens for children under 3 years old":{priority:3,actions:{alert:async e=>"Prescribe starter pack"===await U("Starter pack needed for 14 days",`${e.treatmentInitiationState}`,`${e.regimenName}`,[{name:"Cancel",slot:"start",color:"danger"},{name:"Prescribe starter pack",slot:"end"}],"his-info-color")?(e.starterPackNeeded=!0,"continue"):"exit"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{age:e=>e<3,regimenCode:e=>11===e,treatmentInitiationState:e=>["Initiation","Re-initiation"].includes(e)}},"Provide 14 day starter pack for NVP based regimens on newly initiated/re-initiation patients":{priority:3,actions:{alert:async e=>"Prescribe starter pack"===await U("Starter pack needed for 14 days",`${e.treatmentInitiationState}`,`${e.regimenName}`,[{name:"Cancel",slot:"start",color:"danger"},{name:"Prescribe starter pack",slot:"end"}],"his-info-color")?(e.starterPackNeeded=!0,"continue"):"exit"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{regimenCode:e=>[0,2,6].includes(e),treatmentInitiationState:e=>["Initiation","Re-initiation"].includes(e)}},"Ask to reuse hanging pills if any":{priority:5,actions:{alert:async e=>{const t=await U("Hanging pills recommendation","Add hanging pills?","",[{name:"No",slot:"start",color:"warning"},{name:"Yes",slot:"end"}],"his-info-color");return e.hangingPillsStatus="Yes"===t?"Optimize - including hanging pills":"Exact - excluding hanging pills","continue"}},target:"next_visit_interval",targetEvent:"beforeNext",conditions:{drugs:(e,{hangingPills:t})=>e.map(e=>t.includes(e)).some(Boolean)}},"Provide warning of use of DTG regimen to women of reproductive age":{priority:2,actions:{alert:async({regimenName:e})=>"Select another regimen"===await U("Use of DTG or EFV in women of reproductive age",e,["There is currently <u>no confirmation</u>","that <b>DTG</b> is safe in <u>very early pregnancy</u>","DTG-based regimens are therefore not used as standard 1st line regimens for","<u>girls and women</u> who may get pregnancy"].join(" "),[{name:"Select another regimen",slot:"start"},{name:"Continue with regimen",slot:"end",color:"danger"}],"his-danger-color")?"exit":"continue"},target:"arv_regimens",targetEvent:"beforeNext",conditions:{regimenCode:e=>e>=12,isChildBearing:e=>e}},"Provide pallet options for LPV regimens for patient's whose weight is between 3 and 25 kgs":{priority:6,actions:{alert:async e=>{const t=await U("Pellets (cups) / Tabs","","Prescribe LPV/r in <b>Pellets (cups)</b> or <b>Tablets</b>?",[{name:"Granules",slot:"start"},{name:"Pellets",slot:"end"},{name:"Tabs",slot:"end"}],"his-info-color");return e.lpvType=t.toLowerCase(),"continue"}},target:"arv_regimens",targetEvent:"beforeNext",conditions:{weight:e=>e>=3&&e<=25,regimenCode:e=>11===e||9===e}},"Provide 14 day interval for NVP or LVP Regimen starter pack":{priority:1,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{prescriptionType:e=>"Regimen"===e,selectedInterval:e=>e>14,starterPackNeeded:e=>e,regimenCode:e=>[0,2,6,11].includes(e)}},"Restrict Emergency supply prescription to 1 month":{priority:1,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{selectedInterval:e=>e>28,patientType:e=>"Emergency supply"===e}},"Provide intervals upto 1 month, 2nd up to 2 months, and 3rd up to 6 months for Patients receiving TPT":{priority:2,data:{enabled:!1},target:"next_visit_interval",targetEvent:"onBuild",conditions:{prescriptionType:e=>"Regimen"===e,medicationOrders:e=>e.map(e=>!!`${e}`.match(/3hp/i)).some(Boolean),tptPrescriptionCount:(e,{selectedInterval:t})=>Math.round(t/30)>e}}},oe={"Rifapentine or isoniazid should be taken weekly":{concept:"Weekly (QW)",priority:1,conditions:{drug:e=>`${e}`.match(/Rifapentine|Isoniazid/i)}},"Use daily frequency for any other drugs":{concept:"Daily (QOD)",priority:2,conditions:{drug:e=>!`${e}`.match(/Rifapentine|Isoniazid/i)}}};function se(e,t){const i=[],a=[-1,"",null,void 0];for(const n in t){if(!(n in e))continue;const o=e[n];a.includes(o)?i.push(!1):i.push(t[n](o,e))}return i.every(Boolean)}function re(e,t,i="",a="",n="priority"){const o=[];for(const s in t){const n=t[s];[n.target&&i&&n.target!=i,n.targetEvent&&a&&n.targetEvent!=a].some(Boolean)||se(e,n.conditions)&&(n.title=s,n.description&&(n.description.text=n.description.info(e)),o.push(n))}return"priority"===n?o.sort((e,t)=>e.priority&&t.priority&&e.priority<t.priority?-1:1):function(e){return e.sort((e,t)=>e.weight&&t.weight&&e.weight>t.weight?-1:1)}(o)}const ce=i({name:"Prescription",data:()=>({toDisplayFmt:Q,toDisplayGenderFmt:K,accordionState:{allergySection:!0,medicationSection:!1,arvRegimensSection:!1,nextVisitSection:!1},consultation:y({}),prescription:y({}),chevronUp:b,chevronDown:v,reasonsForOver6Months:"",route:"",providerID:1,patientID:-1,facts:{age:-1,gender:"",weight:50,currentDate:"",isChildBearing:!1,isPregnant:!1,isBreastfeeding:!1,prescriptionType:"",patientType:"",tbStatus:"",tptStatus:{},tptPrescriptionCount:0,currentRegimenCode:-1,currentRegimenStr:"",drug:"",drugs:[],contraindications:{},hasSideEffects:!1,sideEffectsTable:{},lastSideEffectDate:"",regimenCode:-1,regimenCodeStr:"",regimenName:"",regimenDrugs:[],hangingPills:[],reasonForSwitch:"",starterPackNeeded:!1,hangingPillsStatus:"",treatmentInitiationState:"",lpvType:"",medicationOrders:[],selectedInterval:0,isEligibleForTpt:!1,customDrugs:[]},arvRegimens:[],medicationOptions:[],selectedRegimen:{},customRegimen:!1,allergyOption:"",Intervaloptions:[{label:"2 weeks",value:14},{label:"1 month",value:28},{label:"2 months",value:56},{label:"3 months",value:84},{label:"4 months",value:112},{label:"5 months",value:140},{label:"6 months",value:168},{label:"7 months",value:196},{label:"8 months",value:224},{label:"9 months",value:252},{label:"10 months",value:280},{label:"11 months",value:308},{label:"12 months",value:336}],allergyOptions:[{label:"Yes",value:"Yes"},{label:"No",value:"No"},{label:"Unknown",value:"Unknown"}],nextVisitInterval:1,selectedMedications:[],medicationRunOutDate:H.getSessionDate(),estimatedPacks:[],customIngredients:[],editableMedication:!1,customIngredientSearch:""}),components:{IonIcon:h,IonItem:g,IonLabel:p,IonSelect:u,IonSelectOption:m,IonTextarea:d,IonCheckbox:l,IonButton:c,IonAccordion:r,IonAccordionGroup:s,IonRadio:o,IonRadioGroup:n,IonNote:a},computed:{prescriptionIntervalSelection(){return"Emergency supply"===this.facts.patientType?this.Intervaloptions.filter(e=>e.value<=28):this.Intervaloptions},noDispensation(){return this.medicationOptions.some(e=>"none"===e.value&&e.isChecked)},over6monthsMedication(){return this.nextVisitInterval>168},filteredIngredients(){if(!this.customIngredientSearch)return this.customIngredients;const e=this.customIngredientSearch.toLowerCase();return this.customIngredients.filter(t=>t.name.toLowerCase().includes(e))}},methods:{isChildBearing(){return"F"===this.facts.gender&&this.facts.age>=12&&this.facts.age<=50},toggleAccordion(e){this.accordionState[e]=!this.accordionState[e]},async onEvent(e,t){const i=re(this.facts,ne,e,t);for(const o in i){var a;const e=i[o];var n;if(null!=e&&null!==(a=e.actions)&&void 0!==a&&a.alert)if(await(null==e||null===(n=e.actions)||void 0===n?void 0:n.alert(this.facts))===ie.EXIT)return!1}return!0},formatDrugs:e=>e.map(e=>e.alternative_drug_name).join(" + "),getDrugFrequency(e){this.facts.drug=e;const t=re(this.facts,oe);if(!ee.isEmpty(t))return t[0].concept},extractRegimenCode(e){try{return e.match(/n\/a/i)?-1:parseInt(e.substring(0,e.length))}catch(t){return console.warn(t),-1}},buildSideEffectsTable(e){const t=[];for(const i in e){const a=this.facts.contraindications[i]||[];t.push([Q(i),a.join(", "),e[i].join(", ")])}return{columns:["Date","Contraindication(s)","Side effect(s)"],rows:t}},async toggleRegimen(e){if(this.selectedRegimen.name!==e.name){this.facts.lpvType="",this.facts.hangingPillsStatus="",this.facts.starterPackNeeded=!1,this.facts.regimenName=`${e.name} (${this.formatDrugs(e.drugs)})`,this.facts.regimenCodeStr=e.name,this.facts.regimenCode=this.extractRegimenCode(e.name),this.facts.regimenDrugs=e.drugs,this.facts.drugs=e.drugs.map(e=>e.drug_id);const t=this.prescription.findAndGroupDrugSideEffects(this.facts.drugs);if(this.facts.hasSideEffects=!ee.isEmpty(t),this.facts.sideEffectsTable=this.buildSideEffectsTable(t),!this.onEvent(te.ARV_REGIMENS,ae.ON_VALUE))return;this.selectedRegimen=e,this.selectedMedications=e.drugs,this.updateEstimatedPacks()}else this.selectedRegimen={},this.selectedMedications=[]},disableOption:(e,t=!0)=>({disabled:t,description:{color:"danger",show:"always",text:e}}),validateTPTOption(e){return this.facts.tptStatus.completed?this.disableOption("Completed TPT treatment"):this.facts.tptStatus.tb_treatment?this.disableOption("Completed/on TB treatment"):this.facts.isPregnant?this.disableOption("Pregnant patient"):this.facts.tptStatus.eligible["3HP"]||this.facts.tptStatus.eligible["6H"]?null!==this.facts.tptStatus.tpt&&this.facts.tptStatus.tpt!==e?this.disableOption(`On ${this.facts.tptStatus.tpt} treatment`):(this.facts.isEligibleForTpt=e.includes("3HP")?this.facts.tptStatus.eligible["3HP"]:this.facts.tptStatus.eligible["6H"],this.facts.isBreastfeeding?this.disableOption("Breastfeeding patient",!1):this.facts.isEligibleForTpt&&this.facts.tptStatus.tpt===e&&!this.facts.tptStatus.completed?{isChecked:!0}:{}):this.disableOption("Not eligible to start or re-start TPT")},buildTPTOption(e,t,i=0){const a={label:e,value:t,isChecked:!1,disabled:!1};if(i>0&&this.facts.weight<i)return{...a,...this.disableOption("Weight below regulation")};const n=this.validateTPTOption(e);return{...a,...n}},buildMedicationOptions(){this.medicationOptions=[{label:"ARVs",value:"arvs",isChecked:!1},{label:"CPT",value:"cpt",isChecked:!1,..."Yes"===this.allergyOption?this.disableOption("Allergic to sulphur"):{}},this.buildTPTOption("3HP (RFP + INH)","3hp",20),this.buildTPTOption("INH 300 / RFP 300 (3HP)","inh300",30),this.buildTPTOption("IPT","ipt",30),{label:"None",value:"none",isChecked:!1}]},async allergyChange(e){this.allergyOption=e.detail.value},nextVisitIntervalChange(e){const t=new Date;this.nextVisitInterval=e.detail.value,this.medicationRunOutDate=Y(t,this.nextVisitInterval,"days"),this.updateEstimatedPacks()},async onSubmit(){try{const e=[await this.createbuildValueCoded("Allergic to sulphur",this.allergyOption.toString())];this.noDispensation?e.push(await this.consultation.buildValueCoded("Prescribe drugs","No")):(e.push(await this.consultation.buildValueCoded("Prescribe drugs","Yes")),this.medicationOptions.forEach(async t=>{t.isChecked&&e.push(await this.consultation.buildValueCoded("Medication orders",t.label))})),await this.consultation.saveObservationList(e),await this.prescription.createEncounter(),this.prescription.setNextVisitInterval(this.nextVisitInterval);const t=this.selectedMedications.map(e=>this.prescription.toOrderObj(e.drug_id,e.alternative_drug_name||e.drug_name,e.units,e.am,e.pm,e.frequency||this.getDrugFrequency(e.drug_name)));if(await this.prescription.createDrugOrder(t),this.over6monthsMedication){const e=await this.consultation.buildValueCoded("Why prescribe medication for more than 6 months?",this.reasonsForOver6Months);await this.prescription.saveObservationList([e])}return!0}catch(e){return console.error("Error saving prescription:",e),G("Failed to save prescription"),!1}},async createbuildValueCoded(e,t){return await this.consultation.buildValueCoded(e,t)},async handleMedicationSelection(e,t,i){const a=e.detail.checked;if("none"===i.value)return a&&(this.medicationOptions=this.medicationOptions.map((e,i)=>({...e,isChecked:i===t}))),void(await this.updateSelectedMedications());"arvs"===i.value&&(a?(this.accordionState.arvRegimensSection=!0,this.accordionState.nextVisitSection=!0):(this.accordionState.arvRegimensSection=!1,this.accordionState.nextVisitSection=!1));const n=e=>!!e.label.match(/IPT|3HP|INH/i),o=this.medicationOptions.filter(n);if(n(i)){const e=e=>"3HP (RFP + INH)"===e.label||"INH 300 / RFP 300 (3HP)"===e.label,t=o.some(e=>"IPT"===e.label&&e.isChecked);if(e(i)&&t&&a){const t=await this.showTPTConflictDialog();return"Prescribe IPT"===t?this.medicationOptions=this.medicationOptions.map(t=>({...t,isChecked:!e(t)&&t.isChecked})):"Prescribe 3HP"===t&&(this.medicationOptions=this.medicationOptions.map(t=>({...t,isChecked:"IPT"!==t.label&&(e(t)?t.label===i.label:t.isChecked)}))),void(await this.updateSelectedMedications())}if(e(i)&&a&&(this.medicationOptions=this.medicationOptions.map(t=>({...t,isChecked:e(t)?t.label===i.label:t.isChecked}))),"IPT"===i.label&&a&&o.some(t=>e(t)&&t.isChecked)){const t=await this.showTPTConflictDialog();return"Prescribe IPT"===t?this.medicationOptions=this.medicationOptions.map(t=>({...t,isChecked:!e(t)&&t.isChecked})):"Prescribe 3HP"===t&&(this.medicationOptions=this.medicationOptions.map(e=>({...e,isChecked:"IPT"!==e.label&&e.isChecked}))),void(await this.updateSelectedMedications())}}a&&"none"!==i.value&&(this.medicationOptions=this.medicationOptions.map(e=>({...e,isChecked:"none"!==e.value&&e.isChecked}))),this.medicationOptions[t].isChecked=a,await this.updateSelectedMedications()},isCustomMedicationSelected(e){return this.selectedMedications.some(t=>t.drug_name===e.name)},toggleCustomMedication(e){const t=this.selectedMedications.findIndex(t=>t.drug_name===e.name);if(t>=0)this.selectedMedications.splice(t,1);else{const t={drug_id:e.drug_id,concept_id:e.concept_id,drug_name:e.name,concept_name:e.name,alternative_drug_name:e.name,units:e.units,am:0,noon:0,pm:0,frequency:"Daily (QOD)",pack_size:30,barcodes:[],regimen_category:"Custom"};this.selectedMedications.push(t)}this.updateEstimatedPacks()},addCustomMedication(e){const t={drug_id:e.drug_id,concept_id:e.concept_id,drug_name:e.name,concept_name:e.name,alternative_drug_name:e.name,units:e.units,am:0,noon:0,pm:0,frequency:"Daily (QOD)",pack_size:30,barcodes:[],regimen_category:"Custom"};this.selectedMedications.some(t=>t.drug_name===e.name)||(this.selectedMedications.push(t),this.updateEstimatedPacks())},async updateSelectedMedications(){this.selectedMedications=[];const e=async(e,t,i)=>{if(this.medicationOptions.find(t=>t.value===e&&t.isChecked)){const e=await A.getRegimenExtras(t,this.facts.weight),a=J(i?e.filter(i):e,"concept_name");this.selectedMedications.push(...a)}};this.medicationOptions.find(e=>"arvs"===e.value&&e.isChecked)&&this.selectedRegimen.drugs&&this.selectedMedications.push(...this.selectedRegimen.drugs),await e("cpt","Cotrimoxazole",e=>"Daily (QOD)"===e.frequency),await e("3hp","INH / RFP"),await e("inh300","INH / RFP"),await e("ipt","INH",e=>"Daily (QOD)"===e.frequency),this.updateEstimatedPacks()},updateEstimatedPacks(){this.prescription.setNextVisitInterval(this.nextVisitInterval),this.estimatedPacks=this.selectedMedications.map(e=>{const t=this.prescription.getDrugPackSize(e),i=this.prescription.calculatePillsPerDay(e.am,e.noon,e.pm),a=this.prescription.estimatePackSize(i,t);return{name:e.drug_name,quantity:a}})},async initFacts(){const e=await W.getProgramInformation(this.patientID);this.facts.hangingPills=this.prescription.getHangingPills(),this.facts.treatmentInitiationState=this.prescription.getTreatmentState(),this.facts.currentRegimenStr=e.current_regimen,this.facts.currentRegimenCode=this.extractRegimenCode(e.current_regimen),this.facts.medicationOrders=this.prescription.getMedicationOrders(),this.facts.contraindications=this.prescription.getContraindications(),this.facts.tptPrescriptionCount=this.prescription.getTptPrescriptionCount(),this.facts.lastSideEffectDate=this.prescription.getLastSideEffectDate(),this.facts.currentDate=H.getSessionDate(),this.facts.isChildBearing=this.isChildBearing(),this.facts.tptStatus=await this.consultation.getTptTreatmentStatus(),this.facts.customDrugs=await this.prescription.getCustomIngridients();const t=new Z(this.patientID,this.providerID);await t.loadPatientType(),this.facts.patientType=t.patientType},showTPTConflictDialog:async()=>await U("TPT Conflict","You cannot prescribe IPT and 3HP together","Please choose one option",[{name:"Prescribe 3HP",slot:"start",color:"primary"},{name:"Prescribe IPT",slot:"end",color:"primary"}]),async fetchCustomIngredients(){try{const e=new Set;this.customIngredients=this.facts.customDrugs.filter(t=>!e.has(t.name)&&(e.add(t.name),!0))}catch(e){console.error("Error fetching custom ingredients:",e),G("Failed to load custom ingredients")}}},watch:{nextVisitInterval:{handler(){this.updateEstimatedPacks()}},allergyOption:{handler(){this.buildMedicationOptions()}},medicationOptions:{handler(){this.updateSelectedMedications()},deep:!0},customRegimen:{async handler(e){e?(await this.fetchCustomIngredients(),this.selectedRegimen={},this.selectedMedications=[],this.editableMedication=!0,this.estimatedPacks=[]):(this.editableMedication=!1,this.selectedMedications=[],this.estimatedPacks=[])}}},async mounted(){var e,t;const i=L();this.providerID=Number(f(i.$state).user_ID)||1;const a=j(),n=f(a.$state).patient;if(this.patientID=(null==n?void 0:n.patientID)||25,this.facts.gender=(null==n?void 0:n.personInformation.gender)||"",this.facts.age=$(null==n?void 0:n.personInformation.birthdate),null==n||null===(e=n.vitals)||void 0===e||null===(e=e.saved)||void 0===e?void 0:e[0]){const e=n.vitals.saved.find(e=>"Weight (kg)"===e.concept_name);e&&(this.facts.weight=e.value_numeric)}const o=null==n||null===(t=n.activePrograms)||void 0===t?void 0:t.find(e=>"HIV PROGRAM"===e.program.name);o&&(this.facts.currentRegimenStr=o.program.name,this.facts.currentRegimenCode=this.extractRegimenCode(o.program.name)),this.consultation=new F(this.patientID,this.providerID),this.prescription=new H(this.patientID,this.providerID);const s=await A.getRegimens(this.patientID);Object.entries(s).forEach(([e,t])=>{this.arvRegimens.push({name:e,drugs:t})}),await this.prescription.loadHangingPills(),await this.prescription.loadRegimenExtras(),await this.initFacts(),this.buildMedicationOptions()}}),le={class:"prescription-container h-full"},de={class:"accordion-section"},me={class:"expand-btn"},ue={class:"accordion-content"},pe={class:"allergy-section"},ge={class:"accordion-section"},he={class:"expand-btn"},fe={class:"accordion-content"},ve={class:"medication-options"},be={class:"option-grid"},ye={class:"checkbox-text"},xe={class:"accordion-section"},we={class:"expand-btn"},ke={class:"accordion-content"},Ie={class:"patient-info"},Se={class:"info-item"},Ce={class:"info-value"},Pe={class:"info-item"},_e={class:"info-value"},Oe={class:"info-item"},Re={class:"info-value"},Ve={class:"info-item"},Te={class:"info-value"},De={class:"info-item"},Ee={class:"info-value"},Me={key:0},Ne={class:"regimen-grid"},Fe=["onClick"],He={class:"regimen-id"},Ae={class:"regimen-name"},Ue=["onClick"],qe={class:"regimen-id"},ze={class:"regimen-name"},Be={key:1,class:"custom-regimen-scroll",style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"0.5rem"}},Le=["onClick"],je={class:"regimen-name"},$e={class:"regimen-units"},Ge={class:"custom-regimen"},We={class:"selected-medication-section"},Ye={class:"medication-table"},Qe={class:"row-cell drug-name"},Ke={class:"row-cell units"},Xe={class:"row-cell am"},Je={class:"row-cell noon"},Ze={class:"row-cell pm"},et={class:"row-cell frequency"},tt={class:"row-cell am"},it={class:"row-cell noon"},at={class:"row-cell pm"},nt={class:"row-cell frequency"},ot={class:"accordion-section"},st={class:"expand-btn"},rt={class:"accordion-content"},ct={class:"next-visit-interval"},lt={class:"medication-run-out"},dt={class:"estimated-packs"},mt={class:"pack-name"},ut={class:"pack-quantity"},pt={key:0,class:"over-6-months-medication"};e("default",X(ce,[["render",function(e,t,i,a,n,o){const s=x("ion-icon"),r=x("ion-radio"),c=x("ion-radio-group"),l=x("ion-checkbox"),d=x("ion-note"),m=x("ion-input"),u=x("ion-select-option"),p=x("ion-select"),g=x("ion-item"),h=x("ion-label"),f=x("ion-textarea");return k(),w("div",le,[I("div",de,[I("div",{class:"accordion-header",onClick:t[0]||(t[0]=t=>e.toggleAccordion("allergySection"))},[t[10]||(t[10]=I("h3",null,"Allergy Information",-1)),I("button",me,[C(s,{icon:e.accordionState.allergySection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),S(I("div",ue,[I("div",pe,[t[11]||(t[11]=I("div",{class:"allergy-label"},"Allergic to cotrimoxazole",-1)),C(c,{modelValue:e.allergyOption,"onUpdate:modelValue":t[1]||(t[1]=t=>e.allergyOption=t),onIonChange:e.allergyChange,class:"horizontal-options"},{default:_(()=>[(k(!0),w(O,null,R(e.allergyOptions,e=>(k(),w("div",{key:e.value,class:"horizontal-item"},[C(r,{value:e.value},{default:_(()=>[V(T(e.label),1)]),_:2},1032,["value"])]))),128))]),_:1},8,["modelValue","onIonChange"])])],512),[[P,e.accordionState.allergySection]])]),I("div",ge,[I("div",{class:"accordion-header",onClick:t[2]||(t[2]=t=>e.toggleAccordion("medicationSection"))},[t[12]||(t[12]=I("h3",null,"Medication to prescribe during this visit",-1)),I("button",he,[C(s,{icon:e.accordionState.medicationSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),S(I("div",fe,[I("div",ve,[I("div",be,[(k(!0),w(O,null,R(e.medicationOptions,(i,a)=>{var n,o;return k(),w("div",{key:i.value,class:"option-item"},[C(l,{checked:i.isChecked,disabled:i.disabled,"label-placement":"end",onIonChange:t=>e.handleMedicationSelection(t,a,i)},{default:_(()=>[I("span",ye,T(i.label),1)]),_:2},1032,["checked","disabled","onIonChange"]),t[13]||(t[13]=I("br",null,null,-1)),"always"===(null===(n=i.description)||void 0===n?void 0:n.show)?(k(),D(d,{key:0,color:null===(o=i.description)||void 0===o?void 0:o.color},{default:_(()=>{var e;return[V(T(null===(e=i.description)||void 0===e?void 0:e.text),1)]}),_:2},1032,["color"])):E("",!0)])}),128))])])],512),[[P,e.accordionState.medicationSection]])]),I("div",xe,[I("div",{class:"accordion-header",onClick:t[3]||(t[3]=t=>e.toggleAccordion("arvRegimensSection"))},[t[14]||(t[14]=I("h3",null,"ARV Regimens",-1)),I("button",we,[C(s,{icon:e.accordionState.arvRegimensSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),S(I("div",ke,[I("div",Ie,[I("div",Se,[t[15]||(t[15]=I("span",{class:"info-label"},"Age:",-1)),I("span",Ce,T(e.facts.age)+" Years",1)]),I("div",Pe,[t[16]||(t[16]=I("span",{class:"info-label"},"Gender:",-1)),I("span",_e,T(e.toDisplayGenderFmt(e.facts.gender)),1)]),I("div",Oe,[t[17]||(t[17]=I("span",{class:"info-label"},"Current Regimen:",-1)),I("span",Re,T(e.facts.currentRegimenStr),1)]),I("div",Ve,[t[18]||(t[18]=I("span",{class:"info-label"},"Current Weight:",-1)),I("span",Te,T(e.facts.weight),1)]),I("div",De,[t[19]||(t[19]=I("span",{class:"info-label"},"Reason for change:",-1)),I("span",Ee,T(e.facts.reasonForSwitch),1)])]),e.customRegimen?(k(),w("div",Me,[C(m,{modelValue:e.customIngredientSearch,"onUpdate:modelValue":t[4]||(t[4]=t=>e.customIngredientSearch=t),onInput:t[5]||(t[5]=t=>{var i;return e.customIngredientSearch=null===(i=t.target)||void 0===i?void 0:i.value}),placeholder:" Search medications...",class:"custom-search","clear-input":""},null,8,["modelValue"])])):E("",!0),I("div",Ne,[e.customRegimen?(k(),w("div",Be,[(k(!0),w(O,null,R(e.filteredIngredients,t=>(k(),w("div",{key:t.name,class:M(["regimen-item",{selected:e.isCustomMedicationSelected(t)}]),onClick:i=>e.toggleCustomMedication(t)},[I("span",je,T(t.name),1),I("span",$e,"("+T(t.units)+")",1)],10,Le))),128))])):(k(),w(O,{key:0},[(k(!0),w(O,null,R(e.arvRegimens.slice(0,5),t=>(k(),w("div",{key:t.name,class:M(["regimen-item",{selected:e.selectedRegimen.name===t.name}]),onClick:i=>e.toggleRegimen(t)},[I("span",He,T(t.name),1),I("span",Ae,T(e.formatDrugs(t.drugs)),1)],10,Fe))),128)),(k(!0),w(O,null,R(e.arvRegimens.slice(5),t=>(k(),w("div",{key:t.name,class:M(["regimen-item",{selected:e.selectedRegimen.name===t.name}]),onClick:i=>e.toggleRegimen(t)},[I("span",qe,T(t.name),1),I("span",ze,T(e.formatDrugs(t.drugs)),1)],10,Ue))),128))],64))]),I("div",Ge,[t[20]||(t[20]=I("span",null,"Set custom regimen",-1)),C(l,{modelValue:e.customRegimen,"onUpdate:modelValue":t[6]||(t[6]=t=>e.customRegimen=t)},null,8,["modelValue"])]),I("div",We,[t[24]||(t[24]=I("h3",null,"Selected medication",-1)),I("div",Ye,[t[23]||(t[23]=N('<div class="table-header" data-v-9a4b7fa9><div class="header-cell drug-name" data-v-9a4b7fa9>Drug name</div><div class="header-cell units" data-v-9a4b7fa9>Units</div><div class="header-cell am" data-v-9a4b7fa9>AM</div><div class="header-cell noon" data-v-9a4b7fa9>Noon</div><div class="header-cell pm" data-v-9a4b7fa9>PM</div><div class="header-cell frequency" data-v-9a4b7fa9>Frequency</div></div>',1)),(k(!0),w(O,null,R(e.selectedMedications,(i,a)=>(k(),w("div",{key:a,class:M(["table-row",{highlighted:0===a}])},[I("div",Qe,T(i.drug_name),1),I("div",Ke,T(i.units),1),e.editableMedication?(k(),w(O,{key:0},[I("div",Xe,[C(m,{onIonInput:e=>i.am=parseFloat(e.target.value),type:"number",modelValue:i.am,"onUpdate:modelValue":e=>i.am=e,min:"0",class:"editable-input",style:{"background-color":"#f0f9ff",border:"1px solid #90caf9","border-radius":"4px"}},null,8,["onIonInput","modelValue","onUpdate:modelValue"])]),I("div",Je,[C(m,{onIonInput:e=>i.noon=parseFloat(e.target.value),type:"number",modelValue:i.noon,"onUpdate:modelValue":e=>i.noon=e,min:"0",class:"editable-input",style:{"background-color":"#f0f9ff",border:"1px solid #90caf9","border-radius":"4px"}},null,8,["onIonInput","modelValue","onUpdate:modelValue"])]),I("div",Ze,[C(m,{onIonInput:e=>i.pm=parseFloat(e.target.value),type:"number",modelValue:i.pm,"onUpdate:modelValue":e=>i.pm=e,min:"0",class:"editable-input",style:{"background-color":"#f0f9ff",border:"1px solid #90caf9","border-radius":"4px"}},null,8,["onIonInput","modelValue","onUpdate:modelValue"])]),I("div",et,[C(p,{modelValue:i.frequency,"onUpdate:modelValue":e=>i.frequency=e,onIonChange:t=>{i.frequency=t.detail.value,e.updateEstimatedPacks()}},{default:_(()=>[C(u,{value:"Daily (QOD)"},{default:_(()=>t[21]||(t[21]=[V("Daily")])),_:1,__:[21]}),C(u,{value:"Weekly"},{default:_(()=>t[22]||(t[22]=[V("Weekly")])),_:1,__:[22]})]),_:2},1032,["modelValue","onUpdate:modelValue","onIonChange"])])],64)):(k(),w(O,{key:1},[I("div",tt,T(i.am),1),I("div",it,T(i.noon),1),I("div",at,T(i.pm),1),I("div",nt,T(i.frequency),1)],64))],2))),128))])])],512),[[P,e.accordionState.arvRegimensSection]])]),I("div",ot,[I("div",{class:"accordion-header",onClick:t[7]||(t[7]=t=>e.toggleAccordion("nextVisitSection"))},[t[25]||(t[25]=I("h3",null,"Next Visit Information",-1)),I("button",st,[C(s,{icon:e.accordionState.nextVisitSection?e.chevronUp:e.chevronDown},null,8,["icon"])])]),S(I("div",rt,[I("div",ct,[C(g,null,{default:_(()=>[C(p,{modelValue:e.nextVisitInterval,"onUpdate:modelValue":t[8]||(t[8]=t=>e.nextVisitInterval=t),interface:"popover",onIonChange:e.nextVisitIntervalChange,placeholder:"Select interval",label:"Interval to next visit","label-placement":"stacked"},{default:_(()=>[(k(!0),w(O,null,R(e.prescriptionIntervalSelection,e=>(k(),D(u,{key:e.value,value:e.value},{default:_(()=>[V(T(e.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","onIonChange"])]),_:1})]),I("div",lt,[t[26]||(t[26]=I("label",null,"Medication run out date:",-1)),I("span",null,T(e.toDisplayFmt(e.medicationRunOutDate)),1)]),I("div",dt,[t[27]||(t[27]=I("h4",null,"Estimated packs/tins:",-1)),(k(!0),w(O,null,R(e.estimatedPacks,(e,t)=>(k(),w("div",{key:t,class:"pack-item"},[I("span",mt,T(e.name),1),I("div",ut,T(e.quantity),1)]))),128))]),e.over6monthsMedication?(k(),w("div",pt,[C(g,null,{default:_(()=>[C(h,{position:"stacked"},{default:_(()=>t[28]||(t[28]=[V("Specify reason for prescribing medication over 6 months "),I("span",{class:"required"},"*",-1)])),_:1,__:[28]}),C(f,{modelValue:e.reasonsForOver6Months,"onUpdate:modelValue":t[9]||(t[9]=t=>e.reasonsForOver6Months=t),placeholder:"Enter reason for over 6 months medication"},null,8,["modelValue"])]),_:1})])):E("",!0)],512),[[P,e.accordionState.nextVisitSection]])])])}],["__scopeId","data-v-9a4b7fa9"]]))}}});
