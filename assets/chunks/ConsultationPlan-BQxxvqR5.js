import{d as ze,an as Ge,cG as Ue,r as n,c as Q,aU as d,a as $e,w as c,O as ee,f as W,J as E,l,e as qe,m as te,k as v,u as P,bw as Je,dx as Ye,a3 as Xe,i as y,bL as ae,v as w,a6 as Ze,eH as je,b8 as S}from"./vendor-BpjEhVym.js";import{u as Ke,_ as Qe,s as et,e as tt,b as at}from"./nonPharmaTherapyStore-BjD9knsY.js";import{u as st,aH as nt,bV as it,aJ as ot,d as lt,aL as rt,a0 as ct,aW as ut,bF as mt,bq as pt,aS as vt,T as dt,J as se,G as A,s as g,af as ft,aX as gt,H,aM as b,aO as ne,bZ as ht,S as Dt,t as V,bI as ie,q as z,n as Pt,_ as yt}from"../index-ChQXOk24.js";import{D as wt}from"./DemographicBar-BqR-cju-.js";import{C as St,b as bt,O as Ot}from"./OPDOutcome-CDPdU5RA.js";import{I as At,N as Tt}from"./NextAppointment-DZRmFjqq.js";import{O as Ct}from"./OPDDiagnosis-C7KzFObT.js";import{O as _t}from"./OPDPrintingModal-BOD7zQAz.js";import{l as It}from"./lodash-NJiRuGo9.js";import{u as kt}from"./usePatientProfile-CCxSUNCs.js";import{u as xt}from"./useUserActivities-CODNHXFl.js";import"./drug_prescription_service-DLfm-sfa.js";import"./patient_diagnosis_service-C0Sb0fFm.js";import"./apexcharts-DMAoEdNS.js";import"./LevelOfConsciousness.vue_vue_type_script_setup_true_lang-BiIK0VRZ.js";import"./previousComplaints-lighosZS.js";import"./patient_complaints_service-DJ2yAU3X.js";import"./DashBox-xefU7wMF.js";import"./BasicForm-DrDShyHD.js";import"./DateInputField-CnNEiyX1.js";import"./formatServerData-Vq32vQeK.js";import"./LabOrdersList-DOJd-0IS.js";import"./group_validation-C_hKPGnq.js";import"./RadiologyStore-CUsjVSWV.js";import"./ncd_appointment_service-DE88wNn3.js";import"./Registration-Bmf8SHmJ.js";import"./useLocation-aT96pFPv.js";import"./vaccines_service-WlVIQx6u.js";import"./sms_service-BkfHhA9X.js";import"./EIRreportsStore-C3K2RALB.js";import"./Export--Z2SJlLh.js";import"./useNeonatalEnrollmentStore-3kwioDpG.js";import"./enrollment-DU-PLRUa.js";const Nt={key:0,class:"spinner-overlay"},Bt={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Lt={class:"back_profile"},Rt=ze({__name:"ConsultationPlan",setup(Ft){const{currentTabIndex:m}=Ke(),{printVisitSummary:oe}=kt(),{hasWaitingList:le}=xt(),f=Ge(),re=Ue(),T=n(!1),C=n(!0),G=n(!1),_=n(!1),I=n(!0),ce=n(!1),k=n(!1),ue=n(!1),U=st(),me=nt(),pe=it(),x=ot(),ve=lt(),$=rt(),de=ct(),fe=ut(),ge=mt(),he=pt(),De=vt(),N=n(!1),h=n(!1),q=Q(()=>({text:h.value?"Saving...":"Finish",icon:h.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:N.value||h.value})),{patient:u}=d(U),{investigations:Pe}=d(me),{OPDdiagnosis:ye}=d(pe),{selectedMedicalDrugsList:J}=d(x),{OPDActivities:O}=d(ve),{outcomes:we}=d($),{currentSelectedNextAppointmentDate:Se}=d(ge),{presentingComplaints:be}=d(he),{vitals:Oe}=d(fe),Y=Q(()=>De.selectedMedicalAllergiesList),X=n(null),B=n(null),Z=n(null),Ae=n(null),Te=n(null),Ce=n(null),L=n(null),a=n(),j=()=>O.value.map(e=>({title:e,icon:""})),_e=async(e,t,s)=>{var r;if(t===0&&await Be(),!await K())return;await p(),e%1===0&&(m.value=e),L.value&&s&&L.value.changeTab(e),((r=a.value[e])==null?void 0:r.title)==="Investigations"&&B.value&&await B.value.openAHDModal()},D=()=>{var s;if(!a.value||a.value.length===0)return null;const e=m.value>=0&&m.value<a.value.length?m.value:0;switch((s=a.value[e])==null?void 0:s.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(O.value.length>0)switch(O.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Ie=()=>{f.push("home")},ke=()=>{f.push("patientProfile")},xe=async()=>{_.value=!0,A("Printing consultation summary... Please wait.");try{await oe(),A("Consultation summary printed successfully!"),setTimeout(()=>{f.push("home")},3500)}catch(e){g("Failed to print consultation summary.")}finally{_.value=!1}},Ne=()=>{A("Patient has finished consultation!"),f.push("home")},K=async()=>{const e=await ft.getObsByEncounterIdAndDate(gt.PRESENTING_COMPLAINTS);return!!(e&&e.length>0)},p=async()=>{var t,s;const e=H.sessionDate();for(let o=0;o<a.value.length;o++)if(!await K())C.value=!1,a.value[o].title!=="Clinical Assessment"&&(a.value[o].icon=je);else{C.value=!0,G.value=!1;const r=a.value[o];if(r.title==="Clinical Assessment"){const i=b("presentingComplaints");a.value[o].icon=R(e,i)?S:""}else if(r.title==="Investigations"){const i=(s=(t=u.value)==null?void 0:t.labOrders)==null?void 0:s.saved,M=i==null?void 0:i.filter(Ve=>H.toStandardHisFormat(e)===H.toStandardHisFormat(Ve.order_date));a.value[o].icon=(M==null?void 0:M.length)>0?S:""}else if(r.title==="Diagnosis"){const i=b("diagnosis");a.value[o].icon=R(e,i)?S:""}else if(r.title==="Treatment Plan"){const i=b("treatment");a.value[o].icon=(i==null?void 0:i.length)>0?S:""}else if(r.title==="Next Appointment"){const i=b("appointments");a.value[o].icon=R(e,i)?S:""}else if(r.title==="Outcome"){const i=b("outcomes");a.value[o].icon=(i==null?void 0:i.length)>0?S:""}}F()},R=(e,t)=>{if(!t)return!1;const s=new Date(e);return s.setHours(0,0,0,0),t.some(o=>{const r=new Date(o.obs_datetime||o.order_date);return r.setHours(0,0,0,0),r.getTime()===s.getTime()})},Be=async()=>{var e;T.value=!0;try{await Le(),await((e=X.value)==null?void 0:e.onSubmit()),await ne(u.value),ht()}catch(t){throw g("Failed to save clinical assessment"),t}finally{T.value=!1}},Le=async()=>{try{if(It.isEmpty(Y.value))return;const e=Y.value.map(s=>({concept_id:s.concept_id,obs_datetime:Dt.getSessionDate(),value_coded:s.concept_id,location_id:de.facilityLocation.code,value_text:s.name})),t=await et(e);U.setPatientRecord(t)}catch(e){V("Failed to save allergies")}},Re=async()=>{try{const e=await tt();u.value={...u.value,...e};const t=await at().saveNonPharmaTherapyPatientData();u.value={...u.value,...t}}catch(e){V("Failed to save treatment plan")}},Fe=()=>{const e=J.value;return console.log("Checking prescribed medications:",{medicationsCount:e.length,medications:e}),e.length>0},Me=async()=>{var e;try{h.value=!0,await((e=Z.value)==null?void 0:e.onSubmit()),await Re(),await $.saveOutcomPatientData(),await ne(u.value);const t=localStorage.getItem("locationID");if(!t){g("Location ID missing.");return}Fe()?le("Waiting for Dispensation")?await We(t):await Ee(t):await He(t)}catch(t){g("Failed to save consultation.")}finally{h.value=!1}},We=async e=>{try{await ie.addPatientToStage(u.value,"DISPENSATION"),await z().refresh(e),x.clearSelectedMedicalDrugsList(),A("Patient moved to Dispensation."),f.push("home")}catch(t){throw g("Failed to move patient to dispensation"),t}},Ee=async e=>{try{await ie.addPatientToStage(u.value,"DISPENSATION"),await z().refresh(e),x.clearSelectedMedicalDrugsList(),V("Patient moved to dispensation queue. You lack access to dispense."),f.push("home")}catch(t){throw g("Failed to move patient to dispensation"),t}},He=async e=>{try{await Pt(u.value),await z().refresh(e),f.push("home")}catch(t){console.error("Failed to close visit:",t),g("Failed to close visit.")}};$e(async()=>{if(O.value.length===0){await f.push("home");return}a.value=j(),await p(),(m.value===void 0||m.value<0)&&(m.value=0),N.value=!1,F()}),c(m,async()=>{await F()}),c(Oe,async()=>{await p()},{deep:!0}),c(u,async()=>{await p()},{deep:!0}),c(Pe,async()=>{await p()},{deep:!0}),c(ye,async()=>{await p()},{deep:!0}),c(J,async()=>{await p()},{deep:!0}),c(we,async()=>{await p()},{deep:!0}),c(Se,async()=>{await p()}),c(be,async()=>{await p()},{deep:!0}),c(re,async()=>{I.value=!1,a.value=j(),setTimeout(()=>{m.value=0,I.value=!0},0)},{deep:!0}),c(ue,e=>{k.value=e,k.value&&setTimeout(()=>{k.value=!1},15e3)}),c(q,(e,t)=>{console.log("Done button options changed:",{from:t,to:e,currentStep:m.value,tabsLength:a.value.length})},{deep:!0});const F=()=>{let e=!1;return h.value&&(e=!0),N.value=e,!e};return(e,t)=>(W(),ee(P(Ze),null,{default:E(()=>[l(_t,{onYes:xe,onNo:Ne,isOpen:ce.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),T.value?(W(),qe("div",Nt,[l(P(Je),{name:"bubbles"}),t[3]||(t[3]=v("div",{class:"loading-text"},"Please wait...",-1))])):te("",!0),l(P(Ye),{"is-open":_.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(dt),l(P(Xe),{fullscreen:!0},{default:E(()=>[l(wt),v("div",Bt,[I.value?(W(),ee(Qe,{key:0,ref_key:"wizard",ref:L,headingTitle:"Consultation Plan","vertical-tabs":"","navigable-tabs":C.value,"scrollable-tabs":"",startIndex:0,doneButton:q.value,nextButton:{disabled:G.value},"custom-tabs":a.value,tabs:a.value,onChange:_e,"onComplete:wizard":t[2]||(t[2]=s=>Me())},{default:E(()=>[v("div",null,[v("div",Lt,[l(se,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:P(ae),"font-weight":"600",onClick:t[0]||(t[0]=s=>Ie())},null,8,["icon"]),l(se,{name:"Back to Profile",iconSlot:"start",fill:"clear",icon:P(ae),"font-weight":"600",onClick:t[1]||(t[1]=s=>ke()),style:{"margin-left":"15px"}},null,8,["icon"])])]),y(v("div",null,[l(St,{ref_key:"clinicalAssessmentRef",ref:X},null,512)],512),[[w,D()==="ClinicalAssessment"]]),y(v("div",null,[l(At,{ref_key:"investigationsRef",ref:B},null,512)],512),[[w,D()==="Investigations"]]),y(v("div",null,[l(Ct,{ref_key:"diagnosisRef",ref:Z},null,512)],512),[[w,D()==="OPDDiagnosis"]]),y(v("div",null,[l(bt,{ref_key:"treatmentPlanRef",ref:Ae},null,512)],512),[[w,D()==="OPDTreatmentPlan"]]),y(v("div",null,[l(Tt,{ref_key:"nextAppointmentRef",ref:Te},null,512)],512),[[w,D()==="NextAppointment"]]),y(v("div",null,[l(Ot,{ref_key:"outcomeRef",ref:Ce},null,512)],512),[[w,D()==="Outcome"]])]),_:1},8,["navigable-tabs","doneButton","nextButton","custom-tabs","tabs"])):te("",!0)])]),_:1})]),_:1}))}}),ga=yt(Rt,[["__scopeId","data-v-3ea702e6"]]);export{ga as default};
