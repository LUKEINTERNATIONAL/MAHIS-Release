import{d as K,bh as X,cr as Y,r as f,c as _,w as S,G as z,e as v,f as r,l as h,H as p,k as l,F as B,T as F,Q as g,m as H,a3 as Z,I as E,p as G,u as ee,bl as te}from"./vendor-CJ2tyHrn.js";import{u as ae,b as ne,F as x,H as se,cJ as oe,G as L,J as le,x as re,aq as R,_ as ie}from"../index-CPIhguZJ.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-BtvCa6MI.js";const ue={class:"visitContent"},ce={class:"visitData"},de={class:"table-header"},ve={class:"encounter-title"},me={class:"table-responsive"},fe={key:0,class:"loading-state"},pe={key:1,class:"empty-state"},_e=K({__name:"VisitsHistory",setup(he){const I=ae(),{patient:i}=X(I),A=Y(),y=f([]),d=f(""),n=f(null),u=f([]),w=f(!1),T=e=>{const t={...e};return e.child&&!e.children?t.children=e.child:e.children||(t.children=[]),t.children&&t.children.length>0&&(t.children=t.children.map(a=>T(a))),t},b=_(()=>{const e=new Set;return y.value.forEach(t=>{t&&t.obs.forEach(a=>{if(a.obs_datetime){const s=a.obs_datetime.split(" ")[0];e.add(s)}})}),Array.from(e).sort((t,a)=>new Date(a).getTime()-new Date(t).getTime())}),D=_(()=>{if(!d.value)return[];const e=new Map;return y.value.forEach(t=>{if(!t)return;const a=t.status||"saved";t.obs.forEach(s=>{if(s.obs_datetime&&s.obs_datetime.startsWith(d.value)){const o=s.encounter_id||"unsaved-".concat(t.encounter_type,"-").concat(d.value),c=s.encounter_datetime||s.obs_datetime;e.has(o)||e.set(o,{encounter_id:o,encounter_type:t.encounter_type,name:J(t.encounter_type),encounter_datetime:c,status:a,observations:[]});const m=T(s);e.get(o).observations.push(m)}})}),Array.from(e.values()).sort((t,a)=>new Date(a.encounter_datetime).getTime()-new Date(t.encounter_datetime).getTime())}),U=_(()=>({paging:!0,lengthChange:!1,searching:!1,ordering:!1,info:!0,autoWidth:!0,responsive:!0,pageLength:8})),q=_(()=>[{data:"observation",title:"Observation"},{data:"value",title:"Value"},{data:"date",title:"Date"}]),J=e=>{const t=ne[e];return t?t.toLowerCase().replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()):"Unknown Encounter"},C=e=>se.toStandardHisDisplayFormat(e),V=e=>{d.value=e,n.value=null,u.value=[],D.value.length>0&&$(D.value[0])},$=e=>{n.value=e,P()},N=async(e,t,a)=>{const s="  ".repeat(t),o=t>0?"└─ ":"";if(a.push({observation:"".concat(s).concat(o).concat(e.concept_name||await M(e.concept_id)),value:await W(e),date:C(e.obs_datetime)}),e.children&&e.children.length>0)for(const c of e.children)await N(c,t+1,a)},M=async e=>{try{return await R.getConceptName(e)}catch(t){return console.error("Error fetching concept name for ID ".concat(e,":"),t),"Concept ".concat(e)}},P=async()=>{if(!n.value){u.value=[];return}w.value=!0;try{const e=n.value.observations||[],t=[];for(const a of e)await N(a,0,t);u.value=t}catch(e){console.error("Error loading table data:",e),u.value=[]}finally{w.value=!1}},W=async e=>e.value_text?e.value_text:e.value_numeric!==null&&e.value_numeric!==void 0?String(e.value_numeric):e.value_datetime?C(e.value_datetime):e.value_coded?await R.getConceptName(e.value_coded):"N/A",Q=e=>{const t=i.value.observations.map(a=>({...a,obs:a.obs.filter(s=>s.encounter_id!==e)})).filter(a=>a.obs.length>0);i.value.observations=t},j=async()=>{if(!n.value)return;const e={id:n.value.encounter_id,status:n.value.status};oe(async t=>{var a;try{e.status==="saved"?(i.value.void_encounters=((a=i.value)==null?void 0:a.void_encounters)||[],i.value.void_encounters.push({id:e.id,reason:t}),L("Encounter has been voided!",2e3)):L("Unsaved encounter has been removed!",2e3),Q(e.id),n.value=null,u.value=[],await new Promise(s=>setTimeout(s,0)),await le(i.value),await k()}catch(s){re("".concat(s),32e3)}})},k=async()=>{u.value=[],y.value=i.value.observations||[],b.value.length>0&&V(b.value[0])};return S(i,async()=>{await k()},{deep:!0,immediate:!0}),S(A,async()=>{await k()},{deep:!0}),(e,t)=>{const a=z("ion-col"),s=z("ion-row");return r(),v("div",ue,[h(s,null,{default:p(()=>[h(a,{size:"1.6",style:{height:"62vh","overflow-y":"auto","padding-right":"0px","padding-left":"0px"}},{default:p(()=>[l("div",null,[(r(!0),v(B,null,F(b.value,(o,c)=>(r(),g(x,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:m=>V(o),key:c,name:C(o),fill:d.value!=o?"outline":"solid",color:d.value==o?"success":""},null,8,["onClick","name","fill","color"]))),128))])]),_:1}),h(a,{size:"2.5"},{default:p(()=>[l("div",null,[(r(!0),v(B,null,F(D.value,(o,c)=>{var m,O;return r(),g(x,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:ge=>$(o),key:c,name:o.name,fill:((m=n.value)==null?void 0:m.encounter_id)!=o.encounter_id?"outline":"solid",color:((O=n.value)==null?void 0:O.encounter_id)==o.encounter_id?"success":""},null,8,["onClick","name","fill","color"])}),128))])]),_:1}),h(a,{offset:"0.1",size:"7.8"},{default:p(()=>[l("div",ce,[l("div",de,[l("h3",ve,[Z(E(n.value?n.value.name:"Select an Encounter")+" ",1),n.value?(r(),v("span",{key:0,class:G(["status-badge",n.value.status])},E(n.value.status),3)):H("",!0)]),n.value&&n.value.status==="saved"?(r(),g(x,{key:0,name:"Void Encounter",fill:"solid",color:"danger",onClick:t[0]||(t[0]=o=>j())})):H("",!0)]),l("div",me,[w.value?(r(),v("div",fe,[...t[1]||(t[1]=[l("p",null,"Loading observations...",-1)])])):u.value.length===0&&n.value?(r(),v("div",pe,[l("p",null,"No observations found for "+E(n.value.name),1)])):(r(),g(ee(te),{key:2,ref:"dataTable",class:"display nowrap modern-table",width:"100%",data:u.value,columns:q.value,options:U.value},{default:p(()=>[...t[2]||(t[2]=[l("thead",null,[l("tr",null,[l("th",null,"Observation"),l("th",null,"Value"),l("th",null,"Date")])],-1)])]),_:1},8,["data","columns","options"]))])])]),_:1})]),_:1})])}}}),Ce=ie(_e,[["__scopeId","data-v-7ce320a6"]]);export{Ce as default};
