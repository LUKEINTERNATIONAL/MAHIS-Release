import{d as Et,ap as Vt,cp as Ht,r as n,c as zt,b2 as f,a as Ut,w as u,O as Q,f as V,J as H,l as r,e as $t,m as Z,k as v,u as P,V as Gt,dz as Yt,a4 as qt,i as w,bM as tt,v as y,a7 as Jt,eK as Kt,ba as b}from"./vendor-CzFJ4KTZ.js";import{u as Xt,_ as jt,d as Qt,a as Zt}from"./nonPharmaTherapyStore-c89c4BAX.js";import{u as te,aK as ee,bX as ae,aM as ne,d as se,aO as oe,b7 as ie,bE as re,bp as le,T as ce,J as et,G as S,s as g,ag as ue,aU as me,H as z,aP as O,aR as at,bV as pe,bH as U,q as I,t as nt,n as ve,_ as de}from"../index-MS1JWVwx.js";import{D as fe}from"./DemographicBar-C4XFQp_u.js";import{C as ge,b as he,O as De}from"./OPDOutcome-CkjD2DXH.js";import{I as Pe,N as we}from"./NextAppointment-ByM3dQoG.js";import{O as ye}from"./OPDDiagnosis-Bn7B4hCB.js";import{O as be}from"./OPDPrintingModal-BLIVYvAP.js";import{p as st}from"./ClientUtils-CLxPFW2t.js";import{u as Se}from"./usePatientProfile-CFlYz9j-.js";import{u as Oe}from"./useUserActivities-PhOwnG0h.js";import"./lodash-NJiRuGo9.js";import"./drug_prescription_service-B3f6x3Hb.js";import"./patient_diagnosis_service-3Wtt-KFa.js";import"./apexcharts-C9muk_WD.js";import"./LevelOfConsciousness.vue_vue_type_script_setup_true_lang-CR_wx7fN.js";import"./previousComplaints-BSRe-Bmg.js";import"./patient_complaints_service-DDyZiphm.js";import"./DashBox-D48htrr2.js";import"./BasicForm-qYfBDefx.js";import"./DateInputField-C0vJN2Ba.js";import"./formatServerData-LwApap27.js";import"./Outcome-ChKpsrdd.js";import"./wardsStore-CB9tfg30.js";import"./LabOrdersList-DZanuE2h.js";import"./group_validation-BbPc1Aue.js";import"./RadiologyStore-HTDqv8sa.js";import"./user_role_management-gs94l_cP.js";import"./ncd_appointment_service-DV0A-Qet.js";import"./Registration-SsfAkjaw.js";import"./useLocation-BA8To2jg.js";import"./vaccines_service-Do02tFWq.js";import"./sms_service-B6YemPF5.js";import"./EIRreportsStore-Bm2_2gSo.js";import"./Export-A2XCvwtJ.js";import"./useNeonatalEnrollmentStore-gP4YJ0fZ.js";import"./enrollment-DU-PLRUa.js";const Ce={key:0,class:"spinner-overlay"},Te={style:{width:"90vw",margin:"0 auto","margin-top":"10px"}},Ae={class:"back_profile"},Ie=Et({__name:"ConsultationPlan",setup(ke){const{currentTabIndex:m}=Xt(),{printVisitSummary:ot}=Se(),{hasWaitingList:C}=Oe(),d=Vt(),it=Ht(),k=n(!1),_=n(!0),$=n(!1),N=n(!1),x=n(!0),rt=n(!1),B=n(!1),lt=n(!1),ct=te(),ut=ee(),mt=ae(),T=ne(),pt=se(),G=oe(),vt=ie(),dt=re(),ft=le(),R=n(!1),h=n(!1),Y=zt(()=>({text:h.value?"Saving...":"Finish",icon:h.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:R.value||h.value})),{patient:l}=f(ct),{investigations:gt}=f(ut),{OPDdiagnosis:ht}=f(mt),{selectedMedicalDrugsList:q}=f(T),{OPDActivities:A}=f(pt),{outcomes:Dt}=f(G),{currentSelectedNextAppointmentDate:Pt}=f(dt),{presentingComplaints:wt}=f(ft),{vitals:yt}=f(vt),J=n(null),L=n(null),K=n(null),bt=n(null),St=n(null),Ot=n(null),F=n(null),a=n(),X=()=>A.value.map(t=>({title:t,icon:""})),Ct=async(t,e,o)=>{var c;if(e===0&&await _t(),!await j())return;await p(),t%1===0&&(m.value=t),F.value&&o&&F.value.changeTab(t),((c=a.value[t])==null?void 0:c.title)==="Investigations"&&L.value&&await L.value.openAHDModal()},D=()=>{var o;if(!a.value||a.value.length===0)return null;const t=m.value>=0&&m.value<a.value.length?m.value:0;switch((o=a.value[t])==null?void 0:o.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(A.value.length>0)switch(A.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Tt=()=>{d.push("home")},At=()=>{d.push("patientProfile")},It=async()=>{N.value=!0,S("Printing consultation summary... Please wait.");try{await ot(),S("Consultation summary printed successfully!"),setTimeout(()=>{d.push("home")},3500)}catch(t){g("Failed to print consultation summary.")}finally{N.value=!1}},kt=()=>{S("Patient has finished consultation!"),d.push("home")},j=async()=>{const t=await ue.getObsByEncounterIdAndDate(me.PRESENTING_COMPLAINTS);return!!(t&&t.length>0)},p=async()=>{var e,o;const t=z.sessionDate();for(let i=0;i<a.value.length;i++)if(!await j())_.value=!1,a.value[i].title!=="Clinical Assessment"&&(a.value[i].icon=Kt);else{_.value=!0,$.value=!1;const c=a.value[i];if(c.title==="Clinical Assessment"){const s=O("presentingComplaints");a.value[i].icon=M(t,s)?b:""}else if(c.title==="Investigations"){const s=(o=(e=l.value)==null?void 0:e.labOrders)==null?void 0:o.saved,E=s==null?void 0:s.filter(Wt=>z.toStandardHisFormat(t)===z.toStandardHisFormat(Wt.order_date));a.value[i].icon=(E==null?void 0:E.length)>0?b:""}else if(c.title==="Diagnosis"){const s=O("diagnosis");a.value[i].icon=M(t,s)?b:""}else if(c.title==="Treatment Plan"){const s=O("treatment");a.value[i].icon=(s==null?void 0:s.length)>0?b:""}else if(c.title==="Next Appointment"){const s=O("appointments");a.value[i].icon=M(t,s)?b:""}else if(c.title==="Outcome"){const s=O("outcomes");a.value[i].icon=(s==null?void 0:s.length)>0?b:""}}W()},M=(t,e)=>{if(!e)return!1;const o=new Date(t);return o.setHours(0,0,0,0),e.some(i=>{const c=new Date(i.obs_datetime||i.order_date);return c.setHours(0,0,0,0),c.getTime()===o.getTime()})},_t=async()=>{var t;k.value=!0;try{await Promise.all([(t=J.value)==null?void 0:t.onSubmit()]),await at(l.value),pe()}catch(e){throw g("Failed to save clinical assessment"),e}finally{k.value=!1}},Nt=async()=>{try{const t=await Qt();l.value={...l.value,...t},await Zt().saveNonPharmaTherapyPatientData()}catch(t){nt("Failed to save treatment plan")}},xt=()=>{const t=q.value;return console.log("Checking prescribed medications:",{medicationsCount:t.length,medications:t}),t.length>0},Bt=async()=>{var t;try{h.value=!0,await((t=K.value)==null?void 0:t.onSubmit()),await Nt(),await G.saveOutcomPatientData(),await at(l.value);const e=localStorage.getItem("locationID");if(!e){g("Location ID missing.");return}const o=xt();if(C("Waiting for Laboratory")){await Lt(e),S("Patient moved to Consultation for Lab follow-up.");return}if(o&&C("Waiting for Consultation")){C("Waiting for Dispensation")?await Rt(e):await Ft(e);return}if(!o&&C("Waiting for Consultation")){await Mt(e);return}}catch(e){g("Failed to save consultation.")}finally{h.value=!1}},Rt=async t=>{try{await U.addPatientToStage(l.value,"DISPENSATION"),await I().refresh(t),T.clearSelectedMedicalDrugsList(),S("Patient moved to Dispensation."),d.push("home")}catch(e){throw g("Failed to move patient to dispensation"),e}},Lt=async t=>{try{await U.addPatientToStage(l.value,"CONSULTATION"),await I().refresh(t),T.clearSelectedMedicalDrugsList(),d.push("home")}catch(e){throw g("Failed to move patient to consultation"),e}},Ft=async t=>{try{await U.addPatientToStage(l.value,"DISPENSATION"),await I().refresh(t),T.clearSelectedMedicalDrugsList(),nt("Patient moved to dispensation queue. You lack access to dispense."),d.push("home")}catch(e){throw g("Failed to move patient to dispensation"),e}},Mt=async t=>{try{await ve(l.value),await I().refresh(t),d.push("home")}catch(e){console.error("Failed to close visit:",e),g("Failed to close visit.")}};Ut(async()=>{var t;try{if(A.value.length===0){await d.push("home");return}a.value=X(),st.setCurrentPatientID((t=l.value)==null?void 0:t.patientID),await p(),(m.value===void 0||m.value<0)&&(m.value=0),R.value=!1,W()}catch(e){console.error("Error: ",e)}}),u(m,async()=>{await W()}),u(yt,async()=>{await p()},{deep:!0}),u(l,async()=>{var t;await p(),st.setCurrentPatientID((t=l.value)==null?void 0:t.patientID)},{deep:!0}),u(gt,async()=>{await p()},{deep:!0}),u(ht,async()=>{await p()},{deep:!0}),u(q,async()=>{await p()},{deep:!0}),u(Dt,async()=>{await p()},{deep:!0}),u(Pt,async()=>{await p()}),u(wt,async()=>{await p()},{deep:!0}),u(it,async()=>{x.value=!1,a.value=X(),setTimeout(()=>{m.value=0,x.value=!0},0)},{deep:!0}),u(lt,t=>{B.value=t,B.value&&setTimeout(()=>{B.value=!1},15e3)}),u(Y,(t,e)=>{console.log("Done button options changed:",{from:e,to:t,currentStep:m.value,tabsLength:a.value.length})},{deep:!0});const W=()=>{let t=!1;return h.value&&(t=!0),R.value=t,!t};return(t,e)=>(V(),Q(P(Jt),null,{default:H(()=>[r(be,{onYes:It,onNo:kt,isOpen:rt.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),k.value?(V(),$t("div",Ce,[r(P(Gt),{name:"bubbles"}),e[3]||(e[3]=v("div",{class:"loading-text"},"Please wait...",-1))])):Z("",!0),r(P(Yt),{"is-open":N.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),r(ce),r(P(qt),{fullscreen:!0},{default:H(()=>[r(fe),v("div",Te,[x.value?(V(),Q(jt,{key:0,ref_key:"wizard",ref:F,headingTitle:"Consultation Plan","vertical-tabs":"","navigable-tabs":_.value,"scrollable-tabs":"",startIndex:0,doneButton:Y.value,nextButton:{disabled:$.value},"custom-tabs":a.value,tabs:a.value,onChange:Ct,"onComplete:wizard":e[2]||(e[2]=o=>Bt())},{default:H(()=>[v("div",null,[v("div",Ae,[r(et,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:P(tt),"font-weight":"600",onClick:e[0]||(e[0]=o=>Tt())},null,8,["icon"]),r(et,{name:"Back to Profile",iconSlot:"start",fill:"clear",icon:P(tt),"font-weight":"600",onClick:e[1]||(e[1]=o=>At()),style:{"margin-left":"15px"}},null,8,["icon"])])]),w(v("div",null,[r(ge,{ref_key:"clinicalAssessmentRef",ref:J},null,512)],512),[[y,D()==="ClinicalAssessment"]]),w(v("div",null,[r(Pe,{ref_key:"investigationsRef",ref:L},null,512)],512),[[y,D()==="Investigations"]]),w(v("div",null,[r(ye,{ref_key:"diagnosisRef",ref:K},null,512)],512),[[y,D()==="OPDDiagnosis"]]),w(v("div",null,[r(he,{ref_key:"treatmentPlanRef",ref:bt},null,512)],512),[[y,D()==="OPDTreatmentPlan"]]),w(v("div",null,[r(we,{ref_key:"nextAppointmentRef",ref:St},null,512)],512),[[y,D()==="NextAppointment"]]),w(v("div",null,[r(De,{ref_key:"outcomeRef",ref:Ot},null,512)],512),[[y,D()==="Outcome"]])]),_:1},8,["navigable-tabs","doneButton","nextButton","custom-tabs","tabs"])):Z("",!0)])]),_:1})]),_:1}))}}),va=de(Ie,[["__scopeId","data-v-d7d4c5f1"]]);export{va as default};
