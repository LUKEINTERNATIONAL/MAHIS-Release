import{d as Q,aW as j,cp as X,r as m,c as _,w as O,a as Y,H as z,e as d,f as l,l as h,J as p,k as o,F as B,P as H,O as g,m as L,Q as Z,K as b,p as G,u as ee,b7 as te}from"./vendor-9T3c-tPq.js";import{u as ae,b3 as ne,J as k,H as se,s as F,cG as oe,E as re,G as le,aT as R,_ as ie}from"../index-Zqy7iC3X.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-qlDaiiMc.js";const ce={class:"visitContent"},ue={class:"visitData"},de={class:"table-header"},ve={class:"encounter-title"},me={class:"table-responsive"},pe={key:0,class:"loading-state"},fe={key:1,class:"empty-state"},_e=Q({__name:"VisitsHistory",setup(he){const A=ae(),{patient:x}=j(A),I=X(),y=m([]),u=m(""),n=m(null),i=m([]),w=m(!1),T=e=>{const t={...e};return e.child&&!e.children?t.children=e.child:e.children||(t.children=[]),t.children&&t.children.length>0&&(t.children=t.children.map(a=>T(a))),t},D=_(()=>{const e=new Set;return y.value.forEach(t=>{t.obs.forEach(a=>{if(a.obs_datetime){const r=a.obs_datetime.split(" ")[0];e.add(r)}})}),Array.from(e).sort((t,a)=>new Date(a).getTime()-new Date(t).getTime())}),C=_(()=>{if(!u.value)return[];const e=new Map;return y.value.forEach(t=>{const a=t.status||"saved";t.obs.forEach(r=>{if(r.obs_datetime&&r.obs_datetime.startsWith(u.value)){const s=r.encounter_id||"unsaved-".concat(t.encounter_type,"-").concat(u.value),c=r.encounter_datetime||r.obs_datetime;e.has(s)||e.set(s,{encounter_id:s,encounter_type:t.encounter_type,name:J(t.encounter_type),encounter_datetime:c,status:a,observations:[]});const v=T(r);e.get(s).observations.push(v)}})}),Array.from(e.values()).sort((t,a)=>new Date(a.encounter_datetime).getTime()-new Date(t.encounter_datetime).getTime())}),M=_(()=>({paging:!0,lengthChange:!1,searching:!1,ordering:!1,info:!0,autoWidth:!0,responsive:!0,pageLength:8})),W=_(()=>[{data:"observation",title:"Observation"},{data:"value",title:"Value"},{data:"date",title:"Date"}]),J=e=>{const t=ne[e];return t?t.toLowerCase().replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()):"Unknown Encounter"},E=e=>se.toStandardHisDisplayFormat(e),V=e=>{u.value=e,n.value=null,i.value=[],C.value.length>0&&S(C.value[0])},S=e=>{n.value=e,q()},$=async(e,t,a)=>{const r="  ".repeat(t),s=t>0?"└─ ":"";if(a.push({observation:"".concat(r).concat(s).concat(e.concept_name||await U(e.concept_id)),value:await K(e),date:E(e.obs_datetime)}),e.children&&e.children.length>0)for(const c of e.children)await $(c,t+1,a)},U=async e=>{try{return await R.getConceptName(e)}catch(t){return console.error("Error fetching concept name for ID ".concat(e,":"),t),"Concept ".concat(e)}},q=async()=>{if(!n.value){i.value=[];return}w.value=!0;try{const e=n.value.observations||[],t=[];for(const a of e)await $(a,0,t);i.value=t}catch(e){console.error("Error loading table data:",e),i.value=[]}finally{w.value=!1}},K=async e=>e.value_text?e.value_text:e.value_numeric!==null&&e.value_numeric!==void 0?String(e.value_numeric):e.value_datetime?E(e.value_datetime):e.value_coded?await R.getConceptName(e.value_coded):"N/A",P=async()=>{if(n.value){if(n.value.status!=="saved"){F("Cannot void unsaved encounters",2e3);return}oe(async e=>{try{await re.voidEncounter(n.value.encounter_id,e),await f(),le("Encounter has been voided!",2e3)}catch(t){F("".concat(t),32e3)}})}},f=async()=>{i.value=[],y.value=x.value.observations||[],D.value.length>0&&V(D.value[0])};return O(x.value,async()=>{await f()},{deep:!0}),O(I,async()=>{await f()},{deep:!0}),Y(async()=>{await f()}),(e,t)=>{const a=z("ion-col"),r=z("ion-row");return l(),d("div",ce,[h(r,null,{default:p(()=>[h(a,{size:"1.6",style:{height:"62vh","overflow-y":"auto","padding-right":"0px","padding-left":"0px"}},{default:p(()=>[o("div",null,[(l(!0),d(B,null,H(D.value,(s,c)=>(l(),g(k,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:v=>V(s),key:c,name:E(s),fill:u.value!=s?"outline":"solid",color:u.value==s?"success":""},null,8,["onClick","name","fill","color"]))),128))])]),_:1}),h(a,{size:"2.5"},{default:p(()=>[o("div",null,[(l(!0),d(B,null,H(C.value,(s,c)=>{var v,N;return l(),g(k,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:ge=>S(s),key:c,name:s.name,fill:((v=n.value)==null?void 0:v.encounter_id)!=s.encounter_id?"outline":"solid",color:((N=n.value)==null?void 0:N.encounter_id)==s.encounter_id?"success":""},null,8,["onClick","name","fill","color"])}),128))])]),_:1}),h(a,{offset:"0.1",size:"7.8"},{default:p(()=>[o("div",ue,[o("div",de,[o("h3",ve,[Z(b(n.value?n.value.name:"Select an Encounter")+" ",1),n.value?(l(),d("span",{key:0,class:G(["status-badge",n.value.status])},b(n.value.status),3)):L("",!0)]),n.value&&n.value.status==="saved"?(l(),g(k,{key:0,name:"Void Encounter",fill:"solid",color:"danger",onClick:t[0]||(t[0]=s=>P())})):L("",!0)]),o("div",me,[w.value?(l(),d("div",pe,[...t[1]||(t[1]=[o("p",null,"Loading observations...",-1)])])):i.value.length===0&&n.value?(l(),d("div",fe,[o("p",null,"No observations found for "+b(n.value.name),1)])):(l(),g(ee(te),{key:2,ref:"dataTable",class:"display nowrap modern-table",width:"100%",data:i.value,columns:W.value,options:M.value},{default:p(()=>[...t[2]||(t[2]=[o("thead",null,[o("tr",null,[o("th",null,"Observation"),o("th",null,"Value"),o("th",null,"Date")])],-1)])]),_:1},8,["data","columns","options"]))])])]),_:1})]),_:1})])}}}),Ee=ie(_e,[["__scopeId","data-v-af20ef73"]]);export{Ee as default};
