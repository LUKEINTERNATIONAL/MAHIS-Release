import{D as oe,d as re,r as c,aF as ie,c as ue,a as de,G as ce,Q as fe,f as g,H as i,l as a,u as s,L as me,k as r,bH as ve,b7 as pe,e as S,m as z,dt as we,az as ge,a3 as v,I as D,a4 as h,a5 as P,d1 as T,bN as he,bt as M,bs as L,P as E,a6 as V,p,bq as Pe}from"./vendor-CJ2tyHrn.js";import{L as B,ab as K,ac as W,t as U,V as ye,G as Se,ad as G,x as y,ae as Ae,af as Ie,ag as be,S as j,a as Ce,ah as ke,_ as xe}from"../index-CPIhguZJ.js";import{i as _e}from"./Img-CJEgX1Vr.js";import{p as Me,g as Le}from"./userService-BEws_pQM.js";import{u as Ee}from"./wardsStore-DRE4cKPY.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-BtvCa6MI.js";const F=oe("authStatusStore",{state:()=>({emrAuthenticated:!1,miumAuthenticated:!1,lastLoginAttempt:null,loginTimestamp:null,username:""}),getters:{isPartiallyAuthenticated:n=>n.emrAuthenticated||n.miumAuthenticated,isFullyAuthenticated:n=>n.emrAuthenticated&&n.miumAuthenticated,authenticationStatus:n=>n.emrAuthenticated&&n.miumAuthenticated?"full":n.emrAuthenticated||n.miumAuthenticated?"partial":"none",authenticatedSystems:n=>{const u=[];return n.emrAuthenticated&&u.push("EMR"),n.miumAuthenticated&&u.push("MIUM"),u},failedSystems:n=>{const u=[];return n.emrAuthenticated||u.push("EMR"),n.miumAuthenticated||u.push("MIUM"),u}},actions:{setEMRAuthenticated(n){this.emrAuthenticated=n,n&&(this.loginTimestamp=new Date)},setMIUMAuthenticated(n){this.miumAuthenticated=n},setUsername(n){this.username=n},recordLoginAttempt(){this.lastLoginAttempt=new Date},clearAuthStatus(){this.emrAuthenticated=!1,this.miumAuthenticated=!1,this.loginTimestamp=null,this.lastLoginAttempt=null,this.username=""},hasSystemAccess(n){return n==="EMR"?this.emrAuthenticated:this.miumAuthenticated}},persist:!0}),Ue={class:"login-container"},Re={key:0,style:{"justify-content":"center",display:"block"}},qe={style:{"font-size":"15px"}},Ne={style:{"font-size":"12px",color:"#34af4d"}},ze={key:1},De={style:{"font-size":"15px"}},Fe={key:0},$e={style:{"text-align":"left"}},He={class:"signup-link"},Oe={style:{display:"flex","justify-content":"center","align-items":"center"}},Te={key:1},Ve={style:{"text-align":"left"}},Be={key:0,class:"password-requirements"},Ke={class:"requirements-list"},We={class:"signup-link"},Ge=re({__name:"Login",setup(n){const u=c(""),m=c(""),R=c(""),A=c(!1),w=c(!1),q=c("test"),f=c(new ke),t=c({username:"",currentPassword:"",newPassword:"",confirmPassword:""}),I=c(!1),b=c(!1),C=c(!1),N=ie(),Q=B(),k=K(),$=ue(()=>t.value.username.trim()!==""&&t.value.currentPassword.trim()!==""&&t.value.newPassword.trim()!==""&&t.value.confirmPassword.trim()!==""&&W(t.value.newPassword)&&t.value.newPassword===t.value.confirmPassword&&t.value.newPassword!==t.value.currentPassword),Y=()=>{k.checkLoginStatus()&&N.push("/home")},Z=async()=>{Q.terminate(),await B().postData("SET_OFFLINE_PROGRAMS")},J=()=>{R.value=localStorage.getItem("core_version")||""},X=async()=>{const l=K(),e=await Le();e&&(l.setUserFacilityName(e.name),l.setFacilityLocation(e),localStorage.setItem("facility_code",e.code))},ee=async()=>{const l=await f.value.checkUserPrograms(void 0);l!=null&&l.programs&&Ce().setAuthorizedPrograms(l==null?void 0:l.programs)},x=()=>{w.value=!w.value,w.value&&(t.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""})},te=()=>{U("Help functionality to be implemented")},se=async()=>{if(!$.value){U("Please complete all fields correctly"),U("Password must be at least 8 characters long and contain at least one uppercase letter, one lowercase letter, one number, and one special character.");return}try{const l=await f.value.requestLogin(t.value.currentPassword,t.value.username);if(l){const{authorization:e}=l,{token:d,user:o}=e;o&&(localStorage.setItem("apiKey",d),await ye.updateUser(o.user_id,{password:t.value.newPassword}),Se("Password changed successfully!"),await f.value.requestLogin(t.value.newPassword,t.value.username),t.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""},w.value=!1,localStorage.setItem("apiKey",""))}}catch(l){l instanceof G?y("Current password is incorrect"):y("Error changing password: ".concat(l))}},ae=async()=>{const l=F();if(!u.value||!m.value)return{success:!1,error:null,validationError:!0};f.value.setUsername(u.value),l.setUsername(u.value);try{return await f.value.login(m.value),await X(),await ee(),await be(),await Me(),await Ee().fetchWards(),l.setEMRAuthenticated(!0),k.setLoginStatus(!0),{success:!0,error:null}}catch(e){return l.setEMRAuthenticated(!1),k.setLoginStatus(!1),{success:!1,error:e}}},ne=async()=>{if(j.getLanConnectionStatus()||j.getPouchDbStatus())return{success:!0,error:null};const e=F();if(!u.value||!m.value)return{success:!1,error:null,validationError:!0};f.value.setUsername(u.value);try{return await f.value.loginToMIUM(m.value),e.setMIUMAuthenticated(!0),{success:!0,error:null}}catch(d){return e.setMIUMAuthenticated(!1),{success:!1,error:d}}},H=async()=>{const l=F();if(!u.value||!m.value){U("Complete form to log in");return}l.recordLoginAttempt();const[e,d]=await Promise.allSettled([ae(),ne()]),o=e.status==="fulfilled"&&e.value.success,O=d.status==="fulfilled"&&d.value.success;if(o)N.push("/home");else if(!o&&!O){const _=e.status==="fulfilled"?e.value.error:e.reason;_ instanceof G?y("Invalid username or password"):_ instanceof Ae?(x(),y("Please change your password",5e4)):_ instanceof Ie?(x(),y("Your password has expired. Please change your password",5e4)):y("".concat(_),5e4)}else!o&&O&&(e.status==="fulfilled"?e.value.error:e.reason)},le=l=>{N.push(l)};return de(async()=>{Y(),k.setLoginStatus(!1),await f.value.loadConfig(),J(),await Z()}),(l,e)=>{const d=ce("ion-icon");return g(),fe(s(Pe),null,{default:i(()=>[a(s(me),{class:"ion-padding login-page"},{default:i(()=>[r("div",Ue,[a(s(ve),{style:{"background-color":"#fff"}},{default:i(()=>[a(s(pe),null,{default:i(()=>[a(s(we),{class:"login_img",src:s(_e)("mw.png"),id:"logo"},null,8,["src"]),a(s(ge),{class:"login-title"},{default:i(()=>[q.value==="development"||q.value==="test"?(g(),S("span",Re,[r("div",null,[e[11]||(e[11]=v(" MaHIS ",-1)),r("small",qe,"(v"+D(R.value)+")",1)]),r("div",Ne,"("+D(q.value)+")",1)])):(g(),S("span",ze,[e[12]||(e[12]=v(" MaHIS ",-1)),r("small",De,"(v"+D(R.value)+")",1)]))]),_:1}),w.value?z("",!0):(g(),S("div",Fe,[r("span",$e,[a(s(h),{value:u.value,onIonInput:e[0]||(e[0]=o=>u.value=o.target.value||""),type:"text",label:"Username",ref:"usernameRef","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:i(()=>[a(s(P),{slot:"end"},{default:i(()=>[a(d,{icon:s(T)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),a(s(h),{value:m.value,onIonInput:e[2]||(e[2]=o=>m.value=o.target.value||""),type:A.value?"text":"password",label:"Password",ref:"passwordRef","label-placement":"floating",fill:"outline",placeholder:"Enter Password",class:"input-fields",required:"",onKeydown:he(H,["enter"])},{default:i(()=>[a(s(P),{slot:"end"},{default:i(()=>[a(d,{icon:A.value?s(M):s(L),onClick:e[1]||(e[1]=o=>A.value=!A.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"])]),a(s(E),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:H,class:"login-button"},{default:i(()=>[...e[13]||(e[13]=[v(" Login ",-1)])]),_:1}),r("p",He,[e[17]||(e[17]=v(" For help click ",-1)),r("a",{href:"#",onClick:V(te,["prevent"])},"Here"),e[18]||(e[18]=v()),e[19]||(e[19]=r("br",null,null,-1)),r("div",Oe,[a(s(E),{fill:"clear",size:"small",onClick:x,style:{display:"inline","--padding-start":"2px","--padding-end":"2px"}},{default:i(()=>[...e[14]||(e[14]=[r("span",{style:{"text-decoration":"underline",color:"#34af4d",cursor:"pointer"}}," Change Password ",-1)])]),_:1}),e[16]||(e[16]=v(" | ",-1)),a(s(E),{fill:"clear",size:"small",onClick:e[3]||(e[3]=o=>le("/downloads")),style:{display:"inline","--padding-start":"2px","--padding-end":"2px"}},{default:i(()=>[...e[15]||(e[15]=[r("span",{style:{"text-decoration":"underline",color:"#34af4d",cursor:"pointer"}}," Download MaHIS ",-1)])]),_:1})])])])),w.value?(g(),S("div",Te,[e[22]||(e[22]=r("h3",{style:{"text-align":"center","margin-bottom":"20px",color:"#34af4d"}},"Change Password",-1)),r("span",Ve,[a(s(h),{value:t.value.username,onIonInput:e[4]||(e[4]=o=>t.value.username=o.target.value||""),type:"text",label:"Username","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:i(()=>[a(s(P),{slot:"end"},{default:i(()=>[a(d,{icon:s(T)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),a(s(h),{value:t.value.currentPassword,onIonInput:e[6]||(e[6]=o=>t.value.currentPassword=o.target.value||""),type:I.value?"text":"password",label:"Current Password","label-placement":"floating",fill:"outline",placeholder:"Enter Current Password",class:"input-fields",required:""},{default:i(()=>[a(s(P),{slot:"end"},{default:i(()=>[a(d,{icon:I.value?s(M):s(L),onClick:e[5]||(e[5]=o=>I.value=!I.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"]),a(s(h),{value:t.value.newPassword,onIonInput:e[8]||(e[8]=o=>t.value.newPassword=o.target.value||""),type:b.value?"text":"password",label:"New Password","label-placement":"floating",fill:"outline",placeholder:"Enter New Password",class:p(["input-fields",{"invalid-input":t.value.newPassword&&!s(W)(t.value.newPassword)}]),required:""},{default:i(()=>[a(s(P),{slot:"end"},{default:i(()=>[a(d,{icon:b.value?s(M):s(L),onClick:e[7]||(e[7]=o=>b.value=!b.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"]),a(s(h),{value:t.value.confirmPassword,onIonInput:e[10]||(e[10]=o=>t.value.confirmPassword=o.target.value||""),type:C.value?"text":"password",label:"Confirm New Password","label-placement":"floating",fill:"outline",placeholder:"Confirm New Password",class:p(["input-fields",{"invalid-input":t.value.confirmPassword&&t.value.newPassword!==t.value.confirmPassword}]),required:""},{default:i(()=>[a(s(P),{slot:"end"},{default:i(()=>[a(d,{icon:C.value?s(M):s(L),onClick:e[9]||(e[9]=o=>C.value=!C.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"])]),t.value.newPassword?(g(),S("div",Be,[e[20]||(e[20]=r("p",{class:"requirements-title"},"Password Requirements:",-1)),r("ul",Ke,[r("li",{class:p({valid:t.value.newPassword.length>=8})},"At least 8 characters",2),r("li",{class:p({valid:/[A-Z]/.test(t.value.newPassword)})},"One uppercase letter",2),r("li",{class:p({valid:/[0-9]/.test(t.value.newPassword)})},"One number",2),r("li",{class:p({valid:/[@#$%^&+=*!-]/.test(t.value.newPassword)})}," One special character (@#$%^&+=*!-) ",2),r("li",{class:p({valid:t.value.newPassword!==t.value.currentPassword&&t.value.currentPassword!==""})}," Different from current password ",2)])])):z("",!0),a(s(E),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:se,class:"login-button",disabled:!$.value},{default:i(()=>[...e[21]||(e[21]=[v(" Change Password ",-1)])]),_:1},8,["disabled"]),r("p",We,[r("a",{href:"#",onClick:V(x,["prevent"])},"Back to Login")])])):z("",!0)]),_:1})]),_:1})])]),_:1})]),_:1})}}}),tt=xe(Ge,[["__scopeId","data-v-8e33c718"]]);export{tt as default};
