import{d as ge,M as Re,ag as Ae,ae as Fe,a2 as xe,dt as Pe,e0 as Me,ah as Je,a6 as Ve,E as pe,G as Ee,ab as me,I as ke,bo as We,N as ze,aW as je,R as Ce,H as S,O,f as u,J as d,l as c,k as J,K as ae,Q as P,e as V,F as oe,P as Le,b2 as be,am as Be,r as g,c as re,w as M,a as De,m as B,u as R,cr as qe,es as Ye,b7 as Se,cY as Ue,n as ue}from"./vendor-Do1wNTJR.js";import{D as U,_ as ye,u as He,s as $e,x as he,n as se,z as we,S as A,g as Te,O as ne,t as Oe,F as fe,bI as Ne,w as le,ao as D,I as ve,ba as Ge,o as Ie,k as Ke,H as Y,bJ as Qe,a as Xe,a3 as Ze}from"../index-DK7ddGbV.js";import{E as et}from"./EnterLabResultsModal-1OGSHlMK.js";import{B as tt}from"./BasicForm-Cs_mEoF1.js";import{u as at}from"./useUserActivities-CcUo4d9F.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-CCt-rnNp.js";import"./DateInputField--xrpOlHx.js";const st=ge({components:{IonButtons:je,IonButton:ze,IonModal:We,IonHeader:ke,IonContent:me,IonToolbar:Ee,IonTitle:pe,IonItem:Ve,IonList:Je,IonAvatar:Me,IonImg:Pe,IonLabel:xe,IonPage:Fe,IonMenu:Ae,BasicForm:tt,IonFooter:Re,DynamicButton:U},data(){return{popoverStatus:null}},props:{keyboardClose:{type:Boolean,default:!1},keepContentsMounted:{type:Boolean,default:!1},content:{default:[]},popoverOpen:{type:Boolean,default:!1},event:{type:Event,default:""},title:{type:String,default:""}},methods:{dismiss(){Ce.dismiss()},nav(h,b){this.dismiss(),this.$router.push(h)}}}),nt={class:"modal_wrapper"},ot={class:"center text_12"};function rt(h,b,G,L,K,Q){const f=S("ion-title"),F=S("ion-button"),r=S("ion-buttons"),H=S("ion-toolbar"),C=S("ion-header"),$=S("ion-skeleton-text"),I=S("ion-col"),w=S("ion-row"),E=S("ion-content"),x=S("ion-modal");return u(),O(x,{"is-open":h.popoverOpen,"show-backdrop":!0,onDidDismiss:b[1]||(b[1]=v=>h.$emit("closePopover",!1)),"keyboard-close":h.keyboardClose},{default:d(()=>[c(C,null,{default:d(()=>[c(H,null,{default:d(()=>[c(f,null,{default:d(()=>[J("b",null,"Lab results for ("+ae(h.content.name)+") test",1)]),_:1}),c(r,{slot:"end"},{default:d(()=>[c(F,{onClick:b[0]||(b[0]=v=>h.$emit("closeModal"))},{default:d(()=>[...b[2]||(b[2]=[P("Close",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),c(E,{class:"ion-padding"},{default:d(()=>[J("div",nt,[J("div",ot,[c(w,null,{default:d(()=>[(u(!0),V(oe,null,Le(h.content.result,(v,W)=>(u(),O(I,{size:"4",key:W},{default:d(()=>[c(w,null,{default:d(()=>[c(I,{size:"8"},{default:d(()=>[v.indicator&&v.indicator.name?(u(),V(oe,{key:0},[P(ae(v.indicator.name),1)],64)):(u(),O($,{key:1,animated:"",style:{width:"80%"}}))]),_:2},1024),c(I,{class:"bold",size:"0.5"},{default:d(()=>[...b[3]||(b[3]=[P(":",-1)])]),_:1}),c(I,{class:"bold",size:"2"},{default:d(()=>[P(ae(v.value),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])])]),_:1})]),_:1},8,["is-open","keyboard-close"])}const lt=ye(st,[["render",rt],["__scopeId","data-v-a0bebd3e"]]),it=ge({__name:"AddLabTestModal",setup(h){const b=He(),G=$e(),{patient:L}=be(b),K=Be(),Q=se,f=g(""),F=g(""),r=g(""),H=g(""),C=g(null),$=g(null),I=g([]),w=re(()=>[{componentType:"multiSelectInputField",name:"test",header:"Test",options:H.value,grid:{s:"6"},icon:se.search,validation:he.required,onChange:l=>{f.value=l.name,T()&&(r.value=[])}},{componentType:"multiSelectInputField",name:"specimen",header:"Specimen",grid:{s:"6"},icon:se.search,validation:he.required,value:r.value.length==1?r.value[0]:"",options:r.value.length>1?r.value:[]}]),E=re(()=>[{componentType:"checkboxField",type:"single",name:"HIV test",label:"HIV test",value:f.value=="HIV test"},{componentType:"checkboxField",type:"single",name:"Hepatitis B Test",label:"Hepatitis B Test",value:f.value=="Hepatitis B Test"},{componentType:"checkboxField",type:"single",name:"Syphilis",label:"Syphilis",value:f.value=="Syphilis"},{componentType:"checkboxField",type:"single",name:"Hepatitis C Test",label:"Hepatitis C Test",value:f.value=="Hepatitis C Test"}]);M(f,async l=>{if(l)try{r.value=await x(l)}catch(n){r.value=[]}else r.value=[]});const x=async l=>{let n;return A.getPouchDbStatus()||A.getLanConnectionStatus()?n=await Te("specimens"):n=await ne.getSpecimens("",1e3),await D.getConceptSet(l,"",{names:n.map(y=>y.name)})};M(L,async()=>{F.value=[...L.value.labOrders.saved,...L.value.labOrders.unsaved]},{deep:!0});const v=()=>{Ce.dismiss()},W=()=>{f.value=""},T=()=>f.value=="HIV test"||f.value=="Syphilis"||f.value=="Hepatitis B Test"||f.value=="Hepatitis C Test",z=async()=>A.getPouchDbStatus()||A.getLanConnectionStatus()?await Te("test_types"):await ne.getTestTypes(),X=async()=>{if(!await ee("referral",9)){Oe("No HIV Test selected");return}fe("HIV Test sent to HTS successfully"),await Z()},j=async()=>{if(await ee("",4))try{await Ne.addPatientToStage(L.value,"LAB"),fe("The patient successfully sent to the lab. You may now attend to other patients."),await Z()}catch(l){console.error("Error sending to lab:",l),le("Failed to send patient to lab")}v()},Z=async()=>{v();const l=String(localStorage.getItem("locationID"));if(!l){le("Location not found");return}await G.refresh(l),await K.push("/home")},ee=async(l="",n)=>{try{const o=$.value.getFormValues();if(!o||Object.keys(o).length===0||!Object.values(o).some(k=>k))return!1;const p=Object.keys(o).map(async k=>{o[k]&&I.value.push({order_type_id:n,concept_id:await D.getConceptID(k,!0),name:k,specimen:"Blood",reason:"Routine",specimenConcept:await D.getConceptID("Blood",!0),referral:l})});return await Promise.all(p),I.value.length>0&&await te(I.value),o}catch(o){return console.error("Error saving HIV tests:",o),!1}},ie=async()=>{if(C.value.validateForm()){Oe("Test not saved");return}if(!C.value){console.error("Form reference is not available");return}const l=C.value.getFormValues(),n=l.test.name,o=l.specimen.name,y=[{concept_id:l.test.concept_id,name:n,specimen:o,reason:"Routine",specimenConcept:await D.getConceptID(o,!0)}];await te(y),v()},te=async l=>{var y,p,k,e,s,a;const n=await ne.buildLabOrders("",l),o=JSON.parse(JSON.stringify(L.value));(k=(p=(y=o.labOrders)!=null?y:o.labOrders={}).unsaved)!=null||(p.unsaved=[]),(a=(s=(e=o.labOrders)!=null?e:o.labOrders={}).saved)!=null||(s.saved=[]),o.labOrders.unsaved.push(...n),await ve(o),F.value=[...o.labOrders.saved,...o.labOrders.unsaved]};return De(async()=>{H.value=await z()}),(l,n)=>{const o=S("ion-icon"),y=S("ion-footer");return u(),V(oe,null,[c(R(ke),{style:{display:"flex","justify-content":"space-between"}},{default:d(()=>[T()?B("",!0):(u(),O(R(pe),{key:0,class:"modalTitle"},{default:d(()=>[...n[5]||(n[5]=[P("Add Lab Test",-1)])]),_:1})),T()?(u(),O(R(pe),{key:1,class:"modalTitle"},{default:d(()=>[...n[6]||(n[6]=[P("Add HIV Test",-1)])]),_:1})):B("",!0),c(o,{onClick:n[0]||(n[0]=p=>v()),style:{"padding-top":"10px","padding-right":"10px"},icon:R(Q).cancel},null,8,["icon"])]),_:1}),T()?B("",!0):(u(),O(R(me),{key:0,class:"ion-padding",style:{"--background":"#fff"}},{default:d(()=>[c(we,{formData:w.value,ref_key:"formRef",ref:C},null,8,["formData"])]),_:1})),T()?(u(),O(R(me),{key:1,class:"ion-padding",style:{"--background":"#fff"}},{default:d(()=>[c(we,{formData:E.value,ref_key:"formRefHiv",ref:$},null,8,["formData"])]),_:1})):B("",!0),c(y,{collapse:"fade",class:"ion-no-border"},{default:d(()=>[T()?B("",!0):(u(),O(U,{key:0,onClick:n[1]||(n[1]=p=>ie()),name:"Save",fill:"solid",style:{float:"right",margin:"2%"}})),T()?(u(),O(U,{key:1,onClick:n[2]||(n[2]=p=>X()),name:"Send to HTS",fill:"solid",style:{float:"right",margin:"2%"}})):B("",!0),T()?(u(),O(U,{key:2,onClick:n[3]||(n[3]=p=>j()),name:"Send to Lab",fill:"solid",style:{float:"right",margin:"2%"}})):B("",!0),T()?(u(),O(U,{key:3,onClick:n[4]||(n[4]=p=>W()),color:"danger",name:"Back",fill:"solid",style:{margin:"2%"}})):B("",!0)]),_:1})],64)}}}),dt=ye(it,[["__scopeId","data-v-ad29d329"]]),ct={class:"container"},ut={class:"table-responsive"},pt=ge({__name:"LabOrdersList",props:{propOrders:{default:()=>[]},showAddTestButton:{type:Boolean,default:!0},showSendToLabButton:{type:Boolean,default:!0}},setup(h){const b=h,G=Be(),L=qe(),K=He(),Q=Ge(),f=$e(),{hasWaitingList:F}=at(),{patient:r}=be(K),{investigations:H}=be(Q),C=g(),$=g([]),I=g(["Lab Test","Specimen","Accession Number","Location","Order Date","Result","Action"]),w=g([]),E=g([]),x=g(""),v=g(!1),W=g(""),T=Ye(()=>{var e;return(e=r.value)==null?void 0:e.labOrders}),z=se,X=re(()=>{const e=[];return b.showAddTestButton&&e.push({text:" <b>+ Add other tests </b>",className:"add-test text-white",action:async()=>{await ee()}}),b.showSendToLabButton&&e.push({text:" <b>Send to Lab </b>",className:"send-lab text-white",attr:{id:"send-to-lab-btn"},action:async()=>{await ie()}}),{responsive:!0,select:!1,layout:{topStart:"buttons",topEnd:"search",bottomStart:"info",bottomEnd:"paging"},ordering:!1,buttons:e}}),j=()=>{var t;const s=((t=Xe().activeProgram)==null?void 0:t.program_id)===14&&!F("Waiting for Laboratory"),a=document.getElementById("send-to-lab-btn");a&&(s&&l.value?a.style.display="inline":a.style.display="none")},Z=async e=>{const s=[{concept_id:await D.getConceptID(e.name,!0),name:e.name,specimen:e.specimen,reason:"Routine",specimenConcept:await D.getConceptID(e.specimen,!0)}];let t=(await ne.buildLabOrders("",s))[0];if(t.order_date=t.date||Y.sessionDate(),t.specimen.name||(t.specimen.name=await D.getConceptName(t.specimen.concept_id)),t.tests&&t.tests.length>0)for(let i=0;i<t.tests.length;i++)t.tests[i].name||(t.tests[i].name=await D.getConceptName(t.tests[i].concept_id));r.value.labOrders.unsaved.push(t),await ve(r.value),await p()},ee=async()=>{await Ie(dt,{class:"lab-results-modal"},!0,{title:"name"}),await p()},ie=async()=>{await Ke("Do you want to send this patient to the lab?",{cancelBtnLabel:"Cancel",confirmBtnLabel:"Send to Lab",returnName:!0})=="Confirm"&&await te()},te=async()=>{try{const e=String(localStorage.getItem("locationID"));if(!e){le("Location not found");return}await Ne.addPatientToStage(r.value,"LAB"),await f.refresh(e),await G.push("home"),fe("The patient successfully sent to the lab. You may now attend to other patients.")}catch(e){console.error("Error sending to lab:",e),le("Failed to send patient to lab")}},l=re(()=>{const e=T.value;if(!e)return!1;const s=e.saved||[],a=e.unsaved||[],t=[...s,...a];return t.length===0?!1:t.some(i=>!(i!=null&&i.tests)||!Array.isArray(i.tests)?!1:i.tests.some(_=>!(_!=null&&_.result)||_.result.length===0))}),n=async()=>{var s,a,t,i,_;if(!((s=r.value)!=null&&s.labOrders)||(w.value=[...(t=(a=r.value)==null?void 0:a.labOrders)==null?void 0:t.saved,...(_=(i=r.value)==null?void 0:i.labOrders)==null?void 0:_.unsaved],!w.value))return;const e=await w.value.filter(m=>Y.toStandardHisFormat(Y.sessionDate())===Y.toStandardHisFormat(m.order_date));e.length>0?H.value[0].selectedData=e:H.value[0].selectedData=""},o=async(e,s)=>{var t,i,_;if(await Ze("Do you want to delete ".concat(e.tests[0].name," ?"),s)){const m=JSON.parse(JSON.stringify(r.value));m.labOrders.saved.some(N=>{var q,_e;return N.order_date===e.order_date&&((q=N==null?void 0:N.tests[0])==null?void 0:q.name)==((_e=e==null?void 0:e.tests[0])==null?void 0:_e.name)})?(m.labOrders.saved=y(m.labOrders.saved,e.tests[0].name,e.order_date),(_=(i=(t=m.labOrders)!=null?t:m.labOrders={}).voided)!=null||(i.voided=[]),m.labOrders.voided.push({orderId:e.id,reason:"Mistake entry"})):m.labOrders.unsaved=y(m.labOrders.unsaved,e.tests[0].name,e.date),await ve(m)}await p()},y=(e,s,a)=>e.filter(t=>(t.order_date===a&&(t.tests=t.tests.filter(i=>i.name!==s)),t.tests.length>0)),p=async()=>{if(!r.value.labOrders)return;w.value=[...r.value.labOrders.saved,...r.value.labOrders.unsaved];const e=k(w.value),a=(A.getProgramID()==32?[["FBS","Blood","","","","",'<button class="btn btn-outline-success btn-sm order-btn" data-id=\''.concat(JSON.stringify({name:"FBS",specimen:"Blood"}),"'>Order Test</button> ")],["HbA1c","Blood","","","","",'<button class="btn btn-outline-success btn-sm order-btn" data-id=\''.concat(JSON.stringify({name:"HbA1c",specimen:"Blood"}),"'>Order Test</button> ")],["RBS","Blood","","","","",'<button class="btn btn-outline-success btn-sm order-btn" data-id=\''.concat(JSON.stringify({name:"RBS",specimen:"Blood"}),"'>Order Test</button> ")]]:[]).filter(t=>!e.some(i=>i[0]===t[0]));$.value=[...e,...a],j(),await n(),Se.use(Ue)},k=(e,s)=>e.length>0?e.flatMap(a=>a.tests.flatMap(t=>{var ce,N,q;const i='<button class="btn btn-outline-success btn-sm result-btn" data-id=\''.concat(JSON.stringify(a),"'>Enter Result</button> "),_='<button class="btn btn-outline-secondary btn-sm view-btn" data-id=\''.concat(JSON.stringify(t),"'>").concat(z.view2,"</button> ");let m=i;((ce=t==null?void 0:t.result)==null?void 0:ce.length)==1?m=(t==null?void 0:t.result)!=null?((N=t==null?void 0:t.result[0])==null?void 0:N.value)||"":null:((q=t==null?void 0:t.result)==null?void 0:q.length)>1&&(t==null||t.result,m=_);let de="";return a!=null&&a.accession_number&&(de='<button class="btn btn-outline-secondary btn-sm" data-id=\''.concat(JSON.stringify(a),"'>").concat(z.print2,"</button>")),[[t==null?void 0:t.name,a==null?void 0:a.specimen.name,(a==null?void 0:a.accession_number)||"",(a==null?void 0:a.order_type_id)==9?"<span class='red-tag'>HTS</span>":"",Y.toStandardHisFormat(a==null?void 0:a.order_date),m,de+'\n                        <button class="btn btn-outline-danger btn-sm delete-btn" data-id=\''.concat(JSON.stringify(a),"'>").concat(z.delete2,"</button>\n                        ")]]})):[];return De(async()=>{A.getProgramID()==14&&X.value.buttons.push(),await n(),await p(),ue(()=>{const e=C.value.dt;e.columns.adjust().draw(),e.on("click",".result-btn",async s=>{const a=s.target.getAttribute("data-id");await Ie(et,{class:"lab-results-modal"},!0,{test_data:JSON.parse(a)})}),e.on("click",".view-btn",s=>{const a=s.target.getAttribute("data-id");x.value=JSON.parse(a),v.value=!0}),e.on("click",".delete-btn",s=>{const a=s.target.getAttribute("data-id");o(JSON.parse(a),s)}),e.on("click",".order-btn",s=>{const a=s.target.getAttribute("data-id");Z(JSON.parse(a))})}),w.value=b.propOrders,W.value=new Qe(r.value.patientID),E.value=await A.getUserRoles()}),M(()=>L,async()=>{await p()},{deep:!0,immediate:!0}),M(()=>r,async()=>{await p()},{deep:!0,immediate:!0}),M(()=>{var e,s,a,t;return[(s=(e=r.value)==null?void 0:e.labOrders)==null?void 0:s.saved,(t=(a=r.value)==null?void 0:a.labOrders)==null?void 0:t.unsaved]},()=>{ue(()=>{j()})},{deep:!0,immediate:!0}),M(l,e=>{console.log("hasTestsWithoutResults changed:",e),ue(()=>{j()})},{deep:!0,immediate:!0}),(e,s)=>(u(),V("div",ct,[J("div",ut,[c(R(Se),{ref_key:"dataTable",ref:C,options:X.value,data:$.value,class:"display nowrap modern-table",width:"100%"},{default:d(()=>[J("thead",null,[J("tr",null,[(u(!0),V(oe,null,Le(I.value,a=>(u(),V("th",{key:a},ae(a),1))),128))])])]),_:1},8,["options","data"])]),c(lt,{popoverOpen:v.value,content:x.value,onCloseModal:s[0]||(s[0]=a=>v.value=!1)},null,8,["popoverOpen","content"])]))}}),ht=ye(pt,[["__scopeId","data-v-978dcb74"]]);export{ht as default};
