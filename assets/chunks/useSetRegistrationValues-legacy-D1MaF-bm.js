!function(){function e(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["../index-legacy-Cux3rgIH.js","./useLocation-legacy-DN0f-JsQ.js","./vendor-legacy-yRrh2kya.js","./vaccines_service-legacy-B4Ep1GsK.js"],function(t,n){"use strict";var i,a,o,l,r,d,u,s,c,m,v,p,h,_,y,g,f,b,D,I,w,F,T,S,k,P,x,V,R,C,N,B,L,A,H,E,M,O,Y,q,$,j,U,W,G,z,J,K,Q,Z,X,ee,te;return{setters:[e=>{i=e.n,a=e.D,o=e._,l=e.x,r=e.y,d=e.z,u=e.H,s=e.S,c=e.g,m=e.K,v=e.a7,p=e.o,h=e.P,_=e.u,y=e.J,g=e.b,f=e.w,b=e.I,D=e.F,I=e.aL,w=e.a9},e=>{F=e.u},e=>{T=e.d,S=e.N,k=e.L,P=e.a6,x=e.ah,V=e.ad,R=e.dt,C=e.ac,N=e.e1,B=e.a2,L=e.R,A=e.H,H=e.e,E=e.f,M=e.m,O=e.l,Y=e.k,q=e.J,$=e.Q,j=e.F,U=e.r,W=e.c,G=e.O,z=e.u,J=e.K,K=e.P,Q=e.z,Z=e.b2,X=e.a,ee=e.bx},e=>{te=e.g}],execute:function(){var n=document.createElement("style");n.textContent=".large-card[data-v-ffb46cdd]{padding:5%;border-radius:15px;border:1px solid #ccc;height:82vh;background-color:#fff;overflow-y:auto;-webkit-box-shadow:0px -2px 19px -2px rgba(196,190,196,1);-moz-box-shadow:0px -2px 19px -2px rgba(196,190,196,1);box-shadow:0 -2px 19px -2px #c4bec4}.header[data-v-ffb46cdd]{display:flex;gap:20px;padding:10px 20px}.position_content[data-v-ffb46cdd]{max-width:100vw}.accordion-expanded[data-v-ffb46cdd]{background-color:#ded}button[aria-expanded=false][data-v-ffb46cdd]{background:rgba(var(--ion-color-rose-rgb),.25)}ion-accordion.accordion-expanding ion-item[slot=header][data-v-ffb46cdd],ion-accordion.accordion-expanded ion-item[slot=header][data-v-ffb46cdd]{--background: #ddeedd}\n/*$vite$:1*/",document.head.appendChild(n),t({a:function(){const e=_(),{patient:t}=Z(e),n=e=>{var n,i;const a=null==t||null===(n=t.value)||void 0===n||null===(n=n.guardianInformation)||void 0===n?void 0:n.saved[0],o=null!=a&&null!==(i=a.relationship_type)&&void 0!==i&&i.b_is_to_a?{name:a.relationship_type.b_is_to_a,id:a.relationship_type.relationship_type_id,trackByID:a.relationship_type.relationship_type_id+a.relationship_type.b_is_to_a}:"";null==e||e.setFormValue("guardianNationalID",(null==a?void 0:a.national_id)||""),null==e||e.setFormValue("guardianFirstname",(null==a?void 0:a.given_name)||""),null==e||e.setFormValue("guardianMiddleName",(null==a?void 0:a.middle_name)||""),null==e||e.setFormValue("guardianLastname",(null==a?void 0:a.family_name)||""),null==e||e.setFormValue("guardianPhoneNumber",null!=a&&a.cell_phone_number?null==a?void 0:a.cell_phone_number:""),null==e||e.setFormValue("relationship",o||"")};return{setFormValues:e=>{var i,a;const{personalInformationRef:o,socialHistoryRef:l,countryRef:r,currentLocationRef:d,homeLocationRef:s,guardianInformationRef:c}=e.value,m=null==t||null===(i=t.value)||void 0===i?void 0:i.personInformation;null==o||o.setFormValue("nationalID",null==t||null===(a=t.value)||void 0===a||null===(a=a.otherPersonInformation)||void 0===a?void 0:a.nationalID),null==o||o.setFormValue("firstname",null==m?void 0:m.given_name),null==o||o.setFormValue("middleName",null==m?void 0:m.middle_name),null==o||o.setFormValue("lastname",null==m?void 0:m.family_name),null==o||o.setFormValue("gender",null==m?void 0:m.gender),null==o||o.setFormValue("birthdate",null!=m&&m.birthdate?u.toStandardHisDisplayFormat(null==m?void 0:m.birthdate):""),null==o||o.setFormValue("Phone Number",null!=m&&m.cell_phone_number?null==m?void 0:m.cell_phone_number:""),null==s||s.setFormValue("home_district",{name:null==m?void 0:m.home_district}),null==s||s.setFormValue("home_traditional_authority",{name:null==m?void 0:m.home_traditional_authority}),null==s||s.setFormValue("home_village",{name:null==m?void 0:m.home_village}),null==d||d.setFormValue("current_district",{name:null==m?void 0:m.current_district}),null==d||d.setFormValue("current_traditional_authority",{name:null==m?void 0:m.current_traditional_authority}),null==d||d.setFormValue("current_village",{name:null==m?void 0:m.current_village}),null==d||d.setFormValue("closestLandmark",{name:null==m?void 0:m.landmark}),null==r||r.setFormValue("country",null!=m&&m.country?{name:null==m?void 0:m.country}:{name:"Malawi"}),null==l||l.setFormValue("religion",{name:null==m?void 0:m.religion}),null==l||l.setFormValue("occupation",null==m?void 0:m.occupation),null==l||l.setFormValue("maritalStatus",null==m?void 0:m.marital_status),null==l||l.setFormValue("highestLevelOfEducation",null==m?void 0:m.education_level),n(c)},setGuardianInformation:n}},u:function(){const e=U(1),t=U(4),n=_(),{patient:i}=Z(n),a=W(()=>0===t.value?4:Math.ceil(4/t.value)),o=W(()=>a.value>1),l=W(()=>o.value&&e.value>1),r=W(()=>o.value&&e.value<a.value),d=()=>{t.value=(()=>{const e=window.innerWidth;return e>=992?4:e>=768?3:e>=576?2:1})(),e.value>a.value&&(e.value=a.value),0===e.value&&a.value>0&&(e.value=1)};return X(()=>{window.addEventListener("resize",d),d()}),ee(()=>{window.removeEventListener("resize",d)}),{currentPage:e,columnsPerRow:t,totalPages:a,showPaginationButtons:o,showPreviousButton:l,showNextButton:r,nextPage:()=>{e.value<a.value&&e.value++},prevPage:()=>{e.value>1&&e.value--},goToPage:t=>{t>=1&&t<=a.value&&(e.value=t)},handleResize:d,isCardVisible:n=>{if(1===a.value)return!0;const i=(e.value-1)*t.value,o=i+t.value-1;return n>=i&&n<=o}}}});const ne=T({components:{IonLabel:B,IonAvatar:N,IonRow:C,IonImg:R,IonCol:V,IonList:x,IonItem:P,IonIcon:k,IonButton:S,DynamicButton:a},data:()=>({selectedResult:{},iconsContent:i,isAnyAccordionOpen:!0,isLoading:!1}),methods:{dismiss(e){L.dismiss(e)}}}),ie={key:0,class:"spinner-overlay"};const ae=t("C",o(ne,[["render",function(e,t,n,i,a,o){const l=A("ion-spinner"),r=A("ion-title"),d=A("ion-icon"),u=A("ion-header"),s=A("center"),c=A("ion-content"),m=A("DynamicButton"),v=A("ion-col"),p=A("ion-row"),h=A("ion-footer");return E(),H(j,null,[e.isLoading?(E(),H("div",ie,[O(l,{name:"bubbles"}),t[3]||(t[3]=Y("div",{class:"loading-text"},"Please wait...",-1))])):M("",!0),O(u,{style:{display:"flex","justify-content":"space-between"}},{default:q(()=>[O(r,{class:"modalTitle"},{default:q(()=>[...t[4]||(t[4]=[$("Printer",-1)])]),_:1}),O(d,{onClick:t[0]||(t[0]=t=>e.dismiss("dismiss")),style:{"padding-top":"10px","padding-right":"10px"},icon:e.iconsContent.cancel},null,8,["icon"])]),_:1}),O(c,{fullscreen:!0,class:"ion-padding",style:{"--background":"#fff"}},{default:q(()=>[O(s,null,{default:q(()=>[...t[5]||(t[5]=[Y("h3",{class:"ion-padding"},"Do you want to print a barcode?",-1)])]),_:1})]),_:1}),O(h,null,{default:q(()=>[O(p,null,{default:q(()=>[O(v,null,{default:q(()=>[O(m,{color:"danger",onClick:t[1]||(t[1]=t=>e.dismiss("dismiss")),name:"No",fill:"solid",style:{float:"right","margin-right":"2%",width:"100px"}}),O(m,{onClick:t[2]||(t[2]=t=>e.dismiss("Yes")),name:"Yes",fill:"solid",style:{float:"right","margin-right":"2%",width:"100px"}})]),_:1})]),_:1})]),_:1})],64)}]])),oe=(t("e",T({__name:"CurrentLocation",setup(e,{expose:t}){const{formRef:n,exposeFormMethods:a}=r(),{currentLocation:o}=(e=>{const t=U(!1),{getDistricts:n,districtList:a,selectedTraditionalAuthorityId:o,villages:r,selectedDistrictId:d,TAs:u}=F();return n(),{currentLocation:W(()=>[{componentType:"Heading",name:"Current Location",position:"center"},{componentType:"multiSelectInputField",header:"Current district",name:"current_district",trackBy:"district_id",validation:e=>l.required(e),icon:i.search,options:a.value,onChange:(t,n)=>{null!=e&&e.value&&(e.value.setFormValue("current_traditional_authority",[]),e.value.setFormValue("current_village",[])),d.value=(null==t?void 0:t.district_id)||null}},{componentType:"multiSelectInputField",header:"Current traditional authority",name:"current_traditional_authority",trackBy:"traditional_authority_id",validation:e=>l.required(e),icon:i.search,options:u.value,disabled:e=>{var t;return!(null!=u&&null!==(t=u.value)&&void 0!==t&&t.length)},onChange:(t,n)=>{var i;null!=e&&e.value&&(null==e||null===(i=e.value)||void 0===i||i.setFormValue("current_village",[])),o.value=(null==t?void 0:t.traditional_authority_id)||null}},{componentType:"multiSelectInputField",header:"Current village",name:"current_village",trackBy:"village_id",icon:i.search,validation:e=>l.required(e),options:r.value,disabled:e=>{var t;return!(null!=r&&null!==(t=r.value)&&void 0!==t&&t.length)}},{componentType:"multiSelectInputField",header:"Closest landmark/Plot number",name:"closestLandmark",trackBy:"id",icon:i.search,options:[{id:1,name:"Church"},{id:2,name:"Mosque"},{id:3,name:"Primary School"},{id:4,name:"Borehole"},{id:5,name:"Secondary School"},{id:6,name:"College"},{id:7,name:"Market"},{id:8,name:"Football Ground"},{id:9,name:"Other"}]}]),TAs:u,isLoadingTAs:t,selectedDistrictId:d}})(n);return t(a()),(e,t)=>(E(),G(d,{formData:z(o),ref_key:"formRef",ref:n},null,8,["formData"]))}})),(e,t)=>(null==e||!e.same_as_current)&&!(null!=t&&t.length)),le=(e,t)=>n=>{setTimeout(()=>{n?((e,t)=>{if(null==e||!e.value||null==t||!t.value)return;const{current_district:n,current_traditional_authority:i,current_village:a}=e.value;t.value.setFormValue("home_district",n),t.value.setFormValue("home_traditional_authority",i),t.value.setFormValue("home_village",a)})(e,t):(e=>{null!=e&&e.value&&(e.value.setFormValue("home_district",[]),e.value.setFormValue("home_traditional_authority",[]),e.value.setFormValue("home_village",[]))})(t)},0)},re=(t("f",T({__name:"HomeLocation",props:{currentLocationFormValues:{}},setup(e,{expose:t}){const n=e,{formRef:a,exposeFormMethods:o}=r(),u=W(()=>n.currentLocationFormValues),{homeLocation:s}=((e,t)=>{const{getDistricts:n,districtList:a,selectedTraditionalAuthorityId:o,villages:r,selectedDistrictId:d,TAs:u}=F();n();const s=W(()=>[{componentType:"Heading",name:"Home Location",position:"center"},{componentType:"checkboxField",type:"single",name:"same_as_current",label:"Same as current",onChange:le(e,t)},{componentType:"multiSelectInputField",header:"Home district",name:"home_district",trackBy:"district_id",icon:i.search,validation:l.required,options:a.value,onChange:e=>((e,t,n)=>{t.value=(null==e?void 0:e.district_id)||null,null!=n&&n.value&&(n.value.setFormValue("home_traditional_authority",[]),n.value.setFormValue("home_village",[]))})(e,d,t)},{componentType:"multiSelectInputField",header:"Home traditional authority",name:"home_traditional_authority",trackBy:"traditional_authority_id",validation:l.required,icon:i.search,options:u.value,disabled:e=>oe(e,u.value),onChange:e=>((e,t,n)=>{var i;t.value=(null==e?void 0:e.traditional_authority_id)||null,null==n||null===(i=n.value)||void 0===i||i.setFormValue("home_village",[])})(e,o,t),openDirection:"auto"},{componentType:"multiSelectInputField",header:"Home village",name:"home_village",trackBy:"village_id",icon:i.search,validation:l.required,options:r.value,disabled:e=>oe(e,r.value),openDirection:"auto"}]);return{homeLocation:s}})(u,a);return t(o()),(e,t)=>(E(),G(d,{formData:z(s),ref_key:"formRef",ref:a},null,8,["formData"]))}})),t("d",T({__name:"Country",setup(e,{expose:t}){const{country:n}=(()=>{const{countriesList:e,getCountries:t}=F();return t(),{country:W(()=>[{componentType:"Heading",name:"Country",position:"center"},{componentType:"multiSelectInputField",header:"Country",name:"country",trackBy:"district_id",openDirection:"auto",icon:i.search,validation:e=>l.required(e),options:e.value}])}})(),{formRef:a,exposeFormMethods:o}=r();return t(o()),(e,t)=>(E(),G(d,{formData:z(n),ref_key:"formRef",ref:a},null,8,["formData"]))}})),t("_",T({__name:"PersonalInformation",setup(e,{expose:t}){const{personalInformation:n}=(()=>{function e(e,t){const n=new Date(e);return n.setFullYear(n.getFullYear()-t),n.toISOString().split("T")[0]}return{personalInformation:W(()=>[{componentType:"Heading",name:"Personal Information",position:"center"},{componentType:"inputField",header:"National ID",name:"nationalID",placeholder:"__-__-__-__",icon:i.nationalID,validation:e=>l.isMWNationalID(e)},{componentType:"inputField",header:"First name",name:"firstname",icon:i.fullName,validation:e=>l.isName(e)},{componentType:"inputField",header:"Middle name",name:"middleName",icon:i.fullName,validation:e=>l.isNamesEmpty(e)},{componentType:"inputField",header:"Last name",name:"lastname",icon:i.fullName,validation:e=>l.isName(e)},{componentType:"radioButtonField",header:"Gender",name:"gender",type:"inline",validation:e=>l.required(e),options:[{label:"Male",value:"M"},{label:"Female",value:"F"},{label:"Undetermined",value:"Undetermined"}]},{componentType:"dateInputField",header:"Date of birth",name:"birthdate",icon:i.calenderPrimary,minDate:e(u.sessionDate(),110),validation:e=>l.required(e),condition:e=>!e.Estimate,disabled:e=>e.Estimate},{componentType:"inputField",header:"Estimated age",name:"estimation",icon:i.time,validation:e=>l.isEstimationDate(e),initialUnit:"Years",unitOptions:[{label:"Days",value:"Days"},{label:"Weeks",value:"Weeks"},{label:"Months",value:"Months"},{label:"Years",value:"Years"}],unitValidation:e=>e&&""!==e?null:"Please select a unit.",condition:e=>e.Estimate},{componentType:"checkboxField",name:"Estimate",type:"single",label:"Estimate age"},{componentType:"phoneInputField",name:"Phone Number",header:"Phone Number",validation:e=>l.isMWPhoneNumber(e.phoneNumber)}])}})(),{formRef:a,exposeFormMethods:o}=r();return t(o()),(e,t)=>(E(),G(d,{formData:z(n),ref_key:"formRef",ref:a},null,8,["formData"]))}})),T({components:{IonLabel:B,IonAvatar:N,IonRow:C,IonImg:R,IonCol:V,IonList:x,IonItem:P,IonIcon:k,IonButton:S},data:()=>({selectedResult:{},iconsContent:i,isAnyAccordionOpen:!0,isLoading:!1}),methods:{updateAccordionState(e){const t=this.$refs.accordionGroup;this.isAnyAccordionOpen=void 0!==t.value},dismiss(e){L.dismiss(e)},async init(){this.setData(this.deduplicationData[0]||{})},async onSelect(){L.dismiss(this.selectedResult)},setData(e){this.selectedResult=e},dateFormat:e=>u.toStandardHisDisplayFormat(e),probabilityToPercentage:e=>(100*e).toFixed(2)+"%"},props:{deduplicationData:{default:[]},to_be_registered:{default:[]}},mounted(){this.init()},activated(){this.init()}})),de={key:0,class:"spinner-overlay"},ue={class:"header position_content"},se={style:{"font-size":"1.2em","font-weight":"700"}},ce={class:"due_date"},me={class:"ion-padding",slot:"content"},ve={style:{display:"flex","justify-content":"end",gap:"10px"}};const pe=o(re,[["render",function(e,t,n,i,a,o){const l=A("ion-spinner"),r=A("ion-icon"),d=A("ion-header"),u=A("ion-label"),s=A("ion-item"),c=A("ion-col"),m=A("ion-row"),v=A("ion-accordion"),p=A("ion-accordion-group"),h=A("ion-content"),_=A("ion-button"),y=A("ion-footer");return E(),H(j,null,[e.isLoading?(E(),H("div",de,[O(l,{name:"bubbles"}),t[3]||(t[3]=Y("div",{class:"loading-text"},"Please wait...",-1))])):M("",!0),O(d,null,{default:q(()=>[Y("div",ue,[Y("div",{style:{display:"flex","align-items":"center"},onClick:t[0]||(t[0]=t=>e.dismiss("back"))},[O(r,{slot:"separator",size:"large",icon:e.iconsContent.arrowLeft},null,8,["icon"])]),Y("div",se,"Matches found: ("+J(e.deduplicationData.length)+")",1)])]),_:1}),O(h,{fullscreen:!0,class:"ion-padding",style:{"--background":"#fff"}},{default:q(()=>[O(p,{ref:"accordionGroup",class:"previousView",value:"0",onIonChange:e.updateAccordionState},{default:q(()=>[(E(!0),H(j,null,K(e.deduplicationData,(n,i)=>(E(),G(v,{style:{"margin-bottom":"15px"},value:i,"toggle-icon-slot":"start",class:"custom_card",button:"",key:i,detail:!0,color:n.value===e.selectedResult.value?"light":"",onClick:t=>e.setData(n)},{default:q(()=>[O(s,{slot:"header"},{default:q(()=>[O(u,{class:"previousLabel"},{default:q(()=>{var e,t;return[$(J(null==n||null===(e=n.person)||void 0===e?void 0:e.given_name)+" "+J(null==n||null===(t=n.person)||void 0===t?void 0:t.family_name),1)]}),_:2},1024),Y("div",ce,[t[4]||(t[4]=$(" Score: ",-1)),Y("b",null,J(e.probabilityToPercentage(null==n?void 0:n.score)||"-"),1)])]),_:2},1024),Y("div",me,[O(m,null,{default:q(()=>[O(c,null,{default:q(()=>[...t[5]||(t[5]=[Y("b",null,"To be Registered",-1)])]),_:1}),O(c,null,{default:q(()=>[...t[6]||(t[6]=[Y("b",null,"Already Registered",-1)])]),_:1})]),_:1}),O(m,null,{default:q(()=>[O(c,null,{default:q(()=>[O(m,null,{default:q(()=>{var n,i;return[t[7]||(t[7]=$(" Name: ",-1)),Y("b",null,J(null===(n=e.to_be_registered)||void 0===n?void 0:n.given_name)+" "+J(null===(i=e.to_be_registered)||void 0===i?void 0:i.family_name),1)]}),_:1}),O(m,null,{default:q(()=>{var n;return[t[8]||(t[8]=$("Gender: ",-1)),Y("b",null,J(null===(n=e.to_be_registered)||void 0===n?void 0:n.gender),1)]}),_:1}),O(m,null,{default:q(()=>{var n;return[t[9]||(t[9]=$("Birthdate: ",-1)),Y("b",null,J(null===(n=e.to_be_registered)||void 0===n?void 0:n.birthdate),1)]}),_:1}),O(m,null,{default:q(()=>{var n;return[t[10]||(t[10]=$("Home District: ",-1)),Y("b",null,J(null===(n=e.to_be_registered)||void 0===n?void 0:n.home_district),1)]}),_:1}),O(m,null,{default:q(()=>{var n;return[t[11]||(t[11]=$("Home TA: ",-1)),Y("b",null,J(null===(n=e.to_be_registered)||void 0===n?void 0:n.home_traditional_authority),1)]}),_:1})]),_:1}),O(c,null,{default:q(()=>[O(m,null,{default:q(()=>{var e,i;return[t[12]||(t[12]=$(" Name: ",-1)),Y("b",null,J(null==n||null===(e=n.person)||void 0===e?void 0:e.given_name)+" "+J(null==n||null===(i=n.person)||void 0===i?void 0:i.family_name),1)]}),_:2},1024),O(m,null,{default:q(()=>{var e;return[t[13]||(t[13]=$("Gender: ",-1)),Y("b",null,J(null==n||null===(e=n.person)||void 0===e?void 0:e.gender),1)]}),_:2},1024),O(m,null,{default:q(()=>{var i;return[t[14]||(t[14]=$("Birthdate: ",-1)),Y("b",null,J(e.dateFormat(null==n||null===(i=n.person)||void 0===i?void 0:i.birthdate)),1)]}),_:2},1024),O(m,null,{default:q(()=>{var e;return[t[15]||(t[15]=$("Home District: ",-1)),Y("b",null,J(null==n||null===(e=n.person)||void 0===e?void 0:e.home_district),1)]}),_:2},1024),O(m,null,{default:q(()=>{var e;return[t[16]||(t[16]=$("Home TA: ",-1)),Y("b",null,J(null==n||null===(e=n.person)||void 0===e?void 0:e.home_traditional_authority),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)])]),_:2},1032,["value","color","onClick"]))),128))]),_:1},8,["onIonChange"])]),_:1}),O(y,{collapse:"fade",class:"ion-no-border"},{default:q(()=>[Y("div",ve,[O(_,{fill:"solid",color:"secondary",onClick:t[1]||(t[1]=t=>e.dismiss("dismiss"))},{default:q(()=>[...t[17]||(t[17]=[$(" Not Duplicate ",-1)])]),_:1}),O(_,{onClick:t[2]||(t[2]=t=>e.onSelect()),fill:"solid",disabled:!e.isAnyAccordionOpen},{default:q(()=>[...t[18]||(t[18]=[$("Select ",-1)])]),_:1},8,["disabled"])])]),_:1})],64)}],["__scopeId","data-v-ffb46cdd"]]),he=m();class _e{async getDDEIds(){const e=s.getPouchDbStatus(),t=s.getLanConnectionStatus(),n=s.getAPIStatus();if(t){const e=await this.getAndUpdateAvailableDdeId();return null!=e&&e.success?e.ddeId:void 0}if(e&&!t){var i,a;const e=await c("dde");if(null!==(i=e[0])&&void 0!==i&&i.npid)return(null===(a=e[0])||void 0===a?void 0:a.npid)||""}if(n)try{var o;const e=await s.getJson("/dde/patients/sync_npids",{count:1,program_id:s.getProgramID()});return(null==e||null===(o=e.npids[0])||void 0===o?void 0:o.npid)||""}catch(l){return""}return""}async deleteDDEId(e){he.postData({command:"deleteData",storeName:"dde",data:{npid:e}})}async possibleDuplicates(e){if(s.getAPIStatus())try{const n=new v,i=await n.checkPotentialDuplicates(e);if(i.length>0){const a=await p(pe,{class:"fullScreenModal"},!0,{to_be_registered:e,deduplicationData:i});if("dismiss"!=a&&"back"!=a){var t;const e=await n.importPatient(null==a||null===(t=a.person)||void 0===t?void 0:t.id),i=await h.findByID(e.patient_id);return await _().setPatientRecord(i),!0}return"back"==a}return!1}catch(n){return!1}return!1}async getAndUpdateAvailableDdeId(){try{const{couchdbUsername:e,couchdbPassword:t,couchdbPort:n,couchdbHost:i,couchdbProtocol:a}=s.getCouchdbConfig(),o=`${a}://${i}:${n}/dde`,l="Basic "+btoa(`${e}:${t}`),r={selector:{type:"dde_id",$or:[{status:{$exists:!1}},{status:{$ne:"used"}}]},limit:1},d=await fetch(`${o}/_find`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:l},body:JSON.stringify(r)});if(!d.ok)throw new Error(`Failed to query documents: ${d.statusText}`);const u=await d.json();if(console.log("ðŸš€ ~ DDEService ~ getAndUpdateAvailableDdeId ~ findResult:",u),!u.docs||0===u.docs.length)return{success:!1,error:"No available DDE IDs found"};const c=u.docs[0],m=c.dde_id;c.status="used",c.assignedAt=(new Date).toISOString();const v=await fetch(`${o}/${c._id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:l},body:JSON.stringify(c)});if(!v.ok)throw new Error(`Failed to update document: ${v.statusText}`);return console.log("ðŸš€ ~ DDEService ~ getAndUpdateAvailableDdeId ~ ddeId:",m),{success:!0,ddeId:m}}catch(e){return console.error("Error getting and updating DDE ID:",e),null}}}class ye{getRegion(e){return{1:"Central Region",2:"Northern Region",3:"Southern Region",4:"Foreign"}[e]}hasValidData(e,t=[]){return!(!e||"object"!=typeof e)&&(0===t.length?Object.values(e).some(e=>null!=e&&""!==e):t.every(t=>null!==e[t]&&void 0!==e[t]&&""!==e[t]))}async buildObservation(e,t){if(!t)return null;const n="object"==typeof t&&t.name?t.name:t;return await y.buildValueText(e,n)}buildGuardianInfo(e){const t={};return t.given_name=(null==e?void 0:e.guardianFirstname)||"",t.middle_name=(null==e?void 0:e.guardianMiddleName)||"",t.family_name=(null==e?void 0:e.guardianLastname)||"",t.cell_phone_number=(null==e?void 0:e.guardianPhoneNumber.phoneNumber)||"",t.national_id=(null==e?void 0:e.guardianNationalID)||"",t.gender="",t.birthdate="",t.birthdate_estimated="false",t.home_region="",t.home_district="",t.home_traditional_authority="",t.home_village="",t.current_region="",t.current_district="",t.current_traditional_authority="",t.current_village="",t.landmark="",{saved:[],unsaved:[t]}}async buildVitals(e){return null!=e&&e.Weight?{saved:[],unsaved:[await this.buildObservation("Weight",e.Weight)]}:null}async buildARTPatientType(e,t){const n=[];let i=[];return e&&n.push(await y.buildValueText("Art clinic location",e)),t&&n.push(await y.buildValueCoded("Type of patient",t)),0===n.length?[]:(i=[{encounter_type:g.REGISTRATION,status:"unsaved",obs:n}],i)}async buildBirthRegistrationObservations(e){if(!this.hasValidData(e))return null;const t=(await Promise.all([this.buildObservation("How many doses of Tdv did the mother receive?",e["How many doses of Tdv did the mother receive?"]),this.buildObservation("Protected at birth",e["Protected at birth"]),this.buildObservation("HIV status",e["HIV status"])])).filter(e=>null!==e);return t.length>0?t:null}async buildPatientRecord(e,t,n=""){var i,a,o,l,r,d,u,c,m,v,p,h,_;const{personalInformation:y,currentLocation:g,homeLocation:f,birthRegistration:b,guardianInformation:D,socialHistory:I,patientType:w}=e;return{patientID:n||t||"",ID:t||"",NcdID:"",personInformation:{given_name:(null==y?void 0:y.firstname)||"",middle_name:(null==y?void 0:y.middleName)||"",family_name:(null==y?void 0:y.lastname)||"",gender:(null==y?void 0:y.gender)||"",birthdate:null!=y&&y.Estimate?(new ge).calculateDoB(null==y?void 0:y.estimation,(null==y?void 0:y.estimation_unit)||"Years"):(null==y?void 0:y.birthdate)||"",birthdate_estimated:null!=y&&y.Estimate?"true":"false",home_region:this.getRegion(null==f||null===(i=f.home_district)||void 0===i?void 0:i.region_id)||"",home_district:(null==f||null===(a=f.home_district)||void 0===a?void 0:a.name)||"",home_traditional_authority:(null==f||null===(o=f.home_traditional_authority)||void 0===o?void 0:o.name)||"",home_village:(null==f||null===(l=f.home_village)||void 0===l?void 0:l.name)||"",current_region:this.getRegion(null==g||null===(r=g.current_district)||void 0===r?void 0:r.region_id)||"",current_district:(null==g||null===(d=g.current_district)||void 0===d?void 0:d.name)||"",current_traditional_authority:(null==g||null===(u=g.current_traditional_authority)||void 0===u?void 0:u.name)||"",current_village:(null==g||null===(c=g.current_village)||void 0===c?void 0:c.name)||"",country:(null==e?void 0:e.country.country.name)||"",landmark:(null==g||null===(m=g.closestLandmark)||void 0===m?void 0:m.name)||"",cell_phone_number:(null===(v=y["Phone Number"])||void 0===v?void 0:v.phoneNumber)||"",occupation:(null==I?void 0:I.occupation)||"",marital_status:(null==I?void 0:I.maritalStatus)||"",religion:(null==I||null===(p=I.religion)||void 0===p?void 0:p.name)||"",education_level:(null==I?void 0:I.highestLevelOfEducation)||""},guardianInformation:this.buildGuardianInfo(D),birthRegistration:await this.buildBirthRegistrationObservations(b),otherPersonInformation:{nationalID:(null==y?void 0:y.nationalID)||"",ichisID:s.getIchisId()||"",TEI:s.getTEI()||"",birthID:b["Serial Number"]||"",relationshipID:(null==D||null===(h=D.relationship)||void 0===h?void 0:h.id)||""},vitals:await this.buildVitals(b),vaccineSchedule:await te(null==y?void 0:y.gender,null==y?void 0:y.birthdate),vaccineAdministration:{orders:[],obs:[],voided:[]},observations:await this.buildARTPatientType(null==w||null===(_=w.facility)||void 0===_?void 0:_.name,null==w?void 0:w.patient_type),appointments:{saved:[],unsaved:[]},saveStatusPersonInformation:"pending",saveStatusGuardianInformation:"pending",saveStatusBirthRegistration:"pending",saveStatusVitals:"pending",date_created:"",creator:"",sync_status:"unsynced"}}}class ge extends s{constructor(){super(),e(this,"patientRecordBuilder",void 0),this.patientRecordBuilder=new ye}async saveRegistrationData(e){const t=await(new _e).getDDEIds();if(!t&&(f("DDE IDs are not available."),s.getLanConnectionStatus()||s.getPouchDbStatus()))return!1;let n=await this.patientRecordBuilder.buildPatientRecord(e,t);return 32==s.getProgramID()&&(n=await(async e=>{const t=s.getIchisDiagnosis();if(t.length<=0)return e;const n=await Promise.all(t.map(async e=>{var t;const n=(null==e||null===(t=e.value)||void 0===t||null===(t=t.match(/[\d.]+/))||void 0===t?void 0:t[0])||"",i=null==e?void 0:e.date;if("NCD_CV_D_Likelihood of Diabetes"==e.display){var a;const t=null==e||null===(a=e.id)||void 0===a?void 0:a.split("-");return await y.buildValueNumber("Unspecified Diabetes",n,null,null,i,t[1])}return"NCD_SHD_CV_Client waist circumference"==e.display?await y.buildValueNumber("Waist circumference",n,null,null,i):"NCD_SHD_CV_Client systolic blood pressure"==e.display?await y.buildValueNumber("Systolic",n,null,null,i):"NCD_SHD_CV_Client diastolic blood pressure"==e.display?await y.buildValueNumber("Diastolic",n,null,null,i):void 0}));return e.observations.push({encounter_type:"VITALS",status:"unsaved",obs:n}),e})(n)),!!(await(new _e).possibleDuplicates(n.personInformation))||!!(await b(n))&&(D("Registration successful"),sessionStorage.setItem("ichis_diagnosis",JSON.stringify([])),s.getPouchDbStatus()&&await(new _e).deleteDDEId(t),await this.printBarcode(),!0)}async updateDemographics(e){let t=await this.patientRecordBuilder.buildPatientRecord(e,s.getNationalID(),s.getPatientID());return t.saveStatusPersonInformation="edit",t.saveStatusGuardianInformation="edit",t.saveStatusBirthRegistration="edit",t.saveStatusVitals="edit",!!(await b(t))&&(D("Updated successful"),!0)}checkIfChild(e){if(!(null!=e&&e.estimation||null!=e&&e.birthdate))return{moreThanThirteenYears:!0,underNineMonths:!1,underFiveYears:!1};let t="";return t=e.estimation?this.calculateDoB(e.estimation,e.estimation_unit||"Years")||"":e.birthdate,{moreThanThirteenYears:u.getAgeInYears(t)>13,underNineMonths:u.ageInMonths(t)<9,underFiveYears:u.getAgeInYears(t)<5}}async printBarcode(){"dismiss"!==await p(ae,{class:"small-confirm-modal "})&&(new I).printData("barcode")}calculateDoB(e,t){try{let n=Q(s.getSessionDate());if("Years"===t&&e<0)n=n.add(Math.abs(e),"years");else switch(t){case"Days":n=n.subtract(e,"days");break;case"Months":n=n.subtract(e,"months");break;case"Years":n=n.subtract(e,"years");break;default:return null}return u.toStandardHisDisplayFormat(n.format("YYYY-MM-DD"))||""}catch(n){return console.error("Error calculating date:",n),null}}}t("R",ge);t("c",T({__name:"SocialHistory",setup(e,{expose:t}){const{socialHistory:n}=(()=>{const e=U();return w.isProp("military_site=true").then(t=>{e.value=t}),{socialHistory:W(()=>[{componentType:"Heading",name:"Social History",position:"center"},{componentType:"multiSelectInputField",header:"Religion",name:"religion",icon:i.search,trackBy:"id",options:[{id:1,name:"Christianity"},{id:2,name:"Islam"},{id:3,name:"Judaism"},{id:4,name:"Hinduism"},{id:5,name:"Buddhism"},{id:6,name:"Sikhism"},{id:7,name:"Jainism"},{id:8,name:"BahÃ¡'Ã­ Faith"},{id:9,name:"Zoroastrianism"},{id:10,name:"Confucianism"},{id:11,name:"Taoism"},{id:12,name:"Shinto"},{id:13,name:"Baha'i Faith"},{id:14,name:"Juche"},{id:15,name:"Rastafari"}]},{componentType:"radioButtonField",header:"Occupation status",name:"occupation",type:"inline",validation:l.required,condition:()=>1==s.getProgramID()&&e.value,options:[{label:"Military",value:"Military"},{label:"Civilian",value:"Civilian"}]},{componentType:"radioButtonField",header:"Occupation status",name:"occupation",type:"inline",condition:t=>!e,options:[{label:"Employed",value:"employed"},{label:"Student",value:"Student"},{label:"Unemployed",value:"unemployed"},{label:"Other",value:"Other"}]},{componentType:"radioButtonField",header:"Marital status",name:"maritalStatus",type:"inline",options:[{label:"Single",value:"single"},{label:"Married",value:"married"},{label:"Widow",value:"widow"},{label:"Widower",value:"widower"},{label:"Divorced",value:"divorced"}]},{componentType:"radioButtonField",header:"Highest level of education",name:"highestLevelOfEducation",type:"inline",options:[{label:"No education",value:"No education"},{label:"Primary school",value:"primary school"},{label:"Secondary school",value:"secondary school"},{label:"Tertiary education",value:"tertiary education"}]}])}})(),{formRef:a,exposeFormMethods:o}=r();return t(o()),(e,t)=>(E(),G(d,{formData:z(n),ref_key:"formRef",ref:a},null,8,["formData"]))}})),t("g",T({__name:"PatientType",setup(e,{expose:t}){const{patientType:n}=(()=>{const{facilityList:e,getFacilities:t}=F();return t(),{patientType:W(()=>[{componentType:"Heading",name:"Patient Type",position:"center"},{componentType:"radioButtonField",header:"Patient Type",name:"patient_type",type:"inline",validation:l.required,options:[{label:"New patient",value:"New patient"},{label:"Emergency supply",value:"Emergency supply"},{label:"External consultation",value:"External consultation"}]},{componentType:"multiSelectInputField",header:"Facility",name:"facility",trackBy:"facility_id",openDirection:"auto",icon:i.search,validation:e=>l.required(e),options:e.value.facilities||e.value,condition:e=>"Emergency supply"==(null==e?void 0:e.patient_type)||"External consultation"==(null==e?void 0:e.patient_type)}])}})(),{formRef:a,exposeFormMethods:o}=r();return t(o()),(e,t)=>(E(),G(d,{formData:z(n),ref_key:"formRef",ref:a},null,8,["formData"]))}})),t("b",T({__name:"BirthRegistration",setup(e,{expose:t}){const{formRef:n,exposeFormMethods:a}=r(),{birthRegistration:o}=(e=>({birthRegistration:W(()=>[{componentType:"Heading",name:"Birth Registration",position:"center"},{componentType:"inputField",header:"Birth certificate number",name:"Serial Number",icon:i.nationalID,placeholder:"__-__-__-__"},{componentType:"inputField",header:"Birth Weight/First weight (kg)",name:"Weight",icon:i.weight,validation:e=>l.validateWeight(e)},{componentType:"multiSelectInputField",header:"How many doses of Tdv did the mother receive?",name:"How many doses of Tdv did the mother receive?",icon:i.search,options:[{concept_id:11997,name:"0-2 doses, less than two weeks before delivery"},{concept_id:11998,name:"2-5 doses more than two weeks of delivery"},{concept_id:1067,name:"Unknown"}],trackBy:"concept_id",validation:e=>l.required(e),onChange:t=>{const n=null==t?void 0:t.name;"Unknown"==n?e.value.setFormValue("Protected at birth",{concept_id:1067,name:"Don't know"}):"0-2 doses, less than two weeks before delivery"==n?e.value.setFormValue("Protected at birth",{concept_id:1066,name:"No"}):"2-5 doses more than two weeks of delivery"==n&&e.value.setFormValue("Protected at birth",{concept_id:1065,name:"Yes"})}},{componentType:"multiSelectInputField",header:"Protected at birth (PAB)",name:"Protected at birth",icon:i.search,trackBy:"concept_id",validation:e=>l.required(e),disabled:e=>!e["How many doses of Tdv did the mother receive?"]},{componentType:"multiSelectInputField",header:"HIV status of the Child's Mother",name:"HIV status",icon:i.search,options:[{id:703,name:"Positive"},{id:664,name:"Negative"},{id:1067,name:"Unknown"}],trackBy:"id",validation:e=>l.required(e)}])}))(n);return t(a()),(e,t)=>(E(),G(d,{formData:z(o),ref_key:"formRef",ref:n},null,8,["formData"]))}}))}}})}();
