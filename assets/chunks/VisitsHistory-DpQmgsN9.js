import{d as Q,aW as j,cp as X,r as m,c as _,w as O,a as Y,H as z,e as v,f as r,l as h,J as p,k as l,F as B,P as H,O as g,m as L,Q as Z,K as b,p as G,u as ee,b7 as te}from"./vendor-9T3c-tPq.js";import{u as ae,b3 as ne,J as k,H as se,s as F,cG as oe,E as le,G as re,aT as R,_ as ie}from"../index-fcpPQh40.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-qlDaiiMc.js";const ue={class:"visitContent"},ce={class:"visitData"},de={class:"table-header"},ve={class:"encounter-title"},me={class:"table-responsive"},pe={key:0,class:"loading-state"},fe={key:1,class:"empty-state"},_e=Q({__name:"VisitsHistory",setup(he){const A=ae(),{patient:x}=j(A),I=X(),y=m([]),c=m(""),n=m(null),d=m([]),w=m(!1),S=e=>{const t={...e};return e.child&&!e.children?t.children=e.child:e.children||(t.children=[]),t.children&&t.children.length>0&&(t.children=t.children.map(a=>S(a))),t},D=_(()=>{const e=new Set;return y.value.forEach(t=>{t.obs.forEach(a=>{if(a.obs_datetime){const o=a.obs_datetime.split(" ")[0];e.add(o)}})}),Array.from(e).sort((t,a)=>new Date(a).getTime()-new Date(t).getTime())}),C=_(()=>{if(!c.value)return[];const e=new Map;return y.value.forEach(t=>{const a=t.status||"saved";t.obs.forEach(o=>{if(o.obs_datetime&&o.obs_datetime.startsWith(c.value)){const s=o.encounter_id||"unsaved-".concat(t.encounter_type,"-").concat(c.value),i=o.encounter_datetime||o.obs_datetime;e.has(s)||e.set(s,{encounter_id:s,encounter_type:t.encounter_type,name:J(t.encounter_type),encounter_datetime:i,status:a,observations:[]});const u=S(o);e.get(s).observations.push(u)}})}),Array.from(e.values()).sort((t,a)=>new Date(a.encounter_datetime).getTime()-new Date(t.encounter_datetime).getTime())}),M=_(()=>({paging:!0,lengthChange:!1,searching:!1,ordering:!1,info:!0,autoWidth:!0,responsive:!0,pageLength:8})),W=_(()=>[{data:"observation",title:"Observation"},{data:"value",title:"Value"},{data:"date",title:"Date"},{data:"status",title:"Status",render:e=>{const t=e==="saved"?"status-saved":"status-unsaved";return'<span class="status-pill '.concat(t,'">').concat(e,"</span>")}}]),J=e=>{const t=ne[e];return t?t.toLowerCase().replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()):"Unknown Encounter"},E=e=>se.toStandardHisDisplayFormat(e),$=e=>{c.value=e,n.value=null,d.value=[],C.value.length>0&&T(C.value[0])},T=e=>{n.value=e,q()},V=async(e,t,a,o)=>{const s="  ".repeat(t),i=t>0?"└─ ":"";if(a.push({observation:"".concat(s).concat(i).concat(e.concept_name||await U(e.concept_id)),value:await K(e),date:E(e.obs_datetime),status:o}),e.children&&e.children.length>0)for(const u of e.children)await V(u,t+1,a,o)},U=async e=>{try{return await R.getConceptName(e)}catch(t){return console.error("Error fetching concept name for ID ".concat(e,":"),t),"Concept ".concat(e)}},q=async()=>{if(!n.value){d.value=[];return}w.value=!0;try{const e=n.value.observations||[],t=n.value.status||"saved",a=[];for(const o of e)await V(o,0,a,t);d.value=a}catch(e){console.error("Error loading table data:",e),d.value=[]}finally{w.value=!1}},K=async e=>e.value_text?e.value_text:e.value_numeric!==null&&e.value_numeric!==void 0?String(e.value_numeric):e.value_datetime?E(e.value_datetime):e.value_coded?await R.getConceptName(e.value_coded):"N/A",P=async()=>{if(n.value){if(n.value.status!=="saved"){F("Cannot void unsaved encounters",2e3);return}oe(async e=>{try{await le.voidEncounter(n.value.encounter_id,e),await f(),re("Encounter has been voided!",2e3)}catch(t){F("".concat(t),32e3)}})}},f=async()=>{y.value=x.value.observations||[],D.value.length>0&&$(D.value[0])};return O(x,async()=>{await f()},{deep:!0}),O(I,async()=>{await f()},{deep:!0}),Y(async()=>{await f()}),(e,t)=>{const a=z("ion-col"),o=z("ion-row");return r(),v("div",ue,[h(o,null,{default:p(()=>[h(a,{size:"1.6",style:{height:"62vh","overflow-y":"auto","padding-right":"0px","padding-left":"0px"}},{default:p(()=>[l("div",null,[(r(!0),v(B,null,H(D.value,(s,i)=>(r(),g(k,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:u=>$(s),key:i,name:E(s),fill:c.value!=s?"outline":"solid",color:c.value==s?"success":""},null,8,["onClick","name","fill","color"]))),128))])]),_:1}),h(a,{size:"2.5"},{default:p(()=>[l("div",null,[(r(!0),v(B,null,H(C.value,(s,i)=>{var u,N;return r(),g(k,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:ge=>T(s),key:i,name:s.name,fill:((u=n.value)==null?void 0:u.encounter_id)!=s.encounter_id?"outline":"solid",color:((N=n.value)==null?void 0:N.encounter_id)==s.encounter_id?"success":""},null,8,["onClick","name","fill","color"])}),128))])]),_:1}),h(a,{offset:"0.1",size:"7.8"},{default:p(()=>[l("div",ce,[l("div",de,[l("h3",ve,[Z(b(n.value?n.value.name:"Select an Encounter")+" ",1),n.value?(r(),v("span",{key:0,class:G(["status-badge",n.value.status])},b(n.value.status),3)):L("",!0)]),n.value&&n.value.status==="saved"?(r(),g(k,{key:0,name:"Void Encounter",fill:"solid",color:"danger",onClick:t[0]||(t[0]=s=>P())})):L("",!0)]),l("div",me,[w.value?(r(),v("div",pe,[...t[1]||(t[1]=[l("p",null,"Loading observations...",-1)])])):d.value.length===0&&n.value?(r(),v("div",fe,[l("p",null,"No observations found for "+b(n.value.name),1)])):(r(),g(ee(te),{key:2,ref:"dataTable",class:"display nowrap modern-table",width:"100%",data:d.value,columns:W.value,options:M.value},{default:p(()=>[...t[2]||(t[2]=[l("thead",null,[l("tr",null,[l("th",null,"Observation"),l("th",null,"Value"),l("th",null,"Date"),l("th",null,"Status")])],-1)])]),_:1},8,["data","columns","options"]))])])]),_:1})]),_:1})])}}}),Ee=ie(_e,[["__scopeId","data-v-de0ec097"]]);export{Ee as default};
