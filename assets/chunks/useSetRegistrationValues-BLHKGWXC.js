var me=Object.defineProperty;var _e=(i,e,t)=>e in i?me(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Q=(i,e,t)=>_e(i,typeof e!="symbol"?e+"":e,t);import{n as v,D as pe,_ as R,x as D,y as H,z as x,H as A,S as w,g as he,K as ye,a7 as ve,o as ee,P as be,u as J,J as M,b as ge,w as De,I as Z,F as X,aL as we,a9 as Fe}from"../index-DFvmUOLO.js";import{u as W}from"./useLocation-BYwNkVrK.js";import{d as E,N as te,L as ie,a6 as ne,ah as ae,ad as se,dt as oe,ac as le,e0 as re,a2 as de,R as f,H as g,e as U,f as k,m as ue,l as u,k as b,J as p,Q as T,F as z,r as L,c as V,O as $,u as O,K as S,P as Se,z as Te,b2 as ce,a as Pe,bx as Ce}from"./vendor-DXMRec6a.js";import{g as ke}from"./vaccines_service-B8ZXiDIS.js";const Ve=E({components:{IonLabel:de,IonAvatar:re,IonRow:le,IonImg:oe,IonCol:se,IonList:ae,IonItem:ne,IonIcon:ie,IonButton:te,DynamicButton:pe},data:()=>({selectedResult:{},iconsContent:v,isAnyAccordionOpen:!0,isLoading:!1}),methods:{dismiss(i){f.dismiss(i)}}}),Be={key:0,class:"spinner-overlay"};function Ne(i,e,t,a,n,s){const l=g("ion-spinner"),d=g("ion-title"),_=g("ion-icon"),r=g("ion-header"),h=g("center"),o=g("ion-content"),y=g("DynamicButton"),P=g("ion-col"),C=g("ion-row"),F=g("ion-footer");return k(),U(z,null,[i.isLoading?(k(),U("div",Be,[u(l,{name:"bubbles"}),e[3]||(e[3]=b("div",{class:"loading-text"},"Please wait...",-1))])):ue("",!0),u(r,{style:{display:"flex","justify-content":"space-between"}},{default:p(()=>[u(d,{class:"modalTitle"},{default:p(()=>[...e[4]||(e[4]=[T("Printer",-1)])]),_:1}),u(_,{onClick:e[0]||(e[0]=B=>i.dismiss("dismiss")),style:{"padding-top":"10px","padding-right":"10px"},icon:i.iconsContent.cancel},null,8,["icon"])]),_:1}),u(o,{fullscreen:!0,class:"ion-padding",style:{"--background":"#fff"}},{default:p(()=>[u(h,null,{default:p(()=>[...e[5]||(e[5]=[b("h3",{class:"ion-padding"},"Do you want to print a barcode?",-1)])]),_:1})]),_:1}),u(F,null,{default:p(()=>[u(C,null,{default:p(()=>[u(P,null,{default:p(()=>[u(y,{color:"danger",onClick:e[1]||(e[1]=B=>i.dismiss("dismiss")),name:"No",fill:"solid",style:{float:"right","margin-right":"2%",width:"100px"}}),u(y,{onClick:e[2]||(e[2]=B=>i.dismiss("Yes")),name:"Yes",fill:"solid",style:{float:"right","margin-right":"2%",width:"100px"}})]),_:1})]),_:1})]),_:1})],64)}const Ee=R(Ve,[["render",Ne]]),$e=i=>{const e=L(!1),{getDistricts:t,districtList:a,selectedTraditionalAuthorityId:n,villages:s,selectedDistrictId:l,TAs:d}=W();return t(),{currentLocation:V(()=>[{componentType:"Heading",name:"Current Location",position:"center"},{componentType:"multiSelectInputField",header:"Current district",name:"current_district",trackBy:"district_id",validation:r=>D.required(r),icon:v.search,options:a.value,onChange:(r,h)=>{i!=null&&i.value&&(i.value.setFormValue("current_traditional_authority",[]),i.value.setFormValue("current_village",[])),l.value=(r==null?void 0:r.district_id)||null}},{componentType:"multiSelectInputField",header:"Current traditional authority",name:"current_traditional_authority",trackBy:"traditional_authority_id",validation:r=>D.required(r),icon:v.search,options:d.value,disabled:r=>{var h;return!((h=d==null?void 0:d.value)!=null&&h.length)},onChange:(r,h)=>{var o;i!=null&&i.value&&((o=i==null?void 0:i.value)==null||o.setFormValue("current_village",[])),n.value=(r==null?void 0:r.traditional_authority_id)||null}},{componentType:"multiSelectInputField",header:"Current village",name:"current_village",trackBy:"village_id",icon:v.search,validation:r=>D.required(r),options:s.value,disabled:r=>{var h;return!((h=s==null?void 0:s.value)!=null&&h.length)}},{componentType:"multiSelectInputField",header:"Closest landmark/Plot number",name:"closestLandmark",trackBy:"id",icon:v.search,options:[{id:1,name:"Church"},{id:2,name:"Mosque"},{id:3,name:"Primary School"},{id:4,name:"Borehole"},{id:5,name:"Secondary School"},{id:6,name:"College"},{id:7,name:"Market"},{id:8,name:"Football Ground"},{id:9,name:"Other"}]}]),TAs:d,isLoadingTAs:e,selectedDistrictId:l}},rt=E({__name:"CurrentLocation",setup(i,{expose:e}){const{formRef:t,exposeFormMethods:a}=H(),{currentLocation:n}=$e(t);return e(a()),(s,l)=>(k(),$(x,{formData:O(n),ref_key:"formRef",ref:t},null,8,["formData"]))}}),Ae=(i,e)=>{if(!(i!=null&&i.value)||!(e!=null&&e.value))return;const{current_district:t,current_traditional_authority:a,current_village:n}=i.value;e.value.setFormValue("home_district",t),e.value.setFormValue("home_traditional_authority",a),e.value.setFormValue("home_village",n)},Me=i=>{i!=null&&i.value&&(i.value.setFormValue("home_district",[]),i.value.setFormValue("home_traditional_authority",[]),i.value.setFormValue("home_village",[]))},He=(i,e,t)=>{e.value=(i==null?void 0:i.district_id)||null,t!=null&&t.value&&(t.value.setFormValue("home_traditional_authority",[]),t.value.setFormValue("home_village",[]))},xe=(i,e,t)=>{var a;e.value=(i==null?void 0:i.traditional_authority_id)||null,(a=t==null?void 0:t.value)==null||a.setFormValue("home_village",[])},I=(i,e)=>i!=null&&i.same_as_current?!1:!(e!=null&&e.length),Oe=(i,e)=>t=>{setTimeout(()=>{t?Ae(i,e):Me(e)},0)},Ye=(i,e)=>{const{getDistricts:t,districtList:a,selectedTraditionalAuthorityId:n,villages:s,selectedDistrictId:l,TAs:d}=W();return t(),{homeLocation:V(()=>[{componentType:"Heading",name:"Home Location",position:"center"},{componentType:"checkboxField",type:"single",name:"same_as_current",label:"Same as current",onChange:Oe(i,e)},{componentType:"multiSelectInputField",header:"Home district",name:"home_district",trackBy:"district_id",icon:v.search,validation:D.required,options:a.value,onChange:r=>He(r,l,e)},{componentType:"multiSelectInputField",header:"Home traditional authority",name:"home_traditional_authority",trackBy:"traditional_authority_id",validation:D.required,icon:v.search,options:d.value,disabled:r=>I(r,d.value),onChange:r=>xe(r,n,e),openDirection:"auto"},{componentType:"multiSelectInputField",header:"Home village",name:"home_village",trackBy:"village_id",icon:v.search,validation:D.required,options:s.value,disabled:r=>I(r,s.value),openDirection:"auto"}])}},dt=E({__name:"HomeLocation",props:{currentLocationFormValues:{}},setup(i,{expose:e}){const t=i,{formRef:a,exposeFormMethods:n}=H(),s=V(()=>t.currentLocationFormValues),{homeLocation:l}=Ye(s,a);return e(n()),(d,_)=>(k(),$(x,{formData:O(l),ref_key:"formRef",ref:a},null,8,["formData"]))}}),qe=()=>{const{countriesList:i,getCountries:e}=W();return e(),{country:V(()=>[{componentType:"Heading",name:"Country",position:"center"},{componentType:"multiSelectInputField",header:"Country",name:"country",trackBy:"district_id",openDirection:"auto",icon:v.search,validation:a=>D.required(a),options:i.value}])}},ut=E({__name:"Country",setup(i,{expose:e}){const{country:t}=qe(),{formRef:a,exposeFormMethods:n}=H();return e(n()),(s,l)=>(k(),$(x,{formData:O(t),ref_key:"formRef",ref:a},null,8,["formData"]))}}),Ue=()=>{function i(t,a){const n=new Date(t);return n.setFullYear(n.getFullYear()-a),n.toISOString().split("T")[0]}return{personalInformation:V(()=>[{componentType:"Heading",name:"Personal Information",position:"center"},{componentType:"inputField",header:"National ID",name:"nationalID",placeholder:"__-__-__-__",icon:v.nationalID,validation:t=>D.isMWNationalID(t)},{componentType:"inputField",header:"First name",name:"firstname",icon:v.fullName,validation:t=>D.isName(t)},{componentType:"inputField",header:"Middle name",name:"middleName",icon:v.fullName,validation:t=>D.isNamesEmpty(t)},{componentType:"inputField",header:"Last name",name:"lastname",icon:v.fullName,validation:t=>D.isName(t)},{componentType:"radioButtonField",header:"Gender",name:"gender",type:"inline",validation:t=>D.required(t),options:[{label:"Male",value:"M"},{label:"Female",value:"F"},{label:"Undetermined",value:"Undetermined"}]},{componentType:"dateInputField",header:"Date of birth",name:"birthdate",icon:v.calenderPrimary,minDate:i(A.sessionDate(),110),validation:t=>D.required(t),condition:t=>!t.Estimate,disabled:t=>t.Estimate},{componentType:"inputField",header:"Estimated age",name:"estimation",icon:v.time,validation:t=>D.isEstimationDate(t),initialUnit:"Years",unitOptions:[{label:"Days",value:"Days"},{label:"Weeks",value:"Weeks"},{label:"Months",value:"Months"},{label:"Years",value:"Years"}],unitValidation:t=>!t||t===""?"Please select a unit.":null,condition:t=>t.Estimate},{componentType:"checkboxField",name:"Estimate",type:"single",label:"Estimate age"},{componentType:"phoneInputField",name:"Phone Number",header:"Phone Number",validation:t=>D.isMWPhoneNumber(t.phoneNumber)}])}},ct=E({__name:"PersonalInformation",setup(i,{expose:e}){const{personalInformation:t}=Ue(),{formRef:a,exposeFormMethods:n}=H();return e(n()),(s,l)=>(k(),$(x,{formData:O(t),ref_key:"formRef",ref:a},null,8,["formData"]))}}),Le=E({components:{IonLabel:de,IonAvatar:re,IonRow:le,IonImg:oe,IonCol:se,IonList:ae,IonItem:ne,IonIcon:ie,IonButton:te},data:()=>({selectedResult:{},iconsContent:v,isAnyAccordionOpen:!0,isLoading:!1}),methods:{updateAccordionState(i){const e=this.$refs.accordionGroup;this.isAnyAccordionOpen=e.value!==void 0},dismiss(i){f.dismiss(i)},async init(){this.setData(this.deduplicationData[0]||{})},async onSelect(){f.dismiss(this.selectedResult)},setData(i){this.selectedResult=i},dateFormat(i){return A.toStandardHisDisplayFormat(i)},probabilityToPercentage(i){return(i*100).toFixed(2)+"%"}},props:{deduplicationData:{default:[]},to_be_registered:{default:[]}},mounted(){this.init()},activated(){this.init()}}),We={key:0,class:"spinner-overlay"},Ge={class:"header position_content"},fe={style:{"font-size":"1.2em","font-weight":"700"}},ze={class:"due_date"},Je={class:"ion-padding",slot:"content"},je={style:{display:"flex","justify-content":"end",gap:"10px"}};function Ke(i,e,t,a,n,s){const l=g("ion-spinner"),d=g("ion-icon"),_=g("ion-header"),r=g("ion-label"),h=g("ion-item"),o=g("ion-col"),y=g("ion-row"),P=g("ion-accordion"),C=g("ion-accordion-group"),F=g("ion-content"),B=g("ion-button"),Y=g("ion-footer");return k(),U(z,null,[i.isLoading?(k(),U("div",We,[u(l,{name:"bubbles"}),e[3]||(e[3]=b("div",{class:"loading-text"},"Please wait...",-1))])):ue("",!0),u(_,null,{default:p(()=>[b("div",Ge,[b("div",{style:{display:"flex","align-items":"center"},onClick:e[0]||(e[0]=m=>i.dismiss("back"))},[u(d,{slot:"separator",size:"large",icon:i.iconsContent.arrowLeft},null,8,["icon"])]),b("div",fe,"Matches found: ("+S(i.deduplicationData.length)+")",1)])]),_:1}),u(F,{fullscreen:!0,class:"ion-padding",style:{"--background":"#fff"}},{default:p(()=>[u(C,{ref:"accordionGroup",class:"previousView",value:"0",onIonChange:i.updateAccordionState},{default:p(()=>[(k(!0),U(z,null,Se(i.deduplicationData,(m,q)=>(k(),$(P,{style:{"margin-bottom":"15px"},value:q,"toggle-icon-slot":"start",class:"custom_card",button:"",key:q,detail:!0,color:m.value===i.selectedResult.value?"light":"",onClick:c=>i.setData(m)},{default:p(()=>[u(h,{slot:"header"},{default:p(()=>[u(r,{class:"previousLabel"},{default:p(()=>{var c,N;return[T(S((c=m==null?void 0:m.person)==null?void 0:c.given_name)+" "+S((N=m==null?void 0:m.person)==null?void 0:N.family_name),1)]}),_:2},1024),b("div",ze,[e[4]||(e[4]=T(" Score: ",-1)),b("b",null,S(i.probabilityToPercentage(m==null?void 0:m.score)||"-"),1)])]),_:2},1024),b("div",Je,[u(y,null,{default:p(()=>[u(o,null,{default:p(()=>[...e[5]||(e[5]=[b("b",null,"To be Registered",-1)])]),_:1}),u(o,null,{default:p(()=>[...e[6]||(e[6]=[b("b",null,"Already Registered",-1)])]),_:1})]),_:1}),u(y,null,{default:p(()=>[u(o,null,{default:p(()=>[u(y,null,{default:p(()=>{var c,N;return[e[7]||(e[7]=T(" Name: ",-1)),b("b",null,S((c=i.to_be_registered)==null?void 0:c.given_name)+" "+S((N=i.to_be_registered)==null?void 0:N.family_name),1)]}),_:1}),u(y,null,{default:p(()=>{var c;return[e[8]||(e[8]=T("Gender: ",-1)),b("b",null,S((c=i.to_be_registered)==null?void 0:c.gender),1)]}),_:1}),u(y,null,{default:p(()=>{var c;return[e[9]||(e[9]=T("Birthdate: ",-1)),b("b",null,S((c=i.to_be_registered)==null?void 0:c.birthdate),1)]}),_:1}),u(y,null,{default:p(()=>{var c;return[e[10]||(e[10]=T("Home District: ",-1)),b("b",null,S((c=i.to_be_registered)==null?void 0:c.home_district),1)]}),_:1}),u(y,null,{default:p(()=>{var c;return[e[11]||(e[11]=T("Home TA: ",-1)),b("b",null,S((c=i.to_be_registered)==null?void 0:c.home_traditional_authority),1)]}),_:1})]),_:1}),u(o,null,{default:p(()=>[u(y,null,{default:p(()=>{var c,N;return[e[12]||(e[12]=T(" Name: ",-1)),b("b",null,S((c=m==null?void 0:m.person)==null?void 0:c.given_name)+" "+S((N=m==null?void 0:m.person)==null?void 0:N.family_name),1)]}),_:2},1024),u(y,null,{default:p(()=>{var c;return[e[13]||(e[13]=T("Gender: ",-1)),b("b",null,S((c=m==null?void 0:m.person)==null?void 0:c.gender),1)]}),_:2},1024),u(y,null,{default:p(()=>{var c;return[e[14]||(e[14]=T("Birthdate: ",-1)),b("b",null,S(i.dateFormat((c=m==null?void 0:m.person)==null?void 0:c.birthdate)),1)]}),_:2},1024),u(y,null,{default:p(()=>{var c;return[e[15]||(e[15]=T("Home District: ",-1)),b("b",null,S((c=m==null?void 0:m.person)==null?void 0:c.home_district),1)]}),_:2},1024),u(y,null,{default:p(()=>{var c;return[e[16]||(e[16]=T("Home TA: ",-1)),b("b",null,S((c=m==null?void 0:m.person)==null?void 0:c.home_traditional_authority),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)])]),_:2},1032,["value","color","onClick"]))),128))]),_:1},8,["onIonChange"])]),_:1}),u(Y,{collapse:"fade",class:"ion-no-border"},{default:p(()=>[b("div",je,[u(B,{fill:"solid",color:"secondary",onClick:e[1]||(e[1]=m=>i.dismiss("dismiss"))},{default:p(()=>[...e[17]||(e[17]=[T(" Not Duplicate ",-1)])]),_:1}),u(B,{onClick:e[2]||(e[2]=m=>i.onSelect()),fill:"solid",disabled:!i.isAnyAccordionOpen},{default:p(()=>[...e[18]||(e[18]=[T("Select ",-1)])]),_:1},8,["disabled"])])]),_:1})],64)}const Qe=R(Le,[["render",Ke],["__scopeId","data-v-ffb46cdd"]]),Ze=ye();class G{async getDDEIds(){var n,s,l;const e=w.getPouchDbStatus(),t=w.getLanConnectionStatus(),a=w.getAPIStatus();if(t){const d=await this.getAndUpdateAvailableDdeId();return d!=null&&d.success?d.ddeId:void 0}if(e&&!t){const d=await he("dde");if((n=d[0])!=null&&n.npid)return((s=d[0])==null?void 0:s.npid)||""}if(a)try{const d=await w.getJson("/dde/patients/sync_npids",{count:1,program_id:w.getProgramID()});return((l=d==null?void 0:d.npids[0])==null?void 0:l.npid)||""}catch(d){return""}return""}async deleteDDEId(e){Ze.postData({command:"deleteData",storeName:"dde",data:{npid:e}})}async possibleDuplicates(e){var t;if(w.getAPIStatus())try{const a=new ve,n=await a.checkPotentialDuplicates(e);if(n.length>0){const s=await ee(Qe,{class:"fullScreenModal"},!0,{to_be_registered:e,deduplicationData:n});if(s!="dismiss"&&s!="back"){const l=await a.importPatient((t=s==null?void 0:s.person)==null?void 0:t.id),d=await be.findByID(l.patient_id);return await J().setPatientRecord(d),!0}else if(s=="back")return!0;return!1}else return!1}catch(a){return!1}return!1}async getAndUpdateAvailableDdeId(){try{const{couchdbUsername:e,couchdbPassword:t,couchdbPort:a,couchdbHost:n,couchdbProtocol:s}=w.getCouchdbConfig(),l="".concat(s,"://").concat(n,":").concat(a,"/dde"),d="Basic "+btoa("".concat(e,":").concat(t)),_={selector:{type:"dde_id",$or:[{status:{$exists:!1}},{status:{$ne:"used"}}]},limit:1},r=await fetch("".concat(l,"/_find"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:d},body:JSON.stringify(_)});if(!r.ok)throw new Error("Failed to query documents: ".concat(r.statusText));const h=await r.json();if(console.log("ðŸš€ ~ DDEService ~ getAndUpdateAvailableDdeId ~ findResult:",h),!h.docs||h.docs.length===0)return{success:!1,error:"No available DDE IDs found"};const o=h.docs[0],y=o.dde_id;o.status="used",o.assignedAt=new Date().toISOString();const P=await fetch("".concat(l,"/").concat(o._id),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:d},body:JSON.stringify(o)});if(!P.ok)throw new Error("Failed to update document: ".concat(P.statusText));return console.log("ðŸš€ ~ DDEService ~ getAndUpdateAvailableDdeId ~ ddeId:",y),{success:!0,ddeId:y}}catch(e){return console.error("Error getting and updating DDE ID:",e),null}}}class Xe{getRegion(e){return{1:"Central Region",2:"Northern Region",3:"Southern Region",4:"Foreign"}[e]}hasValidData(e,t=[]){return!e||typeof e!="object"?!1:t.length===0?Object.values(e).some(a=>a!=null&&a!==""):t.every(a=>e[a]!==null&&e[a]!==void 0&&e[a]!=="")}async buildObservation(e,t){if(!t)return null;const a=typeof t=="object"&&t.name?t.name:t;return await M.buildValueText(e,a)}buildGuardianInfo(e){const t={};return t.given_name=(e==null?void 0:e.guardianFirstname)||"",t.middle_name=(e==null?void 0:e.guardianMiddleName)||"",t.family_name=(e==null?void 0:e.guardianLastname)||"",t.cell_phone_number=(e==null?void 0:e.guardianPhoneNumber.phoneNumber)||"",t.national_id=(e==null?void 0:e.guardianNationalID)||"",t.gender="",t.birthdate="",t.birthdate_estimated="false",t.home_region="",t.home_district="",t.home_traditional_authority="",t.home_village="",t.current_region="",t.current_district="",t.current_traditional_authority="",t.current_village="",t.landmark="",{saved:[],unsaved:[t]}}async buildVitals(e){return e!=null&&e.Weight?{saved:[],unsaved:[await this.buildObservation("Weight",e.Weight)]}:null}async buildARTPatientType(e,t){const a=[];let n=[];return e&&a.push(await M.buildValueText("Art clinic location",e)),t&&a.push(await M.buildValueCoded("Type of patient",t)),a.length===0?[]:(n=[{encounter_type:ge.REGISTRATION,status:"unsaved",obs:a}],n)}async buildBirthRegistrationObservations(e){if(!this.hasValidData(e))return null;const a=(await Promise.all([this.buildObservation("How many doses of Tdv did the mother receive?",e["How many doses of Tdv did the mother receive?"]),this.buildObservation("Protected at birth",e["Protected at birth"]),this.buildObservation("HIV status",e["HIV status"])])).filter(n=>n!==null);return a.length>0?a:null}async buildPatientRecord(e,t,a=""){var o,y,P,C,F,B,Y,m,q,c,N,j,K;const{personalInformation:n,currentLocation:s,homeLocation:l,birthRegistration:d,guardianInformation:_,socialHistory:r,patientType:h}=e;return{patientID:a||t||"",ID:t||"",NcdID:"",personInformation:{given_name:(n==null?void 0:n.firstname)||"",middle_name:(n==null?void 0:n.middleName)||"",family_name:(n==null?void 0:n.lastname)||"",gender:(n==null?void 0:n.gender)||"",birthdate:n!=null&&n.Estimate?new Re().calculateDoB(n==null?void 0:n.estimation,(n==null?void 0:n.estimation_unit)||"Years"):(n==null?void 0:n.birthdate)||"",birthdate_estimated:n!=null&&n.Estimate?"true":"false",home_region:this.getRegion((o=l==null?void 0:l.home_district)==null?void 0:o.region_id)||"",home_district:((y=l==null?void 0:l.home_district)==null?void 0:y.name)||"",home_traditional_authority:((P=l==null?void 0:l.home_traditional_authority)==null?void 0:P.name)||"",home_village:((C=l==null?void 0:l.home_village)==null?void 0:C.name)||"",current_region:this.getRegion((F=s==null?void 0:s.current_district)==null?void 0:F.region_id)||"",current_district:((B=s==null?void 0:s.current_district)==null?void 0:B.name)||"",current_traditional_authority:((Y=s==null?void 0:s.current_traditional_authority)==null?void 0:Y.name)||"",current_village:((m=s==null?void 0:s.current_village)==null?void 0:m.name)||"",country:(e==null?void 0:e.country.country.name)||"",landmark:((q=s==null?void 0:s.closestLandmark)==null?void 0:q.name)||"",cell_phone_number:((c=n["Phone Number"])==null?void 0:c.phoneNumber)||"",occupation:(r==null?void 0:r.occupation)||"",marital_status:(r==null?void 0:r.maritalStatus)||"",religion:((N=r==null?void 0:r.religion)==null?void 0:N.name)||"",education_level:(r==null?void 0:r.highestLevelOfEducation)||""},guardianInformation:this.buildGuardianInfo(_),birthRegistration:await this.buildBirthRegistrationObservations(d),otherPersonInformation:{nationalID:(n==null?void 0:n.nationalID)||"",ichisID:w.getIchisId()||"",TEI:w.getTEI()||"",birthID:d["Serial Number"]||"",relationshipID:((j=_==null?void 0:_.relationship)==null?void 0:j.id)||""},vitals:await this.buildVitals(d),vaccineSchedule:await ke(n==null?void 0:n.gender,n==null?void 0:n.birthdate),vaccineAdministration:{orders:[],obs:[],voided:[]},observations:await this.buildARTPatientType((K=h==null?void 0:h.facility)==null?void 0:K.name,h==null?void 0:h.patient_type),appointments:{saved:[],unsaved:[]},saveStatusPersonInformation:"pending",saveStatusGuardianInformation:"pending",saveStatusBirthRegistration:"pending",saveStatusVitals:"pending",date_created:"",creator:"",sync_status:"unsynced"}}}const Ie=async i=>{const e=w.getIchisDiagnosis();if(e.length<=0)return i;const t=await Promise.all(e.map(async a=>{var l,d,_;const n=((d=(l=a==null?void 0:a.value)==null?void 0:l.match(/[\d.]+/))==null?void 0:d[0])||"",s=a==null?void 0:a.date;if(a.display=="NCD_CV_D_Likelihood of Diabetes"){const r=(_=a==null?void 0:a.id)==null?void 0:_.split("-");return await M.buildValueNumber("Unspecified Diabetes",n,null,null,s,r[1])}if(a.display=="NCD_SHD_CV_Client waist circumference")return await M.buildValueNumber("Waist circumference",n,null,null,s);if(a.display=="NCD_SHD_CV_Client systolic blood pressure")return await M.buildValueNumber("Systolic",n,null,null,s);if(a.display=="NCD_SHD_CV_Client diastolic blood pressure")return await M.buildValueNumber("Diastolic",n,null,null,s)}));return i.observations.push({encounter_type:"VITALS",status:"unsaved",obs:t}),i};class Re extends w{constructor(){super();Q(this,"patientRecordBuilder");this.patientRecordBuilder=new Xe}async saveRegistrationData(t){const a=await new G().getDDEIds();if(!a&&(De("DDE IDs are not available."),w.getLanConnectionStatus()||w.getPouchDbStatus()))return!1;let n=await this.patientRecordBuilder.buildPatientRecord(t,a);return w.getProgramID()==32&&(n=await Ie(n)),await new G().possibleDuplicates(n.personInformation)?!0:await Z(n)?(X("Registration successful"),sessionStorage.setItem("ichis_diagnosis",JSON.stringify([])),w.getPouchDbStatus()&&await new G().deleteDDEId(a),await this.printBarcode(),!0):!1}async updateDemographics(t){let a=await this.patientRecordBuilder.buildPatientRecord(t,w.getNationalID(),w.getPatientID());return a.saveStatusPersonInformation="edit",a.saveStatusGuardianInformation="edit",a.saveStatusBirthRegistration="edit",a.saveStatusVitals="edit",await Z(a)?(X("Updated successful"),!0):!1}checkIfChild(t){if(!(t!=null&&t.estimation)&&!(t!=null&&t.birthdate))return{moreThanThirteenYears:!0,underNineMonths:!1,underFiveYears:!1};let a="";return t.estimation?a=this.calculateDoB(t.estimation,t.estimation_unit||"Years")||"":a=t.birthdate,{moreThanThirteenYears:A.getAgeInYears(a)>13,underNineMonths:A.ageInMonths(a)<9,underFiveYears:A.getAgeInYears(a)<5}}async printBarcode(){await ee(Ee,{class:"small-confirm-modal "})!=="dismiss"&&new we().printData("barcode")}calculateDoB(t,a){try{let n=Te(w.getSessionDate());if(a==="Years"&&t<0)n=n.add(Math.abs(t),"years");else switch(a){case"Days":n=n.subtract(t,"days");break;case"Months":n=n.subtract(t,"months");break;case"Years":n=n.subtract(t,"years");break;default:return null}return A.toStandardHisDisplayFormat(n.format("YYYY-MM-DD"))||""}catch(n){return console.error("Error calculating date:",n),null}}}const et=()=>{const i=L();return Fe.isProp("military_site=true").then(t=>{i.value=t}),{socialHistory:V(()=>[{componentType:"Heading",name:"Social History",position:"center"},{componentType:"multiSelectInputField",header:"Religion",name:"religion",icon:v.search,trackBy:"id",options:[{id:1,name:"Christianity"},{id:2,name:"Islam"},{id:3,name:"Judaism"},{id:4,name:"Hinduism"},{id:5,name:"Buddhism"},{id:6,name:"Sikhism"},{id:7,name:"Jainism"},{id:8,name:"BahÃ¡'Ã­ Faith"},{id:9,name:"Zoroastrianism"},{id:10,name:"Confucianism"},{id:11,name:"Taoism"},{id:12,name:"Shinto"},{id:13,name:"Baha'i Faith"},{id:14,name:"Juche"},{id:15,name:"Rastafari"}]},{componentType:"radioButtonField",header:"Occupation status",name:"occupation",type:"inline",validation:D.required,condition:()=>w.getProgramID()==1&&i.value,options:[{label:"Military",value:"Military"},{label:"Civilian",value:"Civilian"}]},{componentType:"radioButtonField",header:"Occupation status",name:"occupation",type:"inline",condition:t=>!i,options:[{label:"Employed",value:"employed"},{label:"Student",value:"Student"},{label:"Unemployed",value:"unemployed"},{label:"Other",value:"Other"}]},{componentType:"radioButtonField",header:"Marital status",name:"maritalStatus",type:"inline",options:[{label:"Single",value:"single"},{label:"Married",value:"married"},{label:"Widow",value:"widow"},{label:"Widower",value:"widower"},{label:"Divorced",value:"divorced"}]},{componentType:"radioButtonField",header:"Highest level of education",name:"highestLevelOfEducation",type:"inline",options:[{label:"No education",value:"No education"},{label:"Primary school",value:"primary school"},{label:"Secondary school",value:"secondary school"},{label:"Tertiary education",value:"tertiary education"}]}])}},mt=E({__name:"SocialHistory",setup(i,{expose:e}){const{socialHistory:t}=et(),{formRef:a,exposeFormMethods:n}=H();return e(n()),(s,l)=>(k(),$(x,{formData:O(t),ref_key:"formRef",ref:a},null,8,["formData"]))}}),tt=()=>{const{facilityList:i,getFacilities:e}=W();return e(),{patientType:V(()=>[{componentType:"Heading",name:"Patient Type",position:"center"},{componentType:"radioButtonField",header:"Patient Type",name:"patient_type",type:"inline",validation:D.required,options:[{label:"New patient",value:"New patient"},{label:"Emergency supply",value:"Emergency supply"},{label:"External consultation",value:"External consultation"}]},{componentType:"multiSelectInputField",header:"Facility",name:"facility",trackBy:"facility_id",openDirection:"auto",icon:v.search,validation:a=>D.required(a),options:i.value.facilities||i.value,condition:a=>(a==null?void 0:a.patient_type)=="Emergency supply"||(a==null?void 0:a.patient_type)=="External consultation"}])}},_t=E({__name:"PatientType",setup(i,{expose:e}){const{patientType:t}=tt(),{formRef:a,exposeFormMethods:n}=H();return e(n()),(s,l)=>(k(),$(x,{formData:O(t),ref_key:"formRef",ref:a},null,8,["formData"]))}}),it=i=>({birthRegistration:V(()=>[{componentType:"Heading",name:"Birth Registration",position:"center"},{componentType:"inputField",header:"Birth certificate number",name:"Serial Number",icon:v.nationalID,placeholder:"__-__-__-__"},{componentType:"inputField",header:"Birth Weight/First weight (kg)",name:"Weight",icon:v.weight,validation:t=>D.validateWeight(t)},{componentType:"multiSelectInputField",header:"How many doses of Tdv did the mother receive?",name:"How many doses of Tdv did the mother receive?",icon:v.search,options:[{concept_id:11997,name:"0-2 doses, less than two weeks before delivery"},{concept_id:11998,name:"2-5 doses more than two weeks of delivery"},{concept_id:1067,name:"Unknown"}],trackBy:"concept_id",validation:t=>D.required(t),onChange:t=>{const a=t==null?void 0:t.name;a=="Unknown"?i.value.setFormValue("Protected at birth",{concept_id:1067,name:"Don't know"}):a=="0-2 doses, less than two weeks before delivery"?i.value.setFormValue("Protected at birth",{concept_id:1066,name:"No"}):a=="2-5 doses more than two weeks of delivery"&&i.value.setFormValue("Protected at birth",{concept_id:1065,name:"Yes"})}},{componentType:"multiSelectInputField",header:"Protected at birth (PAB)",name:"Protected at birth",icon:v.search,trackBy:"concept_id",validation:t=>D.required(t),disabled:t=>!t["How many doses of Tdv did the mother receive?"]},{componentType:"multiSelectInputField",header:"HIV status of the Child's Mother",name:"HIV status",icon:v.search,options:[{id:703,name:"Positive"},{id:664,name:"Negative"},{id:1067,name:"Unknown"}],trackBy:"id",validation:t=>D.required(t)}])}),pt=E({__name:"BirthRegistration",setup(i,{expose:e}){const{formRef:t,exposeFormMethods:a}=H(),{birthRegistration:n}=it(t);return e(a()),(s,l)=>(k(),$(x,{formData:O(n),ref_key:"formRef",ref:t},null,8,["formData"]))}});function ht(){const i=L(1),e=L(4),t=4,a=J(),{patient:n}=ce(a),s=()=>{const F=window.innerWidth;return F>=992?4:F>=768?3:F>=576?2:1},l=V(()=>e.value===0?t:Math.ceil(t/e.value)),d=V(()=>l.value>1),_=V(()=>d.value&&i.value>1),r=V(()=>d.value&&i.value<l.value),h=F=>{if(l.value===1)return!0;const B=(i.value-1)*e.value,Y=B+e.value-1;return F>=B&&F<=Y},o=()=>{i.value<l.value&&i.value++},y=()=>{i.value>1&&i.value--},P=F=>{F>=1&&F<=l.value&&(i.value=F)},C=()=>{e.value=s(),i.value>l.value&&(i.value=l.value),i.value===0&&l.value>0&&(i.value=1)};return Pe(()=>{window.addEventListener("resize",C),C()}),Ce(()=>{window.removeEventListener("resize",C)}),{currentPage:i,columnsPerRow:e,totalPages:l,showPaginationButtons:d,showPreviousButton:_,showNextButton:r,nextPage:o,prevPage:y,goToPage:P,handleResize:C,isCardVisible:h}}function yt(){const i=J(),{patient:e}=ce(i),t=n=>{var y,P,C;const{personalInformationRef:s,socialHistoryRef:l,countryRef:d,currentLocationRef:_,homeLocationRef:r,guardianInformationRef:h}=n.value,o=(y=e==null?void 0:e.value)==null?void 0:y.personInformation;s==null||s.setFormValue("nationalID",(C=(P=e==null?void 0:e.value)==null?void 0:P.otherPersonInformation)==null?void 0:C.nationalID),s==null||s.setFormValue("firstname",o==null?void 0:o.given_name),s==null||s.setFormValue("middleName",o==null?void 0:o.middle_name),s==null||s.setFormValue("lastname",o==null?void 0:o.family_name),s==null||s.setFormValue("gender",o==null?void 0:o.gender),s==null||s.setFormValue("birthdate",o!=null&&o.birthdate?A.toStandardHisDisplayFormat(o==null?void 0:o.birthdate):""),s==null||s.setFormValue("Phone Number",o!=null&&o.cell_phone_number?o==null?void 0:o.cell_phone_number:""),r==null||r.setFormValue("home_district",{name:o==null?void 0:o.home_district}),r==null||r.setFormValue("home_traditional_authority",{name:o==null?void 0:o.home_traditional_authority}),r==null||r.setFormValue("home_village",{name:o==null?void 0:o.home_village}),_==null||_.setFormValue("current_district",{name:o==null?void 0:o.current_district}),_==null||_.setFormValue("current_traditional_authority",{name:o==null?void 0:o.current_traditional_authority}),_==null||_.setFormValue("current_village",{name:o==null?void 0:o.current_village}),_==null||_.setFormValue("closestLandmark",{name:o==null?void 0:o.landmark}),d==null||d.setFormValue("country",o!=null&&o.country?{name:o==null?void 0:o.country}:{name:"Malawi"}),l==null||l.setFormValue("religion",{name:o==null?void 0:o.religion}),l==null||l.setFormValue("occupation",o==null?void 0:o.occupation),l==null||l.setFormValue("maritalStatus",o==null?void 0:o.marital_status),l==null||l.setFormValue("highestLevelOfEducation",o==null?void 0:o.education_level),a(h)},a=n=>{var d,_,r;const s=(_=(d=e==null?void 0:e.value)==null?void 0:d.guardianInformation)==null?void 0:_.saved[0],l=(r=s==null?void 0:s.relationship_type)!=null&&r.b_is_to_a?{name:s.relationship_type.b_is_to_a,id:s.relationship_type.relationship_type_id,trackByID:s.relationship_type.relationship_type_id+s.relationship_type.b_is_to_a}:"";n==null||n.setFormValue("guardianNationalID",(s==null?void 0:s.national_id)||""),n==null||n.setFormValue("guardianFirstname",(s==null?void 0:s.given_name)||""),n==null||n.setFormValue("guardianMiddleName",(s==null?void 0:s.middle_name)||""),n==null||n.setFormValue("guardianLastname",(s==null?void 0:s.family_name)||""),n==null||n.setFormValue("guardianPhoneNumber",s!=null&&s.cell_phone_number?s==null?void 0:s.cell_phone_number:""),n==null||n.setFormValue("relationship",l||"")};return{setFormValues:t,setGuardianInformation:a}}export{Ee as C,Re as R,ct as _,yt as a,pt as b,mt as c,ut as d,rt as e,dt as f,_t as g,ht as u};
