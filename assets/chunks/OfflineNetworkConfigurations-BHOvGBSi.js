import{d as W,r as y,c as Y,a as X,O as Z,f as I,J as C,e as F,m as D,l as $,k as u,u as b,a0 as ee,ab as oe,ac as te,ad as ae,p as H,Q as O,L as se,cl as re,cm as ne,K as E,N as ce,ae as ie,U as le}from"./vendor-DXMRec6a.js";import{Q as de,y as ue,x as P,T as he,z as pe,F as L,w as N,S as i,aM as fe,_ as me}from"../index-DFvmUOLO.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-89lqyBgH.js";const be={key:0,class:"spinner-overlay"},ge={class:"positionCenter"},ve={class:"registration_ion_card"},$e={class:"_card_content"},_e={key:0,class:"connection-status-section"},we={class:"status-indicator"},ye={key:0,class:"timestamp"},Ce={class:"action-buttons"},x="network_last_test_result",Pe=W({__name:"OfflineNetworkConfigurations",setup(Se){const S=de(),w=y(S.getFacilityNetworkConfig()),k=y(!1),T=y(!1),g=y(null),v=y(null),J=fe(),{formRef:z,getFormValues:A}=ue(),V=Y(()=>{var o,e,t,s,r;return[{componentType:"inputField",header:"Username",name:"couchdbUsername",value:(o=w.value)==null?void 0:o.couchdbUsername,validation:P.required,grid:{s:"6"}},{componentType:"inputField",header:"Password",name:"couchdbPassword",type:"password",value:(e=w.value)==null?void 0:e.couchdbPassword,validation:P.required,grid:{s:"6"}},{componentType:"inputField",header:"IP Address",name:"couchdbHost",value:(t=w.value)==null?void 0:t.couchdbHost,validation:P.required,grid:{s:"6"}},{componentType:"inputField",header:"Port Number",name:"couchdbPort",value:(s=w.value)==null?void 0:s.couchdbPort,validation:P.required,grid:{s:"6"}},{componentType:"Heading",name:"Protocol",grid:{s:"4"}},{componentType:"radioButtonField",name:"couchdbProtocol",validation:P.required,type:"inline",grid:{s:"6"},value:(r=w.value)==null?void 0:r.couchdbProtocol,options:[{label:"https",value:"https"},{label:"http",value:"http"}]}]}),q=async()=>{T.value=!0,g.value=null,v.value=null;try{const o=A(),{couchdbUsername:e,couchdbPassword:t,couchdbHost:s,couchdbPort:r,couchdbProtocol:h}=o;if(!e||!t||!s||!h)throw new Error("Please fill in all required fields");const p=e.trim(),_=t.trim(),f=s.trim(),m=h.trim(),l=btoa("".concat(p,":").concat(_)),c=r?":".concat(r):"",d="".concat(m,"://").concat(f).concat(c);console.log("Testing connection to:",d);const n=await fetch("".concat(d,"/"),{method:"GET",headers:{Authorization:"Basic ".concat(l),"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(n.ok){const a=await n.json();if(a.couchdb==="Welcome")g.value="available",v.value=new Date().toLocaleString(),localStorage.setItem(x,JSON.stringify({status:"available",timestamp:v.value,version:a.version})),L("Connected successfully! CouchDB version: ".concat(a.version),3e3),await j();else throw new Error("Server responded but is not CouchDB")}else{let a="Connection failed";switch(n.status){case 401:a="Authentication failed - Invalid username or password";break;case 403:a="Access forbidden - Check user permissions";break;case 404:a="CouchDB server not found at this address";break;case 500:a="CouchDB server error";break;default:a="Connection failed with status: ".concat(n.status)}throw new Error(a)}}catch(o){console.error("Connection test failed:",o),g.value="error",v.value=new Date().toLocaleString(),localStorage.setItem(x,JSON.stringify({status:"error",timestamp:v.value,error:o.message})),o.name==="AbortError"||o.name==="TimeoutError"?N("Connection timeout - Check your network and server address",5e3):o.message.includes("fetch")?N("Network error - Cannot reach the server",5e3):N(o.message,5e3)}finally{T.value=!1}},j=async()=>{await(await le.create({header:"Save as Facility Default",message:"This will save the configuration for all users at this facility. Other users will automatically use these settings when they log in. Continue?",buttons:[{text:"Cancel",role:"cancel"},{text:"Save for All Users",handler:async()=>{k.value=!0;try{const e=A(),{couchdbHostRemote:t}=i.getCouchdbConfigRemote(),{couchdbHost:s}=i.getCouchdbConfig(),r={couchdbUsername:e.couchdbUsername,couchdbPassword:e.couchdbPassword,couchdbHost:e.couchdbHost,couchdbPort:e.couchdbPort||"",couchdbProtocol:e.couchdbProtocol,locationId:i.getUserLocationId(),facilityName:"",configuredBy:i.getUserName(),configuredAt:new Date().toISOString(),configSource:"global_property"};await S.setGlobalProperty("facility_network_config",JSON.stringify(r)),J.setConfig(r),t!=s&&await M(),L("Facility configuration saved successfully",3e3)}catch(e){console.error("Save error:",e),N("Failed to save facility configuration",3e3)}finally{k.value=!1}}}]})).present()},G=async()=>{const{couchdbUsername:o,couchdbPassword:e,couchdbPort:t,couchdbHost:s,couchdbProtocol:r}=i.getCouchdbConfig();console.log("ðŸš€ ~ ensureReplicatorDatabase ~ couchdbHost:",s);const h=btoa("".concat(o,":").concat(e)),p=t?":".concat(t):"";if((await fetch("".concat(r,"://").concat(s).concat(p,"/_replicator"),{method:"HEAD",headers:{Authorization:"Basic ".concat(h)}})).status===404){const f=t?":".concat(t):"",m=await fetch("".concat(r,"://").concat(s).concat(f,"/_replicator"),{method:"PUT",headers:{Authorization:"Basic ".concat(h),"Content-Type":"application/json"}});if(!m.ok)throw new Error("Failed to create _replicator database: ".concat(m.status));console.log("_replicator database created successfully")}},M=async()=>{await G();const{couchdbUsername:o,couchdbPassword:e,couchdbPort:t,couchdbHost:s,couchdbProtocol:r}=i.getCouchdbConfig(),h=K(),p=btoa("".concat(o,":").concat(e)),_=t?":".concat(t):"",f="".concat(r,"://").concat(s).concat(_,"/_replicator"),m=h.map(async l=>{try{const c=await fetch("".concat(f,"/").concat(l._id),{method:"GET",headers:{Authorization:"Basic ".concat(p),"Content-Type":"application/json"}});if(c.ok){const d=await c.json(),n={...l,_rev:d._rev},a=await fetch("".concat(f,"/").concat(l._id),{method:"PUT",headers:{Authorization:"Basic ".concat(p),"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok)throw new Error("Failed to update replication job ".concat(l._id,": ").concat(a.status," - ").concat(await a.text()));return a.json()}else if(c.status===404){const d=await fetch(f,{method:"POST",headers:{Authorization:"Basic ".concat(p),"Content-Type":"application/json"},body:JSON.stringify(l)});if(!d.ok)throw new Error("Failed to create replication job ".concat(l._id,": ").concat(d.status," - ").concat(await d.text()));return d.json()}else throw new Error("Error checking existing replication ".concat(l._id,": ").concat(c.status," - ").concat(await c.text()))}catch(c){throw console.error("Error processing replication job ".concat(l._id,":"),c),c}});await Promise.all(m)},K=()=>{const{couchdbHostRemote:o,couchdbPortRemote:e,couchdbUsernameRemote:t,couchdbPasswordRemote:s,couchdbProtocolRemote:r}=i.getCouchdbConfigRemote(),{couchdbUsername:h,couchdbPassword:p,couchdbPort:_,couchdbHost:f,couchdbProtocol:m}=i.getCouchdbConfig(),l=[...databaseConfig.liveSyncDatabases,...databaseConfig.periodicSyncDatabases];let c=[];const d=i.getUserLocationId();for(const n of l){const a=_?":".concat(_):"",B=e?":".concat(e):"";let R={_id:"pull_".concat(d,"_").concat(n),source:"".concat(r,"://").concat(t,":").concat(s,"@").concat(o).concat(B,"/").concat(n),target:"".concat(m,"://").concat(h,":").concat(p,"@").concat(f).concat(a,"/").concat(n),create_target:!0,continuous:!0},U={_id:"push_".concat(d,"_").concat(n),target:"".concat(r,"://").concat(t,":").concat(s,"@").concat(o).concat(B,"/").concat(n),source:"".concat(m,"://").concat(h,":").concat(p,"@").concat(f).concat(a,"/").concat(n),create_target:!0,continuous:!0};n==="patients_records"&&(R.selector={location_id:i.getUserLocationId()},U.selector={location_id:i.getUserLocationId()}),n==="dde"&&(R.selector={facility_code:i.getUserLocationId()},U.selector={facility_code:i.getUserLocationId()}),c.push(R),c.push(U)}return c},Q=()=>{const o=localStorage.getItem(x);if(o)try{const e=JSON.parse(o);g.value=e.status,v.value=e.timestamp}catch(e){console.error("Failed to parse last test result:",e)}};return X(async()=>{Q(),await S.loadFacilityNetworkConfig(),w.value=S.getFacilityNetworkConfig()}),(o,e)=>(I(),Z(b(ie),{class:H({loading:k.value})},{default:C(()=>[k.value?(I(),F("div",be,[$(b(ee),{name:"bubbles"}),e[0]||(e[0]=u("div",{class:"loading-text"},"Please wait...",-1))])):D("",!0),$(he),$(b(oe),{fullscreen:!0},{default:C(()=>[u("div",ge,[u("div",ve,[u("div",$e,[e[1]||(e[1]=u("div",{class:"card_header_main"},[u("div",null,[u("h2",{class:"card_hearder"},"Set Offline Network Configurations")])],-1)),$(b(te),null,{default:C(()=>[$(b(ae),{size:"12"},{default:C(()=>[u("div",null,[$(pe,{formData:V.value,ref_key:"formRef",ref:z},null,8,["formData"]),g.value?(I(),F("div",_e,[u("div",{class:H(["connection-result",g.value])},[u("div",we,[$(b(se),{icon:g.value==="available"?b(re):b(ne)},null,8,["icon"]),O(" "+E(g.value==="available"?"Connection Successful":"Connection Failed"),1)]),v.value?(I(),F("div",ye,E(v.value),1)):D("",!0)],2)])):D("",!0),u("div",Ce,[$(b(ce),{onClick:q,disabled:T.value,class:"primary-btn",expand:"block",fill:"solid"},{default:C(()=>[O(E(T.value?"Testing Connection...":"Test And Save Connection"),1)]),_:1},8,["disabled"])])])]),_:1})]),_:1})])])])]),_:1})]),_:1},8,["class"]))}}),Re=me(Pe,[["__scopeId","data-v-67d0a193"]]);export{Re as default};
