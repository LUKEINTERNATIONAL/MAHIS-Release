System.register(["./vendor-legacy-CL4ddJgY.js","../index-legacy-CaiYktbb.js","./EnterLabResultsModal-legacy-BhjHaaqt.js","./BasicForm-legacy-zIFOOTdk.js","./useUserActivities-legacy-Ci5gInde.js","./lodash-legacy-pOOc9Efu.js","./apexcharts-legacy-TrKVFpG0.js","./DateInputField-legacy-BiSji2JA.js"],function(e,t){"use strict";var a,n,o,s,l,d,i,r,u,c,p,v,b,m,g,f,y,h,w,_,x,S,O,k,I,T,B,C,H,D,L,F,N,A,$,J,j,R,E,M,P,z,V,W,Y,q,G,U,K,X,Q,Z,ee,te,ae,ne,oe,se,le,de,ie,re,ue,ce,pe,ve,be;return{setters:[e=>{a=e.d,n=e.M,o=e.aj,s=e.a7,l=e.X,d=e.dq,i=e.d_,r=e.ak,u=e.$,c=e.E,p=e.G,v=e.a4,b=e.I,m=e.bo,g=e.N,f=e.aW,y=e.R,h=e.H,w=e.O,_=e.f,x=e.J,S=e.l,O=e.k,k=e.K,I=e.Q,T=e.e,B=e.F,C=e.P,H=e.b2,D=e.ap,L=e.r,F=e.c,N=e.w,A=e.a,$=e.m,J=e.u,j=e.cr,R=e.es,E=e.b7,M=e.cY,P=e.n},e=>{z=e.M,V=e._,W=e.u,Y=e.s,q=e.aF,G=e.n,U=e.aG,K=e.S,X=e.g,Q=e.O,Z=e.t,ee=e.K,te=e.bG,ae=e.w,ne=e.ah,oe=e.aU,se=e.b8,le=e.o,de=e.k,ie=e.H,re=e.bH,ue=e.a,ce=e.X},e=>{pe=e.E},e=>{ve=e.B},e=>{be=e.u},null,null,null],execute:function(){var t=document.createElement("style");t.textContent="ion-footer[data-v-a0bebd3e]{--ion-toolbar-background: #f4f4f4f4}ion-modal[data-v-a0bebd3e]{--width: 90%;--height: 94%}.ion-padding[data-v-ad29d329]{--padding-start: var(--ion-padding, 0px);--padding-end: var(--ion-padding, 0px);--padding-top: var(--ion-padding, 0px);--padding-bottom: var(--ion-padding, 16px)}#container[data-v-ad29d329]{text-align:center;position:absolute;left:0;right:0;top:50%;transform:translateY(-50%)}#container strong[data-v-ad29d329]{font-size:20px;line-height:26px}#container p[data-v-ad29d329]{font-size:16px;line-height:22px;color:#8c8c8c;margin:0}#container a[data-v-ad29d329]{text-decoration:none}.action_buttons[data-v-ad29d329]{color:var(--ion-color-primary);display:flex;align-items:center;float:right;max-width:70px}.modify_buttons[data-v-ad29d329]{padding-left:20px}.item_no_border[data-v-ad29d329]{--border-color: transparent}.search_result[data-v-ad29d329]{padding:10px}.action_buttons[data-v-ad29d329]{opacity:0;transition:opacity .3s}.dashed_bottom_border:hover .action_buttons[data-v-ad29d329]{opacity:1}.dashed_bottom_border[data-v-ad29d329]{font-weight:700}.sub_item_body[data-v-ad29d329]{margin-left:45px}ion-segment-button[data-v-ad29d329]{background:#fff;margin-right:1px;font-size:12px;text-transform:unset}.bottomSummary[data-v-ad29d329]{margin-top:20px;max-width:600px}.bottomSummary .segment-button-checked[data-v-ad29d329]{background:#fff!important;--indicator-color: none}.bottomSummary ion-segment-button[data-v-ad29d329]{background:#e6e6e6;margin-right:5px;border-top-right-radius:10px;border-top-left-radius:10px;text-transform:unset;font-style:normal;font-weight:700;font-size:12px}.bmi_blood[data-v-978dcb74]{font-size:14px;font-weight:500;border:1px solid #ddeedd;border-radius:4px;padding:4px;min-width:190px}.graphBtn[data-v-978dcb74]{font-size:14px;font-weight:500;border:1px solid #ddeedd;border-radius:4px;padding:4px;min-width:90px}._active[data-v-978dcb74]{background-color:#ded;color:#006401;padding:5px;border-radius:4px}.iconBg[data-v-978dcb74]{background:#ded;padding:2px;border-radius:5px}.show_more[data-v-978dcb74]{color:#006401;padding:10px}.no-margin-left[data-v-978dcb74]{margin:0;display:flex;justify-content:flex-start;background:#e0ffff}.scrollable-container[data-v-978dcb74]{overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%}\n/*$vite$:1*/",document.head.appendChild(t);const me=a({components:{IonButtons:f,IonButton:g,IonModal:m,IonHeader:b,IonContent:v,IonToolbar:p,IonTitle:c,IonItem:u,IonList:r,IonAvatar:i,IonImg:d,IonLabel:l,IonPage:s,IonMenu:o,BasicForm:ve,IonFooter:n,DynamicButton:z},data:()=>({popoverStatus:null}),props:{keyboardClose:{type:Boolean,default:!1},keepContentsMounted:{type:Boolean,default:!1},content:{default:[]},popoverOpen:{type:Boolean,default:!1},event:{type:Event,default:""},title:{type:String,default:""}},methods:{dismiss(){y.dismiss()},nav(e,t){this.dismiss(),this.$router.push(e)}}}),ge={class:"modal_wrapper"},fe={class:"center text_12"},ye=V(me,[["render",function(e,t,a,n,o,s){const l=h("ion-title"),d=h("ion-button"),i=h("ion-buttons"),r=h("ion-toolbar"),u=h("ion-header"),c=h("ion-skeleton-text"),p=h("ion-col"),v=h("ion-row"),b=h("ion-content"),m=h("ion-modal");return _(),w(m,{"is-open":e.popoverOpen,"show-backdrop":!0,onDidDismiss:t[1]||(t[1]=t=>e.$emit("closePopover",!1)),"keyboard-close":e.keyboardClose},{default:x(()=>[S(u,null,{default:x(()=>[S(r,null,{default:x(()=>[S(l,null,{default:x(()=>[O("b",null,"Lab results for ("+k(e.content.name)+") test",1)]),_:1}),S(i,{slot:"end"},{default:x(()=>[S(d,{onClick:t[0]||(t[0]=t=>e.$emit("closeModal"))},{default:x(()=>[...t[2]||(t[2]=[I("Close",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),S(b,{class:"ion-padding"},{default:x(()=>[O("div",ge,[O("div",fe,[S(v,null,{default:x(()=>[(_(!0),T(B,null,C(e.content.result,(e,a)=>(_(),w(p,{size:"4",key:a},{default:x(()=>[S(v,null,{default:x(()=>[S(p,{size:"8"},{default:x(()=>[e.indicator&&e.indicator.name?(_(),T(B,{key:0},[I(k(e.indicator.name),1)],64)):(_(),w(c,{key:1,animated:"",style:{width:"80%"}}))]),_:2},1024),S(p,{class:"bold",size:"0.5"},{default:x(()=>[...t[3]||(t[3]=[I(":",-1)])]),_:1}),S(p,{class:"bold",size:"2"},{default:x(()=>[I(k(e.value),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])])]),_:1})]),_:1},8,["is-open","keyboard-close"])}],["__scopeId","data-v-a0bebd3e"]]),he=V(a({__name:"AddLabTestModal",setup(e){const t=W(),a=Y(),{patient:n}=H(t),o=D(),s=G,l=L(""),d=L(""),i=L(""),r=L(""),u=L(null),p=L(null),m=L([]),g=F(()=>[{componentType:"multiSelectInputField",name:"test",header:"Test",options:r.value,grid:{s:"6"},icon:G.search,validation:q.required,onChange:e=>{l.value=e.name,C()&&(i.value=[])}},{componentType:"multiSelectInputField",name:"specimen",header:"Specimen",grid:{s:"6"},icon:G.search,validation:q.required,value:1==i.value.length?i.value[0]:"",options:i.value.length>1?i.value:[]}]),f=F(()=>[{componentType:"checkboxField",type:"single",name:"HIV test",label:"HIV test",value:"HIV test"==l.value},{componentType:"checkboxField",type:"single",name:"Hepatitis B Test",label:"Hepatitis B Test",value:"Hepatitis B Test"==l.value},{componentType:"checkboxField",type:"single",name:"Syphilis",label:"Syphilis",value:"Syphilis"==l.value},{componentType:"checkboxField",type:"single",name:"Hepatitis C Test",label:"Hepatitis C Test",value:"Hepatitis C Test"==l.value}]);N(l,async e=>{if(e)try{i.value=await O(e)}catch(t){i.value=[]}else i.value=[]});const O=async e=>{let t;return t=K.getPouchDbStatus()||K.getLanConnectionStatus()?await X("specimens"):await Q.getSpecimens("",1e3),await ne.getConceptSet(e,"",{names:t.map(e=>e.name)})};N(n,async()=>{d.value=[...n.value.labOrders.saved,...n.value.labOrders.unsaved]},{deep:!0});const k=()=>{y.dismiss()},C=()=>"HIV test"==l.value||"Syphilis"==l.value||"Hepatitis B Test"==l.value||"Hepatitis C Test"==l.value,j=async()=>{k();const e=String(localStorage.getItem("locationID"));e?(await a.refresh(e),await o.push("/home")):ae("Location not found")},R=async(e="",t)=>{try{const a=p.value.getFormValues();if(!a||0===Object.keys(a).length)return!1;if(!Object.values(a).some(e=>e))return!1;const n=Object.keys(a).map(async n=>{a[n]&&m.value.push({order_type_id:t,concept_id:await ne.getConceptID(n,!0),name:n,specimen:"Blood",reason:"Routine",specimenConcept:await ne.getConceptID("Blood",!0),referral:e})});return await Promise.all(n),m.value.length>0&&await E(m.value),a}catch(a){return console.error("Error saving HIV tests:",a),!1}},E=async e=>{var t,a,o,s,l,i;const r=await Q.buildLabOrders("",e),u=JSON.parse(JSON.stringify(n.value));null!==(a=(t=null!==(o=u.labOrders)&&void 0!==o?o:u.labOrders={}).unsaved)&&void 0!==a||(t.unsaved=[]),null!==(l=(s=null!==(i=u.labOrders)&&void 0!==i?i:u.labOrders={}).saved)&&void 0!==l||(s.saved=[]),u.labOrders.unsaved.push(...r),await oe(u),d.value=[...u.labOrders.saved,...u.labOrders.unsaved]};return A(async()=>{r.value=await(async()=>K.getPouchDbStatus()||K.getLanConnectionStatus()?await X("test_types"):await Q.getTestTypes())()}),(e,t)=>{const a=h("ion-icon"),o=h("ion-footer");return _(),T(B,null,[S(J(b),{style:{display:"flex","justify-content":"space-between"}},{default:x(()=>[C()?$("",!0):(_(),w(J(c),{key:0,class:"modalTitle"},{default:x(()=>[...t[5]||(t[5]=[I("Add Lab Test",-1)])]),_:1})),C()?(_(),w(J(c),{key:1,class:"modalTitle"},{default:x(()=>[...t[6]||(t[6]=[I("Add HIV Test",-1)])]),_:1})):$("",!0),S(a,{onClick:t[0]||(t[0]=e=>k()),style:{"padding-top":"10px","padding-right":"10px"},icon:J(s).cancel},null,8,["icon"])]),_:1}),C()?$("",!0):(_(),w(J(v),{key:0,class:"ion-padding",style:{"--background":"#fff"}},{default:x(()=>[S(U,{formData:g.value,ref_key:"formRef",ref:u},null,8,["formData"])]),_:1})),C()?(_(),w(J(v),{key:1,class:"ion-padding",style:{"--background":"#fff"}},{default:x(()=>[S(U,{formData:f.value,ref_key:"formRefHiv",ref:p},null,8,["formData"])]),_:1})):$("",!0),S(o,{collapse:"fade",class:"ion-no-border"},{default:x(()=>[C()?$("",!0):(_(),w(z,{key:0,onClick:t[1]||(t[1]=e=>(async()=>{if(u.value.validateForm())return void Z("Test not saved");if(!u.value)return void console.error("Form reference is not available");const e=u.value.getFormValues(),t=e.test.name,a=e.specimen.name,n=[{concept_id:e.test.concept_id,name:t,specimen:a,reason:"Routine",specimenConcept:await ne.getConceptID(a,!0)}];await E(n),k()})()),name:"Save",fill:"solid",style:{float:"right",margin:"2%"}})),C()?(_(),w(z,{key:1,onClick:t[2]||(t[2]=e=>(async()=>{await R("referral",9)?(ee("HIV Test sent to HTS successfully"),await j()):Z("No HIV Test selected")})()),name:"Send to HTS",fill:"solid",style:{float:"right",margin:"2%"}})):$("",!0),C()?(_(),w(z,{key:2,onClick:t[3]||(t[3]=e=>(async()=>{if(await R("",4))try{await te.addPatientToStage(n.value,"LAB"),ee("The patient successfully sent to the lab. You may now attend to other patients."),await j()}catch(e){console.error("Error sending to lab:",e),ae("Failed to send patient to lab")}k()})()),name:"Send to Lab",fill:"solid",style:{float:"right",margin:"2%"}})):$("",!0),C()?(_(),w(z,{key:3,onClick:t[4]||(t[4]=e=>{l.value=""}),color:"danger",name:"Back",fill:"solid",style:{margin:"2%"}})):$("",!0)]),_:1})],64)}}}),[["__scopeId","data-v-ad29d329"]]),we={class:"container"},_e={class:"table-responsive"},xe=a({__name:"LabOrdersList",props:{propOrders:{default:()=>[]},showAddTestButton:{type:Boolean,default:!0},showSendToLabButton:{type:Boolean,default:!0}},setup(e){const t=e,a=D(),n=j(),o=W(),s=se(),l=Y(),{hasWaitingList:d}=be(),{patient:i}=H(o),{investigations:r}=H(s),u=L(),c=L([]),p=L(["Lab Test","Specimen","Accession Number","Location","Order Date","Result","Action"]),v=L([]),b=L([]),m=L(""),g=L(!1),f=L(""),y=R(()=>{var e;return null===(e=i.value)||void 0===e?void 0:e.labOrders}),h=G,w=F(()=>{const e=[];return t.showAddTestButton&&e.push({text:" <b>+ Add other tests </b>",className:"add-test text-white",action:async()=>{await $()}}),t.showSendToLabButton&&e.push({text:" <b>Send to Lab </b>",className:"send-lab text-white",attr:{id:"send-to-lab-btn"},action:async()=>{await z()}}),{responsive:!0,select:!1,layout:{topStart:"buttons",topEnd:"search",bottomStart:"info",bottomEnd:"paging"},ordering:!1,buttons:e}}),I=()=>{var e;const t=14===(null===(e=ue().activeProgram)||void 0===e?void 0:e.program_id)&&!d("Waiting for Laboratory"),a=document.getElementById("send-to-lab-btn");a&&(t&&q.value?a.style.display="inline":a.style.display="none")},$=async()=>{await le(he,{class:"lab-results-modal"},!0,{title:"name"}),await Z()},z=async()=>{"Confirm"==await de("Do you want to send this patient to the lab?",{cancelBtnLabel:"Cancel",confirmBtnLabel:"Send to Lab",returnName:!0})&&await V()},V=async()=>{try{const e=String(localStorage.getItem("locationID"));if(!e)return void ae("Location not found");await te.addPatientToStage(i.value,"LAB"),await l.refresh(e),await a.push("home"),ee("The patient successfully sent to the lab. You may now attend to other patients.")}catch(e){console.error("Error sending to lab:",e),ae("Failed to send patient to lab")}},q=F(()=>{const e=y.value;if(!e)return!1;const t=[...e.saved||[],...e.unsaved||[]];return 0!==t.length&&t.some(e=>!(null==e||!e.tests||!Array.isArray(e.tests))&&e.tests.some(e=>!(null!=e&&e.result)||0===e.result.length))}),U=async()=>{var e,t,a;if(null===(e=i.value)||void 0===e||!e.labOrders)return;if(v.value=[...null===(t=i.value)||void 0===t||null===(t=t.labOrders)||void 0===t?void 0:t.saved,...null===(a=i.value)||void 0===a||null===(a=a.labOrders)||void 0===a?void 0:a.unsaved],!v.value)return;const n=await v.value.filter(e=>ie.toStandardHisFormat(ie.sessionDate())===ie.toStandardHisFormat(e.order_date));n.length>0?r.value[0].selectedData=n:r.value[0].selectedData=""},X=(e,t,a)=>e.filter(e=>(e.order_date===a&&(e.tests=e.tests.filter(e=>e.name!==t)),e.tests.length>0)),Z=async()=>{if(!i.value.labOrders)return;v.value=[...i.value.labOrders.saved,...i.value.labOrders.unsaved];const e=ve(v.value),t=(32==K.getProgramID()?[["FBS","Blood","","","","",`<button class="btn btn-outline-success btn-sm order-btn" data-id='${JSON.stringify({name:"FBS",specimen:"Blood"})}'>Order Test</button> `],["HbA1c","Blood","","","","",`<button class="btn btn-outline-success btn-sm order-btn" data-id='${JSON.stringify({name:"HbA1c",specimen:"Blood"})}'>Order Test</button> `],["RBS","Blood","","","","",`<button class="btn btn-outline-success btn-sm order-btn" data-id='${JSON.stringify({name:"RBS",specimen:"Blood"})}'>Order Test</button> `]]:[]).filter(t=>!e.some(e=>e[0]===t[0]));c.value=[...e,...t],I(),await U(),E.use(M)},ve=(e,t)=>e.length>0?e.flatMap(e=>e.tests.flatMap(t=>{var a,n;const o=`<button class="btn btn-outline-success btn-sm result-btn" data-id='${JSON.stringify(e)}'>Enter Result</button> `,s=`<button class="btn btn-outline-secondary btn-sm view-btn" data-id='${JSON.stringify(t)}'>${h.view2}</button> `;let l=o;var d;1==(null==t||null===(a=t.result)||void 0===a?void 0:a.length)?l=null!=(null==t?void 0:t.result)?(null==t||null===(d=t.result[0])||void 0===d?void 0:d.value)||"":null:(null==t||null===(n=t.result)||void 0===n?void 0:n.length)>1&&(null==t||t.result,l=s);let i="";return null!=e&&e.accession_number&&(i=`<button class="btn btn-outline-secondary btn-sm" data-id='${JSON.stringify(e)}'>${h.print2}</button>`),[[null==t?void 0:t.name,null==e?void 0:e.specimen.name,(null==e?void 0:e.accession_number)||"",9==(null==e?void 0:e.order_type_id)?"<span class='red-tag'>HTS</span>":"",ie.toStandardHisFormat(null==e?void 0:e.order_date),l,i+`\n                        <button class="btn btn-outline-danger btn-sm delete-btn" data-id='${JSON.stringify(e)}'>${h.delete2}</button>\n                        `]]})):[];return A(async()=>{14==K.getProgramID()&&w.value.buttons.push(),await U(),await Z(),P(()=>{const e=u.value.dt;e.columns.adjust().draw(),e.on("click",".result-btn",async e=>{const t=e.target.getAttribute("data-id");await le(pe,{class:"lab-results-modal"},!0,{test_data:JSON.parse(t)})}),e.on("click",".view-btn",e=>{const t=e.target.getAttribute("data-id");m.value=JSON.parse(t),g.value=!0}),e.on("click",".delete-btn",e=>{const t=e.target.getAttribute("data-id");(async(e,t)=>{if(await ce(`Do you want to delete ${e.tests[0].name} ?`,t)){const t=JSON.parse(JSON.stringify(i.value));var a,n,o;t.labOrders.saved.some(t=>{var a,n;return t.order_date===e.order_date&&(null==t||null===(a=t.tests[0])||void 0===a?void 0:a.name)==(null==e||null===(n=e.tests[0])||void 0===n?void 0:n.name)})?(t.labOrders.saved=X(t.labOrders.saved,e.tests[0].name,e.order_date),null!==(n=(a=null!==(o=t.labOrders)&&void 0!==o?o:t.labOrders={}).voided)&&void 0!==n||(a.voided=[]),t.labOrders.voided.push({orderId:e.id,reason:"Mistake entry"})):t.labOrders.unsaved=X(t.labOrders.unsaved,e.tests[0].name,e.date),await oe(t)}await Z()})(JSON.parse(t),e)}),e.on("click",".order-btn",e=>{const t=e.target.getAttribute("data-id");(async e=>{const t=[{concept_id:await ne.getConceptID(e.name,!0),name:e.name,specimen:e.specimen,reason:"Routine",specimenConcept:await ne.getConceptID(e.specimen,!0)}];let a=(await Q.buildLabOrders("",t))[0];if(a.order_date=a.date||ie.sessionDate(),a.specimen.name||(a.specimen.name=await ne.getConceptName(a.specimen.concept_id)),a.tests&&a.tests.length>0)for(let n=0;n<a.tests.length;n++)a.tests[n].name||(a.tests[n].name=await ne.getConceptName(a.tests[n].concept_id));i.value.labOrders.unsaved.push(a),await oe(i.value),await Z()})(JSON.parse(t))})}),v.value=t.propOrders,f.value=new re(i.value.patientID),b.value=await K.getUserRoles()}),N(()=>n,async()=>{await Z()},{deep:!0,immediate:!0}),N(()=>i,async()=>{await Z()},{deep:!0,immediate:!0}),N(()=>{var e,t;return[null===(e=i.value)||void 0===e||null===(e=e.labOrders)||void 0===e?void 0:e.saved,null===(t=i.value)||void 0===t||null===(t=t.labOrders)||void 0===t?void 0:t.unsaved]},()=>{P(()=>{I()})},{deep:!0,immediate:!0}),N(q,e=>{console.log("hasTestsWithoutResults changed:",e),P(()=>{I()})},{deep:!0,immediate:!0}),(e,t)=>(_(),T("div",we,[O("div",_e,[S(J(E),{ref_key:"dataTable",ref:u,options:w.value,data:c.value,class:"display nowrap modern-table",width:"100%"},{default:x(()=>[O("thead",null,[O("tr",null,[(_(!0),T(B,null,C(p.value,e=>(_(),T("th",{key:e},k(e),1))),128))])])]),_:1},8,["options","data"])]),S(ye,{popoverOpen:g.value,content:m.value,onCloseModal:t[0]||(t[0]=e=>g.value=!1)},null,8,["popoverOpen","content"])]))}});e("default",V(xe,[["__scopeId","data-v-978dcb74"]]))}}});
