import{d as Et,am as Vt,cr as Ht,r as n,c as zt,b2 as f,a as $t,w as c,O as X,f as V,J as H,l as r,e as Jt,m as Z,k as d,u as P,a0 as Ut,dE as Yt,ab as qt,i as w,bT as tt,v as b,ae as Gt,eJ as jt,ba as y}from"./vendor-Do41i3tR.js";import{u as Kt,_ as Qt}from"./useFormWizard-BFgSyO4_.js";import{u as Xt,ba as Zt,bV as te,b1 as ee,e as ae,b2 as ne,b0 as se,bF as ie,T as oe,D as et,r as re,F as S,w as g,J as le,b as ue,H as z,b4 as O,I as at,b_ as ce,bI as $,s as A,t as nt,q as me,_ as pe}from"../index-DmWNBpr9.js";import{D as ve}from"./DemographicBar-BkCJgdeB.js";import{C as de,b as fe,O as ge}from"./OPDOutcome-DBvRnCO1.js";import{I as he,N as De}from"./NextAppointment-DenQvDZd.js";import{O as Pe}from"./OPDDiagnosis-CqworbMz.js";import{O as we}from"./OPDPrintingModal-DC1wm9-k.js";import{b as be,u as ye}from"./nonPharmaTherapyStore-21WquTb_.js";import{u as Se}from"./previousComplaints-0GQ-2BaE.js";import{p as st}from"./ClientUtils-DFreqOSr.js";import{u as Oe}from"./usePatientProfile-BFrjn0in.js";import{u as Ce}from"./useUserActivities-CEGDA33R.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-DB4uOJSt.js";import"./LevelOfConsciousness.vue_vue_type_script_setup_true_lang-CDmwJrxn.js";import"./patient_complaints_service-DqJUhuQK.js";import"./DashBox-D4tZCR1X.js";import"./drug_prescription_service-LlM8W1d9.js";import"./Outcome-ylkFUZIP.js";import"./wardsStore-Bmz-lpc6.js";import"./LabOrdersList-CSE1YPU8.js";import"./EnterLabResultsModal-BZE2I7Qb.js";import"./BasicForm-CAHG-Ryz.js";import"./DateInputField-B-oTnImo.js";import"./group_validation-B_TUvOmH.js";import"./RadiologyStore-Dtys9bNK.js";import"./formatServerData-DFmQRhdp.js";import"./user_role_management-CSaXuiYe.js";import"./ncd_appointment_service-DA1xJUhG.js";import"./patient_diagnosis_service-JLNpMt4z.js";import"./Registration-DC4Vm8iy.js";import"./useSetRegistrationValues-C5e3rA4C.js";import"./useLocation-zxaj1Df3.js";import"./vaccines_service-UqNT7xWQ.js";import"./sms_service-DddHjCeK.js";import"./EIRreportsStore-DfUJIXTD.js";import"./Export-Do69Xl03.js";import"./useNeonatalEnrollmentStore-BNxshxEW.js";import"./enrollment-DU-PLRUa.js";const Te={key:0,class:"spinner-overlay"},Ie={style:{width:"90vw",margin:"0 auto","margin-top":"10px"}},Ae={class:"back_profile"},_e=Et({__name:"ConsultationPlan",setup(ke){const{currentTabIndex:m}=Kt(),{printVisitSummary:it}=Oe(),{hasWaitingList:C}=Ce(),p=Vt(),ot=Ht(),_=n(!1),k=n(!0),J=n(!1),N=n(!1),x=n(!0),rt=n(!1),B=n(!1),lt=n(!1),ut=Xt(),ct=Zt(),mt=te(),T=ee(),pt=ae(),U=ne(),vt=se(),dt=ie(),ft=Se(),F=n(!1),h=n(!1),Y=zt(()=>({text:h.value?"Saving...":"Finish",icon:h.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:F.value||h.value})),{patient:l}=f(ut),{investigations:gt}=f(ct),{OPDdiagnosis:ht}=f(mt),{selectedMedicalDrugsList:q}=f(T),{OPDActivities:I}=f(pt),{outcomes:Dt}=f(U),{currentSelectedNextAppointmentDate:Pt}=f(dt),{presentingComplaints:wt}=f(ft),{vitals:bt}=f(vt),G=n(null),L=n(null),j=n(null),yt=n(null),St=n(null),Ot=n(null),R=n(null),a=n(),K=()=>I.value.map(t=>({title:t,icon:""})),Ct=async(t,e,i)=>{var u;if(e===0&&await kt(),!await Q())return;await v(),t%1===0&&(m.value=t),R.value&&i&&R.value.changeTab(t),((u=a.value[t])==null?void 0:u.title)==="Investigations"&&L.value&&await L.value.openAHDModal()},D=()=>{var i;if(!a.value||a.value.length===0)return null;const t=m.value>=0&&m.value<a.value.length?m.value:0;switch((i=a.value[t])==null?void 0:i.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(I.value.length>0)switch(I.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Tt=()=>{p.push("home")},It=()=>{re()?p.push("/deathPatientProfile"):p.push("/patientProfile")},At=async()=>{N.value=!0,S("Printing consultation summary... Please wait.");try{await it(),S("Consultation summary printed successfully!"),setTimeout(()=>{p.push("home")},3500)}catch(t){g("Failed to print consultation summary.")}finally{N.value=!1}},_t=()=>{S("Patient has finished consultation!"),p.push("home")},Q=async()=>{const t=await le.getObsByEncounterIdAndDate(ue.PRESENTING_COMPLAINTS);return!!(t&&t.length>0)},v=async()=>{var e,i;const t=z.sessionDate();for(let o=0;o<a.value.length;o++)if(!await Q())k.value=!1,a.value[o].title!=="Clinical Assessment"&&(a.value[o].icon=jt);else{k.value=!0,J.value=!1;const u=a.value[o];if(u.title==="Clinical Assessment"){const s=O("presentingComplaints");a.value[o].icon=W(t,s)?y:""}else if(u.title==="Investigations"){const s=(i=(e=l.value)==null?void 0:e.labOrders)==null?void 0:i.saved,E=s==null?void 0:s.filter(Mt=>z.toStandardHisFormat(t)===z.toStandardHisFormat(Mt.order_date));a.value[o].icon=(E==null?void 0:E.length)>0?y:""}else if(u.title==="Diagnosis"){const s=O("diagnosis");a.value[o].icon=W(t,s)?y:""}else if(u.title==="Treatment Plan"){const s=O("treatment");a.value[o].icon=(s==null?void 0:s.length)>0?y:""}else if(u.title==="Next Appointment"){const s=O("appointments");a.value[o].icon=W(t,s)?y:""}else if(u.title==="Outcome"){const s=O("outcomes");a.value[o].icon=(s==null?void 0:s.length)>0?y:""}}M()},W=(t,e)=>{if(!e)return!1;const i=new Date(t);return i.setHours(0,0,0,0),e.some(o=>{const u=new Date(o.obs_datetime||o.order_date);return u.setHours(0,0,0,0),u.getTime()===i.getTime()})},kt=async()=>{var t;_.value=!0;try{await Promise.all([(t=G.value)==null?void 0:t.onSubmit()]),await at(l.value),ce()}catch(e){throw g("Failed to save clinical assessment"),e}finally{_.value=!1}},Nt=async()=>{try{const t=await be();l.value={...l.value,...t},await ye().saveNonPharmaTherapyPatientData()}catch(t){nt("Failed to save treatment plan")}},xt=()=>{const t=q.value;return console.log("Checking prescribed medications:",{medicationsCount:t.length,medications:t}),t.length>0},Bt=async()=>{var t;try{h.value=!0,await((t=j.value)==null?void 0:t.onSubmit()),await Nt(),await U.saveOutcomPatientData(),await at(l.value);const e=localStorage.getItem("locationID");if(!e){g("Location ID missing.");return}const i=xt();if(C("Waiting for Laboratory")){await Lt(e),S("Patient moved to Consultation for Lab follow-up.");return}if(i&&C("Waiting for Consultation")){C("Waiting for Dispensation")?await Ft(e):await Rt(e);return}if(!i&&C("Waiting for Consultation")){await Wt(e);return}}catch(e){g("Failed to save consultation.")}finally{h.value=!1}},Ft=async t=>{try{await $.addPatientToStage(l.value,"DISPENSATION"),await A().refresh(t),T.clearSelectedMedicalDrugsList(),S("Patient moved to Dispensation."),p.push("home")}catch(e){throw g("Failed to move patient to dispensation"),e}},Lt=async t=>{try{await $.addPatientToStage(l.value,"CONSULTATION"),await A().refresh(t),T.clearSelectedMedicalDrugsList(),p.push("home")}catch(e){throw g("Failed to move patient to consultation"),e}},Rt=async t=>{try{await $.addPatientToStage(l.value,"DISPENSATION"),await A().refresh(t),T.clearSelectedMedicalDrugsList(),nt("Patient moved to dispensation queue. You lack access to dispense."),p.push("home")}catch(e){throw g("Failed to move patient to dispensation"),e}},Wt=async t=>{try{await me(l.value),await A().refresh(t),p.push("home")}catch(e){console.error("Failed to close visit:",e),g("Failed to close visit.")}};$t(async()=>{var t;try{if(I.value.length===0){await p.push("home");return}a.value=K(),st.setCurrentPatientID((t=l.value)==null?void 0:t.patientID),await v(),(m.value===void 0||m.value<0)&&(m.value=0),F.value=!1,M()}catch(e){console.error("Error: ",e)}}),c(m,async()=>{await M()}),c(bt,async()=>{await v()},{deep:!0}),c(l,async()=>{var t;await v(),st.setCurrentPatientID((t=l.value)==null?void 0:t.patientID)},{deep:!0}),c(gt,async()=>{await v()},{deep:!0}),c(ht,async()=>{await v()},{deep:!0}),c(q,async()=>{await v()},{deep:!0}),c(Dt,async()=>{await v()},{deep:!0}),c(Pt,async()=>{await v()}),c(wt,async()=>{await v()},{deep:!0}),c(ot,async()=>{x.value=!1,a.value=K(),setTimeout(()=>{m.value=0,x.value=!0},0)},{deep:!0}),c(lt,t=>{B.value=t,B.value&&setTimeout(()=>{B.value=!1},15e3)}),c(Y,(t,e)=>{console.log("Done button options changed:",{from:e,to:t,currentStep:m.value,tabsLength:a.value.length})},{deep:!0});const M=()=>{let t=!1;return h.value&&(t=!0),F.value=t,!t};return(t,e)=>(V(),X(P(Gt),null,{default:H(()=>[r(we,{onYes:At,onNo:_t,isOpen:rt.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),_.value?(V(),Jt("div",Te,[r(P(Ut),{name:"bubbles"}),e[3]||(e[3]=d("div",{class:"loading-text"},"Please wait...",-1))])):Z("",!0),r(P(Yt),{"is-open":N.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),r(oe),r(P(qt),{fullscreen:!0},{default:H(()=>[r(ve),d("div",Ie,[x.value?(V(),X(Qt,{key:0,ref_key:"wizard",ref:R,headingTitle:"Consultation Plan","vertical-tabs":"","navigable-tabs":k.value,"scrollable-tabs":"",startIndex:0,doneButton:Y.value,nextButton:{disabled:J.value},"custom-tabs":a.value,tabs:a.value,onChange:Ct,"onComplete:wizard":e[2]||(e[2]=i=>Bt())},{default:H(()=>[d("div",null,[d("div",Ae,[r(et,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:P(tt),"font-weight":"600",onClick:e[0]||(e[0]=i=>Tt())},null,8,["icon"]),r(et,{name:"Back to Profile",iconSlot:"start",fill:"clear",icon:P(tt),"font-weight":"600",onClick:e[1]||(e[1]=i=>It()),style:{"margin-left":"15px"}},null,8,["icon"])])]),w(d("div",null,[r(de,{ref_key:"clinicalAssessmentRef",ref:G},null,512)],512),[[b,D()==="ClinicalAssessment"]]),w(d("div",null,[r(he,{ref_key:"investigationsRef",ref:L},null,512)],512),[[b,D()==="Investigations"]]),w(d("div",null,[r(Pe,{ref_key:"diagnosisRef",ref:j},null,512)],512),[[b,D()==="OPDDiagnosis"]]),w(d("div",null,[r(fe,{ref_key:"treatmentPlanRef",ref:yt},null,512)],512),[[b,D()==="OPDTreatmentPlan"]]),w(d("div",null,[r(De,{ref_key:"nextAppointmentRef",ref:St},null,512)],512),[[b,D()==="NextAppointment"]]),w(d("div",null,[r(ge,{ref_key:"outcomeRef",ref:Ot},null,512)],512),[[b,D()==="Outcome"]])]),_:1},8,["navigable-tabs","doneButton","nextButton","custom-tabs","tabs"])):Z("",!0)])]),_:1})]),_:1}))}}),ha=pe(_e,[["__scopeId","data-v-637056bb"]]);export{ha as default};
