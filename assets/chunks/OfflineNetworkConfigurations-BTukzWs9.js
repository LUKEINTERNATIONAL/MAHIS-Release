import{d as W,r as y,c as Y,a as X,O as Z,f as I,J as C,e as D,m as F,l as $,k as u,u as b,bx as ee,a3 as oe,a4 as te,a5 as ae,p as H,Q as O,L as se,cj as re,ck as ne,K as B,N as ce,a6 as ie,U as le}from"./vendor-BolvhNQv.js";import{y as de,aB as ue,aC as P,T as he,aD as pe,G as L,s as N,S as i,aF as fe,_ as me}from"../index-BJJABCwX.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-Go-aTq24.js";const be={key:0,class:"spinner-overlay"},ge={class:"positionCenter"},ve={class:"registration_ion_card"},$e={class:"_card_content"},_e={key:0,class:"connection-status-section"},we={class:"status-indicator"},ye={key:0,class:"timestamp"},Ce={class:"action-buttons"},E="network_last_test_result",Pe=W({__name:"OfflineNetworkConfigurations",setup(Se){const S=de(),w=y(S.getFacilityNetworkConfig()),k=y(!1),T=y(!1),g=y(null),v=y(null),J=fe(),{formRef:z,getFormValues:x}=ue(),V=Y(()=>[{componentType:"inputField",header:"Username",name:"couchdbUsername",value:w.value.couchdbUsername,validation:P.required,grid:{s:"6"}},{componentType:"inputField",header:"Password",name:"couchdbPassword",type:"password",value:w.value.couchdbPassword,validation:P.required,grid:{s:"6"}},{componentType:"inputField",header:"IP Address",name:"couchdbHost",value:w.value.couchdbHost,validation:P.required,grid:{s:"6"}},{componentType:"inputField",header:"Port Number",name:"couchdbPort",value:w.value.couchdbPort,validation:P.required,grid:{s:"6"}},{componentType:"Heading",name:"Protocol",grid:{s:"4"}},{componentType:"radioButtonField",name:"couchdbProtocol",validation:P.required,type:"inline",grid:{s:"6"},value:w.value.couchdbProtocol,options:[{label:"https",value:"https"},{label:"http",value:"http"}]}]),j=async()=>{T.value=!0,g.value=null,v.value=null;try{const o=x(),{couchdbUsername:e,couchdbPassword:a,couchdbHost:n,couchdbPort:c,couchdbProtocol:h}=o;if(!e||!a||!n||!h)throw new Error("Please fill in all required fields");const p=e.trim(),_=a.trim(),f=n.trim(),m=h.trim(),l=btoa("".concat(p,":").concat(_)),r=c?":".concat(c):"",d="".concat(m,"://").concat(f).concat(r);console.log("Testing connection to:",d);const s=await fetch("".concat(d,"/"),{method:"GET",headers:{Authorization:"Basic ".concat(l),"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(s.ok){const t=await s.json();if(t.couchdb==="Welcome")g.value="available",v.value=new Date().toLocaleString(),localStorage.setItem(E,JSON.stringify({status:"available",timestamp:v.value,version:t.version})),L("Connected successfully! CouchDB version: ".concat(t.version),3e3),await q();else throw new Error("Server responded but is not CouchDB")}else{let t="Connection failed";switch(s.status){case 401:t="Authentication failed - Invalid username or password";break;case 403:t="Access forbidden - Check user permissions";break;case 404:t="CouchDB server not found at this address";break;case 500:t="CouchDB server error";break;default:t="Connection failed with status: ".concat(s.status)}throw new Error(t)}}catch(o){console.error("Connection test failed:",o),g.value="error",v.value=new Date().toLocaleString(),localStorage.setItem(E,JSON.stringify({status:"error",timestamp:v.value,error:o.message})),o.name==="AbortError"||o.name==="TimeoutError"?N("Connection timeout - Check your network and server address",5e3):o.message.includes("fetch")?N("Network error - Cannot reach the server",5e3):N(o.message,5e3)}finally{T.value=!1}},q=async()=>{await(await le.create({header:"Save as Facility Default",message:"This will save the configuration for all users at this facility. Other users will automatically use these settings when they log in. Continue?",buttons:[{text:"Cancel",role:"cancel"},{text:"Save for All Users",handler:async()=>{k.value=!0;try{const e=x(),{couchdbHostRemote:a}=i.getCouchdbConfigRemote(),{couchdbHost:n}=i.getCouchdbConfig(),c={couchdbUsername:e.couchdbUsername,couchdbPassword:e.couchdbPassword,couchdbHost:e.couchdbHost,couchdbPort:e.couchdbPort||"",couchdbProtocol:e.couchdbProtocol,locationId:i.getUserLocationId(),facilityName:"",configuredBy:i.getUserName(),configuredAt:new Date().toISOString(),configSource:"global_property"};await S.setGlobalProperty("facility_network_config",JSON.stringify(c)),J.setConfig(c),a!=n&&await K(),L("Facility configuration saved successfully",3e3)}catch(e){console.error("Save error:",e),N("Failed to save facility configuration",3e3)}finally{k.value=!1}}}]})).present()},G=async()=>{const{couchdbUsername:o,couchdbPassword:e,couchdbPort:a,couchdbHost:n,couchdbProtocol:c}=i.getCouchdbConfig();console.log("ðŸš€ ~ ensureReplicatorDatabase ~ couchdbHost:",n);const h=btoa("".concat(o,":").concat(e)),p=a?":".concat(a):"";if((await fetch("".concat(c,"://").concat(n).concat(p,"/_replicator"),{method:"HEAD",headers:{Authorization:"Basic ".concat(h)}})).status===404){const f=a?":".concat(a):"",m=await fetch("".concat(c,"://").concat(n).concat(f,"/_replicator"),{method:"PUT",headers:{Authorization:"Basic ".concat(h),"Content-Type":"application/json"}});if(!m.ok)throw new Error("Failed to create _replicator database: ".concat(m.status));console.log("_replicator database created successfully")}},K=async()=>{await G();const{couchdbUsername:o,couchdbPassword:e,couchdbPort:a,couchdbHost:n,couchdbProtocol:c}=i.getCouchdbConfig(),h=M(),p=btoa("".concat(o,":").concat(e)),_=a?":".concat(a):"",f="".concat(c,"://").concat(n).concat(_,"/_replicator"),m=h.map(async l=>{try{const r=await fetch("".concat(f,"/").concat(l._id),{method:"GET",headers:{Authorization:"Basic ".concat(p),"Content-Type":"application/json"}});if(r.ok){const d=await r.json(),s={...l,_rev:d._rev},t=await fetch("".concat(f,"/").concat(l._id),{method:"PUT",headers:{Authorization:"Basic ".concat(p),"Content-Type":"application/json"},body:JSON.stringify(s)});if(!t.ok)throw new Error("Failed to update replication job ".concat(l._id,": ").concat(t.status," - ").concat(await t.text()));return t.json()}else if(r.status===404){const d=await fetch(f,{method:"POST",headers:{Authorization:"Basic ".concat(p),"Content-Type":"application/json"},body:JSON.stringify(l)});if(!d.ok)throw new Error("Failed to create replication job ".concat(l._id,": ").concat(d.status," - ").concat(await d.text()));return d.json()}else throw new Error("Error checking existing replication ".concat(l._id,": ").concat(r.status," - ").concat(await r.text()))}catch(r){throw console.error("Error processing replication job ".concat(l._id,":"),r),r}});await Promise.all(m)},M=()=>{const{couchdbHostRemote:o,couchdbPortRemote:e,couchdbUsernameRemote:a,couchdbPasswordRemote:n,couchdbProtocolRemote:c}=i.getCouchdbConfigRemote(),{couchdbUsername:h,couchdbPassword:p,couchdbPort:_,couchdbHost:f,couchdbProtocol:m}=i.getCouchdbConfig(),l=[...databaseConfig.liveSyncDatabases,...databaseConfig.periodicSyncDatabases];let r=[];const d=i.getUserLocationId();for(const s of l){const t=_?":".concat(_):"",A=e?":".concat(e):"";let R={_id:"pull_".concat(d,"_").concat(s),source:"".concat(c,"://").concat(a,":").concat(n,"@").concat(o).concat(A,"/").concat(s),target:"".concat(m,"://").concat(h,":").concat(p,"@").concat(f).concat(t,"/").concat(s),create_target:!0,continuous:!0},U={_id:"push_".concat(d,"_").concat(s),target:"".concat(c,"://").concat(a,":").concat(n,"@").concat(o).concat(A,"/").concat(s),source:"".concat(m,"://").concat(h,":").concat(p,"@").concat(f).concat(t,"/").concat(s),create_target:!0,continuous:!0};s==="patients_records"&&(R.selector={location_id:i.getUserLocationId()},U.selector={location_id:i.getUserLocationId()}),s==="dde"&&(R.selector={facility_code:i.getUserLocationId()},U.selector={facility_code:i.getUserLocationId()}),r.push(R),r.push(U)}return r},Q=()=>{const o=localStorage.getItem(E);if(o)try{const e=JSON.parse(o);g.value=e.status,v.value=e.timestamp}catch(e){console.error("Failed to parse last test result:",e)}};return X(async()=>{Q(),await S.loadFacilityNetworkConfig(),w.value=S.getFacilityNetworkConfig()}),(o,e)=>(I(),Z(b(ie),{class:H({loading:k.value})},{default:C(()=>[k.value?(I(),D("div",be,[$(b(ee),{name:"bubbles"}),e[0]||(e[0]=u("div",{class:"loading-text"},"Please wait...",-1))])):F("",!0),$(he),$(b(oe),{fullscreen:!0},{default:C(()=>[u("div",ge,[u("div",ve,[u("div",$e,[e[1]||(e[1]=u("div",{class:"card_header_main"},[u("div",null,[u("h2",{class:"card_hearder"},"Set Offline Network Configurations")])],-1)),$(b(te),null,{default:C(()=>[$(b(ae),{size:"12"},{default:C(()=>[u("div",null,[$(pe,{formData:V.value,ref_key:"formRef",ref:z},null,8,["formData"]),g.value?(I(),D("div",_e,[u("div",{class:H(["connection-result",g.value])},[u("div",we,[$(b(se),{icon:g.value==="available"?b(re):b(ne)},null,8,["icon"]),O(" "+B(g.value==="available"?"Connection Successful":"Connection Failed"),1)]),v.value?(I(),D("div",ye,B(v.value),1)):F("",!0)],2)])):F("",!0),u("div",Ce,[$(b(ce),{onClick:j,disabled:T.value,class:"primary-btn",expand:"block",fill:"solid"},{default:C(()=>[O(B(T.value?"Testing Connection...":"Test And Save Connection"),1)]),_:1},8,["disabled"])])])]),_:1})]),_:1})])])])]),_:1})]),_:1},8,["class"]))}}),Re=me(Pe,[["__scopeId","data-v-9cd15011"]]);export{Re as default};
