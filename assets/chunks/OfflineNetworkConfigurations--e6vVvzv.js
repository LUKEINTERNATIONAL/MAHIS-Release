import{d as oe,aV as te,c as u,r as d,cn as ae,d2 as se,cl as F,a as ne,O as re,f,J as v,e as m,m as h,l as s,k as a,u as t,bx as le,a3 as ce,bq as ie,p as P,L as _,K as p,cj as O,a4 as ue,a5 as de,Q as x,ck as fe,N as V,ed as ve,a6 as ge,U as me}from"./vendor-ChpUWbYC.js";import{a1 as he,aB as pe,aC as w,T as be,aD as ye,G as Ce,s as D,S as L,_ as _e}from"../index-gpdATzA9.js";import{u as we}from"./useNetworkConfig-FMNgwYIm.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-Cj7xBElI.js";const Se={key:0,class:"spinner-overlay"},ke={class:"positionCenter"},Te={class:"card_content"},Pe={class:"card_header_main"},De={key:0,class:"connection-status-section"},Ie={class:"status-indicator"},Ne={key:0,class:"timestamp"},Fe={class:"action-buttons"},xe={key:0,style:{"font-size":"0.8rem","margin-left":"8px"}},Ue={class:"help-text"},U="network_last_test_result",Be=oe({__name:"OfflineNetworkConfigurations",setup(Ae){const b=he(),{config:g,isConfigured:$e}=te(b),y=u(()=>g.value.configSource),S=d(!1),k=d(!1),n=d(null),c=d(null);d(!0);const l=d(null),i=d("none"),I=we(),{formRef:q,getFormValues:B}=pe();u(()=>b.config);const H=u(()=>[{componentType:"inputField",header:"Username",name:"couchdbUsername",value:g.value.couchdbUsername,validation:w.required,grid:{s:"6"}},{componentType:"inputField",header:"Password",name:"couchdbPassword",type:"password",value:g.value.couchdbPassword,validation:w.required,grid:{s:"6"}},{componentType:"inputField",header:"IP Address",name:"couchdbHost",value:g.value.couchdbHost,validation:w.required,grid:{s:"6"}},{componentType:"inputField",header:"Port Number",name:"couchdbPort",value:g.value.couchdbPort,validation:w.required,grid:{s:"6"}},{componentType:"Heading",name:"Protocol",grid:{s:"4"}},{componentType:"radioButtonField",name:"couchdbProtocol",validation:w.required,type:"inline",grid:{s:"6"},value:g.value.couchdbProtocol,options:[{label:"https",value:"https"},{label:"http",value:"http"}]}]),R=u(()=>{const e=y.value||i.value;return e==="global_property"?"source-global":e==="local_storage"?"source-local":""}),z=u(()=>{const e=y.value||i.value;return e==="global_property"?ae:e==="local_storage"?se:F}),G=u(()=>{const e=y.value||i.value;return e==="global_property"?"Using Facility Default Configuration":e==="local_storage"?"Using Local Configuration":"No Configuration"}),J=u(()=>l.value?l.value.success?l.value.source==="global_property"?"Configuration loaded from facility settings. You can use these settings or modify them.":"Configuration loaded from your local storage.":"Please configure your network settings below.":""),j=async()=>{k.value=!0,n.value=null,c.value=null;try{const e=B(),{couchdbUsername:o,couchdbPassword:C,couchdbHost:N,couchdbPort:A,couchdbProtocol:$}=e;if(!o||!C||!N||!$)throw new Error("Please fill in all required fields");const Y=o.trim(),Q=C.trim(),W=N.trim(),X=$.trim(),Z=btoa("".concat(Y,":").concat(Q)),ee=A?":".concat(A):"",E="".concat(X,"://").concat(W).concat(ee);console.log("Testing connection to:",E);const T=await fetch("".concat(E,"/"),{method:"GET",headers:{Authorization:"Basic ".concat(Z),"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(T.ok){const r=await T.json();if(r.couchdb==="Welcome")n.value="available",c.value=new Date().toLocaleString(),localStorage.setItem(U,JSON.stringify({status:"available",timestamp:c.value,version:r.version})),Ce("Connected successfully! CouchDB version: ".concat(r.version),3e3);else throw new Error("Server responded but is not CouchDB")}else{let r="Connection failed";switch(T.status){case 401:r="Authentication failed - Invalid username or password";break;case 403:r="Access forbidden - Check user permissions";break;case 404:r="CouchDB server not found at this address";break;case 500:r="CouchDB server error";break;default:r="Connection failed with status: ".concat(T.status)}throw new Error(r)}}catch(e){console.error("Connection test failed:",e),n.value="error",c.value=new Date().toLocaleString(),localStorage.setItem(U,JSON.stringify({status:"error",timestamp:c.value,error:e.message})),e.name==="AbortError"||e.name==="TimeoutError"?D("Connection timeout - Check your network and server address",5e3):e.message.includes("fetch")?D("Network error - Cannot reach the server",5e3):D(e.message,5e3)}finally{k.value=!1}},M=async()=>{await(await me.create({header:"Save as Facility Default",message:"This will save the configuration for all users at this facility. Other users will automatically use these settings when they log in. Continue?",buttons:[{text:"Cancel",role:"cancel"},{text:"Save for All Users",handler:async()=>{S.value=!0;try{const o=B(),C={couchdbUsername:o.couchdbUsername,couchdbPassword:o.couchdbPassword,couchdbHost:o.couchdbHost,couchdbPort:o.couchdbPort||"",couchdbProtocol:o.couchdbProtocol,locationId:L.getUserLocationId(),facilityName:"",configuredBy:L.getUserName(),configuredAt:new Date().toISOString(),configSource:"global_property"};await I.saveAsGlobalProperty(C)&&(b.setConfig(C),i.value="global_property")}catch(o){console.error("Save error:",o),D("Failed to save facility configuration",3e3)}finally{S.value=!1}}}]})).present()},K=()=>{const e=localStorage.getItem(U);if(e)try{const o=JSON.parse(e);n.value=o.status,c.value=o.timestamp}catch(o){console.error("Failed to parse last test result:",o)}};return ne(async()=>{if(K(),b.isConfigured){console.log("Configuration already in store"),i.value=y.value||"local_storage",l.value={success:!0,source:y.value};return}const e=await I.autoDiscoverConfig();l.value=e,e.success&&e.config?(b.setConfig({...e.config,configSource:e.source}),i.value=e.source):i.value=I.getConfigSource()}),(e,o)=>(f(),re(t(ge),{class:P({loading:S.value})},{default:v(()=>[S.value?(f(),m("div",Se,[s(t(le),{name:"bubbles"}),o[0]||(o[0]=a("div",{class:"loading-text"},"Please wait...",-1))])):h("",!0),s(be),s(t(ce),{fullscreen:!0},{default:v(()=>[a("div",ke,[s(t(ie),{class:"registration_ion_card"},{default:v(()=>[a("div",Te,[a("div",Pe,[a("div",null,[o[1]||(o[1]=a("h2",{class:"card_hearder"},"Set Offline Network Configurations",-1)),i.value!=="none"?(f(),m("div",{key:0,class:P(["config-source-badge",R.value])},[s(t(_),{icon:z.value},null,8,["icon"]),a("span",null,p(G.value),1)],2)):h("",!0)])]),l.value?(f(),m("div",{key:0,class:P(["info-banner",l.value.success?"success":"warning"])},[s(t(_),{icon:l.value.success?t(O):t(F)},null,8,["icon"]),a("div",null,[a("strong",null,p(l.value.success?"Configuration Found!":"No Configuration Found"),1),a("p",null,p(J.value),1)])],2)):h("",!0),s(t(ue),null,{default:v(()=>[s(t(de),{size:"12"},{default:v(()=>[a("div",null,[s(ye,{formData:H.value,ref_key:"formRef",ref:q},null,8,["formData"]),n.value?(f(),m("div",De,[a("div",{class:P(["connection-result",n.value])},[a("div",Ie,[s(t(_),{icon:n.value==="available"?t(O):t(fe)},null,8,["icon"]),x(" "+p(n.value==="available"?"Connection Successful":"Connection Failed"),1)]),c.value?(f(),m("div",Ne,p(c.value),1)):h("",!0)],2)])):h("",!0),a("div",Fe,[s(t(V),{onClick:j,disabled:k.value,class:"primary-btn",expand:"block",fill:"solid"},{default:v(()=>[x(p(k.value?"Testing Connection...":"Test Connection"),1)]),_:1},8,["disabled"]),s(t(V),{onClick:M,class:"super-user-btn",expand:"block",fill:"solid",disabled:n.value!=="available"},{default:v(()=>[s(t(_),{icon:t(ve),slot:"start"},null,8,["icon"]),o[2]||(o[2]=x(" Save as Facility Default ",-1)),n.value!=="available"?(f(),m("span",xe," (Test connection first) ")):h("",!0)]),_:1},8,["disabled"])]),a("div",Ue,[s(t(_),{icon:t(F)},null,8,["icon"]),o[3]||(o[3]=a("p",null," Save this configuration as the facility default for other users to automatically use these settings when they log in. ",-1))])])]),_:1})]),_:1})])]),_:1})])]),_:1})]),_:1},8,["class"]))}}),He=_e(Be,[["__scopeId","data-v-e5323f06"]]);export{He as default};
