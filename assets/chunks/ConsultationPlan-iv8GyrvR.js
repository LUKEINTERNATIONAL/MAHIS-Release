import{d as Ee,an as Me,cG as ze,r as n,c as j,aU as p,a as He,w as r,O as q,f as F,J as E,l,e as Ve,m as K,k as d,u as y,bw as We,dv as $e,a3 as Ue,i as b,bL as Ge,v as D,a6 as Je,eF as Ye,b8 as P}from"./vendor-umexne7m.js";import{u as je,_ as qe,s as Ke,e as Xe,b as Ze}from"./useFormWizard-DVR8pS1M.js";import{u as Qe,aI as et,bV as tt,aK as at,d as st,aM as nt,a0 as ot,aX as it,bq as lt,bu as rt,aT as ut,T as ct,J as mt,G as S,s as _,ag as vt,aY as dt,H as M,aN as w,aP as X,bZ as Z,t as Q,S as pt,bI as ee,q as te,_ as ft}from"../index-wq8pjg4N.js";import{D as gt}from"./DemographicBar-CMSx84Ik.js";import{C as ht,b as bt,O as Dt}from"./OPDOutcome-DFrZbfNl.js";import{I as Pt,N as yt}from"./AHDWorkflow.vue_vue_type_script_setup_true_lang-B8i-WEkm.js";import{O as St}from"./OPDDiagnosis-CMydB2Dt.js";import{O as wt}from"./OPDPrintingModal-Bm592mvw.js";import{l as At}from"./lodash-NJiRuGo9.js";import{u as _t}from"./usePatientProfile-CUcejX0m.js";import"./drug_prescription_service-DQ9es4m9.js";import"./patient_diagnosis_service-CeDwDoAm.js";import"./apexcharts-BGuYrJTw.js";import"./LevelOfConsciousness.vue_vue_type_script_setup_true_lang-BfP46iks.js";import"./previousComplaints-CKziMvBC.js";import"./patient_complaints_service-WqmzSQw-.js";import"./DashBox-fky5MJGF.js";import"./BasicForm-5hJpTk0c.js";import"./DateInputField-DLc_KYfR.js";import"./formatServerData-CBjDuu2v.js";import"./LabOrdersList-DlZOC0IV.js";import"./group_validation-7p9C1GGP.js";import"./ncd_appointment_service-DtbkiMHl.js";import"./RadiologyStore-CRJqG8kV.js";import"./Registration-CqYk7pHy.js";import"./useLocation-CT7EPsRC.js";import"./vaccines_service-B3YbmHQ_.js";import"./sms_service-D84sYOUE.js";import"./EIRreportsStore-BeeJ2yFY.js";import"./Export-BsMCciJz.js";import"./useNeonatalEnrollmentStore-D4lLwqRb.js";import"./enrollment-DU-PLRUa.js";const Tt={key:0,class:"spinner-overlay"},Ct={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},It={class:"back_profile"},xt=Ee({__name:"ConsultationPlan",setup(Ot){const{currentTabIndex:u}=je(),{printVisitSummary:ae}=_t(),f=Me(),se=ze(),T=n(!1),C=n(!0),z=n(!1),I=n(!1),x=n(!0),ne=n(!1),O=n(!1),oe=n(!1),H=Qe(),ie=et(),le=tt(),re=at(),ue=st(),V=nt(),ce=ot(),me=it(),ve=lt(),de=rt(),N=n(!1),h=n(!1),W=j(()=>({text:h.value?"Saving...":"Finish",icon:h.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:N.value||h.value})),{patient:c}=p(H),{investigations:pe}=p(ie),{OPDdiagnosis:fe}=p(le),{selectedMedicalDrugsList:ge,nonPharmalogicalTherapyAndOtherNotes:Nt}=p(re),{OPDActivities:A}=p(ue),{outcomes:he}=p(V),{currentSelectedNextAppointmentDate:be}=p(ve),{presentingComplaints:De}=p(de),{vitals:Pe}=p(me),ye=ut(),$=j(()=>ye.selectedMedicalAllergiesList),U=n(null),Se=n(null),G=n(null),we=n(null),Ae=n(null),_e=n(null),k=n(null),J=()=>A.value.map(e=>({title:e,icon:""})),a=n(),Te=n({}),Ce=async(e,t,i)=>{t===0&&await Ne(),await Y()&&(await m(),e%1===0&&(u.value=e),k.value&&i&&k.value.changeTab(e))},g=()=>{var i;if(!a.value||a.value.length===0)return null;const e=u.value>=0&&u.value<a.value.length?u.value:0;switch((i=a.value[e])==null?void 0:i.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(A.value.length>0)switch(A.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Ie=()=>{f.push("home")},xe=async()=>{I.value=!0,S("Printing consultation summary... Please wait.");try{await ae(),S("Consultation summary printed successfully!"),setTimeout(()=>{f.push("home")},3500)}catch(e){_("Failed to print consultation summary.")}finally{I.value=!1}},Oe=()=>{S("Patient has finished consultation!"),f.push("home")},Y=async()=>{const e=await vt.getObsByEncounterIdAndDate(dt.PRESENTING_COMPLAINTS);return!!(e&&e.length>0)},m=async()=>{var t,i;const e=M.sessionDate();for(let o=0;o<a.value.length;o++)if(!await Y())C.value=!1,a.value[o].title!=="Clinical Assessment"&&(a.value[o].icon=Ye);else{C.value=!0,z.value=!1;const v=a.value[o];if(Te.value={title:"Untitled"},v.title==="Clinical Assessment"){const s=w("presentingComplaints");a.value[o].icon=R(e,s)?P:""}else if(v.title==="Investigations"){const s=(i=(t=c.value)==null?void 0:t.labOrders)==null?void 0:i.saved,L=s==null?void 0:s.filter(Fe=>M.toStandardHisFormat(e)===M.toStandardHisFormat(Fe.order_date));a.value[o].icon=(L==null?void 0:L.length)>0?P:""}else if(v.title==="Diagnosis"){const s=w("diagnosis");a.value[o].icon=R(e,s)?P:""}else if(v.title==="Treatment Plan"){const s=w("treatment");a.value[o].icon=(s==null?void 0:s.length)>0?P:""}else if(v.title==="Next Appointment"){const s=w("appointments");a.value[o].icon=R(e,s)?P:""}else if(v.title==="Outcome"){const s=w("outcomes");a.value[o].icon=(s==null?void 0:s.length)>0?P:""}}B()},R=(e,t)=>{if(!t)return!1;const i=new Date(e);return i.setHours(0,0,0,0),t.some(o=>{const v=new Date(o.obs_datetime||o.order_date);return v.setHours(0,0,0,0),v.getTime()===i.getTime()})},Ne=async()=>{var e;T.value=!0;try{await ke(),await Promise.all([(e=U.value)==null?void 0:e.onSubmit()]),await X(c.value),Z()}catch(t){throw _("Failed to save clinical assessment"),t}finally{T.value=!1}},ke=async()=>{try{if(!At.isEmpty($.value)){const e=Be(),t=await Ke(e);H.setPatientRecord(t)}}catch(e){console.error("Failed to save allergies:",e),Q("Failed to save allergies")}},Re=async()=>{try{const e=await Xe();c.value=Object.assign(c.value,e);const t=await Ze().saveNonPharmaTherapyPatientData();c.value=Object.assign(c.value,t)}catch(e){Q("Failed to save treatment plan")}},Be=()=>$.value.map(e=>({concept_id:e.concept_id,obs_datetime:pt.getSessionDate(),value_coded:e.concept_id,location_id:ce.facilityLocation.code,value_text:e.name})),Le=async()=>{var e;try{h.value=!0,(e=G.value)==null||e.onSubmit(),await Re(),await V.saveOutcomPatientData(),await Z(),await X(c.value);const t=localStorage.getItem("locationID"),i=localStorage.getItem("userRoles");if(!t){_("Location ID could not be found. Please check your settings.");return}(i?JSON.parse(i):[]).some(s=>s.role==="Lab")?(await ee.addPatientToStage(c.value,"CONSULTATION"),await te().refresh(t),await f.push("home"),S("Lab results submitted. Patient can return to consultation")):(await ee.addPatientToStage(c.value,"DISPENSATION"),await te().refresh(t),await f.push("home"),S("Consultation patient saved successfully."))}catch(t){_("Failed to save consultation data"),await f.push("home")}finally{h.value=!1}};He(async()=>{if(A.value.length===0){await f.push("home");return}a.value=J(),await m(),(u.value===void 0||u.value<0)&&(u.value=0),N.value=!1,B()}),r(u,async()=>{await B()}),r(Pe,async()=>{await m()},{deep:!0}),r(c,async()=>{await m()},{deep:!0}),r(pe,async()=>{await m()},{deep:!0}),r(fe,async()=>{await m()},{deep:!0}),r(ge,async()=>{await m()},{deep:!0}),r(he,async()=>{await m()},{deep:!0}),r(be,async()=>{await m()}),r(De,async()=>{await m()},{deep:!0}),r(se,async()=>{x.value=!1,a.value=J(),setTimeout(()=>{u.value=0,x.value=!0},0)},{deep:!0}),r(oe,e=>{O.value=e,O.value&&setTimeout(()=>{O.value=!1},15e3)}),r(W,(e,t)=>{console.log("Done button options changed:",{from:t,to:e,currentStep:u.value,tabsLength:a.value.length}),e.disabled!==(t==null?void 0:t.disabled)&&console.log("Done button ".concat(e.disabled?"disabled":"enabled")),e.text!==(t==null?void 0:t.text)&&console.log('Done button text changed from "'.concat(t==null?void 0:t.text,'" to "').concat(e.text,'"'))},{deep:!0});const B=()=>{let e=!1;return g(),h.value&&(e=!0),N.value=e,!e};return(e,t)=>(F(),q(y(Je),null,{default:E(()=>[l(wt,{onYes:xe,onNo:Oe,isOpen:ne.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),T.value?(F(),Ve("div",Tt,[l(y(We),{name:"bubbles"}),t[2]||(t[2]=d("div",{class:"loading-text"},"Please wait...",-1))])):K("",!0),l(y($e),{"is-open":I.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(ct),l(y(Ue),{fullscreen:!0},{default:E(()=>[l(gt),d("div",Ct,[x.value?(F(),q(qe,{key:0,ref_key:"wizard",ref:k,headingTitle:"Consultation Plan","vertical-tabs":"","navigable-tabs":C.value,"scrollable-tabs":"",startIndex:0,doneButton:W.value,nextButton:{disabled:z.value},"custom-tabs":a.value,tabs:a.value,onChange:Ce,"onComplete:wizard":t[1]||(t[1]=i=>Le())},{default:E(()=>[d("div",null,[d("div",It,[l(mt,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:y(Ge),"font-weight":"600",onClick:t[0]||(t[0]=i=>Ie())},null,8,["icon"])])]),b(d("div",null,[l(ht,{ref_key:"clinicalAssessmentRef",ref:U},null,512)],512),[[D,g()==="ClinicalAssessment"]]),b(d("div",null,[l(Pt,{ref_key:"investigationsRef",ref:Se},null,512)],512),[[D,g()==="Investigations"]]),b(d("div",null,[l(St,{ref_key:"diagnosisRef",ref:G},null,512)],512),[[D,g()==="OPDDiagnosis"]]),b(d("div",null,[l(bt,{ref_key:"treatmentPlanRef",ref:we},null,512)],512),[[D,g()==="OPDTreatmentPlan"]]),b(d("div",null,[l(yt,{ref_key:"nextAppointmentRef",ref:Ae},null,512)],512),[[D,g()==="NextAppointment"]]),b(d("div",null,[l(Dt,{ref_key:"outcomeRef",ref:_e},null,512)],512),[[D,g()==="Outcome"]])]),_:1},8,["navigable-tabs","doneButton","nextButton","custom-tabs","tabs"])):K("",!0)])]),_:1})]),_:1}))}}),ca=ft(xt,[["__scopeId","data-v-dcbfb1eb"]]);export{ca as default};
