import{d as Wt,ap as Vt,cp as Et,r as n,c as Ht,b2 as f,a as zt,w as c,O as Q,f as E,J as H,l,e as Ut,m as Z,k as v,u as P,V as $t,dz as Gt,a4 as Yt,i as w,bM as tt,v as y,a7 as qt,eK as Jt,ba as b}from"./vendor-BuyqdZ53.js";import{u as Kt,_ as Xt,d as jt,a as Qt}from"./nonPharmaTherapyStore-DLCyzLX6.js";import{u as Zt,aK as te,bX as ee,aM as ae,d as ne,aO as se,b7 as oe,bE as ie,bp as le,T as re,J as et,G as S,s as g,ag as ce,aU as ue,H as z,aP as O,aR as at,bV as me,bH as U,q as I,t as nt,n as pe,_ as ve}from"../index-Wz3npakQ.js";import{D as de}from"./DemographicBar-CTlS-xyT.js";import{C as fe,b as ge,O as he}from"./OPDOutcome-5wBypDIe.js";import{I as De,N as Pe}from"./NextAppointment-ujXCgUrg.js";import{O as we}from"./OPDDiagnosis-G-rLZQKP.js";import{O as ye}from"./OPDPrintingModal-C_7njJhy.js";import{u as be}from"./usePatientProfile-B004Qmf1.js";import{u as Se}from"./useUserActivities-sD6uOqzI.js";import"./lodash-NJiRuGo9.js";import"./drug_prescription_service-CeT8wn5o.js";import"./patient_diagnosis_service-DFPfUzNj.js";import"./apexcharts-BQpaTz5X.js";import"./LevelOfConsciousness.vue_vue_type_script_setup_true_lang-ir-dgZnb.js";import"./previousComplaints-DhapZjcM.js";import"./patient_complaints_service-CKowY8FD.js";import"./DashBox-iXudeF3J.js";import"./BasicForm-B5n_HEV5.js";import"./DateInputField-NWQifQiC.js";import"./formatServerData-DP4xDOl3.js";import"./Outcome-Sa-e59ij.js";import"./wardsStore-BKADZ4vA.js";import"./LabOrdersList-Ce0Y5eWC.js";import"./group_validation-CdxhLV5A.js";import"./RadiologyStore-D9QtbdJH.js";import"./user_role_management-De8AiThb.js";import"./ncd_appointment_service-fNTaZY-f.js";import"./Registration-BkPVCsy2.js";import"./useLocation-lWCfFzGt.js";import"./vaccines_service-Bo6JVtnG.js";import"./sms_service-DlrC7VP-.js";import"./EIRreportsStore-Co6EtPhe.js";import"./Export-D8yZ0ZE0.js";import"./useNeonatalEnrollmentStore-CknJF5nL.js";import"./enrollment-DU-PLRUa.js";const Oe={key:0,class:"spinner-overlay"},Te={style:{width:"90vw",margin:"0 auto","margin-top":"10px"}},Ce={class:"back_profile"},Ae=Wt({__name:"ConsultationPlan",setup(Ie){const{currentTabIndex:u}=Kt(),{printVisitSummary:st}=be(),{hasWaitingList:T}=Se(),d=Vt(),ot=Et(),k=n(!1),_=n(!0),$=n(!1),N=n(!1),x=n(!0),it=n(!1),B=n(!1),lt=n(!1),rt=Zt(),ct=te(),ut=ee(),C=ae(),mt=ne(),G=se(),pt=oe(),vt=ie(),dt=le(),R=n(!1),h=n(!1),Y=Ht(()=>({text:h.value?"Saving...":"Finish",icon:h.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:R.value||h.value})),{patient:m}=f(rt),{investigations:ft}=f(ct),{OPDdiagnosis:gt}=f(ut),{selectedMedicalDrugsList:q}=f(C),{OPDActivities:A}=f(mt),{outcomes:ht}=f(G),{currentSelectedNextAppointmentDate:Dt}=f(vt),{presentingComplaints:Pt}=f(dt),{vitals:wt}=f(pt),J=n(null),L=n(null),K=n(null),yt=n(null),bt=n(null),St=n(null),F=n(null),a=n(),X=()=>A.value.map(t=>({title:t,icon:""})),Ot=async(t,e,o)=>{var r;if(e===0&&await kt(),!await j())return;await p(),t%1===0&&(u.value=t),F.value&&o&&F.value.changeTab(t),((r=a.value[t])==null?void 0:r.title)==="Investigations"&&L.value&&await L.value.openAHDModal()},D=()=>{var o;if(!a.value||a.value.length===0)return null;const t=u.value>=0&&u.value<a.value.length?u.value:0;switch((o=a.value[t])==null?void 0:o.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(A.value.length>0)switch(A.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Tt=()=>{d.push("home")},Ct=()=>{d.push("patientProfile")},At=async()=>{N.value=!0,S("Printing consultation summary... Please wait.");try{await st(),S("Consultation summary printed successfully!"),setTimeout(()=>{d.push("home")},3500)}catch(t){g("Failed to print consultation summary.")}finally{N.value=!1}},It=()=>{S("Patient has finished consultation!"),d.push("home")},j=async()=>{const t=await ce.getObsByEncounterIdAndDate(ue.PRESENTING_COMPLAINTS);return!!(t&&t.length>0)},p=async()=>{var e,o;const t=z.sessionDate();for(let i=0;i<a.value.length;i++)if(!await j())_.value=!1,a.value[i].title!=="Clinical Assessment"&&(a.value[i].icon=Jt);else{_.value=!0,$.value=!1;const r=a.value[i];if(r.title==="Clinical Assessment"){const s=O("presentingComplaints");a.value[i].icon=M(t,s)?b:""}else if(r.title==="Investigations"){const s=(o=(e=m.value)==null?void 0:e.labOrders)==null?void 0:o.saved,V=s==null?void 0:s.filter(Mt=>z.toStandardHisFormat(t)===z.toStandardHisFormat(Mt.order_date));a.value[i].icon=(V==null?void 0:V.length)>0?b:""}else if(r.title==="Diagnosis"){const s=O("diagnosis");a.value[i].icon=M(t,s)?b:""}else if(r.title==="Treatment Plan"){const s=O("treatment");a.value[i].icon=(s==null?void 0:s.length)>0?b:""}else if(r.title==="Next Appointment"){const s=O("appointments");a.value[i].icon=M(t,s)?b:""}else if(r.title==="Outcome"){const s=O("outcomes");a.value[i].icon=(s==null?void 0:s.length)>0?b:""}}W()},M=(t,e)=>{if(!e)return!1;const o=new Date(t);return o.setHours(0,0,0,0),e.some(i=>{const r=new Date(i.obs_datetime||i.order_date);return r.setHours(0,0,0,0),r.getTime()===o.getTime()})},kt=async()=>{var t;k.value=!0;try{await Promise.all([(t=J.value)==null?void 0:t.onSubmit()]),await at(m.value),me()}catch(e){throw g("Failed to save clinical assessment"),e}finally{k.value=!1}},_t=async()=>{try{const t=await jt();m.value={...m.value,...t},await Qt().saveNonPharmaTherapyPatientData()}catch(t){nt("Failed to save treatment plan")}},Nt=()=>{const t=q.value;return console.log("Checking prescribed medications:",{medicationsCount:t.length,medications:t}),t.length>0},xt=async()=>{var t;try{h.value=!0,await((t=K.value)==null?void 0:t.onSubmit()),await _t(),await G.saveOutcomPatientData(),await at(m.value);const e=localStorage.getItem("locationID");if(!e){g("Location ID missing.");return}const o=Nt();if(T("Waiting for Laboratory")){await Rt(e),S("Patient moved to Consultation for Lab follow-up.");return}if(o&&T("Waiting for Consultation")){T("Waiting for Dispensation")?await Bt(e):await Lt(e);return}if(!o&&T("Waiting for Consultation")){await Ft(e);return}}catch(e){g("Failed to save consultation.")}finally{h.value=!1}},Bt=async t=>{try{await U.addPatientToStage(m.value,"DISPENSATION"),await I().refresh(t),C.clearSelectedMedicalDrugsList(),S("Patient moved to Dispensation."),d.push("home")}catch(e){throw g("Failed to move patient to dispensation"),e}},Rt=async t=>{try{await U.addPatientToStage(m.value,"CONSULTATION"),await I().refresh(t),C.clearSelectedMedicalDrugsList(),d.push("home")}catch(e){throw g("Failed to move patient to consultation"),e}},Lt=async t=>{try{await U.addPatientToStage(m.value,"DISPENSATION"),await I().refresh(t),C.clearSelectedMedicalDrugsList(),nt("Patient moved to dispensation queue. You lack access to dispense."),d.push("home")}catch(e){throw g("Failed to move patient to dispensation"),e}},Ft=async t=>{try{await pe(m.value),await I().refresh(t),d.push("home")}catch(e){console.error("Failed to close visit:",e),g("Failed to close visit.")}};zt(async()=>{if(A.value.length===0){await d.push("home");return}a.value=X(),await p(),(u.value===void 0||u.value<0)&&(u.value=0),R.value=!1,W()}),c(u,async()=>{await W()}),c(wt,async()=>{await p()},{deep:!0}),c(m,async()=>{await p()},{deep:!0}),c(ft,async()=>{await p()},{deep:!0}),c(gt,async()=>{await p()},{deep:!0}),c(q,async()=>{await p()},{deep:!0}),c(ht,async()=>{await p()},{deep:!0}),c(Dt,async()=>{await p()}),c(Pt,async()=>{await p()},{deep:!0}),c(ot,async()=>{x.value=!1,a.value=X(),setTimeout(()=>{u.value=0,x.value=!0},0)},{deep:!0}),c(lt,t=>{B.value=t,B.value&&setTimeout(()=>{B.value=!1},15e3)}),c(Y,(t,e)=>{console.log("Done button options changed:",{from:e,to:t,currentStep:u.value,tabsLength:a.value.length})},{deep:!0});const W=()=>{let t=!1;return h.value&&(t=!0),R.value=t,!t};return(t,e)=>(E(),Q(P(qt),null,{default:H(()=>[l(ye,{onYes:At,onNo:It,isOpen:it.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),k.value?(E(),Ut("div",Oe,[l(P($t),{name:"bubbles"}),e[3]||(e[3]=v("div",{class:"loading-text"},"Please wait...",-1))])):Z("",!0),l(P(Gt),{"is-open":N.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(re),l(P(Yt),{fullscreen:!0},{default:H(()=>[l(de),v("div",Te,[x.value?(E(),Q(Xt,{key:0,ref_key:"wizard",ref:F,headingTitle:"Consultation Plan","vertical-tabs":"","navigable-tabs":_.value,"scrollable-tabs":"",startIndex:0,doneButton:Y.value,nextButton:{disabled:$.value},"custom-tabs":a.value,tabs:a.value,onChange:Ot,"onComplete:wizard":e[2]||(e[2]=o=>xt())},{default:H(()=>[v("div",null,[v("div",Ce,[l(et,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:P(tt),"font-weight":"600",onClick:e[0]||(e[0]=o=>Tt())},null,8,["icon"]),l(et,{name:"Back to Profile",iconSlot:"start",fill:"clear",icon:P(tt),"font-weight":"600",onClick:e[1]||(e[1]=o=>Ct()),style:{"margin-left":"15px"}},null,8,["icon"])])]),w(v("div",null,[l(fe,{ref_key:"clinicalAssessmentRef",ref:J},null,512)],512),[[y,D()==="ClinicalAssessment"]]),w(v("div",null,[l(De,{ref_key:"investigationsRef",ref:L},null,512)],512),[[y,D()==="Investigations"]]),w(v("div",null,[l(we,{ref_key:"diagnosisRef",ref:K},null,512)],512),[[y,D()==="OPDDiagnosis"]]),w(v("div",null,[l(ge,{ref_key:"treatmentPlanRef",ref:yt},null,512)],512),[[y,D()==="OPDTreatmentPlan"]]),w(v("div",null,[l(Pe,{ref_key:"nextAppointmentRef",ref:bt},null,512)],512),[[y,D()==="NextAppointment"]]),w(v("div",null,[l(he,{ref_key:"outcomeRef",ref:St},null,512)],512),[[y,D()==="Outcome"]])]),_:1},8,["navigable-tabs","doneButton","nextButton","custom-tabs","tabs"])):Z("",!0)])]),_:1})]),_:1}))}}),ma=ve(Ae,[["__scopeId","data-v-146b079a"]]);export{ma as default};
