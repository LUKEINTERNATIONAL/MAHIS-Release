var V=Object.defineProperty;var L=(t,e,a)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var p=(t,e,a)=>L(t,typeof e!="symbol"?e+"":e,a);import{D as E,aV as y}from"./vendor-BthE7zCk.js";import{l as v}from"./lodash-NJiRuGo9.js";import{b2 as I,u as f,af as C,S as m,E as k,H as h,aQ as U,bq as H,P as $,a7 as R,G as _,t as S,aJ as O,aK as P,a0 as j}from"../index-DWFSpzOY.js";import{g as z,D as T,a as D}from"./drug_prescription_service-B-PJMTVJ.js";import{P as J}from"./patient_diagnosis_service-BF_YAU7A.js";const b=[{isFinishBtn:!1,validationStatus:"",sectionHeader:"Visual acuity test",data:{rowData:[{colData:[{inputHeader:"Left Eye",value:"",name:"Left eye visual acuity",required:!0,eventType:"input",alertsErrorMassage:"",disabled:!1,validationFunctionName:"",valueType:"text"},{inputHeader:"Right Eye",value:"",name:"Right eye visual acuity",required:!0,eventType:"input",alertsErrorMassage:"",disabled:!1,validationFunctionName:"",valueType:"text"}]}]}}],M=[{selectedData:[],classDash:"dashed_bottom_border",groupedRadioBtnContent:{groupedData:[{header:{selectedValue:"",name:"Peripheral neuropathy"},data:[{name:"Neuropathy/PVO",labelPlacement:"start",colSize:"3",justify:"space-between",header:!0,headClassName:"bold"},{name:"Yes",value:"Yes",checked:!1,colSize:"3",justify:"end"},{name:"No",value:"No",checked:!1,colSize:"3",justify:"end"}]}]}},{selectedData:[],classDash:"dashed_bottom_border",groupedRadioBtnContent:{groupedData:[{header:{selectedValue:"",name:"Deformity"},data:[{name:"Deformities",labelPlacement:"start",colSize:"3",justify:"space-between",header:!0,headClassName:"bold"},{name:"Yes",value:"Yes",checked:!1,colSize:"3",justify:"end"},{name:"No",value:"No",checked:!1,colSize:"3",justify:"end"}]}]}},{selectedData:[],classDash:"dashed_bottom_border",groupedRadioBtnContent:{groupedData:[{header:{selectedValue:"",name:"Ulcers"},data:[{name:"Ulcers",labelPlacement:"start",colSize:"3",justify:"space-between",header:!0,headClassName:"bold"},{name:"Yes",value:"Yes",checked:!1,colSize:"3",justify:"end"},{name:"No",value:"No",checked:!1,colSize:"3",justify:"end"}]}]}}],w=[{isFinishBtn:!1,validationStatus:"",sectionHeader:"CV Risk %",data:{rowData:[{colData:[{inputHeader:"",value:"",name:"CVD",required:!0,eventType:"input",alertsErrorMassage:"",disabled:!1,valueType:"text",validationFunctionName:"isNumber"}]}]}}],oe=E("complicationsStore",{state:()=>({visualScreening:[...b],FootScreening:[...M],cvScreening:[...w]}),actions:{setCvScreening(t){this.cvScreening=t},setVisualScreening(t){this.visualScreening=t},setFootScreening(t){this.FootScreening=t},getInitialCvScreening(){return[...v.cloneDeep(w)]},getInitialVisualScreening(){return[...v.cloneDeep(b)]},getInitialFootScreening(){return[...v.cloneDeep(M)]},resetScreening(){this.setCvScreening(this.getInitialCvScreening()),this.setFootScreening(this.getInitialFootScreening()),this.setVisualScreening(this.getInitialVisualScreening())}},persist:!0});class Y extends I{constructor(e,a){super(e,105,a)}}class B extends I{constructor(e,a){super(e,25,a)}static async get_____(e="",a=1,n=10){}}async function ce(t){var e,a,n;try{const s=f(),{patient:i}=y(s),r=JSON.parse(JSON.stringify(i.value));return(n=(a=(e=r.allergies)!=null?e:r.allergies={}).unsaved)!=null||(a.unsaved=[]),r.allergies.unsaved.push(...t),_("Allergies appended to patient record successfully"),r}catch(s){S("Unable to save Allegies!")}}class de{async onSubmitNotes(e,a,n){const s=new Y(e,a);await s.createEncounter(),await s.saveObservationList(n)}async onSubmitAllergies(e,a,n){try{const s=new B(e,a);await s.createEncounter(),await s.saveObservationList(n),_("Allergies saved successfully")}catch(s){console.error("Error saving allergies:",s),S("Failed to save allergies")}}}class le{constructor(){p(this,"programID");p(this,"providerID");p(this,"patientID");p(this,"date");p(this,"demographics");p(this,"previousDrugPrescriptions",[]);p(this,"previousClinicalNotes");p(this,"previousDrugAllergies");const e=f();this.demographics=e.patient,this.patientID=this.demographics.patientID,this.date=C.getSessionDate(),this.providerID=m.getUserID(),this.programID=C.getProgramID(),this.previousClinicalNotes={},this.previousDrugAllergies={}}async getPatientEncounters(){const e=await this.getPatientVisitDates(),a=e.map(async s=>{const i=s.value,r=await k.getEncounters(this.patientID,{date:i});await Promise.all(r.map(async o=>{var u;if(o.type.name=="NOTES"){const{observations:c}=o;v.isEmpty(c)||c.forEach(l=>{if(l.concept_id=="2688"){const g=h.toStandardHisDisplayFormat(l.obs_datetime);v.isEmpty(this.previousClinicalNotes.hasOwnProperty(g))&&(this.previousClinicalNotes[g]=[]),this.previousClinicalNotes[g].push({date:g,notes:l.value_text})}})}if(o.type.name=="TREATMENT"){const{observations:c}=o;if(!v.isEmpty(c))for(const l in c){let g="<UNKNOWN CONCEPT>";const d=c[l];try{(u=d==null?void 0:d.concept)!=null&&u.concept_names?g=d.concept.concept_names[0].name:g=await U.getConceptName(d.concept_id)}catch(A){console.error(d,A)}const x=await C.resolvePrimaryValue(d),N=h.toStandardHisDisplayFormat(d.date_created);g=="Allergic"&&(this.previousDrugAllergies.hasOwnProperty(N)||(this.previousDrugAllergies[N]=[]),this.previousDrugAllergies[N].push({date:N,value:x}))}}}))});await Promise.all(a);const n=e.map(async s=>{const i=await H.getOrderByPatient(this.patientID,{start_date:s.value});if(!v.isEmpty(i)){const r=i.map(o=>({drugName:o.drug.name,value:h.toStandardHisTimeFormat(o.order.start_date),dose:o.dose,frequency:z(o.frequency),prescription:h.toStandardHisFormat(o.order.auto_expire_date),duration:q(o.order.instructions),other:o}));this.previousDrugPrescriptions.push({prescriptionDate:h.toStandardHisDisplayFormat(s.value),previousPrescriptions:r})}});return await Promise.all(n),{previousDrugPrescriptions:this.previousDrugPrescriptions,previousClinicalNotes:this.previousClinicalNotes,previousDrugAllergies:this.previousDrugAllergies}}async getPatientVisitDates(){return(await $.getPatientVisits(this.patientID,!1)).map(e=>({label:h.toStandardHisDisplayFormat(e),value:e,other:{isActive:e===R.getSessionDate()}}))}}function q(t){const e=/(\d+)\s+days/i,a=t.match(e);return a&&a.length>1?parseInt(a[1]):null}async function ue(){const t=f(),{patient:e}=y(t),a=e.value,n=[8809,903,6410,6409],s="";let i;m.getLanConnectionStatus()||m.getPouchDbStatus()?i=await J.getDiagnosis(s,1,15):i=await m.getJson("diagnosis",{id:7409,page_size:2e3});const r=i.filter(d=>n.includes(d.concept_id));r.push({concept_id:8809,concept_name_id:926,concept_name_type:"FULLY_SPECIFIED",creator:1,date_created:"2004-06-25T00:00:00.000+02:00",date_voided:null,id:72,locale:"en",locale_preferred:0,name:"Hypertension",uuid:"b99faa1e-8d80-11d8-abbb-0024217bb78e",void_reason:null,voided:0,voided_by:null});const o=a.diagnosis.saved.map(d=>d.value_coded),u=a.diagnosis.unsaved.map(d=>d.value_coded),c=[...o,...u];return r.filter(d=>c.includes(d.concept_id)).map(d=>d.name)}async function ge(){var t,e,a;try{const n=f(),{patient:s}=y(n),i=W(),r=JSON.parse(JSON.stringify(s.value));if(i.length>0){(a=(e=(t=r.MedicationOrder)!=null?t:r.MedicationOrder={}).unsaved)!=null||(e.unsaved=[]);const o=r.MedicationOrder.unsaved.findIndex(c=>c.NCD_Drug_Orders);if(o>=0)r.MedicationOrder.unsaved[o].NCD_Drug_Orders=[...r.MedicationOrder.unsaved[o].NCD_Drug_Orders,...i];else{const c={NCD_Drug_Orders:i};r.MedicationOrder.unsaved.push(c)}const u=P();return u.setMedicationRunOutDate(Q()),u.clearMedicationDataStores(),_("Drug order(s) has been created"),r}else S("Unable to create drug orders!")}catch(n){S("Unable to create drug orders!")}}function pe(){try{const t=new Date(m.getSessionDate()),a=O().selectedMedicalDrugsList;let n=0;if(a.forEach(c=>{const l=parseInt(c.duration,10);!isNaN(l)&&l>n&&(n=l)}),n<=0)return{date:null,formattedDate:null};const s=new Date(t);s.setDate(t.getDate()+n);const i=String(s.getDate()).padStart(2,"0"),r=String(s.getMonth()+1).padStart(2,"0"),o=s.getFullYear(),u="".concat(i,"/").concat(r,"/").concat(o);return{date:s,formattedDate:u}}catch(t){return console.error("Error calculating OPD medication run out date:",t),{date:null,formattedDate:null}}}function Q(){try{const t=new Date(m.getSessionDate()),a=P().selectedNCDMedicationList;let n=0;if(a.forEach(c=>{const l=parseInt(c.duration,10);!isNaN(l)&&l>n&&(n=l)}),n<=0)return{date:null,formattedDate:null};const s=new Date(t);s.setDate(t.getDate()+n);const i=String(s.getDate()).padStart(2,"0"),r=String(s.getMonth()+1).padStart(2,"0"),o=s.getFullYear(),u="".concat(i,"/").concat(r,"/").concat(o);return{date:s,formattedDate:u}}catch(t){return console.error("Error calculating medication run out date:",t),{date:null,formattedDate:null}}}const W=()=>{const t=P();return t.selectedNCDMedicationList.map(e=>{e.frequency=t.frequency_selections[e.drug_id]||"",e.totalDosage=Object.values(e.dosage).reduce((s,i)=>s+Number(i),0);const a=T.getSessionDate(),n=X(e.drug_id);return{drug_inventory_id:e.drug_id,equivalent_daily_dose:e.totalDosage=="Unknown"?0:e.totalDosage*(n==null?void 0:n.value)||0,start_date:a,auto_expire_date:F(a,e.duration),units:e.units,instructions:"".concat(e.name," ").concat(e.totalDosage," ").concat(e.units," ").concat((n==null?void 0:n.code)||""," for ").concat(e.duration," days"),dose:G(e),frequency:(n==null?void 0:n.code)||""}})},G=t=>t.dose_strength!=null&&t.dose_strength?Math.trunc(t.dose_strength):1;async function De(){var t,e,a;try{const n=f(),{patient:s}=y(n),i=K(),r=JSON.parse(JSON.stringify(s.value));if(i.length>0){(a=(e=(t=r.MedicationOrder)!=null?t:r.MedicationOrder={}).unsaved)!=null||(e.unsaved=[]);const o=r.MedicationOrder.unsaved.findIndex(c=>c.NCD_Drug_Orders);if(o>=0)r.MedicationOrder.unsaved[o].NCD_Drug_Orders=[...r.MedicationOrder.unsaved[o].NCD_Drug_Orders,...i];else{const c={NCD_Drug_Orders:i};r.MedicationOrder.unsaved.push(c)}return O().clearSelectedMedicalDrugsList(),_("Drug order(s) has been created"),r}}catch(n){S("Unable to create drug orders!")}}const K=()=>O().selectedMedicalDrugsList.map(e=>{const a=T.getSessionDate(),n=D.find(s=>s.label===e.frequency)||{};return{drug_inventory_id:e.drug_id,equivalent_daily_dose:e.dose=="Unknown"?0:e.dose*(n==null?void 0:n.value)||0,start_date:a,auto_expire_date:F(a,e.duration),units:e.units,instructions:"".concat(e.drugName,": ").concat(e.dose," ").concat(e.units," ").concat((n==null?void 0:n.code)||""," for ").concat(e.duration," days"),dose:e.dose,frequency:(n==null?void 0:n.code)||""}}),X=t=>{const a=P().selectedNCDMedicationList.find(s=>s.drug_id===t);if(!a||!a.dosage)return null;switch(["morning","afternoon","evening"].reduce((s,i)=>s+(a.dosage[i]?1:0),0)){case 1:return a.dosage.morning?D.find(s=>s.code==="QAM"):a.dosage.afternoon?D.find(s=>s.code==="QNOON"):a.dosage.evening?D.find(s=>s.code==="QPM"):D.find(s=>s.code==="OD");case 2:return D.find(s=>s.code==="BD");case 3:return D.find(s=>s.code==="TDS");default:return D.find(s=>s.code==="Unknown")}},F=(t,e)=>{const a=new Date(t);return a.setDate(a.getDate()+parseInt(e)),h.toStandardHisFormat(a)},Z=()=>O().nonPharmalogicalTherapyAndOtherNotes,he=E("nonPharmaTherapyStore",{state:()=>({items:[{id:"wound-dressing",label:"Wound dressing",checked:!1},{id:"patient-education",label:"Patient education",checked:!1},{id:"counseling",label:"Counseling",checked:!1},{id:"minor-surgery",label:"Minor Surgery",checked:!1}],current_patient:{}}),actions:{async saveNonPharmaTherapyPatientData(){const t=j(),e=[];this.items.forEach(n=>{n.checked==!0&&e.push({concept_id:11023,value_text:n.label,obs_datetime:h.toStandardHisFormat(m.getSessionDate()),location_id:t.facilityLocation.code})});const a=Z();a&&e.push({concept_id:2592,obs_datetime:m.getSessionDate(),value_text:a,location_id:t.facilityLocation.code});try{if(e.length>0)return this.clearSelectednonPharmaTherapyStore(),_("Non Pharma Therapy staged successfully!"),await ee(e)}catch(n){S("Unable to update Non Pharma Therapy!")}},clearSelectednonPharmaTherapyStore(){this.items.forEach(t=>{t.checked=!1})},setCurrentPatient(t){this.current_patient=t}},persist:!0});async function ee(t){var e,a,n;try{const s=f(),{patient:i}=y(s),r=JSON.parse(JSON.stringify(i.value));return(n=(a=(e=r.notes)!=null?e:r.notes={}).unsaved)!=null||(a.unsaved=[]),r.notes.unsaved.push(...t),r}catch(s){S("Unable to create non pharmalogical notes!")}}export{le as P,de as T,he as a,pe as b,ge as c,De as d,ue as g,ce as s,oe as u};
