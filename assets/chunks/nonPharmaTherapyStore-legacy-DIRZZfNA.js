!function(){function e(e,t,a){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}System.register(["./vendor-legacy-D3PRHnoP.js","../index-legacy-C-l3iinE.js","./lodash-legacy-pOOc9Efu.js","./drug_prescription_service-legacy-Bpg_g_a9.js","./patient_diagnosis_service-legacy-DvUcPZBF.js"],function(t,a){"use strict";var n,i,o,s,r,l,d,c,u,p,g,v,f,h,b,y,m,D,w,_,S,T,N,P,O,x,k,I,C,$,B,M,E,j,q,F,A,L,U,H,z,J;return{setters:[e=>{n=e.d,i=e.c,o=e.H,s=e.e,r=e.f,l=e.m,d=e.k,c=e.p,u=e.j,p=e.l,g=e.K,v=e.r,f=e.w,h=e.a,b=e.F,y=e.P,m=e.O,D=e.u,w=e.J,_=e.n,S=e.aW,T=e.D},e=>{N=e.b1,P=e.u,O=e.af,x=e.S,k=e.E,I=e.H,C=e.aT,$=e.bF,B=e.P,M=e.a8,E=e.G,j=e.t,q=e.aL,F=e.aM,A=e.a1},e=>{L=e.l},e=>{U=e.g,H=e.D,z=e.a},e=>{J=e.P}],execute:function(){t({b:function(){try{const e=new Date(x.getSessionDate()),t=q().selectedMedicalDrugsList;let a=0;if(t.forEach(e=>{const t=parseInt(e.duration,10);!isNaN(t)&&t>a&&(a=t)}),a<=0)return{date:null,formattedDate:null};const n=new Date(e);n.setDate(e.getDate()+a);const i=String(n.getDate()).padStart(2,"0"),o=String(n.getMonth()+1).padStart(2,"0"),s=n.getFullYear();return{date:n,formattedDate:`${i}/${o}/${s}`}}catch(e){return console.error("Error calculating OPD medication run out date:",e),{date:null,formattedDate:null}}},c:async function(){try{const n=P(),{patient:i}=S(n),o=ce(),s=JSON.parse(JSON.stringify(i.value));if(o.length>0){var e,t,a;null!==(t=(e=null!==(a=s.MedicationOrder)&&void 0!==a?a:s.MedicationOrder={}).unsaved)&&void 0!==t||(e.unsaved=[]),s.MedicationOrder.unsaved=[...s.MedicationOrder.unsaved,...o];const n=F();return n.setMedicationRunOutDate(function(){try{const e=new Date(x.getSessionDate()),t=F().selectedNCDMedicationList;let a=0;if(t.forEach(e=>{const t=parseInt(e.duration,10);!isNaN(t)&&t>a&&(a=t)}),a<=0)return{date:null,formattedDate:null};const n=new Date(e);n.setDate(e.getDate()+a);const i=String(n.getDate()).padStart(2,"0"),o=String(n.getMonth()+1).padStart(2,"0"),s=n.getFullYear();return{date:n,formattedDate:`${i}/${o}/${s}`}}catch(e){return console.error("Error calculating medication run out date:",e),{date:null,formattedDate:null}}}()),n.clearMedicationDataStores(),E("Drug order(s) has been created"),s}j("Unable to create drug orders!")}catch(n){j("Unable to create drug orders!")}},d:async function(){try{const n=P(),{patient:i}=S(n),o=pe(),s=JSON.parse(JSON.stringify(i.value));var e,t,a;if(o.length>0)return null!==(t=(e=null!==(a=s.MedicationOrder)&&void 0!==a?a:s.MedicationOrder={}).unsaved)&&void 0!==t||(e.unsaved=[]),s.MedicationOrder.unsaved=[...s.MedicationOrder.unsaved,...o],E("Drug order(s) has been created"),s}catch(n){j("Unable to create drug orders!")}},g:async function(){const e=P(),{patient:t}=S(e),a=t.value,n=[8809,903,6410,6409];let i;i=x.getLanConnectionStatus()||x.getPouchDbStatus()?await J.getDiagnosis("",1,15):await x.getJson("diagnosis",{id:7409,page_size:2e3});const o=i.filter(e=>n.includes(e.concept_id));o.push({concept_id:8809,concept_name_id:926,concept_name_type:"FULLY_SPECIFIED",creator:1,date_created:"2004-06-25T00:00:00.000+02:00",date_voided:null,id:72,locale:"en",locale_preferred:0,name:"Hypertension",uuid:"b99faa1e-8d80-11d8-abbb-0024217bb78e",void_reason:null,voided:0,voided_by:null});const s=a.diagnosis.saved.map(e=>e.value_coded),r=a.diagnosis.unsaved.map(e=>e.value_coded),l=[...s,...r],d=o.filter(e=>l.includes(e.concept_id));return d.map(e=>e.name)},s:async function(e){try{var t,a,n;const i=P(),{patient:o}=S(i),s=JSON.parse(JSON.stringify(o.value));return null!==(a=(t=null!==(n=s.allergies)&&void 0!==n?n:s.allergies={}).unsaved)&&void 0!==a||(t.unsaved=[]),s.allergies.unsaved.push(...e),E("Allergies appended to patient record successfully"),s}catch(i){j("Unable to save Allegies!")}}});const a={class:"fw-list-wrapper"},W=["id"],V={class:"fw-step-container"},Y={key:0},Q={key:1},K=n({__name:"WizardStep",props:{tab:{type:Object,default:()=>{}},index:{type:Number,default:0},currentIndex:{type:Number,default:0},squaredTab:{type:Boolean,default:!1},showProgress:{type:Boolean,default:!0}},setup(e){const t=e,n=i(()=>t.currentIndex>t.index);i(()=>`pi pi-${t.tab.icon}`);const v=i(()=>["fw-list-wrapper-icon",{"fw-step-active":t.tab.active,"fw-step-checked":t.tab.checked,"fw-squared-tab":t.squaredTab}]);return(t,i)=>{const f=o("ion-icon");return r(),s("li",null,[e.showProgress?(r(),s("div",{key:0,class:c(["fw-list-progress",{"fw-list-progress-active":n.value}])},null,2)):l("",!0),d("div",a,[d("div",{id:`step-${e.tab.id}`,role:"tab",class:c(v.value)},[d("div",V,[u(t.$slots,"active-step",{},()=>[e.tab.icon?(r(),s("i",Y,[p(f,{icon:e.tab.icon,style:{"font-size":"16px"}},null,8,["icon"])])):(r(),s("i",Q,g(e.index+1),1))])])],10,W),u(t.$slots,"title",{},()=>[d("span",{class:c(["fw-step-title",{active:e.tab.active}])},g(e.tab.title),3)])])])}}}),R=["disabled"],G={key:0},X=n({__name:"Button",props:{options:{type:Object,default:function(){return{}}}},setup(e){const t=e,a=i(()=>["fw-btn",{"fw-btn-disabled":t.options.disabled}]);return(t,n)=>{return r(),s("button",{class:c(a.value),disabled:e.options.disabled},[e.options.hideText?l("",!0):(r(),s("span",G,g(e.options.text),1)),e.options.hideIcon?l("",!0):(r(),s("i",{key:1,class:c((i=e.options.icon,`pi pi-${i}`))},null,2))],10,R);var i}}}),Z=["id"],ee={key:0,class:"fw-body-list",role:"tablist"},te={class:"fw-body"},ae={class:"fw-body-content"},ne={class:"fw-body-container"},ie={key:0,class:"fw-footer"},oe={class:"fw-footer-left"},se={class:"fw-footer-right"};t("_",n({__name:"Wizard",props:{id:{type:String,default:"fw-"+(new Date).valueOf()},headingTitle:{type:String,default:""},customTabs:{type:Array,default:()=>[{id:0,title:"Step 1",icon:"map"},{id:1,title:"Step 2",icon:"check"},{id:2,title:"Step 3",icon:"pencil"}]},nextButton:{type:Object,default:function(){return{}}},backButton:{type:Object,default:function(){return{}}},doneButton:{type:Object,default:function(){return{}}},hideButtons:{type:Boolean,default:!1},startIndex:{type:Number,default:0,validator:e=>e>=0},verticalTabs:{type:Boolean,default:!1},beforeChange:{type:Function,default:()=>{}},beforeMount:{type:Function,default:()=>{}},navigableTabs:{type:Boolean,default:!1},scrollableTabs:{type:Boolean,default:!1},cardBackground:{type:Boolean,default:!1},squaredTabs:{type:Boolean,default:!1},showProgress:{type:Boolean,default:!0},showWizard:{type:Boolean,default:!0}},emits:["change","complete:wizard","updated:tabs","onValidateTabs","done-button-changed"],setup(e,{expose:t,emit:a}){const n=a,o=e;let S=v(0);const T=i(()=>[...o.customTabs].map((e,t)=>({...e,checked:t<S.value,active:t===S.value}))),N=i(()=>T.value.length-1),P=i(()=>Object.assign({text:"Back",icon:"arrow-left",hideText:!1,hideIcon:!1,disabled:!1},o.backButton)),O=i(()=>Object.assign({text:"Next",icon:"arrow-right",hideText:!1,hideIcon:!1,disabled:!1},o.nextButton)),x=i(()=>Object.assign({text:"Done",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},o.doneButton));f(()=>o.doneButton,(e,t)=>{n("done-button-changed",{newOptions:x.value,oldOptions:t?Object.assign({text:"Done",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},t):null,currentTabIndex:S.value,isLastStep:I.value})},{deep:!0,immediate:!1}),f(x,(e,t)=>{console.log("Done button options changed:",{new:e,old:t,currentStep:S.value})},{deep:!0}),h(()=>{S.value=o.startIndex,$(),n("change",S.value)});const k=i(()=>0!==S.value),I=i(()=>S.value===N.value),C=i(()=>["form-wizard-vue",{"fw-vertical":o.verticalTabs},{"fw-overflow-scroll":o.scrollableTabs},{"fw-card":o.cardBackground}]),$=()=>{n("updated:tabs",T.value,S.value)},B=async()=>{if(S.value===N.value)return void(x.value.disabled||E());if(O.value.disabled)return;const e=S.value+1,t=S.value;o.navigableTabs?(n("change",e,t),await o.beforeChange(),q(e)):n("change",e,t,!0)},M=async()=>{if(0===S.value||P.value.disabled)return;const e=S.value-1,t=S.value;n("change",e,t),await o.beforeChange(),q(e)},E=()=>{const e=S.value,t=S.value-1;n("complete:wizard",e,t)},j=async e=>{if(!o.navigableTabs)return;const t=e,a=S.value;n("change",t,a),await o.beforeChange(),q(t)},q=async e=>{S.value=e,$(),await _(),await o.beforeMount()};return t({changeTab:q}),(t,a)=>(r(),s("div",{id:e.id,class:c(C.value)},[e.showWizard?(r(),s("ul",ee,[d("h4",null,g(e.headingTitle),1),(r(!0),s(b,null,y(T.value,(a,n)=>u(t.$slots,"wizard-step",{tab:a,index:n,navigateToTab:j},()=>[(r(),m(K,{key:a.id,tab:a,index:n,currentIndex:D(S),squaredTab:e.squaredTabs,showProgress:e.showProgress,onClick:e=>j(n)},{"active-step":w(()=>[u(t.$slots,"active-step")]),title:w(()=>[u(t.$slots,"title")]),_:3},8,["tab","index","currentIndex","squaredTab","showProgress","onClick"]))])),256))])):l("",!0),d("div",te,[d("div",ae,[d("div",ne,[u(t.$slots,"default")])]),e.hideButtons?l("",!0):(r(),s("div",ie,[u(t.$slots,"footer",{},()=>[d("div",oe,[k.value?(r(),s("span",{key:0,role:"button",onClick:M},[u(t.$slots,"back",{},()=>[p(X,{options:P.value},null,8,["options"])])])):l("",!0),u(t.$slots,"custom-buttons-left")]),d("div",se,[u(t.$slots,"custom-buttons-right"),I.value?(r(),s("span",{key:0,role:"button",onClick:B},[u(t.$slots,"done",{},()=>[p(X,{options:x.value},null,8,["options"])])])):(r(),s("div",{key:1,role:"button",onClick:B},[u(t.$slots,"next",{},()=>[p(X,{options:O.value},null,8,["options"])])]))])])]))])],10,Z))}})),t("u",()=>{const e=v(""),t=t=>{t%1==0&&(e.value=t)};return{currentTabIndex:e,onChangeCurrentTab:t,onTabBeforeChange:a=>{0===e.value&&console.log("First Tab"),t(a)},changeBtnIconPosition:()=>{_(()=>{const e=document.querySelector(".fw-footer-left .fw-btn");if(!e)return;const t=e.querySelector("span"),a=e.querySelector("i");t&&a&&(e.removeChild(t),e.removeChild(a),e.appendChild(a),e.appendChild(t))})}}});class re extends N{constructor(e,t){super(e,105,t)}}class le extends N{constructor(e,t){super(e,25,t)}static async get_____(e="",t=1,a=10){}}t("T",class{async onSubmitNotes(e,t,a){const n=new re(e,t);await n.createEncounter(),await n.saveObservationList(a)}async onSubmitAllergies(e,t,a){try{const n=new le(e,t);await n.createEncounter(),await n.saveObservationList(a),E("Allergies saved successfully")}catch(n){console.error("Error saving allergies:",n),j("Failed to save allergies")}}});function de(e){const t=e.match(/(\d+)\s+days/i);return t&&t.length>1?parseInt(t[1]):null}t("P",class{constructor(){e(this,"programID",void 0),e(this,"providerID",void 0),e(this,"patientID",void 0),e(this,"date",void 0),e(this,"demographics",void 0),e(this,"previousDrugPrescriptions",[]),e(this,"previousClinicalNotes",void 0),e(this,"previousDrugAllergies",void 0);const t=P();this.demographics=t.patient,this.patientID=this.demographics.patientID,this.date=O.getSessionDate(),this.providerID=x.getUserID(),this.programID=O.getProgramID(),this.previousClinicalNotes={},this.previousDrugAllergies={}}async getPatientEncounters(){const e=await this.getPatientVisitDates(),t=e.map(async e=>{const t=e.value,a=await k.getEncounters(this.patientID,{date:t});await Promise.all(a.map(async e=>{if("NOTES"==e.type.name){const{observations:t}=e;L.isEmpty(t)||t.forEach(e=>{if("2688"==e.concept_id){const t=I.toStandardHisDisplayFormat(e.obs_datetime);L.isEmpty(this.previousClinicalNotes.hasOwnProperty(t))&&(this.previousClinicalNotes[t]=[]),this.previousClinicalNotes[t].push({date:t,notes:e.value_text})}})}if("TREATMENT"==e.type.name){const{observations:n}=e;if(!L.isEmpty(n))for(const e in n){let i="<UNKNOWN CONCEPT>";const o=n[e];try{var t;i=null!=o&&null!==(t=o.concept)&&void 0!==t&&t.concept_names?o.concept.concept_names[0].name:await C.getConceptName(o.concept_id)}catch(a){console.error(o,a)}const s=await O.resolvePrimaryValue(o),r=I.toStandardHisDisplayFormat(o.date_created);"Allergic"==i&&(this.previousDrugAllergies.hasOwnProperty(r)||(this.previousDrugAllergies[r]=[]),this.previousDrugAllergies[r].push({date:r,value:s}))}}}))});await Promise.all(t);const a=e.map(async e=>{const t=await $.getOrderByPatient(this.patientID,{start_date:e.value});if(!L.isEmpty(t)){const a=t.map(e=>({drugName:e.drug.name,value:I.toStandardHisTimeFormat(e.order.start_date),dose:e.dose,frequency:U(e.frequency),prescription:I.toStandardHisFormat(e.order.auto_expire_date),duration:de(e.order.instructions),other:e}));this.previousDrugPrescriptions.push({prescriptionDate:I.toStandardHisDisplayFormat(e.value),previousPrescriptions:a})}});return await Promise.all(a),{previousDrugPrescriptions:this.previousDrugPrescriptions,previousClinicalNotes:this.previousClinicalNotes,previousDrugAllergies:this.previousDrugAllergies}}async getPatientVisitDates(){return(await B.getPatientVisits(this.patientID,!1)).map(e=>({label:I.toStandardHisDisplayFormat(e),value:e,other:{isActive:e===M.getSessionDate()}}))}});const ce=()=>{const e=F();return e.selectedNCDMedicationList.map(t=>{t.frequency=e.frequency_selections[t.drug_id]||"",t.totalDosage=Object.values(t.dosage).reduce((e,t)=>e+Number(t),0);const a=H.getSessionDate(),n=ge(t.drug_id);return{drug_inventory_id:t.drug_id,equivalent_daily_dose:"Unknown"==t.totalDosage?0:t.totalDosage*(null==n?void 0:n.value)||0,start_date:a,auto_expire_date:ve(a,t.duration),units:t.units,instructions:`${t.name} ${t.totalDosage} ${t.units} ${(null==n?void 0:n.code)||""} for ${t.duration} days`,dose:ue(t),frequency:(null==n?void 0:n.code)||"",drug_name:t.drugName,offline_id:x.generateId(x.getUserName()),program_id:x.getProgramID()}})},ue=e=>null!=e.dose_strength&&e.dose_strength?Math.trunc(e.dose_strength):1;const pe=()=>q().selectedMedicalDrugsList.map(e=>{const t=H.getSessionDate(),a=z.find(t=>t.label===e.frequency)||{};return{drug_inventory_id:e.drug_id,equivalent_daily_dose:"Unknown"==e.dose?0:e.dose*(null==a?void 0:a.value)||0,start_date:t,auto_expire_date:ve(t,e.duration),units:e.units,instructions:`${e.drugName}: ${e.dose} ${e.units} ${(null==a?void 0:a.code)||""} for ${e.duration} days`,dose:e.dose,frequency:(null==a?void 0:a.code)||"",drug_name:e.drugName,offline_id:x.generateId(x.getUserName()),program_id:x.getProgramID()}}),ge=e=>{const t=F().selectedNCDMedicationList.find(t=>t.drug_id===e);if(!t||!t.dosage)return null;switch(["morning","afternoon","evening"].reduce((e,a)=>e+(t.dosage[a]?1:0),0)){case 1:return t.dosage.morning?z.find(e=>"QAM"===e.code):t.dosage.afternoon?z.find(e=>"QNOON"===e.code):t.dosage.evening?z.find(e=>"QPM"===e.code):z.find(e=>"OD"===e.code);case 2:return z.find(e=>"BD"===e.code);case 3:return z.find(e=>"TDS"===e.code);default:return z.find(e=>"Unknown"===e.code)}},ve=(e,t)=>{const a=new Date(e);return a.setDate(a.getDate()+parseInt(t)),I.toStandardHisFormat(a)};t("a",T("nonPharmaTherapyStore",{state:()=>({items:[{id:"wound-dressing",label:"Wound dressing",checked:!1},{id:"patient-education",label:"Patient education",checked:!1},{id:"counseling",label:"Counseling",checked:!1},{id:"minor-surgery",label:"Minor Surgery",checked:!1}],current_patient:{}}),actions:{async saveNonPharmaTherapyPatientData(){const e=A(),t=[];this.items.forEach(a=>{1==a.checked&&t.push({concept_id:11023,value_text:a.label,obs_datetime:I.toStandardHisFormat(x.getSessionDate()),location_id:e.facilityLocation.code})});const a=q().nonPharmalogicalTherapyAndOtherNotes;a&&t.push({concept_id:2592,obs_datetime:x.getSessionDate(),value_text:a,location_id:e.facilityLocation.code});try{if(t.length>0)return this.clearSelectednonPharmaTherapyStore(),E("Non Pharma Therapy staged successfully!"),await async function(e){try{var t,a,n;const i=P(),{patient:o}=S(i),s=JSON.parse(JSON.stringify(o.value));return null!==(a=(t=null!==(n=s.notes)&&void 0!==n?n:s.notes={}).unsaved)&&void 0!==a||(t.unsaved=[]),s.notes.unsaved.push(...e),s}catch(i){j("Unable to create non pharmalogical notes!")}}(t)}catch(n){j("Unable to update Non Pharma Therapy!")}},clearSelectednonPharmaTherapyStore(){this.items.forEach(e=>{e.checked=!1})},setCurrentPatient(e){this.current_patient=e}},persist:!0}))}}})}();
