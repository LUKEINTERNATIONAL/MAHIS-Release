import{d as Z,b2 as j,cr as X,r as f,c as _,w as S,H as z,e as v,f as l,l as h,J as p,k as r,F as H,P as B,O as g,m as F,Q as Y,K as E,p as G,u as ee,b7 as te}from"./vendor-CAxM8KGs.js";import{u as ae,b as ne,D as x,H as se,cH as oe,Z as L,C as re,w as le,an as R,_ as ie}from"../index-eJpzASAs.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-y0ZeiY9V.js";const ue={class:"visitContent"},ce={class:"visitData"},de={class:"table-header"},ve={class:"encounter-title"},me={class:"table-responsive"},fe={key:0,class:"loading-state"},pe={key:1,class:"empty-state"},_e=Z({__name:"VisitsHistory",setup(he){const A=ae(),{patient:i}=j(A),I=X(),y=f([]),d=f(""),n=f(null),u=f([]),w=f(!1),T=e=>{const t={...e};return e.child&&!e.children?t.children=e.child:e.children||(t.children=[]),t.children&&t.children.length>0&&(t.children=t.children.map(a=>T(a))),t},b=_(()=>{const e=new Set;return y.value.forEach(t=>{t&&t.obs.forEach(a=>{if(a.obs_datetime){const s=a.obs_datetime.split(" ")[0];e.add(s)}})}),Array.from(e).sort((t,a)=>new Date(a).getTime()-new Date(t).getTime())}),D=_(()=>{if(!d.value)return[];const e=new Map;return y.value.forEach(t=>{if(!t)return;const a=t.status||"saved";t.obs.forEach(s=>{if(s.obs_datetime&&s.obs_datetime.startsWith(d.value)){const o=s.encounter_id||"unsaved-".concat(t.encounter_type,"-").concat(d.value),c=s.encounter_datetime||s.obs_datetime;e.has(o)||e.set(o,{encounter_id:o,encounter_type:t.encounter_type,name:M(t.encounter_type),encounter_datetime:c,status:a,observations:[]});const m=T(s);e.get(o).observations.push(m)}})}),Array.from(e.values()).sort((t,a)=>new Date(a.encounter_datetime).getTime()-new Date(t.encounter_datetime).getTime())}),P=_(()=>({paging:!0,lengthChange:!1,searching:!1,ordering:!1,info:!0,autoWidth:!0,responsive:!0,pageLength:8})),U=_(()=>[{data:"observation",title:"Observation"},{data:"value",title:"Value"},{data:"date",title:"Date"}]),M=e=>{const t=ne[e];return t?t.toLowerCase().replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()):"Unknown Encounter"},C=e=>se.toStandardHisDisplayFormat(e),V=e=>{d.value=e,n.value=null,u.value=[],D.value.length>0&&O(D.value[0])},O=e=>{n.value=e,q()},$=async(e,t,a)=>{const s="  ".repeat(t),o=t>0?"└─ ":"";if(a.push({observation:"".concat(s).concat(o).concat(e.concept_name||await W(e.concept_id)),value:await J(e),date:C(e.obs_datetime)}),e.children&&e.children.length>0)for(const c of e.children)await $(c,t+1,a)},W=async e=>{try{return await R.getConceptName(e)}catch(t){return console.error("Error fetching concept name for ID ".concat(e,":"),t),"Concept ".concat(e)}},q=async()=>{if(!n.value){u.value=[];return}w.value=!0;try{const e=n.value.observations||[],t=[];for(const a of e)await $(a,0,t);u.value=t}catch(e){console.error("Error loading table data:",e),u.value=[]}finally{w.value=!1}},J=async e=>e.value_text?e.value_text:e.value_numeric!==null&&e.value_numeric!==void 0?String(e.value_numeric):e.value_datetime?C(e.value_datetime):e.value_coded?await R.getConceptName(e.value_coded):"N/A",K=e=>{const t=i.value.observations.map(a=>({...a,obs:a.obs.filter(s=>s.encounter_id!==e)})).filter(a=>a.obs.length>0);i.value.observations=t},Q=async()=>{if(!n.value)return;const e={id:n.value.encounter_id,status:n.value.status};oe(async t=>{var a;try{e.status==="saved"?(i.value.void_encounters=((a=i.value)==null?void 0:a.void_encounters)||[],i.value.void_encounters.push({id:e.id,reason:t}),L("Encounter has been voided!",2e3)):L("Unsaved encounter has been removed!",2e3),K(e.id),n.value=null,u.value=[],await new Promise(s=>setTimeout(s,0)),await re(i.value),await k()}catch(s){le("".concat(s),32e3)}})},k=async()=>{u.value=[],y.value=i.value.observations||[],b.value.length>0&&V(b.value[0])};return S(i,async()=>{await k()},{deep:!0,immediate:!0}),S(I,async()=>{await k()},{deep:!0}),(e,t)=>{const a=z("ion-col"),s=z("ion-row");return l(),v("div",ue,[h(s,null,{default:p(()=>[h(a,{size:"1.6",style:{height:"62vh","overflow-y":"auto","padding-right":"0px","padding-left":"0px"}},{default:p(()=>[r("div",null,[(l(!0),v(H,null,B(b.value,(o,c)=>(l(),g(x,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:m=>V(o),key:c,name:C(o),fill:d.value!=o?"outline":"solid",color:d.value==o?"success":""},null,8,["onClick","name","fill","color"]))),128))])]),_:1}),h(a,{size:"2.5"},{default:p(()=>[r("div",null,[(l(!0),v(H,null,B(D.value,(o,c)=>{var m,N;return l(),g(x,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:ge=>O(o),key:c,name:o.name,fill:((m=n.value)==null?void 0:m.encounter_id)!=o.encounter_id?"outline":"solid",color:((N=n.value)==null?void 0:N.encounter_id)==o.encounter_id?"success":""},null,8,["onClick","name","fill","color"])}),128))])]),_:1}),h(a,{offset:"0.1",size:"7.8"},{default:p(()=>[r("div",ce,[r("div",de,[r("h3",ve,[Y(E(n.value?n.value.name:"Select an Encounter")+" ",1),n.value?(l(),v("span",{key:0,class:G(["status-badge",n.value.status])},E(n.value.status),3)):F("",!0)]),n.value&&n.value.status==="saved"?(l(),g(x,{key:0,name:"Void Encounter",fill:"solid",color:"danger",onClick:t[0]||(t[0]=o=>Q())})):F("",!0)]),r("div",me,[w.value?(l(),v("div",fe,[...t[1]||(t[1]=[r("p",null,"Loading observations...",-1)])])):u.value.length===0&&n.value?(l(),v("div",pe,[r("p",null,"No observations found for "+E(n.value.name),1)])):(l(),g(ee(te),{key:2,ref:"dataTable",class:"display nowrap modern-table",width:"100%",data:u.value,columns:U.value,options:P.value},{default:p(()=>[...t[2]||(t[2]=[r("thead",null,[r("tr",null,[r("th",null,"Observation"),r("th",null,"Value"),r("th",null,"Date")])],-1)])]),_:1},8,["data","columns","options"]))])])]),_:1})]),_:1})])}}}),Ce=ie(_e,[["__scopeId","data-v-7ce320a6"]]);export{Ce as default};
