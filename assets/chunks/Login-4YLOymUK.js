var me=Object.defineProperty;var pe=(o,t,c)=>t in o?me(o,t,{enumerable:!0,configurable:!0,writable:!0,value:c}):o[t]=c;var V=(o,t,c)=>pe(o,typeof t!="symbol"?t+"":t,c);import{D as we,d as ge,r as f,ao as ve,c as he,a as ye,H as Pe,O as Se,f as h,J as u,l as r,u as a,a3 as ke,k as i,bq as be,aU as Ce,e as k,m as q,dn as Ie,E as Ae,Q as w,K as D,b2 as y,W as P,c$ as K,bF as _e,c6 as L,c5 as M,N as U,bs as G,p as g,a6 as xe}from"./vendor-ChpUWbYC.js";import{a1 as F,y as Y,G as Z,S as O,v as W,a0 as j,a2 as J,t as z,U as Ne,a3 as Q,s as S,a4 as Le,a5 as Me,a6 as Ue,a as ze,a7 as Ee,_ as Re}from"../index-B7-ZI9By.js";import{i as qe}from"./Img-CJEgX1Vr.js";import{p as De,g as Fe}from"./userService-_FTna_n9.js";import{u as $e}from"./useNetworkConfig-DBYj6kda.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-Cj7xBElI.js";const $=we("authStatusStore",{state:()=>({emrAuthenticated:!1,miumAuthenticated:!1,lastLoginAttempt:null,loginTimestamp:null,username:""}),getters:{isPartiallyAuthenticated:o=>o.emrAuthenticated||o.miumAuthenticated,isFullyAuthenticated:o=>o.emrAuthenticated&&o.miumAuthenticated,authenticationStatus:o=>o.emrAuthenticated&&o.miumAuthenticated?"full":o.emrAuthenticated||o.miumAuthenticated?"partial":"none",authenticatedSystems:o=>{const t=[];return o.emrAuthenticated&&t.push("EMR"),o.miumAuthenticated&&t.push("MIUM"),t},failedSystems:o=>{const t=[];return o.emrAuthenticated||t.push("EMR"),o.miumAuthenticated||t.push("MIUM"),t}},actions:{setEMRAuthenticated(o){this.emrAuthenticated=o,o&&(this.loginTimestamp=new Date)},setMIUMAuthenticated(o){this.miumAuthenticated=o},setUsername(o){this.username=o},recordLoginAttempt(){this.lastLoginAttempt=new Date},clearAuthStatus(){this.emrAuthenticated=!1,this.miumAuthenticated=!1,this.loginTimestamp=null,this.lastLoginAttempt=null,this.username=""},hasSystemAccess(o){return o==="EMR"?this.emrAuthenticated:this.miumAuthenticated}},persist:!0});class X{static async initialize(){if(this.initialized)return!0;try{const t=$e(),c=F(),b=Y();if(c.isConfigured)return console.log("Network configuration already in store"),this.initialized=!0,!0;if(c.loadFromLocalStorage())return console.log("Network configuration loaded from localStorage to store"),this.initialized=!0,!0;console.log("No local config found, attempting auto-discovery...");const m=await t.autoDiscoverConfig();return m.success&&m.config?(console.log("Network configuration loaded from ".concat(m.source)),this.applyConfiguration(m.config),m.source==="global_property"&&Z("Network settings loaded automatically from facility configuration",4e3),this.initialized=!0,!0):(console.log("No facility network configuration found, user needs to configure manually"),this.initialized=!0,!1)}catch(t){return console.error("Error during network auto-configuration:",t),this.initialized=!0,!1}}static applyConfiguration(t){F().setConfig({couchdbUsername:t.couchdbUsername,couchdbPassword:t.couchdbPassword,couchdbHost:t.couchdbHost,couchdbPort:t.couchdbPort||"",couchdbProtocol:t.couchdbProtocol,locationId:t.locationId||O.getUserLocationId(),facilityName:t.facilityName||"",configuredBy:t.configuredBy||"",configuredAt:t.configuredAt||new Date().toISOString(),configSource:"global_property"}),console.log("Network configuration applied to store and localStorage")}static reset(){this.initialized=!1}static isInitialized(){return this.initialized}static async forceRefresh(){return this.reset(),await this.initialize()}static clearConfiguration(){F().clearConfig(),this.reset(),console.log("Network configuration cleared")}}V(X,"initialized",!1);const Oe={class:"login-container"},Be={key:0,style:{"justify-content":"center",display:"block"}},He={style:{"font-size":"15px"}},Te={style:{"font-size":"12px",color:"#34af4d"}},Ve={key:1},Ke={style:{"font-size":"15px"}},Ge={key:0},We={style:{"text-align":"left"}},je={class:"signup-link"},Je={style:{display:"flex","justify-content":"center","align-items":"center"}},Qe={key:1},Ye={style:{"text-align":"left"}},Ze={key:0,class:"password-requirements"},Xe={class:"requirements-list"},et={class:"signup-link"},tt=ge({__name:"Login",setup(o){const t=f(""),c=f(""),b=f(""),m=f(!1),v=f(!1),E=f("test"),p=f(new Ee),s=f({username:"",currentPassword:"",newPassword:"",confirmPassword:""}),C=f(!1),I=f(!1),A=f(!1),R=ve(),ee=W(),_=j(),te=Y(),B=he(()=>s.value.username.trim()!==""&&s.value.currentPassword.trim()!==""&&s.value.newPassword.trim()!==""&&s.value.confirmPassword.trim()!==""&&J(s.value.newPassword)&&s.value.newPassword===s.value.confirmPassword&&s.value.newPassword!==s.value.currentPassword),se=()=>{_.checkLoginStatus()&&R.push("/home")},ae=async()=>{ee.terminate(),await W().postData("SET_OFFLINE_PROGRAMS")},oe=()=>{b.value=localStorage.getItem("core_version")||""},ne=async()=>{const n=j(),e=await Fe();e&&(n.setUserFacilityName(e.name),n.setFacilityLocation(e),localStorage.setItem("facility_code",e.code))},re=async()=>{const n=await p.value.checkUserPrograms(void 0);n!=null&&n.programs&&ze().setAuthorizedPrograms(n==null?void 0:n.programs)},x=()=>{v.value=!v.value,v.value&&(s.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""})},le=()=>{z("Help functionality to be implemented")},ie=async()=>{try{await te.loadGlobalProperty();const n=await X.initialize();console.log(n?"Network auto-configuration completed successfully":"No facility network configuration found, user will need to configure manually")}catch(n){console.error("Error during post-login initialization:",n)}},ue=async()=>{if(!B.value){z("Please complete all fields correctly"),z("Password must be at least 8 characters long and contain at least one uppercase letter, one lowercase letter, one number, and one special character.");return}try{const n=await p.value.requestLogin(s.value.currentPassword,s.value.username);if(n){const{authorization:e}=n,{token:d,user:l}=e;l&&(localStorage.setItem("apiKey",d),await Ne.updateUser(l.user_id,{password:s.value.newPassword}),Z("Password changed successfully!"),await p.value.requestLogin(s.value.newPassword,s.value.username),s.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""},v.value=!1,localStorage.setItem("apiKey",""))}}catch(n){n instanceof Q?S("Current password is incorrect"):S("Error changing password: ".concat(n))}},ce=async()=>{const n=$();if(!t.value||!c.value)return{success:!1,error:null,validationError:!0};p.value.setUsername(t.value),n.setUsername(t.value);try{return await p.value.login(c.value),await ne(),await re(),await Ue(),await De(),n.setEMRAuthenticated(!0),_.setLoginStatus(!0),{success:!0,error:null}}catch(e){return n.setEMRAuthenticated(!1),_.setLoginStatus(!1),{success:!1,error:e}}},de=async()=>{if(O.getLanConnectionStatus()||O.getPouchDbStatus())return{success:!0,error:null};const e=$();if(!t.value||!c.value)return{success:!1,error:null,validationError:!0};p.value.setUsername(t.value);try{return await p.value.loginToMIUM(c.value),e.setMIUMAuthenticated(!0),{success:!0,error:null}}catch(d){return e.setMIUMAuthenticated(!1),{success:!1,error:d}}},H=async()=>{const n=$();if(!t.value||!c.value){z("Complete form to log in");return}n.recordLoginAttempt();const[e,d]=await Promise.allSettled([ce(),de()]),l=e.status==="fulfilled"&&e.value.success,T=d.status==="fulfilled"&&d.value.success;if(l)await ie(),R.push("/home");else if(!l&&!T){const N=e.status==="fulfilled"?e.value.error:e.reason;N instanceof Q?S("Invalid username or password"):N instanceof Le?(x(),S("Please change your password",5e4)):N instanceof Me?(x(),S("Your password has expired. Please change your password",5e4)):S("".concat(N),5e4)}else!l&&T&&(e.status==="fulfilled"?e.value.error:e.reason)},fe=n=>{R.push(n)};return ye(async()=>{se(),_.setLoginStatus(!1),await p.value.loadConfig(),oe(),await ae()}),(n,e)=>{const d=Pe("ion-icon");return h(),Se(a(xe),null,{default:u(()=>[r(a(ke),{class:"ion-padding login-page"},{default:u(()=>[i("div",Oe,[r(a(be),{style:{"background-color":"#fff"}},{default:u(()=>[r(a(Ce),null,{default:u(()=>[r(a(Ie),{class:"login_img",src:a(qe)("mw.png"),id:"logo"},null,8,["src"]),r(a(Ae),{class:"login-title"},{default:u(()=>[E.value==="development"||E.value==="test"?(h(),k("span",Be,[i("div",null,[e[11]||(e[11]=w(" MaHIS ",-1)),i("small",He,"(v"+D(b.value)+")",1)]),i("div",Te,"("+D(E.value)+")",1)])):(h(),k("span",Ve,[e[12]||(e[12]=w(" MaHIS ",-1)),i("small",Ke,"(v"+D(b.value)+")",1)]))]),_:1}),v.value?q("",!0):(h(),k("div",Ge,[i("span",We,[r(a(y),{value:t.value,onIonInput:e[0]||(e[0]=l=>t.value=l.target.value||""),type:"text",label:"Username",ref:"usernameRef","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:u(()=>[r(a(P),{slot:"end"},{default:u(()=>[r(d,{icon:a(K)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),r(a(y),{value:c.value,onIonInput:e[2]||(e[2]=l=>c.value=l.target.value||""),type:m.value?"text":"password",label:"Password",ref:"passwordRef","label-placement":"floating",fill:"outline",placeholder:"Enter Password",class:"input-fields",required:"",onKeydown:_e(H,["enter"])},{default:u(()=>[r(a(P),{slot:"end"},{default:u(()=>[r(d,{icon:m.value?a(L):a(M),onClick:e[1]||(e[1]=l=>m.value=!m.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"])]),r(a(U),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:H,class:"login-button"},{default:u(()=>[...e[13]||(e[13]=[w(" Login ",-1)])]),_:1}),i("p",je,[e[17]||(e[17]=w(" For help click ",-1)),i("a",{href:"#",onClick:G(le,["prevent"])},"Here"),e[18]||(e[18]=w()),e[19]||(e[19]=i("br",null,null,-1)),i("div",Je,[r(a(U),{fill:"clear",size:"small",onClick:x,style:{display:"inline","--padding-start":"2px","--padding-end":"2px"}},{default:u(()=>[...e[14]||(e[14]=[i("span",{style:{"text-decoration":"underline",color:"#34af4d",cursor:"pointer"}}," Change Password ",-1)])]),_:1}),e[16]||(e[16]=w(" | ",-1)),r(a(U),{fill:"clear",size:"small",onClick:e[3]||(e[3]=l=>fe("/downloads")),style:{display:"inline","--padding-start":"2px","--padding-end":"2px"}},{default:u(()=>[...e[15]||(e[15]=[i("span",{style:{"text-decoration":"underline",color:"#34af4d",cursor:"pointer"}}," Download MaHIS ",-1)])]),_:1})])])])),v.value?(h(),k("div",Qe,[e[22]||(e[22]=i("h3",{style:{"text-align":"center","margin-bottom":"20px",color:"#34af4d"}},"Change Password",-1)),i("span",Ye,[r(a(y),{value:s.value.username,onIonInput:e[4]||(e[4]=l=>s.value.username=l.target.value||""),type:"text",label:"Username","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:u(()=>[r(a(P),{slot:"end"},{default:u(()=>[r(d,{icon:a(K)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),r(a(y),{value:s.value.currentPassword,onIonInput:e[6]||(e[6]=l=>s.value.currentPassword=l.target.value||""),type:C.value?"text":"password",label:"Current Password","label-placement":"floating",fill:"outline",placeholder:"Enter Current Password",class:"input-fields",required:""},{default:u(()=>[r(a(P),{slot:"end"},{default:u(()=>[r(d,{icon:C.value?a(L):a(M),onClick:e[5]||(e[5]=l=>C.value=!C.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"]),r(a(y),{value:s.value.newPassword,onIonInput:e[8]||(e[8]=l=>s.value.newPassword=l.target.value||""),type:I.value?"text":"password",label:"New Password","label-placement":"floating",fill:"outline",placeholder:"Enter New Password",class:g(["input-fields",{"invalid-input":s.value.newPassword&&!a(J)(s.value.newPassword)}]),required:""},{default:u(()=>[r(a(P),{slot:"end"},{default:u(()=>[r(d,{icon:I.value?a(L):a(M),onClick:e[7]||(e[7]=l=>I.value=!I.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"]),r(a(y),{value:s.value.confirmPassword,onIonInput:e[10]||(e[10]=l=>s.value.confirmPassword=l.target.value||""),type:A.value?"text":"password",label:"Confirm New Password","label-placement":"floating",fill:"outline",placeholder:"Confirm New Password",class:g(["input-fields",{"invalid-input":s.value.confirmPassword&&s.value.newPassword!==s.value.confirmPassword}]),required:""},{default:u(()=>[r(a(P),{slot:"end"},{default:u(()=>[r(d,{icon:A.value?a(L):a(M),onClick:e[9]||(e[9]=l=>A.value=!A.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"])]),s.value.newPassword?(h(),k("div",Ze,[e[20]||(e[20]=i("p",{class:"requirements-title"},"Password Requirements:",-1)),i("ul",Xe,[i("li",{class:g({valid:s.value.newPassword.length>=8})},"At least 8 characters",2),i("li",{class:g({valid:/[A-Z]/.test(s.value.newPassword)})},"One uppercase letter",2),i("li",{class:g({valid:/[0-9]/.test(s.value.newPassword)})},"One number",2),i("li",{class:g({valid:/[@#$%^&+=*!-]/.test(s.value.newPassword)})}," One special character (@#$%^&+=*!-) ",2),i("li",{class:g({valid:s.value.newPassword!==s.value.currentPassword&&s.value.currentPassword!==""})}," Different from current password ",2)])])):q("",!0),r(a(U),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:ue,class:"login-button",disabled:!B.value},{default:u(()=>[...e[21]||(e[21]=[w(" Change Password ",-1)])]),_:1},8,["disabled"]),i("p",et,[i("a",{href:"#",onClick:G(x,["prevent"])},"Back to Login")])])):q("",!0)]),_:1})]),_:1})])]),_:1})]),_:1})}}}),ct=Re(tt,[["__scopeId","data-v-414576a7"]]);export{ct as default};
