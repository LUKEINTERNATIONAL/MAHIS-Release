import{d as ee,aV as oe,c as g,r as u,a as te,O as ae,f as d,J as f,e as m,m as h,l as s,k as a,u as t,bx as se,a3 as ne,bq as re,p as P,L as y,cl as F,K as p,cj as O,a4 as le,a5 as ie,Q as x,ck as ce,N as V,ed as ue,a6 as de,U as fe}from"./vendor-ChpUWbYC.js";import{a1 as ve,aB as ge,aC as _,T as me,aD as he,G as pe,s as D,S as L,_ as be}from"../index-CxT3LRYV.js";import{u as Ce}from"./useNetworkConfig-CNtQDQL1.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-Cj7xBElI.js";const ye={key:0,class:"spinner-overlay"},_e={class:"positionCenter"},we={class:"card_content"},Se={class:"card_header_main"},ke={key:0,class:"connection-status-section"},Te={class:"status-indicator"},Pe={key:0,class:"timestamp"},De={class:"action-buttons"},Ne={key:0,style:{"font-size":"0.8rem","margin-left":"8px"}},Ie={class:"help-text"},U="network_last_test_result",Fe=ee({__name:"OfflineNetworkConfigurations",setup(xe){const b=ve(),{config:v,isConfigured:Ue}=oe(b),w=g(()=>v.value.configSource),S=u(!1),k=u(!1),n=u(null),i=u(null);u(!0);const l=u(null),c=u("none"),N=Ce(),{formRef:q,getFormValues:B}=ge();g(()=>b.config);const H=g(()=>[{componentType:"inputField",header:"Username",name:"couchdbUsername",value:v.value.couchdbUsername,validation:_.required,grid:{s:"6"}},{componentType:"inputField",header:"Password",name:"couchdbPassword",type:"password",value:v.value.couchdbPassword,validation:_.required,grid:{s:"6"}},{componentType:"inputField",header:"IP Address",name:"couchdbHost",value:v.value.couchdbHost,validation:_.required,grid:{s:"6"}},{componentType:"inputField",header:"Port Number",name:"couchdbPort",value:v.value.couchdbPort,validation:_.required,grid:{s:"6"}},{componentType:"Heading",name:"Protocol",grid:{s:"4"}},{componentType:"radioButtonField",name:"couchdbProtocol",validation:_.required,type:"inline",grid:{s:"6"},value:v.value.couchdbProtocol,options:[{label:"https",value:"https"},{label:"http",value:"http"}]}]),R=g(()=>{const e=w.value||c.value;return e==="global_property"?"source-global":e==="local_storage"?"source-local":""}),z=g(()=>{const e=w.value||c.value;return e==="global_property"?"Using Facility Default Configuration":e==="local_storage"?"Using Local Configuration":"No Configuration"}),G=g(()=>l.value?l.value.success?l.value.source==="global_property"?"Configuration loaded from facility settings. You can use these settings or modify them.":"Configuration loaded from your local storage.":"Please configure your network settings below.":""),J=async()=>{k.value=!0,n.value=null,i.value=null;try{const e=B(),{couchdbUsername:o,couchdbPassword:C,couchdbHost:I,couchdbPort:A,couchdbProtocol:$}=e;if(!o||!C||!I||!$)throw new Error("Please fill in all required fields");const K=o.trim(),Y=C.trim(),Q=I.trim(),W=$.trim(),X=btoa("".concat(K,":").concat(Y)),Z=A?":".concat(A):"",E="".concat(W,"://").concat(Q).concat(Z);console.log("Testing connection to:",E);const T=await fetch("".concat(E,"/"),{method:"GET",headers:{Authorization:"Basic ".concat(X),"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(T.ok){const r=await T.json();if(r.couchdb==="Welcome")n.value="available",i.value=new Date().toLocaleString(),localStorage.setItem(U,JSON.stringify({status:"available",timestamp:i.value,version:r.version})),pe("Connected successfully! CouchDB version: ".concat(r.version),3e3);else throw new Error("Server responded but is not CouchDB")}else{let r="Connection failed";switch(T.status){case 401:r="Authentication failed - Invalid username or password";break;case 403:r="Access forbidden - Check user permissions";break;case 404:r="CouchDB server not found at this address";break;case 500:r="CouchDB server error";break;default:r="Connection failed with status: ".concat(T.status)}throw new Error(r)}}catch(e){console.error("Connection test failed:",e),n.value="error",i.value=new Date().toLocaleString(),localStorage.setItem(U,JSON.stringify({status:"error",timestamp:i.value,error:e.message})),e.name==="AbortError"||e.name==="TimeoutError"?D("Connection timeout - Check your network and server address",5e3):e.message.includes("fetch")?D("Network error - Cannot reach the server",5e3):D(e.message,5e3)}finally{k.value=!1}},j=async()=>{await(await fe.create({header:"Save as Facility Default",message:"This will save the configuration for all users at this facility. Other users will automatically use these settings when they log in. Continue?",buttons:[{text:"Cancel",role:"cancel"},{text:"Save for All Users",handler:async()=>{S.value=!0;try{const o=B(),C={couchdbUsername:o.couchdbUsername,couchdbPassword:o.couchdbPassword,couchdbHost:o.couchdbHost,couchdbPort:o.couchdbPort||"",couchdbProtocol:o.couchdbProtocol,locationId:L.getUserLocationId(),facilityName:"",configuredBy:L.getUserName(),configuredAt:new Date().toISOString(),configSource:"global_property"};await N.saveAsGlobalProperty(C)&&(b.setConfig(C),c.value="global_property")}catch(o){console.error("Save error:",o),D("Failed to save facility configuration",3e3)}finally{S.value=!1}}}]})).present()},M=()=>{const e=localStorage.getItem(U);if(e)try{const o=JSON.parse(e);n.value=o.status,i.value=o.timestamp}catch(o){console.error("Failed to parse last test result:",o)}};return te(async()=>{if(M(),b.isConfigured){console.log("Configuration already in store"),c.value=w.value||"local_storage",l.value={success:!0,source:w.value};return}const e=await N.autoDiscoverConfig();l.value=e,e.success&&e.config?(b.setConfig({...e.config,configSource:e.source}),c.value=e.source):c.value=N.getConfigSource()}),(e,o)=>(d(),ae(t(de),{class:P({loading:S.value})},{default:f(()=>[S.value?(d(),m("div",ye,[s(t(se),{name:"bubbles"}),o[0]||(o[0]=a("div",{class:"loading-text"},"Please wait...",-1))])):h("",!0),s(me),s(t(ne),{fullscreen:!0},{default:f(()=>[a("div",_e,[s(t(re),{class:"registration_ion_card"},{default:f(()=>[a("div",we,[a("div",Se,[a("div",null,[o[1]||(o[1]=a("h2",{class:"card_hearder"},"Set Offline Network Configurations",-1)),c.value!=="none"?(d(),m("div",{key:0,class:P(["config-source-badge",R.value])},[s(t(y),{icon:t(F)},null,8,["icon"]),a("span",null,p(z.value),1)],2)):h("",!0)])]),l.value?(d(),m("div",{key:0,class:P(["info-banner",l.value.success?"success":"warning"])},[s(t(y),{icon:l.value.success?t(O):t(F)},null,8,["icon"]),a("div",null,[a("strong",null,p(l.value.success?"Configuration Found!":"No Configuration Found"),1),a("p",null,p(G.value),1)])],2)):h("",!0),s(t(le),null,{default:f(()=>[s(t(ie),{size:"12"},{default:f(()=>[a("div",null,[s(he,{formData:H.value,ref_key:"formRef",ref:q},null,8,["formData"]),n.value?(d(),m("div",ke,[a("div",{class:P(["connection-result",n.value])},[a("div",Te,[s(t(y),{icon:n.value==="available"?t(O):t(ce)},null,8,["icon"]),x(" "+p(n.value==="available"?"Connection Successful":"Connection Failed"),1)]),i.value?(d(),m("div",Pe,p(i.value),1)):h("",!0)],2)])):h("",!0),a("div",De,[s(t(V),{onClick:J,disabled:k.value,class:"primary-btn",expand:"block",fill:"solid"},{default:f(()=>[x(p(k.value?"Testing Connection...":"Test Connection"),1)]),_:1},8,["disabled"]),s(t(V),{onClick:j,class:"super-user-btn",expand:"block",fill:"solid",disabled:n.value!=="available"},{default:f(()=>[s(t(y),{icon:t(ue),slot:"start"},null,8,["icon"]),o[2]||(o[2]=x(" Save as Facility Default ",-1)),n.value!=="available"?(d(),m("span",Ne," (Test connection first) ")):h("",!0)]),_:1},8,["disabled"])]),a("div",Ie,[s(t(y),{icon:t(F)},null,8,["icon"]),o[3]||(o[3]=a("p",null," Save this configuration as the facility default for other users to automatically use these settings when they log in. ",-1))])])]),_:1})]),_:1})])]),_:1})])]),_:1})]),_:1},8,["class"]))}}),Ve=be(Fe,[["__scopeId","data-v-5ac84414"]]);export{Ve as default};
