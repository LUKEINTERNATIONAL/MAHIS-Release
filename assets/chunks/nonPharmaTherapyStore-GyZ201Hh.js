var I=Object.defineProperty;var A=(s,e,t)=>e in s?I(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var g=(s,e,t)=>A(s,typeof e!="symbol"?e+"":e,t);import{aX as C,u as v,J as N,S as l,E as F,H as h,ao as U,bG as $,P as L,ah as x,F as S,t as f,b1 as b,bc as P,aa as H,b as k}from"../index-DFvmUOLO.js";import{l as y}from"./lodash-NJiRuGo9.js";import{g as J,D as M,a as m}from"./drug_prescription_service-CwgqZzSK.js";import{b2 as O,D as R}from"./vendor-DXMRec6a.js";import{P as V}from"./patient_diagnosis_service-CtDPrhI5.js";class Q extends C{constructor(e,t){super(e,105,t)}}class B extends C{constructor(e,t){super(e,25,t)}static async get_____(e="",t=1,r=10){}}async function ne(s){var e,t,r;try{const a=v(),{patient:o}=O(a),n=JSON.parse(JSON.stringify(o.value));return(r=(t=(e=n.allergies)!=null?e:n.allergies={}).unsaved)!=null||(t.unsaved=[]),n.allergies.unsaved.push(...s),S("Allergies appended to patient record successfully"),n}catch(a){f("Unable to save Allegies!")}}class oe{async onSubmitNotes(e,t,r){const a=new Q(e,t);await a.createEncounter(),await a.saveObservationList(r)}async onSubmitAllergies(e,t,r){try{const a=new B(e,t);await a.createEncounter(),await a.saveObservationList(r),S("Allergies saved successfully")}catch(a){console.error("Error saving allergies:",a),f("Failed to save allergies")}}}class ie{constructor(){g(this,"programID");g(this,"providerID");g(this,"patientID");g(this,"date");g(this,"demographics");g(this,"previousDrugPrescriptions",[]);g(this,"previousClinicalNotes");g(this,"previousDrugAllergies");const e=v();this.demographics=e.patient,this.patientID=this.demographics.patientID,this.date=N.getSessionDate(),this.providerID=l.getUserID(),this.programID=N.getProgramID(),this.previousClinicalNotes={},this.previousDrugAllergies={}}async getPatientEncounters(){const e=await this.getPatientVisitDates(),t=e.map(async a=>{const o=a.value,n=await F.getEncounters(this.patientID,{date:o});await Promise.all(n.map(async i=>{var D;if(i.type.name=="NOTES"){const{observations:u}=i;y.isEmpty(u)||u.forEach(d=>{if(d.concept_id=="2688"){const p=h.toStandardHisDisplayFormat(d.obs_datetime);y.isEmpty(this.previousClinicalNotes.hasOwnProperty(p))&&(this.previousClinicalNotes[p]=[]),this.previousClinicalNotes[p].push({date:p,notes:d.value_text})}})}if(i.type.name=="TREATMENT"){const{observations:u}=i;if(!y.isEmpty(u))for(const d in u){let p="<UNKNOWN CONCEPT>";const c=u[d];try{(D=c==null?void 0:c.concept)!=null&&D.concept_names?p=c.concept.concept_names[0].name:p=await U.getConceptName(c.concept_id)}catch(T){console.error(c,T)}const w=await N.resolvePrimaryValue(c),_=h.toStandardHisDisplayFormat(c.date_created);p=="Allergic"&&(this.previousDrugAllergies.hasOwnProperty(_)||(this.previousDrugAllergies[_]=[]),this.previousDrugAllergies[_].push({date:_,value:w}))}}}))});await Promise.all(t);const r=e.map(async a=>{const o=await $.getOrderByPatient(this.patientID,{start_date:a.value});if(!y.isEmpty(o)){const n=o.map(i=>({drugName:i.drug.name,value:h.toStandardHisTimeFormat(i.order.start_date),dose:i.dose,frequency:J(i.frequency),prescription:h.toStandardHisFormat(i.order.auto_expire_date),duration:W(i.order.instructions),other:i}));this.previousDrugPrescriptions.push({prescriptionDate:h.toStandardHisDisplayFormat(a.value),previousPrescriptions:n})}});return await Promise.all(r),{previousDrugPrescriptions:this.previousDrugPrescriptions,previousClinicalNotes:this.previousClinicalNotes,previousDrugAllergies:this.previousDrugAllergies}}async getPatientVisitDates(){return(await L.getPatientVisits(this.patientID,!1)).map(e=>({label:h.toStandardHisDisplayFormat(e),value:e,other:{isActive:e===x.getSessionDate()}}))}}function W(s){const e=/(\d+)\s+days/i,t=s.match(e);return t&&t.length>1?parseInt(t[1]):null}async function ce(){const s=v(),{patient:e}=O(s),t=e.value,r=[8809,903,6410,6409],a="";let o;l.getLanConnectionStatus()||l.getPouchDbStatus()?o=await V.getDiagnosis(a,1,15):o=await l.getJson("diagnosis",{id:7409,page_size:2e3});const n=o.filter(c=>r.includes(c.concept_id));n.push({concept_id:8809,concept_name_id:926,concept_name_type:"FULLY_SPECIFIED",creator:1,date_created:"2004-06-25T00:00:00.000+02:00",date_voided:null,id:72,locale:"en",locale_preferred:0,name:"Hypertension",uuid:"b99faa1e-8d80-11d8-abbb-0024217bb78e",void_reason:null,voided:0,voided_by:null});const i=t.diagnosis.saved.map(c=>c.value_coded),D=t.diagnosis.unsaved.map(c=>c.value_coded),u=[...i,...D];return n.filter(c=>u.includes(c.concept_id)).map(c=>c.name)}async function de(){var s,e,t;try{const r=v(),{patient:a}=O(r),o=G(),n=JSON.parse(JSON.stringify(a.value));if(o.length>0){(t=(e=(s=n.MedicationOrder)!=null?s:n.MedicationOrder={}).unsaved)!=null||(e.unsaved=[]),n.MedicationOrder.unsaved=[...n.MedicationOrder.unsaved,...o];const i=P();return i.setMedicationRunOutDate(Y()),i.clearMedicationDataStores(),S("Drug order(s) has been created"),n}else f("Unable to create drug orders!")}catch(r){f("Unable to create drug orders!")}}function le(){try{const s=new Date(l.getSessionDate()),t=b().selectedMedicalDrugsList;let r=0;if(t.forEach(u=>{const d=parseInt(u.duration,10);!isNaN(d)&&d>r&&(r=d)}),r<=0)return{date:null,formattedDate:null};const a=new Date(s);a.setDate(s.getDate()+r);const o=String(a.getDate()).padStart(2,"0"),n=String(a.getMonth()+1).padStart(2,"0"),i=a.getFullYear(),D="".concat(o,"/").concat(n,"/").concat(i);return{date:a,formattedDate:D}}catch(s){return console.error("Error calculating OPD medication run out date:",s),{date:null,formattedDate:null}}}function Y(){try{const s=new Date(l.getSessionDate()),t=P().selectedNCDMedicationList;let r=0;if(t.forEach(u=>{const d=parseInt(u.duration,10);!isNaN(d)&&d>r&&(r=d)}),r<=0)return{date:null,formattedDate:null};const a=new Date(s);a.setDate(s.getDate()+r);const o=String(a.getDate()).padStart(2,"0"),n=String(a.getMonth()+1).padStart(2,"0"),i=a.getFullYear(),D="".concat(o,"/").concat(n,"/").concat(i);return{date:a,formattedDate:D}}catch(s){return console.error("Error calculating medication run out date:",s),{date:null,formattedDate:null}}}const G=()=>{const s=P();return s.selectedNCDMedicationList.map(e=>{e.frequency=s.frequency_selections[e.drug_id]||"",e.totalDosage=Object.values(e.dosage).reduce((a,o)=>a+Number(o),0);const t=M.getSessionDate(),r=z(e.drug_id);return{drug_inventory_id:e.drug_id,equivalent_daily_dose:e.totalDosage=="Unknown"?0:e.totalDosage*(r==null?void 0:r.value)||0,start_date:t,auto_expire_date:E(t,e.duration),units:e.units,instructions:"".concat(e.name," ").concat(e.totalDosage," ").concat(e.units," ").concat((r==null?void 0:r.code)||""," for ").concat(e.duration," days"),dose:j(e),frequency:(r==null?void 0:r.code)||"",drug_name:e.drugName,offline_id:l.generateId(l.getUserName()),program_id:l.getProgramID()}})},j=s=>s.dose_strength!=null&&s.dose_strength?Math.trunc(s.dose_strength):1;async function ue(){var s,e,t;try{const r=v(),{patient:a}=O(r),o=q(),n=JSON.parse(JSON.stringify(a.value));if(o.length>0)return(t=(e=(s=n.MedicationOrder)!=null?s:n.MedicationOrder={}).unsaved)!=null||(e.unsaved=[]),n.MedicationOrder.unsaved=[...n.MedicationOrder.unsaved,...o],S("Drug order(s) has been created"),n}catch(r){f("Unable to create drug orders!")}}const q=()=>b().selectedMedicalDrugsList.map(e=>{const t=M.getSessionDate(),r=m.find(a=>a.label===e.frequency)||{};return{drug_inventory_id:e.drug_id,equivalent_daily_dose:e.dose=="Unknown"?0:e.dose*(r==null?void 0:r.value)||0,start_date:t,auto_expire_date:E(t,e.duration),units:e.units,instructions:"".concat(e.drugName,": ").concat(e.dose," ").concat(e.units," ").concat((r==null?void 0:r.code)||""," for ").concat(e.duration," days"),dose:e.dose,frequency:(r==null?void 0:r.code)||"",drug_name:e.drugName,offline_id:l.generateId(l.getUserName()),program_id:l.getProgramID()}}),z=s=>{const t=P().selectedNCDMedicationList.find(a=>a.drug_id===s);if(!t||!t.dosage)return null;switch(["morning","afternoon","evening"].reduce((a,o)=>a+(t.dosage[o]?1:0),0)){case 1:return t.dosage.morning?m.find(a=>a.code==="QAM"):t.dosage.afternoon?m.find(a=>a.code==="QNOON"):t.dosage.evening?m.find(a=>a.code==="QPM"):m.find(a=>a.code==="OD");case 2:return m.find(a=>a.code==="BD");case 3:return m.find(a=>a.code==="TDS");default:return m.find(a=>a.code==="Unknown")}},E=(s,e)=>{const t=new Date(s);return t.setDate(t.getDate()+parseInt(e)),h.toStandardHisFormat(t)},K=()=>b().nonPharmalogicalTherapyAndOtherNotes,pe=R("nonPharmaTherapyStore",{state:()=>({items:[{id:"wound-dressing",label:"Wound dressing",checked:!1},{id:"patient-education",label:"Patient education",checked:!1},{id:"counseling",label:"Counseling",checked:!1},{id:"minor-surgery",label:"Minor Surgery",checked:!1}],current_patient:{}}),actions:{async saveNonPharmaTherapyPatientData(){const s=H(),e=[];this.items.forEach(r=>{r.checked==!0&&e.push({concept_id:11023,value_text:r.label,obs_datetime:h.toStandardHisFormat(l.getSessionDate()),location_id:s.facilityLocation.code})});const t=K();t&&e.push({concept_id:2592,obs_datetime:l.getSessionDate(),value_text:t,location_id:s.facilityLocation.code});try{if(e.length>0)return this.clearSelectednonPharmaTherapyStore(),S("Non Pharma Therapy staged successfully!"),await X(e)}catch(r){f("Unable to update Non Pharma Therapy!")}},clearSelectednonPharmaTherapyStore(){this.items.forEach(s=>{s.checked=!1})},setCurrentPatient(s){this.current_patient=s}},persist:!0});async function X(s){try{await N.addObsToEncounterPatient(s,k.NOTES)}catch(e){f("Unable to create non pharmalogical notes!")}}export{ie as P,oe as T,le as a,ue as b,de as c,ce as g,ne as s,pe as u};
