import{d as Q,b2 as j,cr as X,r as m,c as p,w as O,H as z,e as d,f as l,l as _,J as f,k as o,F as B,P as H,O as h,m as L,Q as Y,K as b,p as Z,u as G,b7 as ee}from"./vendor-BataJFSH.js";import{u as te,b as ae,M as k,H as ne,w as F,cG as se,E as oe,K as re,ah as R,_ as le}from"../index-CYcjB3lE.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-BVd6_RNM.js";const ie={class:"visitContent"},ce={class:"visitData"},ue={class:"table-header"},de={class:"encounter-title"},ve={class:"table-responsive"},me={key:0,class:"loading-state"},fe={key:1,class:"empty-state"},pe=Q({__name:"VisitsHistory",setup(_e){const A=te(),{patient:x}=j(A),I=X(),g=m([]),u=m(""),n=m(null),i=m([]),y=m(!1),V=e=>{const t={...e};return e.child&&!e.children?t.children=e.child:e.children||(t.children=[]),t.children&&t.children.length>0&&(t.children=t.children.map(a=>V(a))),t},w=p(()=>{const e=new Set;return g.value.forEach(t=>{t&&t.obs.forEach(a=>{if(a.obs_datetime){const r=a.obs_datetime.split(" ")[0];e.add(r)}})}),Array.from(e).sort((t,a)=>new Date(a).getTime()-new Date(t).getTime())}),D=p(()=>{if(!u.value)return[];const e=new Map;return g.value.forEach(t=>{if(!t)return;const a=t.status||"saved";t.obs.forEach(r=>{if(r.obs_datetime&&r.obs_datetime.startsWith(u.value)){const s=r.encounter_id||"unsaved-".concat(t.encounter_type,"-").concat(u.value),c=r.encounter_datetime||r.obs_datetime;e.has(s)||e.set(s,{encounter_id:s,encounter_type:t.encounter_type,name:U(t.encounter_type),encounter_datetime:c,status:a,observations:[]});const v=V(r);e.get(s).observations.push(v)}})}),Array.from(e.values()).sort((t,a)=>new Date(a.encounter_datetime).getTime()-new Date(t.encounter_datetime).getTime())}),M=p(()=>({paging:!0,lengthChange:!1,searching:!1,ordering:!1,info:!0,autoWidth:!0,responsive:!0,pageLength:8})),K=p(()=>[{data:"observation",title:"Observation"},{data:"value",title:"Value"},{data:"date",title:"Date"}]),U=e=>{const t=ae[e];return t?t.toLowerCase().replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()):"Unknown Encounter"},C=e=>ne.toStandardHisDisplayFormat(e),S=e=>{u.value=e,n.value=null,i.value=[],D.value.length>0&&T(D.value[0])},T=e=>{n.value=e,q()},$=async(e,t,a)=>{const r="  ".repeat(t),s=t>0?"└─ ":"";if(a.push({observation:"".concat(r).concat(s).concat(e.concept_name||await W(e.concept_id)),value:await J(e),date:C(e.obs_datetime)}),e.children&&e.children.length>0)for(const c of e.children)await $(c,t+1,a)},W=async e=>{try{return await R.getConceptName(e)}catch(t){return console.error("Error fetching concept name for ID ".concat(e,":"),t),"Concept ".concat(e)}},q=async()=>{if(!n.value){i.value=[];return}y.value=!0;try{const e=n.value.observations||[],t=[];for(const a of e)await $(a,0,t);i.value=t}catch(e){console.error("Error loading table data:",e),i.value=[]}finally{y.value=!1}},J=async e=>e.value_text?e.value_text:e.value_numeric!==null&&e.value_numeric!==void 0?String(e.value_numeric):e.value_datetime?C(e.value_datetime):e.value_coded?await R.getConceptName(e.value_coded):"N/A",P=async()=>{if(n.value){if(n.value.status!=="saved"){F("Cannot void unsaved encounters",2e3);return}se(async e=>{try{await oe.voidEncounter(n.value.encounter_id,e),await E(),re("Encounter has been voided!",2e3)}catch(t){F("".concat(t),32e3)}})}},E=async()=>{i.value=[],g.value=x.value.observations||[],w.value.length>0&&S(w.value[0])};return O(x,async()=>{await E()},{deep:!0,immediate:!0}),O(I,async()=>{await E()},{deep:!0}),(e,t)=>{const a=z("ion-col"),r=z("ion-row");return l(),d("div",ie,[_(r,null,{default:f(()=>[_(a,{size:"1.6",style:{height:"62vh","overflow-y":"auto","padding-right":"0px","padding-left":"0px"}},{default:f(()=>[o("div",null,[(l(!0),d(B,null,H(w.value,(s,c)=>(l(),h(k,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:v=>S(s),key:c,name:C(s),fill:u.value!=s?"outline":"solid",color:u.value==s?"success":""},null,8,["onClick","name","fill","color"]))),128))])]),_:1}),_(a,{size:"2.5"},{default:f(()=>[o("div",null,[(l(!0),d(B,null,H(D.value,(s,c)=>{var v,N;return l(),h(k,{class:"",style:{"margin-bottom":"5px",width:"96%",height:"45px"},onClick:he=>T(s),key:c,name:s.name,fill:((v=n.value)==null?void 0:v.encounter_id)!=s.encounter_id?"outline":"solid",color:((N=n.value)==null?void 0:N.encounter_id)==s.encounter_id?"success":""},null,8,["onClick","name","fill","color"])}),128))])]),_:1}),_(a,{offset:"0.1",size:"7.8"},{default:f(()=>[o("div",ce,[o("div",ue,[o("h3",de,[Y(b(n.value?n.value.name:"Select an Encounter")+" ",1),n.value?(l(),d("span",{key:0,class:Z(["status-badge",n.value.status])},b(n.value.status),3)):L("",!0)]),n.value&&n.value.status==="saved"?(l(),h(k,{key:0,name:"Void Encounter",fill:"solid",color:"danger",onClick:t[0]||(t[0]=s=>P())})):L("",!0)]),o("div",ve,[y.value?(l(),d("div",me,[...t[1]||(t[1]=[o("p",null,"Loading observations...",-1)])])):i.value.length===0&&n.value?(l(),d("div",fe,[o("p",null,"No observations found for "+b(n.value.name),1)])):(l(),h(G(ee),{key:2,ref:"dataTable",class:"display nowrap modern-table",width:"100%",data:i.value,columns:K.value,options:M.value},{default:f(()=>[...t[2]||(t[2]=[o("thead",null,[o("tr",null,[o("th",null,"Observation"),o("th",null,"Value"),o("th",null,"Date")])],-1)])]),_:1},8,["data","columns","options"]))])])]),_:1})]),_:1})])}}}),Ce=le(pe,[["__scopeId","data-v-ea8f2e52"]]);export{Ce as default};
