import{D as le,d as oe,r as c,an as re,c as ie,a as ue,H as de,O as ce,f as g,J as i,l as n,u as s,a3 as me,k as r,aS as fe,aP as ve,e as A,m as z,dh as pe,E as we,Q as v,K as D,b2 as h,W as P,cX as H,bC as ge,c4 as M,c3 as E,N as U,br as O,p,a6 as he}from"./vendor-yRLTeOJQ.js";import{v as V,a0 as K,a1 as W,t as L,U as Pe,G as ye,a2 as j,s as y,a3 as Ae,a4 as Ie,a5 as Se,a as Ce,a6 as be,_ as ke}from"../index-DIiUW7kT.js";import{i as _e}from"./Img-CJEgX1Vr.js";import{p as xe,g as Me}from"./userService-Dvg59Ulg.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-kFb9FTI6.js";const F=le("authStatusStore",{state:()=>({emrAuthenticated:!1,miumAuthenticated:!1,lastLoginAttempt:null,loginTimestamp:null,username:""}),getters:{isPartiallyAuthenticated:l=>l.emrAuthenticated||l.miumAuthenticated,isFullyAuthenticated:l=>l.emrAuthenticated&&l.miumAuthenticated,authenticationStatus:l=>l.emrAuthenticated&&l.miumAuthenticated?"full":l.emrAuthenticated||l.miumAuthenticated?"partial":"none",authenticatedSystems:l=>{const u=[];return l.emrAuthenticated&&u.push("EMR"),l.miumAuthenticated&&u.push("MIUM"),u},failedSystems:l=>{const u=[];return l.emrAuthenticated||u.push("EMR"),l.miumAuthenticated||u.push("MIUM"),u}},actions:{setEMRAuthenticated(l){this.emrAuthenticated=l,l&&(this.loginTimestamp=new Date)},setMIUMAuthenticated(l){this.miumAuthenticated=l},setUsername(l){this.username=l},recordLoginAttempt(){this.lastLoginAttempt=new Date},clearAuthStatus(){this.emrAuthenticated=!1,this.miumAuthenticated=!1,this.loginTimestamp=null,this.lastLoginAttempt=null,this.username=""},hasSystemAccess(l){return l==="EMR"?this.emrAuthenticated:this.miumAuthenticated}},persist:!0}),Ee={class:"login-container"},Ue={key:0,style:{"justify-content":"center",display:"block"}},Le={style:{"font-size":"15px"}},Re={style:{"font-size":"12px",color:"#34af4d"}},Ne={key:1},qe={style:{"font-size":"15px"}},ze={key:0},De={style:{"text-align":"left"}},Fe={class:"signup-link"},$e={style:{display:"flex","justify-content":"center","align-items":"center"}},Te={key:1},Be={style:{"text-align":"left"}},He={key:0,class:"password-requirements"},Oe={class:"requirements-list"},Ve={class:"signup-link"},Ke=oe({__name:"Login",setup(l){const u=c(""),f=c(""),R=c(""),I=c(!1),w=c(!1),N=c("test"),m=c(new be),t=c({username:"",currentPassword:"",newPassword:"",confirmPassword:""}),S=c(!1),C=c(!1),b=c(!1),q=re(),G=V(),k=K(),$=ie(()=>t.value.username.trim()!==""&&t.value.currentPassword.trim()!==""&&t.value.newPassword.trim()!==""&&t.value.confirmPassword.trim()!==""&&W(t.value.newPassword)&&t.value.newPassword===t.value.confirmPassword&&t.value.newPassword!==t.value.currentPassword),J=()=>{k.checkLoginStatus()&&q.push("/home")},Q=async()=>{G.terminate(),await V().postData("SET_OFFLINE_PROGRAMS")},X=()=>{R.value=localStorage.getItem("core_version")||""},Y=async()=>{const a=K(),e=await Me();e&&(a.setUserFacilityName(e.name),a.setFacilityLocation(e),localStorage.setItem("facility_code",e.code))},Z=async()=>{const a=await m.value.checkUserPrograms(void 0);a!=null&&a.programs&&Ce().setAuthorizedPrograms(a==null?void 0:a.programs)},_=()=>{w.value=!w.value,w.value&&(t.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""})},ee=()=>{L("Help functionality to be implemented")},te=async()=>{if(!$.value){L("Please complete all fields correctly"),L("Password must be at least 8 characters long and contain at least one uppercase letter, one lowercase letter, one number, and one special character.");return}try{const a=await m.value.requestLogin(t.value.currentPassword,t.value.username);if(a){const{authorization:e}=a,{token:d,user:o}=e;o&&(localStorage.setItem("apiKey",d),await Pe.updateUser(o.user_id,{password:t.value.newPassword}),ye("Password changed successfully!"),await m.value.requestLogin(t.value.newPassword,t.value.username),t.value={username:"",currentPassword:"",newPassword:"",confirmPassword:""},w.value=!1,localStorage.setItem("apiKey",""))}}catch(a){a instanceof j?y("Current password is incorrect"):y("Error changing password: ".concat(a))}},se=async()=>{const a=F();if(!u.value||!f.value)return{success:!1,error:null,validationError:!0};m.value.setUsername(u.value),a.setUsername(u.value);try{return await m.value.login(f.value),await Y(),await Z(),await Se(),await xe(),a.setEMRAuthenticated(!0),k.setLoginStatus(!0),{success:!0,error:null}}catch(e){return a.setEMRAuthenticated(!1),k.setLoginStatus(!1),{success:!1,error:e}}},ae=async()=>{const a=F();if(!u.value||!f.value)return{success:!1,error:null,validationError:!0};m.value.setUsername(u.value);try{return await m.value.loginToMIUM(f.value),a.setMIUMAuthenticated(!0),{success:!0,error:null}}catch(e){return a.setMIUMAuthenticated(!1),{success:!1,error:e}}},T=async()=>{const a=F();if(!u.value||!f.value){L("Complete form to log in");return}a.recordLoginAttempt();const[e,d]=await Promise.allSettled([se(),ae()]),o=e.status==="fulfilled"&&e.value.success,B=d.status==="fulfilled"&&d.value.success;if(o)q.push("/home");else if(!o&&!B){const x=e.status==="fulfilled"?e.value.error:e.reason;x instanceof j?y("Invalid username or password"):x instanceof Ae?(_(),y("Please change your password",5e4)):x instanceof Ie?(_(),y("Your password has expired. Please change your password",5e4)):y("".concat(x),5e4)}else!o&&B&&(e.status==="fulfilled"?e.value.error:e.reason)},ne=a=>{q.push(a)};return ue(async()=>{J(),k.setLoginStatus(!1),await m.value.loadConfig(),X(),await Q()}),(a,e)=>{const d=de("ion-icon");return g(),ce(s(he),null,{default:i(()=>[n(s(me),{class:"ion-padding login-page"},{default:i(()=>[r("div",Ee,[n(s(fe),{style:{"background-color":"#fff"}},{default:i(()=>[n(s(ve),null,{default:i(()=>[n(s(pe),{class:"login_img",src:s(_e)("mw.png"),id:"logo"},null,8,["src"]),n(s(we),{class:"login-title"},{default:i(()=>[N.value==="development"||N.value==="test"?(g(),A("span",Ue,[r("div",null,[e[11]||(e[11]=v(" MaHIS ",-1)),r("small",Le,"(v"+D(R.value)+")",1)]),r("div",Re,"("+D(N.value)+")",1)])):(g(),A("span",Ne,[e[12]||(e[12]=v(" MaHIS ",-1)),r("small",qe,"(v"+D(R.value)+")",1)]))]),_:1}),w.value?z("",!0):(g(),A("div",ze,[r("span",De,[n(s(h),{value:u.value,onIonInput:e[0]||(e[0]=o=>u.value=o.target.value||""),type:"text",label:"Username",ref:"usernameRef","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:i(()=>[n(s(P),{slot:"end"},{default:i(()=>[n(d,{icon:s(H)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),n(s(h),{value:f.value,onIonInput:e[2]||(e[2]=o=>f.value=o.target.value||""),type:I.value?"text":"password",label:"Password",ref:"passwordRef","label-placement":"floating",fill:"outline",placeholder:"Enter Password",class:"input-fields",required:"",onKeydown:ge(T,["enter"])},{default:i(()=>[n(s(P),{slot:"end"},{default:i(()=>[n(d,{icon:I.value?s(M):s(E),onClick:e[1]||(e[1]=o=>I.value=!I.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"])]),n(s(U),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:T,class:"login-button"},{default:i(()=>[...e[13]||(e[13]=[v(" Login ",-1)])]),_:1}),r("p",Fe,[e[17]||(e[17]=v(" For help click ",-1)),r("a",{href:"#",onClick:O(ee,["prevent"])},"Here"),e[18]||(e[18]=v()),e[19]||(e[19]=r("br",null,null,-1)),r("div",$e,[n(s(U),{fill:"clear",size:"small",onClick:_,style:{display:"inline","--padding-start":"2px","--padding-end":"2px"}},{default:i(()=>[...e[14]||(e[14]=[r("span",{style:{"text-decoration":"underline",color:"#34af4d",cursor:"pointer"}}," Change Password ",-1)])]),_:1}),e[16]||(e[16]=v(" | ",-1)),n(s(U),{fill:"clear",size:"small",onClick:e[3]||(e[3]=o=>ne("/downloads")),style:{display:"inline","--padding-start":"2px","--padding-end":"2px"}},{default:i(()=>[...e[15]||(e[15]=[r("span",{style:{"text-decoration":"underline",color:"#34af4d",cursor:"pointer"}}," Download MaHIS ",-1)])]),_:1})])])])),w.value?(g(),A("div",Te,[e[22]||(e[22]=r("h3",{style:{"text-align":"center","margin-bottom":"20px",color:"#34af4d"}},"Change Password",-1)),r("span",Be,[n(s(h),{value:t.value.username,onIonInput:e[4]||(e[4]=o=>t.value.username=o.target.value||""),type:"text",label:"Username","label-placement":"floating",fill:"outline",placeholder:"Enter Username",class:"input-fields",required:""},{default:i(()=>[n(s(P),{slot:"end"},{default:i(()=>[n(d,{icon:s(H)},null,8,["icon"])]),_:1})]),_:1},8,["value"]),n(s(h),{value:t.value.currentPassword,onIonInput:e[6]||(e[6]=o=>t.value.currentPassword=o.target.value||""),type:S.value?"text":"password",label:"Current Password","label-placement":"floating",fill:"outline",placeholder:"Enter Current Password",class:"input-fields",required:""},{default:i(()=>[n(s(P),{slot:"end"},{default:i(()=>[n(d,{icon:S.value?s(M):s(E),onClick:e[5]||(e[5]=o=>S.value=!S.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type"]),n(s(h),{value:t.value.newPassword,onIonInput:e[8]||(e[8]=o=>t.value.newPassword=o.target.value||""),type:C.value?"text":"password",label:"New Password","label-placement":"floating",fill:"outline",placeholder:"Enter New Password",class:p(["input-fields",{"invalid-input":t.value.newPassword&&!s(W)(t.value.newPassword)}]),required:""},{default:i(()=>[n(s(P),{slot:"end"},{default:i(()=>[n(d,{icon:C.value?s(M):s(E),onClick:e[7]||(e[7]=o=>C.value=!C.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"]),n(s(h),{value:t.value.confirmPassword,onIonInput:e[10]||(e[10]=o=>t.value.confirmPassword=o.target.value||""),type:b.value?"text":"password",label:"Confirm New Password","label-placement":"floating",fill:"outline",placeholder:"Confirm New Password",class:p(["input-fields",{"invalid-input":t.value.confirmPassword&&t.value.newPassword!==t.value.confirmPassword}]),required:""},{default:i(()=>[n(s(P),{slot:"end"},{default:i(()=>[n(d,{icon:b.value?s(M):s(E),onClick:e[9]||(e[9]=o=>b.value=!b.value)},null,8,["icon"])]),_:1})]),_:1},8,["value","type","class"])]),t.value.newPassword?(g(),A("div",He,[e[20]||(e[20]=r("p",{class:"requirements-title"},"Password Requirements:",-1)),r("ul",Oe,[r("li",{class:p({valid:t.value.newPassword.length>=8})},"At least 8 characters",2),r("li",{class:p({valid:/[A-Z]/.test(t.value.newPassword)})},"One uppercase letter",2),r("li",{class:p({valid:/[0-9]/.test(t.value.newPassword)})},"One number",2),r("li",{class:p({valid:/[@#$%^&+=*!-]/.test(t.value.newPassword)})}," One special character (@#$%^&+=*!-) ",2),r("li",{class:p({valid:t.value.newPassword!==t.value.currentPassword&&t.value.currentPassword!==""})}," Different from current password ",2)])])):z("",!0),n(s(U),{expand:"block",style:{"--background":"var(--ion-color-primary)","font-size":"var(--ion-button-font)"},onClick:te,class:"login-button",disabled:!$.value},{default:i(()=>[...e[21]||(e[21]=[v(" Change Password ",-1)])]),_:1},8,["disabled"]),r("p",Ve,[r("a",{href:"#",onClick:O(_,["prevent"])},"Back to Login")])])):z("",!0)]),_:1})]),_:1})])]),_:1})]),_:1})}}}),Ye=ke(Ke,[["__scopeId","data-v-18536141"]]);export{Ye as default};
