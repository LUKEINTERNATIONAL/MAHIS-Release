import{d as Ue,ao as Je,cp as $e,r as n,c as te,aV as f,a as Ge,w as u,O as ae,f as V,J as H,l,e as Ye,m as se,k as v,u as P,bx as qe,dz as Qe,a3 as Xe,i as w,bM as ne,v as y,a6 as je,eJ as Ke,b9 as S}from"./vendor-BolvhNQv.js";import{u as Ze,_ as et,s as tt,d as at,a as st}from"./nonPharmaTherapyStore-BQv8Bqpw.js";import{u as nt,aJ as ot,bX as it,aL as lt,d as rt,aN as ct,a1 as ut,b7 as mt,bE as pt,bp as vt,aU as dt,T as ft,J as oe,G as b,s as g,ag as gt,b3 as ht,H as z,aO as O,aQ as ie,bV as Dt,S as Pt,t as U,bH as J,q as _,n as wt,_ as yt}from"../index-vq0ibwVO.js";import{D as St}from"./DemographicBar-B5vMMd7x.js";import{C as bt,b as Ot,O as Tt}from"./OPDOutcome-o4mnolyH.js";import{I as At,N as Ct}from"./NextAppointment-CzsVVwQD.js";import{O as _t}from"./OPDDiagnosis-CkddUOCi.js";import{O as It}from"./OPDPrintingModal-QQlhu2JR.js";import{l as kt}from"./lodash-NJiRuGo9.js";import{u as xt}from"./usePatientProfile-CrjyW3oi.js";import{u as Nt}from"./useUserActivities-CclU2PzE.js";import"./drug_prescription_service-SzQuF0yJ.js";import"./patient_diagnosis_service-DTPzN7Sj.js";import"./apexcharts-Go-aTq24.js";import"./LevelOfConsciousness.vue_vue_type_script_setup_true_lang-rVpCGXFs.js";import"./previousComplaints-Odz0HsVm.js";import"./patient_complaints_service-wUEwlsFR.js";import"./DashBox-DazG8gOA.js";import"./BasicForm-9ScFfK1R.js";import"./DateInputField-RK9lkDyW.js";import"./formatServerData-B5-_Z0cd.js";import"./Outcome-Dile7s5u.js";import"./LabOrdersList-DP3IM6xD.js";import"./group_validation-CdCc72SE.js";import"./RadiologyStore-BbgMYe4N.js";import"./user_role_management-CDCL5AAx.js";import"./ncd_appointment_service-D_2Y4Jkl.js";import"./Registration-DDPNSPga.js";import"./useLocation-CHy2vww3.js";import"./vaccines_service-xfZx5mPZ.js";import"./sms_service-OAYTmMoM.js";import"./EIRreportsStore-hgF2UhSl.js";import"./Export-sI8BEwn4.js";import"./useNeonatalEnrollmentStore-DndLv6lC.js";import"./enrollment-DU-PLRUa.js";const Lt={key:0,class:"spinner-overlay"},Bt={style:{width:"90vw",margin:"0 auto","margin-top":"10px"}},Rt={class:"back_profile"},Ft=Ue({__name:"ConsultationPlan",setup(Mt){const{currentTabIndex:m}=Ze(),{printVisitSummary:le}=xt(),{hasWaitingList:T}=Nt(),d=Je(),re=$e(),I=n(!1),k=n(!0),$=n(!1),x=n(!1),N=n(!0),ce=n(!1),L=n(!1),ue=n(!1),G=nt(),me=ot(),pe=it(),A=lt(),ve=rt(),Y=ct(),de=ut(),fe=mt(),ge=pt(),he=vt(),De=dt(),B=n(!1),h=n(!1),q=te(()=>({text:h.value?"Saving...":"Finish",icon:h.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:B.value||h.value})),{patient:r}=f(G),{investigations:Pe}=f(me),{OPDdiagnosis:we}=f(pe),{selectedMedicalDrugsList:Q}=f(A),{OPDActivities:C}=f(ve),{outcomes:ye}=f(Y),{currentSelectedNextAppointmentDate:Se}=f(ge),{presentingComplaints:be}=f(he),{vitals:Oe}=f(fe),X=te(()=>De.selectedMedicalAllergiesList),j=n(null),R=n(null),K=n(null),Te=n(null),Ae=n(null),Ce=n(null),F=n(null),a=n(),Z=()=>C.value.map(e=>({title:e,icon:""})),_e=async(e,t,s)=>{var c;if(t===0&&await Le(),!await ee())return;await p(),e%1===0&&(m.value=e),F.value&&s&&F.value.changeTab(e),((c=a.value[e])==null?void 0:c.title)==="Investigations"&&R.value&&await R.value.openAHDModal()},D=()=>{var s;if(!a.value||a.value.length===0)return null;const e=m.value>=0&&m.value<a.value.length?m.value:0;switch((s=a.value[e])==null?void 0:s.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(C.value.length>0)switch(C.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Ie=()=>{d.push("home")},ke=()=>{d.push("patientProfile")},xe=async()=>{x.value=!0,b("Printing consultation summary... Please wait.");try{await le(),b("Consultation summary printed successfully!"),setTimeout(()=>{d.push("home")},3500)}catch(e){g("Failed to print consultation summary.")}finally{x.value=!1}},Ne=()=>{b("Patient has finished consultation!"),d.push("home")},ee=async()=>{const e=await gt.getObsByEncounterIdAndDate(ht.PRESENTING_COMPLAINTS);return!!(e&&e.length>0)},p=async()=>{var t,s;const e=z.sessionDate();for(let i=0;i<a.value.length;i++)if(!await ee())k.value=!1,a.value[i].title!=="Clinical Assessment"&&(a.value[i].icon=Ke);else{k.value=!0,$.value=!1;const c=a.value[i];if(c.title==="Clinical Assessment"){const o=O("presentingComplaints");a.value[i].icon=M(e,o)?S:""}else if(c.title==="Investigations"){const o=(s=(t=r.value)==null?void 0:t.labOrders)==null?void 0:s.saved,E=o==null?void 0:o.filter(ze=>z.toStandardHisFormat(e)===z.toStandardHisFormat(ze.order_date));a.value[i].icon=(E==null?void 0:E.length)>0?S:""}else if(c.title==="Diagnosis"){const o=O("diagnosis");a.value[i].icon=M(e,o)?S:""}else if(c.title==="Treatment Plan"){const o=O("treatment");a.value[i].icon=(o==null?void 0:o.length)>0?S:""}else if(c.title==="Next Appointment"){const o=O("appointments");a.value[i].icon=M(e,o)?S:""}else if(c.title==="Outcome"){const o=O("outcomes");a.value[i].icon=(o==null?void 0:o.length)>0?S:""}}W()},M=(e,t)=>{if(!t)return!1;const s=new Date(e);return s.setHours(0,0,0,0),t.some(i=>{const c=new Date(i.obs_datetime||i.order_date);return c.setHours(0,0,0,0),c.getTime()===s.getTime()})},Le=async()=>{var e;I.value=!0;try{await Be(),await Promise.all([(e=j.value)==null?void 0:e.onSubmit()]),await ie(r.value),Dt()}catch(t){throw g("Failed to save clinical assessment"),t}finally{I.value=!1}},Be=async()=>{try{if(kt.isEmpty(X.value))return;const e=X.value.map(s=>({concept_id:s.concept_id,obs_datetime:Pt.getSessionDate(),value_coded:s.concept_id,location_id:de.facilityLocation.code,value_text:s.name})),t=await tt(e);G.setPatientRecord(t)}catch(e){U("Failed to save allergies")}},Re=async()=>{try{const e=await at();r.value={...r.value,...e};const t=await st().saveNonPharmaTherapyPatientData();r.value={...r.value,...t}}catch(e){U("Failed to save treatment plan")}},Fe=()=>{const e=Q.value;return console.log("Checking prescribed medications:",{medicationsCount:e.length,medications:e}),e.length>0},Me=async()=>{var e;try{h.value=!0,await((e=K.value)==null?void 0:e.onSubmit()),await Re(),await Y.saveOutcomPatientData(),await ie(r.value);const t=localStorage.getItem("locationID");if(!t){g("Location ID missing.");return}const s=Fe();if(T("Waiting for Laboratory")){await Ee(t),b("Patient moved to Consultation for Lab follow-up.");return}if(s&&T("Waiting for Consultation")){T("Waiting for Dispensation")?await We(t):await Ve(t);return}if(!s&&T("Waiting for Consultation")){await He(t);return}}catch(t){g("Failed to save consultation.")}finally{h.value=!1}},We=async e=>{try{await J.addPatientToStage(r.value,"DISPENSATION"),await _().refresh(e),A.clearSelectedMedicalDrugsList(),b("Patient moved to Dispensation."),d.push("home")}catch(t){throw g("Failed to move patient to dispensation"),t}},Ee=async e=>{try{await J.addPatientToStage(r.value,"CONSULTATION"),await _().refresh(e),A.clearSelectedMedicalDrugsList(),d.push("home")}catch(t){throw g("Failed to move patient to consultation"),t}},Ve=async e=>{try{await J.addPatientToStage(r.value,"DISPENSATION"),await _().refresh(e),A.clearSelectedMedicalDrugsList(),U("Patient moved to dispensation queue. You lack access to dispense."),d.push("home")}catch(t){throw g("Failed to move patient to dispensation"),t}},He=async e=>{try{await wt(r.value),await _().refresh(e),d.push("home")}catch(t){console.error("Failed to close visit:",t),g("Failed to close visit.")}};Ge(async()=>{if(C.value.length===0){await d.push("home");return}a.value=Z(),await p(),(m.value===void 0||m.value<0)&&(m.value=0),B.value=!1,W()}),u(m,async()=>{await W()}),u(Oe,async()=>{await p()},{deep:!0}),u(r,async()=>{await p()},{deep:!0}),u(Pe,async()=>{await p()},{deep:!0}),u(we,async()=>{await p()},{deep:!0}),u(Q,async()=>{await p()},{deep:!0}),u(ye,async()=>{await p()},{deep:!0}),u(Se,async()=>{await p()}),u(be,async()=>{await p()},{deep:!0}),u(re,async()=>{N.value=!1,a.value=Z(),setTimeout(()=>{m.value=0,N.value=!0},0)},{deep:!0}),u(ue,e=>{L.value=e,L.value&&setTimeout(()=>{L.value=!1},15e3)}),u(q,(e,t)=>{console.log("Done button options changed:",{from:t,to:e,currentStep:m.value,tabsLength:a.value.length})},{deep:!0});const W=()=>{let e=!1;return h.value&&(e=!0),B.value=e,!e};return(e,t)=>(V(),ae(P(je),null,{default:H(()=>[l(It,{onYes:xe,onNo:Ne,isOpen:ce.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),I.value?(V(),Ye("div",Lt,[l(P(qe),{name:"bubbles"}),t[3]||(t[3]=v("div",{class:"loading-text"},"Please wait...",-1))])):se("",!0),l(P(Qe),{"is-open":x.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),l(ft),l(P(Xe),{fullscreen:!0},{default:H(()=>[l(St),v("div",Bt,[N.value?(V(),ae(et,{key:0,ref_key:"wizard",ref:F,headingTitle:"Consultation Plan","vertical-tabs":"","navigable-tabs":k.value,"scrollable-tabs":"",startIndex:0,doneButton:q.value,nextButton:{disabled:$.value},"custom-tabs":a.value,tabs:a.value,onChange:_e,"onComplete:wizard":t[2]||(t[2]=s=>Me())},{default:H(()=>[v("div",null,[v("div",Rt,[l(oe,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:P(ne),"font-weight":"600",onClick:t[0]||(t[0]=s=>Ie())},null,8,["icon"]),l(oe,{name:"Back to Profile",iconSlot:"start",fill:"clear",icon:P(ne),"font-weight":"600",onClick:t[1]||(t[1]=s=>ke()),style:{"margin-left":"15px"}},null,8,["icon"])])]),w(v("div",null,[l(bt,{ref_key:"clinicalAssessmentRef",ref:j},null,512)],512),[[y,D()==="ClinicalAssessment"]]),w(v("div",null,[l(At,{ref_key:"investigationsRef",ref:R},null,512)],512),[[y,D()==="Investigations"]]),w(v("div",null,[l(_t,{ref_key:"diagnosisRef",ref:K},null,512)],512),[[y,D()==="OPDDiagnosis"]]),w(v("div",null,[l(Ot,{ref_key:"treatmentPlanRef",ref:Te},null,512)],512),[[y,D()==="OPDTreatmentPlan"]]),w(v("div",null,[l(Ct,{ref_key:"nextAppointmentRef",ref:Ae},null,512)],512),[[y,D()==="NextAppointment"]]),w(v("div",null,[l(Tt,{ref_key:"outcomeRef",ref:Ce},null,512)],512),[[y,D()==="Outcome"]])]),_:1},8,["navigable-tabs","doneButton","nextButton","custom-tabs","tabs"])):se("",!0)])]),_:1})]),_:1}))}}),Pa=yt(Ft,[["__scopeId","data-v-4f57fc75"]]);export{Pa as default};
