import{d as me,b9 as De,aA as He,bq as $e,a5 as Ae,dt as Ne,e1 as Fe,ak as Re,al as Me,az as xe,ay as Je,L as Pe,K as Ve,bC as Ee,P as qe,b8 as ze,M as Te,G as I,Q as k,f as b,H as u,l as f,k as F,I as ae,a3 as te,e as Y,F as de,T as Oe,bh as ue,aF as Ie,r as p,c as G,w as J,a as ke,m as x,cr as We,et as je,bl as ye,cY as Ye,n as ie,u as Ge}from"./vendor-CJ2tyHrn.js";import{F as j,_ as ve,u as Le,v as Ce,y as ge,n as ce,q as Ke,C as _e,S as N,g as Se,O as se,t as he,G as pe,bJ as Be,x as ne,aq as H,J as be,bb as Ue,o as we,k as Qe,H as W,bK as Xe,a as Ze,a4 as et}from"../index-CPIhguZJ.js";import{E as tt}from"./EnterLabResultsModal-BmOe-JXc.js";import{B as at}from"./BasicForm-BEa7BD3q.js";import{u as st}from"./useUserActivities-DlNwy1Si.js";import"./lodash-NJiRuGo9.js";import"./apexcharts-BtvCa6MI.js";import"./DateInputField-BPowwEHU.js";const nt=me({components:{IonButtons:ze,IonButton:qe,IonModal:Ee,IonHeader:Ve,IonContent:Pe,IonToolbar:Je,IonTitle:xe,IonItem:Me,IonList:Re,IonAvatar:Fe,IonImg:Ne,IonLabel:Ae,IonPage:$e,IonMenu:He,BasicForm:at,IonFooter:De,DynamicButton:j},data(){return{popoverStatus:null}},props:{keyboardClose:{type:Boolean,default:!1},keepContentsMounted:{type:Boolean,default:!1},content:{default:[]},popoverOpen:{type:Boolean,default:!1},event:{type:Event,default:""},title:{type:String,default:""}},methods:{dismiss(){Te.dismiss()},nav(_,c){this.dismiss(),this.$router.push(_)}}}),ot={class:"modal_wrapper"},rt={class:"center text_12"};function lt(_,c,K,C,U,m){const R=I("ion-title"),y=I("ion-button"),i=I("ion-buttons"),L=I("ion-toolbar"),$=I("ion-header"),B=I("ion-skeleton-text"),D=I("ion-col"),S=I("ion-row"),P=I("ion-content"),M=I("ion-modal");return b(),k(M,{"is-open":_.popoverOpen,"show-backdrop":!0,onDidDismiss:c[1]||(c[1]=v=>_.$emit("closePopover",!1)),"keyboard-close":_.keyboardClose},{default:u(()=>[f($,null,{default:u(()=>[f(L,null,{default:u(()=>[f(R,null,{default:u(()=>[F("b",null,"Lab results for ("+ae(_.content.name)+") test",1)]),_:1}),f(i,{slot:"end"},{default:u(()=>[f(y,{onClick:c[0]||(c[0]=v=>_.$emit("closeModal"))},{default:u(()=>[...c[2]||(c[2]=[te("Close",-1)])]),_:1})]),_:1})]),_:1})]),_:1}),f(P,{class:"ion-padding"},{default:u(()=>[F("div",ot,[F("div",rt,[f(S,null,{default:u(()=>[(b(!0),Y(de,null,Oe(_.content.result,(v,V)=>(b(),k(D,{size:"4",key:V},{default:u(()=>[f(S,null,{default:u(()=>[f(D,{size:"8"},{default:u(()=>[v.indicator&&v.indicator.name?(b(),Y(de,{key:0},[te(ae(v.indicator.name),1)],64)):(b(),k(B,{key:1,animated:"",style:{width:"80%"}}))]),_:2},1024),f(D,{class:"bold",size:"0.5"},{default:u(()=>[...c[3]||(c[3]=[te(":",-1)])]),_:1}),f(D,{class:"bold",size:"2"},{default:u(()=>[te(ae(v.value),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})])])]),_:1})]),_:1},8,["is-open","keyboard-close"])}const it=ve(nt,[["render",lt],["__scopeId","data-v-a0bebd3e"]]),dt={style:{display:"flex",gap:"8px"}},ut=me({__name:"AddLabTestModal",setup(_){const c=Le(),K=Ce(),{patient:C}=ue(c),U=Ie(),m=p(""),R=p(""),y=p(""),i=p(""),L=p(null),$=p(null),B=p([]),D=G(()=>w()?"Add HIV Test":"Add Lab Test"),S=G(()=>[{componentType:"multiSelectInputField",name:"test",header:"Test",options:i.value,grid:{s:"6"},icon:ce.search,validation:ge.required,onChange:o=>{m.value=o.name,w()&&(y.value=[])}},{componentType:"multiSelectInputField",name:"specimen",header:"Specimen",grid:{s:"6"},icon:ce.search,validation:ge.required,value:y.value.length==1?y.value[0]:"",options:y.value.length>1?y.value:[]}]),P=G(()=>[{componentType:"checkboxField",type:"single",name:"HIV test",label:"HIV test",value:m.value=="HIV test"},{componentType:"checkboxField",type:"single",name:"Hepatitis B Test",label:"Hepatitis B Test",value:m.value=="Hepatitis B Test"},{componentType:"checkboxField",type:"single",name:"Syphilis",label:"Syphilis",value:m.value=="Syphilis"},{componentType:"checkboxField",type:"single",name:"Hepatitis C Test",label:"Hepatitis C Test",value:m.value=="Hepatitis C Test"}]);J(m,async o=>{if(o)try{y.value=await M(o)}catch(l){y.value=[]}else y.value=[]});const M=async o=>{let l;return N.getPouchDbStatus()||N.getLanConnectionStatus()?l=await Se("specimens"):l=await se.getSpecimens("",1e3),await H.getConceptSet(o,"",{names:l.map(T=>T.name)})};J(C,async()=>{R.value=[...C.value.labOrders.saved,...C.value.labOrders.unsaved]},{deep:!0});const v=()=>{Te.dismiss()},V=()=>{m.value=""},w=()=>m.value=="HIV test"||m.value=="Syphilis"||m.value=="Hepatitis B Test"||m.value=="Hepatitis C Test",E=async()=>N.getPouchDbStatus()||N.getLanConnectionStatus()?await Se("test_types"):await se.getTestTypes(),Q=async()=>{if(!await Z("referral",9)){he("No HIV Test selected");return}pe("HIV Test sent to HTS successfully"),await X()},q=async()=>{if(await Z("",4))try{await Be.addPatientToStage(C.value,"LAB"),pe("The patient successfully sent to the lab. You may now attend to other patients."),await X()}catch(o){console.error("Error sending to lab:",o),ne("Failed to send patient to lab")}v()},X=async()=>{v();const o=String(localStorage.getItem("locationID"));if(!o){ne("Location not found");return}await K.refresh(o),await U.push("/home")},Z=async(o="",l)=>{try{const n=$.value.getFormValues();if(!n||Object.keys(n).length===0||!Object.values(n).some(O=>O))return!1;const h=Object.keys(n).map(async O=>{n[O]&&B.value.push({order_type_id:l,concept_id:await H.getConceptID(O,!0),name:O,specimen:"Blood",reason:"Routine",specimenConcept:await H.getConceptID("Blood",!0),referral:o})});return await Promise.all(h),B.value.length>0&&await ee(B.value),n}catch(n){return console.error("Error saving HIV tests:",n),!1}},oe=async()=>{if(L.value.validateForm()){he("Test not saved");return}if(!L.value){console.error("Form reference is not available");return}const o=L.value.getFormValues(),l=o.test.name,n=o.specimen.name,T=[{concept_id:o.test.concept_id,name:l,specimen:n,reason:"Routine",specimenConcept:await H.getConceptID(n,!0)}];await ee(T),v()},ee=async o=>{var T,h,O,e,s,a;const l=await se.buildLabOrders("",o),n=JSON.parse(JSON.stringify(C.value));(O=(h=(T=n.labOrders)!=null?T:n.labOrders={}).unsaved)!=null||(h.unsaved=[]),(a=(s=(e=n.labOrders)!=null?e:n.labOrders={}).saved)!=null||(s.saved=[]),n.labOrders.unsaved.push(...l),await be(n),R.value=[...n.labOrders.saved,...n.labOrders.unsaved]};return ke(async()=>{i.value=await E()}),(o,l)=>(b(),k(Ke,{title:D.value,subtitle:""},{"top-buttons":u(()=>[F("div",dt,[w()?x("",!0):(b(),k(j,{key:0,onClick:l[0]||(l[0]=n=>oe()),name:"Save",fill:"solid",style:{}})),w()?(b(),k(j,{key:1,onClick:l[1]||(l[1]=n=>Q()),name:"Send to HTS",fill:"solid",style:{}})):x("",!0),w()?(b(),k(j,{key:2,onClick:l[2]||(l[2]=n=>q()),name:"Send to Lab",fill:"solid",style:{}})):x("",!0),w()?(b(),k(j,{key:3,onClick:l[3]||(l[3]=n=>V()),color:"danger",name:"Back",fill:"solid",style:{}})):x("",!0)])]),content:u(()=>[w()?x("",!0):(b(),k(_e,{key:0,formData:S.value,ref_key:"formRef",ref:L},null,8,["formData"])),w()?(b(),k(_e,{key:1,formData:P.value,ref_key:"formRefHiv",ref:$},null,8,["formData"])):x("",!0)]),_:1},8,["title"]))}}),ct=ve(ut,[["__scopeId","data-v-5cf5d632"]]),pt={class:"container"},bt={class:"table-responsive"},mt=me({__name:"LabOrdersList",props:{propOrders:{default:()=>[]},showAddTestButton:{type:Boolean,default:!0},showSendToLabButton:{type:Boolean,default:!0}},setup(_){const c=_,K=Ie(),C=We(),U=Le(),m=Ue(),R=Ce(),{hasWaitingList:y}=st(),{patient:i}=ue(U),{investigations:L}=ue(m),$=p(),B=p([]),D=p(["Lab Test","Specimen","Accession Number","Location","Order Date","Result","Action"]),S=p([]),P=p([]),M=p(""),v=p(!1),V=p(""),w=je(()=>{var e;return(e=i.value)==null?void 0:e.labOrders}),E=ce,Q=G(()=>{const e=[];return c.showAddTestButton&&e.push({text:" <b>+ Add other tests </b>",className:"add-test text-white",action:async()=>{await Z()}}),c.showSendToLabButton&&e.push({text:" <b>Send to Lab </b>",className:"send-lab text-white",attr:{id:"send-to-lab-btn"},action:async()=>{await oe()}}),{responsive:!0,select:!1,layout:{topStart:"buttons",topEnd:"search",bottomStart:"info",bottomEnd:"paging"},ordering:!1,buttons:e}}),q=()=>{var t;const s=((t=Ze().activeProgram)==null?void 0:t.program_id)===14&&!y("Waiting for Laboratory"),a=document.getElementById("send-to-lab-btn");a&&(s&&o.value?a.style.display="inline":a.style.display="none")},X=async e=>{const s=[{concept_id:await H.getConceptID(e.name,!0),name:e.name,specimen:e.specimen,reason:"Routine",specimenConcept:await H.getConceptID(e.specimen,!0)}];let t=(await se.buildLabOrders("",s))[0];if(t.order_date=t.date||W.sessionDate(),t.specimen.name||(t.specimen.name=await H.getConceptName(t.specimen.concept_id)),t.tests&&t.tests.length>0)for(let r=0;r<t.tests.length;r++)t.tests[r].name||(t.tests[r].name=await H.getConceptName(t.tests[r].concept_id));i.value.labOrders.unsaved.push(t),await be(i.value),await h()},Z=async()=>{await we(ct,{class:"large-medium-width-modal"},!0),await h()},oe=async()=>{await Qe("Do you want to send this patient to the lab?",{confirmBtnLabel:"Send to Lab",returnName:!0})=="Confirm"&&await ee()},ee=async()=>{try{const e=String(localStorage.getItem("locationID"));if(!e){ne("Location not found");return}await Be.addPatientToStage(i.value,"LAB"),await R.refresh(e),await K.push("home"),pe("The patient successfully sent to the lab. You may now attend to other patients.")}catch(e){console.error("Error sending to lab:",e),ne("Failed to send patient to lab")}},o=G(()=>{const e=w.value;if(!e)return!1;const s=e.saved||[],a=e.unsaved||[],t=[...s,...a];return t.length===0?!1:t.some(r=>!(r!=null&&r.tests)||!Array.isArray(r.tests)?!1:r.tests.some(g=>!(g!=null&&g.result)||g.result.length===0))}),l=async()=>{var s,a,t,r,g;if(!((s=i.value)!=null&&s.labOrders)||(S.value=[...(t=(a=i.value)==null?void 0:a.labOrders)==null?void 0:t.saved,...(g=(r=i.value)==null?void 0:r.labOrders)==null?void 0:g.unsaved],!S.value))return;const e=await S.value.filter(d=>W.toStandardHisFormat(W.sessionDate())===W.toStandardHisFormat(d.order_date));e.length>0?L.value[0].selectedData=e:L.value[0].selectedData=""},n=async(e,s)=>{var t,r,g;if(await et("Do you want to delete ".concat(e.tests[0].name," ?"),s)){const d=JSON.parse(JSON.stringify(i.value));d.labOrders.saved.some(A=>{var z,fe;return A.order_date===e.order_date&&((z=A==null?void 0:A.tests[0])==null?void 0:z.name)==((fe=e==null?void 0:e.tests[0])==null?void 0:fe.name)})?(d.labOrders.saved=T(d.labOrders.saved,e.tests[0].name,e.order_date),(g=(r=(t=d.labOrders)!=null?t:d.labOrders={}).voided)!=null||(r.voided=[]),d.labOrders.voided.push({orderId:e.id,reason:"Mistake entry"})):d.labOrders.unsaved=T(d.labOrders.unsaved,e.tests[0].name,e.date),await be(d)}await h()},T=(e,s,a)=>e.filter(t=>(t.order_date===a&&(t.tests=t.tests.filter(r=>r.name!==s)),t.tests.length>0)),h=async()=>{if(!i.value.labOrders)return;S.value=[...i.value.labOrders.saved,...i.value.labOrders.unsaved];const e=O(S.value),a=(N.getProgramID()==32?[["FBS","Blood","","","","",'<button class="btn btn-outline-success btn-sm order-btn" data-id=\''.concat(JSON.stringify({name:"FBS",specimen:"Blood"}),"'>Order Test</button> ")],["HbA1c","Blood","","","","",'<button class="btn btn-outline-success btn-sm order-btn" data-id=\''.concat(JSON.stringify({name:"HbA1c",specimen:"Blood"}),"'>Order Test</button> ")],["RBS","Blood","","","","",'<button class="btn btn-outline-success btn-sm order-btn" data-id=\''.concat(JSON.stringify({name:"RBS",specimen:"Blood"}),"'>Order Test</button> ")]]:[]).filter(t=>!e.some(r=>r[0]===t[0]));B.value=[...e,...a],q(),await l(),ye.use(Ye)},O=(e,s)=>e.length>0?e.flatMap(a=>a.tests.flatMap(t=>{var le,A,z;const r='<button class="btn btn-outline-success btn-sm result-btn" data-id=\''.concat(JSON.stringify(a),"'>Enter Result</button> "),g='<button class="btn btn-outline-secondary btn-sm view-btn" data-id=\''.concat(JSON.stringify(t),"'>").concat(E.view2,"</button> ");let d=r;((le=t==null?void 0:t.result)==null?void 0:le.length)==1?d=(t==null?void 0:t.result)!=null?((A=t==null?void 0:t.result[0])==null?void 0:A.value)||"":null:((z=t==null?void 0:t.result)==null?void 0:z.length)>1&&(t==null||t.result,d=g);let re="";return a!=null&&a.accession_number&&(re='<button class="btn btn-outline-secondary btn-sm" data-id=\''.concat(JSON.stringify(a),"'>").concat(E.print2,"</button>")),[[t==null?void 0:t.name,a==null?void 0:a.specimen.name,(a==null?void 0:a.accession_number)||"",(a==null?void 0:a.order_type_id)==9?"<span class='red-tag'>HTS</span>":"",W.toStandardHisFormat(a==null?void 0:a.order_date),d,re+'\n                        <button class="btn btn-outline-danger btn-sm delete-btn" data-id=\''.concat(JSON.stringify(a),"'>").concat(E.delete2,"</button>\n                        ")]]})):[];return ke(async()=>{N.getProgramID()==14&&Q.value.buttons.push(),await l(),await h(),ie(()=>{const e=$.value.dt;e.columns.adjust().draw(),e.on("click",".result-btn",async s=>{const a=s.target.getAttribute("data-id");await we(tt,{class:"mediumAutoHeightModal"},!0,{test_data:JSON.parse(a)})}),e.on("click",".view-btn",s=>{const a=s.target.getAttribute("data-id");M.value=JSON.parse(a),v.value=!0}),e.on("click",".delete-btn",s=>{const a=s.target.getAttribute("data-id");n(JSON.parse(a),s)}),e.on("click",".order-btn",s=>{const a=s.target.getAttribute("data-id");X(JSON.parse(a))})}),S.value=c.propOrders,V.value=new Xe(i.value.patientID),P.value=await N.getUserRoles()}),J(()=>C,async()=>{await h()},{deep:!0,immediate:!0}),J(()=>i,async()=>{await h()},{deep:!0,immediate:!0}),J(()=>{var e,s,a,t;return[(s=(e=i.value)==null?void 0:e.labOrders)==null?void 0:s.saved,(t=(a=i.value)==null?void 0:a.labOrders)==null?void 0:t.unsaved]},()=>{ie(()=>{q()})},{deep:!0,immediate:!0}),J(o,e=>{console.log("hasTestsWithoutResults changed:",e),ie(()=>{q()})},{deep:!0,immediate:!0}),(e,s)=>(b(),Y("div",pt,[F("div",bt,[f(Ge(ye),{ref_key:"dataTable",ref:$,options:Q.value,data:B.value,class:"display nowrap modern-table",width:"100%"},{default:u(()=>[F("thead",null,[F("tr",null,[(b(!0),Y(de,null,Oe(D.value,a=>(b(),Y("th",{key:a},ae(a),1))),128))])])]),_:1},8,["options","data"])]),f(it,{popoverOpen:v.value,content:M.value,onCloseModal:s[0]||(s[0]=a=>v.value=!1)},null,8,["popoverOpen","content"])]))}}),Tt=ve(mt,[["__scopeId","data-v-054ff036"]]);export{Tt as default};
