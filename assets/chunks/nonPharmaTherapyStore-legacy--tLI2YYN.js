!function(){function e(e,t,a){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var n=a.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}System.register(["../index-legacy-BUSYOKVO.js","./lodash-legacy-pOOc9Efu.js","./drug_prescription_service-legacy-CEjBjXCJ.js","./vendor-legacy-rL86R-cQ.js","./patient_diagnosis_service-legacy-CBeNPo8Q.js"],function(t,a){"use strict";var n,r,i,s,o,d,c,u,l,g,p,v,h,m,y,f,D,_,b,S,N,P,w;return{setters:[e=>{n=e.aX,r=e.u,i=e.J,s=e.S,o=e.E,d=e.H,c=e.ao,u=e.bG,l=e.P,g=e.ah,p=e.F,v=e.t,h=e.b1,m=e.bc,y=e.aa,f=e.b},e=>{D=e.l},e=>{_=e.g,b=e.D,S=e.a},e=>{N=e.b2,P=e.D},e=>{w=e.P}],execute:function(){t({a:function(){try{const e=new Date(s.getSessionDate()),t=h().selectedMedicalDrugsList;let a=0;if(t.forEach(e=>{const t=parseInt(e.duration,10);!isNaN(t)&&t>a&&(a=t)}),a<=0)return{date:null,formattedDate:null};const n=new Date(e);n.setDate(e.getDate()+a);const r=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1).padStart(2,"0"),o=n.getFullYear();return{date:n,formattedDate:`${r}/${i}/${o}`}}catch(e){return console.error("Error calculating OPD medication run out date:",e),{date:null,formattedDate:null}}},b:async function(){try{const n=r(),{patient:i}=N(n),s=T(),o=JSON.parse(JSON.stringify(i.value));var e,t,a;if(s.length>0)return null!==(t=(e=null!==(a=o.MedicationOrder)&&void 0!==a?a:o.MedicationOrder={}).unsaved)&&void 0!==t||(e.unsaved=[]),o.MedicationOrder.unsaved=[...o.MedicationOrder.unsaved,...s],p("Drug order(s) has been created"),o}catch(n){v("Unable to create drug orders!")}},c:async function(){try{const n=r(),{patient:i}=N(n),o=I(),d=JSON.parse(JSON.stringify(i.value));if(o.length>0){var e,t,a;null!==(t=(e=null!==(a=d.MedicationOrder)&&void 0!==a?a:d.MedicationOrder={}).unsaved)&&void 0!==t||(e.unsaved=[]),d.MedicationOrder.unsaved=[...d.MedicationOrder.unsaved,...o];const n=m();return n.setMedicationRunOutDate(function(){try{const e=new Date(s.getSessionDate()),t=m().selectedNCDMedicationList;let a=0;if(t.forEach(e=>{const t=parseInt(e.duration,10);!isNaN(t)&&t>a&&(a=t)}),a<=0)return{date:null,formattedDate:null};const n=new Date(e);n.setDate(e.getDate()+a);const r=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1).padStart(2,"0"),o=n.getFullYear();return{date:n,formattedDate:`${r}/${i}/${o}`}}catch(e){return console.error("Error calculating medication run out date:",e),{date:null,formattedDate:null}}}()),n.clearMedicationDataStores(),p("Drug order(s) has been created"),d}v("Unable to create drug orders!")}catch(n){v("Unable to create drug orders!")}},g:async function(){const e=r(),{patient:t}=N(e),a=t.value,n=[8809,903,6410,6409];let i;i=s.getLanConnectionStatus()||s.getPouchDbStatus()?await w.getDiagnosis("",1,15):await s.getJson("diagnosis",{id:7409,page_size:2e3});const o=i.filter(e=>n.includes(e.concept_id));o.push({concept_id:8809,concept_name_id:926,concept_name_type:"FULLY_SPECIFIED",creator:1,date_created:"2004-06-25T00:00:00.000+02:00",date_voided:null,id:72,locale:"en",locale_preferred:0,name:"Hypertension",uuid:"b99faa1e-8d80-11d8-abbb-0024217bb78e",void_reason:null,voided:0,voided_by:null});const d=a.diagnosis.saved.map(e=>e.value_coded),c=a.diagnosis.unsaved.map(e=>e.value_coded),u=[...d,...c],l=o.filter(e=>u.includes(e.concept_id));return l.map(e=>e.name)},s:async function(e){try{var t,a,n;const i=r(),{patient:s}=N(i),o=JSON.parse(JSON.stringify(s.value));return null!==(a=(t=null!==(n=o.allergies)&&void 0!==n?n:o.allergies={}).unsaved)&&void 0!==a||(t.unsaved=[]),o.allergies.unsaved.push(...e),p("Allergies appended to patient record successfully"),o}catch(i){v("Unable to save Allegies!")}}});class a extends n{constructor(e,t){super(e,105,t)}}class O extends n{constructor(e,t){super(e,25,t)}static async get_____(e="",t=1,a=10){}}t("T",class{async onSubmitNotes(e,t,n){const r=new a(e,t);await r.createEncounter(),await r.saveObservationList(n)}async onSubmitAllergies(e,t,a){try{const n=new O(e,t);await n.createEncounter(),await n.saveObservationList(a),p("Allergies saved successfully")}catch(n){console.error("Error saving allergies:",n),v("Failed to save allergies")}}});function E(e){const t=e.match(/(\d+)\s+days/i);return t&&t.length>1?parseInt(t[1]):null}t("P",class{constructor(){e(this,"programID",void 0),e(this,"providerID",void 0),e(this,"patientID",void 0),e(this,"date",void 0),e(this,"demographics",void 0),e(this,"previousDrugPrescriptions",[]),e(this,"previousClinicalNotes",void 0),e(this,"previousDrugAllergies",void 0);const t=r();this.demographics=t.patient,this.patientID=this.demographics.patientID,this.date=i.getSessionDate(),this.providerID=s.getUserID(),this.programID=i.getProgramID(),this.previousClinicalNotes={},this.previousDrugAllergies={}}async getPatientEncounters(){const e=await this.getPatientVisitDates(),t=e.map(async e=>{const t=e.value,a=await o.getEncounters(this.patientID,{date:t});await Promise.all(a.map(async e=>{if("NOTES"==e.type.name){const{observations:t}=e;D.isEmpty(t)||t.forEach(e=>{if("2688"==e.concept_id){const t=d.toStandardHisDisplayFormat(e.obs_datetime);D.isEmpty(this.previousClinicalNotes.hasOwnProperty(t))&&(this.previousClinicalNotes[t]=[]),this.previousClinicalNotes[t].push({date:t,notes:e.value_text})}})}if("TREATMENT"==e.type.name){const{observations:n}=e;if(!D.isEmpty(n))for(const e in n){let r="<UNKNOWN CONCEPT>";const s=n[e];try{var t;r=null!=s&&null!==(t=s.concept)&&void 0!==t&&t.concept_names?s.concept.concept_names[0].name:await c.getConceptName(s.concept_id)}catch(a){console.error(s,a)}const o=await i.resolvePrimaryValue(s),u=d.toStandardHisDisplayFormat(s.date_created);"Allergic"==r&&(this.previousDrugAllergies.hasOwnProperty(u)||(this.previousDrugAllergies[u]=[]),this.previousDrugAllergies[u].push({date:u,value:o}))}}}))});await Promise.all(t);const a=e.map(async e=>{const t=await u.getOrderByPatient(this.patientID,{start_date:e.value});if(!D.isEmpty(t)){const a=t.map(e=>({drugName:e.drug.name,value:d.toStandardHisTimeFormat(e.order.start_date),dose:e.dose,frequency:_(e.frequency),prescription:d.toStandardHisFormat(e.order.auto_expire_date),duration:E(e.order.instructions),other:e}));this.previousDrugPrescriptions.push({prescriptionDate:d.toStandardHisDisplayFormat(e.value),previousPrescriptions:a})}});return await Promise.all(a),{previousDrugPrescriptions:this.previousDrugPrescriptions,previousClinicalNotes:this.previousClinicalNotes,previousDrugAllergies:this.previousDrugAllergies}}async getPatientVisitDates(){return(await l.getPatientVisits(this.patientID,!1)).map(e=>({label:d.toStandardHisDisplayFormat(e),value:e,other:{isActive:e===g.getSessionDate()}}))}});const I=()=>{const e=m();return e.selectedNCDMedicationList.map(t=>{t.frequency=e.frequency_selections[t.drug_id]||"",t.totalDosage=Object.values(t.dosage).reduce((e,t)=>e+Number(t),0);const a=b.getSessionDate(),n=C(t.drug_id);return{drug_inventory_id:t.drug_id,equivalent_daily_dose:"Unknown"==t.totalDosage?0:t.totalDosage*(null==n?void 0:n.value)||0,start_date:a,auto_expire_date:A(a,t.duration),units:t.units,instructions:`${t.name} ${t.totalDosage} ${t.units} ${(null==n?void 0:n.code)||""} for ${t.duration} days`,dose:M(t),frequency:(null==n?void 0:n.code)||"",drug_name:t.drugName,offline_id:s.generateId(s.getUserName()),program_id:s.getProgramID()}})},M=e=>null!=e.dose_strength&&e.dose_strength?Math.trunc(e.dose_strength):1;const T=()=>h().selectedMedicalDrugsList.map(e=>{const t=b.getSessionDate(),a=S.find(t=>t.label===e.frequency)||{};return{drug_inventory_id:e.drug_id,equivalent_daily_dose:"Unknown"==e.dose?0:e.dose*(null==a?void 0:a.value)||0,start_date:t,auto_expire_date:A(t,e.duration),units:e.units,instructions:`${e.drugName}: ${e.dose} ${e.units} ${(null==a?void 0:a.code)||""} for ${e.duration} days`,dose:e.dose,frequency:(null==a?void 0:a.code)||"",drug_name:e.drugName,offline_id:s.generateId(s.getUserName()),program_id:s.getProgramID()}}),C=e=>{const t=m().selectedNCDMedicationList.find(t=>t.drug_id===e);if(!t||!t.dosage)return null;switch(["morning","afternoon","evening"].reduce((e,a)=>e+(t.dosage[a]?1:0),0)){case 1:return t.dosage.morning?S.find(e=>"QAM"===e.code):t.dosage.afternoon?S.find(e=>"QNOON"===e.code):t.dosage.evening?S.find(e=>"QPM"===e.code):S.find(e=>"OD"===e.code);case 2:return S.find(e=>"BD"===e.code);case 3:return S.find(e=>"TDS"===e.code);default:return S.find(e=>"Unknown"===e.code)}},A=(e,t)=>{const a=new Date(e);return a.setDate(a.getDate()+parseInt(t)),d.toStandardHisFormat(a)};t("u",P("nonPharmaTherapyStore",{state:()=>({items:[{id:"wound-dressing",label:"Wound dressing",checked:!1},{id:"patient-education",label:"Patient education",checked:!1},{id:"counseling",label:"Counseling",checked:!1},{id:"minor-surgery",label:"Minor Surgery",checked:!1}],current_patient:{}}),actions:{async saveNonPharmaTherapyPatientData(){const e=y(),t=[];this.items.forEach(a=>{1==a.checked&&t.push({concept_id:11023,value_text:a.label,obs_datetime:d.toStandardHisFormat(s.getSessionDate()),location_id:e.facilityLocation.code})});const a=h().nonPharmalogicalTherapyAndOtherNotes;a&&t.push({concept_id:2592,obs_datetime:s.getSessionDate(),value_text:a,location_id:e.facilityLocation.code});try{if(t.length>0)return this.clearSelectednonPharmaTherapyStore(),p("Non Pharma Therapy staged successfully!"),await async function(e){try{await i.addObsToEncounterPatient(e,f.NOTES)}catch(t){v("Unable to create non pharmalogical notes!")}}(t)}catch(n){v("Unable to update Non Pharma Therapy!")}},clearSelectednonPharmaTherapyStore(){this.items.forEach(e=>{e.checked=!1})},setCurrentPatient(e){this.current_patient=e}},persist:!0}))}}})}();
