import{d as Ze,au as je,cl as qe,r as l,b2 as c,a as Qe,w as m,y as K,f as B,z as H,l as u,e as et,m as X,k as v,u as h,bM as tt,d5 as at,a9 as st,dE as nt,i as P,bG as ot,v as S,af as it}from"./vendor-Ce6VXKpK.js";import{u as rt,aD as lt,aT as ct,a1 as ut,c as mt,aJ as vt,N as dt,a2 as pt,aU as gt,aV as ft,aW as ht,aX as yt,aY as Dt,aZ as wt,T as Pt,D as St,z as p,n as C,H as x,aK as I,ax as Z,a_ as j,t as y,S as It,k as q,l as Q,_ as bt}from"./index-jDwfIs7V.js";import{D as Ot}from"./DemographicBar-Ppc1WeF-.js";import{C as At,I as Ct,O as xt,a as Tt,b as _t}from"./OPDOutcome-C4kDTW2F.js";import{N as Nt,T as ee,s as kt,a as Ft,d as Rt,b as Lt}from"./NextAppointment-CtaQpPhT.js";import{O as Et}from"./OPDPrintingModal-lI7ziquC.js";import{l as M}from"./lodash-Dt8AsbQm.js";import{u as Bt}from"./usePatientProfile-D04xnjCO.js";import{u as Ht}from"./useFormWizard-DZ0eo8hf.js";import{f as O,c as te,a as ae}from"./formatServerData-D7qhq70P.js";import{D as Mt}from"./diagnosis-Sgwh-RIp.js";import"./apexcharts-B3Yf87Cy.js";import"./BasicForm-BohKG4F5.js";import"./DateInputField-B0g8m_hw.js";import"./patient_complaints_service-DeMAWttn.js";import"./DashBox-Cyn7QVMO.js";import"./useExposeFromStandardForm-C8nEdZ3G.js";import"./BasicCard-B7Zboqwt.js";import"./lab_order-CuyAnkcc.js";import"./LabTestsHistory-D2qdOfEC.js";import"./userService-BMqDysMq.js";import"./group_validation-B0T6QaeL.js";import"./drug_prescription_service-BU5f67CH.js";import"./drug_service-BXuDvxkH.js";import"./Outcome-DxJbPnhR.js";import"./ncd_appointment_service-9Dbmq_bS.js";import"./Registration-DXv0weT6.js";import"./useLocation-C1w1BRwE.js";import"./vaccines_service-CWOPlJmm.js";import"./sms_service-CkJ28m0H.js";import"./EIRreportsStore-DdbCQGvt.js";import"./Export-Dx26ADSN.js";const Wt={key:0,class:"spinner-overlay"},zt={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Vt={class:"back_profile"},Ut=Ze({__name:"ConsultationPlan",setup(Yt){const{onTabBeforeChange:se,currentTabIndex:g}=Ht("Consultation Plan"),ne=async e=>{e%1===0&&(g.value=e),await He()},{printVisitSummary:oe}=Bt(),D=je(),ie=qe(),T=l(!1),_=l(!1),N=l(!0),re=l(!1),k=l(!1),le=l(!1),ce=rt(),ue=lt(),me=ct(),ve=ut(),de=mt(),W=vt(),z=dt(),pe=pt(),ge=gt(),fe=ft(),he=ht(),ye=yt(),De=Dt(),we=wt(),{patient:o}=c(ce),{investigations:Pe}=c(ue),{OPDdiagnosis:b}=c(me),{selectedMedicalDrugsList:Se,nonPharmalogicalTherapyAndOtherNotes:V,selectedMedicalAllergiesList:F}=c(ve),{OPDActivities:A}=c(de),{outcomes:Ie}=c(W),{currentSelectedNextAppointmentDate:be}=c(ge),{presentingComplaints:Oe}=c(fe),{pregnancy:Ae}=c(he),{pastMedicalHistory:R}=c(ye),{adult:Ce,minor:xe}=c(De),{physicalExam:L}=c(we),{vitals:Te}=c(pe),U=l(null),_e=l(null),Ne=l(null),ke=l(null),Fe=l(null),Re=l(null),Y=()=>A.value.map(e=>({title:e,icon:"",active:"disabled"})),r=l(Y()),w=()=>{var n;if(!r.value||r.value.length===0)return null;const e=g.value>=0&&g.value<r.value.length?g.value:0;switch((n=r.value[e])==null?void 0:n.title){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome";default:if(A.value.length>0)switch(A.value[0]){case"Clinical Assessment":return"ClinicalAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"OPDDiagnosis";case"Treatment Plan":return"OPDTreatmentPlan";case"Next Appointment":return"NextAppointment";case"Outcome":return"Outcome"}return null}},Le=()=>{D.push("home")},Ee=async()=>{_.value=!0,p("Printing consultation summary... Please wait.");try{await oe(),p("Consultation summary printed successfully!"),setTimeout(()=>{D.push("home")},3500)}catch(e){C("Failed to print consultation summary.")}finally{_.value=!1}},Be=()=>{p("Patient has finished consultation!"),D.push("home")},d=async()=>{var t,n;const e=x.sessionDate();I("vitals");for(let a=0;a<r.value.length;a++){const s=r.value[a];if(s.title==="Clinical Assessment"){const i=I("presentingComplaints");r.value[a].icon=E(e,i)?"check":""}else if(s.title==="Investigations"){const i=(n=(t=o.value)==null?void 0:t.labOrders)==null?void 0:n.saved,f=i==null?void 0:i.filter($=>x.toStandardHisFormat(e)===x.toStandardHisFormat($.order_date));r.value[a].icon=(f==null?void 0:f.length)>0?"check":""}else if(s.title==="Diagnosis"){const i=I("diagnosis");r.value[a].icon=E(e,i)?"check":""}else if(s.title==="Treatment Plan"){const i=I("treatment");r.value[a].icon=(i==null?void 0:i.length)>0?"check":""}else if(s.title==="Next Appointment"){const i=I("appointments");r.value[a].icon=E(e,i)?"check":""}else if(s.title==="Outcome"){const i=I("outcomes");r.value[a].icon=(i==null?void 0:i.length)>0?"check":""}}},E=(e,t)=>{if(!t)return!1;const n=new Date(e);return n.setHours(0,0,0,0),t.some(a=>{const s=new Date(a.obs_datetime||a.order_date);return s.setHours(0,0,0,0),s.getTime()===n.getTime()})},He=async()=>{var e;T.value=!0;try{await Promise.all([Me(),(e=U.value)==null?void 0:e.onSubmit(),We(),ze(),Ye(),Ve()]),await Z(o.value),j()}catch(t){throw console.error("Error saving clinical assessment:",t),C("Failed to save clinical assessment"),t}finally{T.value=!1}},Me=async()=>{var e,t,n,a;try{const i=x.getAgeInYears(o.value.personInformation.birthdate)<18?await O(xe.value):await O(Ce.value);i.length>0&&((a=(n=(t=(e=o.value).levelOfConsciousness)!=null?t:e.levelOfConsciousness={}).unsaved)!=null||(n.unsaved=[]),o.value.levelOfConsciousness.unsaved.push(...i),p("Level of Consciousness saved successfully"))}catch(s){console.error("Failed to save consciousness assessment:",s),y("Failed to save consciousness assessment")}},We=async()=>{var e,t,n,a;try{const s=await O(Ae.value);s.length>0&&((a=(n=(t=(e=o.value).pregnancy)!=null?t:e.pregnancy={}).unsaved)!=null||(n.unsaved=[]),o.value.pregnancy.unsaved.push(...s),p("Pregnancy status saved successfully"))}catch(s){console.error("Failed to save pregnancy status:",s),y("Failed to save pregnancy status")}},ze=async()=>{var e,t,n,a;try{const s=await Je();s.length>0&&((a=(n=(t=(e=o.value).pastMedicalHistory)!=null?t:e.pastMedicalHistory={}).unsaved)!=null||(n.unsaved=[]),o.value.pastMedicalHistory.unsaved.push(...s),p("Past medical history saved successfully"))}catch(s){console.error("Failed to save past medical history:",s),y("Failed to save past medical history")}},Ve=async()=>{var e,t,n,a;try{const s=await $e();s.length>0&&((a=(n=(t=(e=o.value).physicalExam)!=null?t:e.physicalExam={}).unsaved)!=null||(n.unsaved=[]),o.value.physicalExam.unsaved.push(...s),p("Physical examination saved successfully"))}catch(s){console.error("Failed to save physical examination:",s),y("Failed to save physical examination")}},Ue=async()=>{var e,t,n,a,s,i;try{if(((t=(e=b.value[0])==null?void 0:e.selectedData)==null?void 0:t.length)>0){const f=localStorage.getItem("userID");await new Mt().onSubmit(o.value.patientID,f,G(b.value[0].selectedData));const Xe=G(b.value[0].selectedData);(i=(s=(a=(n=o.value).diagnosis)!=null?a:n.diagnosis={}).unsaved)!=null||(s.unsaved=[]),o.value.diagnosis.unsaved.push(...Xe)}b.value[0].selectedData=[]}catch(f){console.error("Failed to save diagnosis:",f),y("Failed to save diagnosis")}},Ye=async()=>{try{const e=localStorage.getItem("userID"),t=o.value.patientID;if(!M.isEmpty(F.value)){const n=J();await new ee().onSubmitAllergies(t,e,n),await kt(n)}}catch(e){console.error("Failed to save allergies:",e),y("Failed to save allergies")}},Ge=async()=>{try{const e=localStorage.getItem("userID"),t=o.value.patientID,n=new ee;if(!M.isEmpty(F.value)){const a=J();await n.onSubmitAllergies(t,e,a)}if(!M.isEmpty(V.value)){const a=[{concept_id:2688,obs_datetime:localStorage.getItem("sessionDate"),value_text:V.value,location_id:z.facilityLocation.code}];await Ft(a)}await Rt(),await Lt().saveNonPharmaTherapyPatientData()}catch(e){console.error("Failed to save treatment plan:",e),y("Failed to save treatment plan")}},G=e=>e?e.map(t=>(t==null?void 0:t.data[0])||(t==null?void 0:t.data)):[],Je=async()=>[...await te(R.value),...await O(R.value),...await ae(R.value)],$e=async()=>[...await te(L.value),...await O(L.value),...await ae(L.value)],J=()=>F.value.map(e=>({concept_id:985,obs_datetime:It.getSessionDate(),value_coded:e.concept_id,location_id:z.facilityLocation.code})),Ke=async()=>{try{await Ue(),await Ge(),await W.saveOutcomPatientData(),await j(),await Z(o.value);const e=localStorage.getItem("locationID"),t=localStorage.getItem("userRoles");if(!e){C("Location ID could not be found. Please check your settings.");return}(t?JSON.parse(t):[]).some(s=>s.role==="Lab")?(await q.movePatientToNextStage(o.value.patientID,"LAB","CONSULTATION",e,o.value.visitID||o.value.visit_id),await Q().refresh(e),await D.push("home"),p("Lab results submitted. Patient can return to consultation")):(await q.movePatientToNextStage(o.value.patientID,"CONSULTATION","DISPENSATION",e,o.value.visitID||o.value.visit_id),await Q().refresh(e),await D.push("home"),p("Consultation patient saved successfully."))}catch(e){console.error("Error saving consultation data:",e),C("Failed to save consultation data")}};return Qe(async()=>{if(A.value.length===0){await D.push("home");return}r.value=Y(),await d(),(g.value===void 0||g.value<0)&&(g.value=0)}),m(Te,async()=>{await d()},{deep:!0}),m(o,async()=>{await d()},{deep:!0}),m(Pe,async()=>{await d()},{deep:!0}),m(b,async()=>{await d()},{deep:!0}),m(Se,async()=>{await d()},{deep:!0}),m(Ie,async()=>{await d()},{deep:!0}),m(be,async()=>{await d()}),m(Oe,async()=>{await d()},{deep:!0}),m(ie,async()=>{N.value=!1,setTimeout(()=>{g.value=0,N.value=!0},0)},{deep:!0}),m(le,e=>{k.value=e,k.value&&setTimeout(()=>{k.value=!1},15e3)}),(e,t)=>(B(),K(h(it),null,{default:H(()=>[u(Et,{onYes:Ee,onNo:Be,isOpen:re.value,title:"Do you want to print the consultation summary?"},null,8,["isOpen"]),T.value?(B(),et("div",Wt,[u(h(tt),{name:"bubbles"}),t[2]||(t[2]=v("div",{class:"loading-text"},"Please wait...",-1))])):X("",!0),u(h(at),{"is-open":_.value,message:"Printing consultation summary...",spinner:"circles"},null,8,["is-open"]),u(Pt),u(h(st),{fullscreen:!0},{default:H(()=>[u(Ot),v("div",zt,[N.value?(B(),K(h(nt),{key:0,ref:"wizard","vertical-tabs":"","navigable-tabs":"","scrollable-tabs":"",disabled:!0,startIndex:0,doneButton:{text:"Finish",icon:"check",hideText:!1,hideIcon:!1,disabled:!1},"custom-tabs":r.value,beforeChange:h(se),onChange:ne,"onComplete:wizard":t[1]||(t[1]=n=>Ke())},{default:H(()=>[v("div",null,[v("div",Vt,[u(St,{name:"Back to Waiting list",iconSlot:"start",fill:"clear",icon:h(ot),"font-weight":"600",onClick:t[0]||(t[0]=n=>Le())},null,8,["icon"])])]),P(v("div",null,[u(At,{ref_key:"clinicalAssessmentRef",ref:U},null,512)],512),[[S,w()==="ClinicalAssessment"]]),P(v("div",null,[u(Ct,{ref_key:"investigationsRef",ref:_e},null,512)],512),[[S,w()==="Investigations"]]),P(v("div",null,[u(xt,{ref_key:"diagnosisRef",ref:Ne},null,512)],512),[[S,w()==="OPDDiagnosis"]]),P(v("div",null,[u(Tt,{ref_key:"treatmentPlanRef",ref:ke},null,512)],512),[[S,w()==="OPDTreatmentPlan"]]),P(v("div",null,[u(Nt,{ref_key:"nextAppointmentRef",ref:Fe},null,512)],512),[[S,w()==="NextAppointment"]]),P(v("div",null,[u(_t,{ref_key:"outcomeRef",ref:Re},null,512)],512),[[S,w()==="Outcome"]])]),_:1},8,["custom-tabs","beforeChange"])):X("",!0)])]),_:1})]),_:1}))}}),Ia=bt(Ut,[["__scopeId","data-v-800d7e90"]]);export{Ia as default};
