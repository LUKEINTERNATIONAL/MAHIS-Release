import{d as ke,aH as Ae,ck as Re,r,c as xe,aR as g,w as l,a as Pe,O as Q,f as Z,J as B,l as u,u as y,a7 as Te,k as f,m as Ie,i as h,bC as Ne,v as D,aa as Be,b6 as C}from"./vendor-Cb0zIxoC.js";import{aE as q,u as Ve,aF as Me,aG as $e,aH as Fe,c as He,aI as ze,f as Le,Z as Ee,d as We,T as je,M as Ge,Q as Ue,H as V,aJ as A,aK as Je,aL as Ke,K as X,t as Qe,n as Ze,aM as R,aN as qe,a0 as Xe,S as Ye}from"./index-BBKhEXH0.js";import{D as Oe}from"./DemographicBar-Dfvb5WNc.js";import{u as M,D as et,C as tt,T as at}from"./TreatmentPlan-gWR3xU05.js";import{u as st,I as nt,N as ot,M as it,s as rt,c as lt,a as ct}from"./NextAppointment-C9NOM4ef.js";import{_ as ut}from"./RiskAssessment.vue_vue_type_script_setup_true_lang-EmLruaLK.js";import{_ as mt}from"./Vitals.vue_vue_type_script_setup_true_lang-MU0GeCfO.js";import{u as ft,_ as vt}from"./useFormWizard-EQaVltCt.js";import{l as dt}from"./lodash-NJiRuGo9.js";import{a as Y,b as gt}from"./formatServerData-Bd-JHF4z.js";import{C as pt}from"./Registration-CtNXVhOy.js";import{u as St}from"./usePatientProfile-DgPzx9G8.js";import"./apexcharts-BmfflAd_.js";import"./DashBox-C9DJEXQO.js";import"./BasicForm-gptjnSmQ.js";import"./DateInputField-PVhJhRPH.js";import"./previousDiagnosis-Zk6w0rF2.js";import"./group_validation-Be5t2Qgs.js";import"./drug_service-pxHNgzLl.js";import"./lab_order-DXcfFuwQ.js";import"./drug_prescription_service-B1xqloEO.js";import"./ncd_appointment_service-BM4AyVKl.js";import"./useLocation-CXWBO4FL.js";import"./useExposeFromStandardForm-DEh6RKaa.js";import"./vaccines_service-CM21lE9U.js";import"./sms_service-DZjW3vvg.js";import"./EIRreportsStore-D9Wh1lhH.js";import"./Export-IPHs4uZ2.js";import"./Outcome-BJBH9RCF.js";const ht={style:{width:"88vw",margin:"0 auto","margin-top":"10px"}},Dt={class:"back_profile"},Xt=ke({__name:"ConsultationPlan",setup(bt,{expose:O}){const{onTabBeforeChange:ee,onChangeCurrentTab:te,currentTabIndex:v}=ft("Consultation Plan"),{printVisitSummary:ae}=St(),x=Ae(),se=Re();r([]),r([]),r(!1);const P=r(!0),T=r(!1),S=r(!1),$=xe(()=>({text:S.value?"Saving...":"Finish",icon:S.value?"hourglass-outline":"checkmark",hideText:!1,hideIcon:!1,disabled:T.value||S.value})),ne=q(),oe=Ve(),ie=Me(),re=$e();Fe();const le=st(),_=He();ze();const ce=Le(),ue=M(),me=Ee(),{patient:o}=g(oe),{vitals:fe}=g(ne),{investigations:ve}=g(ie),{diagnosis:de}=g(re),{substance:ge}=g(ce),{selectedNCDMedicationList:F}=g(le),{FootScreening:pe,visualScreening:Se,cvScreening:he}=g(ue),{sessionDate:H}=g(me),{apiStatus:Ct}=g(We());l($,(e,t)=>{console.log("Done button options changed:",{from:t,to:e,currentStep:v.value,tabsLength:n.value.length}),e.disabled!==(t==null?void 0:t.disabled)&&console.log("Done button ".concat(e.disabled?"disabled":"enabled")),e.text!==(t==null?void 0:t.text)&&console.log('Done button text changed from "'.concat(t==null?void 0:t.text,'" to "').concat(e.text,'"'))},{deep:!0}),l(S,(e,t)=>{e!==t&&(console.log("Saving state changed: ".concat(t," -> ").concat(e)),console.log(e?"Starting save process...":"Save process completed"))});const De=e=>{console.log("Done button change received from wizard:",e),e.newOptions.disabled&&console.log("Done button has been disabled"),e.isLastStep&&console.log("User is on the last step, done button should be visible")},w=()=>{let e=!1;return p(),S.value&&(e=!0),T.value=e,!e},be=()=>{x.push("patientProfile")},I=()=>_.NCDActivities.map(e=>({title:e,icon:""})),n=r(I()),z=r(null),L=r(null),E=r(null),W=r(null),j=r(null),G=r(null),U=r(null),p=()=>{var a;if(!n.value||n.value.length===0)return console.log("Tabs not yet initialized"),null;const e=v.value>=0&&v.value<n.value.length?v.value:0;switch((a=n.value[e])==null?void 0:a.title){case"Vital Signs":return"Vitals";case"Risk Assessment":return"RiskAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"DiagnosisComponent";case"Complications Screening":return"ComplicationsScreening";case"Treatment Plan":return"TreatmentPlan";case"Next Appointment":return"NextAppointment";default:if(_.NCDActivities.length>0)switch(_.NCDActivities[0]){case"Vital Signs":return"Vitals";case"Risk Assessment":return"RiskAssessment";case"Investigations":return"Investigations";case"Diagnosis":return"DiagnosisComponent";case"Complications Screening":return"ComplicationsScreening";case"Treatment Plan":return"TreatmentPlan";case"Next Appointment":return"NextAppointment"}return null}},N=()=>{P.value=!1,setTimeout(()=>{v.value=0,P.value=!0},0)},J=()=>{const e=q();e.setVitals(e.getInitialVitals(o.value.ID))},d=async()=>{var a,m;const e=Ue(H.value,"sessionDate","value")||V.sessionDate(),t=A("vitals");for(let s=0;s<n.value.length;s++){const c=n.value[s];if(c.title==="Vital Signs")n.value[s].icon=k(e,t)?C:"";else if(c.title==="Risk Assessment"){const i=A("substanceAbuse");n.value[s].icon=k(e,i)?C:""}else if(c.title==="Investigations"){const i=(m=(a=o==null?void 0:o.value)==null?void 0:a.labOrders)==null?void 0:m.saved,b=i==null?void 0:i.filter(we=>V.toStandardHisFormat(e)===V.toStandardHisFormat(we.order_date));n.value[s].icon=(b==null?void 0:b.length)>0?C:""}else if(c.title==="Diagnosis"){const i=A("diagnosis");n.value[s].icon=k(e,i)?C:""}else if(c.title==="Complications Screening"){const i=A("screening");n.value[s].icon=k(e,i)?C:""}else c.title==="Treatment Plan"&&(F.value.length>0?n.value[s].icon=it()?C:"":n.value[s].icon="")}w()},k=(e,t)=>{const a=new Date(e);return a.setHours(0,0,0,0),t.some(m=>{const s=new Date(m.obs_datetime);return s.setHours(0,0,0,0),s.getTime()===a.getTime()})},Ce=async()=>{var s,c,i,b;const e=[],t=await Y(Se.value),a=await gt(pe.value),m=await Y(he.value);t.length>0&&e.push({concept_id:await R.getConceptID("Visual acuity",!0),value_text:"visual acuity test",obs_datetime:R.getSessionDate(),child:t}),a.length>0&&e.push({concept_id:await R.getConceptID("Foot check",!0),value_text:"foot screening",obs_datetime:R.getSessionDate(),child:a}),m.length>0&&e.push(...m),e.length>0&&((b=(i=(c=(s=o.value).screening)!=null?c:s.screening={}).unsaved)!=null||(i.unsaved=[]),o.value.screening.unsaved.push(...e),X("Complications saved successfully"))},ye=async()=>{const e=qe();if(!dt.isEmpty(e.selectedMedicalAllergiesList)){const m=Xe(),s=e.selectedMedicalAllergiesList.map(i=>({concept_id:i.concept_id,obs_datetime:Ye.getSessionDate(),value_coded:i.concept_id,location_id:m.facilityLocation.code,value_text:i.name})),c=await rt(s);o.value=Object.assign(o.value,c),console.log("Allergies staged successfully:",o.value),e.clearSelectedMedicalAllergiesList()}const t=await lt();o.value=Object.assign(o.value,t);const a=await ct().saveNonPharmaTherapyPatientData();o.value=Object.assign(o.value,a)},K=async()=>{S.value=!0;try{const e=[{ref:z,name:"Vitals"},{ref:L,name:"Risk Assessment"},{ref:E,name:"Investigations"},{ref:W,name:"Diagnosis"},{ref:j,name:"Complications Screening"},{ref:G,name:"Treatment Plan"},{ref:U,name:"Next Appointment"}];for(const t of e)if(t.ref.value&&typeof t.ref.value.onSubmit=="function")try{await t.ref.value.onSubmit()}catch(a){throw console.error("Error calling ".concat(t.name," onSubmit:"),a),a}else console.log("".concat(t.name," component ref not available or no onSubmit method"));await ye(),await Ce(),await Je(),await Ke(o.value),await _e(),X("Data saved successfully!"),x.push("patientProfile")}catch(e){console.error("Error saving data:",e),Qe("Error occurred while saving data. Please try again.")}finally{S.value=!1}},_e=async()=>{await Ze(pt,{class:"small-confirm-modal "})!=="dismiss"&&await ae()};return Pe(async()=>{if(_.NCDActivities.length===0){x.push("patientProfile");return}M().resetScreening(),n.value=I(),await d(),(v.value===void 0||v.value<0)&&(v.value=0,console.log("Setting initial tab index to 0")),T.value=!1,w()}),l(v,async()=>{await w()}),l(fe,async()=>{await d()},{deep:!0}),l(o,async()=>{M().resetScreening(),await d()},{deep:!0}),l(H,async()=>{await d()},{deep:!0}),l(ve,async()=>{await d()},{deep:!0}),l(de,async()=>{await d()},{deep:!0}),l(ge,async()=>{await d()},{deep:!0}),l(F,async()=>{await d()},{deep:!0}),l(se,async e=>{N(),J(),n.value=I()},{deep:!0}),l(o,async(e,t)=>{e.ID!=t.ID&&(N(),J())},{deep:!0}),O({saveData:K,markWizard:d,refreshWizard:N,validateDoneButtonState:w}),(e,t)=>(Z(),Q(y(Be),null,{default:B(()=>[u(je),u(y(Te),{fullscreen:!0},{default:B(()=>[u(Oe),f("div",ht,[P.value?(Z(),Q(vt,{key:0,ref:"wizard","vertical-tabs":"","navigable-tabs":"","scrollable-tabs":"",startIndex:0,doneButton:$.value,"custom-tabs":n.value,beforeChange:y(ee),onChange:y(te),"onComplete:wizard":t[1]||(t[1]=a=>K()),onDoneButtonChanged:De},{default:B(()=>[f("div",null,[f("div",Dt,[u(Ge,{name:"Back to profile",iconSlot:"start",fill:"clear",icon:y(Ne),"font-weight":"600",onClick:t[0]||(t[0]=a=>be())},null,8,["icon"])])]),h(f("div",null,[u(mt,{ref_key:"vitalsRef",ref:z},null,512)],512),[[D,p()=="Vitals"]]),h(f("div",null,[u(ut,{ref_key:"riskAssessmentRef",ref:L},null,512)],512),[[D,p()=="RiskAssessment"]]),h(f("div",null,[u(nt,{ref_key:"investigationsRef",ref:E},null,512)],512),[[D,p()=="Investigations"]]),h(f("div",null,[u(et,{ref_key:"diagnosisRef",ref:W},null,512)],512),[[D,p()=="DiagnosisComponent"]]),h(f("div",null,[u(tt,{ref_key:"complicationsRef",ref:j},null,512)],512),[[D,p()=="ComplicationsScreening"]]),h(f("div",null,[u(at,{ref_key:"treatmentPlanRef",ref:G},null,512)],512),[[D,p()=="TreatmentPlan"]]),h(f("div",null,[u(ot,{ref_key:"nextAppointmentRef",ref:U},null,512)],512),[[D,p()=="NextAppointment"]])]),_:1},8,["doneButton","custom-tabs","beforeChange","onChange"])):Ie("",!0)])]),_:1})]),_:1}))}});export{Xt as default};
