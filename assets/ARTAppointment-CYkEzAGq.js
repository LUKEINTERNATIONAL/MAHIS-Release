import{P as G,l as y,af as F,j as U,G as I,cx as A,S as q,q as W,_ as J}from"./index-BwanHY4k.js";import{A as k}from"./appointment_service-C-IbUly9.js";import{d as K,r as f,c as Q,a as X,y as b,f as u,z as r,e as m,m as P,l as p,k as Y,F as h,L as x,u as s,da as Z,A as V,B as S,aY as $,bm as ee,aa as te,ab as R,a6 as ae,ac as ne,G as ie,D as oe,a$ as le,O as _}from"./vendor--FxeD1z3.js";import{u as se,s as ue}from"./clinicalDaysStore-B9zD7M1X.js";import"./lodash-Dt8AsbQm.js";import"./app_encounter_service-Btkwsnyb.js";const re={key:0,class:"section-header ion-text-left",style:{"margin-bottom":"10px"}},ce={class:"ion-padding"},de={key:0,style:{"font-style":"italic"}},pe={key:1},me=K({__name:"ARTAppointment",setup(ve,{expose:j}){const C=new G,d=new k(C.getID(),-1),i=f({}),g=f([]),L=f([]),O=f(!1),M=Q(()=>Object.values(i.value).some(e=>e!=="")),a=f({medicationRunOut:{label:"Drug runout",val:"...",formattedValue:"",isLoading:!1,apiObj:{}},userSetAppointment:{label:"Selected date",val:"",formattedValue:"",isLoading:!1},bookedAppointments:{label:"Booked Appointment",val:"",isLoading:!1,limitCache:{}},appointmentLimit:{label:"Appointment limit",val:"",isLoading:!1},clinicDays:{label:"Is clinic day?",val:"No",isLoading:!1},clinicHolidays:{label:"Is holiday?",val:"No",isLoading:!1}}),o={clinicHolidays:{init:async()=>{i.value.clinicDays="";const e=se(),t=W();e.getHolidaydatesDataSize()===0&&(await t.loadHolidayDateProperty(),ue()),L.value=e.getHolidaydates(),a.value.userSetAppointment.val&&v(a.value.userSetAppointment.val)},onDateChange:async e=>{i.value.clinicHolidays="",a.value.clinicHolidays.val="No",D(e)&&(i.value.clinicHolidays="Selected date is a clinic holiday",a.value.clinicHolidays.val="Yes")}},clinicDays:{init:async()=>{i.value.clinicDays="";const e=C.getAge()>18?A.ADULT_CLINIC_DAYS:A.PEADS_CLINIC_DAYS;I.get(e).then(t=>{t&&(g.value=t.split(",").map(n=>n.trim())),a.value.userSetAppointment.val&&v(a.value.userSetAppointment.val)}).catch(t=>{console.error(t),i.value.clinicDays="Failed to load clinic days"})},onDateChange:async e=>{i.value.clinicDays="",a.value.clinicDays.val="Yes",D(e)?a.value.clinicDays.val="No":w(e)||(a.value.clinicDays.val="No",i.value.clinicDays="Selected date is not a clinic day")}},userSetAppointment:{validate:()=>(i.value.userSetAppointment="",a.value.userSetAppointment.val?a.value.bookedAppointments.val>=a.value.appointmentLimit.val?(i.value.userSetAppointment="Appointment limit reached",!1):!0:(i.value.userSetAppointment="Appointment date is required",!1)),buildObs:()=>d.buildValueDate("Appointment date",a.value.userSetAppointment.val),onDateChange:async e=>{a.value.userSetAppointment.val=e,a.value.userSetAppointment.formattedValue=_(a.value.userSetAppointment.val).format("DD/MMM/YYYY")}},bookedAppointments:{onDateChange:async e=>{i.value.bookedAppointments="";let t=0;if(a.value.bookedAppointments.limitCache[e])t=a.value.bookedAppointments.limitCache[e];else{const n=await k.getDailiyAppointments(e);n.length&&(a.value.bookedAppointments.limitCache[e]=n.length,t=n.length)}a.value.bookedAppointments.val=t,a.value.appointmentLimit.val>1&&t>=a.value.appointmentLimit.val&&(i.value.bookedAppointments="Appointment limit reached")}},medicationRunOut:{init:async()=>{v(q.getSessionDate()),i.value.medicationRunOut="";try{const e=await d.getNextAppointment();e&&(v(e.appointment_date),a.value.medicationRunOut.apiObj=e,a.value.medicationRunOut.formattedValue=_(e.drugs_run_out_date).format("DD/MMM/YYYY"))}catch(e){i.value.medicationRunOut="No medication runout date found for this patient",a.value.medicationRunOut.formattedValue="N/A",console.log(e)}},buildObs:()=>{var t;const e=a.value.medicationRunOut.apiObj;return d.buildValueDate("Estimated date",(t=e.nextAppointment)!=null?t:d.date)}},appointmentLimit:{init:async()=>{var e;a.value.appointmentLimit.val=(e=await I.get(A.APPOINTMENT_LIMIT))!=null?e:"N/A"}}};function w(e){const n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][new Date(e).getDay()];return g.value.some(l=>l.trim().toLowerCase()===n.toLowerCase())}function D(e){return new RegExp(e,"i").test(L.value)}const H=e=>{if(!w(e)||D(e))return{textColor:"#ff0000",backgroundColor:"rgba(255, 0, 0, 0.08)"}},E=e=>{var c;const t=new Date(e);t.setHours(0,0,0,0);const n=new Date(d.date);n.setHours(0,0,0,0);const l=(c=a.value.medicationRunOut.apiObj)==null?void 0:c.drugs_run_out_date;if(l){const N=new Date(l);return N.setHours(0,0,0,0),t>=n&&t<=N}return t>=n};function T(){var e;for(const t in o)if(typeof((e=o[t])==null?void 0:e.validate)=="function"&&!o[t].validate())return!1;return!0}async function z(){if(!O.value)return y("Please wait for all data to load before submitting"),!1;if(!T())return y("Please fix the validation errors before submitting"),!1;if(Object.keys(i.value).some(t=>i.value[t]!=="")&&!await F("Are you sure you want to submit with current warnings?"))return!1;const e=await Promise.all(Object.keys(o).map(t=>{var n;return typeof((n=o==null?void 0:o[t])==null?void 0:n.buildObs)=="function"?o[t].buildObs():null}).filter(Boolean));if(!e.length)return y("No observations to save"),!1;try{return await d.createEncounter(),await d.saveObservationList(e),U("Appointment saved!"),!0}catch(t){return y("Error has occured while saving observations"),console.error(t),!1}}function v(e){const t=_(e).format("YYYY-MM-DD");Object.keys(o).forEach(n=>{var l;typeof((l=o==null?void 0:o[n])==null?void 0:l.onDateChange)=="function"&&(a.value[n].isLoading=!0,o[n].onDateChange(t).finally(()=>a.value[n].isLoading=!1))})}async function B(){const e=Object.keys(o).map(t=>{var n;return typeof((n=o[t])==null?void 0:n.init)=="function"?(a.value[t].isLoading=!0,o[t].init().catch(l=>{a.value[t].val="Error loading data...",console.error(l)}).finally(()=>a.value[t].isLoading=!1)):Promise.resolve()});Promise.all(e).then(()=>O.value=!0)}return X(()=>B()),j({onSubmit:z}),(e,t)=>(u(),b(s(le),null,{default:r(()=>[M.value?(u(),m("span",re,[Y("div",ce,[(u(!0),m(h,null,x(i.value,(n,l)=>(u(),m(h,{key:l},[n?(u(),b(s(Z),{key:0,style:{background:"red","font-weight":"bold"}},{default:r(()=>[V(S(n),1)]),_:2},1024)):P("",!0)],64))),128))]),t[2]||(t[2]=Y("hr",{style:{"border-top":"1px dashed #0c0c0c","margin-top":"10px"}},null,-1))])):P("",!0),p(s($),null,{default:r(()=>[p(s(ee),null,{default:r(()=>[p(s(te),null,{default:r(()=>[p(s(R),{"size-sm":"12","size-md":"7"},{default:r(()=>[(u(),b(s(ae),{presentation:"date",size:"cover",locale:"en-US",modelValue:a.value.userSetAppointment.val,"onUpdate:modelValue":t[0]||(t[0]=n=>a.value.userSetAppointment.val=n),onIonChange:t[1]||(t[1]=n=>{var l,c;return v((c=(l=n==null?void 0:n.detail)==null?void 0:l.value)!=null?c:"".split("T")[0])}),highlightedDates:H,isDateEnabled:E,key:"".concat(g.value.length,"-").concat(a.value.userSetAppointment.val)},null,8,["modelValue"]))]),_:1}),p(s(R),{"size-sm":"12","size-md":"5"},{default:r(()=>[p(s(ne),null,{default:r(()=>[(u(!0),m(h,null,x(a.value,(n,l)=>(u(),b(s(ie),{key:l},{default:r(()=>{var c;return[p(s(oe),null,{default:r(()=>[V(S(n.label)+": ",1)]),_:2},1024),n.isLoading?(u(),m("span",de," Please wait... ")):(u(),m("span",pe,S((c=n.formattedValue)!=null?c:n.val),1))]}),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}))}}),he=J(me,[["__scopeId","data-v-cfd9bf61"]]);export{he as default};
