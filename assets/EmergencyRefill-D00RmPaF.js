import{d as M,c_ as R,r as q,a as U,y as V,f as A,z as r,l as n,u as a,ad as k,k as c,ag as F,bq as x,ac as g,ab as _,D as y,A as v,B as b,e as O,F as j,L as z,G,ar as S,O as h}from"./vendor-Ddb6Z0_s.js";import{_ as P}from"./DatePicker.vue_vue_type_script_setup_true_lang-kQ_i1dg4.js";import{S as Y}from"./SelectFacility-BhdO2d25.js";import{P as T,t as Q,m as E,k as W,ae as J,_ as K}from"./index-DuNDgd8X.js";import{A as X}from"./app_encounter_service-Du7cx0ZT.js";import{A as Z}from"./adherence_service-l0Q-aGPC.js";import{g as ee}from"./LocationFieldOptions-D5I2sBUF.js";import"./lodash-Dt8AsbQm.js";const te={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},ne={class:"error"},ae={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},le={class:"error"},re={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},ie={class:"error"},oe={class:"ion-padding",style:{"border-bottom":"dashed #ccc"}},se={class:"error"},ue=M({__name:"EmergencyRefill",setup(de,{expose:$}){const I=new T,m=new X(I.getID(),25,-1,""),d=new Z(I.getID(),m.providerID),l=R({date_of_emergency_refill:"",facility:"",drugs:[],next_appointment:"",selectedFacilityObj:null}),s=q({}),C=q([]),u={date_of_emergency_refill:{required:()=>!0,dataHandler:e=>{l.date_of_emergency_refill=e},validation:async()=>{var t,o,i;if(!l.date_of_emergency_refill){s.value.date_of_emergency_refill="Date is required";return}if(h(l.date_of_emergency_refill).isAfter(h())){s.value.date_of_emergency_refill="Date cannot be in the future";return}const e=(i=(o=(t=d.getLastDrugs())==null?void 0:t[0])==null?void 0:o.order)==null?void 0:i.start_date;e&&h(l.date_of_emergency_refill).isBefore(e)&&await J("Date entered is less than last known dispensation of ".concat(h(e).format("DD-MMM-YYYY")))},buildObs:()=>m.buildValueDate("Prescription refill date",l.date_of_emergency_refill)},facility:{required:()=>!0,dataHandler:e=>{l.facility=e.name},searchFacilities:e=>ee(e).then(t=>C.value=t),validation:()=>{l.facility||(s.value.facility="Facility is required")},buildObs:()=>m.buildValueText("Health facility name",l.facility)},drugs:{required:()=>!0,dataHandler:e=>{e.field==="remainingAmount"?l.drugs[e.index].other.remainingAmount=e.value:e.field==="givenAmount"&&(l.drugs[e.index].other.givenAmount=e.value)},validation:()=>{l.drugs.some(e=>!e.other.remainingAmount||!e.other.givenAmount)&&(s.value.drugs="Please enter both remaining and given amounts for all drugs")},buildObs:()=>l.drugs.map(async e=>{const t=d.calculateAdherence(e.other.drug.quantity,e.other.remainingAmount,H(e.other.drug));return{...await d.buildValueCoded("Medications dispensed",e.value),child:[await d.buildPillCountObs(e.other.drug.order_id,e.other.remainingAmount),await d.buildAdherenceObs(e.other.drug.order_id,e.other.drug.drug_id,t,l.date_of_emergency_refill),await d.buildValueNumber("Amount of drug dispensed",e.other.givenAmount)]}})},next_appointment:{required:()=>!0,dataHandler:e=>{l.next_appointment=e},validation:()=>{if(!l.next_appointment){s.value.next_appointment="Next appointment date is required";return}l.date_of_emergency_refill&&h(l.next_appointment).isBefore(l.date_of_emergency_refill)&&(s.value.next_appointment="Next appointment date must be after emergency refill date")},buildObs:()=>m.buildValueDate("Appointment date",l.next_appointment)}};function H(e){const t=o=>"".concat(o).match(/qod/i)?"QOD":"".concat(o).match(/weekly/i)?"QW":o;return d.calculateExpected(e.quantity,e.equivalent_daily_dose,e.order.start_date,t(e.frequency))}function p(e,t){e in u&&typeof u[e].dataHandler=="function"&&u[e].dataHandler(t),w(e)}function w(e){if(s.value[e]="",typeof u[e].required=="function"&&u[e].required()&&!l[e]){s.value[e]="This field is required";return}l[e]&&typeof u[e].validation=="function"&&u[e].validation()}function N(){return Object.keys(l).reduce((e,t)=>{if(t in u&&l[t]&&typeof u[t].buildObs=="function"){const o=u[t].buildObs();return Array.isArray(o)?[...e,...o]:[...e,o]}return e},[])}async function B(){if(Object.keys(u).forEach(t=>w(t)),Object.keys(s.value).some(t=>"".concat(s.value[t]).length>=1))return Q("Please review form for errors");try{if(!await m.createEncounter())return E("Failed to create encounter");const o=await Promise.all(N());await m.saveObservationList(o),W("Emergency refill saved successfully")}catch(t){console.error("Error saving emergency refill data:",t),E("Failed to save emergency refill data")}}async function L(){await d.loadPreviousDrugs(),l.drugs=d.getLastDrugs().map(e=>({label:e.drug.name,value:e.drug.concept_id,other:{givenAmount:"",remainingAmount:"",drug:e}}))}return U(async()=>{await L()}),$({onSubmit:B}),(e,t)=>{var o;return((o=l.drugs)!=null?o:[]).length<=0?(A(),V(a(F),{key:0,style:{height:"40vh"}},{default:r(()=>[n(a(k),null,{default:r(()=>t[3]||(t[3]=[c("h1",{class:"ion-text-center",style:{"margin-top":"15%"}}," No previous dispensations found. ",-1)])),_:1,__:[3]})]),_:1})):(A(),V(a(F),{key:1},{default:r(()=>[n(a(k),null,{default:r(()=>[c("div",te,[n(a(x),null,{default:r(()=>[n(a(g),null,{default:r(()=>[n(a(_),null,{default:r(()=>[n(a(y),null,{default:r(()=>t[4]||(t[4]=[v("Date of emergency refill")])),_:1,__:[4]}),n(P,{place_holder:"Select date",onDateUpDated:t[0]||(t[0]=i=>p("date_of_emergency_refill","".concat(i.value.year,"-").concat(i.value.month,"-").concat(i.value.day))),date_prop:""}),c("div",ne,b(s.value.date_of_emergency_refill),1)]),_:1})]),_:1})]),_:1})]),c("div",ae,[n(a(x),null,{default:r(()=>[n(a(g),null,{default:r(()=>[n(a(_),null,{default:r(()=>[n(a(y),null,{default:r(()=>t[5]||(t[5]=[v("Facility")])),_:1,__:[5]}),n(Y,{show_error:!1,selected_district_ids:[],selected_location:null,onFacilitySelected:t[1]||(t[1]=i=>{p("facility",i.selected_location)})}),c("div",le,b(s.value.facility),1)]),_:1})]),_:1})]),_:1})]),c("div",re,[n(a(y),null,{default:r(()=>t[6]||(t[6]=[v("Emergency Supply Drugs")])),_:1,__:[6]}),(A(!0),O(j,null,z(l.drugs,(i,D)=>(A(),O("div",{key:D,class:"drug-item"},[n(a(x),null,{default:r(()=>[n(a(g),null,{default:r(()=>[n(a(_),{size:"12"},{default:r(()=>[n(a(G),{lines:"none"},{default:r(()=>[n(a(y),null,{default:r(()=>[v(b(i.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),n(a(g),null,{default:r(()=>[n(a(_),{size:"6"},{default:r(()=>[n(a(S),{modelValue:i.other.remainingAmount,"onUpdate:modelValue":f=>i.other.remainingAmount=f,onIonInput:f=>p("drugs",{index:D,field:"remainingAmount",value:f.detail.value}),placeholder:"Pills Remaining",label:"Pills Remaining","label-placement":"stacked",type:"number",fill:"outline"},null,8,["modelValue","onUpdate:modelValue","onIonInput"])]),_:2},1024),n(a(_),{size:"6"},{default:r(()=>[n(a(S),{modelValue:i.other.givenAmount,"onUpdate:modelValue":f=>i.other.givenAmount=f,onIonInput:f=>p("drugs",{index:D,field:"givenAmount",value:f.detail.value}),placeholder:"Pills Given",label:"Pills Given","label-placement":"stacked",type:"number",fill:"outline"},null,8,["modelValue","onUpdate:modelValue","onIonInput"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128)),c("div",ie,b(s.value.drugs),1)]),c("div",oe,[n(a(x),null,{default:r(()=>[n(a(g),null,{default:r(()=>[n(a(_),null,{default:r(()=>[n(a(y),null,{default:r(()=>t[7]||(t[7]=[v("Next Appointment Date")])),_:1,__:[7]}),n(P,{place_holder:"Select next appointment date",onDateUpDated:t[2]||(t[2]=i=>p("next_appointment","".concat(i.value.year,"-").concat(i.value.month,"-").concat(i.value.day))),date_prop:""}),c("div",se,b(s.value.next_appointment),1)]),_:1})]),_:1})]),_:1})])]),_:1})]),_:1}))}}}),be=K(ue,[["__scopeId","data-v-2988fbce"]]);export{be as default};
