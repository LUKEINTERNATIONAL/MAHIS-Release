var He=Object.defineProperty;var Le=(t,e,n)=>e in t?He(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var U=(t,e,n)=>Le(t,typeof e!="symbol"?e+"":e,n);import{H as D,aP as E,u as re,S as _,aH as J,N as ce,_ as le,P as Be,t as Z,o as de,k as C,A as Ue,$ as Ze,s as Ye,d as je}from"./index-CHQBF5A7.js";import{l as qe}from"./lodash-Dt8AsbQm.js";import{D as We,d as W,aa as v,M as Y,ab as Ge,a1 as Ke,a9 as N,Q as j,H as P,e as q,f as k,l as m,k as h,J as u,P as w,F as ue,r as x,a as Qe,N as ae,m as se,u as f,b1 as oe,K as V,bj as Xe}from"./vendor-BTD4y0_l.js";import{S as et}from"./sms_service-DeAP1w1q.js";import{E as tt}from"./EIRreportsStore-BQ6HmNCJ.js";import{u as nt,F as ie,e as at}from"./Export-B3JOLFnC.js";const $=We("immunizationAppointMentStore",{state:()=>({selectedAppointmentMent:[],selectedAppointmentMentForAppointmentsPage:"",AppointmentsReload:!1,startDate:D.sessionDate(),endDate:D.sessionDate()}),actions:{getAppointmentMents(){return this.selectedAppointmentMent},setAppointmentMent(t){this.selectedAppointmentMent.length=0,this.selectedAppointmentMent.push(t)},clearAppointmentMent(){this.selectedAppointmentMent.length=0},getSelectedAppointmentMentForAppointmentsPage(){return this.selectedAppointmentMentForAppointmentsPage},setSelectedAppointmentMentForAppointmentsPage(t){this.selectedAppointmentMentForAppointmentsPage=t},setAppointmentsReload(t){this.AppointmentsReload=t},getAppointmentsReload(){return this.AppointmentsReload},setStartEndDate(t,e){this.startDate=t,this.endDate=e},getStartEndDate(){return{startDate:this.startDate,endDate:this.endDate}}}});class O extends E{constructor(n){const a=n!==void 0?n:O.getPatientID(),r=O.getProviderID();super(a,7,r);U(this,"patientID");U(this,"providerID");this.patientID=a,this.providerID=r}static getPatientID(){return re().patient.patientID}static getProviderID(){return _.getUserID()}async setPatientID(n){this.patientID=n}async createAppointment(n){var p;let a=JSON.parse(JSON.stringify(n));const r=[];$().selectedAppointmentMent.forEach(S=>{const M=D.toStandardHisFormat(S.date);r.push(M)});const l=await this.buildValueDate("Appointment date",r[0]);return(p=a==null?void 0:a.appointments.unsaved)==null||p.push(l),await J(a),ce("next Appointment Set Successfully"),r[0]}async getNextAppointment(){if(this.programID&&this.patientID)return E.getJson("/programs/".concat(this.programID,"/patients/").concat(this.patientID,"/next_appointment_date"),{date:this.date})}async getDailyAppointments(n){const a=E.getProgramID();return E.getJson("/programs/".concat(a,"/booked_appointments"),{date:n,paginate:!1})}}const st=W({components:{IonRow:N,IonItem:Ke,IonList:Ge,IonButton:Y,IonCol:v},props:{date:{type:String,required:!0},patient:{type:Number,required:!0},modalaction:{type:String,required:!0}},data(){return{formattedDate:D.toStandardHisFormat(this.date)}},methods:{async dismissModal(){await j.dismiss()},async sendSMS(){await j.dismiss("send-SMS")}}}),ot={class:"saveBtn"};function it(t,e,n,a,r,c){const l=P("ion-row"),p=P("ion-button"),S=P("ion-col");return k(),q(ue,null,[m(l,{class:"centered-content"},{default:u(()=>e[0]||(e[0]=[h("div",{class:"text-container"},[h("div",null,"Do you want to send SMS reminder?")],-1)])),_:1,__:[0]}),h("div",ot,[m(l,null,{default:u(()=>[m(S,null,{default:u(()=>[m(p,{onClick:t.dismissModal,id:"cbtn",class:"btnText cbtn",fill:"solid",style:{width:"130px"}},{default:u(()=>e[1]||(e[1]=[w(" No ",-1)])),_:1,__:[1]},8,["onClick"])]),_:1}),m(S,null,{default:u(()=>[m(p,{onClick:t.sendSMS,class:"btnText",fill:"solid",style:{width:"130px","text-align":"right"}},{default:u(()=>e[2]||(e[2]=[w(" Yes ",-1)])),_:1,__:[2]},8,["onClick"])]),_:1})]),_:1})])],64)}const rt=le(st,[["render",it],["__scopeId","data-v-2bafd924"]]),ct={class:"lbl-ct"},lt={class:"lbl-ct"},dt={style:{"margin-right":"20px",color:"black"}},ut={key:0},mt={style:{color:"#999"}},pt={style:{"font-size":"16px",color:"#666","margin-top":"5px"}},ft=W({watch:{},name:"xxxComponent"}),gt=W({...ft,props:{patient_Id:{},encounter_Id:{}},setup(t){const e=re(),n=x(),a=x(),r=x(!1),c=x(!1),l=D.toStandardHisDisplayFormat(_.getSessionDate()),p=x(!1),S=x(),M=x(0),z=x([]),F=[];function pe(o){const s=new Date(_.getSessionDate());return s.setHours(0,0,0,0),o<s}const G=t;async function fe(){if($().selectedAppointmentMent.length>0)try{await xe();const i=await new O().createAppointment(e.patient);await _e(),await ye(),await Q(),ge(i)}catch(s){}else Z("please select next appointment date on the calendar")}async function ge(o){if(z.value.length==0){Z("No phone numbers available for sms reminder!");return}if(o&&await de(rt,{class:"nationalIDModal"})=="send-SMS"){const i=JSON.parse(JSON.stringify(e.patient));i.sms={appointment_date:o},await J(i)}}async function _e(){const o=C();o.setVaccineReload(!o.getVaccineReload())}async function ye(){const o=$();o.setAppointmentsReload(!o.getAppointmentsReload())}Qe(async()=>{$().clearAppointmentMent(),await be(),await he()});async function he(){try{const o=new Be,s=G.patient_Id!==void 0?G.patient_Id:o.getID(),i=await we(s);if(F.length>0){const d=F[F.length-1];await De(d,s)==!1&&(n.value=ne(d.vaccine.date_administered,te(i.age)),a.value=D.toStandardHisDisplayFormat(n.value),X(n.value),ee(n.value),r.value=!0)}}catch(o){}}async function De(o,s){try{const i=new Date(e.patient.personInformation.birthdate),d=ne(i,te(o.age)),y=Se(o.vaccine.date_administered),g=new Date(d);return console.log(K(y,g)),K(y,g)}catch(i){}}function Se(o){const s={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"},i=o.split(/[:/ ]/),d="".concat(i[2],"-").concat(s[i[1]],"-").concat(i[0],"T").concat(i[3],":").concat(i[4],":").concat(i[5]);return new Date(d)}function K(o,s){const i=o.getFullYear(),d=o.getMonth(),y=o.getDate(),g=s.getFullYear(),A=s.getMonth(),I=s.getDate();return i!==g?i>g:d!==A?d>A:y>I}function ve(o){return o.forEach(s=>{s.antigens.forEach(i=>{i.status=="administered"&&F.push({age:s.age,vaccine:i})})}),F}async function we(o){try{const s=e.patient.vaccineSchedule;ve(s.vaccine_schedule);for(const i of s.vaccine_schedule)if(i.milestone_status==="current"||i.milestone_status==="upcoming")return i;return null}catch(s){return null}}async function Ae(o){try{const s=await Ue.getDailyAppointments(D.toStandardHisFormat(o),D.toStandardHisFormat(o));M.value=s.length}catch(s){}}async function Q(){try{await j.dismiss()}catch(o){console.error("Modal dismissal error:",o)}}async function be(){try{let o=await et.getConfigurations();c.value=o.show_sms_popup}catch(o){}}async function xe(){var i,d;const o=JSON.parse(JSON.stringify(e.patient.guardianInformation)),s=[...o==null?void 0:o.unsaved,...o==null?void 0:o.saved];s.length>0&&((i=s[0])!=null&&i.cell_phone_number)&&z.value.push((d=s[0])==null?void 0:d.cell_phone_number),e.patient.personInformation.cell_phone_number&&z.value.push(e.patient.personInformation.cell_phone_number)}async function X(o){const s=$(),i={counter:1,date:o};s.setAppointmentMent(i),p.value=!1,await Ae(o),p.value=!0,S.value=D.toStandardHisDisplayFormat(o)}function ee(o){const i=$().getAppointmentMents(),d=A=>{const I=new Date(A);return I.setHours(0,0,0,0),I.getTime()},y=d(new Date(o)),g=i.find(A=>d(new Date(A.date))===y);return g?g.counter:null}function te(o){const s=/(\d+)\s*(week|month|year)s?/i,i=o.match(s);if(!i)return"Invalid input format";const d=parseInt(i[1]);switch(i[2].toLowerCase()){case"week":return d*7;case"month":return d*30;case"year":return d*365;default:return"Invalid time unit"}}function ne(o,s){if(s=="Invalid input format")return"";let i;if(o instanceof Date)i=new Date(o);else{const[b,B]=o.split(" "),[Ee,Pe,Te]=b.split("/"),[Oe,Je,ze]=B.split(":"),Re={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};i=new Date(Number(Te),Re[Pe],Number(Ee),Number(Oe),Number(Je),Number(ze))}i.setDate(i.getDate()+s);const d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],g=b=>String(b).padStart(2,"0"),A=d[i.getDay()],I=y[i.getMonth()],Me=g(i.getDate()),Ie=i.getFullYear(),Ve=g(i.getHours()),Ne=g(i.getMinutes()),$e=g(i.getSeconds()),R=-i.getTimezoneOffset(),Fe=Math.floor(Math.abs(R)/60),ke=Math.abs(R)%60,Ce="GMT".concat(R>=0?"+":"-").concat(g(Fe)).concat(g(ke)),H=Intl.DateTimeFormat().resolvedOptions().timeZone;let L;try{const b=new Intl.DateTimeFormat("en",{timeZone:H,timeZoneName:"long"}).formatToParts(i).find(B=>B.type==="timeZoneName");L=b?b.value:H}catch(b){console.error("Error getting localized time zone name:",b),L=H}return"Date ".concat(A," ").concat(I," ").concat(Me," ").concat(Ie," ").concat(Ve,":").concat(Ne,":").concat($e," ").concat(Ce," (").concat(L,")")}return(o,s)=>{const i=P("VueDatePicker");return k(),q(ue,null,[m(f(N),{style:{"margin-top":"10px"}},{default:u(()=>[m(f(v),{style:{"margin-left":"-3px"}},{default:u(()=>s[1]||(s[1]=[h("div",{class:"om",style:{"font-weight":"600",color:"#8d8686"}},"Set Next Appointment Date",-1)])),_:1,__:[1]}),m(f(v),{size:"6",style:{"text-align":"right"}},{default:u(()=>[m(f(oe),{class:"lbl-tl",style:{"font-size":"13"}},{default:u(()=>[s[2]||(s[2]=w(" Todays Date: ",-1)),h("span",ct,V(f(l)),1)]),_:1,__:[2]})]),_:1})]),_:1}),m(f(N),{style:{"margin-top":"10px"}},{default:u(()=>[m(f(v),{style:{"margin-left":"-3px"}},{default:u(()=>s[3]||(s[3]=[h("div",{class:"om"},null,-1)])),_:1,__:[3]}),p.value?(k(),ae(f(v),{key:0,size:"10",style:{"text-align":"right"}},{default:u(()=>[m(f(oe),{class:"lbl-tl",style:{"font-size":"16","font-weight":"500"}},{default:u(()=>[s[4]||(s[4]=w(" Total Appointments ",-1)),h("span",lt,"("+V(S.value)+")",1),s[5]||(s[5]=w(": ",-1)),h("span",dt,[m(f(Xe),{color:"primary",style:{"margin-bottom":"-5px","font-size":"15px"}},{default:u(()=>[w(V(M.value),1)]),_:1})])]),_:1,__:[4,5]})]),_:1})):se("",!0)]),_:1}),m(f(N),{style:{"margin-top":"20px"}},{default:u(()=>[m(f(v),null,{default:u(()=>[m(i,{modelValue:n.value,"onUpdate:modelValue":s[0]||(s[0]=d=>n.value=d),onDateUpdate:X,"enable-time-picker":!1,inline:"","auto-apply":"","disabled-dates":pe},{day:u(({day:d,date:y})=>[(k(),q("p",ut,[w(V(d),1),h("sup",mt,V(ee(y)),1)]))]),_:1},8,["modelValue"])]),_:1})]),_:1}),r.value?(k(),ae(f(N),{key:0,style:{"margin-top":"0px","margin-bottom":"0px"}},{default:u(()=>[m(f(v),{style:{"background-color":"#f0f0f0",padding:"15px","border-radius":"8px","box-shadow":"0 2px 4px rgba(0, 0, 0, 0.1)"}},{default:u(()=>[s[6]||(s[6]=h("div",{style:{"font-size":"17px",color:"#333","font-weight":"bold"}},"Suggested Date:",-1)),h("div",pt,V(a.value),1)]),_:1,__:[6]})]),_:1})):se("",!0),m(f(N),{style:{"margin-top":"10px","margin-bottom":"10px"}},{default:u(()=>[m(f(v),null,{default:u(()=>[m(f(Y),{onClick:Q,id:"cbtn",class:"btnText cbtn",fill:"solid",style:{width:"130px"}},{default:u(()=>s[7]||(s[7]=[w(" Cancel ",-1)])),_:1,__:[7]})]),_:1}),m(f(v),{style:{"text-align":"right"}},{default:u(()=>[m(f(Y),{onClick:fe,class:"btnText",fill:"solid",style:{width:"130px"}},{default:u(()=>s[8]||(s[8]=[w(" save ",-1)])),_:1,__:[8]})]),_:1})]),_:1})],64)}}}),_t=le(gt,[["__scopeId","data-v-6ee82e0c"]]);async function Pt(t){var a,r;const e=JSON.parse(JSON.stringify(t)),n=C();if(!qe.isEmpty(n.getAdministeredVaccines())){const c=Dt(),l=await St();let p=e==null?void 0:e.vaccineAdministration;p.orders=[...p==null?void 0:p.orders,...c],p.voided=p.voided.filter(S=>{var M;return S.drug_name!==((M=c[0])==null?void 0:M.drug_name)}),p.obs=[...p==null?void 0:p.obs,...l],n.setVaccineReload(!n.getVaccineReload()),p.orders.length>0&&n.setLastVaccineAdminstredOnschedule(p.orders),me(e,(a=c[0])==null?void 0:a.drug_name,"administered",(r=l[0])==null?void 0:r.obs_datetime),await J(e),ce("Saved successful"),await At(e)}}function me(t,e,n,a){t.vaccineSchedule.vaccine_schedule.forEach(r=>{r.antigens.forEach(c=>{c.drug_name===e&&(c.status=n,c.date_administered=a)})})}async function Tt(t,e){const n=await yt(t);return await ht(new Date(e),n)}async function yt(t){try{let e;if(_.getUseIndexDBStatus()&&_.getModsStatus()?e=await Ye("genericVaccineSchedule"):e=await _.getJson("eir/schedule/generic",{paginate:!1}),e.length>0){if(t=="M")return e[0].genericVaccineSchedule.male_schedule;if(t=="F")return e[0].genericVaccineSchedule.female_schedule}else if(je().apiStatus){if(e=await _.getJson("eir/schedule/generic",{paginate:!1}),t=="M")return e.male_schedule;if(t=="F")return e.female_schedule}}catch(e){return console.error("Error getting offline generic vaccine schedule",e),[]}}async function ht(t,e){const n=new Date;return e.forEach(a=>{const r=a.age.toLowerCase();let c=null;if(r==="at birth")c=new Date(t);else if(r.includes("weeks")){const l=parseInt(r.split(" ")[0],10);c=new Date(t),c.setDate(t.getDate()+l*7)}else if(r.includes("months")){const l=parseInt(r.split(" ")[0],10);c=new Date(t),c.setMonth(t.getMonth()+l)}else if(r.includes("years")){const l=parseInt(r.split(" ")[0],10);c=new Date(t),c.setFullYear(t.getFullYear()+l)}c?c>n?a.milestone_status="upcoming":c.toDateString()===n.toDateString()?a.milestone_status="current":a.milestone_status="passed":a.milestone_status="unknown"}),{vaccine_schedule:e}}function Dt(){return C().getAdministeredVaccines().map(e=>{var n,a,r;return{drug_name:((a=(n=e==null?void 0:e.drug_)==null?void 0:n.drug)==null?void 0:a.drug_name)||((r=e==null?void 0:e.drug_)==null?void 0:r.drug_name),drug_inventory_id:e.drug_id,equivalent_daily_dose:1,start_date:e.date_administered,auto_expire_date:vt(e.date_administered,1),units:"ml",instructions:"",dose:1,frequency:"Unknown",batch_number:e.batch_number||"Unknown",prn:0}})}async function St(){const e=C().getAdministeredVaccines();return await Promise.all(e.map(async a=>{var r,c,l;return{concept_id:2876,value_text:((c=(r=a==null?void 0:a.drug_)==null?void 0:r.drug)==null?void 0:c.drug_name)||((l=a==null?void 0:a.drug_)==null?void 0:l.drug_name),obs_datetime:a.date_administered}}))}function vt(t,e){const n=new Date(t);return n.setDate(n.getDate()+parseInt(e)),D.toStandardHisFormat(n)}function wt(){de(_t,{class:"otherVitalsModal"},!1)}async function At(t){var a,r;const e=C(),n=e.getLastVaccineAdminstredOnschedule();n.length>0&&((r=(a=t==null?void 0:t.vaccineSchedule)==null?void 0:a.vaccine_schedule)==null||r.forEach(c=>{bt(c.antigens)==!0&&c.antigens.forEach(l=>{l.drug_id==n[0].drug_inventory_id&&wt()})})),e.setLastVaccineAdminstredOnschedule([])}function bt(t){return t.every(e=>e.status==="administered")}async function Ot(t,e,n){const a=JSON.parse(JSON.stringify(t));let r=a==null?void 0:a.vaccineAdministration;r.orders.some(l=>l.drug_name===e.drug.drug_name)?(r.orders=r.orders.filter(l=>l.drug_name!==e.drug.drug_name),r.obs=r.obs.filter(l=>l.value_text!==e.drug.drug_name)):r.voided=[...r==null?void 0:r.voided,{reason:n,order_id:e.drug.order_id,drug_name:e.drug.drug_name}],me(a,e.drug.drug_name,"pending",""),await J(a)}async function Jt(t,e){return _.void("/encounters/".concat(t),{reason:e})}function zt(t){return xt(t.drug_name)==!0}function xt(t){const e=["Vit","Albendazole"],n=t.toLowerCase().split(/[\s,()]+/);return e.some(a=>a.toLowerCase().split(/[\s,()]+/).some(c=>n.some(l=>l.includes(c)||c.includes(l))))}async function Rt(){return await _.getJson("immunization/months_picker")}async function Ht(t,e){return await _.getJson("immunization/vaccines_administered",{start_date:t,end_date:e})}async function Lt(t,e){return await _.getJson("immunization/aefi_report",{start_date:t,end_date:e})}async function Bt(){return await _.getJson("immunization/under_five_immunizations_drugs")}async function Ut(){return await _.getJson("/immunization/vaccine_names")}function T(t){return/[,"\n]/.test(t)?'"'.concat(t.replace(/"/g,'""'),'"'):t}function Zt(){try{const t=tt(),e=Ze(),{activePlatformProfile:n}=nt();let a=Mt(t.$state.immunizationMonthlyRepoartData);a+="\n",a+=It(t.$state.AEFIReportData),a+="\n",a+="\n        Date Created: ".concat(new Date().toISOString().split("T")[0],"\n        Report Period: ").concat(t.$state.navigationPayload.subTxt,"\n        Site: ").concat(e.$state.userFacilityName);const r=new Blob([a],{type:"text/csv;charset=utf-8;"}),c="".concat(e.$state.userFacilityName,"_").concat(t.$state.navigationPayload.subTxt,"_").concat(t.$state.navigationPayload.title);if(n.value.fileExport===ie.WEB){const l=document.createElement("a");l.href=window.URL.createObjectURL(r),l.setAttribute("download","".concat(c,".csv")),l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l)}else n.value.fileExport===ie.FILE_SYSTEM?at("".concat(c,".csv"),r,"blob"):Z("Platform not supported")}catch(t){console.error("Error exporting CSV:",t)}}function Mt(t){let e="Category,Static <1y,Static >1y,Outreach <1y,Outreach >1y\n";for(const n of t){const a=[T(n.label),n.fixed.lessThan1y,n.fixed.moreThan1y,n.outreach.lessThan1y,n.outreach.moreThan1y].join(",");e+=a+"\n"}return e}function It(t){let e="Cases,"+t.vaccines.map(n=>T(n.name)).join(",")+"\n";for(const n of t.categories){e+=T(n.name)+"\n";for(const a of n.cases){const r=[T(a.name),...a.data.map(c=>c.count)];e+=r.join(",")+"\n"}}return e}export{O as A,rt as a,Rt as b,Ut as c,Ht as d,Zt as e,Bt as f,Tt as g,Lt as h,zt as i,Ot as j,_t as n,Pt as s,$ as u,Jt as v};
